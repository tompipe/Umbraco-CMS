<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\LocalizationServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Services
{
    /// &lt;summary&gt;
    /// Tests covering all methods in the LocalizationService class.
    /// This is more of an integration test as it involves multiple layers
    /// as well as configuration.
    /// &lt;/summary&gt;
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, RequiresSTA]
    public class LocalizationServiceTests : BaseServiceTest
    {
        private Guid _parentItemGuidId;
        private int _parentItemIntId;
        private Guid _childItemGuidId;
        private int _childItemIntId;
        private int _danishLangId;
        private int _englishLangId;

        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        [Test]
        public void Can_Get_Root_Dictionary_Items()
        {
            var rootItems = ServiceContext.LocalizationService.GetRootDictionaryItems();

            Assert.NotNull(rootItems);
            Assert.IsTrue(rootItems.Any());
        }

        [Test]
        public void Can_Determint_If_DictionaryItem_Exists()
        {
            var exists = ServiceContext.LocalizationService.DictionaryItemExists(&quot;Parent&quot;);
            Assert.IsTrue(exists);
        }

        [Test]
        public void Can_Get_All_Languages()
        {
            var languages = ServiceContext.LocalizationService.GetAllLanguages();
            Assert.NotNull(languages);
            Assert.IsTrue(languages.Any());
            Assert.That(languages.Count(), Is.EqualTo(3));
        }

        [Test]
        public void Can_Get_Dictionary_Item_By_Int_Id()
        {
            var parentItem = ServiceContext.LocalizationService.GetDictionaryItemById(_parentItemIntId);
            Assert.NotNull(parentItem);

            var childItem = ServiceContext.LocalizationService.GetDictionaryItemById(_childItemIntId);
            Assert.NotNull(childItem);
        }

        [Test]
        public void Can_Get_Dictionary_Item_By_Guid_Id()
        {
            var parentItem = ServiceContext.LocalizationService.GetDictionaryItemById(_parentItemGuidId);
            Assert.NotNull(parentItem);

            var childItem = ServiceContext.LocalizationService.GetDictionaryItemById(_childItemGuidId);
            Assert.NotNull(childItem);
        }

        [Test]
        public void Can_Get_Dictionary_Item_By_Key()
        {
            var parentItem = ServiceContext.LocalizationService.GetDictionaryItemByKey(&quot;Parent&quot;);
            Assert.NotNull(parentItem);

            var childItem = ServiceContext.LocalizationService.GetDictionaryItemByKey(&quot;Child&quot;);
            Assert.NotNull(childItem);
        }

        [Test]
        public void Can_Get_Dictionary_Item_Children()
        {
            var item = ServiceContext.LocalizationService.GetDictionaryItemChildren(_parentItemGuidId);
            Assert.NotNull(item);
            Assert.That(item.Count(), Is.EqualTo(1));

            foreach (var dictionaryItem in item)
            {
                Assert.AreEqual(_parentItemGuidId, dictionaryItem.ParentId);
                Assert.IsFalse(string.IsNullOrEmpty(dictionaryItem.ItemKey));
            }
        }

        [Test]
        public void Can_Get_Dictionary_Item_Descendants()
        {
            try
            {
                var en = ServiceContext.LocalizationService.GetLanguageById(_englishLangId);
                var dk = ServiceContext.LocalizationService.GetLanguageById(_danishLangId);

                var currParentId = _childItemGuidId;
                for (int i = 0; i &lt; 25; i++)
                {
                    //Create 2 per level
                    var desc1 = new DictionaryItem(currParentId, &quot;D1&quot; + i)
                    {
                        Translations = new List&lt;IDictionaryTranslation&gt;
                        {
                            new DictionaryTranslation(en, &quot;ChildValue1 &quot; + i),
                            new DictionaryTranslation(dk, &quot;B&#248;rnV&#230;rdi1 &quot; + i)
                        }
                    };
                    var desc2 = new DictionaryItem(currParentId, &quot;D2&quot; + i)
                    {
                        Translations = new List&lt;IDictionaryTranslation&gt;
                        {
                            new DictionaryTranslation(en, &quot;ChildValue2 &quot; + i),
                            new DictionaryTranslation(dk, &quot;B&#248;rnV&#230;rdi2 &quot; + i)
                        }
                    };
                    ServiceContext.LocalizationService.Save(desc1);
                    ServiceContext.LocalizationService.Save(desc2);

                    currParentId = desc1.Key;
                }

                DatabaseContext.Database.EnableSqlTrace = true;
                DatabaseContext.Database.EnableSqlCount();

                var items = ServiceContext.LocalizationService.GetDictionaryItemDescendants(_parentItemGuidId)
                    .ToArray();

                Debug.WriteLine(&quot;SQL CALLS: &quot; + DatabaseContext.Database.SqlCount);

                Assert.AreEqual(51, items.Length);
                //there&#39;s a call or two to get languages, so apart from that there should only be one call per level
                Assert.Less(DatabaseContext.Database.SqlCount, 30);
            }
            finally
            {
                DatabaseContext.Database.EnableSqlTrace = false;
                DatabaseContext.Database.DisableSqlCount();
            }
           
        }

        [Test]
        public void Can_Get_Language_By_Culture_Code()
        {
            var danish = ServiceContext.LocalizationService.GetLanguageByCultureCode(&quot;Danish&quot;);
            var english = ServiceContext.LocalizationService.GetLanguageByCultureCode(&quot;English&quot;);
            Assert.NotNull(danish);
            Assert.NotNull(english);
        }

        [Test]
        public void Can_GetLanguageById()
        {
            var danish = ServiceContext.LocalizationService.GetLanguageById(_danishLangId);
            var english = ServiceContext.LocalizationService.GetLanguageById(_englishLangId);
            Assert.NotNull(danish);
            Assert.NotNull(english);
        }

        [Test]
        public void Can_GetLanguageByIsoCode()
        {
            var danish = ServiceContext.LocalizationService.GetLanguageByIsoCode(&quot;da-DK&quot;);
            var english = ServiceContext.LocalizationService.GetLanguageByIsoCode(&quot;en-GB&quot;);
            Assert.NotNull(danish);
            Assert.NotNull(english);
        }

        [Test]
        public void Does_Not_Fail_When_Language_Doesnt_Exist()
        {
            var language = ServiceContext.LocalizationService.GetLanguageByIsoCode(&quot;sv-SE&quot;);
            Assert.Null(language);
        }

        [Test]
        public void Does_Not_Fail_When_DictionaryItem_Doesnt_Exist()
        {
            var item = ServiceContext.LocalizationService.GetDictionaryItemByKey(&quot;RandomKey&quot;);
            Assert.Null(item);
        }

        [Test]
        public void Can_Delete_Language()
        {
            var norwegian = new Language(&quot;nb-NO&quot;) { CultureName = &quot;Norwegian&quot; };
            ServiceContext.LocalizationService.Save(norwegian, 0);
            Assert.That(norwegian.HasIdentity, Is.True);
            var languageId = norwegian.Id;

            ServiceContext.LocalizationService.Delete(norwegian);

            var language = ServiceContext.LocalizationService.GetLanguageById(languageId);
            Assert.Null(language);
        }

        [Test]
        public void Can_Create_DictionaryItem_At_Root()
        {
            var english = ServiceContext.LocalizationService.GetLanguageByIsoCode(&quot;en-US&quot;);

            var item = (IDictionaryItem)new DictionaryItem(&quot;Testing123&quot;)
            {
                Translations = new List&lt;IDictionaryTranslation&gt;
                               {
                                   new DictionaryTranslation(english, &quot;Hello world&quot;)
                               }
            };
            ServiceContext.LocalizationService.Save(item);

            //re-get
            item = ServiceContext.LocalizationService.GetDictionaryItemById(item.Id);

            Assert.Greater(item.Id, 0);
            Assert.IsTrue(item.HasIdentity);
            Assert.IsFalse(item.ParentId.HasValue);
            Assert.AreEqual(&quot;Testing123&quot;, item.ItemKey);
            Assert.AreEqual(1, item.Translations.Count());
        }

        [Test]
        public void Can_Create_DictionaryItem_At_Root_With_Identity()
        {

            var item = ServiceContext.LocalizationService.CreateDictionaryItemWithIdentity(
                &quot;Testing12345&quot;, null, &quot;Hellooooo&quot;);

            //re-get
            item = ServiceContext.LocalizationService.GetDictionaryItemById(item.Id);

            Assert.IsNotNull(item);
            Assert.Greater(item.Id, 0);
            Assert.IsTrue(item.HasIdentity);
            Assert.IsFalse(item.ParentId.HasValue);
            Assert.AreEqual(&quot;Testing12345&quot;, item.ItemKey);
            var allLangs = ServiceContext.LocalizationService.GetAllLanguages();
            Assert.Greater(allLangs.Count(), 0);
            foreach (var language in allLangs)
            {
                Assert.AreEqual(&quot;Hellooooo&quot;, item.Translations.Single(x =&gt; x.Language.CultureName == language.CultureName).Value);    
            }
            
        }

        [Test]
        public void Can_Add_Translation_To_Existing_Dictionary_Item()
        {
            var english = ServiceContext.LocalizationService.GetLanguageByIsoCode(&quot;en-US&quot;);

            var item = (IDictionaryItem) new DictionaryItem(&quot;Testing123&quot;);
            ServiceContext.LocalizationService.Save(item);

            //re-get
            item = ServiceContext.LocalizationService.GetDictionaryItemById(item.Id);

            item.Translations = new List&lt;IDictionaryTranslation&gt;
            {
                new DictionaryTranslation(english, &quot;Hello world&quot;)
            };

            ServiceContext.LocalizationService.Save(item);

            Assert.AreEqual(1, item.Translations.Count());
            foreach (var translation in item.Translations)
            {
                Assert.AreEqual(&quot;Hello world&quot;, translation.Value);
            }

            item.Translations = new List&lt;IDictionaryTranslation&gt;(item.Translations)
            {
                new DictionaryTranslation(
                    ServiceContext.LocalizationService.GetLanguageByIsoCode(&quot;en-GB&quot;),
                    &quot;My new value&quot;)
            };

            ServiceContext.LocalizationService.Save(item);

            //re-get
            item = ServiceContext.LocalizationService.GetDictionaryItemById(item.Id);

            Assert.AreEqual(2, item.Translations.Count());
            Assert.AreEqual(&quot;Hello world&quot;, item.Translations.First().Value);
            Assert.AreEqual(&quot;My new value&quot;, item.Translations.Last().Value);
        }

        [Test]
        public void Can_Delete_DictionaryItem()
        {
            var item = ServiceContext.LocalizationService.GetDictionaryItemByKey(&quot;Child&quot;);
            Assert.NotNull(item);

            ServiceContext.LocalizationService.Delete(item);

            var deletedItem = ServiceContext.LocalizationService.GetDictionaryItemByKey(&quot;Child&quot;);
            Assert.Null(deletedItem);
        }

        [Test]
        public void Can_Update_Existing_DictionaryItem()
        {
            var item = ServiceContext.LocalizationService.GetDictionaryItemByKey(&quot;Child&quot;);
            foreach (var translation in item.Translations)
            {
                translation.Value = translation.Value + &quot;UPDATED&quot;;
            }

            ServiceContext.LocalizationService.Save(item);

            var updatedItem = ServiceContext.LocalizationService.GetDictionaryItemByKey(&quot;Child&quot;);
            Assert.NotNull(updatedItem);

            foreach (var translation in updatedItem.Translations)
            {
                Assert.That(translation.Value.EndsWith(&quot;UPDATED&quot;), Is.True);
            }
        }

        [Test]
        public void Find_BaseData_Language()
        {
            // Arrange
            var localizationService = ServiceContext.LocalizationService;
            
            // Act
            var languages = localizationService.GetAllLanguages();

            // Assert 
            Assert.That(3, Is.EqualTo(languages.Count()));
        }

        [Test]
        public void Save_Language_And_GetLanguageByIsoCode()
        {
            // Arrange
            var localizationService = ServiceContext.LocalizationService;
            var isoCode = &quot;en-AU&quot;;
            var language = new Core.Models.Language(isoCode);

            // Act
            localizationService.Save(language);
            var result = localizationService.GetLanguageByIsoCode(isoCode);

            // Assert
            Assert.NotNull(result);
        }

        [Test]
        public void Save_Language_And_GetLanguageById()
        {
            var localizationService = ServiceContext.LocalizationService;
            var isoCode = &quot;en-AU&quot;;
            var language = new Core.Models.Language(isoCode);

            // Act
            localizationService.Save(language);
            var result = localizationService.GetLanguageById(language.Id);

            // Assert
            Assert.NotNull(result);
        }

        [Test]
        public void Deleted_Language_Should_Not_Exist()
        {
            var localizationService = ServiceContext.LocalizationService;
            var isoCode = &quot;en-AU&quot;;
            var language = new Core.Models.Language(isoCode);
            localizationService.Save(language);

            // Act
            localizationService.Delete(language);
            var result = localizationService.GetLanguageByIsoCode(isoCode);

            // Assert
            Assert.Null(result);
        }

        public override void CreateTestData()
        {
            var danish = new Language(&quot;da-DK&quot;) { CultureName = &quot;Danish&quot; };
            var english = new Language(&quot;en-GB&quot;) { CultureName = &quot;English&quot; };
            ServiceContext.LocalizationService.Save(danish, 0);
            ServiceContext.LocalizationService.Save(english, 0);
            _danishLangId = danish.Id;
            _englishLangId = english.Id;

            var parentItem = new DictionaryItem(&quot;Parent&quot;)
            {
                Translations = new List&lt;IDictionaryTranslation&gt;
                               {
                                   new DictionaryTranslation(english, &quot;ParentValue&quot;),
                                   new DictionaryTranslation(danish, &quot;For&#230;ldreV&#230;rdi&quot;)
                               }
            };
            ServiceContext.LocalizationService.Save(parentItem);
            _parentItemGuidId = parentItem.Key;
            _parentItemIntId = parentItem.Id;

            var childItem = new DictionaryItem(parentItem.Key, &quot;Child&quot;)
            {
                Translations = new List&lt;IDictionaryTranslation&gt;
                                               {
                                                   new DictionaryTranslation(english, &quot;ChildValue&quot;),
                                                   new DictionaryTranslation(danish, &quot;B&#248;rnV&#230;rdi&quot;)
                                               }
            };
            ServiceContext.LocalizationService.Save(childItem);
            _childItemGuidId = childItem.Key;
            _childItemIntId = childItem.Id;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,10,1],[31,13,31,31,1],[32,9,32,10,1],[36,9,36,10,1],[37,13,37,29,1],[38,9,38,10,1],[42,9,42,10,1],[43,13,43,89,1],[45,13,45,39,1],[46,13,46,44,1],[47,9,47,10,1],[51,9,51,10,1],[52,13,52,92,1],[53,13,53,35,1],[54,9,54,10,1],[58,9,58,10,1],[59,13,59,82,1],[60,13,60,39,1],[61,13,61,44,1],[62,13,62,59,1],[63,9,63,10,1],[67,9,67,10,1],[68,13,68,105,1],[69,13,69,40,1],[71,13,71,103,1],[72,13,72,39,1],[73,9,73,10,1],[77,9,77,10,1],[78,13,78,106,1],[79,13,79,40,1],[81,13,81,104,1],[82,13,82,39,1],[83,9,83,10,1],[87,9,87,10,1],[88,13,88,98,1],[89,13,89,40,1],[91,13,91,96,1],[92,13,92,39,1],[93,9,93,10,1],[97,9,97,10,1],[98,13,98,104,1],[99,13,99,34,1],[100,13,100,54,1],[102,13,102,20,1],[102,22,102,40,1],[102,41,102,43,1],[102,44,102,48,1],[103,13,103,14,1],[104,17,104,77,1],[105,17,105,78,1],[106,13,106,14,1],[107,9,107,10,1],[111,9,111,10,1],[113,13,113,14,1],[114,17,114,93,1],[115,17,115,92,1],[117,17,117,53,1],[118,22,118,31,1],[118,33,118,39,1],[118,41,118,44,1],[119,17,119,18,1],[121,21,128,23,1],[129,21,136,23,1],[137,21,137,68,1],[138,21,138,68,1],[140,21,140,46,1],[141,17,141,18,1],[143,17,143,64,1],[144,17,144,59,1],[146,17,147,32,1],[149,17,149,84,1],[151,17,151,51,1],[153,17,153,68,1],[154,13,154,14,1],[156,13,156,14,1],[157,17,157,65,1],[158,17,158,60,1],[159,13,159,14,1],[161,9,161,10,1],[165,9,165,10,1],[166,13,166,96,1],[167,13,167,98,1],[168,13,168,36,1],[169,13,169,37,1],[170,9,170,10,1],[174,9,174,10,1],[175,13,175,92,1],[176,13,176,94,1],[177,13,177,36,1],[178,13,178,37,1],[179,9,179,10,1],[183,9,183,10,1],[184,13,184,91,1],[185,13,185,92,1],[186,13,186,36,1],[187,13,187,37,1],[188,9,188,10,1],[192,9,192,10,1],[193,13,193,93,1],[194,13,194,35,1],[195,9,195,10,1],[199,9,199,10,1],[200,13,200,95,1],[201,13,201,31,1],[202,9,202,10,1],[206,9,206,10,1],[207,13,207,81,1],[208,13,208,67,1],[209,13,209,57,1],[210,13,210,43,1],[212,13,212,66,1],[214,13,214,91,1],[215,13,215,35,1],[216,9,216,10,1],[220,9,220,10,1],[221,13,221,92,1],[223,13,229,15,1],[230,13,230,59,1],[233,13,233,86,1],[235,13,235,40,1],[236,13,236,45,1],[237,13,237,52,1],[238,13,238,57,1],[239,13,239,59,1],[240,9,240,10,1],[244,9,244,10,1],[246,13,247,52,1],[250,13,250,86,1],[252,13,252,36,1],[253,13,253,40,1],[254,13,254,45,1],[255,13,255,52,1],[256,13,256,59,1],[257,13,257,81,1],[258,13,258,49,1],[259,13,259,20,1],[259,22,259,34,1],[259,35,259,37,1],[259,38,259,46,1],[260,13,260,14,1],[261,17,261,76,1],[261,76,261,122,1],[261,122,261,131,1],[261,17,261,131,1],[262,13,262,14,1],[264,9,264,10,1],[268,9,268,10,1],[269,13,269,92,1],[271,13,271,75,1],[272,13,272,59,1],[275,13,275,86,1],[277,13,280,15,1],[282,13,282,59,1],[284,13,284,59,1],[285,13,285,20,1],[285,22,285,37,1],[285,38,285,40,1],[285,41,285,58,1],[286,13,286,14,1],[287,17,287,67,1],[288,13,288,14,1],[290,13,295,15,1],[297,13,297,59,1],[300,13,300,86,1],[302,13,302,59,1],[303,13,303,77,1],[304,13,304,77,1],[305,9,305,10,1],[309,9,309,10,1],[310,13,310,91,1],[311,13,311,34,1],[313,13,313,61,1],[315,13,315,98,1],[316,13,316,38,1],[317,9,317,10,1],[321,9,321,10,1],[322,13,322,91,1],[323,13,323,20,1],[323,22,323,37,1],[323,38,323,40,1],[323,41,323,58,1],[324,13,324,14,1],[325,17,325,67,1],[326,13,326,14,1],[328,13,328,59,1],[330,13,330,98,1],[331,13,331,41,1],[333,13,333,20,1],[333,22,333,37,1],[333,38,333,40,1],[333,41,333,65,1],[334,13,334,14,1],[335,17,335,77,1],[336,13,336,14,1],[337,9,337,10,1],[341,9,341,10,1],[343,13,343,74,1],[346,13,346,67,1],[349,13,349,59,1],[350,9,350,10,1],[354,9,354,10,1],[356,13,356,74,1],[357,13,357,35,1],[358,13,358,62,1],[361,13,361,48,1],[362,13,362,76,1],[365,13,365,36,1],[366,9,366,10,1],[370,9,370,10,1],[371,13,371,74,1],[372,13,372,35,1],[373,13,373,62,1],[376,13,376,48,1],[377,13,377,75,1],[380,13,380,36,1],[381,9,381,10,1],[385,9,385,10,1],[386,13,386,74,1],[387,13,387,35,1],[388,13,388,62,1],[389,13,389,48,1],[392,13,392,50,1],[393,13,393,76,1],[396,13,396,33,1],[397,9,397,10,1],[400,9,400,10,1],[401,13,401,75,1],[402,13,402,77,1],[403,13,403,64,1],[404,13,404,65,1],[405,13,405,39,1],[406,13,406,41,1],[408,13,415,15,1],[416,13,416,65,1],[417,13,417,48,1],[418,13,418,46,1],[420,13,427,15,1],[428,13,428,64,1],[429,13,429,46,1],[430,13,430,44,1],[431,9,431,10,1]]);
    </script>
  </body>
</html>