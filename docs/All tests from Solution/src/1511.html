<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Services\PublicAccessServiceExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.Security;

namespace Umbraco.Core.Services
{
    /// &lt;summary&gt;
    /// Extension methods for the IPublicAccessService
    /// &lt;/summary&gt;
    public static class PublicAccessServiceExtensions
    {

        public static bool RenameMemberGroupRoleRules(this IPublicAccessService publicAccessService, string oldRolename, string newRolename)
        {
            var hasChange = false;
            if (oldRolename == newRolename) return false;

            var allEntries = publicAccessService.GetAll();

            foreach (var entry in allEntries)
            {
                //get rules that match
                var roleRules = entry.Rules
                    .Where(x =&gt; x.RuleType == Constants.Conventions.PublicAccess.MemberRoleRuleType)
                    .Where(x =&gt; x.RuleValue == oldRolename);
                var save = false;
                foreach (var roleRule in roleRules)
                {
                    //a rule is being updated so flag this entry to be saved
                    roleRule.RuleValue = newRolename;
                    save = true;
                }
                if (save)
                {
                    hasChange = true;
                    publicAccessService.Save(entry);
                }
            }
          
            return hasChange;
        }

        public static bool HasAccess(this IPublicAccessService publicAccessService, int documentId, IContentService contentService, IEnumerable&lt;string&gt; currentMemberRoles)
        {
            var content = contentService.GetById(documentId);
            if (content == null) return true;

            var entry = publicAccessService.GetEntryForContent(content);
            if (entry == null) return true;

            return entry.Rules.Any(x =&gt; x.RuleType == Constants.Conventions.PublicAccess.MemberRoleRuleType
                                        &amp;&amp; currentMemberRoles.Contains(x.RuleValue));
        }

        [Obsolete(&quot;this is only used for backward compat&quot;)]
        internal static bool HasAccess(this IPublicAccessService publicAccessService, int documentId, object providerUserKey, IContentService contentService, MembershipProvider membershipProvider, RoleProvider roleProvider)
        {
            var content = contentService.GetById(documentId);
            if (content == null) return true;

            var entry = publicAccessService.GetEntryForContent(content);
            if (entry == null) return true;

            var member = membershipProvider.GetUser(providerUserKey, false);
            if (member == null) return false;

            var roles = roleProvider.GetRolesForUser(member.UserName);
            return entry.Rules.Any(x =&gt; x.RuleType == Constants.Conventions.PublicAccess.MemberRoleRuleType
                                        &amp;&amp; roles.Contains(x.RuleValue));
        }

        public static bool HasAccess(this IPublicAccessService publicAccessService, string path, MembershipUser member, RoleProvider roleProvider)
        {
            var entry = publicAccessService.GetEntryForContent(path.EnsureEndsWith(path));
            if (entry == null) return true;

            var roles = roleProvider.GetRolesForUser(member.UserName);
            return entry.Rules.Any(x =&gt; x.RuleType == Constants.Conventions.PublicAccess.MemberRoleRuleType
                                        &amp;&amp; roles.Contains(x.RuleValue));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,9,15,10,0],[16,13,16,35,0],[17,13,17,44,0],[17,45,17,58,0],[19,13,19,59,0],[21,13,21,20,0],[21,22,21,31,0],[21,32,21,34,0],[21,35,21,45,0],[22,13,22,14,0],[24,17,25,33,0],[25,33,25,100,0],[25,100,26,33,0],[26,33,26,59,0],[26,59,26,61,0],[24,17,26,61,0],[27,17,27,34,0],[28,17,28,24,0],[28,26,28,38,0],[28,39,28,41,0],[28,42,28,51,0],[29,17,29,18,0],[31,21,31,54,0],[32,21,32,33,0],[33,17,33,18,0],[34,17,34,26,0],[35,17,35,18,0],[36,21,36,38,0],[37,21,37,53,0],[38,17,38,18,0],[39,13,39,14,0],[41,13,41,30,0],[42,9,42,10,0],[45,9,45,10,0],[46,13,46,62,0],[47,13,47,33,0],[47,34,47,46,0],[49,13,49,73,0],[50,13,50,31,0],[50,32,50,44,0],[52,13,52,41,0],[52,41,53,84,0],[53,84,53,86,0],[52,13,53,86,0],[54,9,54,10,0],[58,9,58,10,0],[59,13,59,62,0],[60,13,60,33,0],[60,34,60,46,0],[62,13,62,73,0],[63,13,63,31,0],[63,32,63,44,0],[65,13,65,77,0],[66,13,66,32,0],[66,33,66,46,0],[68,13,68,71,0],[69,13,69,41,0],[69,41,70,71,0],[70,71,70,73,0],[69,13,70,73,0],[71,9,71,10,0],[74,9,74,10,0],[75,13,75,91,0],[76,13,76,31,0],[76,32,76,44,0],[78,13,78,71,0],[79,13,79,41,0],[79,41,80,71,0],[80,71,80,73,0],[79,13,80,73,0],[81,9,81,10,0]]);
    </script>
  </body>
</html>