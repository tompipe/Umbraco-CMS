<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\tom pipe\documents\hexadigital\code\umbraco\umbraco-cms\src\umbraco.web.ui\umbraco\developer\packages\directorybrowser.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.UI;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Web.UI.Pages;
using umbraco.BusinessLogic;

namespace Umbraco.Web.UI.Umbraco.Developer.Packages
{
    public partial class DirectoryBrowser : UmbracoEnsuredPage
    {
        public DirectoryBrowser()
        {
            CurrentApp = DefaultApps.developer.ToString();
        }

        string _lsScriptName;
        string _lsWebPath;
        protected string Target = &quot;&quot;;
        private readonly Regex _xssElementIdClean = new Regex(@&quot;^([a-zA-Z0-9-_:\.]+)&quot;);

        private readonly StringBuilder _sb = new StringBuilder();

        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            Response.Cache.SetExpires(DateTime.Now.AddSeconds(5));
            Response.Cache.SetCacheability(HttpCacheability.Public);
            
            //we need to clean this string:
            //http://issues.umbraco.org/issue/U4-2027
            var target = Request.QueryString.Get(&quot;target&quot;);
            if (target.IsNullOrWhiteSpace())
                throw new InvalidOperationException(&quot;The target query string must be set to a valid html element id&quot;);
            var matched = _xssElementIdClean.Matches(target);
            if (matched.Count == 0)
                throw new InvalidOperationException(&quot;The target query string must be set to a valid html element id&quot;);

            Target = matched[0].Value;
            
            try
            {

                //Variables used in script
                var sebChar = IOHelper.DirSepChar.ToString();

                //Work on path and ensure no back tracking
                string sSubDir = Request.QueryString.Get(&quot;path&quot;);
                if (string.IsNullOrEmpty(sSubDir)) { sSubDir = &quot;/&quot;; }

                sSubDir = sSubDir.Replace(IOHelper.DirSepChar.ToString(), &quot;&quot;);
                sSubDir = sSubDir.Replace(&quot;//&quot;, &quot;/&quot;);
                sSubDir = sSubDir.Replace(&quot;..&quot;, &quot;./&quot;);
                sSubDir = sSubDir.Replace(&#39;/&#39;, IOHelper.DirSepChar);

                //Clean path for processing and collect path varitations
                if (sSubDir.Substring(0, 1) != sebChar) { sSubDir = sebChar + sSubDir; }
                if (sSubDir.Substring(sSubDir.Length - 1, 1) != &quot;\\&quot;) { sSubDir = sSubDir + sebChar; }

                //Get name of the browser script file
                _lsScriptName = Request.ServerVariables.Get(&quot;SCRIPT_NAME&quot;);
                var j = _lsScriptName.LastIndexOf(&quot;/&quot;);
                if (j &gt; 0) { _lsScriptName = _lsScriptName.Substring(j + 1, _lsScriptName.Length - (j + 1)).ToLower(); }

                //Create navigation string and other path strings
                GetNavLink(&quot;&quot;, &quot;root&quot;);
                if (sSubDir != sebChar)
                {
                    j = 0; int i = 0;
                    do
                    {
                        i = sSubDir.IndexOf(sebChar, j + 1);
                        _lsWebPath += sSubDir.Substring(j + 1, i - (j + 1)) + &quot;/&quot;;
                        GetNavLink(_lsWebPath, sSubDir.Substring(j + 1, i - (j + 1)));
                        j = i;
                    } while (i != sSubDir.Length - 1);
                }

                //Output header
                _sb.Append(&quot;&lt;table cellpadding=3 cellspacing=1&gt;&lt;tbody&gt;&quot;);

                //Output directorys
                var oDirInfo = new DirectoryInfo(IOHelper.MapPath(&quot;~/&quot; + sSubDir));
                var oDirs = oDirInfo.GetDirectories();
                foreach (var oDir in oDirs)
                {
                    try
                    {
                        _sb.Append(&quot;&lt;tr&gt;&lt;td class=\&quot;tdDir\&quot;&gt;&lt;a href=\&quot;&quot; + _lsScriptName + &quot;?path=&quot; + _lsWebPath + oDir.Name + &quot;&amp;target=&quot; + Target + &quot;\&quot;&gt;&quot; + oDir.Name + &quot;&lt;/a&gt;  &lt;small&gt;&lt;a href=\&quot;javascript:postPath(&#39;/&quot; + _lsWebPath + oDir.Name + &quot;&#39;)\&quot;&gt; (Include entire folder)&lt;/small&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
                    }
                    catch (Exception ex)
                    {
                        _sb.Append(&quot;&lt;tr&gt;&lt;td class=\&quot;tdDir\&quot;&gt;&quot; + oDir.Name + &quot; (Access Denied)&lt;/td&gt;&lt;/tr&gt;&quot;);
                    }
                }

                //Ouput files
                var oFiles = oDirInfo.GetFiles();
                foreach (var oFile in oFiles.Where(oFile =&gt; oFile.Name.ToLower() != _lsScriptName))
                {
                    decimal iLen = oFile.Length;
                    string sLen;
                    if (iLen &gt;= 1048960) { iLen = iLen / 1048960; sLen = &quot;mb&quot;; } else { iLen = iLen / 1024; sLen = &quot;kb&quot;; }
                    sLen = Decimal.Round(iLen, 2).ToString() + sLen;
                    _sb.Append(&quot;&lt;tr&gt;&lt;td class=\&quot;tdFile\&quot;&gt;&lt;a href=\&quot;javascript:postPath(&#39;/&quot; + _lsWebPath + oFile.Name + &quot;&#39;)\&quot;&gt;&quot; + oFile.Name + &quot;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
                }

                //Output footer
                _sb.Append(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/center&gt;&quot;);

            }
            catch (Exception ex)
            {
                RptErr(ex.Message);
            }
        }

        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);
            Output.Controls.Add(new LiteralControl(_sb.ToString()));
        }

        private void RptErr(string psMessage)
        {
            _sb.Append(&quot;&lt;DIV align=\&quot;left\&quot; width=\&quot;100%\&quot;&gt;&lt;B&gt;Script Reported Error: &lt;/B&gt;&amp;nbsp;&quot; + psMessage + &quot;&lt;/DIV&gt;&lt;BR&gt;&quot;);
        }

        private string GetNavLink(string psHref, string psText)
        {
            return (&quot;/&lt;a class=\&quot;tdheadA\&quot; href=\&quot;&quot; + _lsScriptName + &quot;?path=&quot; + psHref + &quot;\&quot;&gt;&quot; + psText + &quot;&lt;/a&gt;&quot;);
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,34,0],[19,9,19,10,0],[20,13,20,59,0],[21,9,21,10,0],[25,9,25,38,0],[26,9,26,88,0],[28,9,28,66,0],[31,9,31,10,0],[32,13,32,28,0],[34,13,34,67,0],[35,13,35,69,0],[39,13,39,60,0],[40,13,40,45,0],[41,17,41,119,0],[42,13,42,62,0],[43,13,43,36,0],[44,17,44,119,0],[46,13,46,39,0],[49,13,49,14,0],[52,17,52,62,0],[55,17,55,66,0],[56,17,56,51,0],[56,52,56,53,0],[56,54,56,68,0],[56,69,56,70,0],[58,17,58,79,0],[59,17,59,54,0],[60,17,60,55,0],[61,17,61,69,0],[64,17,64,56,0],[64,57,64,58,0],[64,59,64,87,0],[64,88,64,89,0],[65,17,65,70,0],[65,71,65,72,0],[65,73,65,101,0],[65,102,65,103,0],[68,17,68,76,0],[69,17,69,56,0],[70,17,70,27,0],[70,28,70,29,0],[70,30,70,119,0],[70,120,70,121,0],[73,17,73,40,0],[74,17,74,40,0],[75,17,75,18,0],[76,21,76,27,0],[76,28,76,38,0],[78,21,78,22,0],[79,25,79,61,0],[80,25,80,83,0],[81,25,81,87,0],[82,25,82,31,0],[83,21,83,22,0],[83,23,83,55,0],[84,17,84,18,0],[87,17,87,74,0],[90,17,90,84,0],[91,17,91,55,0],[92,17,92,24,0],[92,26,92,34,0],[92,35,92,37,0],[92,38,92,43,0],[93,17,93,18,0],[95,21,95,22,0],[96,25,96,295,0],[97,21,97,22,0],[98,21,98,41,0],[99,21,99,22,0],[100,25,100,107,0],[101,21,101,22,0],[102,17,102,18,0],[105,17,105,50,0],[106,17,106,24,0],[106,26,106,35,0],[106,36,106,38,0],[106,39,106,61,0],[106,61,106,98,0],[106,98,106,99,0],[106,39,106,99,0],[107,17,107,18,0],[108,21,108,49,0],[110,21,110,41,0],[110,42,110,43,0],[110,44,110,66,0],[110,67,110,79,0],[110,80,110,81,0],[110,87,110,88,0],[110,89,110,108,0],[110,109,110,121,0],[110,122,110,123,0],[111,21,111,69,0],[112,21,112,161,0],[113,17,113,18,0],[116,17,116,57,0],[118,13,118,14,0],[119,13,119,33,0],[120,13,120,14,0],[121,17,121,36,0],[122,13,122,14,0],[123,9,123,10,0],[126,9,126,10,0],[127,13,127,33,0],[128,13,128,69,0],[129,9,129,10,0],[132,9,132,10,0],[133,13,133,126,0],[134,9,134,10,0],[137,9,137,10,0],[138,13,138,116,0],[139,9,139,10,0]]);
    </script>
  </body>
</html>