<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Services\RelationService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Events;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Services
{
    public class RelationService : RepositoryService, IRelationService
    {
        private readonly IEntityService _entityService;
        
        public RelationService(IDatabaseUnitOfWorkProvider uowProvider, RepositoryFactory repositoryFactory, ILogger logger, IEventMessagesFactory eventMessagesFactory, IEntityService entityService)
            : base(uowProvider, repositoryFactory, logger, eventMessagesFactory)
        {
            if (entityService == null) throw new ArgumentNullException(&quot;entityService&quot;);
            _entityService = entityService;
        }

        /// &lt;summary&gt;
        /// Gets a &lt;see cref=&quot;Relation&quot;/&gt; by its Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;Relation&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;A &lt;see cref=&quot;Relation&quot;/&gt; object&lt;/returns&gt;
        public IRelation GetById(int id)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(id);
            }
        }

        /// &lt;summary&gt;
        /// Gets a &lt;see cref=&quot;RelationType&quot;/&gt; by its Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;RelationType&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;A &lt;see cref=&quot;RelationType&quot;/&gt; object&lt;/returns&gt;
        public IRelationType GetRelationTypeById(int id)
        {
            using (var repository = RepositoryFactory.CreateRelationTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(id);
            }
        }

        /// &lt;summary&gt;
        /// Gets a &lt;see cref=&quot;RelationType&quot;/&gt; by its Alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;Alias of the &lt;see cref=&quot;RelationType&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;A &lt;see cref=&quot;RelationType&quot;/&gt; object&lt;/returns&gt;
        public IRelationType GetRelationTypeByAlias(string alias)
        {
            using (var repository = RepositoryFactory.CreateRelationTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelationType&gt;().Where(x =&gt; x.Alias == alias);
                return repository.GetByQuery(query).FirstOrDefault();
            }
        }

        /// &lt;summary&gt;
        /// Gets all &lt;see cref=&quot;Relation&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ids&quot;&gt;Optional array of integer ids to return relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetAllRelations(params int[] ids)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(ids);
            }
        }

        /// &lt;summary&gt;
        /// Gets all &lt;see cref=&quot;Relation&quot;/&gt; objects by their &lt;see cref=&quot;RelationType&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationType&quot;&gt;&lt;see cref=&quot;RelationType&quot;/&gt; to retrieve Relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetAllRelationsByRelationType(RelationType relationType)
        {
            return GetAllRelationsByRelationType(relationType.Id);
        }

        /// &lt;summary&gt;
        /// Gets all &lt;see cref=&quot;Relation&quot;/&gt; objects by their &lt;see cref=&quot;RelationType&quot;/&gt;&#39;s Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationTypeId&quot;&gt;Id of the &lt;see cref=&quot;RelationType&quot;/&gt; to retrieve Relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetAllRelationsByRelationType(int relationTypeId)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.RelationTypeId == relationTypeId);
                return repository.GetByQuery(query);
            }
        }

        /// &lt;summary&gt;
        /// Gets all &lt;see cref=&quot;Relation&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ids&quot;&gt;Optional array of integer ids to return relationtypes for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;RelationType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelationType&gt; GetAllRelationTypes(params int[] ids)
        {
            using (var repository = RepositoryFactory.CreateRelationTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(ids);
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by their parent Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the parent to retrieve relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByParentId(int id)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.ParentId == id);
                return repository.GetByQuery(query);
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by their parent entity
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parent&quot;&gt;Parent Entity to retrieve relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByParent(IUmbracoEntity parent)
        {
            return GetByParentId(parent.Id);
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by their parent entity
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parent&quot;&gt;Parent Entity to retrieve relations for&lt;/param&gt;
        /// &lt;param name=&quot;relationTypeAlias&quot;&gt;Alias of the type of relation to retrieve&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByParent(IUmbracoEntity parent, string relationTypeAlias)
        {
            return GetByParent(parent).Where(relation =&gt; relation.RelationType.Alias == relationTypeAlias);
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by their child Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the child to retrieve relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByChildId(int id)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.ChildId == id);
                return repository.GetByQuery(query);
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by their child Entity
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;child&quot;&gt;Child Entity to retrieve relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByChild(IUmbracoEntity child)
        {
            return GetByChildId(child.Id);
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by their child Entity
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;child&quot;&gt;Child Entity to retrieve relations for&lt;/param&gt;
        /// &lt;param name=&quot;relationTypeAlias&quot;&gt;Alias of the type of relation to retrieve&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByChild(IUmbracoEntity child, string relationTypeAlias)
        {
            return GetByChild(child).Where(relation =&gt; relation.RelationType.Alias == relationTypeAlias);
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by their child or parent Id.
        /// Using this method will get you all relations regards of it being a child or parent relation.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the child or parent to retrieve relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByParentOrChildId(int id)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.ChildId == id || x.ParentId == id);
                return repository.GetByQuery(query);
            }
        }

        public IEnumerable&lt;IRelation&gt; GetByParentOrChildId(int id, string relationTypeAlias)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var relationTypeRepository = RepositoryFactory.CreateRelationTypeRepository(uow))
            {
                var rtQuery = new Query&lt;IRelationType&gt;().Where(x =&gt; x.Alias == relationTypeAlias);
                var relationType = relationTypeRepository.GetByQuery(rtQuery).FirstOrDefault();
                if (relationType == null) return Enumerable.Empty&lt;IRelation&gt;();

                using (var relationRepo = RepositoryFactory.CreateRelationRepository(uow))
                {
                    var query = new Query&lt;IRelation&gt;().Where(x =&gt; (x.ChildId == id || x.ParentId == id) &amp;&amp; x.RelationTypeId == relationType.Id);
                    return relationRepo.GetByQuery(query);
                }
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by the Name of the &lt;see cref=&quot;RelationType&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationTypeName&quot;&gt;Name of the &lt;see cref=&quot;RelationType&quot;/&gt; to retrieve Relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByRelationTypeName(string relationTypeName)
        {
            List&lt;int&gt; relationTypeIds = null;
            using (var repository = RepositoryFactory.CreateRelationTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelationType&gt;().Where(x =&gt; x.Name == relationTypeName);
                var relationTypes = repository.GetByQuery(query);
                if (relationTypes.Any())
                {
                    relationTypeIds = relationTypes.Select(x =&gt; x.Id).ToList();
                }
            }

            if (relationTypeIds == null)
                return Enumerable.Empty&lt;IRelation&gt;();

            return GetRelationsByListOfTypeIds(relationTypeIds);
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by the Alias of the &lt;see cref=&quot;RelationType&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationTypeAlias&quot;&gt;Alias of the &lt;see cref=&quot;RelationType&quot;/&gt; to retrieve Relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByRelationTypeAlias(string relationTypeAlias)
        {
            List&lt;int&gt; relationTypeIds = null;
            using (var repository = RepositoryFactory.CreateRelationTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelationType&gt;().Where(x =&gt; x.Alias == relationTypeAlias);
                var relationTypes = repository.GetByQuery(query);
                if (relationTypes.Any())
                {
                    relationTypeIds = relationTypes.Select(x =&gt; x.Id).ToList();
                }
            }

            if (relationTypeIds == null)
                return Enumerable.Empty&lt;IRelation&gt;();

            return GetRelationsByListOfTypeIds(relationTypeIds);
        }

        /// &lt;summary&gt;
        /// Gets a list of &lt;see cref=&quot;Relation&quot;/&gt; objects by the Id of the &lt;see cref=&quot;RelationType&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationTypeId&quot;&gt;Id of the &lt;see cref=&quot;RelationType&quot;/&gt; to retrieve Relations for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Relation&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IRelation&gt; GetByRelationTypeId(int relationTypeId)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.RelationTypeId == relationTypeId);
                return repository.GetByQuery(query);
            }
        }

        /// &lt;summary&gt;
        /// Gets the Child object from a Relation as an &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relation&quot;&gt;Relation to retrieve child object from&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;&lt;/param&gt;
        /// &lt;returns&gt;An &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public IUmbracoEntity GetChildEntityFromRelation(IRelation relation, bool loadBaseType = false)
        {
            var objectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(relation.RelationType.ChildObjectType);
            return _entityService.Get(relation.ChildId, objectType, loadBaseType);
        }

        /// &lt;summary&gt;
        /// Gets the Parent object from a Relation as an &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relation&quot;&gt;Relation to retrieve parent object from&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;&lt;/param&gt;
        /// &lt;returns&gt;An &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public IUmbracoEntity GetParentEntityFromRelation(IRelation relation, bool loadBaseType = false)
        {
            var objectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(relation.RelationType.ParentObjectType);
            return _entityService.Get(relation.ParentId, objectType, loadBaseType);
        }

        /// &lt;summary&gt;
        /// Gets the Parent and Child objects from a Relation as a &lt;see cref=&quot;Tuple&quot;/&gt;&quot;/&gt; with &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relation&quot;&gt;Relation to retrieve parent and child object from&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;&lt;/param&gt;
        /// &lt;returns&gt;Returns a Tuple with Parent (item1) and Child (item2)&lt;/returns&gt;
        public Tuple&lt;IUmbracoEntity, IUmbracoEntity&gt; GetEntitiesFromRelation(IRelation relation, bool loadBaseType = false)
        {
            var childObjectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(relation.RelationType.ChildObjectType);
            var parentObjectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(relation.RelationType.ParentObjectType);

            var child = _entityService.Get(relation.ChildId, childObjectType, loadBaseType);
            var parent = _entityService.Get(relation.ParentId, parentObjectType, loadBaseType);

            return new Tuple&lt;IUmbracoEntity, IUmbracoEntity&gt;(parent, child);
        }

        /// &lt;summary&gt;
        /// Gets the Child objects from a list of Relations as a list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relations&quot;&gt;List of relations to retrieve child objects from&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public IEnumerable&lt;IUmbracoEntity&gt; GetChildEntitiesFromRelations(IEnumerable&lt;IRelation&gt; relations, bool loadBaseType = false)
        {
            foreach (var relation in relations)
            {
                var objectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(relation.RelationType.ChildObjectType);
                yield return _entityService.Get(relation.ChildId, objectType, loadBaseType);
            }
        }

        /// &lt;summary&gt;
        /// Gets the Parent objects from a list of Relations as a list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relations&quot;&gt;List of relations to retrieve parent objects from&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public IEnumerable&lt;IUmbracoEntity&gt; GetParentEntitiesFromRelations(IEnumerable&lt;IRelation&gt; relations,
                                                                          bool loadBaseType = false)
        {
            foreach (var relation in relations)
            {
                var objectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(relation.RelationType.ParentObjectType);
                yield return _entityService.Get(relation.ParentId, objectType, loadBaseType);
            }
        }

        /// &lt;summary&gt;
        /// Gets the Parent and Child objects from a list of Relations as a list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relations&quot;&gt;List of relations to retrieve parent and child objects from&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Tuple&quot;/&gt; with &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public IEnumerable&lt;Tuple&lt;IUmbracoEntity, IUmbracoEntity&gt;&gt; GetEntitiesFromRelations(
            IEnumerable&lt;IRelation&gt; relations,
            bool loadBaseType = false)
        {
            foreach (var relation in relations)
            {
                var childObjectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(relation.RelationType.ChildObjectType);
                var parentObjectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(relation.RelationType.ParentObjectType);

                var child = _entityService.Get(relation.ChildId, childObjectType, loadBaseType);
                var parent = _entityService.Get(relation.ParentId, parentObjectType, loadBaseType);

                yield return new Tuple&lt;IUmbracoEntity, IUmbracoEntity&gt;(parent, child);
            }
        }

        /// &lt;summary&gt;
        /// Relates two objects that are based on the &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; interface.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parent&quot;&gt;Parent entity&lt;/param&gt;
        /// &lt;param name=&quot;child&quot;&gt;Child entity&lt;/param&gt;
        /// &lt;param name=&quot;relationType&quot;&gt;The type of relation to create&lt;/param&gt;
        /// &lt;returns&gt;The created &lt;see cref=&quot;Relation&quot;/&gt;&lt;/returns&gt;
        public IRelation Relate(IUmbracoEntity parent, IUmbracoEntity child, IRelationType relationType)
        {
            //Ensure that the RelationType has an indentity before using it to relate two entities
            if (relationType.HasIdentity == false)
                Save(relationType);

            var relation = new Relation(parent.Id, child.Id, relationType);
            if (SavingRelation.IsRaisedEventCancelled(new SaveEventArgs&lt;IRelation&gt;(relation), this))
                return relation;

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateRelationRepository(uow))
            {
                repository.AddOrUpdate(relation);
                uow.Commit();
            }

            SavedRelation.RaiseEvent(new SaveEventArgs&lt;IRelation&gt;(relation, false), this);
            return relation;
        }

        /// &lt;summary&gt;
        /// Relates two objects that are based on the &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; interface.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parent&quot;&gt;Parent entity&lt;/param&gt;
        /// &lt;param name=&quot;child&quot;&gt;Child entity&lt;/param&gt;
        /// &lt;param name=&quot;relationTypeAlias&quot;&gt;Alias of the type of relation to create&lt;/param&gt;
        /// &lt;returns&gt;The created &lt;see cref=&quot;Relation&quot;/&gt;&lt;/returns&gt;
        public IRelation Relate(IUmbracoEntity parent, IUmbracoEntity child, string relationTypeAlias)
        {
            var relationType = GetRelationTypeByAlias(relationTypeAlias);
            if (relationType == null || string.IsNullOrEmpty(relationType.Alias))
                throw new ArgumentNullException(string.Format(&quot;No RelationType with Alias &#39;{0}&#39; exists.&quot;, relationTypeAlias));

            var relation = new Relation(parent.Id, child.Id, relationType);
            if (SavingRelation.IsRaisedEventCancelled(new SaveEventArgs&lt;IRelation&gt;(relation), this))
                return relation;

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateRelationRepository(uow))
            {
                repository.AddOrUpdate(relation);
                uow.Commit();
            }

            SavedRelation.RaiseEvent(new SaveEventArgs&lt;IRelation&gt;(relation, false), this);
            return relation;
        }

        /// &lt;summary&gt;
        /// Checks whether any relations exists for the passed in &lt;see cref=&quot;RelationType&quot;/&gt;.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationType&quot;&gt;&lt;see cref=&quot;RelationType&quot;/&gt; to check for relations&lt;/param&gt;
        /// &lt;returns&gt;Returns &lt;c&gt;True&lt;/c&gt; if any relations exists for the given &lt;see cref=&quot;RelationType&quot;/&gt;, otherwise &lt;c&gt;False&lt;/c&gt;&lt;/returns&gt;
        public bool HasRelations(IRelationType relationType)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.RelationTypeId == relationType.Id);
                return repository.GetByQuery(query).Any();
            }
        }

        /// &lt;summary&gt;
        /// Checks whether any relations exists for the passed in Id.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of an object to check relations for&lt;/param&gt;
        /// &lt;returns&gt;Returns &lt;c&gt;True&lt;/c&gt; if any relations exists with the given Id, otherwise &lt;c&gt;False&lt;/c&gt;&lt;/returns&gt;
        public bool IsRelated(int id)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.ParentId == id || x.ChildId == id);
                return repository.GetByQuery(query).Any();
            }
        }

        /// &lt;summary&gt;
        /// Checks whether two items are related
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;Id of the Parent relation&lt;/param&gt;
        /// &lt;param name=&quot;childId&quot;&gt;Id of the Child relation&lt;/param&gt;
        /// &lt;returns&gt;Returns &lt;c&gt;True&lt;/c&gt; if any relations exists with the given Ids, otherwise &lt;c&gt;False&lt;/c&gt;&lt;/returns&gt;
        public bool AreRelated(int parentId, int childId)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.ParentId == parentId &amp;&amp; x.ChildId == childId);
                return repository.GetByQuery(query).Any();
            }
        }

        /// &lt;summary&gt;
        /// Checks whether two items are related with a given relation type alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;Id of the Parent relation&lt;/param&gt;
        /// &lt;param name=&quot;childId&quot;&gt;Id of the Child relation&lt;/param&gt;
        /// &lt;param name=&quot;relationTypeAlias&quot;&gt;Alias of the relation type&lt;/param&gt;
        /// &lt;returns&gt;Returns &lt;c&gt;True&lt;/c&gt; if any relations exists with the given Ids and relation type, otherwise &lt;c&gt;False&lt;/c&gt;&lt;/returns&gt;
        public bool AreRelated(int parentId, int childId, string relationTypeAlias)
        {
            var relType = GetRelationTypeByAlias(relationTypeAlias);
            if (relType == null)
                return false;

            return AreRelated(parentId, childId, relType);
        }


        /// &lt;summary&gt;
        /// Checks whether two items are related with a given relation type
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;Id of the Parent relation&lt;/param&gt;
        /// &lt;param name=&quot;childId&quot;&gt;Id of the Child relation&lt;/param&gt;
        /// &lt;param name=&quot;relationTypeAlias&quot;&gt;Type of relation&lt;/param&gt;
        /// &lt;returns&gt;Returns &lt;c&gt;True&lt;/c&gt; if any relations exists with the given Ids and relation type, otherwise &lt;c&gt;False&lt;/c&gt;&lt;/returns&gt;
        public bool AreRelated(int parentId, int childId, IRelationType relationType)
        {
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.ParentId == parentId &amp;&amp; x.ChildId == childId &amp;&amp; x.RelationTypeId == relationType.Id);
                return repository.GetByQuery(query).Any();
            }
        }

        /// &lt;summary&gt;
        /// Checks whether two items are related
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parent&quot;&gt;Parent entity&lt;/param&gt;
        /// &lt;param name=&quot;child&quot;&gt;Child entity&lt;/param&gt;
        /// &lt;returns&gt;Returns &lt;c&gt;True&lt;/c&gt; if any relations exist between the entities, otherwise &lt;c&gt;False&lt;/c&gt;&lt;/returns&gt;
        public bool AreRelated(IUmbracoEntity parent, IUmbracoEntity child)
        {
            return AreRelated(parent.Id, child.Id);
        }

        /// &lt;summary&gt;
        /// Checks whether two items are related
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parent&quot;&gt;Parent entity&lt;/param&gt;
        /// &lt;param name=&quot;child&quot;&gt;Child entity&lt;/param&gt;
        /// &lt;param name=&quot;relationTypeAlias&quot;&gt;Alias of the type of relation to create&lt;/param&gt;
        /// &lt;returns&gt;Returns &lt;c&gt;True&lt;/c&gt; if any relations exist between the entities, otherwise &lt;c&gt;False&lt;/c&gt;&lt;/returns&gt;
        public bool AreRelated(IUmbracoEntity parent, IUmbracoEntity child, string relationTypeAlias)
        {
            return AreRelated(parent.Id, child.Id, relationTypeAlias);
        }


        /// &lt;summary&gt;
        /// Saves a &lt;see cref=&quot;Relation&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relation&quot;&gt;Relation to save&lt;/param&gt;
        public void Save(IRelation relation)
        {
            if (SavingRelation.IsRaisedEventCancelled(new SaveEventArgs&lt;IRelation&gt;(relation), this))
                return;

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateRelationRepository(uow))
            {
                repository.AddOrUpdate(relation);
                uow.Commit();
            }

            SavedRelation.RaiseEvent(new SaveEventArgs&lt;IRelation&gt;(relation, false), this);
        }

        /// &lt;summary&gt;
        /// Saves a &lt;see cref=&quot;RelationType&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationType&quot;&gt;RelationType to Save&lt;/param&gt;
        public void Save(IRelationType relationType)
        {
            if (SavingRelationType.IsRaisedEventCancelled(new SaveEventArgs&lt;IRelationType&gt;(relationType), this))
                return;

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateRelationTypeRepository(uow))
            {
                repository.AddOrUpdate(relationType);
                uow.Commit();
            }

            SavedRelationType.RaiseEvent(new SaveEventArgs&lt;IRelationType&gt;(relationType, false), this);
        }

        /// &lt;summary&gt;
        /// Deletes a &lt;see cref=&quot;Relation&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relation&quot;&gt;Relation to Delete&lt;/param&gt;
        public void Delete(IRelation relation)
        {
            if (DeletingRelation.IsRaisedEventCancelled(new DeleteEventArgs&lt;IRelation&gt;(relation), this))
                return;

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateRelationRepository(uow))
            {
                repository.Delete(relation);
                uow.Commit();
            }

            DeletedRelation.RaiseEvent(new DeleteEventArgs&lt;IRelation&gt;(relation, false), this);
        }

        /// &lt;summary&gt;
        /// Deletes a &lt;see cref=&quot;RelationType&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationType&quot;&gt;RelationType to Delete&lt;/param&gt;
        public void Delete(IRelationType relationType)
        {
            if (DeletingRelationType.IsRaisedEventCancelled(new DeleteEventArgs&lt;IRelationType&gt;(relationType), this))
                return;

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateRelationTypeRepository(uow))
            {
                repository.Delete(relationType);
                uow.Commit();
            }

            DeletedRelationType.RaiseEvent(new DeleteEventArgs&lt;IRelationType&gt;(relationType, false), this);
        }

        /// &lt;summary&gt;
        /// Deletes all &lt;see cref=&quot;Relation&quot;/&gt; objects based on the passed in &lt;see cref=&quot;RelationType&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationType&quot;&gt;&lt;see cref=&quot;RelationType&quot;/&gt; to Delete Relations for&lt;/param&gt;
        public void DeleteRelationsOfType(IRelationType relationType)
        {
            var relations = new List&lt;IRelation&gt;();
            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateRelationRepository(uow))
            {
                var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.RelationTypeId == relationType.Id);
                relations.AddRange(repository.GetByQuery(query).ToList());

                foreach (var relation in relations)
                {
                    repository.Delete(relation);
                }
                uow.Commit();
            }

            DeletedRelation.RaiseEvent(new DeleteEventArgs&lt;IRelation&gt;(relations, false), this);
        }

        #region Private Methods
        private IEnumerable&lt;IRelation&gt; GetRelationsByListOfTypeIds(IEnumerable&lt;int&gt; relationTypeIds)
        {
            var relations = new List&lt;IRelation&gt;();
            using (var repository = RepositoryFactory.CreateRelationRepository(UowProvider.GetUnitOfWork()))
            {
                foreach (var relationTypeId in relationTypeIds)
                {
                    int id = relationTypeId;
                    var query = new Query&lt;IRelation&gt;().Where(x =&gt; x.RelationTypeId == id);
                    relations.AddRange(repository.GetByQuery(query).ToList());
                }
            }
            return relations;
        }
        #endregion

        #region Events Handlers
        /// &lt;summary&gt;
        /// Occurs before Deleting a Relation
        /// &lt;/summary&gt;		
        public static event TypedEventHandler&lt;IRelationService, DeleteEventArgs&lt;IRelation&gt;&gt; DeletingRelation;

        /// &lt;summary&gt;
        /// Occurs after a Relation is Deleted
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IRelationService, DeleteEventArgs&lt;IRelation&gt;&gt; DeletedRelation;

        /// &lt;summary&gt;
        /// Occurs before Saving a Relation
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IRelationService, SaveEventArgs&lt;IRelation&gt;&gt; SavingRelation;

        /// &lt;summary&gt;
        /// Occurs after a Relation is Saved
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IRelationService, SaveEventArgs&lt;IRelation&gt;&gt; SavedRelation;

        /// &lt;summary&gt;
        /// Occurs before Deleting a RelationType
        /// &lt;/summary&gt;		
        public static event TypedEventHandler&lt;IRelationService, DeleteEventArgs&lt;IRelationType&gt;&gt; DeletingRelationType;

        /// &lt;summary&gt;
        /// Occurs after a RelationType is Deleted
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IRelationService, DeleteEventArgs&lt;IRelationType&gt;&gt; DeletedRelationType;

        /// &lt;summary&gt;
        /// Occurs before Saving a RelationType
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IRelationService, SaveEventArgs&lt;IRelationType&gt;&gt; SavingRelationType;

        /// &lt;summary&gt;
        /// Occurs after a RelationType is Saved
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IRelationService, SaveEventArgs&lt;IRelationType&gt;&gt; SavedRelationType;
        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,15,19,81,1],[20,9,20,10,1],[21,13,21,39,1],[21,40,21,89,0],[22,13,22,44,1],[23,9,23,10,1],[31,9,31,10,0],[32,20,32,108,0],[33,13,33,14,0],[34,17,34,43,0],[36,9,36,10,0],[44,9,44,10,0],[45,20,45,112,0],[46,13,46,14,0],[47,17,47,43,0],[49,9,49,10,0],[57,9,57,10,1],[58,20,58,112,1],[59,13,59,14,1],[60,17,60,85,1],[61,17,61,70,1],[63,9,63,10,1],[71,9,71,10,0],[72,20,72,108,0],[73,13,73,14,0],[74,17,74,47,0],[76,9,76,10,0],[84,9,84,10,0],[85,13,85,67,0],[86,9,86,10,0],[94,9,94,10,0],[95,20,95,108,0],[96,13,96,14,0],[97,17,97,99,0],[98,17,98,53,0],[100,9,100,10,0],[108,9,108,10,0],[109,20,109,112,0],[110,13,110,14,0],[111,17,111,47,0],[113,9,113,10,0],[121,9,121,10,0],[122,20,122,108,0],[123,13,123,14,0],[124,17,124,81,0],[125,17,125,53,0],[127,9,127,10,0],[135,9,135,10,0],[136,13,136,45,0],[137,9,137,10,0],[146,9,146,10,0],[147,13,147,58,0],[147,58,147,106,0],[147,106,147,108,0],[147,13,147,108,0],[148,9,148,10,0],[156,9,156,10,0],[157,20,157,108,0],[158,13,158,14,0],[159,17,159,80,0],[160,17,160,53,0],[162,9,162,10,0],[170,9,170,10,0],[171,13,171,43,0],[172,9,172,10,0],[181,9,181,10,0],[182,13,182,56,0],[182,56,182,104,0],[182,104,182,106,0],[182,13,182,106,0],[183,9,183,10,0],[192,9,192,10,0],[193,20,193,108,0],[194,13,194,14,0],[195,17,195,100,0],[196,17,196,53,0],[198,9,198,10,0],[201,9,201,10,0],[202,13,202,51,0],[203,20,203,100,0],[204,13,204,14,0],[205,17,205,99,0],[206,17,206,96,0],[207,17,207,42,0],[207,43,207,80,0],[209,24,209,90,0],[210,17,210,18,0],[211,21,211,145,0],[212,21,212,59,0],[215,9,215,10,0],[223,9,223,10,0],[224,13,224,46,0],[225,20,225,112,0],[226,13,226,14,0],[227,17,227,95,0],[228,17,228,66,0],[229,17,229,41,0],[230,17,230,18,0],[231,21,231,65,0],[231,65,231,69,0],[231,69,231,80,0],[231,21,231,80,0],[232,17,232,18,0],[233,13,233,14,0],[235,13,235,41,0],[236,17,236,54,0],[238,13,238,65,0],[239,9,239,10,0],[247,9,247,10,0],[248,13,248,46,0],[249,20,249,112,0],[250,13,250,14,0],[251,17,251,97,0],[252,17,252,66,0],[253,17,253,41,0],[254,17,254,18,0],[255,21,255,65,0],[255,65,255,69,0],[255,69,255,80,0],[255,21,255,80,0],[256,17,256,18,0],[257,13,257,14,0],[259,13,259,41,0],[260,17,260,54,0],[262,13,262,65,0],[263,9,263,10,0],[271,9,271,10,0],[272,20,272,108,0],[273,13,273,14,0],[274,17,274,99,0],[275,17,275,53,0],[277,9,277,10,0],[286,9,286,10,0],[287,13,287,119,0],[288,13,288,83,0],[289,9,289,10,0],[298,9,298,10,0],[299,13,299,120,0],[300,13,300,84,0],[301,9,301,10,0],[310,9,310,10,0],[311,13,311,124,0],[312,13,312,126,0],[314,13,314,93,0],[315,13,315,96,0],[317,13,317,77,0],[318,9,318,10,0],[381,9,381,10,0],[383,13,383,51,0],[384,17,384,36,0],[386,13,386,76,0],[387,13,387,101,0],[388,17,388,33,0],[390,13,390,51,0],[391,20,391,84,0],[392,13,392,14,0],[393,17,393,50,0],[394,17,394,30,0],[395,13,395,14,0],[397,13,397,91,0],[398,13,398,29,0],[399,9,399,10,0],[409,9,409,10,1],[410,13,410,74,1],[411,13,411,82,1],[412,17,412,127,0],[414,13,414,76,1],[415,13,415,101,1],[416,17,416,33,0],[418,13,418,51,1],[419,20,419,84,1],[420,13,420,14,1],[421,17,421,50,1],[422,17,422,30,1],[423,13,423,14,1],[425,13,425,91,1],[426,13,426,29,1],[427,9,427,10,1],[435,9,435,10,0],[436,20,436,108,0],[437,13,437,14,0],[438,17,438,100,0],[439,17,439,59,0],[441,9,441,10,0],[449,9,449,10,0],[450,20,450,108,0],[451,13,451,14,0],[452,17,452,100,0],[453,17,453,59,0],[455,9,455,10,0],[464,9,464,10,0],[465,20,465,108,0],[466,13,466,14,0],[467,17,467,111,0],[468,17,468,59,0],[470,9,470,10,0],[480,9,480,10,0],[481,13,481,69,0],[482,13,482,33,0],[483,17,483,30,0],[485,13,485,59,0],[486,9,486,10,0],[497,9,497,10,0],[498,20,498,108,0],[499,13,499,14,0],[500,17,500,150,0],[501,17,501,59,0],[503,9,503,10,0],[512,9,512,10,0],[513,13,513,52,0],[514,9,514,10,0],[524,9,524,10,0],[525,13,525,71,0],[526,9,526,10,0],[534,9,534,10,0],[535,13,535,101,0],[536,17,536,24,0],[538,13,538,51,0],[539,20,539,84,0],[540,13,540,14,0],[541,17,541,50,0],[542,17,542,30,0],[543,13,543,14,0],[545,13,545,91,0],[546,9,546,10,0],[553,9,553,10,1],[554,13,554,113,1],[555,17,555,24,0],[557,13,557,51,1],[558,20,558,88,1],[559,13,559,14,1],[560,17,560,54,1],[561,17,561,30,1],[562,13,562,14,1],[564,13,564,103,1],[565,9,565,10,1],[572,9,572,10,0],[573,13,573,105,0],[574,17,574,24,0],[576,13,576,51,0],[577,20,577,84,0],[578,13,578,14,0],[579,17,579,45,0],[580,17,580,30,0],[581,13,581,14,0],[583,13,583,95,0],[584,9,584,10,0],[591,9,591,10,0],[592,13,592,117,0],[593,17,593,24,0],[595,13,595,51,0],[596,20,596,88,0],[597,13,597,14,0],[598,17,598,49,0],[599,17,599,30,0],[600,13,600,14,0],[602,13,602,107,0],[603,9,603,10,0],[610,9,610,10,0],[611,13,611,51,0],[612,13,612,51,0],[613,20,613,84,0],[614,13,614,14,0],[615,17,615,100,0],[616,17,616,75,0],[618,17,618,24,0],[618,26,618,38,0],[618,39,618,41,0],[618,42,618,51,0],[619,17,619,18,0],[620,21,620,49,0],[621,17,621,18,0],[622,17,622,30,0],[623,13,623,14,0],[625,13,625,96,0],[626,9,626,10,0],[630,9,630,10,0],[631,13,631,51,0],[632,20,632,108,0],[633,13,633,14,0],[634,17,634,24,0],[634,26,634,44,0],[634,45,634,47,0],[634,48,634,63,0],[635,17,635,18,0],[636,21,636,45,0],[637,21,637,91,0],[638,21,638,79,0],[639,17,639,18,0],[640,13,640,14,0],[641,13,641,30,0],[642,9,642,10,0]]);
    </script>
  </body>
</html>