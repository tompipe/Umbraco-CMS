<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\PublishedContent\PublishedContentExtended.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;

namespace Umbraco.Core.Models.PublishedContent
{

    public class PublishedContentExtended : PublishedContentWrapped, IPublishedContentExtended
    {
        #region Constructor

        // protected for models, private for our static Extend method
        protected PublishedContentExtended(IPublishedContent content)
            : base(content)
        { }

        #endregion

        #region Index

        private int? _index;

        public override int GetIndex()
        {
            // fast
            if (_index.HasValue) return _index.Value;

            // slow -- and don&#39;t cache, not in a set
            if (_contentSet == null) return Content.GetIndex();

            // slow -- but cache for next time
            var index = _contentSet.FindIndex(x =&gt; x.Id == Id);
            if (index &lt; 0)
                throw new IndexOutOfRangeException(&quot;Could not find content in the content set.&quot;);
            _index = index;
            return index;
        }

        #endregion

        #region Extend

        internal static IPublishedContentExtended Extend(IPublishedContent content, IEnumerable&lt;IPublishedContent&gt; contentSet)
        {
            // first unwrap content down to the lowest possible level, ie either the deepest inner
            // IPublishedContent or the first extended that has added properties. this is to avoid
            // nesting extended objects as much as possible, so we try to re-extend that lowest
            // object.

            var wrapped = content as PublishedContentExtended;
            while (wrapped != null &amp;&amp; ((IPublishedContentExtended)wrapped).HasAddedProperties == false)
                wrapped = (content = wrapped.Unwrap()) as PublishedContentExtended;

            // if the factory returns something else than content it means it has created
            // a model, and then that model has to inherit from PublishedContentExtended,
            // =&gt; implements the internal IPublishedContentExtended.

            // here we assume that either the factory just created a model that implements
            // IPublishedContentExtended and therefore does not need to be extended again,
            // because it can carry the extra property - or that it did *not* create a
            // model and therefore returned the original content unchanged.

            var model = content.CreateModel();
            IPublishedContent extended;
            if (model == content) // == means the factory did not create a model
            {
                // so we have to extend
                var contentWithKey = content as IPublishedContentWithKey;
                extended = contentWithKey == null
                    ? new PublishedContentExtended(content)
                    : new PublishedContentWithKeyExtended(contentWithKey);
            }
            else
            {
                // else we can use what the factory returned
                extended = model;
            }

            // so extended should always implement IPublishedContentExtended, however if
            // by mistake the factory returned a different object that does not implement
            // IPublishedContentExtended (which would be an error), throw.
            //
            // see also PublishedContentExtensionsForModels.CreateModel

            // NOTE
            // could we lift that constraint and accept that models just be IPublishedContent?
            // would then mean that we cannot assume a model is IPublishedContentExtended, so
            // either it is, or we need to wrap it. so instead of having
            //   (Model:IPublishedContentExtended (IPublishedContent))
            // we&#39;d have
            //   (PublishedContentExtended (Model (IPublishedContent)))
            // and it is that bad? any other consequences?
            //
            // would also allow the factory to cache the model (though that should really
            // be done by the content cache, not by the factory).

            var extended2 = extended as IPublishedContentExtended;
            if (extended2 == null)
                throw new Exception(&quot;Extended does not implement IPublishedContentExtended.&quot;);
            extended2.SetContentSet(contentSet);
            return extended2;
        }

        #endregion

        #region IPublishedContentExtended

        void IPublishedContentExtended.AddProperty(IPublishedProperty property)
        {
            if (_properties == null)
                _properties = new Collection&lt;IPublishedProperty&gt;();
            _properties.Add(property);
        }

        bool IPublishedContentExtended.HasAddedProperties
        {
            get { return _properties != null; }
        }

        void IPublishedContentExtended.SetContentSet(IEnumerable&lt;IPublishedContent&gt; contentSet)
        {
            _contentSet = contentSet;
        }

        void IPublishedContentExtended.ClearContentSet()
        {
            _contentSet = null;
        }

        void IPublishedContentExtended.SetIndex(int value)
        {
            _index = value;
        }

        void IPublishedContentExtended.ClearIndex()
        {
            _index = null;
        }

        #endregion

        #region Content set

        private IEnumerable&lt;IPublishedContent&gt; _contentSet;

        public override IEnumerable&lt;IPublishedContent&gt; ContentSet
        {
            get { return _contentSet ?? Content.ContentSet; }
        }

        #endregion

        #region Properties

        private ICollection&lt;IPublishedProperty&gt; _properties;

        public override ICollection&lt;IPublishedProperty&gt; Properties
        {
            get
            {
                return _properties == null
                    ? Content.Properties
                    : Content.Properties.Union(_properties).ToList();
            }
        }

        public override object this[string alias]
        {
            get
            {
                if (_properties != null)
                {
                    var property = _properties.FirstOrDefault(prop =&gt; prop.PropertyTypeAlias.InvariantEquals(alias));
                    if (property != null) return property.HasValue ? property.Value : null;
                }
                return Content[alias];
            }
        }

        public override IPublishedProperty GetProperty(string alias)
        {
            return _properties == null
                ? Content.GetProperty(alias)
                : _properties.FirstOrDefault(prop =&gt; prop.PropertyTypeAlias.InvariantEquals(alias)) ?? Content.GetProperty(alias);
        }

        #endregion
    }

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[15,15,15,28,1],[16,9,16,10,1],[16,11,16,12,1],[25,9,25,10,1],[27,13,27,33,1],[27,34,27,54,1],[30,13,30,37,1],[30,38,30,64,1],[33,13,33,52,1],[33,52,33,62,1],[33,62,33,64,1],[33,13,33,64,1],[34,13,34,27,1],[35,17,35,98,0],[36,13,36,28,1],[37,13,37,26,1],[38,9,38,10,1],[45,9,45,10,1],[51,13,51,63,1],[52,13,52,104,1],[53,17,53,84,1],[64,13,64,47,1],[66,13,66,34,1],[67,13,67,14,1],[69,17,69,74,1],[70,17,72,75,1],[73,13,73,14,1],[75,13,75,14,1],[77,17,77,34,1],[78,13,78,14,1],[98,13,98,67,1],[99,13,99,35,1],[100,17,100,95,0],[101,13,101,49,1],[102,13,102,30,1],[103,9,103,10,1],[110,9,110,10,0],[111,13,111,37,0],[112,17,112,68,0],[113,13,113,39,0],[114,9,114,10,0],[118,17,118,18,1],[118,19,118,46,1],[118,47,118,48,1],[122,9,122,10,1],[123,13,123,38,1],[124,9,124,10,1],[127,9,127,10,0],[128,13,128,32,0],[129,9,129,10,0],[132,9,132,10,1],[133,13,133,28,1],[134,9,134,10,1],[137,9,137,10,0],[138,13,138,27,0],[139,9,139,10,0],[149,17,149,18,1],[149,19,149,60,1],[149,61,149,62,1],[161,13,161,14,0],[162,17,164,70,0],[165,13,165,14,0],[171,13,171,14,1],[172,17,172,41,1],[173,17,173,18,0],[174,21,174,71,0],[174,71,174,116,0],[174,116,174,118,0],[174,21,174,118,0],[175,21,175,42,0],[175,43,175,92,0],[176,17,176,18,0],[177,17,177,39,1],[178,13,178,14,1],[182,9,182,10,1],[183,13,185,54,1],[185,54,185,99,0],[185,99,185,131,1],[183,13,185,131,1],[186,9,186,10,1]]);
    </script>
  </body>
</html>