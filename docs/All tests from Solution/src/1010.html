<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\FileUploadPropertyValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Globalization;
using System.IO;
using System.Linq;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Media;
using Umbraco.Core.Models.Editors;
using Umbraco.Core.PropertyEditors;
using Umbraco.Web.Models.ContentEditing;
using umbraco;
using umbraco.cms.businesslogic.Files;
using Umbraco.Core;

namespace Umbraco.Web.PropertyEditors
{
    /// &lt;summary&gt;
    /// The editor for the file upload property editor
    /// &lt;/summary&gt;
    internal class FileUploadPropertyValueEditor : PropertyValueEditorWrapper
    {
        public FileUploadPropertyValueEditor(PropertyValueEditor wrapped) : base(wrapped)
        {
        }

        /// &lt;summary&gt;
        /// Overrides the deserialize value so that we can save the file accordingly
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;editorValue&quot;&gt;
        /// This is value passed in from the editor. We normally don&#39;t care what the editorValue.Value is set to because
        /// we are more interested in the files collection associated with it, however we do care about the value if we 
        /// are clearing files. By default the editorValue.Value will just be set to the name of the file (but again, we
        /// just ignore this and deal with the file collection in editorValue.AdditionalData.ContainsKey(&quot;files&quot;) )
        /// &lt;/param&gt;
        /// &lt;param name=&quot;currentValue&quot;&gt;
        /// The current value persisted for this property. This will allow us to determine if we want to create a new
        /// file path or use the existing file path.
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override object ConvertEditorToDb(ContentPropertyData editorValue, object currentValue)
        {
            if (currentValue == null)
            {
                currentValue = string.Empty;
            }

            //if the value is the same then just return the current value so we don&#39;t re-process everything
            if (string.IsNullOrEmpty(currentValue.ToString()) == false &amp;&amp; editorValue.Value == currentValue.ToString())
            {
                return currentValue;
            }

            //check the editorValue value to see if we need to clear the files or not.
            var clear = false;
            var json = editorValue.Value as JObject;
            if (json != null &amp;&amp; json[&quot;clearFiles&quot;] != null &amp;&amp; json[&quot;clearFiles&quot;].Value&lt;bool&gt;())
            {
                clear = json[&quot;clearFiles&quot;].Value&lt;bool&gt;();
            }

            var currentPersistedValues = new string[] { };
            if (string.IsNullOrEmpty(currentValue.ToString()) == false)
            {
                currentPersistedValues = currentValue.ToString().Split(new[] { &#39;,&#39; }, StringSplitOptions.RemoveEmptyEntries);
            }

            var newValue = new List&lt;string&gt;();

            var fs = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();

            if (clear)
            {
                //Remove any files that are saved for this item
                foreach (var toRemove in currentPersistedValues)
                {
                    fs.DeleteFile(fs.GetRelativePath(toRemove), true);
                }
                return &quot;&quot;;
            }

            //check for any files
            if (editorValue.AdditionalData.ContainsKey(&quot;files&quot;))
            {
                var files = editorValue.AdditionalData[&quot;files&quot;] as IEnumerable&lt;ContentItemFile&gt;;
                if (files != null)
                {
                    //now we just need to move the files to where they should be
                    var filesAsArray = files.ToArray();
                    //a list of all of the newly saved files so we can compare with the current saved files and remove the old ones
                    var savedFilePaths = new List&lt;string&gt;();
                    for (var i = 0; i &lt; filesAsArray.Length; i++)
                    {
                        var file = filesAsArray[i];

                        //don&#39;t continue if this is not allowed!
                        if (UploadFileTypeValidator.ValidateFileExtension(file.FileName) == false)
                        {
                            continue;
                        }

                        //TODO: ALl of this naming logic needs to be put into the ImageHelper and then we need to change ContentExtensions to do the same!

                        var currentPersistedFile = currentPersistedValues.Length &gt;= (i + 1)
                                                       ? currentPersistedValues[i]
                                                       : &quot;&quot;;

                        var name = IOHelper.SafeFileName(file.FileName.Substring(file.FileName.LastIndexOf(IOHelper.DirSepChar) + 1, file.FileName.Length - file.FileName.LastIndexOf(IOHelper.DirSepChar) - 1).ToLower());

                        var subfolder = UmbracoConfig.For.UmbracoSettings().Content.UploadAllowDirectories
                                            ? currentPersistedFile.Replace(fs.GetUrl(&quot;/&quot;), &quot;&quot;).Split(&#39;/&#39;)[0]
                                            : currentPersistedFile.Substring(currentPersistedFile.LastIndexOf(&quot;/&quot;, StringComparison.Ordinal) + 1).Split(&#39;-&#39;)[0];

                        int subfolderId;
                        var numberedFolder = int.TryParse(subfolder, out subfolderId)
                                                 ? subfolderId.ToString(CultureInfo.InvariantCulture)
                                                 : MediaSubfolderCounter.Current.Increment().ToString(CultureInfo.InvariantCulture);

                        var fileName = UmbracoConfig.For.UmbracoSettings().Content.UploadAllowDirectories
                                           ? Path.Combine(numberedFolder, name)
                                           : numberedFolder + &quot;-&quot; + name;

                        using (var fileStream = File.OpenRead(file.TempFilePath))
                        {
                            var umbracoFile = UmbracoMediaFile.Save(fileStream, fileName);

                            if (umbracoFile.SupportsResizing)
                            {
                                var additionalSizes = new List&lt;int&gt;();
                                //get the pre-vals value		
                                var thumbs = editorValue.PreValues.FormatAsDictionary();
                                if (thumbs.Any())
                                {
                                    var thumbnailSizes = thumbs.First().Value.Value;
                                    // additional thumbnails configured as prevalues on the DataType		
                                    foreach (var thumb in thumbnailSizes.Split(new[] { &quot;;&quot;, &quot;,&quot; }, StringSplitOptions.RemoveEmptyEntries))
                                    {
                                        int thumbSize;
                                        if (thumb == &quot;&quot; || int.TryParse(thumb, out thumbSize) == false) continue;
                                        additionalSizes.Add(thumbSize);
                                    }
                                }

                                using (var image = Image.FromStream(fileStream))
                                {
                                    ImageHelper.GenerateMediaThumbnails(fs, fileName, umbracoFile.Extension, image, additionalSizes);
                                }
                            }

                            newValue.Add(umbracoFile.Url);
                            //add to the saved paths
                            savedFilePaths.Add(umbracoFile.Url);
                        }
                        //now remove the temp file
                        File.Delete(file.TempFilePath);
                    }

                    //Remove any files that are no longer saved for this item
                    foreach (var toRemove in currentPersistedValues.Except(savedFilePaths))
                    {
                        fs.DeleteFile(fs.GetRelativePath(toRemove), true);
                    }


                    return string.Join(&quot;,&quot;, newValue);
                }
            }

            //if we&#39;ve made it here, we had no files to save and we were not clearing anything so just persist the same value we had before
            return currentValue;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,77,27,90,1],[28,9,28,10,1],[29,9,29,10,1],[46,9,46,10,0],[47,13,47,38,0],[48,13,48,14,0],[49,17,49,45,0],[50,13,50,14,0],[53,13,53,120,0],[54,13,54,14,0],[55,17,55,37,0],[59,13,59,31,0],[60,13,60,53,0],[61,13,61,96,0],[62,13,62,14,0],[63,17,63,58,0],[64,13,64,14,0],[66,13,66,59,0],[67,13,67,72,0],[68,13,68,14,0],[69,17,69,126,0],[70,13,70,14,0],[72,13,72,47,0],[74,13,74,97,0],[76,13,76,23,0],[77,13,77,14,0],[79,17,79,24,0],[79,26,79,38,0],[79,39,79,41,0],[79,42,79,64,0],[80,17,80,18,0],[81,21,81,71,0],[82,17,82,18,0],[83,17,83,27,0],[87,13,87,65,0],[88,13,88,14,0],[89,17,89,97,0],[90,17,90,35,0],[91,17,91,18,0],[93,21,93,56,0],[95,21,95,61,0],[96,26,96,35,0],[96,37,96,60,0],[96,62,96,65,0],[97,21,97,22,0],[98,25,98,52,0],[101,25,101,99,0],[102,25,102,26,0],[103,29,103,38,0],[108,25,110,61,0],[112,25,112,220,0],[114,25,116,161,0],[119,25,121,133,0],[123,25,125,74,0],[127,32,127,81,0],[128,25,128,26,0],[129,29,129,91,0],[131,29,131,62,0],[132,29,132,30,0],[133,33,133,71,0],[135,33,135,89,0],[136,33,136,50,0],[137,33,137,34,0],[138,37,138,85,0],[140,37,140,44,0],[140,46,140,55,0],[140,56,140,58,0],[140,59,140,138,0],[141,37,141,38,0],[143,41,143,104,0],[143,105,143,114,0],[144,41,144,72,0],[145,37,145,38,0],[146,33,146,34,0],[148,40,148,80,0],[149,33,149,34,0],[150,37,150,134,0],[151,33,151,34,0],[152,29,152,30,0],[154,29,154,59,0],[156,29,156,65,0],[157,25,157,26,0],[159,25,159,56,0],[160,21,160,22,0],[163,21,163,28,0],[163,30,163,42,0],[163,43,163,45,0],[163,46,163,91,0],[164,21,164,22,0],[165,25,165,75,0],[166,21,166,22,0],[169,21,169,55,0],[171,13,171,14,0],[174,13,174,33,0],[175,9,175,10,0]]);
    </script>
  </body>
</html>