<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Cache\DeepCloneRuntimeCacheProvider.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.Caching;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;

namespace Umbraco.Core.Cache
{
    /// &lt;summary&gt;
    /// Interface describing this cache provider as a wrapper for another
    /// &lt;/summary&gt;
    internal interface IRuntimeCacheProviderWrapper
    {
        IRuntimeCacheProvider InnerProvider { get; }
    }

    /// &lt;summary&gt;
    /// A wrapper for any IRuntimeCacheProvider that ensures that all inserts and returns 
    /// are a deep cloned copy of the item when the item is IDeepCloneable and that tracks changes are
    /// reset if the object is TracksChangesEntityBase
    /// &lt;/summary&gt;
    internal class DeepCloneRuntimeCacheProvider : IRuntimeCacheProvider, IRuntimeCacheProviderWrapper
    {
        public IRuntimeCacheProvider InnerProvider { get; private set; }

        public DeepCloneRuntimeCacheProvider(IRuntimeCacheProvider innerProvider)
        {
            if (innerProvider.GetType() == typeof(DeepCloneRuntimeCacheProvider))
                throw new InvalidOperationException(&quot;A &quot; + typeof(DeepCloneRuntimeCacheProvider) + &quot; cannot wrap another instance of &quot; + typeof(DeepCloneRuntimeCacheProvider));

            InnerProvider = innerProvider;
        }

        #region Clear - doesn&#39;t require any changes
        public void ClearAllCache()
        {
            InnerProvider.ClearAllCache();
        }

        public void ClearCacheItem(string key)
        {
            InnerProvider.ClearCacheItem(key);
        }

        public void ClearCacheObjectTypes(string typeName)
        {
            InnerProvider.ClearCacheObjectTypes(typeName);
        }

        public void ClearCacheObjectTypes&lt;T&gt;()
        {
            InnerProvider.ClearCacheObjectTypes&lt;T&gt;();
        }

        public void ClearCacheObjectTypes&lt;T&gt;(Func&lt;string, T, bool&gt; predicate)
        {
            InnerProvider.ClearCacheObjectTypes&lt;T&gt;(predicate);
        }

        public void ClearCacheByKeySearch(string keyStartsWith)
        {
            InnerProvider.ClearCacheByKeySearch(keyStartsWith);
        }

        public void ClearCacheByKeyExpression(string regexString)
        {
            InnerProvider.ClearCacheByKeyExpression(regexString);
        } 
        #endregion

        public IEnumerable&lt;object&gt; GetCacheItemsByKeySearch(string keyStartsWith)
        {
            return InnerProvider.GetCacheItemsByKeySearch(keyStartsWith)
                .Select(CheckCloneableAndTracksChanges);
        }

        public IEnumerable&lt;object&gt; GetCacheItemsByKeyExpression(string regexString)
        {
            return InnerProvider.GetCacheItemsByKeyExpression(regexString)
                .Select(CheckCloneableAndTracksChanges);
        }
        
        public object GetCacheItem(string cacheKey)
        {
            var item = InnerProvider.GetCacheItem(cacheKey);
            return CheckCloneableAndTracksChanges(item);
        }

        public object GetCacheItem(string cacheKey, Func&lt;object&gt; getCacheItem)
        {
            var cached = InnerProvider.GetCacheItem(cacheKey, () =&gt;
            {
                var result = DictionaryCacheProviderBase.GetSafeLazy(getCacheItem);
                var value = result.Value; // force evaluation now - this may throw if cacheItem throws, and then nothing goes into cache
                if (value == null) return null; // do not store null values (backward compat)

                return CheckCloneableAndTracksChanges(value);
            });
            return CheckCloneableAndTracksChanges(cached);
        }

        public object GetCacheItem(string cacheKey, Func&lt;object&gt; getCacheItem, TimeSpan? timeout, bool isSliding = false, CacheItemPriority priority = CacheItemPriority.Normal, CacheItemRemovedCallback removedCallback = null, string[] dependentFiles = null)
        {
            var cached = InnerProvider.GetCacheItem(cacheKey, () =&gt;
            {
                var result = DictionaryCacheProviderBase.GetSafeLazy(getCacheItem);
                var value = result.Value; // force evaluation now - this may throw if cacheItem throws, and then nothing goes into cache
                if (value == null) return null; // do not store null values (backward compat)

                //Clone/reset to go into the cache
                return CheckCloneableAndTracksChanges(value);
            }, timeout, isSliding, priority, removedCallback, dependentFiles);

            //Clone/reset to go out of the cache
            return CheckCloneableAndTracksChanges(cached);
        }

        public void InsertCacheItem(string cacheKey, Func&lt;object&gt; getCacheItem, TimeSpan? timeout = null, bool isSliding = false, CacheItemPriority priority = CacheItemPriority.Normal, CacheItemRemovedCallback removedCallback = null, string[] dependentFiles = null)
        {
            InnerProvider.InsertCacheItem(cacheKey, () =&gt;
            {
                var result = DictionaryCacheProviderBase.GetSafeLazy(getCacheItem);
                var value = result.Value; // force evaluation now - this may throw if cacheItem throws, and then nothing goes into cache
                if (value == null) return null; // do not store null values (backward compat)

                return CheckCloneableAndTracksChanges(value);
            }, timeout, isSliding, priority, removedCallback, dependentFiles);   
        }

        private static object CheckCloneableAndTracksChanges(object input)
        {
            var cloneable = input as IDeepCloneable;
            if (cloneable != null)
            {
                input = cloneable.DeepClone();    
            }

            //on initial construction we don&#39;t want to have dirty properties tracked
            // http://issues.umbraco.org/issue/U4-1946
            var tracksChanges = input as IRememberBeingDirty;
            if (tracksChanges != null)
            {
                tracksChanges.ResetDirtyProperties(false);
                input =  tracksChanges;
            }

            return input;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,54,25,58,1],[25,59,25,71,1],[27,9,27,82,1],[28,9,28,10,1],[29,13,29,82,1],[30,17,30,177,0],[32,13,32,43,1],[33,9,33,10,1],[37,9,37,10,1],[38,13,38,43,1],[39,9,39,10,1],[42,9,42,10,1],[43,13,43,47,1],[44,9,44,10,1],[47,9,47,10,1],[48,13,48,59,1],[49,9,49,10,1],[52,9,52,10,1],[53,13,53,54,1],[54,9,54,10,1],[57,9,57,10,0],[58,13,58,63,0],[59,9,59,10,0],[62,9,62,10,1],[63,13,63,64,1],[64,9,64,10,1],[67,9,67,10,1],[68,13,68,66,1],[69,9,69,10,1],[73,9,73,10,1],[74,13,75,57,1],[76,9,76,10,1],[79,9,79,10,0],[80,13,81,57,0],[82,9,82,10,0],[85,9,85,10,1],[86,13,86,61,1],[87,13,87,57,1],[88,9,88,10,1],[91,9,91,10,1],[92,13,93,13,1],[93,13,93,14,1],[93,14,94,17,1],[94,17,94,84,1],[94,84,95,17,1],[95,17,95,42,1],[95,42,96,17,1],[96,17,96,35,1],[96,35,96,36,1],[96,36,96,48,0],[96,48,98,17,1],[98,17,98,62,1],[98,62,99,13,1],[99,13,99,14,1],[99,14,99,16,1],[92,13,99,16,1],[100,13,100,59,1],[101,9,101,10,1],[104,9,104,10,1],[105,13,106,13,1],[106,13,106,14,1],[106,14,107,17,1],[107,17,107,84,1],[107,84,108,17,1],[108,17,108,42,1],[108,42,109,17,1],[109,17,109,35,1],[109,35,109,36,1],[109,36,109,48,1],[109,48,112,17,1],[112,17,112,62,1],[112,62,113,13,1],[113,13,113,14,1],[113,14,113,79,1],[105,13,113,79,1],[116,13,116,59,1],[117,9,117,10,1],[120,9,120,10,1],[121,13,122,13,1],[122,13,122,14,1],[122,14,123,17,1],[123,17,123,84,1],[123,84,124,17,1],[124,17,124,42,1],[124,42,125,17,1],[125,17,125,35,1],[125,35,125,36,1],[125,36,125,48,0],[125,48,127,17,1],[127,17,127,62,1],[127,62,128,13,1],[128,13,128,14,1],[128,14,128,79,1],[121,13,128,79,1],[129,9,129,10,1],[132,9,132,10,1],[133,13,133,53,1],[134,13,134,35,1],[135,13,135,14,1],[136,17,136,47,1],[137,13,137,14,1],[141,13,141,62,1],[142,13,142,39,1],[143,13,143,14,1],[144,17,144,59,1],[145,17,145,40,1],[146,13,146,14,1],[148,13,148,26,1],[149,9,149,10,1]]);
    </script>
  </body>
</html>