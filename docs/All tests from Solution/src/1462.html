<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Sync\ConfigServerRegistrar.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Web;
using Umbraco.Core.Configuration;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.IO;

namespace Umbraco.Core.Sync
{
    /// &lt;summary&gt;
    /// Provides server registrations to the distributed cache by reading the legacy Xml configuration
    /// in umbracoSettings to get the list of (manually) configured server nodes.
    /// &lt;/summary&gt;
    internal class ConfigServerRegistrar : IServerRegistrar2
    {
        private readonly List&lt;IServerAddress&gt; _addresses;
        private readonly ServerRole _serverRole;
        private readonly string _umbracoApplicationUrl;

        public ConfigServerRegistrar()
            : this(UmbracoConfig.For.UmbracoSettings().DistributedCall)
        { }

        // for tests
        internal ConfigServerRegistrar(IDistributedCallSection settings)
        {
            if (settings.Enabled == false)
            {
                _addresses = new List&lt;IServerAddress&gt;();
                _serverRole = ServerRole.Single;
                _umbracoApplicationUrl = null; // unspecified
                return;
            }

            var serversA = settings.Servers.ToArray();

            _addresses = serversA
                .Select(x =&gt; new ConfigServerAddress(x))
                .Cast&lt;IServerAddress&gt;()
                .ToList();

            if (serversA.Length == 0)
            {
                _serverRole = ServerRole.Unknown; // config error, actually
            }
            else
            {
                var master = serversA[0]; // first one is master
                var appId = master.AppId;
                var serverName = master.ServerName;

                if (appId.IsNullOrWhiteSpace() &amp;&amp; serverName.IsNullOrWhiteSpace())
                    _serverRole = ServerRole.Unknown; // config error, actually
                else
                    _serverRole = IsCurrentServer(appId, serverName)
                        ? ServerRole.Master
                        : ServerRole.Slave;
            }

            var currentServer = serversA.FirstOrDefault(x =&gt; IsCurrentServer(x.AppId, x.ServerName));
            if (currentServer != null)
            {
                // match, use the configured url
                _umbracoApplicationUrl = string.Format(&quot;{0}://{1}:{2}/{3}&quot;,
                    currentServer.ForceProtocol.IsNullOrWhiteSpace() ? &quot;http&quot; : currentServer.ForceProtocol,
                    currentServer.ServerAddress,
                    currentServer.ForcePortnumber.IsNullOrWhiteSpace() ? &quot;80&quot; : currentServer.ForcePortnumber,
                    IOHelper.ResolveUrl(SystemDirectories.Umbraco).TrimStart(&#39;/&#39;));
            }
        }

        private static bool IsCurrentServer(string appId, string serverName)
        {
            // match by appId or computer name
            return (appId.IsNullOrWhiteSpace() == false &amp;&amp; appId.Trim().InvariantEquals(HttpRuntime.AppDomainAppId))
                || (serverName.IsNullOrWhiteSpace() == false &amp;&amp; serverName.Trim().InvariantEquals(NetworkHelper.MachineName));
        }

        public IEnumerable&lt;IServerAddress&gt; Registrations
        {
            get { return _addresses; }
        }

        public ServerRole GetCurrentServerRole()
        {
            return _serverRole;
        }

        public string GetCurrentServerUmbracoApplicationUrl()
        {
            return _umbracoApplicationUrl;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,15,21,72,0],[22,9,22,10,0],[22,11,22,12,0],[25,9,25,73,1],[26,9,26,10,1],[27,13,27,43,1],[28,13,28,14,1],[29,17,29,57,1],[30,17,30,49,1],[31,17,31,47,1],[32,17,32,24,1],[35,13,35,55,1],[37,13,38,30,1],[38,30,38,56,1],[38,56,40,27,1],[37,13,40,27,1],[42,13,42,38,1],[43,13,43,14,1],[44,17,44,50,1],[45,13,45,14,1],[47,13,47,14,1],[48,17,48,42,1],[49,17,49,42,1],[50,17,50,52,1],[52,17,52,83,1],[53,21,53,54,0],[55,21,57,44,1],[58,13,58,14,1],[60,13,60,62,1],[60,62,60,100,1],[60,100,60,102,1],[60,13,60,102,1],[61,13,61,39,1],[62,13,62,14,1],[64,17,68,84,1],[69,13,69,14,1],[70,9,70,10,1],[73,9,73,10,1],[75,13,76,127,1],[77,9,77,10,1],[81,17,81,18,0],[81,19,81,37,0],[81,38,81,39,0],[85,9,85,10,1],[86,13,86,32,1],[87,9,87,10,1],[90,9,90,10,1],[91,13,91,43,1],[92,9,92,10,1]]);
    </script>
  </body>
</html>