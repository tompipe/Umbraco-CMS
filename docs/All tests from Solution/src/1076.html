<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\SurfaceController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.Mvc;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core;
using Umbraco.Web.Security;
using System.Collections.Specialized;

namespace Umbraco.Web.Mvc
{

    /// &lt;summary&gt;
    /// The base controller that all Presentation Add-in controllers should inherit from
    /// &lt;/summary&gt;
    [MergeModelStateToChildAction]
    [MergeParentContextViewData]
    public abstract class SurfaceController : PluginController
    {
        /// &lt;summary&gt;
        /// Default constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        protected SurfaceController(UmbracoContext umbracoContext)
            : base(umbracoContext)
        {
        }

        protected SurfaceController(UmbracoContext umbracoContext, UmbracoHelper umbracoHelper)
            : base(umbracoContext, umbracoHelper)
        {
        }

        /// &lt;summary&gt;
        /// Empty constructor, uses Singleton to resolve the UmbracoContext
        /// &lt;/summary&gt;
        protected SurfaceController()
            : base(UmbracoContext.Current)
        {
        }

        /// &lt;summary&gt;
        /// Redirects to the Umbraco page with the given id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToUmbracoPage(int pageId)
        {
            return new RedirectToUmbracoPageResult(pageId, UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Redirects to the Umbraco page with the given id and passes provided querystring
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToUmbracoPage(int pageId, NameValueCollection queryStringValues)
        {
            return new RedirectToUmbracoPageResult(pageId, queryStringValues, UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Redirects to the Umbraco page with the given id and passes provided querystring
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryString&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToUmbracoPage(int pageId, string queryString)
        {
            return new RedirectToUmbracoPageResult(pageId, queryString, UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Redirects to the Umbraco page with the given id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;publishedContent&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToUmbracoPage(IPublishedContent publishedContent)
        {
            return new RedirectToUmbracoPageResult(publishedContent, UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Redirects to the Umbraco page with the given id and passes provided querystring
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;publishedContent&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToUmbracoPage(IPublishedContent publishedContent, NameValueCollection queryStringValues)
        {
            return new RedirectToUmbracoPageResult(publishedContent, queryStringValues, UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Redirects to the Umbraco page with the given id and passes provided querystring
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;publishedContent&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryString&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToUmbracoPage(IPublishedContent publishedContent, string queryString)
        {
            return new RedirectToUmbracoPageResult(publishedContent, queryString, UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Redirects to the currently rendered Umbraco page
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToCurrentUmbracoPage()
        {
            return new RedirectToUmbracoPageResult(CurrentPage, UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Redirects to the currently rendered Umbraco page and passes provided querystring
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToCurrentUmbracoPage(NameValueCollection queryStringValues)
        {
            return new RedirectToUmbracoPageResult(CurrentPage, queryStringValues, UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Redirects to the currently rendered Umbraco page and passes provided querystring
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected RedirectToUmbracoPageResult RedirectToCurrentUmbracoPage(string queryString)
        {
            return new RedirectToUmbracoPageResult(CurrentPage, queryString, UmbracoContext);
        }
        /// &lt;summary&gt;
        /// Redirects to the currently rendered Umbraco URL
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// this is useful if you need to redirect 
        /// to the current page but the current page is actually a rewritten URL normally done with something like 
        /// Server.Transfer.
        /// &lt;/remarks&gt;
        protected RedirectToUmbracoUrlResult RedirectToCurrentUmbracoUrl()
        {
            return new RedirectToUmbracoUrlResult(UmbracoContext);
        }

        /// &lt;summary&gt;
        /// Returns the currently rendered Umbraco page
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected UmbracoPageResult CurrentUmbracoPage()
        {
            return new UmbracoPageResult(ApplicationContext.ProfilingLogger);
        }

        /// &lt;summary&gt;
        /// Gets the current page.
        /// &lt;/summary&gt;
        protected virtual IPublishedContent CurrentPage
        {
            get
            {
                var routeDefAttempt = TryGetRouteDefinitionFromAncestorViewContexts();
                if (!routeDefAttempt.Success)
                {
                    throw routeDefAttempt.Exception;
                }

                var routeDef = routeDefAttempt.Result;
                return routeDef.PublishedContentRequest.PublishedContent;
            }
        }

        /// &lt;summary&gt;
        /// we need to recursively find the route definition based on the parent view context
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// We may have Child Actions within Child actions so we need to recursively look this up.
        /// see: http://issues.umbraco.org/issue/U4-1844
        /// &lt;/remarks&gt;
        private Attempt&lt;RouteDefinition&gt; TryGetRouteDefinitionFromAncestorViewContexts()
        {
            ControllerContext currentContext = ControllerContext;
            while (currentContext != null)
            {
                var currentRouteData = currentContext.RouteData;
                if (currentRouteData.DataTokens.ContainsKey(Core.Constants.Web.UmbracoRouteDefinitionDataToken))
                {
                    return Attempt.Succeed((RouteDefinition)currentRouteData.DataTokens[Core.Constants.Web.UmbracoRouteDefinitionDataToken]);
                }
                if (currentContext.IsChildAction)
                {
                    //assign current context to parent
                    currentContext = currentContext.ParentActionViewContext;
                }
                else
                {
                    //exit the loop
                    currentContext = null;
                }
            }
            return Attempt&lt;RouteDefinition&gt;.Fail(
                new InvalidOperationException(&quot;Cannot find the Umbraco route definition in the route values, the request must be made in the context of an Umbraco request&quot;));
        }


    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,15,24,35,1],[25,9,25,10,1],[26,9,26,10,1],[29,15,29,50,0],[30,9,30,10,0],[31,9,31,10,0],[37,15,37,43,0],[38,9,38,10,0],[39,9,39,10,0],[47,9,47,10,0],[48,13,48,76,0],[49,9,49,10,0],[58,9,58,10,0],[59,13,59,95,0],[60,9,60,10,0],[69,9,69,10,0],[70,13,70,89,0],[71,9,71,10,0],[79,9,79,10,0],[80,13,80,86,0],[81,9,81,10,0],[90,9,90,10,0],[91,13,91,105,0],[92,9,92,10,0],[101,9,101,10,0],[102,13,102,99,0],[103,9,103,10,0],[110,9,110,10,0],[111,13,111,81,0],[112,9,112,10,0],[120,9,120,10,0],[121,13,121,100,0],[122,9,122,10,0],[130,9,130,10,0],[131,13,131,94,0],[132,9,132,10,0],[143,9,143,10,0],[144,13,144,67,0],[145,9,145,10,0],[152,9,152,10,0],[153,13,153,78,0],[154,9,154,10,0],[162,13,162,14,1],[163,17,163,87,1],[164,17,164,46,1],[165,17,165,18,0],[166,21,166,53,0],[169,17,169,55,1],[170,17,170,74,1],[171,13,171,14,1],[183,9,183,10,1],[184,13,184,66,1],[185,13,185,43,1],[186,13,186,14,1],[187,17,187,65,1],[188,17,188,113,1],[189,17,189,18,1],[190,21,190,142,1],[192,17,192,50,0],[193,17,193,18,0],[195,21,195,77,0],[196,17,196,18,0],[198,17,198,18,0],[200,21,200,43,0],[201,17,201,18,0],[202,13,202,14,0],[203,13,204,175,0],[205,9,205,10,1]]);
    </script>
  </body>
</html>