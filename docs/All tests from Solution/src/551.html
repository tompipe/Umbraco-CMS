<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\webservices\TreeClientService.asmx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Formatting;
using System.Web;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.Hosting;
using System.Web.Http.Routing;
using System.Web.Mvc;
using System.Web.Routing;
using System.Web.Services;
using Umbraco.Core;
using Umbraco.Web;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebServices;
using umbraco.BusinessLogic;
using umbraco.businesslogic;
using umbraco.presentation.umbraco.controls;
using umbraco.cms.presentation.Trees;
using System.Web.Script.Services;
using System.Web.Script.Serialization;
using System.EnterpriseServices;
using System.IO;
using System.Web.UI;
using umbraco.controls.Tree;
using Umbraco.Web.Trees;

namespace umbraco.presentation.webservices
{
    /// &lt;summary&gt;
    /// Client side ajax utlities for the tree
    /// &lt;/summary&gt;
    [ScriptService]
    [WebService]
    public class TreeClientService : UmbracoAuthorizedWebService
    {

        /// &lt;summary&gt;
        /// Returns a key/value object with: json, app, js as the keys
        /// &lt;/summary&gt;	
        /// &lt;returns&gt;&lt;/returns&gt;
        [WebMethod]
        [ScriptMethod(ResponseFormat = ResponseFormat.Json)]
        public Dictionary&lt;string, string&gt; GetInitAppTreeData(string app, string treeType, bool showContextMenu, bool isDialog, TreeDialogModes dialogMode, string functionToCall, string nodeKey)
        {
            AuthorizeRequest(app, true);

            var treeCtl = new TreeControl()
            {
                ShowContextMenu = showContextMenu,
                IsDialog = isDialog,
                DialogMode = dialogMode,
                App = app,
                TreeType = string.IsNullOrEmpty(treeType) ? &quot;&quot; : treeType, //don&#39;t set the tree type unless explicitly set
                NodeKey = string.IsNullOrEmpty(nodeKey) ? &quot;&quot; : nodeKey,
                StartNodeID = -1, //TODO: set this based on parameters!
                FunctionToCall = string.IsNullOrEmpty(functionToCall) ? &quot;&quot; : functionToCall
            };

            var returnVal = new Dictionary&lt;string, string&gt;();

            if (string.IsNullOrEmpty(treeType))
            {
                //if there&#39;s not tree type specified, then render out the tree as per normal with the normal 
                //way of doing things
                returnVal.Add(&quot;json&quot;, treeCtl.GetJSONInitNode());
            }
            else
            {
                var tree = LegacyTreeDataConverter.GetLegacyTreeForLegacyServices(Services.ApplicationTreeService, treeType);
                
                tree.ShowContextMenu = showContextMenu;
                tree.IsDialog = isDialog;
                tree.DialogMode = dialogMode;
                tree.NodeKey = string.IsNullOrEmpty(nodeKey) ? &quot;&quot; : nodeKey;
                tree.FunctionToCall = string.IsNullOrEmpty(functionToCall) ? &quot;&quot; : functionToCall;
                //this would be nice to set, but no parameters :( 
                //tree.StartNodeID =    

                //now render it&#39;s start node
                var xTree = new XmlTree();
                xTree.Add(tree.RootNode);

                returnVal.Add(&quot;json&quot;, xTree.ToString());    
            }

            returnVal.Add(&quot;app&quot;, app);
            returnVal.Add(&quot;js&quot;, treeCtl.JSCurrApp);

            return returnVal;
        }

        [Obsolete(&quot;Use the AuthorizeRequest methods on the base class UmbracoAuthorizedWebService instead&quot;)]
        public static void Authorize()
        {
            if (!BasePages.BasePage.ValidateUserContextID(BasePages.BasePage.umbracoUserContextID))
                throw new Exception(&quot;Client authorization failed. User is not logged in&quot;);
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[47,9,47,10,0],[48,13,48,41,0],[50,13,60,15,0],[62,13,62,62,0],[64,13,64,48,0],[65,13,65,14,0],[68,17,68,66,0],[69,13,69,14,0],[71,13,71,14,0],[72,17,72,126,0],[74,17,74,56,0],[75,17,75,42,0],[76,17,76,46,0],[77,17,77,77,0],[78,17,78,98,0],[83,17,83,43,0],[84,17,84,42,0],[86,17,86,57,0],[87,13,87,14,0],[89,13,89,39,0],[90,13,90,52,0],[92,13,92,30,0],[93,9,93,10,0],[97,9,97,10,0],[98,13,98,100,0],[99,17,99,91,0],[100,9,100,10,0]]);
    </script>
  </body>
</html>