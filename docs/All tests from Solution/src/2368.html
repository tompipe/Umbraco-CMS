<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\UmbracoExamine\Config\LazyIndexCriteria.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Examine;
using Examine.LuceneEngine.Config;
using UmbracoExamine.DataServices;

namespace UmbracoExamine.Config
{
    internal class LazyIndexCriteria : IIndexCriteria
    {
        public LazyIndexCriteria(
            IndexSet set,
            IDataService svc,
            StaticFieldCollection indexFieldPolicies)
        {
            if (set == null) throw new ArgumentNullException(&quot;set&quot;);
            if (indexFieldPolicies == null) throw new ArgumentNullException(&quot;indexFieldPolicies&quot;);
            if (svc == null) throw new ArgumentNullException(&quot;svc&quot;);
           
            _lazyCriteria = new Lazy&lt;IIndexCriteria&gt;(() =&gt;
            {
                var attributeFields = set.IndexAttributeFields.Cast&lt;IIndexField&gt;().ToArray();
                var userFields = set.IndexUserFields.Cast&lt;IIndexField&gt;().ToArray();
                var includeNodeTypes = set.IncludeNodeTypes.Cast&lt;IIndexField&gt;().Select(x =&gt; x.Name).ToArray();
                var excludeNodeTypes = set.ExcludeNodeTypes.Cast&lt;IIndexField&gt;().Select(x =&gt; x.Name).ToArray();
                var parentId = set.IndexParentId;

                //if there are no user fields defined, we&#39;ll populate them from the data source (include them all)
                if (set.IndexUserFields.Count == 0)
                {
                    //we need to add all user fields to the collection if it is empty (this is the default if none are specified)
                    var userProps = svc.ContentService.GetAllUserPropertyNames();
                    var fields = new List&lt;IIndexField&gt;();
                    foreach (var u in userProps)
                    {
                        var field = new IndexField() { Name = u };

                        StaticField policy;
                        if (indexFieldPolicies.TryGetValue(u, out policy))
                        {
                            field.Type = policy.Type;
                            field.EnableSorting = policy.EnableSorting;
                        }
                        fields.Add(field);
                    }
                    userFields = fields.ToArray();
                }

                //if there are no attribute fields defined, we&#39;ll populate them from the data source (include them all)
                if (set.IndexAttributeFields.Count == 0)
                {
                    //we need to add all system fields to the collection if it is empty (this is the default if none are specified)
                    var sysProps = svc.ContentService.GetAllSystemPropertyNames();
                    var fields = new List&lt;IIndexField&gt;();
                    foreach (var s in sysProps)
                    {
                        var field = new IndexField() { Name = s };

                        StaticField policy;
                        if (indexFieldPolicies.TryGetValue(s, out policy))
                        {
                            field.Type = policy.Type;
                            field.EnableSorting = policy.EnableSorting;
                        }
                        fields.Add(field);
                    }
                    attributeFields = fields.ToArray();
                }


                return new IndexCriteria(
                    attributeFields,
                    userFields,
                    includeNodeTypes,
                    excludeNodeTypes,
                    parentId);
            });
        }

        private readonly Lazy&lt;IIndexCriteria&gt; _lazyCriteria;

        public IEnumerable&lt;string&gt; ExcludeNodeTypes
        {
            get { return _lazyCriteria.Value.ExcludeNodeTypes; }
        }

        public IEnumerable&lt;string&gt; IncludeNodeTypes
        {
            get { return _lazyCriteria.Value.IncludeNodeTypes; }
        }

        public int? ParentNodeId
        {
            get { return _lazyCriteria.Value.ParentNodeId; }
        }

        public IEnumerable&lt;IIndexField&gt; StandardFields
        {
            get { return _lazyCriteria.Value.StandardFields; }
        }

        public IEnumerable&lt;IIndexField&gt; UserFields
        {
            get { return _lazyCriteria.Value.UserFields; }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,9,15,54,1],[16,9,16,10,1],[17,13,17,29,1],[17,30,17,69,0],[18,13,18,44,1],[18,45,18,99,0],[19,13,19,29,1],[19,30,19,69,0],[21,13,22,13,1],[22,13,22,14,1],[22,14,23,17,1],[23,17,23,94,1],[23,94,24,17,1],[24,17,24,84,1],[24,84,25,17,1],[25,17,25,93,1],[25,93,25,99,0],[25,99,25,111,1],[25,17,25,111,1],[25,111,26,17,1],[26,17,26,93,1],[26,93,26,99,0],[26,99,26,111,1],[26,17,26,111,1],[26,111,27,17,1],[27,17,27,50,1],[27,50,30,17,1],[30,17,30,52,1],[30,52,31,17,1],[31,17,31,18,1],[31,18,33,21,1],[33,21,33,82,1],[33,82,34,21,1],[34,21,34,58,1],[34,58,35,21,1],[35,21,35,28,1],[35,28,35,30,1],[35,30,35,35,1],[35,35,35,36,1],[35,36,35,38,1],[35,38,35,39,1],[35,39,35,48,1],[35,48,36,21,1],[36,21,36,22,1],[36,22,37,25,1],[37,25,37,67,1],[37,67,40,25,1],[40,25,40,75,1],[40,75,41,25,1],[41,25,41,26,1],[41,26,42,29,1],[42,29,42,54,1],[42,54,43,29,1],[43,29,43,72,1],[43,72,44,25,1],[44,25,44,26,1],[44,26,45,25,1],[45,25,45,43,1],[45,43,46,21,1],[46,21,46,22,1],[46,22,47,21,1],[47,21,47,51,1],[47,51,48,17,1],[48,17,48,18,1],[48,18,51,17,1],[51,17,51,57,1],[51,57,52,17,1],[52,17,52,18,1],[52,18,54,21,1],[54,21,54,83,1],[54,83,55,21,1],[55,21,55,58,1],[55,58,56,21,1],[56,21,56,28,1],[56,28,56,30,1],[56,30,56,35,1],[56,35,56,36,1],[56,36,56,38,1],[56,38,56,39,1],[56,39,56,47,1],[56,47,57,21,1],[57,21,57,22,1],[57,22,58,25,1],[58,25,58,67,1],[58,67,61,25,1],[61,25,61,75,1],[61,75,62,25,1],[62,25,62,26,1],[62,26,63,29,1],[63,29,63,54,1],[63,54,64,29,1],[64,29,64,72,1],[64,72,65,25,1],[65,25,65,26,1],[65,26,66,25,1],[66,25,66,43,1],[66,43,67,21,1],[67,21,67,22,1],[67,22,68,21,1],[68,21,68,56,1],[68,56,69,17,1],[69,17,69,18,1],[69,18,72,17,1],[72,17,77,31,1],[77,31,78,13,1],[78,13,78,14,1],[78,14,78,16,1],[21,13,78,16,1],[79,9,79,10,1],[85,17,85,18,1],[85,19,85,63,1],[85,64,85,65,1],[90,17,90,18,1],[90,19,90,63,1],[90,64,90,65,1],[95,17,95,18,1],[95,19,95,59,1],[95,60,95,61,1],[100,17,100,18,1],[100,19,100,61,1],[100,62,100,63,1],[105,17,105,18,1],[105,19,105,57,1],[105,58,105,59,1]]);
    </script>
  </body>
</html>