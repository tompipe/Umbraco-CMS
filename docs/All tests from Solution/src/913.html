<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Security\Identity\FixWindowsAuthMiddlware.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using System.Security.Claims;
using System.Security.Principal;
using System.Threading.Tasks;
using Microsoft.Owin;
using Umbraco.Core;
using Umbraco.Core.Security;

namespace Umbraco.Web.Security.Identity
{
    /// &lt;summary&gt;
    /// This is used to inspect the request to see if 2 x identities are assigned: A windows one and a back office one.
    /// When this is the case, it means that auth has executed for Windows &amp; auth has executed for our back office cookie
    /// handler and now two identities have been assigned. Unfortunately, at some stage in the pipeline - I&#39;m pretty sure
    /// it&#39;s the Role Provider Module - it again changes the user&#39;s Principal to a RolePrincipal and discards the second
    /// Identity which is the Back office identity thus preventing a user from accessing the back office... it&#39;s very annoying.
    /// 
    /// To fix this, we re-set the user Principal to only have a single identity: the back office one, since we know this is
    /// for a back office request.
    /// &lt;/summary&gt;
    internal class FixWindowsAuthMiddlware : OwinMiddleware
    {
        public FixWindowsAuthMiddlware(OwinMiddleware next) : base(next)
        {
        }

        public override async Task Invoke(IOwinContext context)
        {
            if (context.Request.Uri.IsClientSideRequest() == false)
            {
                var claimsPrincipal = context.Request.User as ClaimsPrincipal;
                if (claimsPrincipal != null
                    &amp;&amp; claimsPrincipal.Identities.Count() &gt; 1
                    &amp;&amp; claimsPrincipal.Identities.Any(x =&gt; x is WindowsIdentity)
                    &amp;&amp; claimsPrincipal.Identities.Any(x =&gt; x is UmbracoBackOfficeIdentity))
                {
                    var backOfficeIdentity = claimsPrincipal.Identities.First(x =&gt; x is UmbracoBackOfficeIdentity);
                    if (backOfficeIdentity.IsAuthenticated)
                    {
                        context.Request.User = new ClaimsPrincipal(backOfficeIdentity);
                    }
                }
            }

            if (Next != null)
            {
                await Next.Invoke(context);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,63,23,73,0],[24,9,24,10,0],[25,9,25,10,0],[28,9,28,10,0],[29,13,29,68,0],[30,13,30,14,0],[31,17,31,79,0],[32,17,34,60,0],[34,60,34,80,0],[34,80,35,60,0],[35,60,35,90,0],[35,90,35,92,0],[32,17,35,92,0],[36,17,36,18,0],[37,21,37,84,0],[37,84,37,114,0],[37,114,37,116,0],[37,21,37,116,0],[38,21,38,60,0],[39,21,39,22,0],[40,25,40,88,0],[41,21,41,22,0],[42,17,42,18,0],[43,13,43,14,0],[45,13,45,30,0],[46,13,46,14,0],[47,17,47,44,0],[48,13,48,14,0],[49,9,49,10,0]]);
    </script>
  </body>
</html>