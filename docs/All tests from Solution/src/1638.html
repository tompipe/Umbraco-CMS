<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\DbConnectionExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;
using System.Data.SqlServerCe;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using MySql.Data.MySqlClient;
using Umbraco.Core.Logging; 

namespace Umbraco.Core.Persistence
{
    internal static class DbConnectionExtensions
    {

        public static DatabaseProviders DetectProviderFromConnectionString(string connString)
        {
            var builder = new DbConnectionStringBuilder {ConnectionString = connString};
            var allKeys = builder.Keys.Cast&lt;string&gt;();

            var mySql = new[] {&quot;Server&quot;, &quot;Database&quot;, &quot;Uid&quot;, &quot;Pwd&quot;};
            if (mySql.All(x =&gt; allKeys.InvariantContains(x)))
            {
                return DatabaseProviders.MySql;
            }

            if (allKeys.InvariantContains(&quot;Data Source&quot;) 
                //this dictionary is case insensitive
                &amp;&amp; builder[&quot;Data source&quot;].ToString().InvariantContains(&quot;.sdf&quot;))
            {
                return DatabaseProviders.SqlServerCE;
            }

            return DatabaseProviders.SqlServer;
        }

        public static bool IsConnectionAvailable(string connString, DatabaseProviders provider)
        {
            DbProviderFactory factory;
            switch (provider)
            {
                case DatabaseProviders.SqlServer:
                case DatabaseProviders.SqlAzure:
                    factory = DbProviderFactories.GetFactory(Constants.DatabaseProviders.SqlServer);
                    break;
                case DatabaseProviders.SqlServerCE:
                    factory = DbProviderFactories.GetFactory(&quot;System.Data.SqlServerCe.4.0&quot;);
                    break;
                case DatabaseProviders.MySql:
                    factory = DbProviderFactories.GetFactory(Constants.DatabaseProviders.MySql);
                    break;
                case DatabaseProviders.PostgreSQL:
                case DatabaseProviders.Oracle:
                case DatabaseProviders.SQLite:                    
                default:
                    throw new NotSupportedException(&quot;The provider &quot; + provider + &quot; is not supported&quot;);
            }

            var conn = factory.CreateConnection();
            if (conn == null)
            {
                throw new InvalidOperationException(&quot;Could not create a connection for provider &quot; + provider);
            }
            conn.ConnectionString = connString;
            using (var connection = conn)
            {
                return connection.IsAvailable();
            }
        }

        public static string GetConnStringExSecurityInfo(this IDbConnection connection)
        {
            try
            {
                if (connection is SqlConnection)
                {
                    var builder = new SqlConnectionStringBuilder(connection.ConnectionString);
                    return string.Format(&quot;DataSource: {0}, InitialCatalog: {1}&quot;, builder.DataSource, builder.InitialCatalog);
                }

                if (connection is SqlCeConnection)
                {
                    var builder = new SqlCeConnectionStringBuilder(connection.ConnectionString);
                    return string.Format(&quot;DataSource: {0}&quot;, builder.DataSource);
                }

                if (connection is MySqlConnection)
                {
                    var builder = new MySqlConnectionStringBuilder(connection.ConnectionString);
                    return string.Format(&quot;Server: {0}, Database: {1}&quot;, builder.Server, builder.Database);
                }
            }
            catch (Exception ex)
            {
                LogHelper.WarnWithException(typeof(DbConnectionExtensions),
                    &quot;Could not resolve connection string parameters&quot;, ex);
                return &quot;(Could not resolve)&quot;;
            }

            throw new ArgumentException(string.Format(&quot;The connection type {0} is not supported&quot;, connection.GetType()));
        }

        public static bool IsAvailable(this IDbConnection connection)
        {
            try
            {
                connection.Open();
                connection.Close();
            }
            catch (DbException exc)
            {
                // Don&#39;t swallow this error, the exception is super handy for knowing &quot;why&quot; its not available
                LogHelper.WarnWithException(typeof(DbConnectionExtensions),
                    &quot;Configured database is reporting as not being available! {0}&quot;, exc, connection.GetConnStringExSecurityInfo);
                return false;
            }

            return true;
        }

        
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,0],[21,13,21,89,0],[22,13,22,55,0],[24,13,24,68,0],[25,13,25,32,0],[25,32,25,60,0],[25,60,25,62,0],[25,13,25,62,0],[26,13,26,14,0],[27,17,27,48,0],[30,13,32,80,0],[33,13,33,14,0],[34,17,34,54,0],[37,13,37,48,0],[38,9,38,10,0],[41,9,41,10,1],[43,13,43,30,1],[47,21,47,101,0],[48,21,48,27,0],[50,21,50,93,1],[51,21,51,27,1],[53,21,53,97,0],[54,21,54,27,0],[59,21,59,103,0],[62,13,62,51,1],[63,13,63,30,1],[64,13,64,14,0],[65,17,65,111,0],[67,13,67,48,1],[68,20,68,41,1],[69,13,69,14,1],[70,17,70,49,1],[72,9,72,10,1],[75,9,75,10,0],[77,13,77,14,0],[78,17,78,49,0],[79,17,79,18,0],[80,21,80,95,0],[81,21,81,126,0],[84,17,84,51,0],[85,17,85,18,0],[86,21,86,97,0],[87,21,87,81,0],[90,17,90,51,0],[91,17,91,18,0],[92,21,92,97,0],[93,21,93,106,0],[95,13,95,14,0],[96,13,96,33,0],[97,13,97,14,0],[98,17,99,75,0],[100,17,100,46,0],[103,13,103,122,0],[104,9,104,10,0],[107,9,107,10,1],[109,13,109,14,1],[110,17,110,35,1],[111,17,111,36,0],[112,13,112,14,0],[113,13,113,36,1],[114,13,114,14,1],[116,17,117,130,1],[118,17,118,30,1],[121,13,121,25,0],[122,9,122,10,1]]);
    </script>
  </body>
</html>