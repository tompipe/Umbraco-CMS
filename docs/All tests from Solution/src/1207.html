<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Models\Mapping\MemberModelMapper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using System.Web.Security;
using AutoMapper;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Mapping;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using System.Linq;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Security;
using Umbraco.Web.Trees;

namespace Umbraco.Web.Models.Mapping
{
    /// &lt;summary&gt;
    /// Declares model mappings for members.
    /// &lt;/summary&gt;
    internal class MemberModelMapper : MapperConfiguration
    {
        public override void ConfigureMappings(IConfiguration config, ApplicationContext applicationContext)
        {
            //FROM MembershipUser TO MediaItemDisplay - used when using a non-umbraco membership provider
            config.CreateMap&lt;MembershipUser, MemberDisplay&gt;()
                .ConvertUsing(user =&gt;
                {
                    var member = Mapper.Map&lt;MembershipUser, IMember&gt;(user);
                    return Mapper.Map&lt;IMember, MemberDisplay&gt;(member);
                });

            //FROM MembershipUser TO IMember - used when using a non-umbraco membership provider
            config.CreateMap&lt;MembershipUser, IMember&gt;()
                .ConstructUsing(user =&gt; MemberService.CreateGenericMembershipProviderMember(user.UserName, user.Email, user.UserName, &quot;&quot;))
                //we&#39;re giving this entity an ID of 0 - we cannot really map it but it needs an id so the system knows it&#39;s not a new entity
                .ForMember(member =&gt; member.Id, expression =&gt; expression.MapFrom(user =&gt; int.MaxValue))
                .ForMember(member =&gt; member.Comments, expression =&gt; expression.MapFrom(user =&gt; user.Comment))
                .ForMember(member =&gt; member.CreateDate, expression =&gt; expression.MapFrom(user =&gt; user.CreationDate))
                .ForMember(member =&gt; member.UpdateDate, expression =&gt; expression.MapFrom(user =&gt; user.LastActivityDate))
                .ForMember(member =&gt; member.LastPasswordChangeDate, expression =&gt; expression.MapFrom(user =&gt; user.LastPasswordChangedDate))
                .ForMember(member =&gt; member.Key, expression =&gt; expression.MapFrom(user =&gt; user.ProviderUserKey.TryConvertTo&lt;Guid&gt;().Result.ToString(&quot;N&quot;)))
                //This is a special case for password - we don&#39;t actually care what the password is but it either needs to be something or nothing
                // so we&#39;ll set it to something if the member is actually created, otherwise nothing if it is a new member.
                .ForMember(member =&gt; member.RawPasswordValue, expression =&gt; expression.MapFrom(user =&gt; user.CreationDate &gt; DateTime.MinValue ? Guid.NewGuid().ToString(&quot;N&quot;) : &quot;&quot;))
                .ForMember(member =&gt; member.Properties, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.CreatorId, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.Level, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.Name, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.ParentId, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.Path, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.SortOrder, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.AdditionalData, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.FailedPasswordAttempts, expression =&gt; expression.Ignore())
                //TODO: Support these eventually
                .ForMember(member =&gt; member.PasswordQuestion, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.RawPasswordAnswerValue, expression =&gt; expression.Ignore());

            //FROM IMember TO MediaItemDisplay
            config.CreateMap&lt;IMember, MemberDisplay&gt;()
                .ForMember(display =&gt; display.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IMember&gt;()))
                .ForMember(display =&gt; display.Icon, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Icon))
                .ForMember(display =&gt; display.ContentTypeAlias, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Alias))
                .ForMember(display =&gt; display.ContentTypeName, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Name))
                .ForMember(display =&gt; display.Properties, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Tabs, expression =&gt; expression.ResolveUsing(new MemberTabsAndPropertiesResolver(applicationContext.Services.TextService)))
                .ForMember(display =&gt; display.MemberProviderFieldMapping, expression =&gt; expression.ResolveUsing(new MemberProviderFieldMappingResolver()))
                .ForMember(display =&gt; display.MembershipScenario,
                    expression =&gt; expression.ResolveUsing(new MembershipScenarioMappingResolver(new Lazy&lt;IMemberTypeService&gt;(() =&gt; applicationContext.Services.MemberTypeService))))
                .ForMember(display =&gt; display.Notifications, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Errors, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Published, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Updater, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Alias, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.IsChildOfListView, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Trashed, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.IsContainer, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.TreeNodeUrl, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.HasPublishedVersion, expression =&gt; expression.Ignore())
                .AfterMap((member, display) =&gt; MapGenericCustomProperties(applicationContext.Services.MemberService, member, display, applicationContext.Services.TextService));

            //FROM IMember TO MemberBasic
            config.CreateMap&lt;IMember, MemberBasic&gt;()
                .ForMember(dto =&gt; dto.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IMember&gt;()))
                .ForMember(dto =&gt; dto.Icon, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Icon))
                .ForMember(dto =&gt; dto.ContentTypeAlias, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Alias))
                .ForMember(dto =&gt; dto.Email, expression =&gt; expression.MapFrom(content =&gt; content.Email))
                .ForMember(dto =&gt; dto.Username, expression =&gt; expression.MapFrom(content =&gt; content.Username))
                .ForMember(dto =&gt; dto.Trashed, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Published, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Updater, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Alias, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.HasPublishedVersion, expression =&gt; expression.Ignore());

            //FROM MembershipUser TO MemberBasic
            config.CreateMap&lt;MembershipUser, MemberBasic&gt;()
                //we&#39;re giving this entity an ID of 0 - we cannot really map it but it needs an id so the system knows it&#39;s not a new entity
                .ForMember(member =&gt; member.Id, expression =&gt; expression.MapFrom(user =&gt; int.MaxValue))
                .ForMember(member =&gt; member.CreateDate, expression =&gt; expression.MapFrom(user =&gt; user.CreationDate))
                .ForMember(member =&gt; member.UpdateDate, expression =&gt; expression.MapFrom(user =&gt; user.LastActivityDate))
                .ForMember(member =&gt; member.Key, expression =&gt; expression.MapFrom(user =&gt; user.ProviderUserKey.TryConvertTo&lt;Guid&gt;().Result.ToString(&quot;N&quot;)))
                .ForMember(member =&gt; member.Owner, expression =&gt; expression.UseValue(new UserBasic {Name = &quot;Admin&quot;, UserId = 0}))
                .ForMember(member =&gt; member.Icon, expression =&gt; expression.UseValue(&quot;icon-user&quot;))
                .ForMember(member =&gt; member.Name, expression =&gt; expression.MapFrom(user =&gt; user.UserName))
                .ForMember(member =&gt; member.Email, expression =&gt; expression.MapFrom(content =&gt; content.Email))
                .ForMember(member =&gt; member.Username, expression =&gt; expression.MapFrom(content =&gt; content.UserName))
                .ForMember(member =&gt; member.Properties, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.ParentId, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.Path, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.SortOrder, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.AdditionalData, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.Published, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.Updater, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.Trashed, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.Alias, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.ContentTypeAlias, expression =&gt; expression.Ignore())
                .ForMember(member =&gt; member.HasPublishedVersion, expression =&gt; expression.Ignore());

            //FROM IMember TO ContentItemDto&lt;IMember&gt;
            config.CreateMap&lt;IMember, ContentItemDto&lt;IMember&gt;&gt;()
                .ForMember(dto =&gt; dto.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IMember&gt;()))
                .ForMember(dto =&gt; dto.Published, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Updater, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Icon, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Alias, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.HasPublishedVersion, expression =&gt; expression.Ignore())
                //do no map the custom member properties (currently anyways, they were never there in 6.x)
                .ForMember(dto =&gt; dto.Properties, expression =&gt; expression.ResolveUsing(new MemberDtoPropertiesValueResolver()));
        }

        /// &lt;summary&gt;
        /// Maps the generic tab with custom properties for content
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;memberService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;member&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;display&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;localizedText&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// If this is a new entity and there is an approved field then we&#39;ll set it to true by default.
        /// &lt;/remarks&gt;
        private static void MapGenericCustomProperties(IMemberService memberService, IMember member, MemberDisplay display, ILocalizedTextService localizedText)
        {
            var membersProvider = Core.Security.MembershipProviderExtensions.GetMembersMembershipProvider();

            //map the tree node url
            if (HttpContext.Current != null)
            {
                var urlHelper = new UrlHelper(new RequestContext(new HttpContextWrapper(HttpContext.Current), new RouteData()));
                var url = urlHelper.GetUmbracoApiService&lt;MemberTreeController&gt;(controller =&gt; controller.GetTreeNode(display.Key.ToString(&quot;N&quot;), null));
                display.TreeNodeUrl = url;
            }

            var genericProperties = new List&lt;ContentPropertyDisplay&gt;
            {
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}doctype&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;content/membertype&quot;),
                    Value = localizedText.UmbracoDictionaryTranslate(display.ContentTypeName),
                    View = PropertyEditorResolver.Current.GetByAlias(Constants.PropertyEditors.NoEditAlias).ValueEditor.View
                },
                GetLoginProperty(memberService, member, display, localizedText),
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}email&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;general/email&quot;),
                    Value = display.Email,
                    View = &quot;email&quot;,
                    Validation = {Mandatory = true}
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}password&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;password&quot;),
                    //NOTE: The value here is a json value - but the only property we care about is the generatedPassword one if it exists, the newPassword exists
                    // only when creating a new member and we want to have a generated password pre-filled.
                    Value = new Dictionary&lt;string, object&gt;
                    {
                        {&quot;generatedPassword&quot;, member.GetAdditionalDataValueIgnoreCase(&quot;GeneratedPassword&quot;, null)},
                        {&quot;newPassword&quot;, member.GetAdditionalDataValueIgnoreCase(&quot;NewPassword&quot;, null)},
                    },
                    //TODO: Hard coding this because the changepassword doesn&#39;t necessarily need to be a resolvable (real) property editor
                    View = &quot;changepassword&quot;,
                    //initialize the dictionary with the configuration from the default membership provider
                    Config = new Dictionary&lt;string, object&gt;(membersProvider.GetConfiguration())
                    {
                        //the password change toggle will only be displayed if there is already a password assigned.
                        {&quot;hasPassword&quot;, member.RawPasswordValue.IsNullOrWhiteSpace() == false}
                    }
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}membergroup&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;content/membergroup&quot;),
                    Value = GetMemberGroupValue(display.Username),
                    View = &quot;membergroups&quot;,
                    Config = new Dictionary&lt;string, object&gt; {{&quot;IsRequired&quot;, true}}
                }
            };

            TabsAndPropertiesResolver.MapGenericProperties(member, display, localizedText, genericProperties, properties =&gt;
            {
                if (HttpContext.Current != null &amp;&amp; UmbracoContext.Current != null &amp;&amp; UmbracoContext.Current.Security.CurrentUser != null
                    &amp;&amp; UmbracoContext.Current.Security.CurrentUser.AllowedSections.Any(x =&gt; x.Equals(Constants.Applications.Settings)))
                {
                    var memberTypeLink = string.Format(&quot;#/member/memberTypes/edit/{0}&quot;, member.ContentTypeId);

                    //Replace the doctype property
                    var docTypeProperty = properties.First(x =&gt; x.Alias == string.Format(&quot;{0}doctype&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix));
                    docTypeProperty.Value = new List&lt;object&gt;
                    {
                        new
                        {
                            linkText = member.ContentType.Name,
                            url = memberTypeLink,
                            target = &quot;_self&quot;,
                            icon = &quot;icon-item-arrangement&quot;
                        }
                    };
                    docTypeProperty.View = &quot;urllist&quot;;
                }
            });

            //check if there&#39;s an approval field
            var provider = membersProvider as global::umbraco.providers.members.UmbracoMembershipProvider;
            if (member.HasIdentity == false &amp;&amp; provider != null)
            {
                var approvedField = provider.ApprovedPropertyTypeAlias;
                var prop = display.Properties.FirstOrDefault(x =&gt; x.Alias == approvedField);
                if (prop != null)
                {
                    prop.Value = 1;
                }
            }
        }

        /// &lt;summary&gt;
        /// Returns the login property display field
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;memberService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;member&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;display&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;localizedText&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// If the membership provider installed is the umbraco membership provider, then we will allow changing the username, however if
        /// the membership provider is a custom one, we cannot allow chaning the username because MembershipProvider&#39;s do not actually natively
        /// allow that.
        /// &lt;/remarks&gt;
        internal static ContentPropertyDisplay GetLoginProperty(IMemberService memberService, IMember member, MemberDisplay display, ILocalizedTextService localizedText)
        {
            var prop = new ContentPropertyDisplay
            {
                Alias = string.Format(&quot;{0}login&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                Label = localizedText.Localize(&quot;login&quot;),
                Value = display.Username
            };

            var scenario = memberService.GetMembershipScenario();

            //only allow editing if this is a new member, or if the membership provider is the umbraco one
            if (member.HasIdentity == false || scenario == MembershipScenario.NativeUmbraco)
            {
                prop.View = &quot;textbox&quot;;
                prop.Validation.Mandatory = true;
            }
            else
            {
                prop.View = &quot;readonlyvalue&quot;;
            }
            return prop;
        }

        internal static IDictionary&lt;string, bool&gt; GetMemberGroupValue(string username)
        {
            var userRoles = username.IsNullOrWhiteSpace() ? null : Roles.GetRolesForUser(username);

            // create a dictionary of all roles (except internal roles) + &quot;false&quot;
            var result = Roles.GetAllRoles().Distinct()
                // if a role starts with __umbracoRole we won&#39;t show it as it&#39;s an internal role used for public access
                .Where(x =&gt; x.StartsWith(Constants.Conventions.Member.InternalRolePrefix) == false)
                .ToDictionary(x =&gt; x, x =&gt; false);

            // if user has no roles, just return the dictionary
            if (userRoles == null) return result;

            // else update the dictionary to &quot;true&quot; for the user roles (except internal roles)
            foreach (var userRole in userRoles.Where(x =&gt; x.StartsWith(Constants.Conventions.Member.InternalRolePrefix) == false))
                result[userRole] = true;

            return result;
        }

        /// &lt;summary&gt;
        /// This ensures that the custom membership provider properties are not mapped - these property values are controller by the membership provider
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Because these properties don&#39;t exist on the form, if we don&#39;t remove them for this map we&#39;ll get validation errors when posting data
        /// &lt;/remarks&gt;
        internal class MemberDtoPropertiesValueResolver : ValueResolver&lt;IMember, IEnumerable&lt;ContentPropertyDto&gt;&gt;
        {
            protected override IEnumerable&lt;ContentPropertyDto&gt; ResolveCore(IMember source)
            {
                var defaultProps = Constants.Conventions.Member.GetStandardPropertyTypeStubs();

                //remove all membership properties, these values are set with the membership provider.
                var exclude = defaultProps.Select(x =&gt; x.Value.Alias).ToArray();

                return source.Properties
                    .Where(x =&gt; exclude.Contains(x.Alias) == false)
                    .Select(Mapper.Map&lt;Property, ContentPropertyDto&gt;);
            }
        }

        /// &lt;summary&gt;
        /// A custom tab/property resolver for members which will ensure that the built-in membership properties are or arent&#39; displayed
        /// depending on if the member type has these properties
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// This also ensures that the IsLocked out property is readonly when the member is not locked out - this is because
        /// an admin cannot actually set isLockedOut = true, they can only unlock.
        /// &lt;/remarks&gt;
        internal class MemberTabsAndPropertiesResolver : TabsAndPropertiesResolver
        {
            private readonly ILocalizedTextService _localizedTextService;

            public MemberTabsAndPropertiesResolver(ILocalizedTextService localizedTextService)
                : base(localizedTextService)
            {
                _localizedTextService = localizedTextService;
            }

            public MemberTabsAndPropertiesResolver(ILocalizedTextService localizedTextService,
                IEnumerable&lt;string&gt; ignoreProperties) : base(localizedTextService, ignoreProperties)
            {
                _localizedTextService = localizedTextService;
            }

            protected override IEnumerable&lt;Tab&lt;ContentPropertyDisplay&gt;&gt; ResolveCore(IContentBase content)
            {
                var provider = Core.Security.MembershipProviderExtensions.GetMembersMembershipProvider();

                IgnoreProperties = content.PropertyTypes
                    .Where(x =&gt; x.HasIdentity == false)
                    .Select(x =&gt; x.Alias)
                    .ToArray();

                var result = base.ResolveCore(content).ToArray();

                if (provider.IsUmbracoMembershipProvider() == false)
                {
                    //it&#39;s a generic provider so update the locked out property based on our known constant alias
                    var isLockedOutProperty = result.SelectMany(x =&gt; x.Properties).FirstOrDefault(x =&gt; x.Alias == Constants.Conventions.Member.IsLockedOut);
                    if (isLockedOutProperty != null &amp;&amp; isLockedOutProperty.Value.ToString() != &quot;1&quot;)
                    {
                        isLockedOutProperty.View = &quot;readonlyvalue&quot;;
                        isLockedOutProperty.Value = _localizedTextService.Localize(&quot;general/no&quot;);
                    }

                    return result;
                }
                else
                {
                    var umbracoProvider = (IUmbracoMemberTypeMembershipProvider) provider;

                    //This is kind of a hack because a developer is supposed to be allowed to set their property editor - would have been much easier
                    // if we just had all of the membeship provider fields on the member table :(
                    // TODO: But is there a way to map the IMember.IsLockedOut to the property ? i dunno.
                    var isLockedOutProperty = result.SelectMany(x =&gt; x.Properties).FirstOrDefault(x =&gt; x.Alias == umbracoProvider.LockPropertyTypeAlias);
                    if (isLockedOutProperty != null &amp;&amp; isLockedOutProperty.Value.ToString() != &quot;1&quot;)
                    {
                        isLockedOutProperty.View = &quot;readonlyvalue&quot;;
                        isLockedOutProperty.Value = _localizedTextService.Localize(&quot;general/no&quot;);
                    }

                    return result;
                }
            }
        }

        internal class MembershipScenarioMappingResolver : ValueResolver&lt;IMember, MembershipScenario&gt;
        {
            private readonly Lazy&lt;IMemberTypeService&gt; _memberTypeService;

            public MembershipScenarioMappingResolver(Lazy&lt;IMemberTypeService&gt; memberTypeService)
            {
                _memberTypeService = memberTypeService;
            }

            protected override MembershipScenario ResolveCore(IMember source)
            {
                var provider = Core.Security.MembershipProviderExtensions.GetMembersMembershipProvider();

                if (provider.IsUmbracoMembershipProvider())
                {
                    return MembershipScenario.NativeUmbraco;
                }
                var memberType = _memberTypeService.Value.Get(Constants.Conventions.MemberTypes.DefaultAlias);
                return memberType != null
                    ? MembershipScenario.CustomProviderWithUmbracoLink
                    : MembershipScenario.StandaloneCustomProvider;
            }
        }

        /// &lt;summary&gt;
        /// A resolver to map the provider field aliases
        /// &lt;/summary&gt;
        internal class MemberProviderFieldMappingResolver : ValueResolver&lt;IMember, IDictionary&lt;string, string&gt;&gt;
        {
            protected override IDictionary&lt;string, string&gt; ResolveCore(IMember source)
            {
                var provider = Core.Security.MembershipProviderExtensions.GetMembersMembershipProvider();

                if (provider.IsUmbracoMembershipProvider() == false)
                {
                    return new Dictionary&lt;string, string&gt;
                    {
                        {Constants.Conventions.Member.IsLockedOut, Constants.Conventions.Member.IsLockedOut},
                        {Constants.Conventions.Member.IsApproved, Constants.Conventions.Member.IsApproved},
                        {Constants.Conventions.Member.Comments, Constants.Conventions.Member.Comments}
                    };
                }
                else
                {
                    var umbracoProvider = (IUmbracoMemberTypeMembershipProvider) provider;

                    return new Dictionary&lt;string, string&gt;
                    {
                        {Constants.Conventions.Member.IsLockedOut, umbracoProvider.LockPropertyTypeAlias},
                        {Constants.Conventions.Member.IsApproved, umbracoProvider.ApprovedPropertyTypeAlias},
                        {Constants.Conventions.Member.Comments, umbracoProvider.CommentPropertyTypeAlias}
                    };
                }
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,1],[29,13,31,17,1],[31,17,31,18,0],[31,18,32,21,1],[32,21,32,76,0],[32,76,33,21,1],[33,21,33,71,0],[33,71,34,17,1],[34,17,34,18,0],[34,18,34,20,1],[29,13,34,20,1],[37,13,38,41,1],[38,41,38,138,0],[38,138,40,63,1],[40,63,40,103,1],[40,103,41,69,1],[41,69,41,109,1],[41,109,42,71,1],[42,71,42,116,1],[42,116,43,71,1],[43,71,43,120,1],[43,120,44,83,1],[44,83,44,139,1],[44,139,45,64,1],[45,64,45,154,1],[45,154,48,77,1],[48,77,48,178,1],[48,178,49,71,1],[49,71,49,90,1],[49,90,50,70,1],[50,70,50,89,1],[50,89,51,66,1],[51,66,51,85,1],[51,85,52,65,1],[52,65,52,84,1],[52,84,53,69,1],[53,69,53,88,1],[53,88,54,65,1],[54,65,54,84,1],[54,84,55,70,1],[55,70,55,89,1],[55,89,56,75,1],[56,75,56,94,1],[56,94,57,83,1],[57,83,57,102,1],[57,102,59,77,1],[59,77,59,96,1],[59,96,60,83,1],[60,83,60,102,1],[60,102,60,104,1],[37,13,60,104,1],[63,13,64,68,1],[64,68,64,121,1],[64,121,65,67,1],[65,67,65,122,1],[65,122,66,79,1],[66,79,66,135,1],[66,135,67,78,1],[67,78,67,133,1],[67,133,68,73,1],[68,73,68,92,1],[68,92,69,67,1],[69,67,69,168,1],[69,168,70,89,1],[70,89,70,154,1],[70,154,72,35,1],[72,35,72,132,1],[72,132,72,177,0],[72,177,72,180,1],[72,35,72,180,1],[72,180,73,76,1],[73,76,73,95,1],[73,95,74,69,1],[74,69,74,88,1],[74,88,75,72,1],[75,72,75,91,1],[75,91,76,70,1],[76,70,76,89,1],[76,89,77,68,1],[77,68,77,87,1],[77,87,78,80,1],[78,80,78,99,1],[78,99,79,70,1],[79,70,79,89,1],[79,89,80,74,1],[80,74,80,93,1],[80,93,81,74,1],[81,74,81,93,1],[81,93,82,82,1],[82,82,82,101,1],[82,101,83,48,1],[83,48,83,175,0],[83,175,83,177,1],[63,13,83,177,1],[86,13,87,60,1],[87,60,87,113,1],[87,113,88,59,1],[88,59,88,114,1],[88,114,89,71,1],[89,71,89,127,1],[89,127,90,60,1],[90,60,90,104,1],[90,104,91,63,1],[91,63,91,110,1],[91,110,92,62,1],[92,62,92,81,1],[92,81,93,64,1],[93,64,93,83,1],[93,83,94,62,1],[94,62,94,81,1],[94,81,95,60,1],[95,60,95,79,1],[95,79,96,74,1],[96,74,96,93,1],[96,93,96,95,1],[86,13,96,95,1],[99,13,101,63,1],[101,63,101,103,1],[101,103,102,71,1],[102,71,102,116,1],[102,116,103,71,1],[103,71,103,120,1],[103,120,104,64,1],[104,64,104,154,1],[104,154,105,66,1],[105,66,105,129,1],[105,129,106,65,1],[106,65,106,97,1],[106,97,107,65,1],[107,65,107,106,1],[107,106,108,66,1],[108,66,108,110,1],[108,110,109,69,1],[109,69,109,116,1],[109,116,110,71,1],[110,71,110,90,1],[110,90,111,69,1],[111,69,111,88,1],[111,88,112,65,1],[112,65,112,84,1],[112,84,113,70,1],[113,70,113,89,1],[113,89,114,75,1],[114,75,114,94,1],[114,94,115,70,1],[115,70,115,89,1],[115,89,116,68,1],[116,68,116,87,1],[116,87,117,68,1],[117,68,117,87,1],[117,87,118,66,1],[118,66,118,85,1],[118,85,119,77,1],[119,77,119,96,1],[119,96,120,80,1],[120,80,120,99,1],[120,99,120,101,1],[99,13,120,101,1],[123,13,124,60,1],[124,60,124,113,1],[124,113,125,64,1],[125,64,125,83,1],[125,83,126,62,1],[126,62,126,81,1],[126,81,127,59,1],[127,59,127,78,1],[127,78,128,60,1],[128,60,128,79,1],[128,79,129,74,1],[129,74,129,93,1],[129,93,131,65,1],[131,65,131,128,1],[131,128,131,130,1],[123,13,131,130,1],[132,9,132,10,1],[145,9,145,10,0],[146,13,146,109,0],[149,13,149,45,0],[150,13,150,14,0],[151,17,151,129,0],[152,17,152,151,0],[153,17,153,43,0],[154,13,154,14,0],[156,13,202,15,0],[204,13,205,13,0],[205,13,205,14,0],[205,14,206,17,0],[206,17,207,93,0],[207,93,207,134,0],[207,134,207,136,0],[206,17,207,136,0],[207,136,208,17,0],[208,17,208,18,0],[208,18,209,21,0],[209,21,209,111,0],[209,111,212,21,0],[212,21,212,65,0],[212,65,212,162,0],[212,162,212,164,0],[212,21,212,164,0],[212,164,213,21,0],[213,21,222,23,0],[222,23,223,21,0],[223,21,223,54,0],[223,54,224,17,0],[224,17,224,18,0],[224,18,225,13,0],[225,13,225,14,0],[225,14,225,16,0],[204,13,225,16,0],[228,13,228,107,0],[229,13,229,65,0],[230,13,230,14,0],[231,17,231,72,0],[232,17,232,67,0],[232,67,232,91,0],[232,91,232,93,0],[232,17,232,93,0],[233,17,233,34,0],[234,17,234,18,0],[235,21,235,36,0],[236,17,236,18,0],[237,13,237,14,0],[238,9,238,10,0],[254,9,254,10,0],[255,13,260,15,0],[262,13,262,66,0],[265,13,265,93,0],[266,13,266,14,0],[267,17,267,39,0],[268,17,268,50,0],[269,13,269,14,0],[271,13,271,14,0],[272,17,272,45,0],[273,13,273,14,0],[274,13,274,25,0],[275,9,275,10,0],[278,9,278,10,0],[279,13,279,100,0],[282,13,284,29,0],[284,29,284,99,0],[284,99,285,36,0],[285,36,285,37,0],[285,37,285,44,0],[285,44,285,49,0],[285,49,285,51,0],[282,13,285,51,0],[288,13,288,35,0],[288,36,288,50,0],[291,13,291,20,0],[291,22,291,34,0],[291,35,291,37,0],[291,38,291,59,0],[291,59,291,129,0],[291,129,291,130,0],[291,38,291,130,0],[292,17,292,41,0],[294,13,294,27,0],[295,9,295,10,0],[306,13,306,14,0],[307,17,307,96,0],[310,17,310,56,0],[310,56,310,69,0],[310,69,310,81,0],[310,17,310,81,0],[312,17,313,33,0],[313,33,313,67,0],[313,67,314,71,0],[312,17,314,71,0],[315,13,315,14,0],[331,19,331,45,1],[332,13,332,14,1],[333,17,333,62,1],[334,13,334,14,1],[337,57,337,101,0],[338,13,338,14,0],[339,17,339,62,0],[340,13,340,14,0],[343,13,343,14,0],[344,17,344,106,0],[346,17,347,33,0],[347,33,347,55,0],[347,55,348,34,0],[348,34,348,41,0],[348,41,349,32,0],[346,17,349,32,0],[351,17,351,66,0],[353,17,353,69,0],[354,17,354,18,0],[356,21,356,70,0],[356,70,356,82,0],[356,82,356,104,0],[356,104,356,155,0],[356,155,356,157,0],[356,21,356,157,0],[357,21,357,100,0],[358,21,358,22,0],[359,25,359,68,0],[360,25,360,98,0],[361,21,361,22,0],[363,21,363,35,0],[366,17,366,18,0],[367,21,367,91,0],[372,21,372,70,0],[372,70,372,82,0],[372,82,372,104,0],[372,104,372,152,0],[372,152,372,154,0],[372,21,372,154,0],[373,21,373,100,0],[374,21,374,22,0],[375,25,375,68,0],[376,25,376,98,0],[377,21,377,22,0],[379,21,379,35,0],[381,13,381,14,0],[388,13,388,97,1],[389,13,389,14,1],[390,17,390,56,1],[391,13,391,14,1],[394,13,394,14,0],[395,17,395,106,0],[397,17,397,60,0],[398,17,398,18,0],[399,21,399,61,0],[401,17,401,111,0],[402,17,404,67,0],[405,13,405,14,0],[414,13,414,14,0],[415,17,415,106,0],[417,17,417,69,0],[418,17,418,18,0],[419,21,424,23,0],[427,17,427,18,0],[428,21,428,91,0],[430,21,435,23,0],[437,13,437,14,0]]);
    </script>
  </body>
</html>