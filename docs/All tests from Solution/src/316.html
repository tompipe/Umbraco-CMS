<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Routing\RenderRouteHandlerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Web.Mvc;
using System.Web.Routing;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Stubs;
using Umbraco.Web;
using Umbraco.Web.Models;
using Umbraco.Web.Mvc;
using Umbraco.Web.Routing;
using Umbraco.Web.WebApi;
using umbraco.BusinessLogic;
using Umbraco.Core.Profiling;
using Umbraco.Core.Strings;

namespace Umbraco.Tests.Routing
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerFixture)]
	[TestFixture]
	public class RenderRouteHandlerTests : BaseRoutingTest
	{

		public override void Initialize()
		{                       
			base.Initialize();

		    SettingsForTests.UmbracoPath = &quot;~/umbraco&quot;;
            
			var webBoot = new WebBootManager(new UmbracoApplication(), new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()),  true);
			//webBoot.Initialize();
			//webBoot.Startup(null); -&gt; don&#39;t call startup, we don&#39;t want any other application event handlers to bind for this test.
			//webBoot.Complete(null);
			webBoot.CreateRoutes();
		}

        protected override void FreezeResolution()
        {
            DefaultRenderMvcControllerResolver.Current = new DefaultRenderMvcControllerResolver(typeof(RenderMvcController));

            SurfaceControllerResolver.Current = new SurfaceControllerResolver(
                new ActivatorServiceProvider(), Logger,
                PluginManager.Current.ResolveSurfaceControllers());
            UmbracoApiControllerResolver.Current = new UmbracoApiControllerResolver(
                new ActivatorServiceProvider(), Logger,
                PluginManager.Current.ResolveUmbracoApiControllers());
            ShortStringHelperResolver.Current = new ShortStringHelperResolver(new LegacyShortStringHelper());

            base.FreezeResolution();
        }

		public override void TearDown()
		{
			base.TearDown();
		    UmbracoContext.Current = null;
			RouteTable.Routes.Clear();			
		}

        Template CreateTemplate(string alias)
        {
            var path = &quot;template&quot;;
            var name = &quot;Template&quot;;
            var template = new Template(path, name, alias);
            template.Content = &quot;&quot;; // else saving throws with a dirty internal error
            ApplicationContext.Services.FileService.SaveTemplate(template);
            return template;
        }

		/// &lt;summary&gt;
		/// Will route to the default controller and action since no custom controller is defined for this node route
		/// &lt;/summary&gt;
		[Test]
		public void Umbraco_Route_Umbraco_Defined_Controller_Action()
		{
            var template = CreateTemplate(&quot;homePage&quot;);
			var route = RouteTable.Routes[&quot;Umbraco_default&quot;];
			var routeData = new RouteData() { Route = route };
			var routingContext = GetRoutingContext(&quot;~/dummy-page&quot;, template.Id, routeData);
			var docRequest = new PublishedContentRequest(routingContext.UmbracoContext.CleanedUmbracoUrl, routingContext)
			{
                PublishedContent = routingContext.UmbracoContext.ContentCache.GetById(1174),
				TemplateModel = template,
                RenderingEngine = RenderingEngine.Mvc
			};

			var handler = new RenderRouteHandler(
                new TestControllerFactory(routingContext.UmbracoContext, Mock.Of&lt;ILogger&gt;()), 
                routingContext.UmbracoContext);

			handler.GetHandlerForRoute(routingContext.UmbracoContext.HttpContext.Request.RequestContext, docRequest);
			Assert.AreEqual(&quot;RenderMvc&quot;, routeData.Values[&quot;controller&quot;].ToString());
            //the route action will still be the one we&#39;ve asked for because our RenderActionInvoker is the thing that decides
            // if the action matches.
            Assert.AreEqual(&quot;homePage&quot;, routeData.Values[&quot;action&quot;].ToString());
		}

		//test all template name styles to match the ActionName

        //[TestCase(&quot;home-\\234^^*32page&quot;)]        //TODO: This fails!
        [TestCase(&quot;home-page&quot;)]
        [TestCase(&quot;home-page&quot;)]
        [TestCase(&quot;home-page&quot;)]
		[TestCase(&quot;Home-Page&quot;)] 
		[TestCase(&quot;HomePage&quot;)]
		[TestCase(&quot;homePage&quot;)]
        [TestCase(&quot;site1/template2&quot;)]
        [TestCase(&quot;site1\\template2&quot;)]
        public void Umbraco_Route_User_Defined_Controller_Action(string templateName)
		{
            // NOTE - here we create templates with crazy aliases... assuming that these
            // could exist in the database... yet creating templates should sanitize
            // aliases one way or another...

            var template = CreateTemplate(templateName);
            var route = RouteTable.Routes[&quot;Umbraco_default&quot;];
			var routeData = new RouteData() {Route = route};
			var routingContext = GetRoutingContext(&quot;~/dummy-page&quot;, template.Id, routeData, true);
			var docRequest = new PublishedContentRequest(routingContext.UmbracoContext.CleanedUmbracoUrl, routingContext)
				{
                    PublishedContent = routingContext.UmbracoContext.ContentCache.GetById(1172), 
					TemplateModel = template
				};

			var handler = new RenderRouteHandler(
                new TestControllerFactory(routingContext.UmbracoContext, Mock.Of&lt;ILogger&gt;()), 
                routingContext.UmbracoContext);

			handler.GetHandlerForRoute(routingContext.UmbracoContext.HttpContext.Request.RequestContext, docRequest);
			Assert.AreEqual(&quot;CustomDocument&quot;, routeData.Values[&quot;controller&quot;].ToString());
		    Assert.AreEqual(
                //global::umbraco.cms.helpers.Casing.SafeAlias(template.Alias),
                template.Alias.ToSafeAlias(),
		        routeData.Values[&quot;action&quot;].ToString());
		}


		#region Internal classes

		///// &lt;summary&gt;
		///// Used to test a user route (non-umbraco)
		///// &lt;/summary&gt;
		//private class CustomUserController : Controller
		//{

		//    public ActionResult Index()
		//    {
		//        return View();
		//    }

		//    public ActionResult Test(int id)
		//    {
		//        return View();
		//    }

		//}

		/// &lt;summary&gt;
		/// Used to test a user route umbraco route
		/// &lt;/summary&gt;
		public class CustomDocumentController : RenderMvcController
		{
		    public CustomDocumentController(UmbracoContext umbracoContext) : base(umbracoContext)
		    {
		    }

		    public ActionResult HomePage(RenderModel model)
			{
				return View();
			}

		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[27,3,27,4,1],[28,4,28,22,1],[30,7,30,50,1],[32,4,32,133,1],[36,4,36,27,1],[37,3,37,4,1],[40,9,40,10,1],[41,13,41,126,1],[43,13,45,68,1],[46,13,48,71,1],[49,13,49,110,1],[51,13,51,37,1],[52,9,52,10,1],[55,3,55,4,1],[56,4,56,20,1],[57,7,57,37,1],[58,4,58,30,1],[59,3,59,4,1],[62,9,62,10,1],[63,13,63,35,1],[64,13,64,35,1],[65,13,65,60,1],[66,13,66,35,1],[67,13,67,76,1],[68,13,68,29,1],[69,9,69,10,1],[76,3,76,4,1],[77,13,77,55,1],[78,4,78,53,1],[79,4,79,54,1],[80,4,80,83,1],[81,4,86,6,1],[88,4,90,48,1],[92,4,92,109,1],[93,4,93,76,1],[96,13,96,80,1],[97,3,97,4,1],[111,3,111,4,1],[116,13,116,57,1],[117,13,117,62,1],[118,4,118,52,1],[119,4,119,89,1],[120,4,124,7,1],[126,4,128,48,1],[130,4,130,109,1],[131,4,131,81,1],[132,7,135,50,1],[136,3,136,4,1],[164,72,164,92,1],[165,7,165,8,1],[166,7,166,8,1],[169,4,169,5,0],[170,5,170,19,0],[171,4,171,5,0]]);
    </script>
  </body>
</html>