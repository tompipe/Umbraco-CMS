<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\SyntaxProvider\MySqlSyntaxProviderTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.SyntaxProvider
{
    //[NUnit.Framework.Ignore(&quot;This doesn&#39;t actually test anything&quot;)]
    [TestFixture]
    public class MySqlSyntaxProviderTests : BaseUsingSqlCeSyntax
    {
        [SetUp]
        public void SetUp()
        {
            SqlSyntaxContext.SqlSyntaxProvider = new MySqlSyntaxProvider(Mock.Of&lt;ILogger&gt;());
        }

        [Test]
        [NUnit.Framework.Ignore]
        public void Can_Generate_Create_Table_Statement()
        {
            var type = typeof(TagRelationshipDto);
            var definition = DefinitionFactory.GetTableDefinition(SqlSyntaxContext.SqlSyntaxProvider, type);

            string create = SqlSyntaxContext.SqlSyntaxProvider.Format(definition);
            string primaryKey = SqlSyntaxContext.SqlSyntaxProvider.FormatPrimaryKey(definition);
            var indexes = SqlSyntaxContext.SqlSyntaxProvider.Format(definition.Indexes);
            var keys = SqlSyntaxContext.SqlSyntaxProvider.Format(definition.ForeignKeys);

            Debug.Print(create);
            Debug.Print(primaryKey);
            foreach (var sql in keys)
            {
                Debug.Print(sql);
            }

            foreach (var sql in indexes)
            {
                Debug.Print(sql);
            }
        }

        [TearDown]
        public void TearDown()
        {
            SqlSyntaxContext.SqlSyntaxProvider = null;
        }

        [Test]
        public void U4_8017()
        {
            var logger = Mock.Of&lt;ILogger&gt;();
            var migration = new TestMigration(SqlSyntaxContext.SqlSyntaxProvider, logger);
            var context = new MigrationContext(DatabaseProviders.MySql, null, logger);
            migration.Context = context;
            migration.Up();
            var x = context.Expressions;
            Assert.AreEqual(1, x.Count);
            var e = x.First().ToString();

            // SQLCE provider *does* use UniqueIdentifier
            // MySql using GUID...? because InitColumnTypeMap() missing in provider, fixed

            Assert.AreEqual(&quot;ALTER TABLE `cmsPropertyTypeGroup` ADD COLUMN `uniqueID` char(36) NOT NULL&quot;, e);
        }

        [Migration(&quot;1.0.0&quot;, 0, &quot;Test&quot;)]
        private class TestMigration : MigrationBase
        {
            public TestMigration(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
            {}

            public override void Up()
            {
                Create.Column(&quot;uniqueID&quot;).OnTable(&quot;cmsPropertyTypeGroup&quot;).AsGuid().NotNullable().WithDefault(SystemMethods.NewGuid);
            }

            public override void Down()
            {
                throw new NotImplementedException();
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,94,1],[24,9,24,10,1],[29,9,29,10,0],[30,13,30,51,0],[31,13,31,109,0],[33,13,33,83,0],[34,13,34,97,0],[35,13,35,89,0],[36,13,36,90,0],[38,13,38,33,0],[39,13,39,37,0],[40,13,40,20,0],[40,22,40,29,0],[40,30,40,32,0],[40,33,40,37,0],[41,13,41,14,0],[42,17,42,34,0],[43,13,43,14,0],[45,13,45,20,0],[45,22,45,29,0],[45,30,45,32,0],[45,33,45,40,0],[46,13,46,14,0],[47,17,47,34,0],[48,13,48,14,0],[49,9,49,10,0],[53,9,53,10,1],[54,13,54,55,1],[55,9,55,10,1],[59,9,59,10,1],[60,13,60,45,1],[61,13,61,91,1],[62,13,62,87,1],[63,13,63,41,1],[64,13,64,28,1],[65,13,65,41,1],[66,13,66,41,1],[67,13,67,42,1],[72,13,72,110,1],[73,9,73,10,1],[78,82,78,105,1],[79,13,79,14,1],[79,14,79,15,1],[82,13,82,14,1],[83,17,83,133,1],[84,13,84,14,1],[87,13,87,14,0],[88,17,88,53,0]]);
    </script>
  </body>
</html>