<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\UmbracoExamine\TestContentService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;
using System.Xml.Linq;
using System.Xml.XPath;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Repositories;
using UmbracoExamine;
using UmbracoExamine.DataServices;

namespace Umbraco.Tests.UmbracoExamine
{
    /// &lt;summary&gt;
	/// A mock data service used to return content from the XML data file created with CWS
	/// &lt;/summary&gt;
	public class TestContentService : IContentService
	{
		public const int ProtectedNode = 1142;

		public TestContentService(string contentXml = null, string mediaXml = null)
		{
            if (contentXml == null)
            {
                contentXml = TestFiles.umbraco;
            }
            if (mediaXml == null)
            {
                mediaXml = TestFiles.media;
            }
            _xContent = XDocument.Parse(contentXml);
		    _xMedia = XDocument.Parse(mediaXml);
		}

		#region IContentService Members

		/// &lt;summary&gt;
		/// Return the XDocument containing the xml from the umbraco.config xml file
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;xpath&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		/// &lt;remarks&gt;
		/// This is no different in the test suite as published content
		/// &lt;/remarks&gt;
		public XDocument GetLatestContentByXPath(string xpath)
		{
			var xdoc = XDocument.Parse(&quot;&lt;content&gt;&lt;/content&gt;&quot;);
			xdoc.Root.Add(_xContent.XPathSelectElements(xpath));

			return xdoc;
		}

		/// &lt;summary&gt;
		/// Return the XDocument containing the xml from the umbraco.config xml file
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;xpath&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public XDocument GetPublishedContentByXPath(string xpath)
		{
		    return GetContentByXPath(xpath, _xContent);			
		}

        private XDocument GetContentByXPath(string xpath, XDocument content)
        {
            var xdoc = XDocument.Parse(&quot;&lt;content&gt;&lt;/content&gt;&quot;);
            xdoc.Root.Add(content.XPathSelectElements(xpath));

            return xdoc;
        }

		public string StripHtml(string value)
		{
			const string pattern = @&quot;&lt;(.|\n)*?&gt;&quot;;
			return Regex.Replace(value, pattern, string.Empty);
		}

		public bool IsProtected(int nodeId, string path)
		{
			// single node is marked as protected for test indexer
			// hierarchy is not important for this test
			return nodeId == ProtectedNode;
		}

        private List&lt;string&gt; _userPropNames; 
		public IEnumerable&lt;string&gt; GetAllUserPropertyNames()
		{
            if (_userPropNames == null)
            {
                var xpath = &quot;//*[count(@id)&gt;0 and @id != -1]&quot;;
                _userPropNames = GetPublishedContentByXPath(xpath)
                    .Root
                    .Elements() //each page
                    .SelectMany(x =&gt; x.Elements().Where(e =&gt; e.Attribute(&quot;id&quot;) == null)) //each page property (no @id)         
                    .Select(x =&gt; x.Name.LocalName) //the name of the property
                    .Distinct()
                    .Union(GetContentByXPath(xpath, _xMedia)
                               .Root
                               .Elements() //each page
                               .SelectMany(x =&gt; x.Elements().Where(e =&gt; e.Attribute(&quot;id&quot;) == null)) //each page property (no @id)         
                               .Select(x =&gt; (string)x.Attribute(&quot;alias&quot;)) //the name of the property NOTE: We are using the legacy XML here.
                               .Distinct()).ToList();
            }
		    return _userPropNames;
		}

        private List&lt;string&gt; _sysPropNames; 
		public IEnumerable&lt;string&gt; GetAllSystemPropertyNames()
		{
            if (_sysPropNames == null)
            {
                _sysPropNames = UmbracoContentIndexer.IndexFieldPolicies.Select(x =&gt; x.Name).ToList();
            }
		    return _sysPropNames;
		}

		#endregion

		private readonly XDocument _xContent;
        private readonly XDocument _xMedia;






	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,3,20,78,1],[21,3,21,4,1],[22,13,22,36,1],[23,13,23,14,1],[24,17,24,48,1],[25,13,25,14,1],[26,13,26,34,1],[27,13,27,14,1],[28,17,28,44,1],[29,13,29,14,1],[30,13,30,53,1],[31,7,31,43,1],[32,3,32,4,1],[45,3,45,4,1],[46,4,46,54,1],[47,4,47,56,1],[49,4,49,16,1],[50,3,50,4,1],[58,3,58,4,1],[59,7,59,50,1],[60,3,60,4,1],[63,9,63,10,1],[64,13,64,63,1],[65,13,65,63,1],[67,13,67,25,1],[68,9,68,10,1],[71,3,71,4,0],[73,4,73,55,0],[74,3,74,4,0],[77,3,77,4,1],[80,4,80,35,1],[81,3,81,4,1],[85,3,85,4,1],[86,13,86,40,1],[87,13,87,14,1],[88,17,88,63,1],[89,17,92,38,1],[92,38,92,62,1],[92,62,92,87,1],[92,87,92,88,1],[92,38,92,88,1],[92,88,93,34,1],[93,34,93,50,1],[93,50,98,49,1],[98,49,98,73,1],[98,73,98,98,1],[98,98,98,99,1],[98,49,98,99,1],[98,99,99,45,1],[99,45,99,73,1],[99,73,100,54,1],[89,17,100,54,1],[101,13,101,14,1],[102,7,102,29,1],[103,3,103,4,1],[107,3,107,4,1],[108,13,108,39,1],[109,13,109,14,1],[110,17,110,86,1],[110,86,110,92,1],[110,92,110,103,1],[110,17,110,103,1],[111,13,111,14,1],[112,7,112,28,1],[113,3,113,4,1]]);
    </script>
  </body>
</html>