<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\tom pipe\documents\hexadigital\code\umbraco\umbraco-cms\src\umbraco.web.ui\umbraco\developer\macros\editmacro.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.UI.WebControls;
using Umbraco.Core.IO;
using Umbraco.Core;
using Umbraco.Core.Models;

namespace Umbraco.Web.UI.Umbraco.Developer.Macros
{
	public partial class EditMacro : global::umbraco.cms.presentation.developer.editMacro
	{

		protected override void OnLoad(EventArgs e)
		{
			base.OnLoad(e);

			PopulatePartialViewFiles();
		}

		/// &lt;summary&gt;
		/// This ensures that the SelectedPartialView txt box value is set correctly when the m_macro object&#39;s 
		/// ScriptingFile property contains a full virtual path beginning with the MacroPartials path
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;macro&quot;&gt; &lt;/param&gt;
		/// &lt;param name=&quot;macroAssemblyValue&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;macroTypeValue&quot;&gt;&lt;/param&gt;
		protected override void PopulateFieldsOnLoad(IMacro macro, string macroAssemblyValue, string macroTypeValue)
		{
			base.PopulateFieldsOnLoad(macro, macroAssemblyValue, macroTypeValue);
			//check if the ScriptingFile property contains the MacroPartials path
			if (macro.ScriptPath.IsNullOrWhiteSpace() == false &amp;&amp;
                (macro.ScriptPath.StartsWith(SystemDirectories.MvcViews + &quot;/MacroPartials/&quot;)
                || (Regex.IsMatch(macro.ScriptPath, &quot;~/App_Plugins/.+?/Views/MacroPartials&quot;, RegexOptions.Compiled))))
			{
				macroPython.Text = &quot;&quot;;
                SelectedPartialView.Text = macro.ScriptPath;
			}
		}

		/// &lt;summary&gt;
		/// This changes the macro type to a PartialViewMacro if the SelectedPartialView txt box has a value.
		/// This then also updates the file path saved for the partial view to be the full virtual path, not just the file name.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;macro&quot;&gt; &lt;/param&gt;
		/// &lt;param name=&quot;macroCachePeriod&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;macroAssemblyValue&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;macroTypeValue&quot;&gt;&lt;/param&gt;
		protected override void SetMacroValuesFromPostBack(IMacro macro, int macroCachePeriod, string macroAssemblyValue, string macroTypeValue)
		{
			base.SetMacroValuesFromPostBack(macro, macroCachePeriod, macroAssemblyValue, macroTypeValue);
			if (!SelectedPartialView.Text.IsNullOrWhiteSpace())
			{
				macro.ScriptPath = SelectedPartialView.Text;
			}
		}

		/// &lt;summary&gt;
		/// Populate the drop down list for partial view files
		/// &lt;/summary&gt;
		private void PopulatePartialViewFiles()
		{
			var partialsDir = IOHelper.MapPath(SystemDirectories.MvcViews + &quot;/MacroPartials&quot;);
			//get all the partials in the normal /MacroPartials folder
			var foundMacroPartials = GetPartialViewFiles(partialsDir, partialsDir, SystemDirectories.MvcViews + &quot;/MacroPartials&quot;);
			//now try to find all of them int he App_Plugins/[PackageName]/Views/MacroPartials folder
			var appPluginsFolder = new DirectoryInfo(IOHelper.MapPath(SystemDirectories.AppPlugins));
		    if (appPluginsFolder.Exists)
		    {
                foreach (var d in appPluginsFolder.GetDirectories())
                {
                    var viewsFolder = d.GetDirectories(&quot;Views&quot;);
                    if (viewsFolder.Any())
                    {
                        var macroPartials = viewsFolder.First().GetDirectories(&quot;MacroPartials&quot;);
                        if (macroPartials.Any())
                        {
                            foundMacroPartials = foundMacroPartials.Concat(
                                GetPartialViewFiles(macroPartials.First().FullName, macroPartials.First().FullName, SystemDirectories.AppPlugins + &quot;/&quot; + d.Name + &quot;/Views/MacroPartials&quot;));
                        }
                    }
                }    
		    }
			
			
			PartialViewList.DataSource = foundMacroPartials;
			PartialViewList.DataBind();
			PartialViewList.Items.Insert(0, new ListItem(&quot;Browse partial view files on server...&quot;, string.Empty));			
		}

		/// &lt;summary&gt;
		/// Get the list of partial view files in the ~/Views/MacroPartials folder and in all 
		/// folders of ~/App_Plugins/[PackageName]/Views/MacroPartials
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;orgPath&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;prefixVirtualPath&quot;&gt; &lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		private IEnumerable&lt;string&gt; GetPartialViewFiles(string orgPath, string path, string prefixVirtualPath)
		{
			var files = new List&lt;string&gt;();
			var dirInfo = new DirectoryInfo(path);

			// Populate subdirectories
			var dirInfos = dirInfo.GetDirectories();
			foreach (var dir in dirInfos)
			{
				files.AddRange(GetPartialViewFiles(orgPath, path + &quot;/&quot; + dir.Name, prefixVirtualPath));
			}

			var fileInfo = dirInfo.GetFiles(&quot;*.*&quot;);

			files.AddRange(
				fileInfo.Select(file =&gt; 
					prefixVirtualPath.TrimEnd(&#39;/&#39;) + &quot;/&quot; + (path.Replace(orgPath, string.Empty).Trim(&#39;/&#39;) + &quot;/&quot; + file.Name).Trim(&#39;/&#39;)));
			return files;
		}

        /// &lt;summary&gt;
        /// Binds the drop down list but ensures that the macro param type exists if it doesn&#39;t the drop down will be left blank
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
	    protected void MacroPropertiesOnItemDataBound(object sender, RepeaterItemEventArgs e)
	    {
            if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
            {
                var propertyTypes = (DropDownList)e.Item.FindControl(&quot;macroPropertyType&quot;);

                var editors = GetMacroParameterEditors();
                propertyTypes.DataSource = editors;
                propertyTypes.DataBind();
                var macroProp = (IMacroProperty)e.Item.DataItem;
                if (editors.Any(x =&gt; x.Alias == macroProp.EditorAlias))
                {
                    propertyTypes.SelectedValue = macroProp.EditorAlias;
                }    
            }

	    }
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,3,19,4,0],[20,4,20,19,0],[22,4,22,31,0],[23,3,23,4,0],[33,3,33,4,0],[34,4,34,73,0],[36,4,38,119,0],[39,4,39,5,0],[40,5,40,27,0],[41,17,41,61,0],[42,4,42,5,0],[43,3,43,4,0],[54,3,54,4,0],[55,4,55,97,0],[56,4,56,55,0],[57,4,57,5,0],[58,5,58,49,0],[59,4,59,5,0],[60,3,60,4,0],[66,3,66,4,0],[67,4,67,86,0],[69,4,69,122,0],[71,4,71,93,0],[72,7,72,35,0],[73,7,73,8,0],[74,17,74,24,0],[74,26,74,31,0],[74,32,74,34,0],[74,35,74,68,0],[75,17,75,18,0],[76,21,76,65,0],[77,21,77,43,0],[78,21,78,22,0],[79,25,79,97,0],[80,25,80,49,0],[81,25,81,26,0],[82,29,83,188,0],[84,25,84,26,0],[85,21,85,22,0],[86,17,86,18,0],[87,7,87,8,0],[90,4,90,52,0],[91,4,91,31,0],[92,4,92,106,0],[93,3,93,4,0],[104,3,104,4,0],[105,4,105,35,0],[106,4,106,42,0],[109,4,109,44,0],[110,4,110,11,0],[110,13,110,20,0],[110,21,110,23,0],[110,24,110,32,0],[111,4,111,5,0],[112,5,112,92,0],[113,4,113,5,0],[115,4,115,43,0],[117,4,119,6,0],[119,6,119,120,0],[119,120,119,123,0],[117,4,119,123,0],[120,4,120,17,0],[121,3,121,4,0],[129,6,129,7,0],[130,13,130,105,0],[131,13,131,14,0],[132,17,132,91,0],[134,17,134,58,0],[135,17,135,52,0],[136,17,136,42,0],[137,17,137,65,0],[138,17,138,38,0],[138,38,138,70,0],[138,70,138,72,0],[138,17,138,72,0],[139,17,139,18,0],[140,21,140,73,0],[141,17,141,18,0],[142,13,142,14,0],[144,6,144,7,0]]);
    </script>
  </body>
</html>