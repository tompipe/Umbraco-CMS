<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\users\UserPermissions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Xml;
using System.IO;
using System.Collections;
using System.Web.UI.WebControls;
using System.Data.SqlClient;
using System.Data;
using Umbraco.Core;
using Umbraco.Web;
using Umbraco.Web.Security;
using umbraco;
using umbraco.BusinessLogic;
using System.Web;
using umbraco.BusinessLogic.Actions;
using umbraco.DataLayer;
using umbraco.cms.businesslogic;
using umbraco.interfaces;
using umbraco.BasePages;
using umbraco.cms.businesslogic.web;

namespace umbraco.cms.presentation.user
{
    /// &lt;summary&gt;
    /// Provides umbraco user permission functionality on various nodes. Only nodes that are published are queried via the cache.
    /// &lt;/summary&gt;    
    public class UserPermissions
    {
        readonly User _user;

        public UserPermissions(User user)
        {
            _user = user;
        }

        /// &lt;summary&gt;
        /// saves new permissions with the parameters supplied
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeIDs&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;actions&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;replaceChildren&quot;&gt;&lt;/param&gt;
        public void SaveNewPermissions(int[] nodeIDs, List&lt;IAction&gt; actions, bool replaceChildren)
        {
            //ensure permissions that are permission assignable
            var permissions = actions.FindAll(a =&gt; (a.CanBePermissionAssigned));

            //ensure that only the nodes that the user has permissions to update are updated
            var lstNoPermissions = new List&lt;int&gt;();
            foreach (var nodeId in nodeIDs)
            {
                var nodeActions = UmbracoContext.Current.UmbracoUser.GetPermissions(GetNodePath(nodeId));
                var lstActions = BusinessLogic.Actions.Action.FromString(nodeActions);
                if (lstActions == null || !lstActions.Contains(ActionRights.Instance))
                    lstNoPermissions.Add(nodeId);
            }
            //remove the nodes that the user doesn&#39;t have permission to update
            var lstNodeIDs = new List&lt;int&gt;();
            lstNodeIDs.AddRange(nodeIDs);
            foreach (var noPermission in lstNoPermissions)
                lstNodeIDs.Remove(noPermission);
            nodeIDs = lstNodeIDs.ToArray();

            //get the complete list of node ids that this change will affect
            var allNodes = new List&lt;int&gt;();
            if (replaceChildren)
            {
                foreach (var nodeId in nodeIDs)
                {
                    allNodes.Add(nodeId);
                    allNodes.AddRange(FindChildNodes(nodeId));
                }
            }
            else
            {
                allNodes.AddRange(nodeIDs);
            }

            //if permissions are to be assigned, then assign them
            if (permissions.Count &gt; 0)
            {
                ApplicationContext.Current.Services.UserService.ReplaceUserPermissions(
                    _user.Id, permissions.Select(x =&gt; x.Letter), allNodes.ToArray());
            }
            else
            {
                //If there are NO permissions for this node, we need to assign the ActionNull permission otherwise
                //the node will inherit from it&#39;s parent.
                ApplicationContext.Current.Services.UserService.ReplaceUserPermissions(
                    _user.Id, new[] { ActionNull.Instance.Letter }, allNodes.ToArray());
            }            

        }

        /// &lt;summary&gt;
        /// Returns the current user permissions for the node specified
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public List&lt;IAction&gt; GetExistingNodePermission(int nodeId)
        {
            var path = GetNodePath(nodeId);
            if (path != &quot;&quot;)
            {
                //get the user and their permissions
                string permissions = _user.GetPermissions(path);
                return umbraco.BusinessLogic.Actions.Action.FromString(permissions);
            }
            return null;
        }

        /// &lt;summary&gt;
        /// gets path attribute for node id passed
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;iNodeId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static string GetNodePath(int iNodeId)
        {
            if (Document.IsDocument(iNodeId))
            {
                var doc = new Document(iNodeId);
                return doc.Path;
            } 
            
            return &quot;&quot;;
        }

        /// &lt;summary&gt;
        /// Finds all child node IDs
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static IEnumerable&lt;int&gt; FindChildNodes(int nodeId)
        {
            var docs = Document.GetChildrenForTree(nodeId);
            var nodeIds = new List&lt;int&gt;();
            foreach (var doc in docs)
            {
                nodeIds.Add(doc.Id);
                if (doc.HasChildren)
                {
                    nodeIds.AddRange(FindChildNodes(doc.Id));
                }
            }
            return nodeIds;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,42,0],[34,9,34,10,0],[35,13,35,26,0],[36,9,36,10,0],[45,9,45,10,0],[47,13,47,52,0],[47,52,47,79,0],[47,79,47,81,0],[47,13,47,81,0],[50,13,50,52,0],[51,13,51,20,0],[51,22,51,32,0],[51,33,51,35,0],[51,36,51,43,0],[52,13,52,14,0],[53,17,53,106,0],[54,17,54,87,0],[55,17,55,87,0],[56,21,56,50,0],[57,13,57,14,0],[59,13,59,46,0],[60,13,60,42,0],[61,13,61,20,0],[61,22,61,38,0],[61,39,61,41,0],[61,42,61,58,0],[62,17,62,49,0],[63,13,63,44,0],[66,13,66,44,0],[67,13,67,33,0],[68,13,68,14,0],[69,17,69,24,0],[69,26,69,36,0],[69,37,69,39,0],[69,40,69,47,0],[70,17,70,18,0],[71,21,71,42,0],[72,21,72,63,0],[73,17,73,18,0],[74,13,74,14,0],[76,13,76,14,0],[77,17,77,44,0],[78,13,78,14,0],[81,13,81,39,0],[82,13,82,14,0],[83,17,84,55,0],[84,55,84,63,0],[84,63,84,86,0],[83,17,84,86,0],[85,13,85,14,0],[87,13,87,14,0],[90,17,91,89,0],[92,13,92,14,0],[94,9,94,10,0],[102,9,102,10,0],[103,13,103,44,0],[104,13,104,28,0],[105,13,105,14,0],[107,17,107,65,0],[108,17,108,85,0],[110,13,110,25,0],[111,9,111,10,0],[119,9,119,10,0],[120,13,120,46,0],[121,13,121,14,0],[122,17,122,49,0],[123,17,123,33,0],[126,13,126,23,0],[127,9,127,10,0],[135,9,135,10,0],[136,13,136,60,0],[137,13,137,43,0],[138,13,138,20,0],[138,22,138,29,0],[138,30,138,32,0],[138,33,138,37,0],[139,13,139,14,0],[140,17,140,37,0],[141,17,141,37,0],[142,17,142,18,0],[143,21,143,62,0],[144,17,144,18,0],[145,13,145,14,0],[146,13,146,28,0],[147,9,147,10,0]]);
    </script>
  </body>
</html>