<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\PackagesTreeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Net;
using System.Net.Http.Formatting;
using System.Web.Http;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Web.Models.Trees;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi.Filters;
using umbraco;
using umbraco.BusinessLogic.Actions;
using umbraco.cms.businesslogic.packager;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Services;
using Constants = Umbraco.Core.Constants;
using Umbraco.Core.Services;

namespace Umbraco.Web.Trees
{
    [UmbracoTreeAuthorize(Constants.Trees.Packages)]
    [Tree(Constants.Applications.Developer, Constants.Trees.Packages, null, sortOrder: 0)]
    [PluginController(&quot;UmbracoTrees&quot;)]
    [CoreTree]
    [LegacyBaseTree(typeof(loadPackager))]
    public class PackagesTreeController : TreeController
    {
        /// &lt;summary&gt;
        /// Helper method to create a root model for a tree
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected override TreeNode CreateRootNode(FormDataCollection queryStrings)
        {
            var root = base.CreateRootNode(queryStrings);

            //this will load in a custom UI instead of the dashboard for the root node
            root.RoutePath = string.Format(&quot;{0}/{1}/{2}&quot;, Constants.Applications.Developer, Constants.Trees.Packages, &quot;overview&quot;);
            root.Icon = &quot;icon-box&quot;;

            return root;
        }

        protected override TreeNodeCollection GetTreeNodes(string id, FormDataCollection queryStrings)
        {
            var baseUrl = Constants.Applications.Developer + &quot;/packages/&quot;;

            var nodes = new TreeNodeCollection();

            var createdPackages = CreatedPackage.GetAllCreatedPackages();
            
            if (id == &quot;created&quot;)
            {
                nodes.AddRange(
                    createdPackages
                        .OrderBy(entity =&gt; entity.Data.Name)
                        .Select(dt =&gt;
                        {
                            var node = CreateTreeNode(dt.Data.Id.ToString(), id, queryStrings, dt.Data.Name, &quot;icon-inbox&quot;, false,
                                string.Format(&quot;/{0}/framed/{1}&quot;,
                                    queryStrings.GetValue&lt;string&gt;(&quot;application&quot;),
                                    Uri.EscapeDataString(&quot;developer/Packages/EditPackage.aspx?id=&quot; + dt.Data.Id)));                            
                            return node;
                        }));
            }
            else
            {
                //must be root
                var node = CreateTreeNode(
                    &quot;created&quot;,
                    id,
                    queryStrings,
                    Services.TextService.Localize(&quot;treeHeaders/createdPackages&quot;),
                    &quot;icon-folder&quot;,
                    createdPackages.Count &gt; 0,
                    string.Empty);

                

                //TODO: This isn&#39;t the best way to ensure a noop process for clicking a node but it works for now.
                node.AdditionalData[&quot;jsClickCallback&quot;] = &quot;javascript:void(0);&quot;;

                nodes.Add(node);
            }

            

            return nodes;
        }

        protected override MenuItemCollection GetMenuForNode(string id, FormDataCollection queryStrings)
        {
            var menu = new MenuItemCollection();

            // Root actions
            if (id == &quot;-1&quot;)
            {
                menu.Items.Add&lt;ActionNew&gt;(Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionNew.Instance.Alias)))
                    .ConvertLegacyMenuItem(null, Constants.Trees.Packages, queryStrings.GetValue&lt;string&gt;(&quot;application&quot;));
            }
            else if (id == &quot;created&quot;)
            {
                menu.Items.Add&lt;ActionNew&gt;(Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionNew.Instance.Alias)))
                    .ConvertLegacyMenuItem(null, Constants.Trees.Packages, queryStrings.GetValue&lt;string&gt;(&quot;application&quot;));

                menu.Items.Add&lt;RefreshNode, ActionRefresh&gt;(
                    Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionRefresh.Instance.Alias)), true);
            }
            else
            {
                //it&#39;s a package node
                menu.Items.Add&lt;ActionDelete&gt;(ui.Text(&quot;actions&quot;, ActionDelete.Instance.Alias));
            }

            return menu;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[35,9,35,10,0],[36,13,36,58,0],[39,13,39,131,0],[40,13,40,36,0],[42,13,42,25,0],[43,9,43,10,0],[46,9,46,10,0],[47,13,47,75,0],[49,13,49,50,0],[51,13,51,74,0],[53,13,53,33,0],[54,13,54,14,0],[55,17,57,44,0],[57,44,57,60,0],[57,60,59,25,0],[59,25,59,26,0],[59,26,60,29,0],[60,29,63,116,0],[63,116,64,29,0],[64,29,64,41,0],[64,41,65,25,0],[65,25,65,26,0],[65,26,65,29,0],[55,17,65,29,0],[66,13,66,14,0],[68,13,68,14,0],[70,17,77,35,0],[82,17,82,80,0],[84,17,84,33,0],[85,13,85,14,0],[89,13,89,26,0],[90,9,90,10,0],[93,9,93,10,0],[94,13,94,49,0],[97,13,97,28,0],[98,13,98,14,0],[99,17,100,122,0],[101,13,101,14,0],[102,18,102,38,0],[103,13,103,14,0],[104,17,105,122,0],[107,17,108,118,0],[109,13,109,14,0],[111,13,111,14,0],[113,17,113,95,0],[114,13,114,14,0],[116,13,116,25,0],[117,9,117,10,0]]);
    </script>
  </body>
</html>