<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\cruds.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Collections.Generic;
using Umbraco.Core;
using Umbraco.Web;
using umbraco.cms.businesslogic;

namespace umbraco.dialogs
{
    /// &lt;summary&gt;
    /// Summary description for cruds.
    /// &lt;/summary&gt;
    public partial class cruds : BasePages.UmbracoEnsuredPage
    {

        public cruds()
        {
            CurrentApp = BusinessLogic.DefaultApps.content.ToString();

        }

        private readonly Dictionary&lt;string, HtmlTableRow&gt; _permissions = new Dictionary&lt;string, HtmlTableRow&gt;();
        private CMSNode _node;
        
        protected void Page_Load(object sender, EventArgs e)
        {
            Button1.Text = ui.Text(&quot;update&quot;);
            pane_form.Text = ui.Text(&quot;actions&quot;, &quot;SetPermissionsForThePage&quot;,_node.Text); 
        }

        override protected void OnInit(EventArgs e)
        {
            base.OnInit(e);

            _node = new CMSNode(Request.GetItemAs&lt;int&gt;(&quot;id&quot;));

            var ht = new HtmlTable();
            ht.Attributes.Add(&quot;class&quot;, &quot;table&quot;);

            var names = new HtmlTableRow();

            var corner = new HtmlTableCell(&quot;th&quot;);
            corner.Style.Add(&quot;border&quot;, &quot;none&quot;);
            names.Cells.Add(corner);
            
            foreach (var a in ActionsResolver.Current.Actions)
            {
                if (a.CanBePermissionAssigned == false) continue;

                var permissionRow = new HtmlTableRow();
                var label = new HtmlTableCell
                    {
                        InnerText = ui.Text(&quot;actions&quot;, a.Alias)
                    };
                permissionRow.Cells.Add(label);
                _permissions.Add(a.Alias, permissionRow);
            }

            ht.Rows.Add(names);
            
            foreach (var u in BusinessLogic.User.getAll())
            {
                // Not disabled users and not system account
                if (u.Disabled == false &amp;&amp; u.Id &gt; 0)
                {
                    var hc = new HtmlTableCell(&quot;th&quot;)
                        {
                            InnerText = u.Name
                        };
                    hc.Style.Add(&quot;text-align&quot;, &quot;center&quot;);
                    hc.Style.Add(&quot;border&quot;, &quot;none&quot;);
                    names.Cells.Add(hc);

                    foreach (var a in ActionsResolver.Current.Actions)
                    {
                        var chk = new CheckBox
                            {
                                //Each checkbox is named with the user _ permission alias so we can parse
                                ID = u.Id + &quot;_&quot; + a.Letter                                
                            };

                        if (a.CanBePermissionAssigned == false) continue;

                        if (u.GetPermissions(_node.Path).IndexOf(a.Letter) &gt; -1)
                        {
                            chk.Checked = true;
                        }

                        var cell = new HtmlTableCell();
                        cell.Style.Add(&quot;text-align&quot;, &quot;center&quot;);
                        cell.Controls.Add(chk);

                        _permissions[a.Alias].Cells.Add(cell);
                    }
                }
            }

            //add all collected rows
            foreach (var perm in _permissions.Values)
            {
                ht.Rows.Add(perm);    
            }

            PlaceHolder1.Controls.Add(ht);
        }


        protected void Button1_Click(object sender, EventArgs e)
        {
            //get non disabled, non admin users and project to a dictionary, 
            // the string (value) portion will store the array of chars = their permissions
            var usersPermissions = BusinessLogic.User.getAll()
                                                .Where(user =&gt; user.Disabled == false &amp;&amp; user.Id &gt; 0)
                                                .ToDictionary(user =&gt; user, user =&gt; &quot;&quot;);
            
            //iterate over each row which equals:
            // * a certain permission and the user&#39;s who will be allowed/denied that permission
            foreach (var row in _permissions)
            {
                //iterate each cell that is not the first cell (which is the permission header cell)
                for (var i = 1; i &lt; row.Value.Cells.Count; i++)
                {
                    var currCell = row.Value.Cells[i];
                    //there&#39;s only one control per cell = the check box
                    var chk = (CheckBox)currCell.Controls[0];
                    //if it&#39;s checked then append the permissions
                    if (chk.Checked)
                    {
                        //now we will parse the checkbox ID which is the userId_permissionAlias
                        var split = chk.ID.Split(new[] { &#39;_&#39; }, StringSplitOptions.RemoveEmptyEntries);
                        //get the reference to the user
                        var user = usersPermissions.Keys.Single(x =&gt; x.Id == int.Parse(split[0]));
                        //get the char permission
                        var permAlias = split[1];
                        //now append that char permission to the user
                        usersPermissions[user] += permAlias;    
                    }
                }
            }
            
            // Loop through the users and update their permissions
            foreach (var user in usersPermissions)
            {
                //default to &quot;-&quot; for whatever reason (was here before so we&#39;ll leave it)
                var cruds = &quot;-&quot;;
                if (user.Value.IsNullOrWhiteSpace() == false)
                {
                    cruds = user.Value;
                }
                BusinessLogic.Permission.UpdateCruds(user.Key, _node, cruds);       
            }

            // Update feedback message
            //FeedBackMessage.Text = &quot;&lt;div class=\&quot;feedbackCreate\&quot;&gt;&quot; + ui.Text(&quot;rights&quot;) + &quot; &quot; + ui.Text(&quot;ok&quot;) + &quot;&lt;/div&gt;&quot;;
            feedback1.type = uicontrols.Feedback.feedbacktype.success;
            feedback1.Text = ui.Text(&quot;rights&quot;) + &quot; &quot; + ui.Text(&quot;ok&quot;);
            PlaceHolder1.Visible = false;
            panel_buttons.Visible = false;


        }

        /// &lt;summary&gt;
        /// pane_form control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.Pane pane_form;

        /// &lt;summary&gt;
        /// feedback1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.Feedback feedback1;

        /// &lt;summary&gt;
        /// PlaceHolder1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.PlaceHolder PlaceHolder1;

        /// &lt;summary&gt;
        /// panel_buttons control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.HtmlControls.HtmlGenericControl panel_buttons;

        /// &lt;summary&gt;
        /// Button1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Button Button1;

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,23,0],[26,9,26,10,0],[27,13,27,71,0],[29,9,29,10,0],[31,9,31,113,0],[35,9,35,10,0],[36,13,36,46,0],[37,13,37,88,0],[38,9,38,10,0],[41,9,41,10,0],[42,13,42,28,0],[44,13,44,63,0],[46,13,46,38,0],[47,13,47,49,0],[49,13,49,44,0],[51,13,51,50,0],[52,13,52,48,0],[53,13,53,37,0],[55,13,55,20,0],[55,22,55,27,0],[55,28,55,30,0],[55,31,55,62,0],[56,13,56,14,0],[57,17,57,56,0],[57,57,57,66,0],[59,17,59,56,0],[60,17,63,23,0],[64,17,64,48,0],[65,17,65,58,0],[66,13,66,14,0],[68,13,68,32,0],[70,13,70,20,0],[70,22,70,27,0],[70,28,70,30,0],[70,31,70,58,0],[71,13,71,14,0],[73,17,73,53,0],[74,17,74,18,0],[75,21,78,27,0],[79,21,79,58,0],[80,21,80,52,0],[81,21,81,41,0],[83,21,83,28,0],[83,30,83,35,0],[83,36,83,38,0],[83,39,83,70,0],[84,21,84,22,0],[85,25,89,31,0],[91,25,91,64,0],[91,65,91,74,0],[93,25,93,81,0],[94,25,94,26,0],[95,29,95,48,0],[96,25,96,26,0],[98,25,98,56,0],[99,25,99,64,0],[100,25,100,48,0],[102,25,102,63,0],[103,21,103,22,0],[104,17,104,18,0],[105,13,105,14,0],[108,13,108,20,0],[108,22,108,30,0],[108,31,108,33,0],[108,34,108,53,0],[109,13,109,14,0],[110,17,110,35,0],[111,13,111,14,0],[113,13,113,43,0],[114,9,114,10,0],[118,9,118,10,0],[121,13,122,64,0],[122,64,122,101,0],[122,101,123,71,0],[123,71,123,75,0],[123,75,123,85,0],[123,85,123,87,0],[123,87,123,89,0],[121,13,123,89,0],[127,13,127,20,0],[127,22,127,29,0],[127,30,127,32,0],[127,33,127,45,0],[128,13,128,14,0],[130,22,130,31,0],[130,33,130,58,0],[130,60,130,63,0],[131,17,131,18,0],[132,21,132,55,0],[134,21,134,62,0],[136,21,136,37,0],[137,21,137,22,0],[139,25,139,104,0],[141,25,141,70,0],[141,70,141,97,0],[141,97,141,99,0],[141,25,141,99,0],[143,25,143,50,0],[145,25,145,61,0],[146,21,146,22,0],[147,17,147,18,0],[148,13,148,14,0],[151,13,151,20,0],[151,22,151,30,0],[151,31,151,33,0],[151,34,151,50,0],[152,13,152,14,0],[154,17,154,33,0],[155,17,155,62,0],[156,17,156,18,0],[157,21,157,40,0],[158,17,158,18,0],[159,17,159,78,0],[160,13,160,14,0],[164,13,164,71,0],[165,13,165,70,0],[166,13,166,42,0],[167,13,167,43,0],[170,9,170,10,0]]);
    </script>
  </body>
</html>