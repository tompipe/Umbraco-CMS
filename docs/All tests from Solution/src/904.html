<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Security\WebAuthExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Net.Http;
using System.Security.Claims;
using System.Security.Principal;
using System.ServiceModel.Channels;
using System.Threading;
using System.Web;
using AutoMapper;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Security;
using Umbraco.Web.WebApi;

namespace Umbraco.Web.Security
{
    internal static class WebAuthExtensions
    {
        /// &lt;summary&gt;
        /// This will set a an authenticated IPrincipal to the current request given the IUser object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;request&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;user&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal static IPrincipal SetPrincipalForRequest(this HttpRequestMessage request, IUser user)
        {
            var principal = new ClaimsPrincipal(
                new UmbracoBackOfficeIdentity(
                    new ClaimsIdentity(),
                    Mapper.Map&lt;UserData&gt;(user)));

            //It is actually not good enough to set this on the current app Context and the thread, it also needs
            // to be set explicitly on the HttpContext.Current !! This is a strange web api thing that is actually 
            // an underlying fault of asp.net not propogating the User correctly.
            if (HttpContext.Current != null)
            {
                HttpContext.Current.User = principal;
            }
            var http = request.TryGetHttpContext();
            if (http)
            {
                http.Result.User = principal;
            }
            Thread.CurrentPrincipal = principal;

            //For WebAPI
            request.SetUserPrincipal(principal);

            return principal;
        }

        /// &lt;summary&gt;
        /// This will set a an authenticated IPrincipal to the current request given the IUser object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;httpContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;userData&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal static IPrincipal SetPrincipalForRequest(this HttpContextBase httpContext, UserData userData)
        {
            var principal = new ClaimsPrincipal(
                new UmbracoBackOfficeIdentity(
                    new ClaimsIdentity(),
                    userData));

            //It is actually not good enough to set this on the current app Context and the thread, it also needs
            // to be set explicitly on the HttpContext.Current !! This is a strange web api thing that is actually 
            // an underlying fault of asp.net not propogating the User correctly.
            if (HttpContext.Current != null)
            {
                HttpContext.Current.User = principal;
            }
            httpContext.User = principal;
            Thread.CurrentPrincipal = principal;
            return principal;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,0],[24,13,27,50,0],[32,13,32,45,0],[33,13,33,14,0],[34,17,34,54,0],[35,13,35,14,0],[36,13,36,52,0],[37,13,37,22,0],[38,13,38,14,0],[39,17,39,46,0],[40,13,40,14,0],[41,13,41,49,0],[44,13,44,49,0],[46,13,46,30,0],[47,9,47,10,0],[56,9,56,10,0],[57,13,60,32,0],[65,13,65,45,0],[66,13,66,14,0],[67,17,67,54,0],[68,13,68,14,0],[69,13,69,42,0],[70,13,70,49,0],[71,13,71,30,0],[72,9,72,10,0]]);
    </script>
  </body>
</html>