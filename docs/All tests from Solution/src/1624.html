<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\PropertyEditors\ValueConverters\MultipleTextStringValueConverter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Xml;
using System.Xml.Linq;
using Umbraco.Core.Models.PublishedContent;

namespace Umbraco.Core.PropertyEditors.ValueConverters
{
    [PropertyValueType(typeof(IEnumerable&lt;string&gt;))]
    [PropertyValueCache(PropertyCacheValue.All, PropertyCacheLevel.Content)]
    public class MultipleTextStringValueConverter : PropertyValueConverterBase
    {
        public override bool IsConverter(PublishedPropertyType propertyType)
        {
            return Constants.PropertyEditors.MultipleTextstringAlias.Equals(propertyType.PropertyEditorAlias);
        }

        public override object ConvertDataToSource(PublishedPropertyType propertyType, object source, bool preview)
        {
            // data is (both in database and xml):
            // &lt;keyFeatureList&gt;
            //    &lt;values&gt;
            //        &lt;value&gt;Strong&lt;/value&gt;
            //        &lt;value&gt;Flexible&lt;/value&gt;
            //        &lt;value&gt;Efficient&lt;/value&gt;
            //    &lt;/values&gt;
            // &lt;/keyFeatureList&gt;

            var sourceString = source != null ? source.ToString() : null;
            if (string.IsNullOrWhiteSpace(sourceString)) return Enumerable.Empty&lt;string&gt;();

            //SD: I have no idea why this logic is here, I&#39;m pretty sure we&#39;ve never saved the multiple txt string
            // as xml in the database, it&#39;s always been new line delimited. Will ask Stephen about this.
            // In the meantime, we&#39;ll do this xml check, see if it parses and if not just continue with 
            // splitting by newline
            //
            //   RS: SD/Stephan Please consider post before deciding to remove 
            //// https://our.umbraco.org/forum/contributing-to-umbraco-cms/76989-keep-the-xml-values-in-the-multipletextstringvalueconverter
            var values = new List&lt;string&gt;();
            var pos = sourceString.IndexOf(&quot;&lt;value&gt;&quot;, StringComparison.Ordinal);
            while (pos &gt;= 0)
            {
                pos += &quot;&lt;value&gt;&quot;.Length;
                var npos = sourceString.IndexOf(&quot;&lt;&quot;, pos, StringComparison.Ordinal);
                var value = sourceString.Substring(pos, npos - pos);
                values.Add(value);
                pos = sourceString.IndexOf(&quot;&lt;value&gt;&quot;, pos, StringComparison.Ordinal);
            }
            
            // Fall back on normal behaviour
            if (values.Any() == false)
            {
                return sourceString.Split(Environment.NewLine.ToCharArray());
            }

            return values.ToArray();
        }

        public override object ConvertSourceToXPath(PublishedPropertyType propertyType, object source, bool preview)
        {
            var d = new XmlDocument();
            var e = d.CreateElement(&quot;values&quot;);
            d.AppendChild(e);

            var values = (IEnumerable&lt;string&gt;) source;
            foreach (var value in values)
            {
                var ee = d.CreateElement(&quot;value&quot;);
                ee.InnerText = value;
                e.AppendChild(ee);
            }

            return d.CreateNavigator();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,0],[17,13,17,111,0],[18,9,18,10,0],[21,9,21,10,0],[31,13,31,74,0],[32,13,32,57,0],[32,58,32,92,0],[41,13,41,45,0],[42,13,42,81,0],[43,13,43,29,0],[44,13,44,14,0],[45,17,45,41,0],[46,17,46,85,0],[47,17,47,69,0],[48,17,48,35,0],[49,17,49,86,0],[50,13,50,14,0],[53,13,53,39,0],[54,13,54,14,0],[55,17,55,78,0],[58,13,58,37,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,39,0],[64,13,64,47,0],[65,13,65,30,0],[67,13,67,55,0],[68,13,68,20,0],[68,22,68,31,0],[68,32,68,34,0],[68,35,68,41,0],[69,13,69,14,0],[70,17,70,51,0],[71,17,71,38,0],[72,17,72,35,0],[73,13,73,14,0],[75,13,75,40,0],[76,9,76,10,0]]);
    </script>
  </body>
</html>