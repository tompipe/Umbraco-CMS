<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\UmbracoExamine\SearchTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using Examine;
using Examine.LuceneEngine.Providers;
using Lucene.Net.Store;
using NUnit.Framework;
using Examine.LuceneEngine.SearchCriteria;
using Lucene.Net.Analysis.Standard;
using Lucene.Net.Index;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.UmbracoExamine
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class SearchTests : ExamineBaseTest
    {

        [Test]
        public void Test_Sort_Order_Sorting()
        {
            using (var luceneDir = new RandomIdRAMDirectory())
            using (var writer = new IndexWriter(luceneDir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29), IndexWriter.MaxFieldLength.LIMITED))
            using (var indexer = IndexInitializer.GetUmbracoIndexer(writer, null,
                    new TestDataService()
                    {
                        ContentService = new TestContentService(TestFiles.umbraco_sort)
                    },
                    supportUnpublishedContent: true))
            using (var searcher = IndexInitializer.GetUmbracoSearcher(writer))
            {                
                indexer.RebuildIndex();                

                var s = (LuceneSearcher)searcher;
                var luceneSearcher = s.GetSearcher();
                var i = (LuceneIndexer)indexer;

                var numberSortedCriteria = searcher.CreateSearchCriteria()
                    .ParentId(1148).And()
                    .OrderBy(new SortableField(&quot;sortOrder&quot;, SortType.Int));
                var numberSortedResult = searcher.Search(numberSortedCriteria.Compile());

                var stringSortedCriteria = searcher.CreateSearchCriteria()
                    .ParentId(1148).And()
                    .OrderBy(&quot;sortOrder&quot;); //will default to string
                var stringSortedResult = searcher.Search(stringSortedCriteria.Compile());

                Assert.AreEqual(12, numberSortedResult.TotalItemCount);
                Assert.AreEqual(12, stringSortedResult.TotalItemCount);

                Assert.IsTrue(IsSortedByNumber(numberSortedResult));
                Assert.IsFalse(IsSortedByNumber(stringSortedResult));
            }
        }

        private bool IsSortedByNumber(IEnumerable&lt;SearchResult&gt; results)
        {
            var currentSort = 0;
            foreach (var searchResult in results)
            {
                var sort = int.Parse(searchResult.Fields[&quot;sortOrder&quot;]);
                if (currentSort &gt;= sort)
                {
                    return false;
                }
                currentSort = sort;
            }
            return true;
        }        

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,1],[25,20,25,62,1],[26,20,26,152,1],[27,20,32,53,1],[33,20,33,78,1],[34,13,34,14,1],[35,17,35,40,1],[37,17,37,50,1],[38,17,38,54,1],[39,17,39,48,1],[41,17,43,76,1],[44,17,44,90,1],[46,17,48,43,1],[49,17,49,90,1],[51,17,51,72,1],[52,17,52,72,1],[54,17,54,69,1],[55,17,55,70,1],[56,13,56,14,1],[57,9,57,10,1],[60,9,60,10,1],[61,13,61,33,1],[62,13,62,20,1],[62,22,62,38,1],[62,39,62,41,1],[62,42,62,49,1],[63,13,63,14,1],[64,17,64,72,1],[65,17,65,41,1],[66,17,66,18,1],[67,21,67,34,1],[69,17,69,36,1],[70,13,70,14,1],[71,13,71,25,1],[72,9,72,10,1]]);
    </script>
  </body>
</html>