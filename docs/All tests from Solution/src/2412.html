<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\propertytype\PropertyTypeGroup.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using umbraco.BusinessLogic;
using umbraco.DataLayer;

namespace umbraco.cms.businesslogic.propertytype
{
    public class PropertyTypeGroup
    {
        public int Id { get; set; }
        public int ContentTypeId { get; set; }
        public string Name { get; set; }
        public int SortOrder { get; set; }

        public PropertyTypeGroup()
        {
        }

        public PropertyTypeGroup(int contentTypeId, string name, int sortOrder)
        {
            ContentTypeId = contentTypeId;
            Name = name;
            SortOrder = sortOrder;
        }

        public PropertyTypeGroup(int contentTypeId, string name)
        {
            ContentTypeId = contentTypeId;
            Name = name;
            SortOrder = -1; // we set this to -1 so in the save method we can get the current highest sortorder in case it&#39;s not sat after init (ie. if you want to force a sortOrder)
        }

        public IEnumerable&lt;PropertyType&gt; GetPropertyTypes(List&lt;int&gt; contentTypeIds)
        {
            return PropertyType.GetPropertyTypesByGroup(Id, contentTypeIds);
        }

        public IEnumerable&lt;PropertyType&gt; GetPropertyTypes()
        {
            return PropertyType.GetPropertyTypesByGroup(Id);
        }

        // note: this is used to delete all groups that inherit from a group, when the group is deleted,
        // see the Delete method in this class - but it is all done in an obsolete way which does not
        // take compositions in account + we delete the group but do not re-allocate the properties, etc.
        // ALL THIS should be either removed, or refactored to use the new APIs - so... returning nothing
        // from now on, which is just another way of being broken.
        public IEnumerable&lt;PropertyTypeGroup&gt; GetPropertyTypeGroups()
        {
            return Enumerable.Empty&lt;PropertyTypeGroup&gt;();
        }

        public void Save()
        {
            if (Id != 0)
            {
                using (var sqlHelper = Application.SqlHelper)
                    sqlHelper.ExecuteNonQuery(
                        @&quot;UPDATE 
                            cmsPropertyTypeGroup 
                        SET 
                            contenttypeNodeId = @contentTypeId,
                            sortOrder = @sortOrder,                        
                            text = @name
                        WHERE
                            id = @id
                    &quot;,
                        sqlHelper.CreateParameter(&quot;@id&quot;, Id),
                        sqlHelper.CreateParameter(&quot;@contentTypeId&quot;, ContentTypeId),
                        sqlHelper.CreateParameter(&quot;@sortOrder&quot;, SortOrder),
                        sqlHelper.CreateParameter(&quot;@name&quot;, Name)
                    );
            }
            else
            {
                if (SortOrder == -1)
                    using (var sqlHelper = Application.SqlHelper)
                        SortOrder = sqlHelper.ExecuteScalar&lt;int&gt;(&quot;select count(*) from cmsPropertyTypeGroup where contenttypeNodeId = @nodeId&quot;,
                        sqlHelper.CreateParameter(&quot;@nodeId&quot;, ContentTypeId)) + 1;

                using (var sqlHelper = Application.SqlHelper)
                    sqlHelper.ExecuteNonQuery(
                        @&quot;
                        INSERT INTO 
                            cmsPropertyTypeGroup
                            (contenttypeNodeId, sortOrder, text)
                        VALUES 
                            (@contentTypeId, @sortOrder, @name)
                    &quot;,
                        sqlHelper.CreateParameter(&quot;@contentTypeId&quot;, ContentTypeId),
                        sqlHelper.CreateParameter(&quot;@sortOrder&quot;, SortOrder),
                        sqlHelper.CreateParameter(&quot;@name&quot;, Name)
                    );

                using (var sqlHelper = Application.SqlHelper)
                    Id = sqlHelper.ExecuteScalar&lt;int&gt;(&quot;SELECT MAX(id) FROM [cmsPropertyTypeGroup]&quot;);

            }
        }

        public void Delete()
        {
            // update all PropertyTypes using this group
            foreach (var pt in GetPropertyTypes())
            {
                pt.PropertyTypeGroup = 0;
                pt.Save();
            }

            foreach (var ptg in GetPropertyTypeGroups())
                ptg.Delete();

            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;DELETE FROM cmsPropertyTypeGroup WHERE id = @id&quot;, sqlHelper.CreateParameter(&quot;@id&quot;, Id));
        }

        internal void Load()
        {
            using (var sqlHelper = Application.SqlHelper)
            using (var dr = sqlHelper.ExecuteReader(@&quot; SELECT contenttypeNodeId, sortOrder, text FROM cmsPropertyTypeGroup WHERE id = @id&quot;, sqlHelper.CreateParameter(&quot;@id&quot;, Id)))
            {
                if (dr.Read())
                {
                    SortOrder = dr.GetInt(&quot;sortOrder&quot;);
                    ContentTypeId = dr.GetInt(&quot;contenttypeNodeId&quot;);
                    Name = dr.GetString(&quot;text&quot;);
                }
            }
        }

        public static PropertyTypeGroup GetPropertyTypeGroup(int id)
        {
            var ptg = new PropertyTypeGroup { Id = id };
            ptg.Load();
            return ptg;
        }

        public static IEnumerable&lt;PropertyTypeGroup&gt; GetPropertyTypeGroupsFromContentType(int contentTypeId)
        {
            var ptgs = new List&lt;PropertyTypeGroup&gt;();
            using (var sqlHelper = Application.SqlHelper)
            using (var dr = sqlHelper.ExecuteReader(@&quot; SELECT id FROM cmsPropertyTypeGroup WHERE contenttypeNodeId = @contentTypeId&quot;, sqlHelper.CreateParameter(&quot;@contentTypeId&quot;, contentTypeId)))
            {
                while (dr.Read())
                {
                    ptgs.Add(GetPropertyTypeGroup(dr.GetInt(&quot;id&quot;)));
                }
            }

            return ptgs;
        }

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        protected static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[11,25,11,29,0],[11,30,11,34,0],[12,36,12,40,0],[12,41,12,45,0],[13,30,13,34,0],[13,35,13,39,0],[14,32,14,36,0],[14,37,14,41,0],[16,9,16,35,0],[17,9,17,10,0],[18,9,18,10,0],[20,9,20,80,0],[21,9,21,10,0],[22,13,22,43,0],[23,13,23,25,0],[24,13,24,35,0],[25,9,25,10,0],[27,9,27,65,0],[28,9,28,10,0],[29,13,29,43,0],[30,13,30,25,0],[31,13,31,28,0],[32,9,32,10,0],[35,9,35,10,0],[36,13,36,77,0],[37,9,37,10,0],[40,9,40,10,0],[41,13,41,61,0],[42,9,42,10,0],[50,9,50,10,0],[51,13,51,58,0],[52,9,52,10,0],[55,9,55,10,0],[56,13,56,25,0],[57,13,57,14,0],[58,24,58,61,0],[59,21,73,23,0],[74,13,74,14,0],[76,13,76,14,0],[77,17,77,37,0],[78,28,78,65,0],[79,25,80,82,0],[82,24,82,61,0],[83,21,94,23,0],[96,24,96,61,0],[97,21,97,101,0],[99,13,99,14,0],[100,9,100,10,0],[103,9,103,10,0],[105,13,105,20,0],[105,22,105,28,0],[105,29,105,31,0],[105,32,105,50,0],[106,13,106,14,0],[107,17,107,42,0],[108,17,108,27,0],[109,13,109,14,0],[111,13,111,20,0],[111,22,111,29,0],[111,30,111,32,0],[111,33,111,56,0],[112,17,112,30,0],[114,20,114,57,0],[115,17,115,132,0],[116,9,116,10,0],[119,9,119,10,0],[120,20,120,57,0],[121,20,121,178,0],[122,13,122,14,0],[123,17,123,31,0],[124,17,124,18,0],[125,21,125,56,0],[126,21,126,68,0],[127,21,127,49,0],[128,17,128,18,0],[129,13,129,14,0],[130,9,130,10,0],[133,9,133,10,0],[134,13,134,57,0],[135,13,135,24,0],[136,13,136,24,0],[137,9,137,10,0],[140,9,140,10,0],[141,13,141,54,0],[142,20,142,57,0],[143,20,143,194,0],[144,13,144,14,0],[145,17,145,34,0],[146,17,146,18,0],[147,21,147,69,0],[148,17,148,18,0],[149,13,149,14,0],[151,13,151,25,0],[152,9,152,10,0],[160,17,160,18,0],[160,19,160,48,0],[160,49,160,50,0]]);
    </script>
  </body>
</html>