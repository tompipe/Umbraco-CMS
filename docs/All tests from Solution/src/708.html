<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\TagQuery.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using AutoMapper;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Web.Models;

namespace Umbraco.Web
{
    /// &lt;summary&gt;
    /// A class that exposes methods used to query tag data in views
    /// &lt;/summary&gt;
    public class TagQuery : ITagQuery
    {

        //TODO: This class also acts as a wrapper for ITagQuery due to breaking changes, need to fix in
        // version 8: http://issues.umbraco.org/issue/U4-6899
        private readonly ITagQuery _wrappedQuery;

        private readonly ITagService _tagService;
        private readonly ITypedPublishedContentQuery _typedContentQuery;

        [Obsolete(&quot;Use the alternate constructor specifying the contentQuery instead&quot;)]
        public TagQuery(ITagService tagService)
            : this(tagService, new PublishedContentQuery(UmbracoContext.Current.ContentCache, UmbracoContext.Current.MediaCache))
        {
        }

        [Obsolete(&quot;Use the alternate constructor specifying the ITypedPublishedContentQuery instead&quot;)]
        public TagQuery(ITagService tagService, PublishedContentQuery contentQuery)
        {
            if (tagService == null) throw new ArgumentNullException(&quot;tagService&quot;);
            if (contentQuery == null) throw new ArgumentNullException(&quot;contentQuery&quot;);
            _tagService = tagService;
            _typedContentQuery = contentQuery;
        }

        /// &lt;summary&gt;
        /// Constructor for wrapping ITagQuery, see http://issues.umbraco.org/issue/U4-6899
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;wrappedQuery&quot;&gt;&lt;/param&gt;
        internal TagQuery(ITagQuery wrappedQuery)
        {
            if (wrappedQuery == null) throw new ArgumentNullException(&quot;wrappedQuery&quot;);
            _wrappedQuery = wrappedQuery;
        }

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;tagService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;typedContentQuery&quot;&gt;&lt;/param&gt;
        public TagQuery(ITagService tagService, ITypedPublishedContentQuery typedContentQuery)
        {
            if (tagService == null) throw new ArgumentNullException(&quot;tagService&quot;);
            if (typedContentQuery == null) throw new ArgumentNullException(&quot;typedContentQuery&quot;);
            _tagService = tagService;
            _typedContentQuery = typedContentQuery;
        }
        
        /// &lt;summary&gt;
        /// Returns all content that is tagged with the specified tag value and optional tag group
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;tag&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;tagGroup&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;IPublishedContent&gt; GetContentByTag(string tag, string tagGroup = null)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetContentByTag(tag, tagGroup);

            var ids = _tagService.GetTaggedContentByTag(tag, tagGroup)
                .Select(x =&gt; x.EntityId);
            return _typedContentQuery.TypedContent(ids)
                .Where(x =&gt; x != null);
        }

        /// &lt;summary&gt;
        /// Returns all content that has been tagged with any tag in the specified group
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;tagGroup&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;IPublishedContent&gt; GetContentByTagGroup(string tagGroup)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetContentByTagGroup(tagGroup);

            var ids = _tagService.GetTaggedContentByTagGroup(tagGroup)
                .Select(x =&gt; x.EntityId);
            return _typedContentQuery.TypedContent(ids)
                .Where(x =&gt; x != null);
        }

        /// &lt;summary&gt;
        /// Returns all Media that is tagged with the specified tag value and optional tag group
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;tag&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;tagGroup&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;IPublishedContent&gt; GetMediaByTag(string tag, string tagGroup = null)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetMediaByTag(tag, tagGroup);

            var ids = _tagService.GetTaggedMediaByTag(tag, tagGroup)
                .Select(x =&gt; x.EntityId);
            return _typedContentQuery.TypedMedia(ids)
                .Where(x =&gt; x != null);
        }

        /// &lt;summary&gt;
        /// Returns all Media that has been tagged with any tag in the specified group
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;tagGroup&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;IPublishedContent&gt; GetMediaByTagGroup(string tagGroup)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetMediaByTagGroup(tagGroup);

            var ids = _tagService.GetTaggedMediaByTagGroup(tagGroup)
                .Select(x =&gt; x.EntityId);
            return _typedContentQuery.TypedMedia(ids)
                .Where(x =&gt; x != null);
        }

        //TODO: Should prob implement these, requires a bit of work on the member service to do this,
        // also not sure if its necessary ?
        //public IEnumerable&lt;IPublishedContent&gt; GetMembersByTag(string tag, string tagGroup = null)
        //{
        //}

        //public IEnumerable&lt;IPublishedContent&gt; GetMembersByTagGroup(string tagGroup)
        //{
        //}

        /// &lt;summary&gt;
        /// Get every tag stored in the database (with optional group)
        /// &lt;/summary&gt;
        public IEnumerable&lt;TagModel&gt; GetAllTags(string group = null)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetAllTags(group);

            return Mapper.Map&lt;IEnumerable&lt;TagModel&gt;&gt;(_tagService.GetAllTags(group));
        }

        /// &lt;summary&gt;
        /// Get all tags for content items (with optional group)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;group&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;TagModel&gt; GetAllContentTags(string group = null)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetAllContentTags(group);

            return Mapper.Map&lt;IEnumerable&lt;TagModel&gt;&gt;(_tagService.GetAllContentTags(group));
        }

        /// &lt;summary&gt;
        /// Get all tags for media items (with optional group)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;group&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;TagModel&gt; GetAllMediaTags(string group = null)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetAllMediaTags(group);

            return Mapper.Map&lt;IEnumerable&lt;TagModel&gt;&gt;(_tagService.GetAllMediaTags(group));
        }

        /// &lt;summary&gt;
        /// Get all tags for member items (with optional group)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;group&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;TagModel&gt; GetAllMemberTags(string group = null)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetAllMemberTags(group);

            return Mapper.Map&lt;IEnumerable&lt;TagModel&gt;&gt;(_tagService.GetAllMemberTags(group));
        }

        /// &lt;summary&gt;
        /// Returns all tags attached to a property by entity id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;propertyTypeAlias&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;tagGroup&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;TagModel&gt; GetTagsForProperty(int contentId, string propertyTypeAlias, string tagGroup = null)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetTagsForProperty(contentId, propertyTypeAlias, tagGroup);

            return Mapper.Map&lt;IEnumerable&lt;TagModel&gt;&gt;(_tagService.GetTagsForProperty(contentId, propertyTypeAlias, tagGroup));
        }

        /// &lt;summary&gt;
        /// Returns all tags attached to an entity (content, media or member) by entity id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;tagGroup&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;TagModel&gt; GetTagsForEntity(int contentId, string tagGroup = null)
        {
            //TODO: http://issues.umbraco.org/issue/U4-6899
            if (_wrappedQuery != null) return _wrappedQuery.GetTagsForEntity(contentId, tagGroup);

            return Mapper.Map&lt;IEnumerable&lt;TagModel&gt;&gt;(_tagService.GetTagsForEntity(contentId, tagGroup));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,15,26,130,0],[27,9,27,10,0],[28,9,28,10,0],[31,9,31,84,0],[32,9,32,10,0],[33,13,33,36,0],[33,37,33,83,0],[34,13,34,38,0],[34,39,34,87,0],[35,13,35,38,0],[36,13,36,47,0],[37,9,37,10,0],[43,9,43,50,1],[44,9,44,10,1],[45,13,45,38,1],[45,39,45,87,0],[46,13,46,42,1],[47,9,47,10,1],[54,9,54,95,0],[55,9,55,10,0],[56,13,56,36,0],[56,37,56,83,0],[57,13,57,43,0],[57,44,57,97,0],[58,13,58,38,0],[59,13,59,52,0],[60,9,60,10,0],[69,9,69,10,0],[71,13,71,39,0],[71,40,71,92,0],[73,13,74,30,0],[74,30,74,40,0],[74,40,74,42,0],[73,13,74,42,0],[75,13,76,29,0],[76,29,76,38,0],[76,38,76,40,0],[75,13,76,40,0],[77,9,77,10,0],[85,9,85,10,0],[87,13,87,39,0],[87,40,87,92,0],[89,13,90,30,0],[90,30,90,40,0],[90,40,90,42,0],[89,13,90,42,0],[91,13,92,29,0],[92,29,92,38,0],[92,38,92,40,0],[91,13,92,40,0],[93,9,93,10,0],[102,9,102,10,0],[104,13,104,39,0],[104,40,104,90,0],[106,13,107,30,0],[107,30,107,40,0],[107,40,107,42,0],[106,13,107,42,0],[108,13,109,29,0],[109,29,109,38,0],[109,38,109,40,0],[108,13,109,40,0],[110,9,110,10,0],[118,9,118,10,0],[120,13,120,39,0],[120,40,120,90,0],[122,13,123,30,0],[123,30,123,40,0],[123,40,123,42,0],[122,13,123,42,0],[124,13,125,29,0],[125,29,125,38,0],[125,38,125,40,0],[124,13,125,40,0],[126,9,126,10,0],[142,9,142,10,0],[144,13,144,39,0],[144,40,144,79,0],[146,13,146,85,0],[147,9,147,10,0],[155,9,155,10,0],[157,13,157,39,0],[157,40,157,86,0],[159,13,159,92,0],[160,9,160,10,0],[168,9,168,10,0],[170,13,170,39,0],[170,40,170,84,0],[172,13,172,90,0],[173,9,173,10,0],[181,9,181,10,0],[183,13,183,39,0],[183,40,183,85,0],[185,13,185,91,0],[186,9,186,10,0],[196,9,196,10,0],[198,13,198,39,0],[198,40,198,120,0],[200,13,200,126,0],[201,9,201,10,0],[210,9,210,10,0],[212,13,212,39,0],[212,40,212,99,0],[214,13,214,105,0],[215,9,215,10,0]]);
    </script>
  </body>
</html>