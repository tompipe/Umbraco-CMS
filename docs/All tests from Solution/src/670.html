<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\settings\editTemplate.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using umbraco.BasePages;
using umbraco.BusinessLogic;

using umbraco.cms.businesslogic.template;
using umbraco.cms.presentation.Trees;
using umbraco.DataLayer;
using umbraco.uicontrols;
using System.Linq;

namespace umbraco.cms.presentation.settings
{
	/// &lt;summary&gt;
	/// Summary description for editTemplate.
	/// &lt;/summary&gt;
	public partial class editTemplate : UmbracoEnsuredPage
	{
		private Template _template;
        public MenuButton SaveButton;

		public editTemplate()
		{
			CurrentApp = DefaultApps.settings.ToString();
		}

		protected override void OnPreRender(EventArgs e)
		{
			base.OnPreRender(e);

			ScriptManager.GetCurrent(Page).Services.Add(
				new ServiceReference(IOHelper.ResolveUrl(SystemDirectories.WebServices + &quot;/codeEditorSave.asmx&quot;)));
			ScriptManager.GetCurrent(Page).Services.Add(
                new ServiceReference(IOHelper.ResolveUrl(SystemDirectories.WebServices + &quot;/legacyAjaxCalls.asmx&quot;)));
		}

        protected string TemplateTreeSyncPath { get; private set; }

		protected void Page_Load(object sender, EventArgs e)
		{
			MasterTemplate.Attributes.Add(&quot;onchange&quot;, &quot;changeMasterPageFile()&quot;);
		    TemplateTreeSyncPath = &quot;-1,init,&quot; + _template.Path.Replace(&quot;-1,&quot;, &quot;&quot;);

			if (!IsPostBack)
			{
				MasterTemplate.Items.Add(new ListItem(ui.Text(&quot;none&quot;), &quot;0&quot;));
				foreach (Template t in Template.GetAllAsList())
				{
					if (t.Id != _template.Id)
					{
						var li = new ListItem(t.Text, t.Id.ToString());
						li.Attributes.Add(&quot;id&quot;, t.Alias.Replace(&quot; &quot;, &quot;&quot;));
						MasterTemplate.Items.Add(li);
					}
				}

				NameTxt.Text = _template.GetRawText();
				AliasTxt.Text = _template.Alias;
				editorSource.Text = _template.Design;

				try
				{
					if (_template.MasterTemplate &gt; 0)
						MasterTemplate.SelectedValue = _template.MasterTemplate.ToString();
				}
				catch (Exception ex)
				{
				}

				ClientTools
                    .SetActiveTreeType(Constants.Trees.Templates)
                    .SyncTree(TemplateTreeSyncPath, false);

				LoadScriptingTemplates();
				LoadMacros();
			}
		}

		protected override void OnInit(EventArgs e)
		{
			_template = new Template(int.Parse(Request.QueryString[&quot;templateID&quot;]));
			//
			// CODEGEN: This call is required by the ASP.NET Web Form Designer.
			//
			InitializeComponent();
			base.OnInit(e);
			Panel1.hasMenu = true;

		    var editor = Panel1.NewTabPage(ui.Text(&quot;template&quot;));
            editor.Controls.Add(Pane8);

            var props = Panel1.NewTabPage(ui.Text(&quot;properties&quot;));
            props.Controls.Add(Pane7);

            SaveButton = Panel1.Menu.NewButton();
            SaveButton.Text = ui.Text(&quot;save&quot;);
            SaveButton.ButtonType = MenuButtonType.Primary;
            SaveButton.ID = &quot;save&quot;;
            SaveButton.CssClass = &quot;client-side&quot;;

			Panel1.Text = ui.Text(&quot;edittemplate&quot;);
			pp_name.Text = ui.Text(&quot;name&quot;, UmbracoUser);
            pp_alias.Text = ui.Text(&quot;alias&quot;, UmbracoUser);
            pp_masterTemplate.Text = ui.Text(&quot;mastertemplate&quot;, UmbracoUser);


			// Editing buttons
            MenuIconI umbField = editorSource.Menu.NewIcon();
			umbField.ImageURL = UmbracoPath + &quot;/images/editor/insField.gif&quot;;
			umbField.OnClickCommand =
				ClientTools.Scripts.OpenModalWindow(
					IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/umbracoField.aspx?objectId=&quot; +
					editorSource.ClientID + &quot;&amp;tagName=UMBRACOGETDATA&quot;, ui.Text(&quot;template&quot;, &quot;insertPageField&quot;), 640, 550);
			umbField.AltText = ui.Text(&quot;template&quot;, &quot;insertPageField&quot;);


			// TODO: Update icon
            MenuIconI umbDictionary = editorSource.Menu.NewIcon();
			umbDictionary.ImageURL = GlobalSettings.Path + &quot;/images/editor/dictionaryItem.gif&quot;;
			umbDictionary.OnClickCommand =
				ClientTools.Scripts.OpenModalWindow(
					IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/umbracoField.aspx?objectId=&quot; +
					editorSource.ClientID + &quot;&amp;tagName=UMBRACOGETDICTIONARY&quot;, ui.Text(&quot;template&quot;, &quot;insertDictionaryItem&quot;),
					640, 550);
			umbDictionary.AltText = &quot;Insert umbraco dictionary item&quot;;

		    editorSource.Menu.NewElement(&quot;div&quot;, &quot;splitButtonMacroPlaceHolder&quot;, &quot;sbPlaceHolder&quot;, 40);

			if (UmbracoConfig.For.UmbracoSettings().Templates.UseAspNetMasterPages)
			{
			    MenuIconI umbContainer = editorSource.Menu.NewIcon();
				umbContainer.ImageURL = UmbracoPath + &quot;/images/editor/masterpagePlaceHolder.gif&quot;;
				umbContainer.AltText = ui.Text(&quot;template&quot;, &quot;insertContentAreaPlaceHolder&quot;);
				umbContainer.OnClickCommand =
					ClientTools.Scripts.OpenModalWindow(
						IOHelper.ResolveUrl(SystemDirectories.Umbraco) +
						&quot;/dialogs/insertMasterpagePlaceholder.aspx?&amp;id=&quot; + _template.Id,
						ui.Text(&quot;template&quot;, &quot;insertContentAreaPlaceHolder&quot;), 470, 320);

                MenuIconI umbContent = editorSource.Menu.NewIcon();
				umbContent.ImageURL = UmbracoPath + &quot;/images/editor/masterpageContent.gif&quot;;
				umbContent.AltText = ui.Text(&quot;template&quot;, &quot;insertContentArea&quot;);
				umbContent.OnClickCommand =
					ClientTools.Scripts.OpenModalWindow(
						IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/insertMasterpageContent.aspx?id=&quot; +
						_template.Id, ui.Text(&quot;template&quot;, &quot;insertContentArea&quot;), 470, 300);
			}


			//Spit button
            editorSource.Menu.InsertSplitter();
            editorSource.Menu.NewElement(&quot;div&quot;, &quot;splitButtonPlaceHolder&quot;, &quot;sbPlaceHolder&quot;, 40);

			// Help
            editorSource.Menu.InsertSplitter();

            MenuIconI helpIcon = editorSource.Menu.NewIcon();
			helpIcon.OnClickCommand =
				ClientTools.Scripts.OpenModalWindow(
					IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/settings/modals/showumbracotags.aspx?alias=&quot; +
					_template.Alias, ui.Text(&quot;template&quot;, &quot;quickGuide&quot;), 600, 580);
			helpIcon.ImageURL = UmbracoPath + &quot;/images/editor/help.png&quot;;
			helpIcon.AltText = ui.Text(&quot;template&quot;, &quot;quickGuide&quot;);
		}


		private void LoadScriptingTemplates()
		{
			string path = SystemDirectories.Umbraco + &quot;/scripting/templates/cshtml/&quot;;
			string abPath = IOHelper.MapPath(path);

			var files = new List&lt;KeyValuePair&lt;string, string&gt;&gt;();

			if (Directory.Exists(abPath))
			{
				string extension = &quot;.cshtml&quot;;

				foreach (FileInfo fi in new DirectoryInfo(abPath).GetFiles(&quot;*&quot; + extension))
				{
					string filename = Path.GetFileName(fi.FullName);

					files.Add(new KeyValuePair&lt;string, string&gt;(
								  filename,
                                  filename.Replace(extension, &quot;&quot;).SplitPascalCasing().ToFirstUpperInvariant()
								  ));
				}
			}

			rpt_codeTemplates.DataSource = files;
			rpt_codeTemplates.DataBind();
		}

		private void LoadMacros()
		{
		    using (var sqlHelper = BusinessLogic.Application.SqlHelper)
            using (IRecordsReader macroRenderings = 
                sqlHelper.ExecuteReader(&quot;select id, macroAlias, macroName from cmsMacro order by macroName&quot;))
		    {
		        rpt_macros.DataSource = macroRenderings;
		        rpt_macros.DataBind();
		    }
		}

		public string DoesMacroHaveSettings(string macroId)
		{
            using (var sqlHelper = BusinessLogic.Application.SqlHelper)
                if (
				    sqlHelper.ExecuteScalar&lt;int&gt;(string.Format(&quot;select 1 from cmsMacroProperty where macro = {0}&quot;, macroId)) ==
				    1)
				    return &quot;1&quot;;
			    else
				    return &quot;0&quot;;
		}

		/// &lt;summary&gt;
		/// Required method for Designer support - do not modify
		/// the contents of this method with the code editor.
		/// &lt;/summary&gt;
		private void InitializeComponent()
		{
		}

		/// &lt;summary&gt;
		/// CssInclude1 control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::ClientDependency.Core.Controls.CssInclude CssInclude1;

		/// &lt;summary&gt;
		/// JsInclude control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::ClientDependency.Core.Controls.JsInclude JsInclude;

		/// &lt;summary&gt;
		/// Panel1 control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.TabView Panel1;

		/// &lt;summary&gt;
		/// Pane7 control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.Pane Pane7;
        protected global::umbraco.uicontrols.Pane Pane8;

		/// &lt;summary&gt;
		/// pp_name control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.PropertyPanel pp_name;

		/// &lt;summary&gt;
		/// NameTxt control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.TextBox NameTxt;

		/// &lt;summary&gt;
		/// pp_alias control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.PropertyPanel pp_alias;

		/// &lt;summary&gt;
		/// AliasTxt control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.TextBox AliasTxt;

		/// &lt;summary&gt;
		/// pp_masterTemplate control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.PropertyPanel pp_masterTemplate;

		/// &lt;summary&gt;
		/// MasterTemplate control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.DropDownList MasterTemplate;

		/// &lt;summary&gt;
		/// pp_source control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.PropertyPanel pp_source;

		/// &lt;summary&gt;
		/// editorSource control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.CodeArea editorSource;

		/// &lt;summary&gt;
		/// rpt_codeTemplates control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.Repeater rpt_codeTemplates;

		/// &lt;summary&gt;
		/// rpt_macros control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.Repeater rpt_macros;
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,3,28,24,0],[29,3,29,4,0],[30,4,30,49,0],[31,3,31,4,0],[34,3,34,4,0],[35,4,35,24,0],[37,4,38,104,0],[39,4,40,117,0],[41,3,41,4,0],[43,49,43,53,0],[43,54,43,66,0],[46,3,46,4,0],[47,4,47,72,0],[48,7,48,77,0],[50,4,50,20,0],[51,4,51,5,0],[52,5,52,66,0],[53,5,53,12,0],[53,14,53,24,0],[53,25,53,27,0],[53,28,53,51,0],[54,5,54,6,0],[55,6,55,31,0],[56,6,56,7,0],[57,7,57,54,0],[58,7,58,57,0],[59,7,59,36,0],[60,6,60,7,0],[61,5,61,6,0],[63,5,63,43,0],[64,5,64,37,0],[65,5,65,42,0],[68,5,68,6,0],[69,6,69,39,0],[70,7,70,74,0],[71,5,71,6,0],[72,5,72,25,0],[73,5,73,6,0],[74,5,74,6,0],[76,5,78,60,0],[80,5,80,30,0],[81,5,81,18,0],[82,4,82,5,0],[83,3,83,4,0],[86,3,86,4,0],[87,4,87,75,0],[91,4,91,26,0],[92,4,92,19,0],[93,4,93,26,0],[95,7,95,59,0],[96,13,96,40,0],[98,13,98,66,0],[99,13,99,39,0],[101,13,101,50,0],[102,13,102,47,0],[103,13,103,60,0],[104,13,104,36,0],[105,13,105,49,0],[107,4,107,42,0],[108,4,108,48,0],[109,13,109,59,0],[110,13,110,77,0],[114,13,114,62,0],[115,4,115,68,0],[116,4,119,107,0],[120,4,120,62,0],[124,13,124,67,0],[125,4,125,87,0],[126,4,130,16,0],[131,4,131,61,0],[133,7,133,95,0],[135,4,135,75,0],[136,4,136,5,0],[137,8,137,61,0],[138,5,138,86,0],[139,5,139,80,0],[140,5,144,70,0],[146,17,146,68,0],[147,5,147,80,0],[148,5,148,67,0],[149,5,152,73,0],[153,4,153,5,0],[157,13,157,48,0],[158,13,158,96,0],[161,13,161,48,0],[163,13,163,62,0],[164,4,167,68,0],[168,4,168,64,0],[169,4,169,57,0],[170,3,170,4,0],[174,3,174,4,0],[175,4,175,77,0],[176,4,176,43,0],[178,4,178,57,0],[180,4,180,33,0],[181,4,181,5,0],[182,5,182,34,0],[184,5,184,12,0],[184,14,184,25,0],[184,26,184,28,0],[184,29,184,80,0],[185,5,185,6,0],[186,6,186,54,0],[188,6,191,14,0],[192,5,192,6,0],[193,4,193,5,0],[195,4,195,41,0],[196,4,196,33,0],[197,3,197,4,0],[200,3,200,4,0],[201,14,201,65,0],[202,20,203,109,0],[204,7,204,8,0],[205,11,205,51,0],[206,11,206,33,0],[207,7,207,8,0],[208,3,208,4,0],[211,3,211,4,0],[212,20,212,71,0],[213,17,215,11,0],[216,9,216,20,0],[218,9,218,20,0],[219,3,219,4,0],[226,3,226,4,0],[227,3,227,4,0]]);
    </script>
  </body>
</html>