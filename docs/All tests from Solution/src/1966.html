<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\PublicAccessEntry.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Collections.Specialized;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization;
using Umbraco.Core.Models.EntityBase;

namespace Umbraco.Core.Models
{
    [Serializable]
    [DataContract(IsReference = true)]
    public class PublicAccessEntry : Entity, IAggregateRoot
    {
        private readonly ObservableCollection&lt;PublicAccessRule&gt; _ruleCollection;
        private int _protectedNodeId;
        private int _noAccessNodeId;
        private int _loginNodeId;
        private readonly List&lt;Guid&gt; _removedRules = new List&lt;Guid&gt;();

        public PublicAccessEntry(IContent protectedNode, IContent loginNode, IContent noAccessNode, IEnumerable&lt;PublicAccessRule&gt; ruleCollection)
        {
            LoginNodeId = loginNode.Id;
            NoAccessNodeId = noAccessNode.Id;
            _protectedNodeId = protectedNode.Id;

            _ruleCollection = new ObservableCollection&lt;PublicAccessRule&gt;(ruleCollection);
            _ruleCollection.CollectionChanged += _ruleCollection_CollectionChanged;
        }

        public PublicAccessEntry(Guid id, int protectedNodeId, int loginNodeId, int noAccessNodeId, IEnumerable&lt;PublicAccessRule&gt; ruleCollection)
        {
            Key = id;
            Id = Key.GetHashCode();

            LoginNodeId = loginNodeId;
            NoAccessNodeId = noAccessNodeId;
            _protectedNodeId = protectedNodeId;

            _ruleCollection = new ObservableCollection&lt;PublicAccessRule&gt;(ruleCollection);
            _ruleCollection.CollectionChanged += _ruleCollection_CollectionChanged;
        }

        void _ruleCollection_CollectionChanged(object sender, NotifyCollectionChangedEventArgs e)
        {
            OnPropertyChanged(Ps.Value.AllowedSectionsSelector);

            //if (e.Action == NotifyCollectionChangedAction.Add)
            //{
            //    var item = e.NewItems.Cast&lt;PublicAccessRule&gt;().First();

            //    if (_addedSections.Contains(item) == false)
            //    {
            //        _addedSections.Add(item);
            //    }
            //}

            if (e.Action == NotifyCollectionChangedAction.Remove)
            {
                var item = e.OldItems.Cast&lt;PublicAccessRule&gt;().First();

                if (_removedRules.Contains(item.Key) == false)
                {
                    _removedRules.Add(item.Key);
                }

            }
        }

        private static readonly Lazy&lt;PropertySelectors&gt; Ps = new Lazy&lt;PropertySelectors&gt;();

        private class PropertySelectors
        {
            public readonly PropertyInfo ProtectedNodeIdSelector = ExpressionHelper.GetPropertyInfo&lt;PublicAccessEntry, int&gt;(x =&gt; x.ProtectedNodeId);
            public readonly PropertyInfo LoginNodeIdSelector = ExpressionHelper.GetPropertyInfo&lt;PublicAccessEntry, int&gt;(x =&gt; x.LoginNodeId);
            public readonly PropertyInfo NoAccessNodeIdSelector = ExpressionHelper.GetPropertyInfo&lt;PublicAccessEntry, int&gt;(x =&gt; x.NoAccessNodeId);
            public readonly PropertyInfo AllowedSectionsSelector = ExpressionHelper.GetPropertyInfo&lt;PublicAccessEntry, IEnumerable&lt;PublicAccessRule&gt;&gt;(x =&gt; x.Rules);
        }

        internal IEnumerable&lt;Guid&gt; RemovedRules
        {
            get { return _removedRules; }
        }

        public IEnumerable&lt;PublicAccessRule&gt; Rules
        {
            get { return _ruleCollection; }
        }

        public PublicAccessRule AddRule(string ruleValue, string ruleType)
        {
            var rule = new PublicAccessRule
            {
                AccessEntryId = Key,
                RuleValue = ruleValue,
                RuleType = ruleType
            };
            _ruleCollection.Add(rule);
            return rule;
        }

        public void RemoveRule(PublicAccessRule rule)
        {
            _ruleCollection.Remove(rule);
        }

        public void ClearRules()
        {
            _ruleCollection.Clear();
        }


        internal void ClearRemovedRules()
        {
            _removedRules.Clear();
        }

        [DataMember]
        public int LoginNodeId
        {
            get { return _loginNodeId; }
            set { SetPropertyValueAndDetectChanges(value, ref _loginNodeId, Ps.Value.LoginNodeIdSelector); }
        }

        [DataMember]
        public int NoAccessNodeId
        {
            get { return _noAccessNodeId; }
            set { SetPropertyValueAndDetectChanges(value, ref _noAccessNodeId, Ps.Value.NoAccessNodeIdSelector); }
        }

        [DataMember]
        public int ProtectedNodeId
        {
            get { return _protectedNodeId; }
            set { SetPropertyValueAndDetectChanges(value, ref _protectedNodeId, Ps.Value.ProtectedNodeIdSelector); }
        }

        public override void ResetDirtyProperties(bool rememberPreviouslyChangedProperties)
        {
            _removedRules.Clear();
            base.ResetDirtyProperties(rememberPreviouslyChangedProperties);
            foreach (var publicAccessRule in _ruleCollection)
            {
                publicAccessRule.ResetDirtyProperties(rememberPreviouslyChangedProperties);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,70,1],[20,9,20,70,1],[22,9,22,146,1],[23,9,23,10,1],[24,13,24,40,1],[25,13,25,46,1],[26,13,26,49,1],[28,13,28,90,1],[29,13,29,84,1],[30,9,30,10,1],[32,9,32,146,1],[33,9,33,10,1],[34,13,34,22,1],[35,13,35,36,1],[37,13,37,39,1],[38,13,38,45,1],[39,13,39,48,1],[41,13,41,90,1],[42,13,42,84,1],[43,9,43,10,1],[46,9,46,10,1],[47,13,47,65,1],[59,13,59,66,1],[60,13,60,14,1],[61,17,61,72,1],[63,17,63,63,1],[64,17,64,18,1],[65,21,65,49,1],[66,17,66,18,1],[68,13,68,14,1],[69,9,69,10,1],[71,9,71,92,1],[75,13,75,149,1],[76,13,76,141,1],[77,13,77,147,1],[78,13,78,165,1],[83,17,83,18,1],[83,19,83,40,1],[83,41,83,42,1],[88,17,88,18,1],[88,19,88,42,1],[88,43,88,44,1],[92,9,92,10,1],[93,13,98,15,1],[99,13,99,39,1],[100,13,100,25,1],[101,9,101,10,1],[104,9,104,10,1],[105,13,105,42,1],[106,9,106,10,1],[109,9,109,10,0],[110,13,110,37,0],[111,9,111,10,0],[115,9,115,10,1],[116,13,116,35,1],[117,9,117,10,1],[122,17,122,18,1],[122,19,122,39,1],[122,40,122,41,1],[123,17,123,18,1],[123,19,123,107,1],[123,108,123,109,1],[129,17,129,18,1],[129,19,129,42,1],[129,43,129,44,1],[130,17,130,18,1],[130,19,130,113,1],[130,114,130,115,1],[136,17,136,18,1],[136,19,136,43,1],[136,44,136,45,1],[137,17,137,18,0],[137,19,137,115,0],[137,116,137,117,0],[141,9,141,10,1],[142,13,142,35,1],[143,13,143,76,1],[144,13,144,20,1],[144,22,144,42,1],[144,43,144,45,1],[144,46,144,61,1],[145,13,145,14,1],[146,17,146,92,1],[147,13,147,14,1],[148,9,148,10,1]]);
    </script>
  </body>
</html>