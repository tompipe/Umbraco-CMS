<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\templateControls\Macro.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Collections;
using umbraco.cms.businesslogic.macro;
using System.Web;

namespace umbraco.presentation.templateControls
{

    [DefaultProperty(&quot;Alias&quot;)]
    [ToolboxData(&quot;&lt;{0}:Macro runat=server&gt;&lt;/{0}:Macro&gt;&quot;)]
    [PersistChildren(false)]
    [ParseChildren(true, &quot;Text&quot;)]
    public class Macro : WebControl, ITextControl
    {

        private Hashtable m_Attributes = new Hashtable();
        private string m_Code = String.Empty;

        public Hashtable MacroAttributes
        {
            get
            {
                //                Hashtable attributes = (Hashtable)ViewState[&quot;Attributes&quot;];
                return m_Attributes;
            }
            set
            {
                m_Attributes = value;
            }
        }


        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public string Alias
        {
            get
            {
                String s = (String)ViewState[&quot;Alias&quot;];
                return ((s == null) ? String.Empty : s);
            }

            set
            {
                ViewState[&quot;Alias&quot;] = value;
            }
        }

        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public string Language {
            get {
                var s = (String)ViewState[&quot;Language&quot;];
                return (s ?? String.Empty);
            }
            set {
                ViewState[&quot;Language&quot;] = value.ToLower();
            }
        }

        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public string FileLocation {
            get {
                var s = (String)ViewState[&quot;FileLocation&quot;];
                return (s ?? String.Empty);
            }
            set {
                ViewState[&quot;FileLocation&quot;] = value.ToLower();
            }
        }
		[Bindable(true)]
		[Category(&quot;Umbraco&quot;)]
		[DefaultValue(RenderEvents.Init)]
		[Localizable(true)]
		public RenderEvents RenderEvent
		{
			get
			{
				RenderEvents renderEvent = RenderEvents.Init;
				if (ViewState[&quot;RenderEvent&quot;] != null)
					renderEvent = (RenderEvents)ViewState[&quot;RenderEvent&quot;];
				return renderEvent;
			}
			set
			{
				ViewState[&quot;RenderEvent&quot;] = value;
			}
		}

		// Indicates where to run EnsureChildControls and effectively render the macro
		public enum RenderEvents
		{
			Init,
			PreRender,
			Render
		}

        public IList&lt;Exception&gt; Exceptions = new List&lt;Exception&gt;();

		/// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;E:System.Web.UI.Control.Init&quot;/&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;An &lt;see cref=&quot;T:System.EventArgs&quot;/&gt; object that contains the event data.&lt;/param&gt;
        protected override void OnInit(EventArgs e) {
            base.OnInit(e);

            // Create child controls when told to - this is the default
			if (this.RenderEvent == RenderEvents.Init)
	            EnsureChildControls();
        }

		// Create child controls when told to - new option to render at PreRender
		protected override void OnPreRender(EventArgs e)
		{
			base.OnPreRender(e);

			if (this.RenderEvent == RenderEvents.PreRender)
				EnsureChildControls();
		}

        /// &lt;summary&gt;
        /// Called by the ASP.NET page framework to notify server controls that use composition-based implementation to create any child controls they contain in preparation for posting back or rendering.
        /// &lt;/summary&gt;
        protected override void CreateChildControls() {
            // collect all attributes set on the control
            var keys = Attributes.Keys;
            foreach (string key in keys)
                MacroAttributes.Add(key.ToLower(), HttpUtility.HtmlDecode(Attributes[key]));

            if (!MacroAttributes.ContainsKey(&quot;macroalias&quot;) &amp;&amp; !MacroAttributes.ContainsKey(&quot;macroAlias&quot;))
                MacroAttributes.Add(&quot;macroalias&quot;, Alias);

            // set pageId to int.MinValue if no pageID was found,
            // e.g. if the macro was rendered on a custom (non-Umbraco) page
            int pageId = Context.Items[&quot;pageID&quot;] == null ? int.MinValue : int.Parse(Context.Items[&quot;pageID&quot;].ToString());

            if ((!String.IsNullOrEmpty(Language) &amp;&amp; Text != &quot;&quot;) || !string.IsNullOrEmpty(FileLocation)) {
                var tempMacro = new macro();
                tempMacro.GenerateMacroModelPropertiesFromAttributes(MacroAttributes);
                if (string.IsNullOrEmpty(FileLocation)) {
                    tempMacro.Model.ScriptCode = Text;
                    tempMacro.Model.ScriptLanguage = Language;
                } else {
                    tempMacro.Model.ScriptName = FileLocation;
                }
                tempMacro.Model.MacroType = MacroTypes.Script;
                if (!String.IsNullOrEmpty(Attributes[&quot;Cache&quot;])) {
                    var cacheDuration = 0;
                    if (int.TryParse(Attributes[&quot;Cache&quot;], out cacheDuration))
                        tempMacro.Model.CacheDuration = cacheDuration;
                    else
                        System.Web.HttpContext.Current.Trace.Warn(&quot;Template&quot;, &quot;Cache attribute is in incorect format (should be an integer).&quot;);
                }
                var c = tempMacro.renderMacro((Hashtable)Context.Items[&quot;pageElements&quot;], pageId);
                if (c != null)
                {
                    Exceptions = tempMacro.Exceptions;

                    Controls.Add(c);
                }
                else
                    System.Web.HttpContext.Current.Trace.Warn(&quot;Template&quot;, &quot;Result of inline macro scripting is null&quot;);
            
            } else {
                var tempMacro = macro.GetMacro(Alias);
                if (tempMacro != null) {
                    try {
                        var c = tempMacro.renderMacro(MacroAttributes, (Hashtable)Context.Items[&quot;pageElements&quot;], pageId);
                        if (c != null)
                            Controls.Add(c);
                        else
                            System.Web.HttpContext.Current.Trace.Warn(&quot;Template&quot;, &quot;Result of macro &quot; + tempMacro.Name + &quot; is null&quot;);
                    } catch (Exception ee) {
                        System.Web.HttpContext.Current.Trace.Warn(&quot;Template&quot;, &quot;Error adding macro &quot; + tempMacro.Name, ee);
                        throw;
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// Renders the control to the specified HTML writer.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;writer&quot;&gt;The &lt;see cref=&quot;T:System.Web.UI.HtmlTextWriter&quot;/&gt; object that receives the control content.&lt;/param&gt;
        protected override void Render(HtmlTextWriter writer)
        {
			// Create child controls when told to - do it here anyway as it has to be done
            EnsureChildControls();

            bool isDebug = GlobalSettings.DebugMode &amp;&amp; (helper.Request(&quot;umbdebugshowtrace&quot;) != &quot;&quot; || helper.Request(&quot;umbdebug&quot;) != &quot;&quot;);
            if (isDebug)
            {
                writer.Write(&quot;&lt;div title=\&quot;Macro Tag: &#39;{0}&#39;\&quot; style=\&quot;border: 1px solid #009;\&quot;&gt;&quot;, Alias);
            }
            base.RenderChildren(writer);
            if (isDebug)
            {
                writer.Write(&quot;&lt;/div&gt;&quot;);
            }
        }


        public string Text
        {
            get { return m_Code; }
            set { m_Code = value; }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,58,0],[21,9,21,46,0],[26,13,26,14,0],[28,17,28,37,0],[29,13,29,14,0],[31,13,31,14,0],[32,17,32,38,0],[33,13,33,14,0],[44,13,44,14,0],[45,17,45,55,0],[46,17,46,57,0],[47,13,47,14,0],[50,13,50,14,0],[51,17,51,44,0],[52,13,52,14,0],[60,17,60,18,0],[61,17,61,55,0],[62,17,62,44,0],[63,13,63,14,0],[64,17,64,18,0],[65,17,65,57,0],[66,13,66,14,0],[74,17,74,18,0],[75,17,75,59,0],[76,17,76,44,0],[77,13,77,14,0],[78,17,78,18,0],[79,17,79,61,0],[80,13,80,14,0],[89,4,89,5,0],[90,5,90,50,0],[91,5,91,42,0],[92,6,92,59,0],[93,5,93,24,0],[94,4,94,5,0],[96,4,96,5,0],[97,5,97,38,0],[98,4,98,5,0],[109,9,109,68,0],[115,53,115,54,0],[116,13,116,28,0],[119,4,119,46,0],[120,14,120,36,0],[121,9,121,10,0],[125,3,125,4,0],[126,4,126,24,0],[128,4,128,51,0],[129,5,129,27,0],[130,3,130,4,0],[135,55,135,56,0],[137,13,137,40,0],[138,13,138,20,0],[138,22,138,32,0],[138,33,138,35,0],[138,36,138,40,0],[139,17,139,93,0],[141,13,141,106,0],[142,17,142,58,0],[146,13,146,121,0],[148,13,148,104,0],[148,105,148,106,0],[149,17,149,45,0],[150,17,150,87,0],[151,17,151,56,0],[151,57,151,58,0],[152,21,152,55,0],[153,21,153,63,0],[154,17,154,18,0],[154,24,154,25,0],[155,21,155,63,0],[156,17,156,18,0],[157,17,157,63,0],[158,17,158,64,0],[158,65,158,66,0],[159,21,159,43,0],[160,21,160,78,0],[161,25,161,71,0],[163,25,163,144,0],[164,17,164,18,0],[165,17,165,97,0],[166,17,166,31,0],[167,17,167,18,0],[168,21,168,55,0],[170,21,170,37,0],[171,17,171,18,0],[173,21,173,119,0],[175,13,175,14,0],[175,20,175,21,0],[176,17,176,55,0],[177,17,177,39,0],[177,40,177,41,0],[178,25,178,26,0],[179,25,179,122,0],[180,25,180,39,0],[181,29,181,45,0],[183,29,183,133,0],[184,21,184,22,0],[184,23,184,43,0],[184,44,184,45,0],[185,25,185,123,0],[186,25,186,31,0],[188,17,188,18,0],[189,13,189,14,0],[190,9,190,10,0],[197,9,197,10,0],[199,13,199,35,0],[201,13,201,136,0],[202,13,202,25,0],[203,13,203,14,0],[204,17,204,107,0],[205,13,205,14,0],[206,13,206,41,0],[207,13,207,25,0],[208,13,208,14,0],[209,17,209,40,0],[210,13,210,14,0],[211,9,211,10,0],[216,17,216,18,0],[216,19,216,33,0],[216,34,216,35,0],[217,17,217,18,0],[217,19,217,34,0],[217,35,217,36,0]]);
    </script>
  </body>
</html>