<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Sync\ServerMessengerBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Newtonsoft.Json;
using Umbraco.Core.Cache;
using Umbraco.Core.Logging;
using umbraco.interfaces;

namespace Umbraco.Core.Sync
{
    /// &lt;summary&gt;
    /// Provides a base class for all &lt;see cref=&quot;IServerMessenger&quot;/&gt; implementations.
    /// &lt;/summary&gt;
    public abstract class ServerMessengerBase : IServerMessenger
    {
        protected bool DistributedEnabled { get; set; }

        protected ServerMessengerBase(bool distributedEnabled)
        {
            DistributedEnabled = distributedEnabled;
        }

        /// &lt;summary&gt;
        /// Determines whether to make distributed calls when messaging a cache refresher.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;servers&quot;&gt;The registered servers.&lt;/param&gt;
        /// &lt;param name=&quot;refresher&quot;&gt;The cache refresher.&lt;/param&gt;
        /// &lt;param name=&quot;messageType&quot;&gt;The message type.&lt;/param&gt;
        /// &lt;returns&gt;true if distributed calls are required; otherwise, false, all we have is the local server.&lt;/returns&gt;
        protected virtual bool RequiresDistributed(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, MessageType messageType)
        {
            return DistributedEnabled &amp;&amp; servers.Any();
        }

        // ensures that all items in the enumerable are of the same type, either int or Guid.
        protected static bool GetArrayType(IEnumerable&lt;object&gt; ids, out Type arrayType)
        {
            arrayType = null;
            if (ids == null) return true;

            foreach (var id in ids)
            {
                // only int and Guid are supported
                if ((id is int) == false &amp;&amp; ((id is Guid) == false))
                    return false;
                // initialize with first item
                if (arrayType == null)
                    arrayType = id.GetType();
                // check remaining items
                if (arrayType != id.GetType())
                    return false;
            }

            return true;
        }

        #region IServerMessenger

        public void PerformRefresh(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, object payload)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);
            if (payload == null) throw new ArgumentNullException(&quot;payload&quot;);

            Deliver(servers, refresher, payload);
        }

        public void PerformRefresh(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, string jsonPayload)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);
            if (jsonPayload == null) throw new ArgumentNullException(&quot;jsonPayload&quot;);

            Deliver(servers, refresher, MessageType.RefreshByJson, json: jsonPayload);
        }

        public void PerformRefresh&lt;T&gt;(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, Func&lt;T, int&gt; getNumericId, params T[] instances)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);
            if (getNumericId == null) throw new ArgumentNullException(&quot;getNumericId&quot;);
            if (instances == null || instances.Length == 0) return;

            Func&lt;T, object&gt; getId = x =&gt; getNumericId(x);
            Deliver(servers, refresher, MessageType.RefreshByInstance, getId, instances);
        }

        public void PerformRefresh&lt;T&gt;(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, Func&lt;T, Guid&gt; getGuidId, params T[] instances)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);
            if (getGuidId == null) throw new ArgumentNullException(&quot;getGuidId&quot;);
            if (instances == null || instances.Length == 0) return;

            Func&lt;T, object&gt; getId = x =&gt; getGuidId(x);
            Deliver(servers, refresher, MessageType.RefreshByInstance, getId, instances);
        }

        public void PerformRemove&lt;T&gt;(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, Func&lt;T, int&gt; getNumericId, params T[] instances)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);
            if (getNumericId == null) throw new ArgumentNullException(&quot;getNumericId&quot;);
            if (instances == null || instances.Length == 0) return;

            Func&lt;T, object&gt; getId = x =&gt; getNumericId(x);
            Deliver(servers, refresher, MessageType.RemoveByInstance, getId, instances);
        }

        public void PerformRemove(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, params int[] numericIds)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);
            if (numericIds == null || numericIds.Length == 0) return;

            Deliver(servers, refresher, MessageType.RemoveById, numericIds.Cast&lt;object&gt;());
        }

        public void PerformRefresh(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, params int[] numericIds)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);
            if (numericIds == null || numericIds.Length == 0) return;

            Deliver(servers, refresher, MessageType.RefreshById, numericIds.Cast&lt;object&gt;());
        }

        public void PerformRefresh(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, params Guid[] guidIds)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);
            if (guidIds == null || guidIds.Length == 0) return;

            Deliver(servers, refresher, MessageType.RefreshById, guidIds.Cast&lt;object&gt;());
        }

        public void PerformRefreshAll(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

            Deliver(servers, refresher, MessageType.RefreshAll);
        }

        //public void PerformNotify(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, object payload)
        //{
        //    if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
        //    if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

        //    Deliver(servers, refresher, payload);
        //}

        #endregion

        #region Deliver

        protected void DeliverLocal(ICacheRefresher refresher, object payload)
        {
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

            LogHelper.Debug&lt;ServerMessengerBase&gt;(&quot;Invoking refresher {0} on local server for message type RefreshByPayload&quot;,
                refresher.GetType);

            var payloadRefresher = refresher as IPayloadCacheRefresher;
            if (payloadRefresher == null)
                throw new InvalidOperationException(&quot;The cache refresher &quot; + refresher.GetType() + &quot; is not of type &quot; + typeof(IPayloadCacheRefresher));
            payloadRefresher.Refresh(payload);
        }

        /// &lt;summary&gt;
        /// Executes the non strongly typed &lt;see cref=&quot;ICacheRefresher&quot;/&gt; on the local/current server
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;refresher&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;messageType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;ids&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;json&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// Since this is only for non strongly typed &lt;see cref=&quot;ICacheRefresher&quot;/&gt; it will throw for message types that by instance
        /// &lt;/remarks&gt;
        protected void DeliverLocal(ICacheRefresher refresher, MessageType messageType, IEnumerable&lt;object&gt; ids = null, string json = null)
        {
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

            LogHelper.Debug&lt;ServerMessengerBase&gt;(&quot;Invoking refresher {0} on local server for message type {1}&quot;,
                refresher.GetType,
                () =&gt; messageType);

            switch (messageType)
            {
                case MessageType.RefreshAll:
                    refresher.RefreshAll();
                    break;

                case MessageType.RefreshById:
                    if (ids != null)
                        foreach (var id in ids)
                        {
                            if (id is int)
                                refresher.Refresh((int) id);
                            else if (id is Guid)
                                refresher.Refresh((Guid) id);
                            else
                                throw new InvalidOperationException(&quot;The id must be either an int or a Guid.&quot;);
                        }
                    break;

                case MessageType.RefreshByJson:
                    var jsonRefresher = refresher as IJsonCacheRefresher;
                    if (jsonRefresher == null)
                        throw new InvalidOperationException(&quot;The cache refresher &quot; + refresher.GetType() + &quot; is not of type &quot; + typeof(IJsonCacheRefresher));
                    jsonRefresher.Refresh(json);
                    break;

                case MessageType.RemoveById:
                    if (ids != null)
                        foreach (var id in ids)
                        {
                            if (id is int)
                                refresher.Remove((int) id);
                            else
                                throw new InvalidOperationException(&quot;The id must be an int.&quot;);
                        }
                    break;

                default:
                //case MessageType.RefreshByInstance:
                //case MessageType.RemoveByInstance:
                    throw new NotSupportedException(&quot;Invalid message type &quot; + messageType);
            }
        }
        
        /// &lt;summary&gt;
        /// Executes the strongly typed &lt;see cref=&quot;ICacheRefresher{T}&quot;/&gt; on the local/current server
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;refresher&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;messageType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;getId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;instances&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// Since this is only for strongly typed &lt;see cref=&quot;ICacheRefresher{T}&quot;/&gt; it will throw for message types that are not by instance
        /// &lt;/remarks&gt;
        protected void DeliverLocal&lt;T&gt;(ICacheRefresher refresher, MessageType messageType, Func&lt;T, object&gt; getId, IEnumerable&lt;T&gt; instances)
        {
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

            LogHelper.Debug&lt;ServerMessengerBase&gt;(&quot;Invoking refresher {0} on local server for message type {1}&quot;,
                refresher.GetType,
                () =&gt; messageType);

            var typedRefresher = refresher as ICacheRefresher&lt;T&gt;;

            switch (messageType)
            {
                case MessageType.RefreshAll:
                    refresher.RefreshAll();
                    break;

                case MessageType.RefreshByInstance:
                    if (typedRefresher == null)
                        throw new InvalidOperationException(&quot;The refresher must be a typed refresher.&quot;);
                    foreach (var instance in instances)
                        typedRefresher.Refresh(instance);
                    break;

                case MessageType.RemoveByInstance:
                    if (typedRefresher == null)
                        throw new InvalidOperationException(&quot;The cache refresher &quot; + refresher.GetType() + &quot; is not a typed refresher.&quot;);
                    foreach (var instance in instances)
                        typedRefresher.Remove(instance);
                    break;

                default:
                //case MessageType.RefreshById:
                //case MessageType.RemoveById:
                //case MessageType.RefreshByJson:
                    throw new NotSupportedException(&quot;Invalid message type &quot; + messageType);
            }
        }

        //protected void DeliverLocal(ICacheRefresher refresher, object payload)
        //{
        //    if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

        //    LogHelper.Debug&lt;ServerMessengerBase&gt;(&quot;Invoking refresher {0} on local server for message type Notify&quot;,
        //        () =&gt; refresher.GetType());

        //    refresher.Notify(payload);
        //}

        protected abstract void DeliverRemote(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, MessageType messageType, IEnumerable&lt;object&gt; ids = null, string json = null);

        //protected abstract void DeliverRemote(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, object payload);

        protected virtual void Deliver(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, object payload)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

            var serversA = servers.ToArray();

            // deliver local
            DeliverLocal(refresher, payload);

            // distribute?
            if (RequiresDistributed(serversA, refresher, MessageType.RefreshByJson) == false)
                return;

            // deliver remote
            var json = JsonConvert.SerializeObject(payload);
            DeliverRemote(serversA, refresher, MessageType.RefreshByJson, null, json);
        }

        protected virtual void Deliver(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, MessageType messageType, IEnumerable&lt;object&gt; ids = null, string json = null)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

            var serversA = servers.ToArray();
            var idsA = ids == null ? null : ids.ToArray();

            // deliver local
            DeliverLocal(refresher, messageType, idsA, json);

            // distribute?
            if (RequiresDistributed(serversA, refresher, messageType) == false)
                return;

            // deliver remote
            DeliverRemote(serversA, refresher, messageType, idsA, json);
        }

        protected virtual void Deliver&lt;T&gt;(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, MessageType messageType, Func&lt;T, object&gt; getId, IEnumerable&lt;T&gt; instances)
        {
            if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
            if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

            var serversA = servers.ToArray();
            var instancesA = instances.ToArray();

            // deliver local
            DeliverLocal(refresher, messageType, getId, instancesA);

            // distribute?
            if (RequiresDistributed(serversA, refresher, messageType) == false)
                return;

            // deliver remote

            // map ByInstance to ById as there&#39;s no remote instances
            if (messageType == MessageType.RefreshByInstance) messageType = MessageType.RefreshById;
            if (messageType == MessageType.RemoveByInstance) messageType = MessageType.RemoveById;

            // convert instances to identifiers
            var idsA = instancesA.Select(getId).ToArray();

            DeliverRemote(serversA, refresher, messageType, idsA);
        }

        //protected virtual void Deliver(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, object payload)
        //{
        //    if (servers == null) throw new ArgumentNullException(&quot;servers&quot;);
        //    if (refresher == null) throw new ArgumentNullException(&quot;refresher&quot;);

        //    var serversA = servers.ToArray();

        //    // deliver local
        //    DeliverLocal(refresher, payload);

        //    // distribute?
        //    if (RequiresDistributed(serversA, refresher, messageType) == false)
        //        return;

        //    // deliver remote
        //    DeliverRemote(serversA, refresher, payload);
        //}

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,45,16,49,0],[16,50,16,54,1],[18,9,18,63,1],[19,9,19,10,1],[20,13,20,53,1],[21,9,21,10,1],[31,9,31,10,0],[32,13,32,56,0],[33,9,33,10,0],[37,9,37,10,0],[38,13,38,30,0],[39,13,39,29,0],[39,30,39,42,0],[41,13,41,20,0],[41,22,41,28,0],[41,29,41,31,0],[41,32,41,35,0],[42,13,42,14,0],[44,17,44,69,0],[45,21,45,34,0],[47,17,47,39,0],[48,21,48,46,0],[50,17,50,47,0],[51,21,51,34,0],[52,13,52,14,0],[54,13,54,25,0],[55,9,55,10,0],[60,9,60,10,0],[61,13,61,33,0],[61,34,61,77,0],[62,13,62,35,0],[62,36,62,81,0],[63,13,63,33,0],[63,34,63,77,0],[65,13,65,50,0],[66,9,66,10,0],[69,9,69,10,0],[70,13,70,33,0],[70,34,70,77,0],[71,13,71,35,0],[71,36,71,81,0],[72,13,72,37,0],[72,38,72,85,0],[74,13,74,87,0],[75,9,75,10,0],[78,9,78,10,0],[79,13,79,33,0],[79,34,79,77,0],[80,13,80,35,0],[80,36,80,81,0],[81,13,81,38,0],[81,39,81,87,0],[82,13,82,60,0],[82,61,82,68,0],[84,13,84,42,0],[84,42,84,57,0],[84,57,84,58,0],[84,13,84,58,0],[85,13,85,90,0],[86,9,86,10,0],[89,9,89,10,0],[90,13,90,33,0],[90,34,90,77,0],[91,13,91,35,0],[91,36,91,81,0],[92,13,92,35,0],[92,36,92,81,0],[93,13,93,60,0],[93,61,93,68,0],[95,13,95,42,0],[95,42,95,54,0],[95,54,95,55,0],[95,13,95,55,0],[96,13,96,90,0],[97,9,97,10,0],[100,9,100,10,0],[101,13,101,33,0],[101,34,101,77,0],[102,13,102,35,0],[102,36,102,81,0],[103,13,103,38,0],[103,39,103,87,0],[104,13,104,60,0],[104,61,104,68,0],[106,13,106,42,0],[106,42,106,57,0],[106,57,106,58,0],[106,13,106,58,0],[107,13,107,89,0],[108,9,108,10,0],[111,9,111,10,0],[112,13,112,33,0],[112,34,112,77,0],[113,13,113,35,0],[113,36,113,81,0],[114,13,114,62,0],[114,63,114,70,0],[116,13,116,92,0],[117,9,117,10,0],[120,9,120,10,0],[121,13,121,33,0],[121,34,121,77,0],[122,13,122,35,0],[122,36,122,81,0],[123,13,123,62,0],[123,63,123,70,0],[125,13,125,93,0],[126,9,126,10,0],[129,9,129,10,0],[130,13,130,33,0],[130,34,130,77,0],[131,13,131,35,0],[131,36,131,81,0],[132,13,132,56,0],[132,57,132,64,0],[134,13,134,90,0],[135,9,135,10,0],[138,9,138,10,0],[139,13,139,33,0],[139,34,139,77,0],[140,13,140,35,0],[140,36,140,81,0],[142,13,142,65,0],[143,9,143,10,0],[158,9,158,10,0],[159,13,159,35,0],[159,36,159,81,0],[161,13,162,36,0],[164,13,164,72,0],[165,13,165,42,0],[166,17,166,153,0],[167,13,167,47,0],[168,9,168,10,0],[181,9,181,10,0],[182,13,182,35,0],[182,36,182,81,0],[184,13,186,23,0],[186,23,186,34,0],[186,34,186,36,0],[184,13,186,36,0],[188,13,188,33,0],[191,21,191,44,0],[192,21,192,27,0],[195,21,195,37,0],[196,25,196,32,0],[196,34,196,40,0],[196,41,196,43,0],[196,44,196,47,0],[197,25,197,26,0],[198,29,198,43,0],[199,33,199,61,0],[200,34,200,49,0],[201,33,201,62,0],[203,33,203,112,0],[204,25,204,26,0],[205,21,205,27,0],[208,21,208,74,0],[209,21,209,47,0],[210,25,210,158,0],[211,21,211,49,0],[212,21,212,27,0],[215,21,215,37,0],[216,25,216,32,0],[216,34,216,40,0],[216,41,216,43,0],[216,44,216,47,0],[217,25,217,26,0],[218,29,218,43,0],[219,33,219,60,0],[221,33,221,95,0],[222,25,222,26,0],[223,21,223,27,0],[228,21,228,92,0],[230,9,230,10,0],[244,9,244,10,0],[245,13,245,35,0],[245,36,245,81,0],[247,13,249,23,0],[249,23,249,34,0],[249,34,249,36,0],[247,13,249,36,0],[251,13,251,66,0],[253,13,253,33,0],[256,21,256,44,0],[257,21,257,27,0],[260,21,260,48,0],[261,25,261,105,0],[262,21,262,28,0],[262,30,262,42,0],[262,43,262,45,0],[262,46,262,55,0],[263,25,263,58,0],[264,21,264,27,0],[267,21,267,48,0],[268,25,268,138,0],[269,21,269,28,0],[269,30,269,42,0],[269,43,269,45,0],[269,46,269,55,0],[270,25,270,57,0],[271,21,271,27,0],[277,21,277,92,0],[279,9,279,10,0],[296,9,296,10,0],[297,13,297,33,0],[297,34,297,77,0],[298,13,298,35,0],[298,36,298,81,0],[300,13,300,46,0],[303,13,303,46,0],[306,13,306,94,0],[307,17,307,24,0],[310,13,310,61,0],[311,13,311,87,0],[312,9,312,10,0],[315,9,315,10,0],[316,13,316,33,0],[316,34,316,77,0],[317,13,317,35,0],[317,36,317,81,0],[319,13,319,46,0],[320,13,320,59,0],[323,13,323,62,0],[326,13,326,80,0],[327,17,327,24,0],[330,13,330,73,0],[331,9,331,10,0],[334,9,334,10,0],[335,13,335,33,0],[335,34,335,77,0],[336,13,336,35,0],[336,36,336,81,0],[338,13,338,46,0],[339,13,339,50,0],[342,13,342,69,0],[345,13,345,80,0],[346,17,346,24,0],[351,13,351,62,0],[351,63,351,101,0],[352,13,352,61,0],[352,62,352,99,0],[355,13,355,59,0],[357,13,357,67,0],[358,9,358,10,0]]);
    </script>
  </body>
</html>