<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Xml\DynamicContext.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Xml;
using System.Xml.Xsl;
using System.Xml.XPath;

// source: mvpxml.codeplex.com

namespace Umbraco.Core.Xml
{
	/// &lt;summary&gt;
	/// Provides the evaluation context for fast execution and custom 
	/// variables resolution.
	/// &lt;/summary&gt;
	/// &lt;remarks&gt;
	/// This class is responsible for resolving variables during dynamic expression execution.
	/// &lt;para&gt;Discussed in http://weblogs.asp.net/cazzu/archive/2003/10/07/30888.aspx&lt;/para&gt;
	/// &lt;para&gt;Author: Daniel Cazzulino, &lt;a href=&quot;http://clariusconsulting.net/kzu&quot;&gt;blog&lt;/a&gt;&lt;/para&gt;
	/// &lt;/remarks&gt;
	public class DynamicContext : XsltContext
	{
		#region Private vars

	    readonly IDictionary&lt;string, IXsltContextVariable&gt; _variables =
			new Dictionary&lt;string, IXsltContextVariable&gt;();

		#endregion Private

		#region Constructors &amp; Initialization

		/// &lt;summary&gt;
		/// Initializes a new instance of the &lt;see cref=&quot;DynamicContext&quot;/&gt; class.
		/// &lt;/summary&gt;
		public DynamicContext()
			: base(new NameTable())
		{
		}

		/// &lt;summary&gt;
		/// Initializes a new instance of the &lt;see cref=&quot;DynamicContext&quot;/&gt; 
		/// class with the specified &lt;see cref=&quot;NameTable&quot;/&gt;.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;table&quot;&gt;The NameTable to use.&lt;/param&gt;
		public DynamicContext(NameTable table)
			: base(table)
		{
		}

		/// &lt;summary&gt;
		/// Initializes a new instance of the &lt;see cref=&quot;DynamicContext&quot;/&gt; class.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;context&quot;&gt;A previously filled context with the namespaces to use.&lt;/param&gt;
		public DynamicContext(XmlNamespaceManager context)
			: this(context, new NameTable())
		{
		}

		/// &lt;summary&gt;
		/// Initializes a new instance of the &lt;see cref=&quot;DynamicContext&quot;/&gt; class.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;context&quot;&gt;A previously filled context with the namespaces to use.&lt;/param&gt;
		/// &lt;param name=&quot;table&quot;&gt;The NameTable to use.&lt;/param&gt;
		public DynamicContext(XmlNamespaceManager context, NameTable table)
			: base(table)
		{
			object xml = table.Add(XmlNamespaces.Xml);
			object xmlns = table.Add(XmlNamespaces.XmlNs);

		    if (context == null) return;

		    foreach (string prefix in context)
		    {
		        var uri = context.LookupNamespace(prefix);
		        // Use fast object reference comparison to omit forbidden namespace declarations.
		        if (Equals(uri, xml) || Equals(uri, xmlns))
		            continue;
		        if (uri == null)
		            continue;
		        base.AddNamespace(prefix, uri);
		    }
		}

		#endregion Constructors &amp; Initialization

		#region Common Overrides

		/// &lt;summary&gt;
		/// Implementation equal to &lt;see cref=&quot;XsltContext&quot;/&gt;.
		/// &lt;/summary&gt;
		public override int CompareDocument(string baseUri, string nextbaseUri)
		{
			return String.Compare(baseUri, nextbaseUri, false, System.Globalization.CultureInfo.InvariantCulture);
		}

		/// &lt;summary&gt;
		/// Same as &lt;see cref=&quot;XmlNamespaceManager&quot;/&gt;.
		/// &lt;/summary&gt;
		public override string LookupNamespace(string prefix)
		{
		    var key = NameTable.Get(prefix);
		    return key == null ? null : base.LookupNamespace(key);
		}

	    /// &lt;summary&gt;
		/// Same as &lt;see cref=&quot;XmlNamespaceManager&quot;/&gt;.
		/// &lt;/summary&gt;
		public override string LookupPrefix(string uri)
		{
		    var key = NameTable.Get(uri);
		    return key == null ? null : base.LookupPrefix(key);
		}

	    /// &lt;summary&gt;
		/// Same as &lt;see cref=&quot;XsltContext&quot;/&gt;.
		/// &lt;/summary&gt;
		public override bool PreserveWhitespace(XPathNavigator node)
		{
			return true;
		}

		/// &lt;summary&gt;
		/// Same as &lt;see cref=&quot;XsltContext&quot;/&gt;.
		/// &lt;/summary&gt;
		public override bool Whitespace
		{
			get { return true; }
		}

		#endregion Common Overrides

		#region Public Members

		/// &lt;summary&gt;
		/// Shortcut method that compiles an expression using an empty navigator.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;xpath&quot;&gt;The expression to compile&lt;/param&gt;
		/// &lt;returns&gt;A compiled &lt;see cref=&quot;XPathExpression&quot;/&gt;.&lt;/returns&gt;
		public static XPathExpression Compile(string xpath)
		{
			return new XmlDocument().CreateNavigator().Compile(xpath);
		}

		#endregion Public Members

		#region Variable Handling Code

		/// &lt;summary&gt;
		/// Adds the variable to the dynamic evaluation context.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;name&quot;&gt;The name of the variable to add to the context.&lt;/param&gt;
		/// &lt;param name=&quot;value&quot;&gt;The value of the variable to add to the context.&lt;/param&gt;
		/// &lt;remarks&gt;
		/// Value type conversion for XPath evaluation is as follows:
		/// &lt;list type=&quot;table&quot;&gt;
		///		&lt;listheader&gt;
		///			&lt;term&gt;CLR Type&lt;/term&gt;
		///			&lt;description&gt;XPath type&lt;/description&gt;
		///		&lt;/listheader&gt;
		///		&lt;item&gt;
		///			&lt;term&gt;System.String&lt;/term&gt;
		///			&lt;description&gt;XPathResultType.String&lt;/description&gt;
		///		&lt;/item&gt;
		///		&lt;item&gt;
		///			&lt;term&gt;System.Double (or types that can be converted to)&lt;/term&gt;
		///			&lt;description&gt;XPathResultType.Number&lt;/description&gt;
		///		&lt;/item&gt;
		///		&lt;item&gt;
		///			&lt;term&gt;System.Boolean&lt;/term&gt;
		///			&lt;description&gt;XPathResultType.Boolean&lt;/description&gt;
		///		&lt;/item&gt;
		///		&lt;item&gt;
		///			&lt;term&gt;System.Xml.XPath.XPathNavigator&lt;/term&gt;
		///			&lt;description&gt;XPathResultType.Navigator&lt;/description&gt;
		///		&lt;/item&gt;
		///		&lt;item&gt;
		///			&lt;term&gt;System.Xml.XPath.XPathNodeIterator&lt;/term&gt;
		///			&lt;description&gt;XPathResultType.NodeSet&lt;/description&gt;
		///		&lt;/item&gt;
		///		&lt;item&gt;
		///			&lt;term&gt;Others&lt;/term&gt;
		///			&lt;description&gt;XPathResultType.Any&lt;/description&gt;
		///		&lt;/item&gt;
		/// &lt;/list&gt;
		/// &lt;note type=&quot;note&quot;&gt;See the topic &quot;Compile, Select, Evaluate, and Matches with 
		/// XPath and XPathExpressions&quot; in MSDN documentation for additional information.&lt;/note&gt;
		/// &lt;/remarks&gt;
		/// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;The &lt;paramref name=&quot;value&quot;/&gt; is null.&lt;/exception&gt;
		public void AddVariable(string name, object value)
		{
			if (value == null) throw new ArgumentNullException(&quot;value&quot;);
			_variables[name] = new DynamicVariable(name, value);
		}

		/// &lt;summary&gt;
		/// See &lt;see cref=&quot;XsltContext&quot;/&gt;. Not used in our implementation.
		/// &lt;/summary&gt;
		public override IXsltContextFunction ResolveFunction(string prefix, string name, XPathResultType[] argTypes)
		{
			return null;
		}

		/// &lt;summary&gt;
		/// Resolves the dynamic variables added to the context. See &lt;see cref=&quot;XsltContext&quot;/&gt;. 
		/// &lt;/summary&gt;
		public override IXsltContextVariable ResolveVariable(string prefix, string name)
		{
			IXsltContextVariable var;
			_variables.TryGetValue(name, out var);
			return var;
		}

		#endregion Variable Handling Code

		#region Internal DynamicVariable class

		/// &lt;summary&gt;
		/// Represents a variable during dynamic expression execution.
		/// &lt;/summary&gt;
		internal class DynamicVariable : IXsltContextVariable
		{
		    readonly string _name;
		    readonly object _value;

			#region Public Members

            public string Name { get { return _name; } }

			/// &lt;summary&gt;
			/// Initializes a new instance of the class.
			/// &lt;/summary&gt;
			/// &lt;param name=&quot;name&quot;&gt;The name of the variable.&lt;/param&gt;
			/// &lt;param name=&quot;value&quot;&gt;The value of the variable.&lt;/param&gt;
			public DynamicVariable(string name, object value)
			{

				_name = name;
				_value = value;

				if (value is String)
					_type = XPathResultType.String;
				else if (value is bool)
					_type = XPathResultType.Boolean;
				else if (value is XPathNavigator)
					_type = XPathResultType.Navigator;
				else if (value is XPathNodeIterator)
					_type = XPathResultType.NodeSet;
				else
				{
					// Try to convert to double (native XPath numeric type)
					if (value is double)
					{
						_type = XPathResultType.Number;
					}
					else
					{
						if (value is IConvertible)
						{
							try
							{
								_value = Convert.ToDouble(value);
								// We suceeded, so it&#39;s a number.
								_type = XPathResultType.Number;
							}
							catch (FormatException)
							{
								_type = XPathResultType.Any;
							}
							catch (OverflowException)
							{
								_type = XPathResultType.Any;
							}
						}
						else
						{
							_type = XPathResultType.Any;
						}
					}
				}
			}

			#endregion Public Members

			#region IXsltContextVariable Implementation

			XPathResultType IXsltContextVariable.VariableType
			{
				get { return _type; }
			}

		    readonly XPathResultType _type;

			object IXsltContextVariable.Evaluate(XsltContext context)
			{
				return _value;
			}

			bool IXsltContextVariable.IsLocal
			{
				get { return false; }
			}

			bool IXsltContextVariable.IsParam
			{
				get { return false; }
			}

			#endregion IXsltContextVariable Implementation
		}

		#endregion Internal DynamicVariable class
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,6,25,51,1],[24,6,25,51,0],[24,6,25,51,0],[35,6,35,27,1],[36,3,36,4,1],[37,3,37,4,1],[45,6,45,17,0],[46,3,46,4,0],[47,3,47,4,0],[54,6,54,36,0],[55,3,55,4,0],[56,3,56,4,0],[64,6,64,17,0],[65,3,65,4,0],[66,4,66,46,0],[67,4,67,50,0],[69,7,69,27,0],[69,28,69,35,0],[71,7,71,14,0],[71,16,71,29,0],[71,30,71,32,0],[71,33,71,40,0],[72,7,72,8,0],[73,11,73,53,0],[75,11,75,54,0],[76,15,76,24,0],[77,11,77,27,0],[78,15,78,24,0],[79,11,79,42,0],[80,7,80,8,0],[81,3,81,4,0],[91,3,91,4,0],[92,4,92,106,0],[93,3,93,4,0],[99,3,99,4,1],[100,7,100,39,1],[101,7,101,61,1],[102,3,102,4,1],[108,3,108,4,0],[109,7,109,36,0],[110,7,110,58,0],[111,3,111,4,0],[117,3,117,4,0],[118,4,118,16,0],[119,3,119,4,0],[126,8,126,9,0],[126,10,126,22,0],[126,23,126,24,0],[139,3,139,4,0],[140,4,140,62,0],[141,3,141,4,0],[189,3,189,4,1],[190,4,190,22,1],[190,23,190,64,0],[191,4,191,56,1],[192,3,192,4,1],[198,3,198,4,0],[199,4,199,16,0],[200,3,200,4,0],[206,3,206,4,1],[208,4,208,42,1],[209,4,209,15,1],[210,3,210,4,1],[226,38,226,39,0],[226,40,226,53,0],[226,54,226,55,0],[233,4,233,53,1],[234,4,234,5,1],[236,5,236,18,1],[237,5,237,20,1],[239,5,239,25,1],[240,6,240,37,1],[241,10,241,28,0],[242,6,242,38,0],[243,10,243,38,0],[244,6,244,40,0],[245,10,245,41,0],[246,6,246,38,0],[248,5,248,6,0],[250,6,250,26,0],[251,6,251,7,0],[252,7,252,38,0],[253,6,253,7,0],[255,6,255,7,0],[256,7,256,33,0],[257,7,257,8,0],[259,8,259,9,0],[260,9,260,42,0],[262,9,262,40,0],[263,8,263,9,0],[264,8,264,31,0],[265,8,265,9,0],[266,9,266,37,0],[267,8,267,9,0],[268,8,268,33,0],[269,8,269,9,0],[270,9,270,37,0],[271,8,271,9,0],[272,7,272,8,0],[274,7,274,8,0],[275,8,275,36,0],[276,7,276,8,0],[277,6,277,7,0],[278,5,278,6,0],[279,4,279,5,1],[287,9,287,10,0],[287,11,287,24,0],[287,25,287,26,0],[293,4,293,5,1],[294,5,294,19,1],[295,4,295,5,1],[299,9,299,10,0],[299,11,299,24,0],[299,25,299,26,0],[304,9,304,10,0],[304,11,304,24,0],[304,25,304,26,0]]);
    </script>
  </body>
</html>