<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\MediaServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Services
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, RequiresSTA]
    public class MediaServiceTests : BaseServiceTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        [Test]
        public void Get_Paged_Children_With_Media_Type_Filter()
        {
            var mediaService = ServiceContext.MediaService;
            var mediaType1 = MockedContentTypes.CreateImageMediaType(&quot;Image2&quot;);
            ServiceContext.ContentTypeService.Save(mediaType1);
            var mediaType2 = MockedContentTypes.CreateImageMediaType(&quot;Image3&quot;);
            ServiceContext.ContentTypeService.Save(mediaType2);

            for (int i = 0; i &lt; 10; i++)
            {
                var m1 = MockedMedia.CreateMediaImage(mediaType1, -1);
                mediaService.Save(m1);
                var m2 = MockedMedia.CreateMediaImage(mediaType2, -1);
                mediaService.Save(m2);
            }

            long total;
            var result = ServiceContext.MediaService.GetPagedChildren(-1, 0, 11, out total, &quot;SortOrder&quot;, Direction.Ascending, true, null, new[] {mediaType1.Id, mediaType2.Id});
            Assert.AreEqual(11, result.Count());
            Assert.AreEqual(20, total);

            result = ServiceContext.MediaService.GetPagedChildren(-1, 1, 11, out total, &quot;SortOrder&quot;, Direction.Ascending, true, null, new[] { mediaType1.Id, mediaType2.Id });
            Assert.AreEqual(9, result.Count());
            Assert.AreEqual(20, total);
        }

        [Test]
        public void Can_Move_Media()
        {
            // Arrange
            var mediaItems = CreateTrashedTestMedia();
            var mediaService = ServiceContext.MediaService;
            var media = mediaService.GetById(mediaItems.Item3.Id);

            // Act
            mediaService.Move(media, mediaItems.Item2.Id);

            // Assert
            Assert.That(media.ParentId, Is.EqualTo(mediaItems.Item2.Id));
            Assert.That(media.Trashed, Is.False);
        }

        [Test]
        public void Can_Move_Media_To_RecycleBin()
        {
            // Arrange
            var mediaItems = CreateTrashedTestMedia();
            var mediaService = ServiceContext.MediaService;
            var media = mediaService.GetById(mediaItems.Item1.Id);

            // Act
            mediaService.MoveToRecycleBin(media);

            // Assert
            Assert.That(media.ParentId, Is.EqualTo(-21));
            Assert.That(media.Trashed, Is.True);
        }

        [Test]
        public void Can_Move_Media_From_RecycleBin()
        {
            // Arrange
            var mediaItems = CreateTrashedTestMedia();
            var mediaService = ServiceContext.MediaService;
            var media = mediaService.GetById(mediaItems.Item4.Id);

            // Act - moving out of recycle bin
            mediaService.Move(media, mediaItems.Item1.Id);
            var mediaChild = mediaService.GetById(mediaItems.Item5.Id);

            // Assert
            Assert.That(media.ParentId, Is.EqualTo(mediaItems.Item1.Id));
            Assert.That(media.Trashed, Is.False);
            Assert.That(mediaChild.ParentId, Is.EqualTo(mediaItems.Item4.Id));
            Assert.That(mediaChild.Trashed, Is.False);
        }

        [Test]
        public void Cannot_Save_Media_With_Empty_Name()
        {
            // Arrange
            var mediaService = ServiceContext.MediaService;
            var mediaType = MockedContentTypes.CreateVideoMediaType();
            ServiceContext.ContentTypeService.Save(mediaType);
            var media = mediaService.CreateMedia(string.Empty, -1, &quot;video&quot;);

            // Act &amp; Assert
            Assert.Throws&lt;ArgumentException&gt;(() =&gt; mediaService.Save(media));
        }

        [Test]
        public void Ensure_Content_Xml_Created()
        {
            var mediaService = ServiceContext.MediaService;
            var mediaType = MockedContentTypes.CreateVideoMediaType();
            ServiceContext.ContentTypeService.Save(mediaType);
            var media = mediaService.CreateMedia(&quot;Test&quot;, -1, &quot;video&quot;);

            mediaService.Save(media);

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var uow = provider.GetUnitOfWork();

            Assert.IsTrue(uow.Database.Exists&lt;ContentXmlDto&gt;(media.Id));

        }

        [Test]
        public void Can_Get_Media_By_Path()
        {
            var mediaService = ServiceContext.MediaService;
            var mediaType = MockedContentTypes.CreateImageMediaType(&quot;Image2&quot;);
            ServiceContext.ContentTypeService.Save(mediaType);

            var media = MockedMedia.CreateMediaImage(mediaType, -1);
            mediaService.Save(media);

            var mediaPath = &quot;/media/test-image.png&quot;;
            var resolvedMedia = mediaService.GetMediaByPath(mediaPath);
            
            Assert.IsNotNull(resolvedMedia);
            Assert.That(resolvedMedia.GetValue(Constants.Conventions.Media.File).ToString() == mediaPath);
        }

        [Test]
        public void Can_Get_Media_With_Crop_By_Path()
        {
            var mediaService = ServiceContext.MediaService;
            var mediaType = MockedContentTypes.CreateImageMediaType(&quot;Image2&quot;);
            ServiceContext.ContentTypeService.Save(mediaType);

            var media = MockedMedia.CreateMediaImageWithCrop(mediaType, -1);
            mediaService.Save(media);

            var mediaPath = &quot;/media/test-image.png&quot;;
            var resolvedMedia = mediaService.GetMediaByPath(mediaPath);

            Assert.IsNotNull(resolvedMedia);
            Assert.That(resolvedMedia.GetValue(Constants.Conventions.Media.File).ToString().Contains(mediaPath));
        }

        private Tuple&lt;IMedia, IMedia, IMedia, IMedia, IMedia&gt; CreateTrashedTestMedia()
        {
            //Create and Save folder-Media -&gt; 1050
            var folderMediaType = ServiceContext.ContentTypeService.GetMediaType(1031);
            var folder = MockedMedia.CreateMediaFolder(folderMediaType, -1);
            ServiceContext.MediaService.Save(folder);
            
            //Create and Save folder-Media -&gt; 1051
            var folder2 = MockedMedia.CreateMediaFolder(folderMediaType, -1);
            ServiceContext.MediaService.Save(folder2);
            
            //Create and Save image-Media  -&gt; 1052
            var imageMediaType = ServiceContext.ContentTypeService.GetMediaType(1032);
            var image = (Media)MockedMedia.CreateMediaImage(imageMediaType, 1050);
            ServiceContext.MediaService.Save(image);
            
            //Create and Save folder-Media that is trashed -&gt; 1053
            var folderTrashed = (Media)MockedMedia.CreateMediaFolder(folderMediaType, -21);
            folderTrashed.Trashed = true;
            ServiceContext.MediaService.Save(folderTrashed);
            
            //Create and Save image-Media child of folderTrashed -&gt; 1054            
            var imageTrashed = (Media)MockedMedia.CreateMediaImage(imageMediaType, folderTrashed.Id);
            imageTrashed.Trashed = true;
            ServiceContext.MediaService.Save(imageTrashed);


            return new Tuple&lt;IMedia, IMedia, IMedia, IMedia, IMedia&gt;(folder, folder2, image, folderTrashed, imageTrashed);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,1],[25,13,25,31,1],[26,9,26,10,1],[30,9,30,10,1],[31,13,31,29,1],[32,9,32,10,1],[36,9,36,10,1],[37,13,37,60,1],[38,13,38,80,1],[39,13,39,64,1],[40,13,40,80,1],[41,13,41,64,1],[43,18,43,27,1],[43,29,43,35,1],[43,37,43,40,1],[44,13,44,14,1],[45,17,45,71,1],[46,17,46,39,1],[47,17,47,71,1],[48,17,48,39,1],[49,13,49,14,1],[52,13,52,177,1],[53,13,53,49,1],[54,13,54,40,1],[56,13,56,175,1],[57,13,57,48,1],[58,13,58,40,1],[59,9,59,10,1],[63,9,63,10,1],[65,13,65,55,1],[66,13,66,60,1],[67,13,67,67,1],[70,13,70,59,1],[73,13,73,74,1],[74,13,74,50,1],[75,9,75,10,1],[79,9,79,10,1],[81,13,81,55,1],[82,13,82,60,1],[83,13,83,67,1],[86,13,86,50,1],[89,13,89,58,1],[90,13,90,49,1],[91,9,91,10,1],[95,9,95,10,1],[97,13,97,55,1],[98,13,98,60,1],[99,13,99,67,1],[102,13,102,59,1],[103,13,103,72,1],[106,13,106,74,1],[107,13,107,50,1],[108,13,108,79,1],[109,13,109,55,1],[110,9,110,10,1],[114,9,114,10,1],[116,13,116,60,1],[117,13,117,71,1],[118,13,118,63,1],[119,13,119,77,1],[122,13,122,52,1],[122,52,122,76,1],[122,76,122,78,1],[122,13,122,78,1],[123,9,123,10,1],[127,9,127,10,1],[128,13,128,60,1],[129,13,129,71,1],[130,13,130,63,1],[131,13,131,71,1],[133,13,133,38,1],[135,13,135,67,1],[136,13,136,48,1],[138,13,138,73,1],[140,9,140,10,1],[144,9,144,10,1],[145,13,145,60,1],[146,13,146,79,1],[147,13,147,63,1],[149,13,149,69,1],[150,13,150,38,1],[152,13,152,53,1],[153,13,153,72,1],[155,13,155,45,1],[156,13,156,107,1],[157,9,157,10,1],[161,9,161,10,1],[162,13,162,60,1],[163,13,163,79,1],[164,13,164,63,1],[166,13,166,77,1],[167,13,167,38,1],[169,13,169,53,1],[170,13,170,72,1],[172,13,172,45,1],[173,13,173,114,1],[174,9,174,10,1],[177,9,177,10,1],[179,13,179,88,1],[180,13,180,77,1],[181,13,181,54,1],[184,13,184,78,1],[185,13,185,55,1],[188,13,188,87,1],[189,13,189,83,1],[190,13,190,53,1],[193,13,193,92,1],[194,13,194,42,1],[195,13,195,61,1],[198,13,198,102,1],[199,13,199,41,1],[200,13,200,60,1],[203,13,203,123,1],[204,9,204,10,1]]);
    </script>
  </body>
</html>