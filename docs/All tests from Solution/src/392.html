<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Migrations\Upgrades\SqlCeUpgradeTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using System.Data.SqlServerCe;
using System.IO;
using Moq;
using NUnit.Framework;
using SQLCE4Umbraco;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Migrations.Upgrades
{
    [TestFixture]
    public class SqlCeUpgradeTest : BaseUpgradeTest
    {
        public override void DatabaseSpecificSetUp()
        {
            SqlSyntaxContext.SqlSyntaxProvider = new SqlCeSyntaxProvider();

            string filePath = string.Concat(Path, &quot;\\UmbracoPetaPocoTests.sdf&quot;);

            if (!File.Exists(filePath))
            {
                try
                {
                    //Delete database file before continueing                    
                    if (File.Exists(filePath))
                    {
                        File.Delete(filePath);
                    }
                }
                catch (Exception)
                {
                    //if this doesn&#39;t work we have to make sure everything is reset! otherwise
                    // well run into issues because we&#39;ve already set some things up
                    TearDown();
                    throw;
                }

                //Create the Sql CE database
                //Get the connectionstring settings from config
                var settings = ConfigurationManager.ConnectionStrings[Core.Configuration.GlobalSettings.UmbracoConnectionName];
                using (var engine = new SqlCeEngine(settings.ConnectionString))
                {
                    engine.CreateDatabase();
                }
            }
            else
            {
                TestHelper.ClearDatabase();
            }
            
        }

        public override void DatabaseSpecificTearDown()
        {
            //legacy API database connection close
            SqlCeContextGuardian.CloseBackgroundConnection();

            TestHelper.ClearDatabase();
        }

        public override ISqlSyntaxProvider GetSyntaxProvider()
        {
            return new SqlCeSyntaxProvider();
        }

        public override UmbracoDatabase GetConfiguredDatabase()
        {
            return new UmbracoDatabase(&quot;Datasource=|DataDirectory|UmbracoPetaPocoTests.sdf;Flush Interval=1;&quot;, Constants.DatabaseProviders.SqlCe, Mock.Of&lt;ILogger&gt;());
        }

        public override DatabaseProviders GetDatabaseProvider()
        {
            return DatabaseProviders.SqlServerCE;
        }

        public override string GetDatabaseSpecificSqlScript()
        {
            return SqlScripts.SqlResources.SqlCeTotal_480;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,76,1],[23,13,23,81,1],[25,13,25,40,1],[26,13,26,14,1],[28,17,28,18,1],[30,21,30,47,1],[31,21,31,22,0],[32,25,32,47,0],[33,21,33,22,0],[34,17,34,18,1],[35,17,35,34,0],[36,17,36,18,0],[39,21,39,32,0],[40,21,40,27,0],[45,17,45,128,1],[46,24,46,79,1],[47,17,47,18,1],[48,21,48,45,1],[49,17,49,18,1],[50,13,50,14,1],[52,13,52,14,0],[53,17,53,44,0],[54,13,54,14,0],[56,9,56,10,1],[59,9,59,10,1],[61,13,61,62,1],[63,13,63,40,1],[64,9,64,10,1],[67,9,67,10,1],[68,13,68,46,1],[69,9,69,10,1],[72,9,72,10,1],[73,13,73,167,1],[74,9,74,10,1],[77,9,77,10,1],[78,13,78,50,1],[79,9,79,10,1],[82,9,82,10,1],[83,13,83,59,1],[84,9,84,10,1]]);
    </script>
  </body>
</html>