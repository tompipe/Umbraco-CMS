<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\ServerRegistrationRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Cache;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Factories;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence.Repositories
{
    internal class ServerRegistrationRepository : PetaPocoRepositoryBase&lt;int, IServerRegistration&gt;, IServerRegistrationRepository
    {
        private readonly ICacheProvider _staticCache;

        public ServerRegistrationRepository(IDatabaseUnitOfWork work, ICacheProvider staticCache, ILogger logger, ISqlSyntaxProvider sqlSyntax)
            : base(work, CacheHelper.CreateDisabledCacheHelper(), logger, sqlSyntax)
        {
            _staticCache = staticCache;
        }

        protected override int PerformCount(IQuery&lt;IServerRegistration&gt; query)
        {
            throw new NotSupportedException(&quot;This repository does not support this method.&quot;);
        }

        protected override bool PerformExists(int id)
        {
            // use the underlying GetAll which force-caches all registrations
            return GetAll().Any(x =&gt; x.Id == id);
        }

        protected override IServerRegistration PerformGet(int id)
        {
            // use the underlying GetAll which force-caches all registrations
            return GetAll().FirstOrDefault(x =&gt; x.Id == id);
        }

        protected override IEnumerable&lt;IServerRegistration&gt; PerformGetAll(params int[] ids)
        {
            // we do NOT want to populate the cache on-demand, because then it might happen
            // during a ReadCommited transaction, and reading the registrations under ReadCommited
            // is NOT safe because they could be updated in the middle of the read.
            //
            // the cache is populated by ReloadCache which should only be called from methods
            // that ensure proper locking (at least, read-lock in ReadCommited) of the repo.

            var all = _staticCache.GetCacheItem&lt;IEnumerable&lt;IServerRegistration&gt;&gt;(CacheKey, Enumerable.Empty&lt;IServerRegistration&gt;);
            return ids.Length == 0 ? all : all.Where(x =&gt; ids.Contains(x.Id));
        }

        protected override IEnumerable&lt;IServerRegistration&gt; PerformGetByQuery(IQuery&lt;IServerRegistration&gt; query)
        {
            throw new NotSupportedException(&quot;This repository does not support this method.&quot;);
        }

        protected override Sql GetBaseQuery(bool isCount)
        {
            var sql = new Sql();
            sql.Select(isCount ? &quot;COUNT(*)&quot; : &quot;*&quot;)
               .From&lt;ServerRegistrationDto&gt;(SqlSyntax);
            return sql;
        }

        protected override string GetBaseWhereClause()
        {
            return &quot;id = @Id&quot;;
        }

        protected override IEnumerable&lt;string&gt; GetDeleteClauses()
        {
            var list = new List&lt;string&gt;
                {
                    &quot;DELETE FROM umbracoServer WHERE id = @Id&quot;                               
                };
            return list;
        }

        protected override Guid NodeObjectTypeId
        {
            get { throw new NotImplementedException(); }
        }

        protected override void PersistNewItem(IServerRegistration entity)
        {
            ((ServerRegistration)entity).AddingEntity();

            var factory = new ServerRegistrationFactory();
            var dto = factory.BuildDto(entity);

            var id = Convert.ToInt32(Database.Insert(dto));
            entity.Id = id;

            entity.ResetDirtyProperties();
            ReloadCache();
        }

        protected override void PersistUpdatedItem(IServerRegistration entity)
        {
            ((ServerRegistration)entity).UpdatingEntity();

            var factory = new ServerRegistrationFactory();
            var dto = factory.BuildDto(entity);

            Database.Update(dto);

            entity.ResetDirtyProperties();
            ReloadCache();
        }

        public override void PersistDeletedItem(IEntity entity)
        {
            base.PersistDeletedItem(entity);
            ReloadCache();
        }

        private static readonly string CacheKey = GetCacheTypeKey&lt;IServerRegistration&gt;() + &quot;all&quot;;

        public void ReloadCache()
        {
            var factory = new ServerRegistrationFactory();
            var all = Database.Fetch&lt;ServerRegistrationDto&gt;(&quot;WHERE id &gt; 0&quot;)
                .Select(x =&gt; factory.BuildEntity(x))
                .Cast&lt;IServerRegistration&gt;()
                .ToArray();
            _staticCache.ClearCacheItem(CacheKey);
            _staticCache.GetCacheItem(CacheKey, () =&gt; all);
        }

        public void DeactiveStaleServers(TimeSpan staleTimeout)
        {
            var timeoutDate = DateTime.Now.Subtract(staleTimeout);

            Database.Update&lt;ServerRegistrationDto&gt;(&quot;SET isActive=0, isMaster=0 WHERE lastNotifiedDate &lt; @timeoutDate&quot;, new { /*timeoutDate =*/ timeoutDate });
            ReloadCache();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,15,21,85,1],[22,9,22,10,1],[23,13,23,40,1],[24,9,24,10,1],[27,9,27,10,0],[28,13,28,94,0],[32,9,32,10,1],[34,13,34,38,1],[34,38,34,48,1],[34,48,34,50,1],[34,13,34,50,1],[35,9,35,10,1],[38,9,38,10,1],[40,13,40,49,1],[40,49,40,59,1],[40,59,40,61,1],[40,13,40,61,1],[41,9,41,10,1],[44,9,44,10,1],[52,13,52,132,1],[53,13,53,59,1],[53,59,53,77,0],[53,77,53,79,1],[53,13,53,79,1],[54,9,54,10,1],[57,9,57,10,0],[58,13,58,94,0],[62,9,62,10,0],[63,13,63,33,0],[64,13,65,56,0],[66,13,66,24,0],[67,9,67,10,0],[70,9,70,10,0],[71,13,71,31,0],[72,9,72,10,0],[75,9,75,10,1],[76,13,79,19,1],[80,13,80,25,1],[81,9,81,10,1],[85,17,85,18,0],[85,19,85,55,0],[89,9,89,10,1],[90,13,90,57,1],[92,13,92,59,1],[93,13,93,48,1],[95,13,95,60,1],[96,13,96,28,1],[98,13,98,43,1],[99,13,99,27,1],[100,9,100,10,1],[103,9,103,10,1],[104,13,104,59,1],[106,13,106,59,1],[107,13,107,48,1],[109,13,109,34,1],[111,13,111,43,1],[112,13,112,27,1],[113,9,113,10,1],[116,9,116,10,1],[117,13,117,45,1],[118,13,118,27,1],[119,9,119,10,1],[121,9,121,98,1],[124,9,124,10,1],[125,13,125,59,1],[126,13,127,30,1],[127,30,127,52,1],[127,52,129,28,1],[126,13,129,28,1],[130,13,130,51,1],[131,13,131,55,1],[131,55,131,58,1],[131,58,131,60,1],[131,13,131,60,1],[132,9,132,10,1],[135,9,135,10,0],[136,13,136,67,0],[138,13,138,159,0],[139,13,139,27,0],[140,9,140,10,0]]);
    </script>
  </body>
</html>