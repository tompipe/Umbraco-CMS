<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\AssignDomain.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Web.UI.WebControls;
using Umbraco.Web;
using umbraco.BasePages;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.language;
using umbraco.cms.businesslogic.web;

namespace umbraco.dialogs
{
    /// &lt;summary&gt;
    /// Summary description for AssignDomain.
    /// &lt;/summary&gt;
    public partial class AssignDomain : UmbracoEnsuredPage
    {
        private int _currentId;
        private int _editDomain;

        public AssignDomain()
        {
            CurrentApp = DefaultApps.content.ToString();
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            _currentId = Request.GetItemAs&lt;int&gt;(&quot;id&quot;);
            prop_domain.Text = ui.Text(&quot;assignDomain&quot;, &quot;domain&quot;, UmbracoUser);
            prop_lang.Text = ui.Text(&quot;general&quot;, &quot;language&quot;, UmbracoUser);
            pane_addnew.Text = ui.Text(&quot;assignDomain&quot;, &quot;addNew&quot;, UmbracoUser);
            pane_edit.Text = ui.Text(&quot;assignDomain&quot;, &quot;orEdit&quot;, UmbracoUser);

            if (Request.GetItemAsString(&quot;editDomain&quot;).Trim() != &quot;&quot;)
            {
                _editDomain = Request.GetItemAs&lt;int&gt;(&quot;editDomain&quot;);
            }

            if (Request.GetItemAsString(&quot;delDomain&quot;).Trim() != &quot;&quot;)
            {
                var d = new Domain(Request.GetItemAs&lt;int&gt;(&quot;delDomain&quot;));
                FeedBackMessage.type = uicontrols.Feedback.feedbacktype.success;
                FeedBackMessage.Text = ui.Text(&quot;assignDomain&quot;, &quot;domainDeleted&quot;, d.Name, UmbracoUser);
                d.Delete();
                UpdateDomainList();
            }

            if (!IsPostBack)
            {
                // Add caption to button
                ok.Text = ui.Text(&quot;assignDomain&quot;, &quot;addNew&quot;, UmbracoUser);

                var selectedLanguage = -1;

                // Maybe add editing info - not the best way this is made ;-)
                if (_editDomain &gt; 0)
                {
                    var d = new Domain(_editDomain);
                    selectedLanguage = d.Language.id;
                    DomainName.Text = d.Name.StartsWith(&quot;*&quot;) ? &quot;*&quot; : d.Name;
                    ok.Text = ui.Text(&quot;general&quot;, &quot;update&quot;, UmbracoUser);
                }

                // Add caption to language validator
                LanguageValidator.ErrorMessage = ui.Text(&quot;defaultdialogs&quot;, &quot;requiredField&quot;, UmbracoUser) + &quot;&lt;br/&gt;&quot;;
                DomainValidator.ErrorMessage = ui.Text(&quot;defaultdialogs&quot;, &quot;requiredField&quot;, UmbracoUser);

                DomainValidator2.ErrorMessage = ui.Text(&quot;assignDomain&quot;, &quot;invalidDomain&quot;, UmbracoUser);
                //DomainValidator2.ValidationExpression = @&quot;^(?i:http[s]?://)?([-\w]+(\.[-\w]+)*)(:\d+)?(/[-\w]*)?$&quot;;
                DomainValidator2.ValidationExpression = @&quot;^(\*|((?i:http[s]?://)?([-\w]+(\.[-\w]+)*)(:\d+)?(/[-\w]*)?))$&quot;;

                Languages.Items.Add(new ListItem(ui.Text(&quot;general&quot;, &quot;choose&quot;, UmbracoUser), &quot;&quot;));
                foreach (var l in Language.GetAllAsList())
                {
                    var li = new ListItem();
                    li.Text = l.FriendlyName;
                    li.Value = l.id.ToString(CultureInfo.InvariantCulture);
                    if (selectedLanguage == l.id)
                        li.Selected = true;
                    Languages.Items.Add(li);
                }
            }

            UpdateDomainList();
        }

        private void UpdateDomainList()
        {

            var domainList = Domain.GetDomainsById(_currentId);

            if (domainList.Length &gt; 0)
            {
                allDomains.Text = &quot;&lt;table border=\&quot;0\&quot; cellspacing=\&quot;10\&quot;&gt;&quot;;

                foreach (var d in domainList)
                {
                    var name = d.Name.StartsWith(&quot;*&quot;) ? &quot;*&quot; : d.Name;
                    allDomains.Text += &quot;&lt;tr&gt;&lt;td&gt;&quot; + name + &quot;&lt;/td&gt;&lt;td&gt;(&quot; + d.Language.CultureAlias + &quot;)&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;?id=&quot; + _currentId + &quot;&amp;editDomain=&quot; +
                                       d.Id.ToString(CultureInfo.InvariantCulture) + &quot;\&quot;&gt;&quot; + ui.Text(&quot;edit&quot;) + &quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;?id=&quot; + _currentId +
                                       &quot;&amp;delDomain=&quot; + d.Id.ToString(CultureInfo.InvariantCulture) + &quot;\&quot; onClick=\&quot;return confirm(&#39;&quot; +
                                       ui.Text(&quot;defaultdialogs&quot;, &quot;confirmdelete&quot;, UmbracoUser) +
                                       &quot;&#39;);\&quot; style=\&quot;color: red\&quot;&gt;&quot; + ui.Text(&quot;delete&quot;) + &quot;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&quot;;
                }

                allDomains.Text += &quot;&lt;/table&gt;&quot;;
                pane_edit.Visible = true;
            }
            else
            {
                pane_edit.Visible = false;
            }
        }

        protected void SaveDomain(object sender, EventArgs e)
        {
            if (Page.IsValid)
            {
                if (_editDomain &gt; 0)
                {
                    var d = new Domain(_editDomain);
                    d.Language = new Language(int.Parse(Languages.SelectedValue));
                    d.Name = DomainName.Text.ToLower();
                    FeedBackMessage.type = uicontrols.Feedback.feedbacktype.success;
                    FeedBackMessage.Text = ui.Text(&quot;assignDomain&quot;, &quot;domainUpdated&quot;, DomainName.Text, UmbracoUser);
                    d.Save();

                    DomainName.Text = &quot;&quot;;
                    Languages.SelectedIndex = 0;
                    UpdateDomainList();

                    //this is probably the worst webform I&#39;ve ever seen... 
                    Response.Redirect(&quot;AssignDomain.aspx?id=&quot; + _currentId.ToString());
                }
                else
                {
                    // have to handle wildcard
                    var domainName = DomainName.Text.Trim();
                    domainName = domainName == &quot;*&quot; ? (&quot;*&quot; + _currentId.ToString(CultureInfo.InvariantCulture)) : domainName;

                    if (!Domain.Exists(domainName.ToLower()))
                    {
                        Domain.MakeNew(domainName, _currentId, int.Parse(Languages.SelectedValue));
                        FeedBackMessage.Text = ui.Text(&quot;assignDomain&quot;, &quot;domainCreated&quot;, domainName, UmbracoUser);
                        FeedBackMessage.type = uicontrols.Feedback.feedbacktype.success;

                        DomainName.Text = &quot;&quot;;
                        Languages.SelectedIndex = 0;
                        UpdateDomainList();

                        //this is probably the worst webform I&#39;ve ever seen... 
                        Response.Redirect(&quot;AssignDomain.aspx?id=&quot; + _currentId.ToString());
                    }
                    else
                    {
                        FeedBackMessage.Text = ui.Text(&quot;assignDomain&quot;, &quot;domainExists&quot;, DomainName.Text.Trim(), UmbracoUser);
                        FeedBackMessage.type = uicontrols.Feedback.feedbacktype.error;
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// FeedBackMessage control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.Feedback FeedBackMessage;

        /// &lt;summary&gt;
        /// pane_addnew control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.Pane pane_addnew;

        /// &lt;summary&gt;
        /// prop_domain control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.PropertyPanel prop_domain;

        /// &lt;summary&gt;
        /// DomainName control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.TextBox DomainName;

        /// &lt;summary&gt;
        /// DomainValidator control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.RequiredFieldValidator DomainValidator;

        /// &lt;summary&gt;
        /// DomainValidator2 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.RegularExpressionValidator DomainValidator2;

        /// &lt;summary&gt;
        /// prop_lang control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.PropertyPanel prop_lang;

        /// &lt;summary&gt;
        /// Languages control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.DropDownList Languages;

        /// &lt;summary&gt;
        /// LanguageValidator control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.RequiredFieldValidator LanguageValidator;

        /// &lt;summary&gt;
        /// ok control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Button ok;

        /// &lt;summary&gt;
        /// pane_edit control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.Pane pane_edit;

        /// &lt;summary&gt;
        /// allDomains control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Literal allDomains;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,30,0],[21,9,21,10,0],[22,13,22,57,0],[23,9,23,10,0],[26,9,26,10,0],[27,13,27,55,0],[28,13,28,79,0],[29,13,29,74,0],[30,13,30,79,0],[31,13,31,77,0],[33,13,33,68,0],[34,13,34,14,0],[35,17,35,68,0],[36,13,36,14,0],[38,13,38,67,0],[39,13,39,14,0],[40,17,40,73,0],[41,17,41,81,0],[42,17,42,102,0],[43,17,43,28,0],[44,17,44,36,0],[45,13,45,14,0],[47,13,47,29,0],[48,13,48,14,0],[50,17,50,74,0],[52,17,52,43,0],[55,17,55,37,0],[56,17,56,18,0],[57,21,57,53,0],[58,21,58,54,0],[59,21,59,77,0],[60,21,60,73,0],[61,17,61,18,0],[64,17,64,116,0],[65,17,65,104,0],[67,17,67,103,0],[69,17,69,123,0],[71,17,71,98,0],[72,17,72,24,0],[72,26,72,31,0],[72,32,72,34,0],[72,35,72,58,0],[73,17,73,18,0],[74,21,74,45,0],[75,21,75,46,0],[76,21,76,76,0],[77,21,77,50,0],[78,25,78,44,0],[79,21,79,45,0],[80,17,80,18,0],[81,13,81,14,0],[83,13,83,32,0],[84,9,84,10,0],[87,9,87,10,0],[89,13,89,64,0],[91,13,91,39,0],[92,13,92,14,0],[93,17,93,77,0],[95,17,95,24,0],[95,26,95,31,0],[95,32,95,34,0],[95,35,95,45,0],[96,17,96,18,0],[97,21,97,70,0],[98,21,102,109,0],[103,17,103,18,0],[105,17,105,47,0],[106,17,106,42,0],[107,13,107,14,0],[109,13,109,14,0],[110,17,110,43,0],[111,13,111,14,0],[112,9,112,10,0],[115,9,115,10,0],[116,13,116,30,0],[117,13,117,14,0],[118,17,118,37,0],[119,17,119,18,0],[120,21,120,53,0],[121,21,121,83,0],[122,21,122,56,0],[123,21,123,85,0],[124,21,124,115,0],[125,21,125,30,0],[127,21,127,42,0],[128,21,128,49,0],[129,21,129,40,0],[132,21,132,88,0],[133,17,133,18,0],[135,17,135,18,0],[137,21,137,61,0],[138,21,138,125,0],[140,21,140,62,0],[141,21,141,22,0],[142,25,142,100,0],[143,25,143,114,0],[144,25,144,89,0],[146,25,146,46,0],[147,25,147,53,0],[148,25,148,44,0],[151,25,151,92,0],[152,21,152,22,0],[154,21,154,22,0],[155,25,155,125,0],[156,25,156,87,0],[157,21,157,22,0],[158,17,158,18,0],[159,13,159,14,0],[160,9,160,10,0]]);
    </script>
  </body>
</html>