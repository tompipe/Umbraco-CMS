<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\translation\default.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Globalization;
using System.IO;
using System.Text;
using System.Xml;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Web;
using umbraco.BasePages;
using umbraco.BusinessLogic;
using umbraco.BusinessLogic.Actions;
using umbraco.cms.businesslogic.propertytype;
using umbraco.cms.businesslogic.task;
using umbraco.cms.businesslogic.translation;
//using umbraco.cms.businesslogic.utilities;
using umbraco.cms.businesslogic.web;

using ICSharpCode.SharpZipLib.BZip2;
using ICSharpCode.SharpZipLib.Zip;
using ICSharpCode.SharpZipLib.Zip.Compression;
using ICSharpCode.SharpZipLib.Zip.Compression.Streams;
using ICSharpCode.SharpZipLib.GZip;
using Umbraco.Core.IO;
using System.Collections.Generic;

namespace umbraco.presentation.translation
{
    public partial class _default : UmbracoEnsuredPage
    {
        public _default()
        {
            CurrentApp = DefaultApps.translation.ToString();

        }
        protected void Page_Load(object sender, EventArgs e)
        {
            DataTable tasks = new DataTable();
            tasks.Columns.Add(&quot;Id&quot;);
            tasks.Columns.Add(&quot;Date&quot;);
            tasks.Columns.Add(&quot;NodeId&quot;);
            tasks.Columns.Add(&quot;NodeName&quot;);
            tasks.Columns.Add(&quot;ReferingUser&quot;);
            tasks.Columns.Add(&quot;Language&quot;);

            taskList.Columns[0].HeaderText = ui.Text(&quot;nodeName&quot;);
            taskList.Columns[1].HeaderText = ui.Text(&quot;translation&quot;, &quot;taskAssignedBy&quot;);
            taskList.Columns[2].HeaderText = ui.Text(&quot;date&quot;);

            ((System.Web.UI.WebControls.HyperLinkField)taskList.Columns[3]).Text = ui.Text(&quot;translation&quot;, &quot;details&quot;);
            ((System.Web.UI.WebControls.HyperLinkField)taskList.Columns[4]).Text = ui.Text(&quot;translation&quot;, &quot;downloadTaskAsXml&quot;);

            Tasks ts = new Tasks();
            if (Request[&quot;mode&quot;] == &quot;owned&quot;)
            {
                ts = Task.GetOwnedTasks(base.getUser(), false);
                pane_tasks.Text = ui.Text(&quot;translation&quot;, &quot;ownedTasks&quot;);
                Panel2.Text = ui.Text(&quot;translation&quot;, &quot;ownedTasks&quot;);
            }
            else
            {
                ts = Task.GetTasks(base.getUser(), false);
                pane_tasks.Text = ui.Text(&quot;translation&quot;, &quot;assignedTasks&quot;);
                Panel2.Text = ui.Text(&quot;translation&quot;, &quot;assignedTasks&quot;);
            }

            uploadFile.Text = ui.Text(&quot;upload&quot;);
            pane_uploadFile.Text = ui.Text(&quot;translation&quot;, &quot;uploadTranslationXml&quot;);

            foreach (Task t in ts)
            {
                if (t.Type.Alias == &quot;toTranslate&quot;)
                {
                    DataRow task = tasks.NewRow();
                    task[&quot;Id&quot;] = t.Id;
                    task[&quot;Date&quot;] = t.Date;
                    task[&quot;NodeId&quot;] = t.Node.Id;
                    task[&quot;NodeName&quot;] = t.Node.Text;
                    task[&quot;ReferingUser&quot;] = t.ParentUser.Name;
                    tasks.Rows.Add(task);
                }
            }

            taskList.DataSource = tasks;
            taskList.DataBind();
            feedback.Style.Add(&quot;margin-top&quot;, &quot;10px&quot;);

        }

        protected void uploadFile_Click(object sender, EventArgs e)
        {
            // Save temp file
            if (translationFile.PostedFile != null)
            {
                string tempFileName;
                if (translationFile.PostedFile.FileName.ToLower().Contains(&quot;.zip&quot;))
                    tempFileName = IOHelper.MapPath(SystemDirectories.Data + &quot;/&quot; + &quot;translationFile_&quot; + Guid.NewGuid().ToString() + &quot;.zip&quot;);
                else
                    tempFileName = IOHelper.MapPath(SystemDirectories.Data + &quot;/&quot; + &quot;translationFile_&quot; + Guid.NewGuid().ToString() + &quot;.xml&quot;);

                translationFile.PostedFile.SaveAs(tempFileName);

                // xml or zip file
                if (new FileInfo(tempFileName).Extension.ToLower() == &quot;.zip&quot;)
                {
                    // Zip Directory
                    string tempPath = IOHelper.MapPath(SystemDirectories.Data + &quot;/&quot; + &quot;translationFiles_&quot; + Guid.NewGuid().ToString());

                    // Add the path to the zipfile to viewstate
                    ViewState.Add(&quot;zipFile&quot;, tempPath);

                    // Unpack the zip file

                    cms.businesslogic.utilities.Zip.UnPack(tempFileName, tempPath, true);

                    // Test the number of xml files
                    try
                    {
                        StringBuilder sb = new StringBuilder();
                        foreach (FileInfo translationFileXml in new DirectoryInfo(ViewState[&quot;zipFile&quot;].ToString()).GetFiles(&quot;*.xml&quot;))
                        {
                            try
                            {
                                foreach (Task translation in ImportTranslatationFile(translationFileXml.FullName))
                                {

                                    sb.Append(&quot;&lt;li&gt;&quot; + translation.Node.Text + &quot; &lt;a target=\&quot;_blank\&quot; href=\&quot;preview.aspx?id=&quot; + translation.Id + &quot;\&quot;&gt;&quot; + ui.Text(&quot;preview&quot;) + &quot;&lt;/a&gt;&lt;/li&gt;&quot;);
                                }
                            }
                            catch (Exception ee)
                            {
                                sb.Append(&quot;&lt;li style=\&quot;color: red;\&quot;&gt;&quot; + ee.ToString() + &quot;&lt;/li&gt;&quot;);
                            }
                        }

                        feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.success;
                        feedback.Text = &quot;&lt;h3&gt;&quot; + ui.Text(&quot;translation&quot;, &quot;MultipleTranslationDone&quot;) + &quot;&lt;/h3&gt;&lt;p&gt;&quot; + ui.Text(&quot;translation&quot;, &quot;translationDoneHelp&quot;) + &quot;&lt;/p&gt;&lt;ul&gt;&quot; + sb.ToString() + &quot;&lt;/ul&gt;&quot;;
                    }
                    catch (Exception ex)
                    {
                        feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.error;
                        feedback.Text = &quot;&lt;h3&gt;&quot; + ui.Text(&quot;translation&quot;, &quot;translationFailed&quot;) + &quot;&lt;/h3&gt;&lt;p&gt;&quot; + ex.ToString() + &quot;&lt;/&gt;&quot;;
                    }
                }
                else
                {
                    StringBuilder sb = new StringBuilder();
                    List&lt;Task&gt; l = ImportTranslatationFile(tempFileName);

                    if (l.Count == 1)
                    {
                        feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.success;
                        feedback.Text = &quot;&lt;h3&gt;&quot; + ui.Text(&quot;translation&quot;, &quot;translationDone&quot;) + &quot;&lt;/h3&gt;&lt;p&gt;&quot; + ui.Text(&quot;translation&quot;, &quot;translationDoneHelp&quot;) + &quot;&lt;/p&gt;&lt;p&gt;&lt;a target=\&quot;_blank\&quot; href=\&quot;preview.aspx?id=&quot; + l[0].Id + &quot;\&quot;&gt;&quot; + ui.Text(&quot;preview&quot;) + &quot;&lt;/a&gt;&lt;/p&gt;&quot;;
                    }

                    else
                    {
                        foreach (Task t in l)
                        {
                            sb.Append(&quot;&lt;li&gt;&quot; + t.Node.Text + &quot; &lt;a target=\&quot;_blank\&quot; href=\&quot;preview.aspx?id=&quot; + t.Id + &quot;\&quot;&gt;&quot; + ui.Text(&quot;preview&quot;) + &quot;&lt;/a&gt;&lt;/li&gt;&quot;);
                        }

                        feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.success;
                        feedback.Text = &quot;&lt;h3&gt;&quot; + ui.Text(&quot;translation&quot;, &quot;MultipleTranslationDone&quot;) + &quot;&lt;/h3&gt;&lt;p&gt;&quot; + ui.Text(&quot;translation&quot;, &quot;translationDoneHelp&quot;) + &quot;&lt;/p&gt;&lt;ul&gt;&quot; + sb.ToString() + &quot;&lt;/ul&gt;&quot;;
                    }
                }

                // clean up
                File.Delete(tempFileName);
            }
        }

        private List&lt;Task&gt; ImportTranslatationFile(string tempFileName)
        {
            try
            {
                List&lt;Task&gt; tl = new List&lt;Task&gt;();

                // open file
                XmlDocument tf = new XmlDocument();
                tf.XmlResolver = null;
                tf.Load(tempFileName);

                // Get task xml node
                XmlNodeList tasks = tf.SelectNodes(&quot;//task&quot;);

                foreach (XmlNode taskXml in tasks)
                {
                    string xpath = UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema ? &quot;node&quot; : &quot;* [@isDoc]&quot;;
                    XmlNode taskNode = taskXml.SelectSingleNode(xpath);

                    // validate file
                    Task t = new Task(int.Parse(taskXml.Attributes.GetNamedItem(&quot;Id&quot;).Value));
                    if (t != null)
                    {
                        //user auth and content node validation
                        if (t.Node.Id == int.Parse(taskNode.Attributes.GetNamedItem(&quot;id&quot;).Value) &amp;&amp; (t.User.Id == UmbracoUser.Id || t.ParentUser.Id == UmbracoUser.Id))
                        {

                            // update node contents
                            var d = new Document(t.Node.Id);
                            Document.Import(d.ParentId, UmbracoUser, (XmlElement)taskNode);

                            //send notifications! TODO: This should be put somewhere centralized instead of hard coded directly here
                            ApplicationContext.Services.NotificationService.SendNotification(d.ContentEntity, ActionTranslate.Instance, ApplicationContext);

                            t.Closed = true;
                            t.Save();


                            tl.Add(t);
                        }
                    }
                }

                return tl;
            }
            catch (Exception ee)
            {
                throw new Exception(&quot;Error importing translation file &#39;&quot; + tempFileName + &quot;&#39;: &quot; + ee.ToString());
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,9,32,26,0],[33,9,33,10,0],[34,13,34,61,0],[36,9,36,10,0],[38,9,38,10,0],[39,13,39,47,0],[40,13,40,37,0],[41,13,41,39,0],[42,13,42,41,0],[43,13,43,43,0],[44,13,44,47,0],[45,13,45,43,0],[47,13,47,66,0],[48,13,48,87,0],[49,13,49,62,0],[51,13,51,118,0],[52,13,52,128,0],[54,13,54,36,0],[55,13,55,44,0],[56,13,56,14,0],[57,17,57,64,0],[58,17,58,72,0],[59,17,59,68,0],[60,13,60,14,0],[62,13,62,14,0],[63,17,63,59,0],[64,17,64,75,0],[65,17,65,71,0],[66,13,66,14,0],[68,13,68,49,0],[69,13,69,83,0],[71,13,71,20,0],[71,22,71,28,0],[71,29,71,31,0],[71,32,71,34,0],[72,13,72,14,0],[73,17,73,51,0],[74,17,74,18,0],[75,21,75,51,0],[76,21,76,39,0],[77,21,77,43,0],[78,21,78,48,0],[79,21,79,52,0],[80,21,80,62,0],[81,21,81,42,0],[82,17,82,18,0],[83,13,83,14,0],[85,13,85,41,0],[86,13,86,33,0],[87,13,87,54,0],[89,9,89,10,0],[92,9,92,10,0],[94,13,94,52,0],[95,13,95,14,0],[97,17,97,84,0],[98,21,98,141,0],[100,21,100,141,0],[102,17,102,65,0],[105,17,105,78,0],[106,17,106,18,0],[108,21,108,136,0],[111,21,111,56,0],[115,21,115,90,0],[119,21,119,22,0],[120,25,120,64,0],[121,25,121,32,0],[121,34,121,61,0],[121,62,121,64,0],[121,65,121,133,0],[122,25,122,26,0],[124,29,124,30,0],[125,33,125,40,0],[125,42,125,58,0],[125,59,125,61,0],[125,62,125,114,0],[126,33,126,34,0],[128,37,128,189,0],[129,33,129,34,0],[130,29,130,30,0],[131,29,131,49,0],[132,29,132,30,0],[133,33,133,99,0],[134,29,134,30,0],[135,25,135,26,0],[137,25,137,98,0],[138,25,138,200,0],[139,21,139,22,0],[140,21,140,41,0],[141,21,141,22,0],[142,25,142,96,0],[143,25,143,131,0],[144,21,144,22,0],[145,17,145,18,0],[147,17,147,18,0],[148,21,148,60,0],[149,21,149,74,0],[151,21,151,38,0],[152,21,152,22,0],[153,25,153,98,0],[154,25,154,261,0],[155,21,155,22,0],[158,21,158,22,0],[159,25,159,32,0],[159,34,159,40,0],[159,41,159,43,0],[159,44,159,45,0],[160,25,160,26,0],[161,29,161,161,0],[162,25,162,26,0],[164,25,164,98,0],[165,25,165,200,0],[166,21,166,22,0],[167,17,167,18,0],[170,17,170,43,0],[171,13,171,14,0],[172,9,172,10,0],[175,9,175,10,0],[177,13,177,14,0],[178,17,178,50,0],[181,17,181,52,0],[182,17,182,39,0],[183,17,183,39,0],[186,17,186,62,0],[188,17,188,24,0],[188,26,188,41,0],[188,42,188,44,0],[188,45,188,50,0],[189,17,189,18,0],[190,21,190,123,0],[191,21,191,72,0],[194,21,194,95,0],[195,21,195,35,0],[196,21,196,22,0],[198,25,198,168,0],[199,25,199,26,0],[202,29,202,61,0],[203,29,203,92,0],[206,29,206,157,0],[208,29,208,45,0],[209,29,209,38,0],[212,29,212,39,0],[213,25,213,26,0],[214,21,214,22,0],[215,17,215,18,0],[217,17,217,27,0],[219,13,219,33,0],[220,13,220,14,0],[221,17,221,114,0],[223,9,223,10,0]]);
    </script>
  </body>
</html>