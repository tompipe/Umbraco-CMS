<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebApi\Filters\FileUploadCleanupFilterAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Web.Http.Filters;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Web.Models.ContentEditing;
using File = System.IO.File;

namespace Umbraco.Web.WebApi.Filters
{
    /// &lt;summary&gt;
    /// Checks if the parameter is ContentItemSave and then deletes any temporary saved files from file uploads associated with the request
    /// &lt;/summary&gt;
    internal sealed class FileUploadCleanupFilterAttribute : ActionFilterAttribute
    {
        private readonly bool _incomingModel;

        /// &lt;summary&gt;
        /// Constructor specifies if the filter should analyze the incoming or outgoing model
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;incomingModel&quot;&gt;&lt;/param&gt;
        public FileUploadCleanupFilterAttribute(bool incomingModel = true)
        {
            _incomingModel = incomingModel;
        }

        /// &lt;summary&gt;
        /// Returns true so that other filters can execute along with this one
        /// &lt;/summary&gt;
        public override bool AllowMultiple
        {
            get { return true; }
        }

        public override void OnActionExecuted(HttpActionExecutedContext actionExecutedContext)
        {
            base.OnActionExecuted(actionExecutedContext);

            var tempFolders = new List&lt;string&gt;();

            if (_incomingModel)
            {
                if (actionExecutedContext.ActionContext.ActionArguments.Any())
                {
                    var contentItem = actionExecutedContext.ActionContext.ActionArguments.First().Value as IHaveUploadedFiles;
                    if (contentItem != null)
                    {
                        //cleanup any files associated
                        foreach (var f in contentItem.UploadedFiles)
                        {
                            //track all temp folders so we can remove old files afterwords
                            var dir = Path.GetDirectoryName(f.TempFilePath);
                            if (tempFolders.Contains(dir) == false)
                            {
                                tempFolders.Add(dir);
                            }

                            try
                            {
                                File.Delete(f.TempFilePath);
                            }
                            catch (System.Exception ex)
                            {
                                LogHelper.Error&lt;FileUploadCleanupFilterAttribute&gt;(&quot;Could not delete temp file &quot; + f.TempFilePath, ex);
                            }
                        }
                    }
                }
            }
            else
            {
                if (actionExecutedContext == null)
                {
                    LogHelper.Warn&lt;FileUploadCleanupFilterAttribute&gt;(&quot;The actionExecutedContext is null!!??&quot;);
                    return;
                }
                if (actionExecutedContext.Request == null)
                {
                    LogHelper.Warn&lt;FileUploadCleanupFilterAttribute&gt;(&quot;The actionExecutedContext.Request is null!!??&quot;);
                    return;
                }
                if (actionExecutedContext.Request.Content == null)
                {
                    LogHelper.Warn&lt;FileUploadCleanupFilterAttribute&gt;(&quot;The actionExecutedContext.Request.Content is null!!??&quot;);
                    return;
                }

                ObjectContent objectContent;
                
                try
                {
                    objectContent = actionExecutedContext.Response.Content as ObjectContent;
                }
                catch (System.Exception ex)
                {
                    LogHelper.Error&lt;FileUploadCleanupFilterAttribute&gt;(&quot;Could not acquire actionExecutedContext.Response.Content&quot;, ex);
                    return;
                }

                if (objectContent != null)
                {
                    var uploadedFiles = objectContent.Value as IHaveUploadedFiles;
                    if (uploadedFiles != null)
                    {
                        if (uploadedFiles.UploadedFiles != null)
                        {
                            //cleanup any files associated
                            foreach (var f in uploadedFiles.UploadedFiles)
                            {
                                if (f.TempFilePath.IsNullOrWhiteSpace() == false)
                                {
                                    //track all temp folders so we can remove old files afterwords
                                    var dir = Path.GetDirectoryName(f.TempFilePath);
                                    if (tempFolders.Contains(dir) == false)
                                    {
                                        tempFolders.Add(dir);
                                    }

                                    LogHelper.Debug&lt;FileUploadCleanupFilterAttribute&gt;(&quot;Removing temp file &quot; + f.TempFilePath);

                                    try
                                    {
                                        File.Delete(f.TempFilePath);
                                    }
                                    catch (System.Exception ex)
                                    {
                                        LogHelper.Error&lt;FileUploadCleanupFilterAttribute&gt;(&quot;Could not delete temp file &quot; + f.TempFilePath, ex);
                                    }

                                    //clear out the temp path so it&#39;s not returned in the response
                                    f.TempFilePath = &quot;&quot;;
                                }
                                else
                                {
                                    LogHelper.Warn&lt;FileUploadCleanupFilterAttribute&gt;(&quot;The f.TempFilePath is null or whitespace!!??&quot;);   
                                }
                            }
                        }
                        else
                        {
                            LogHelper.Warn&lt;FileUploadCleanupFilterAttribute&gt;(&quot;The uploadedFiles.UploadedFiles is null!!??&quot;);   
                        }                        
                    }
                    else
                    {
                        LogHelper.Warn&lt;FileUploadCleanupFilterAttribute&gt;(&quot;The actionExecutedContext.Request.Content.Value is not IHaveUploadedFiles, it is &quot; + objectContent.Value.GetType());
                    }
                }
                else
                {
                    LogHelper.Warn&lt;FileUploadCleanupFilterAttribute&gt;(&quot;The actionExecutedContext.Request.Content is not ObjectContent, it is &quot; + actionExecutedContext.Request.Content.GetType());
                }
            }

            //Now remove all old files so that the temp folder(s) never grow
            foreach (var tempFolder in tempFolders.Distinct())
            {
                var files = Directory.GetFiles(tempFolder);
                foreach (var file in files)
                {
                    if (DateTime.UtcNow - File.GetLastWriteTimeUtc(file) &gt; TimeSpan.FromDays(1))
                    {
                        try
                        {
                            File.Delete(file);
                        }
                        catch (System.Exception ex)
                        {
                            LogHelper.Error&lt;FileUploadCleanupFilterAttribute&gt;(&quot;Could not delete temp file &quot; + file, ex);
                        }
                    }
                }

            }
            
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,75,0],[27,9,27,10,0],[28,13,28,44,0],[29,9,29,10,0],[36,17,36,18,0],[36,19,36,31,0],[36,32,36,33,0],[40,9,40,10,0],[41,13,41,58,0],[43,13,43,50,0],[45,13,45,32,0],[46,13,46,14,0],[47,17,47,79,0],[48,17,48,18,0],[49,21,49,127,0],[50,21,50,45,0],[51,21,51,22,0],[53,25,53,32,0],[53,34,53,39,0],[53,40,53,42,0],[53,43,53,68,0],[54,25,54,26,0],[56,29,56,77,0],[57,29,57,68,0],[58,29,58,30,0],[59,33,59,54,0],[60,29,60,30,0],[63,29,63,30,0],[64,33,64,61,0],[65,29,65,30,0],[66,29,66,56,0],[67,29,67,30,0],[68,33,68,135,0],[69,29,69,30,0],[70,25,70,26,0],[71,21,71,22,0],[72,17,72,18,0],[73,13,73,14,0],[75,13,75,14,0],[76,17,76,51,0],[77,17,77,18,0],[78,21,78,111,0],[79,21,79,28,0],[81,17,81,59,0],[82,17,82,18,0],[83,21,83,119,0],[84,21,84,28,0],[86,17,86,67,0],[87,17,87,18,0],[88,21,88,127,0],[89,21,89,28,0],[95,17,95,18,0],[96,21,96,93,0],[97,17,97,18,0],[98,17,98,44,0],[99,17,99,18,0],[100,21,100,135,0],[101,21,101,28,0],[104,17,104,43,0],[105,17,105,18,0],[106,21,106,83,0],[107,21,107,47,0],[108,21,108,22,0],[109,25,109,65,0],[110,25,110,26,0],[112,29,112,36,0],[112,38,112,43,0],[112,44,112,46,0],[112,47,112,74,0],[113,29,113,30,0],[114,33,114,82,0],[115,33,115,34,0],[117,37,117,85,0],[118,37,118,76,0],[119,37,119,38,0],[120,41,120,62,0],[121,37,121,38,0],[123,37,123,127,0],[126,37,126,38,0],[127,41,127,69,0],[128,37,128,38,0],[129,37,129,64,0],[130,37,130,38,0],[131,41,131,143,0],[132,37,132,38,0],[135,37,135,57,0],[136,33,136,34,0],[138,33,138,34,0],[139,37,139,134,0],[140,33,140,34,0],[141,29,141,30,0],[142,25,142,26,0],[144,25,144,26,0],[145,29,145,125,0],[146,25,146,26,0],[147,21,147,22,0],[149,21,149,22,0],[150,25,150,191,0],[151,21,151,22,0],[152,17,152,18,0],[154,17,154,18,0],[155,21,155,194,0],[156,17,156,18,0],[157,13,157,14,0],[160,13,160,20,0],[160,22,160,36,0],[160,37,160,39,0],[160,40,160,62,0],[161,13,161,14,0],[162,17,162,60,0],[163,17,163,24,0],[163,26,163,34,0],[163,35,163,37,0],[163,38,163,43,0],[164,17,164,18,0],[165,21,165,97,0],[166,21,166,22,0],[168,25,168,26,0],[169,29,169,47,0],[170,25,170,26,0],[171,25,171,52,0],[172,25,172,26,0],[173,29,173,121,0],[174,25,174,26,0],[175,21,175,22,0],[176,17,176,18,0],[178,13,178,14,0],[180,9,180,10,0]]);
    </script>
  </body>
</html>