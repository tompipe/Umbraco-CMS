<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Mappers\MappingResolver.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;

namespace Umbraco.Core.Persistence.Mappers
{
    internal class MappingResolver : LazyManyObjectsResolverBase&lt;MappingResolver, BaseMapper&gt;
    {
        /// &lt;summary&gt;
        /// Constructor accepting a list of BaseMapper types that are attributed with the MapperFor attribute
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;serviceProvider&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;logger&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;assignedMapperTypes&quot;&gt;&lt;/param&gt;
        public MappingResolver(IServiceProvider serviceProvider, ILogger logger, Func&lt;IEnumerable&lt;Type&gt;&gt; assignedMapperTypes)
            : base(serviceProvider, logger, assignedMapperTypes)
        {
            
        }

        /// &lt;summary&gt;
        /// Caches the type -&gt; mapper so that we don&#39;t have to type check each time we want one or lookup the attribute
        /// &lt;/summary&gt;
        private readonly ConcurrentDictionary&lt;Type, BaseMapper&gt; _mapperCache = new ConcurrentDictionary&lt;Type, BaseMapper&gt;();

        /// &lt;summary&gt;
        /// Return a mapper by type
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public virtual BaseMapper ResolveMapperByType(Type type)
        {
            return _mapperCache.GetOrAdd(type, type1 =&gt;
                {
                    
                    //first check if we can resolve it by attribute

                    var byAttribute = TryGetMapperByAttribute(type);
                    if (byAttribute.Success)
                    {
                        return byAttribute.Result;
                    }
                    throw new Exception(&quot;Invalid Type: A Mapper could not be resolved based on the passed in Type &quot; + type);
                });
        }

        /// &lt;summary&gt;
        /// Check the entity type to see if it has a mapper attribute assigned and try to instantiate it
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;entityType&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private Attempt&lt;BaseMapper&gt; TryGetMapperByAttribute(Type entityType)
        {            
            //check if any of the mappers are assigned to this type
            var mapper = Values.FirstOrDefault(
                x =&gt; x.GetType().GetCustomAttributes&lt;MapperForAttribute&gt;(false)
                      .Any(m =&gt; m.EntityType == entityType));

            if (mapper == null)
            {
                return Attempt&lt;BaseMapper&gt;.Fail();
            }

            return Attempt&lt;BaseMapper&gt;.Succeed(mapper);
        }  

        public virtual string GetMapping(Type type, string propertyName)
        {
            var mapper = ResolveMapperByType(type);
            var result = mapper.Map(propertyName);
            if(string.IsNullOrEmpty(result))
                throw new Exception(&quot;Invalid mapping: The passed in property name could not be mapped using the passed in type&quot;);

            return result;
        }

    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,15,19,65,1],[20,9,20,10,1],[22,9,22,10,1],[27,9,27,125,1],[35,9,35,10,1],[36,13,37,17,1],[37,17,37,18,1],[37,18,41,21,1],[41,21,41,69,1],[41,69,42,21,1],[42,21,42,45,1],[42,45,43,21,1],[43,21,43,22,1],[43,22,44,25,1],[44,25,44,51,1],[44,51,46,21,1],[46,21,46,125,0],[46,125,47,17,1],[47,17,47,18,1],[47,18,47,20,1],[36,13,47,20,1],[48,9,48,10,1],[56,9,56,10,1],[58,13,59,22,1],[59,22,60,33,1],[60,33,60,59,1],[60,59,60,60,1],[59,22,60,60,1],[60,60,60,62,1],[58,13,60,62,1],[62,13,62,32,1],[63,13,63,14,0],[64,17,64,51,0],[67,13,67,56,1],[68,9,68,10,1],[71,9,71,10,1],[72,13,72,52,1],[73,13,73,51,1],[74,13,74,45,1],[75,17,75,130,0],[77,13,77,27,1],[78,9,78,10,1]]);
    </script>
  </body>
</html>