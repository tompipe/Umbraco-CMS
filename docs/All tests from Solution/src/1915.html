<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\MemberFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;

namespace Umbraco.Core.Persistence.Factories
{
    internal class MemberFactory
    {
        private readonly IMemberType _contentType;
        private readonly Guid _nodeObjectTypeId;
        private readonly int _id;
        private int _primaryKey;

        public MemberFactory(IMemberType contentType, Guid nodeObjectTypeId, int id)
        {
            _contentType = contentType;
            _nodeObjectTypeId = nodeObjectTypeId;
            _id = id;
        }

        public MemberFactory(Guid nodeObjectTypeId, int id)
        {
            _nodeObjectTypeId = nodeObjectTypeId;
            _id = id;
        }

        #region Implementation of IEntityFactory&lt;IMedia,ContentVersionDto&gt;

        public static IMember BuildEntity(MemberDto dto, IMemberType contentType)
        {
            var member = new Member(
                dto.ContentVersionDto.ContentDto.NodeDto.Text,
                dto.Email, dto.LoginName, dto.Password, contentType);

            try
            {
                member.DisableChangeTracking();

                member.Id = dto.NodeId;
                member.Key = dto.ContentVersionDto.ContentDto.NodeDto.UniqueId;
                member.Path = dto.ContentVersionDto.ContentDto.NodeDto.Path;
                member.CreatorId = dto.ContentVersionDto.ContentDto.NodeDto.UserId.Value;
                member.Level = dto.ContentVersionDto.ContentDto.NodeDto.Level;
                member.ParentId = dto.ContentVersionDto.ContentDto.NodeDto.ParentId;
                member.SortOrder = dto.ContentVersionDto.ContentDto.NodeDto.SortOrder;
                member.Trashed = dto.ContentVersionDto.ContentDto.NodeDto.Trashed;
                member.CreateDate = dto.ContentVersionDto.ContentDto.NodeDto.CreateDate;
                member.UpdateDate = dto.ContentVersionDto.VersionDate;
                member.Version = dto.ContentVersionDto.VersionId;

                member.ProviderUserKey = member.Key;
                //on initial construction we don&#39;t want to have dirty properties tracked
                // http://issues.umbraco.org/issue/U4-1946
                member.ResetDirtyProperties(false);
                return member;
            }
            finally
            {
                member.EnableChangeTracking();
            }
        }

        [Obsolete(&quot;Use the static BuildEntity instead so we don&#39;t have to allocate one of these objects everytime we want to map values&quot;)]
        public IMember BuildEntity(MemberDto dto)
        {
            return BuildEntity(dto, _contentType);
        }

        public MemberDto BuildDto(IMember entity)
        {
            var dto = new MemberDto
            {
                ContentVersionDto = new ContentVersionDto
                {
                    NodeId = entity.Id,
                    VersionDate = entity.UpdateDate,
                    VersionId = entity.Version,
                    ContentDto = BuildContentDto(entity)
                },
                Email = entity.Email,
                LoginName = entity.Username,
                NodeId = entity.Id,
                Password = entity.RawPasswordValue
            };
            return dto;
        }

        #endregion

        public void SetPrimaryKey(int primaryKey)
        {
            _primaryKey = primaryKey;
        }

        private ContentDto BuildContentDto(IMember entity)
        {
            var contentDto = new ContentDto
            {
                NodeId = entity.Id,
                ContentTypeId = entity.ContentTypeId,
                NodeDto = BuildNodeDto(entity)
            };

            if (_primaryKey &gt; 0)
            {
                contentDto.PrimaryKey = _primaryKey;
            }

            return contentDto;
        }

        private NodeDto BuildNodeDto(IMember entity)
        {
            var nodeDto = new NodeDto
            {
                CreateDate = entity.CreateDate,
                NodeId = entity.Id,
                Level = short.Parse(entity.Level.ToString(CultureInfo.InvariantCulture)),
                NodeObjectType = _nodeObjectTypeId,
                ParentId = entity.ParentId,
                Path = entity.Path,
                SortOrder = entity.SortOrder,
                Text = entity.Name,
                Trashed = entity.Trashed,
                UniqueId = entity.Key,
                UserId = entity.CreatorId
            };

            return nodeDto;
        }
    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,85,1],[17,9,17,10,1],[18,13,18,40,1],[19,13,19,50,1],[20,13,20,22,1],[21,9,21,10,1],[23,9,23,60,1],[24,9,24,10,1],[25,13,25,50,1],[26,13,26,22,1],[27,9,27,10,1],[32,9,32,10,1],[33,13,35,70,1],[38,13,38,14,1],[39,17,39,48,1],[41,17,41,40,1],[42,17,42,80,1],[43,17,43,77,1],[44,17,44,90,1],[45,17,45,79,1],[46,17,46,85,1],[47,17,47,87,1],[48,17,48,83,1],[49,17,49,89,1],[50,17,50,71,1],[51,17,51,66,1],[53,17,53,53,1],[56,17,56,52,1],[57,17,57,31,1],[60,13,60,14,1],[61,17,61,47,1],[62,13,62,14,1],[63,9,63,10,1],[67,9,67,10,1],[68,13,68,51,1],[69,9,69,10,1],[72,9,72,10,1],[73,13,86,15,1],[87,13,87,24,1],[88,9,88,10,1],[93,9,93,10,1],[94,13,94,38,1],[95,9,95,10,1],[98,9,98,10,1],[99,13,104,15,1],[106,13,106,33,1],[107,13,107,14,1],[108,17,108,53,1],[109,13,109,14,1],[111,13,111,31,1],[112,9,112,10,1],[115,9,115,10,1],[116,13,129,15,1],[131,13,131,28,1],[132,9,132,10,1]]);
    </script>
  </body>
</html>