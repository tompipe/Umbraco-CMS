<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Services\SectionService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Xml.Linq;
using Umbraco.Core.Cache;
using Umbraco.Core.Events;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.UnitOfWork;
using File = System.IO.File;

namespace Umbraco.Core.Services
{
    internal class SectionService : ISectionService
    {
        private readonly IUserService _userService;
        private IEnumerable&lt;Section&gt; _allAvailableSections;
        private readonly IApplicationTreeService _applicationTreeService;
        private readonly IDatabaseUnitOfWorkProvider _uowProvider;
        private readonly CacheHelper _cache;
        internal const string AppConfigFileName = &quot;applications.config&quot;;
        private static string _appConfig;
        private volatile bool _isInitialized = false;
        private static readonly object Locker = new object();

        public SectionService(
            IUserService userService,
            IApplicationTreeService applicationTreeService,
            IDatabaseUnitOfWorkProvider uowProvider,
            CacheHelper cache)
        {
            if (applicationTreeService == null) throw new ArgumentNullException(&quot;applicationTreeService&quot;);
            if (cache == null) throw new ArgumentNullException(&quot;cache&quot;);

            _userService = userService;
            _applicationTreeService = applicationTreeService;
            _uowProvider = uowProvider;
            _cache = cache;
        }

        

        /// &lt;summary&gt;
        /// gets/sets the application.config file path
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// The setter is generally only going to be used in unit tests, otherwise it will attempt to resolve it using the IOHelper.MapPath
        /// &lt;/remarks&gt;
        internal static string AppConfigFilePath
        {
            get
            {
                if (string.IsNullOrWhiteSpace(_appConfig))
                {
                    _appConfig = IOHelper.MapPath(SystemDirectories.Config + &quot;/&quot; + AppConfigFileName);
                }
                return _appConfig;
            }
            set { _appConfig = value; }
        }

        /// &lt;summary&gt;
        /// Initializes the service with all available application plugins
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;allAvailableSections&quot;&gt;
        /// All application plugins found in assemblies
        /// &lt;/param&gt;
        /// &lt;remarks&gt;
        /// This is used to populate the app.config file with any applications declared in plugins that don&#39;t exist in the file
        /// &lt;/remarks&gt;
        public void Initialize(IEnumerable&lt;Section&gt; allAvailableSections)
        {
            _allAvailableSections = allAvailableSections;            
        }

        /// &lt;summary&gt;
        /// The cache storage for all applications
        /// &lt;/summary&gt;
        public IEnumerable&lt;Section&gt; GetSections()
        {
            return _cache.RuntimeCache.GetCacheItem&lt;IEnumerable&lt;Section&gt;&gt;(
                CacheKeys.ApplicationsCacheKey,
                () =&gt;
                    {
                        ////used for unit tests
                        //if (_testApps != null)
                        //    return _testApps;

                        var list = ReadFromXmlAndSort();

                        //On first access we need to do some initialization
                        if (_isInitialized == false)
                        {
                            lock (Locker)
                            {
                                if (_isInitialized == false)
                                {
                                    //now we can check the non-volatile flag
                                    if (_allAvailableSections != null)
                                    {
                                        var hasChanges = false;

                                        LoadXml(doc =&gt;
                                        {
                                            //Now, load in the xml structure and update it with anything that is not declared there and save the file.

                                            //NOTE: On the first iteration here, it will lazily scan all apps, etc... this is because this ienumerable is lazy
                                            // based on the ApplicationRegistrar - and as noted there this is not an ideal way to do things but were stuck like this
                                            // currently because of the legacy assemblies and types not in the Core.

                                            //Get all the trees not registered in the config
                                            var unregistered = _allAvailableSections
                                                .Where(x =&gt; list.Any(l =&gt; l.Alias == x.Alias) == false)
                                                .ToArray();

                                            hasChanges = unregistered.Any();

                                            var count = 0;
                                            foreach (var attr in unregistered)
                                            {
                                                doc.Root.Add(new XElement(&quot;add&quot;,
                                                    new XAttribute(&quot;alias&quot;, attr.Alias),
                                                    new XAttribute(&quot;name&quot;, attr.Name),
                                                    new XAttribute(&quot;icon&quot;, attr.Icon),
                                                    new XAttribute(&quot;sortOrder&quot;, attr.SortOrder)));
                                                count++;
                                            }

                                            //don&#39;t save if there&#39;s no changes
                                            return count &gt; 0;
                                        }, true);

                                        if (hasChanges)
                                        {
                                            //If there were changes, we need to re-read the structures from the XML
                                            list = ReadFromXmlAndSort();
                                        }
                                    }
                                }

                                _isInitialized = true;
                            }
                        }

                        return list;

                    }, new TimeSpan(0, 10, 0));
        }

        internal void LoadXml(Func&lt;XDocument, bool&gt; callback, bool saveAfterCallbackIfChanged)
        {
            lock (Locker)
            {
                var doc = File.Exists(AppConfigFilePath)
                    ? XDocument.Load(AppConfigFilePath)
                    : XDocument.Parse(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&lt;applications /&gt;&quot;);

                if (doc.Root != null)
                {
                    var changed = callback.Invoke(doc);

                    if (saveAfterCallbackIfChanged &amp;&amp; changed)
                    {
                        //ensure the folder is created!
                        Directory.CreateDirectory(Path.GetDirectoryName(AppConfigFilePath));

                        doc.Save(AppConfigFilePath);

                        //remove the cache so it gets re-read ... SD: I&#39;m leaving this here even though it
                        // is taken care of by events as well, I think unit tests may rely on it being cleared here.
                        _cache.RuntimeCache.ClearCacheItem(CacheKeys.ApplicationsCacheKey);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// Get the user&#39;s allowed sections
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;Section&gt; GetAllowedSections(int userId)
        {
            
            var user = _userService.GetUserById(userId);
            if (user == null)
            {
                throw new InvalidOperationException(&quot;No user found with id &quot; + userId);
            }

            return GetSections().Where(x =&gt; user.AllowedSections.Contains(x.Alias));
        }

        /// &lt;summary&gt;
        /// Gets the application by its alias.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;appAlias&quot;&gt;The application alias.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Section GetByAlias(string appAlias)
        {
            return GetSections().FirstOrDefault(t =&gt; t.Alias == appAlias);
        }

        /// &lt;summary&gt;
        /// Creates a new applcation if no application with the specified alias is found.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;The application name.&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;The application alias.&lt;/param&gt;
        /// &lt;param name=&quot;icon&quot;&gt;The application icon, which has to be located in umbraco/images/tray folder.&lt;/param&gt;
        public void MakeNew(string name, string alias, string icon)
        {
            MakeNew(name, alias, icon, GetSections().Max(x =&gt; x.SortOrder) + 1);
        }

        /// &lt;summary&gt;
        /// Makes the new.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;The name.&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;The alias.&lt;/param&gt;
        /// &lt;param name=&quot;icon&quot;&gt;The icon.&lt;/param&gt;
        /// &lt;param name=&quot;sortOrder&quot;&gt;The sort order.&lt;/param&gt;
        public void MakeNew(string name, string alias, string icon, int sortOrder)
        {            
            if (GetSections().All(x =&gt; x.Alias != alias))
            {
                LoadXml(doc =&gt;
                {
                    doc.Root.Add(new XElement(&quot;add&quot;,
                        new XAttribute(&quot;alias&quot;, alias),
                        new XAttribute(&quot;name&quot;, name),
                        new XAttribute(&quot;icon&quot;, icon),
                        new XAttribute(&quot;sortOrder&quot;, sortOrder)));
                    return true;
                }, true);

                //raise event
                OnNew(new Section(name, alias, icon, sortOrder), new EventArgs());
            }
        }

        /// &lt;summary&gt;
        /// Deletes the section
        /// &lt;/summary&gt;        
        public void DeleteSection(Section section)
        {
            lock (Locker)
            {
                //delete the assigned applications
                _uowProvider.GetUnitOfWork().Database.Execute(
                    &quot;delete from umbracoUser2App where app = @appAlias&quot;,
                    new { appAlias = section.Alias });

                //delete the assigned trees
                var trees = _applicationTreeService.GetApplicationTrees(section.Alias);
                foreach (var t in trees)
                {
                    _applicationTreeService.DeleteTree(t);
                }

                LoadXml(doc =&gt;
                {
                    doc.Root.Elements(&quot;add&quot;).Where(x =&gt; x.Attribute(&quot;alias&quot;) != null &amp;&amp; x.Attribute(&quot;alias&quot;).Value == section.Alias)
                        .Remove();

                    return true;
                }, true);

                //raise event
                OnDeleted(section, new EventArgs());   
            }            
        }

        private List&lt;Section&gt; ReadFromXmlAndSort()
        {
            var tmp = new List&lt;Section&gt;();

            LoadXml(doc =&gt;
            {
                foreach (var addElement in doc.Root.Elements(&quot;add&quot;).OrderBy(x =&gt;
                {
                    var sortOrderAttr = x.Attribute(&quot;sortOrder&quot;);
                    return sortOrderAttr != null ? Convert.ToInt32(sortOrderAttr.Value) : 0;
                }))
                {
                    var sortOrderAttr = addElement.Attribute(&quot;sortOrder&quot;);
                    tmp.Add(new Section(addElement.Attribute(&quot;name&quot;).Value,
                                        addElement.Attribute(&quot;alias&quot;).Value,
                                        addElement.Attribute(&quot;icon&quot;).Value,
                                        sortOrderAttr != null ? Convert.ToInt32(sortOrderAttr.Value) : 0));
                }
                return false;
            }, false);

            return tmp;
        } 

        internal static event TypedEventHandler&lt;Section, EventArgs&gt; Deleted;
        private static void OnDeleted(Section app, EventArgs args)
        {
            if (Deleted != null)
            {
                Deleted(app, args);
            }
        }

        internal static event TypedEventHandler&lt;Section, EventArgs&gt; New;
        private static void OnNew(Section app, EventArgs args)
        {
            if (New != null)
            {
                New(app, args);
            }
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,54,1],[27,9,27,62,1],[29,9,33,31,1],[34,9,34,10,1],[35,13,35,48,1],[35,49,35,107,0],[36,13,36,31,1],[36,32,36,73,0],[38,13,38,40,1],[39,13,39,62,1],[40,13,40,40,1],[41,13,41,28,1],[42,9,42,10,1],[55,13,55,14,1],[56,17,56,59,1],[57,17,57,18,0],[58,21,58,103,0],[59,17,59,18,0],[60,17,60,35,1],[61,13,61,14,1],[62,17,62,18,1],[62,19,62,38,1],[62,39,62,40,1],[75,9,75,10,0],[76,13,76,58,0],[77,9,77,10,0],[83,9,83,10,1],[84,13,87,21,1],[87,21,87,22,1],[87,22,92,25,1],[92,25,92,57,1],[92,57,95,25,1],[95,25,95,53,1],[95,53,96,25,1],[96,25,96,26,1],[96,26,97,29,1],[97,29,97,42,1],[97,42,98,29,1],[98,29,98,30,1],[98,30,99,33,1],[99,33,99,61,1],[99,61,100,33,1],[100,33,100,34,1],[100,34,102,37,1],[102,37,102,71,1],[102,71,103,37,1],[103,37,103,38,0],[103,38,104,41,1],[104,41,104,64,0],[104,64,106,41,1],[106,41,107,41,0],[107,41,107,42,0],[107,42,115,45,0],[115,45,116,61,0],[116,61,116,75,0],[116,75,116,93,0],[116,93,116,103,0],[116,61,116,103,0],[116,103,117,60,0],[115,45,117,60,0],[117,60,119,45,0],[119,45,119,77,0],[119,77,121,45,0],[121,45,121,59,0],[121,59,122,45,0],[122,45,122,52,0],[122,52,122,54,0],[122,54,122,62,0],[122,62,122,63,0],[122,63,122,65,0],[122,65,122,66,0],[122,66,122,78,0],[122,78,123,45,0],[123,45,123,46,0],[123,46,124,49,0],[124,49,128,99,0],[128,99,129,49,0],[129,49,129,57,0],[129,57,130,45,0],[130,45,130,46,0],[130,46,133,45,0],[133,45,133,62,0],[133,62,134,41,0],[134,41,134,42,0],[134,42,134,50,0],[106,41,134,50,0],[134,50,136,41,1],[136,41,136,56,0],[136,56,137,41,1],[137,41,137,42,0],[137,42,139,45,1],[139,45,139,73,0],[139,73,140,41,1],[140,41,140,42,0],[140,42,141,37,1],[141,37,141,38,0],[141,38,142,33,1],[142,33,142,34,1],[142,34,144,33,1],[144,33,144,55,1],[144,55,145,29,1],[145,29,145,30,1],[145,30,146,25,1],[146,25,146,26,1],[146,26,148,25,1],[148,25,148,37,1],[148,37,150,21,1],[150,21,150,22,1],[150,22,150,48,1],[84,13,150,48,1],[151,9,151,10,1],[154,9,154,10,1],[155,13,155,26,1],[156,13,156,14,1],[157,17,159,82,1],[161,17,161,38,1],[162,17,162,18,1],[163,21,163,56,1],[165,21,165,63,1],[166,21,166,22,1],[168,25,168,93,1],[170,25,170,53,1],[174,25,174,92,1],[175,21,175,22,1],[176,17,176,18,1],[177,13,177,14,1],[178,9,178,10,1],[186,9,186,10,0],[188,13,188,57,0],[189,13,189,30,0],[190,13,190,14,0],[191,17,191,88,0],[194,13,194,45,0],[194,45,194,83,0],[194,83,194,85,0],[194,13,194,85,0],[195,9,195,10,0],[203,9,203,10,1],[204,13,204,54,1],[204,54,204,73,1],[204,73,204,75,1],[204,13,204,75,1],[205,9,205,10,1],[214,9,214,10,1],[215,13,215,63,1],[215,63,215,74,1],[215,74,215,81,1],[215,13,215,81,1],[216,9,216,10,1],[226,9,226,10,1],[227,13,227,40,1],[227,40,227,56,1],[227,56,227,58,1],[227,13,227,58,1],[228,13,228,14,1],[229,17,230,17,1],[230,17,230,18,1],[230,18,231,21,1],[231,21,235,66,1],[235,66,236,21,1],[236,21,236,33,1],[236,33,237,17,1],[237,17,237,18,1],[237,18,237,26,1],[229,17,237,26,1],[240,17,240,83,1],[241,13,241,14,1],[242,9,242,10,1],[248,9,248,10,1],[249,13,249,26,1],[250,13,250,14,1],[252,17,254,55,1],[257,17,257,88,1],[258,17,258,24,1],[258,26,258,31,1],[258,32,258,34,1],[258,35,258,40,1],[259,17,259,18,1],[260,21,260,59,1],[261,17,261,18,1],[263,17,264,17,1],[264,17,264,18,1],[264,18,265,21,1],[265,21,265,57,1],[265,57,265,132,1],[265,132,266,35,1],[265,21,266,35,1],[266,35,268,21,1],[268,21,268,33,1],[268,33,269,17,1],[269,17,269,18,1],[269,18,269,26,1],[263,17,269,26,1],[272,17,272,53,1],[273,13,273,14,1],[274,9,274,10,1],[277,9,277,10,1],[278,13,278,43,1],[280,13,281,13,1],[281,13,281,14,1],[281,14,282,17,1],[282,17,282,24,1],[282,24,282,26,1],[282,26,282,40,1],[282,40,282,41,1],[282,41,282,43,1],[282,43,282,44,1],[282,44,283,17,1],[283,17,283,18,1],[283,18,284,21,1],[284,21,284,66,1],[284,66,285,21,1],[285,21,285,93,1],[285,93,286,17,1],[286,17,286,18,1],[286,18,286,19,1],[282,44,286,19,1],[286,19,287,17,1],[287,17,287,18,1],[287,18,288,21,1],[288,21,288,75,1],[288,75,289,21,1],[289,21,292,108,1],[292,108,293,17,1],[293,17,293,18,1],[293,18,294,17,1],[294,17,294,30,1],[294,30,295,13,1],[295,13,295,14,1],[295,14,295,23,1],[280,13,295,23,1],[297,13,297,24,1],[298,9,298,10,1],[302,9,302,10,1],[303,13,303,33,1],[304,13,304,14,0],[305,17,305,36,0],[306,13,306,14,0],[307,9,307,10,1],[311,9,311,10,1],[312,13,312,29,1],[313,13,313,14,0],[314,17,314,32,0],[315,13,315,14,0],[316,9,316,10,1]]);
    </script>
  </body>
</html>