<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\TestHelpers\BaseSeleniumTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data.SqlServerCe;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Linq.Dynamic;
using System.Runtime.InteropServices;
using System.Text;
using System.Web.Management;
using Moq;
using NUnit.Framework;
using OpenQA.Selenium;
using OpenQA.Selenium.Firefox;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations.Initial;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Tests.TestHelpers
{
    public class BaseSeleniumTest
    {
        internal IWebDriver Driver;
        internal string BaseUrl;

        private StringBuilder _verificationErrors;
        private UmbracoDatabase _database;

        protected ApplicationContext ApplicationContext
        {
            get { return ApplicationContext.Current; }
        }

        [SetUp]
        public virtual void Initialize()
        {

            // Disable medium trust
            var transform = TransformWebConfig(&quot;Release&quot;);

            var assemblyPath = TestHelper.CurrentAssemblyDirectory;
            assemblyPath = Path.Combine(assemblyPath, @&quot;..\..\..\Umbraco.Web.UI\&quot;);
            var webUiPath = Path.GetFullPath(new Uri(assemblyPath).LocalPath);

            var installedPackagesConfig = string.Format(&quot;{0}App_Data\\packages\\installed\\installedPackages.config&quot;, webUiPath);
            if (File.Exists(installedPackagesConfig))
                File.Delete(installedPackagesConfig);

            var databaseDataPath = string.Format(@&quot;{0}\App_Data\Umbraco.sdf&quot;, webUiPath);
            var connectionString = string.Format(@&quot;Data Source={0}&quot;, databaseDataPath);

            //Create the Sql CE database
            using (var engine = new SqlCeEngine(connectionString))
            {
                if (File.Exists(databaseDataPath) == false)
                    engine.CreateDatabase();
            }

            var syntaxProvider = new SqlCeSyntaxProvider();
            SqlSyntaxContext.SqlSyntaxProvider = syntaxProvider;

            _database = new UmbracoDatabase(connectionString, Constants.DatabaseProviders.SqlCe, Mock.Of&lt;ILogger&gt;());

            // First remove anything in the database
            var creation = new DatabaseSchemaCreation(_database, Mock.Of&lt;ILogger&gt;(), syntaxProvider);
            creation.UninstallDatabaseSchema();

            // Then populate it with fresh data
            _database.CreateDatabaseSchema(false);

            _database.Execute(&quot;UPDATE umbracoUser SET userName = &#39;admin&#39;, userPassword = &#39;W477AMlLwwJQeAGlPZKiEILr8TA=&#39;, userEmail = &#39;none&#39; WHERE id = 0&quot;); // password: test

            // Recycle app pool so the new user can log in
            //var webConfigFilePath = string.Format(@&quot;{0}\web.config&quot;, webUiPath);
            //File.SetLastWriteTime(webConfigFilePath, DateTime.Now);

            // Disable medium trust
            transform = TransformWebConfig(&quot;Release&quot;);

            Driver = new FirefoxDriver();
            BaseUrl = &quot;http://localhost:61639/&quot;;
            _verificationErrors = new StringBuilder();
        }

        [TearDown]
        public virtual void TearDown()
        {
            try
            {
                Driver.Quit();
            }
            catch (Exception)
            {
                // Ignore errors if unable to close the browser
            }

            // Re-enable medium trust
            var transform = TransformWebConfig(&quot;Debug&quot;);

            Assert.AreEqual(&quot;&quot;, _verificationErrors.ToString());
        }

        private static string TransformWebConfig(string configurationToUse)
        {
            var assemblyPath = TestHelper.CurrentAssemblyDirectory;
            var toolsPath = Path.Combine(assemblyPath, @&quot;..\..\..\..\tools\ConfigTransformTool\&quot;);
            var webUiPath = Path.GetFullPath(new Uri(Path.Combine(assemblyPath, @&quot;..\..\..\Umbraco.Web.UI\&quot;)).LocalPath);

            var fileToTransform = webUiPath + &quot;web.config&quot;;
            var transformFile = string.Format(&quot;{0}web.Template.{1}.config&quot;, webUiPath, configurationToUse);

            var psi = new ProcessStartInfo(string.Format(&quot;{0}ctt.exe&quot;, toolsPath), string.Format(&quot;s:\&quot;{0}\&quot; t:\&quot;{1}\&quot; d:\&quot;{2}\&quot; pw v&quot;, fileToTransform, transformFile, fileToTransform))
            {
                WorkingDirectory = Environment.CurrentDirectory,
                UseShellExecute = false,
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                CreateNoWindow = true
            };

            string[] result = {string.Empty};
            using (var process = new Process { StartInfo = psi })
            {
                // delegate for writing the process output to the response output
                Action&lt;Object, DataReceivedEventArgs&gt; dataReceived = ((sender, e) =&gt;
                {
                    if (e.Data != null) // sometimes a random event is received with null data, not sure why - I prefer to leave it out
                    {
                        result[0] +=  e.Data;
                        result[0] += &quot;\r\n&quot;;
                    }
                });

                process.OutputDataReceived += new DataReceivedEventHandler(dataReceived);
                process.ErrorDataReceived += new DataReceivedEventHandler(dataReceived);

                // start the process and start reading the standard and error outputs
                process.Start();
                process.BeginErrorReadLine();
                process.BeginOutputReadLine();

                // wait for the process to exit
                process.WaitForExit();

                // an exit code other than 0 generally means an error
                if (process.ExitCode != 0)
                {
                    result[0] = result[0] + &quot;\r\n - Exited with exitcode &quot; + process.ExitCode;
                }
            }

            return result[0];
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,17,32,18,0],[32,19,32,53,0],[32,54,32,55,0],[37,9,37,10,0],[40,13,40,59,0],[42,13,42,68,0],[43,13,43,84,0],[44,13,44,79,0],[46,13,46,130,0],[47,13,47,54,0],[48,17,48,54,0],[50,13,50,90,0],[51,13,51,88,0],[54,20,54,66,0],[55,13,55,14,0],[56,17,56,60,0],[57,21,57,45,0],[58,13,58,14,0],[60,13,60,60,0],[61,13,61,65,0],[63,13,63,118,0],[66,13,66,102,0],[67,13,67,48,0],[70,13,70,51,0],[72,13,72,156,0],[79,13,79,55,0],[81,13,81,42,0],[82,13,82,49,0],[83,13,83,55,0],[84,9,84,10,0],[88,9,88,10,0],[90,13,90,14,0],[91,17,91,31,0],[92,13,92,14,0],[93,13,93,30,0],[94,13,94,14,0],[96,13,96,14,0],[99,13,99,57,0],[101,13,101,65,0],[102,9,102,10,0],[105,9,105,10,0],[106,13,106,68,0],[107,13,107,99,0],[108,13,108,122,0],[110,13,110,60,0],[111,13,111,108,0],[113,13,120,15,0],[122,13,122,46,0],[123,20,123,65,0],[124,13,124,14,0],[126,17,127,17,0],[127,17,127,18,0],[127,18,128,21,0],[128,21,128,40,0],[128,40,129,21,0],[129,21,129,22,0],[129,22,130,25,0],[130,25,130,46,0],[130,46,131,25,0],[131,25,131,45,0],[131,45,132,21,0],[132,21,132,22,0],[132,22,133,17,0],[133,17,133,18,0],[133,18,133,20,0],[126,17,133,20,0],[135,17,135,90,0],[136,17,136,89,0],[139,17,139,33,0],[140,17,140,46,0],[141,17,141,47,0],[144,17,144,39,0],[147,17,147,43,0],[148,17,148,18,0],[149,21,149,95,0],[150,17,150,18,0],[151,13,151,14,0],[153,13,153,30,0],[154,9,154,10,0]]);
    </script>
  </body>
</html>