<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSeven\UpdateRelatedLinksData.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Deployment.Internal;
using System.Dynamic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Web.Script.Serialization;
using System.Xml;
using System.Xml.Linq;
using Newtonsoft.Json;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSeven
{
    [Migration(&quot;7.0.0&quot;, 10, GlobalSettings.UmbracoMigrationName)]
    public class UpdateRelatedLinksData : MigrationBase
    {
        public UpdateRelatedLinksData(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {
            Execute.Code(UpdateRelatedLinksDataDo);
        }

        public string UpdateRelatedLinksDataDo(Database database)
        {
            if (database != null)
            {
                var dtSql = new Sql().Select(&quot;nodeId&quot;)
                    .From&lt;DataTypeDto&gt;(SqlSyntax)
                    .Where&lt;DataTypeDto&gt;(dto =&gt; dto.PropertyEditorAlias == Constants.PropertyEditors.RelatedLinksAlias);

                var dataTypeIds = database.Fetch&lt;int&gt;(dtSql);
                if (dataTypeIds.Any() == false) return string.Empty;

                // need to use dynamic, as PropertyDataDto has new properties (eg decimal...) in further versions that don&#39;t exist yet
                var propertyData = database.Fetch&lt;dynamic&gt;(&quot;SELECT * FROM cmsPropertyData&quot;
                        + &quot; WHERE propertyTypeId in (SELECT id from cmsPropertyType where dataTypeID IN (@dataTypeIds))&quot;, new { /*dataTypeIds =*/ dataTypeIds });
                if (propertyData.Any() == false) return string.Empty;

                var nodesIdsWithProperty = propertyData.Select(x =&gt; (int) x.contentNodeId).Distinct().ToArray();

                var cmsContentXmlEntries = new List&lt;ContentXmlDto&gt;();
                //We&#39;re doing an &quot;IN&quot; query here but SQL server only supports 2100 query parameters so we&#39;re going to split on that
                // It would be better to do this as an INNER join + sub query but I don&#39;t have time for that at the moment and this is only run once
                // so it&#39;s not a big deal.
                var batches = nodesIdsWithProperty.InGroupsOf(2000);
                foreach (var batch in batches)
                {
                    cmsContentXmlEntries.AddRange(database.Fetch&lt;ContentXmlDto&gt;(&quot;WHERE nodeId in (@nodeIds)&quot;, new { nodeIds = batch }));
                }

                var propertyTypeIds = propertyData.Select(x =&gt; (int) x.propertytypeid).Distinct();

                //NOTE: We are writing the full query because we&#39;ve added a column to the PropertyTypeDto in later versions so one of the columns
                // won&#39;t exist yet
                var propertyTypes = database.Fetch&lt;PropertyTypeDto&gt;(&quot;SELECT * FROM cmsPropertyType WHERE id in (@propertyTypeIds)&quot;, new { propertyTypeIds = propertyTypeIds });

                foreach (var data in propertyData)
                {
                    if (string.IsNullOrEmpty(data.dataNtext) == false)
                    {
                        XmlDocument xml;
                        //fetch the current data (that&#39;s in xml format)
                        try
                        {
                            xml = new XmlDocument();
                            xml.LoadXml(data.dataNtext);
                        }
                        catch (Exception ex)
                        {
                            int dataId = data.id;
                            int dataNodeId = data.contentNodeId;
                            string dataText = data.dataNtext;
                            Logger.Error&lt;UpdateRelatedLinksData&gt;(&quot;The data stored for property id &quot; + dataId + &quot; on document &quot; + dataNodeId +
                                &quot; is not valid XML, the data will be removed because it cannot be converted to the new format. The value was: &quot; + dataText, ex);

                            data.dataNtext = &quot;&quot;;
                            database.Update(&quot;cmsPropertyData&quot;, &quot;id&quot;, data, new[] { &quot;dataNText&quot; });

                            UpdateXmlTable(propertyTypes, data, cmsContentXmlEntries, database);

                            continue;
                        }

                        var links = new List&lt;ExpandoObject&gt;();

                        //loop all the stored links
                        foreach (XmlNode node in xml.DocumentElement.ChildNodes)
                        {
                            var title = node.Attributes[&quot;title&quot;].Value;
                            var type = node.Attributes[&quot;type&quot;].Value;
                            var newwindow = node.Attributes[&quot;newwindow&quot;].Value.Equals(&quot;1&quot;);
                            var lnk = node.Attributes[&quot;link&quot;].Value;

                            //create the links in the format the new prop editor expects it to be
                            var link = new ExpandoObject() as IDictionary&lt;string, object&gt;;
                            link.Add(&quot;title&quot;, title);
                            link.Add(&quot;caption&quot;, title);
                            link.Add(&quot;link&quot;, lnk);
                            link.Add(&quot;newWindow&quot;, newwindow);
                            link.Add(&quot;type&quot;, type.Equals(&quot;internal&quot;) ? &quot;internal&quot; : &quot;external&quot;);
                            link.Add(&quot;internal&quot;, type.Equals(&quot;internal&quot;) ? lnk : null);

                            link.Add(&quot;edit&quot;, false);
                            link.Add(&quot;isInternal&quot;, type.Equals(&quot;internal&quot;));

                            links.Add((ExpandoObject)link);
                        }

                        //store the serialized data
                        data.dataNtext = JsonConvert.SerializeObject(links);

                        database.Update(&quot;cmsPropertyData&quot;, &quot;id&quot;, data, new[] { &quot;dataNText&quot; });

                        UpdateXmlTable(propertyTypes, data, cmsContentXmlEntries, database);

                    }
                }
            }
            return string.Empty;
        }

        public override void Down()
        {
            throw new DataLossException(&quot;Cannot downgrade from a version 7 database to a prior version, the database schema has already been modified&quot;);
        }

        private static void UpdateXmlTable(List&lt;PropertyTypeDto&gt; propertyTypes, dynamic data, List&lt;ContentXmlDto&gt; cmsContentXmlEntries, Database database)
        {
            //now we need to update the cmsContentXml table
            var propertyType = propertyTypes.SingleOrDefault(x =&gt; x.Id == data.propertytypeid);
            if (propertyType != null)
            {
                var xmlItem = cmsContentXmlEntries.SingleOrDefault(x =&gt; x.NodeId == data.contentNodeId);
                if (xmlItem != null)
                {
                    var x = XElement.Parse(xmlItem.Xml);
                    var prop = x.Element(propertyType.Alias);
                    if (prop != null)
                    {
                        prop.ReplaceAll(new XCData(data.dataNtext));
                        database.Update(xmlItem);
                    }
                }
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,87,22,110,1],[23,9,23,10,1],[24,9,24,10,1],[27,9,27,10,0],[28,13,28,52,0],[29,9,29,10,0],[32,9,32,10,1],[33,13,33,34,1],[34,13,34,14,1],[35,17,37,120,1],[39,17,39,62,1],[40,17,40,48,1],[40,49,40,69,0],[43,17,44,162,1],[45,17,45,49,1],[45,50,45,70,0],[47,17,47,69,1],[47,69,47,90,1],[47,90,47,113,1],[47,17,47,113,1],[49,17,49,70,1],[53,17,53,69,1],[54,17,54,24,1],[54,26,54,35,1],[54,36,54,38,1],[54,39,54,46,1],[55,17,55,18,1],[56,21,56,137,1],[57,17,57,18,1],[59,17,59,64,1],[59,64,59,86,1],[59,86,59,99,1],[59,17,59,99,1],[63,17,63,176,1],[65,17,65,24,1],[65,26,65,34,1],[65,35,65,37,1],[65,38,65,50,1],[66,17,66,18,1],[67,21,67,71,1],[68,21,68,22,1],[72,25,72,26,1],[73,29,73,53,1],[74,29,74,57,1],[75,25,75,26,1],[76,25,76,45,1],[77,25,77,26,1],[78,29,78,50,1],[79,29,79,65,1],[80,29,80,62,1],[81,29,82,161,1],[84,29,84,49,1],[85,29,85,99,1],[87,29,87,97,1],[89,29,89,38,1],[92,25,92,63,1],[95,25,95,32,1],[95,34,95,46,1],[95,47,95,49,1],[95,50,95,80,1],[96,25,96,26,1],[97,29,97,72,1],[98,29,98,70,1],[99,29,99,92,1],[100,29,100,69,1],[103,29,103,91,1],[104,29,104,54,1],[105,29,105,56,1],[106,29,106,51,1],[107,29,107,62,1],[108,29,108,97,1],[109,29,109,88,1],[111,29,111,53,1],[112,29,112,77,1],[114,29,114,60,1],[115,25,115,26,1],[118,25,118,77,1],[120,25,120,95,1],[122,25,122,93,1],[124,21,124,22,1],[125,17,125,18,1],[126,13,126,14,1],[127,13,127,33,1],[128,9,128,10,1],[131,9,131,10,0],[132,13,132,153,0],[136,9,136,10,1],[138,13,138,67,1],[138,67,138,94,1],[138,94,138,96,1],[138,13,138,96,1],[139,13,139,38,1],[140,13,140,14,1],[141,17,141,73,1],[141,73,141,103,0],[141,103,141,105,1],[141,17,141,105,1],[142,17,142,37,1],[143,17,143,18,0],[144,21,144,57,0],[145,21,145,62,0],[146,21,146,38,0],[147,21,147,22,0],[148,25,148,69,0],[149,25,149,50,0],[150,21,150,22,0],[151,17,151,18,0],[152,13,152,14,1],[153,9,153,10,1]]);
    </script>
  </body>
</html>