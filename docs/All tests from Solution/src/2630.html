<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\XPathCheckBoxList\XPathCheckBoxListDataEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Xml.Linq;
using umbraco.interfaces;

namespace umbraco.editorControls.XPathCheckBoxList
{
    /// &lt;summary&gt;
    /// Renders a CheckBoxList using with option nodes obtained by an XPath expression
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class XPathCheckBoxListDataEditor : CompositeControl, IDataEditor
    {
        /// &lt;summary&gt;
        /// Field for the data.
        /// &lt;/summary&gt;
        private IData data;

        /// &lt;summary&gt;
        /// Field for the options.
        /// &lt;/summary&gt;
        private XPathCheckBoxListOptions options;

        /// &lt;summary&gt;
        /// Field for the checkbox list.
        /// &lt;/summary&gt;
        private CheckBoxList checkBoxList = new CheckBoxList();

        /// &lt;summary&gt;
        /// Gets a value indicating whether [treat as rich text editor].
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        ///     &lt;c&gt;true&lt;/c&gt; if [treat as rich text editor]; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/value&gt;
        public virtual bool TreatAsRichTextEditor
        {
            get
            {
                return false;
            }
        }

        /// &lt;summary&gt;
        /// Gets a value indicating whether [show label].
        /// &lt;/summary&gt;
        /// &lt;value&gt;&lt;c&gt;true&lt;/c&gt; if [show label]; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/value&gt;
        public virtual bool ShowLabel
        {
            get
            {
                return true;
            }
        }

        /// &lt;summary&gt;
        /// Gets the editor.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The editor.&lt;/value&gt;
        public Control Editor
        {
            get
            {
                return this;
            }
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of XPathCheckBoxListDataEditor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;data&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;options&quot;&gt;&lt;/param&gt;
        internal XPathCheckBoxListDataEditor(IData data, XPathCheckBoxListOptions options)
        {
            this.data = data;
            this.options = options;
        }

        /// &lt;summary&gt;
        /// Called by the ASP.NET page framework to notify server controls that use composition-based implementation to create any child controls they contain in preparation for posting back or rendering.
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            switch (this.options.UmbracoObjectType)
            {
                case uQuery.UmbracoObjectType.Unknown:
                case uQuery.UmbracoObjectType.Document:

                    this.checkBoxList.DataSource = uQuery.GetNodesByXPath(this.options.XPath).Where(x =&gt; x.Id != -1).ToNameIds();
                    break;

                case uQuery.UmbracoObjectType.Media:

                    this.checkBoxList.DataSource = uQuery.GetMediaByXPath(this.options.XPath).Where(x =&gt; x.Id != -1).ToNameIds();
                    break;

                case uQuery.UmbracoObjectType.Member:

                    this.checkBoxList.DataSource = uQuery.GetMembersByXPath(this.options.XPath).ToNameIds();
                    break;
            }

            this.checkBoxList.DataTextField = &quot;Value&quot;;
            this.checkBoxList.DataValueField = this.options.UseIds ? &quot;Key&quot; : &quot;Value&quot;;
            this.checkBoxList.DataBind();

            this.Controls.Add(this.checkBoxList);
        }

        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;E:System.Web.UI.Control.Load&quot;/&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;T:System.EventArgs&quot;/&gt; object that contains the event data.&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
            this.EnsureChildControls();

            if (!this.Page.IsPostBack &amp;&amp; this.data.Value != null)
            {
                string value = this.data.Value.ToString();
                List&lt;string&gt; selectedValues = new List&lt;string&gt;();

                if (xmlHelper.CouldItBeXml(value))
                {
                    // build selected values from XML fragment
                    foreach (XElement nodeXElement in XElement.Parse(value).Elements())
                    {
                        selectedValues.Add(nodeXElement.Value);
                    }
                }
                else
                {
                    // Assume a CSV source
                    selectedValues = value.Split(&#39;,&#39;).ToList();
                }

                // Find checkboxes where values match the stored values and set to selected
                ListItem checkBoxListItem = null;
                foreach (string selectedValue in selectedValues)
                {
                    checkBoxListItem = this.checkBoxList.Items.FindByValue(selectedValue);
                    if (checkBoxListItem != null)
                    {
                        checkBoxListItem.Selected = true;
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// Called by Umbraco when saving the node
        /// &lt;/summary&gt;
        public void Save()
        {
            // Get all checked item values
            IEnumerable&lt;string&gt; selectedOptions = from ListItem item in this.checkBoxList.Items
                                                    where item.Selected
                                                    select item.Value;

            if (this.options.UseXml)
            {
                string elementName = this.options.UseIds ? &quot;nodeId&quot; : &quot;nodeName&quot;;

                this.data.Value = new XElement(
                                        &quot;XPathCheckBoxList&quot;,
                                        selectedOptions.Select(x =&gt; new XElement(elementName, x.ToString())))
                                        .ToString();
            }
            else
            {
                // Save the CSV
                this.data.Value = string.Join(&quot;,&quot;, selectedOptions.ToArray());
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,64,0],[41,13,41,14,0],[42,17,42,30,0],[43,13,43,14,0],[53,13,53,14,0],[54,17,54,29,0],[55,13,55,14,0],[65,13,65,14,0],[66,17,66,29,0],[67,13,67,14,0],[75,9,75,91,0],[76,9,76,10,0],[77,13,77,30,0],[78,13,78,36,0],[79,9,79,10,0],[85,9,85,10,0],[86,13,86,52,0],[91,21,91,106,0],[91,106,91,116,0],[91,116,91,130,0],[91,21,91,130,0],[92,21,92,27,0],[96,21,96,106,0],[96,106,96,116,0],[96,116,96,130,0],[96,21,96,130,0],[97,21,97,27,0],[101,21,101,109,0],[102,21,102,27,0],[105,13,105,55,0],[106,13,106,86,0],[107,13,107,42,0],[109,13,109,50,0],[110,9,110,10,0],[117,9,117,10,0],[118,13,118,28,0],[119,13,119,40,0],[121,13,121,66,0],[122,13,122,14,0],[123,17,123,59,0],[124,17,124,66,0],[126,17,126,51,0],[127,17,127,18,0],[129,21,129,28,0],[129,30,129,51,0],[129,52,129,54,0],[129,55,129,87,0],[130,21,130,22,0],[131,25,131,64,0],[132,21,132,22,0],[133,17,133,18,0],[135,17,135,18,0],[137,21,137,64,0],[138,17,138,18,0],[141,17,141,50,0],[142,17,142,24,0],[142,26,142,46,0],[142,47,142,49,0],[142,50,142,64,0],[143,17,143,18,0],[144,21,144,91,0],[145,21,145,50,0],[146,21,146,22,0],[147,25,147,58,0],[148,21,148,22,0],[149,17,149,18,0],[150,13,150,14,0],[151,9,151,10,0],[157,9,157,10,0],[159,13,160,59,0],[160,59,160,72,0],[160,72,161,60,0],[161,60,161,70,0],[161,70,161,71,0],[159,13,161,71,0],[163,13,163,37,0],[164,13,164,14,0],[165,17,165,82,0],[167,17,169,69,0],[169,69,169,108,0],[169,108,170,53,0],[167,17,170,53,0],[171,13,171,14,0],[173,13,173,14,0],[175,17,175,79,0],[176,13,176,14,0],[177,9,177,10,0]]);
    </script>
  </body>
</html>