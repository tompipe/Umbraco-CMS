<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\ContentRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text.RegularExpressions;
using System.Xml.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;

using Umbraco.Core.Persistence.Mappers;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;
using umbraco.editorControls.tinyMCE3;
using umbraco.interfaces;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class ContentRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            CreateTestData();

            VersionableRepositoryBase&lt;int, IContent&gt;.ThrowOnWarning = true;
        }

        [TearDown]
        public override void TearDown()
        {
            VersionableRepositoryBase&lt;int, IContent&gt;.ThrowOnWarning = false;

            base.TearDown();
        }

        private ContentRepository CreateRepository(IDatabaseUnitOfWork unitOfWork, out ContentTypeRepository contentTypeRepository, out DataTypeDefinitionRepository dtdRepository)
        {
            TemplateRepository tr;
            var ctRepository = CreateRepository(unitOfWork, out contentTypeRepository, out tr);
            dtdRepository = new DataTypeDefinitionRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, contentTypeRepository);
            return ctRepository;
        }

        private ContentRepository CreateRepository(IDatabaseUnitOfWork unitOfWork, out ContentTypeRepository contentTypeRepository)
        {
            TemplateRepository tr;
            return CreateRepository(unitOfWork, out contentTypeRepository, out tr);
        }

        private ContentRepository CreateRepository(IDatabaseUnitOfWork unitOfWork, out ContentTypeRepository contentTypeRepository, out TemplateRepository templateRepository)
        {
            templateRepository = new TemplateRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, Mock.Of&lt;IFileSystem&gt;(), Mock.Of&lt;IFileSystem&gt;(), Mock.Of&lt;ITemplatesSection&gt;());
            var tagRepository = new TagRepository(unitOfWork, CacheHelper, Logger, SqlSyntax);
            contentTypeRepository = new ContentTypeRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, templateRepository);
            var repository = new ContentRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, contentTypeRepository, templateRepository, tagRepository, Mock.Of&lt;IContentSection&gt;());
            return repository;
        }

        [Test]
        public void Get_Always_Returns_Latest_Version()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            IContent content1;

            var versions = new List&lt;Guid&gt;();
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var hasPropertiesContentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;);
                content1 = MockedContent.CreateSimpleContent(hasPropertiesContentType);

                //save version
                contentTypeRepository.AddOrUpdate(hasPropertiesContentType);
                repository.AddOrUpdate(content1);
                unitOfWork.Commit();
                versions.Add(content1.Version);

                //publish version
                content1.ChangePublishedState(PublishedState.Published);
                repository.AddOrUpdate(content1);
                unitOfWork.Commit();
                versions.Add(content1.Version);

                //change something and make a pending version
                content1.Name = &quot;new name&quot;;
                content1.ChangePublishedState(PublishedState.Saved);
                repository.AddOrUpdate(content1);
                unitOfWork.Commit();
                versions.Add(content1.Version);
            }

            // Assert
            Assert.AreEqual(3, versions.Distinct().Count());
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var content = repository.GetByQuery(new Query&lt;IContent&gt;().Where(c =&gt; c.Id == content1.Id)).ToArray()[0];
                Assert.AreEqual(versions[2], content.Version);

                content = repository.Get(content1.Id);
                Assert.AreEqual(versions[2], content.Version);

                foreach (var version in versions)
                {
                    content = repository.GetByVersion(version);
                    Assert.IsNotNull(content);
                    Assert.AreEqual(version, content.Version);
                }
            }
        }

        [Test]
        public void Deal_With_Corrupt_Duplicate_Newest_Published_Flags()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            IContent content1;

            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var hasPropertiesContentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;);
                content1 = MockedContent.CreateSimpleContent(hasPropertiesContentType);
                
                contentTypeRepository.AddOrUpdate(hasPropertiesContentType);
                repository.AddOrUpdate(content1);                
                unitOfWork.Commit();                
            }

            var versionDtos = new List&lt;ContentVersionDto&gt;();

            //Now manually corrupt the data
            var versions = new[] { Guid.NewGuid(), Guid.NewGuid() };
            for (var index = 0; index &lt; versions.Length; index++)
            {
                var version = versions[index];
                var versionDate = DateTime.Now.AddMinutes(index);
                var versionDto = new ContentVersionDto
                {
                    NodeId = content1.Id,
                    VersionDate = versionDate,
                    VersionId = version
                };
                this.DatabaseContext.Database.Insert(versionDto);
                versionDtos.Add(versionDto);
                this.DatabaseContext.Database.Insert(new DocumentDto
                {
                    Newest = true,
                    NodeId = content1.Id,
                    Published = true,
                    Text = content1.Name,
                    VersionId = version,
                    WriterUserId = 0,
                    UpdateDate = versionDate,
                    TemplateId = content1.Template == null || content1.Template.Id &lt;= 0 ? null : (int?) content1.Template.Id
                });
            }

            // Assert
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var content = repository.GetByQuery(new Query&lt;IContent&gt;().Where(c =&gt; c.Id == content1.Id)).ToArray();
                Assert.AreEqual(1, content.Length);
                Assert.AreEqual(content[0].Version, versionDtos.Single(x =&gt; x.Id == versionDtos.Max(y =&gt; y.Id)).VersionId);
                Assert.AreEqual(content[0].UpdateDate.ToString(CultureInfo.InvariantCulture), versionDtos.Single(x =&gt; x.Id == versionDtos.Max(y =&gt; y.Id)).VersionDate.ToString(CultureInfo.InvariantCulture));

                var contentItem = repository.GetByVersion(content1.Version);
                Assert.IsNotNull(contentItem);

                contentItem = repository.Get(content1.Id);
                Assert.IsNotNull(contentItem);
                Assert.AreEqual(contentItem.UpdateDate.ToString(CultureInfo.InvariantCulture), versionDtos.Single(x =&gt; x.Id == versionDtos.Max(y =&gt; y.Id)).VersionDate.ToString(CultureInfo.InvariantCulture));
                Assert.AreEqual(contentItem.Version, versionDtos.Single(x =&gt; x.Id == versionDtos.Max(y =&gt; y.Id)).VersionId);

                var allVersions = repository.GetAllVersions(content[0].Id);
                var allKnownVersions = versionDtos.Select(x =&gt; x.VersionId).Union(new[]{ content1.Version }).ToArray();
                Assert.IsTrue(allKnownVersions.ContainsAll(allVersions.Select(x =&gt; x.Version)));
                Assert.IsTrue(allVersions.Select(x =&gt; x.Version).ContainsAll(allKnownVersions));
            }
        }

        /// &lt;summary&gt;
        /// This tests the regression issue of U4-9438
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// The problem was the iteration of the property data in VersionableRepositoryBase when a content item
        /// in the list actually doesn&#39;t have any property types, it would still skip over a property row.
        /// To test, we have 3 content items, the first has properties, the second doesn&#39;t and the third does.
        /// &lt;/remarks&gt;
        [Test]
        public void Property_Data_Assigned_Correctly()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;

            var allContent = new List&lt;IContent&gt;();
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var emptyContentType = MockedContentTypes.CreateBasicContentType();
                var hasPropertiesContentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;);
                var content1 = MockedContent.CreateSimpleContent(hasPropertiesContentType);
                var content2 = MockedContent.CreateBasicContent(emptyContentType);
                var content3 = MockedContent.CreateSimpleContent(hasPropertiesContentType);

                // Act
                contentTypeRepository.AddOrUpdate(emptyContentType);
                contentTypeRepository.AddOrUpdate(hasPropertiesContentType);
                repository.AddOrUpdate(content1);
                repository.AddOrUpdate(content2);
                repository.AddOrUpdate(content3);
                unitOfWork.Commit();

                allContent.Add(content1);
                allContent.Add(content2);
                allContent.Add(content3);
            }

            // Assert
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                //this will cause the GetPropertyCollection to execute and we need to ensure that 
                // all of the properties and property types are all correct
                var result = repository.GetAll(allContent.Select(x =&gt; x.Id).ToArray()).ToArray();

                foreach (var content in result)
                {
                    foreach (var contentProperty in content.Properties)
                    {
                        //prior to the fix, the 2nd document iteration in the GetPropertyCollection would have caused
                        //the enumerator to move forward past the first property of the 3rd document which would have 
                        //ended up not assiging a property to the 3rd document. This would have ended up with the 3rd
                        //document still having 3 properties but the last one would not have been assigned an identity
                        //because the property data would not have been assigned.
                        Assert.IsTrue(contentProperty.HasIdentity);
                    }
                }
            }
        }

        [Test]
        public void Rebuild_Xml_Structures_With_Non_Latest_Version()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var contentType1 = MockedContentTypes.CreateSimpleContentType(&quot;Textpage1&quot;, &quot;Textpage1&quot;);
                contentTypeRepository.AddOrUpdate(contentType1);

                var allCreated = new List&lt;IContent&gt;();

                //create 100 non published
                for (var i = 0; i &lt; 100; i++)
                {
                    var c1 = MockedContent.CreateSimpleContent(contentType1);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                //create 100 published
                for (var i = 0; i &lt; 100; i++)
                {
                    var c1 = MockedContent.CreateSimpleContent(contentType1);
                    c1.ChangePublishedState(PublishedState.Published);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                unitOfWork.Commit();

                //now create some versions of this content - this shouldn&#39;t affect the xml structures saved
                for (int i = 0; i &lt; allCreated.Count; i++)
                {
                    allCreated[i].Name = &quot;blah&quot; + i;
                    //IMPORTANT testing note here: We need to changed the published state here so that
                    // it doesn&#39;t automatically think this is simply publishing again - this forces the latest
                    // version to be Saved and not published
                    allCreated[i].ChangePublishedState(PublishedState.Saved);
                    repository.AddOrUpdate(allCreated[i]);
                }
                unitOfWork.Commit();

                //delete all xml
                unitOfWork.Database.Execute(&quot;DELETE FROM cmsContentXml&quot;);
                Assert.AreEqual(0, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));

                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10);

                Assert.AreEqual(100, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));
            }
        }

        [Test]
        public void Rebuild_All_Xml_Structures()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {

                var contentType1 = MockedContentTypes.CreateSimpleContentType(&quot;Textpage1&quot;, &quot;Textpage1&quot;);
                contentTypeRepository.AddOrUpdate(contentType1);
                var allCreated = new List&lt;IContent&gt;();

                for (var i = 0; i &lt; 100; i++)
                {
                    //These will be non-published so shouldn&#39;t show up
                    var c1 = MockedContent.CreateSimpleContent(contentType1);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                for (var i = 0; i &lt; 100; i++)
                {
                    var c1 = MockedContent.CreateSimpleContent(contentType1);
                    c1.ChangePublishedState(PublishedState.Published);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                unitOfWork.Commit();

                //now create some versions of this content - this shouldn&#39;t affect the xml structures saved
                for (int i = 0; i &lt; allCreated.Count; i++)
                {
                    allCreated[i].Name = &quot;blah&quot; + i;
                    repository.AddOrUpdate(allCreated[i]);
                }
                unitOfWork.Commit();

                //delete all xml
                unitOfWork.Database.Execute(&quot;DELETE FROM cmsContentXml&quot;);
                Assert.AreEqual(0, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));

                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10);

                Assert.AreEqual(100, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));
            }
        }

        [Test]
        public void Rebuild_All_Xml_Structures_Ensure_Orphaned_Are_Removed()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                //delete all xml
                unitOfWork.Database.Execute(&quot;DELETE FROM cmsContentXml&quot;);

                var contentType1 = MockedContentTypes.CreateSimpleContentType(&quot;Textpage1&quot;, &quot;Textpage1&quot;);
                contentTypeRepository.AddOrUpdate(contentType1);
                var allCreated = new List&lt;IContent&gt;();

                for (var i = 0; i &lt; 100; i++)
                {
                    //These will be non-published so shouldn&#39;t show up
                    var c1 = MockedContent.CreateSimpleContent(contentType1);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                for (var i = 0; i &lt; 100; i++)
                {
                    var c1 = MockedContent.CreateSimpleContent(contentType1);
                    c1.ChangePublishedState(PublishedState.Published);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                unitOfWork.Commit();

                //now create some versions of this content - this shouldn&#39;t affect the xml structures saved
                for (int i = 0; i &lt; allCreated.Count; i++)
                {
                    allCreated[i].Name = &quot;blah&quot; + i;
                    repository.AddOrUpdate(allCreated[i]);
                }
                unitOfWork.Commit();

                //Add some extra orphaned rows that shouldn&#39;t be there
                var notPublished = MockedContent.CreateSimpleContent(contentType1);
                repository.AddOrUpdate(notPublished);
                unitOfWork.Commit();
                //Force add it
                unitOfWork.Database.Insert(new ContentXmlDto
                {
                    NodeId = notPublished.Id,
                    Xml = &quot;&lt;test&gt;&lt;/test&gt;&quot;
                });

                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10);

                Assert.AreEqual(100, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));
            }
        }

        [Test]
        public void Rebuild_All_Xml_Structures_For_Content_Type()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var contentType1 = MockedContentTypes.CreateSimpleContentType(&quot;Textpage1&quot;, &quot;Textpage1&quot;);
                var contentType2 = MockedContentTypes.CreateSimpleContentType(&quot;Textpage2&quot;, &quot;Textpage2&quot;);
                var contentType3 = MockedContentTypes.CreateSimpleContentType(&quot;Textpage3&quot;, &quot;Textpage3&quot;);
                contentTypeRepository.AddOrUpdate(contentType1);
                contentTypeRepository.AddOrUpdate(contentType2);
                contentTypeRepository.AddOrUpdate(contentType3);

                var allCreated = new List&lt;IContent&gt;();

                for (var i = 0; i &lt; 30; i++)
                {
                    //These will be non-published so shouldn&#39;t show up
                    var c1 = MockedContent.CreateSimpleContent(contentType1);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                for (var i = 0; i &lt; 30; i++)
                {
                    var c1 = MockedContent.CreateSimpleContent(contentType1);
                    c1.ChangePublishedState(PublishedState.Published);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                for (var i = 0; i &lt; 30; i++)
                {
                    var c1 = MockedContent.CreateSimpleContent(contentType2);
                    c1.ChangePublishedState(PublishedState.Published);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                for (var i = 0; i &lt; 30; i++)
                {
                    var c1 = MockedContent.CreateSimpleContent(contentType3);
                    c1.ChangePublishedState(PublishedState.Published);
                    repository.AddOrUpdate(c1);
                    allCreated.Add(c1);
                }
                unitOfWork.Commit();

                //now create some versions of this content - this shouldn&#39;t affect the xml structures saved
                for (int i = 0; i &lt; allCreated.Count; i++)
                {
                    allCreated[i].Name = &quot;blah&quot; + i;
                    repository.AddOrUpdate(allCreated[i]);
                }
                unitOfWork.Commit();

                //delete all xml
                unitOfWork.Database.Execute(&quot;DELETE FROM cmsContentXml&quot;);
                Assert.AreEqual(0, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));

                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10, contentTypeIds: new[] { contentType1.Id, contentType2.Id });

                Assert.AreEqual(60, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));
            }
        }

        /// &lt;summary&gt;
        /// This test ensures that when property values using special database fields are saved, the actual data in the
        /// object being stored is also transformed in the same way as the data being stored in the database is.
        /// Before you would see that ex: a decimal value being saved as 100 or &quot;100&quot;, would be that exact value in the
        /// object, but the value saved to the database was actually 100.000000.
        /// When querying the database for the value again - the value would then differ from what is in the object.
        /// This caused inconsistencies between saving+publishing and simply saving and then publishing, due to the former
        /// sending the non-transformed data directly on to publishing.
        /// &lt;/summary&gt;
        [Test]
        public void Property_Values_With_Special_DatabaseTypes_Are_Equal_Before_And_After_Being_Persisted()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            DataTypeDefinitionRepository dataTypeDefinitionRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository, out dataTypeDefinitionRepository))
            {
                // Setup
                var dtd = new DataTypeDefinition(-1, Constants.PropertyEditors.DecimalAlias) { Name = &quot;test&quot;, DatabaseType = DataTypeDatabaseType.Decimal };
                dataTypeDefinitionRepository.AddOrUpdate(dtd);
                unitOfWork.Commit();

                const string decimalPropertyAlias = &quot;decimalProperty&quot;;
                const string intPropertyAlias = &quot;intProperty&quot;;
                const string dateTimePropertyAlias = &quot;datetimeProperty&quot;;
                var dateValue = new DateTime(2016, 1, 6);

                var propertyTypeCollection = new PropertyTypeCollection(
                    new List&lt;PropertyType&gt;
                    {
                        MockedPropertyTypes.CreateDecimalProperty(decimalPropertyAlias, &quot;Decimal property&quot;, dtd.Id),
                        MockedPropertyTypes.CreateIntegerProperty(intPropertyAlias, &quot;Integer property&quot;),
                        MockedPropertyTypes.CreateDateTimeProperty(dateTimePropertyAlias, &quot;DateTime property&quot;)
                    });
                var contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;, propertyTypeCollection);
                contentTypeRepository.AddOrUpdate(contentType);
                unitOfWork.Commit();

                // Int and decimal values are passed in as strings as they would be from the backoffice UI
                var textpage = MockedContent.CreateSimpleContentWithSpecialDatabaseTypes(contentType, &quot;test@umbraco.org&quot;, -1, &quot;100&quot;, &quot;150&quot;, dateValue);

                // Act
                repository.AddOrUpdate(textpage);
                unitOfWork.Commit();

                // Assert
                Assert.That(contentType.HasIdentity, Is.True);
                Assert.That(textpage.HasIdentity, Is.True);

                var persistedTextpage = repository.Get(textpage.Id);
                Assert.That(persistedTextpage.Name, Is.EqualTo(textpage.Name));
                Assert.AreEqual(100m, persistedTextpage.GetValue(decimalPropertyAlias));
                Assert.AreEqual(persistedTextpage.GetValue(decimalPropertyAlias), textpage.GetValue(decimalPropertyAlias));
                Assert.AreEqual(150, persistedTextpage.GetValue(intPropertyAlias));
                Assert.AreEqual(persistedTextpage.GetValue(intPropertyAlias), textpage.GetValue(intPropertyAlias));
                Assert.AreEqual(dateValue, persistedTextpage.GetValue(dateTimePropertyAlias));
                Assert.AreEqual(persistedTextpage.GetValue(dateTimePropertyAlias), textpage.GetValue(dateTimePropertyAlias));
            }
        }

        [Test]
        public void Ensures_Permissions_Are_Set_If_Parent_Entity_Permissions_Exist()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();

            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;);
                contentType.AllowedContentTypes = new List&lt;ContentTypeSort&gt;
                {
                    new ContentTypeSort(new Lazy&lt;int&gt;(() =&gt; contentType.Id), 0, contentType.Alias)
                };
                var parentPage = MockedContent.CreateSimpleContent(contentType);
                contentTypeRepository.AddOrUpdate(contentType);
                repository.AddOrUpdate(parentPage);
                unitOfWork.Commit();

                // Act
                repository.AssignEntityPermission(parentPage, &#39;A&#39;, new int[] { 0 });
                var childPage = MockedContent.CreateSimpleContent(contentType, &quot;child&quot;, parentPage);
                repository.AddOrUpdate(childPage);
                unitOfWork.Commit();

                // Assert
                var permissions = repository.GetPermissionsForEntity(childPage.Id);
                Assert.AreEqual(1, permissions.Count());
                Assert.AreEqual(&quot;A&quot;, permissions.Single().AssignedPermissions.First());
            }

        }

        [Test]
        public void Can_Perform_Add_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                ContentType contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage2&quot;, &quot;Textpage&quot;);
                IContent textpage = MockedContent.CreateSimpleContent(contentType);

                // Act
                contentTypeRepository.AddOrUpdate(contentType);
                repository.AddOrUpdate(textpage);
                unitOfWork.Commit();

                // Assert
                Assert.That(contentType.HasIdentity, Is.True);
                Assert.That(textpage.HasIdentity, Is.True);


            }
        }

        [Test]
        public void Can_Perform_Add_With_Default_Template()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            TemplateRepository templateRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository, out templateRepository))
            {
                var template = new Template(&quot;hello&quot;, &quot;hello&quot;);
                templateRepository.AddOrUpdate(template);
                unitOfWork.Commit();

                ContentType contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage2&quot;, &quot;Textpage&quot;);
                contentType.AllowedTemplates = Enumerable.Empty&lt;ITemplate&gt;(); // because CreateSimple... assigns one
                contentType.SetDefaultTemplate(template);
                Content textpage = MockedContent.CreateSimpleContent(contentType);

                // Act

                contentTypeRepository.AddOrUpdate(contentType);
                repository.AddOrUpdate(textpage);
                unitOfWork.Commit();

                var fetched = repository.Get(textpage.Id);

                // Assert
                Assert.That(textpage.Template, Is.Not.Null);
                Assert.That(textpage.Template, Is.EqualTo(contentType.DefaultTemplate));

                TestHelper.AssertAllPropertyValuesAreEquals(textpage, fetched, &quot;yyyy-MM-dd HH:mm:ss&quot;);
            }
        }

        //Covers issue U4-2791 and U4-2607
        [Test]
        public void Can_Save_Content_With_AtSign_In_Name_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;);
                contentTypeRepository.AddOrUpdate(contentType);
                unitOfWork.Commit();

                var textpage = MockedContent.CreateSimpleContent(contentType, &quot;test@umbraco.org&quot;, -1);
                var anotherTextpage = MockedContent.CreateSimpleContent(contentType, &quot;@lightgiants&quot;, -1);

                // Act

                repository.AddOrUpdate(textpage);
                repository.AddOrUpdate(anotherTextpage);
                unitOfWork.Commit();

                // Assert
                Assert.That(contentType.HasIdentity, Is.True);
                Assert.That(textpage.HasIdentity, Is.True);

                var content = repository.Get(textpage.Id);
                Assert.That(content.Name, Is.EqualTo(textpage.Name));

                var content2 = repository.Get(anotherTextpage.Id);
                Assert.That(content2.Name, Is.EqualTo(anotherTextpage.Name));
            }
        }

        [Test]
        public void Can_Perform_Multiple_Adds_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                ContentType contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;);
                Content textpage = MockedContent.CreateSimpleContent(contentType);

                // Act
                contentTypeRepository.AddOrUpdate(contentType);
                repository.AddOrUpdate(textpage);
                unitOfWork.Commit();

                Content subpage = MockedContent.CreateSimpleContent(contentType, &quot;Text Page 1&quot;, textpage.Id);
                repository.AddOrUpdate(subpage);
                unitOfWork.Commit();

                // Assert
                Assert.That(contentType.HasIdentity, Is.True);
                Assert.That(textpage.HasIdentity, Is.True);
                Assert.That(subpage.HasIdentity, Is.True);
                Assert.That(textpage.Id, Is.EqualTo(subpage.ParentId));
            }

        }


        [Test]
        public void Can_Verify_Fresh_Entity_Is_Not_Dirty()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var content = repository.Get(NodeDto.NodeIdSeed + 3);
                bool dirty = ((Content)content).IsDirty();

                // Assert
                Assert.That(dirty, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Update_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var content = repository.Get(NodeDto.NodeIdSeed + 2);
                content.Name = &quot;About 2&quot;;
                repository.AddOrUpdate(content);
                unitOfWork.Commit();
                var updatedContent = repository.Get(NodeDto.NodeIdSeed + 2);

                // Assert
                Assert.That(updatedContent.Id, Is.EqualTo(content.Id));
                Assert.That(updatedContent.Name, Is.EqualTo(content.Name));
            }

        }

        [Test]
        public void Can_Update_With_Null_Template()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var content = repository.Get(NodeDto.NodeIdSeed + 2);
                content.Template = null;
                repository.AddOrUpdate(content);
                unitOfWork.Commit();
                var updatedContent = repository.Get(NodeDto.NodeIdSeed + 2);

                // Assert
                Assert.That(updatedContent.Template, Is.Null);
            }

        }

        [Test]
        public void Can_Perform_Delete_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var contentType = contentTypeRepository.Get(NodeDto.NodeIdSeed);
                var content = new Content(&quot;Textpage 2 Child Node&quot;, NodeDto.NodeIdSeed + 3, contentType);
                content.CreatorId = 0;
                content.WriterId = 0;

                // Act
                repository.AddOrUpdate(content);
                unitOfWork.Commit();
                var id = content.Id;

                repository.Delete(content);
                unitOfWork.Commit();

                var content1 = repository.Get(id);

                // Assert
                Assert.That(content1, Is.Null);
            }
        }

        [Test]
        public void Can_Perform_Get_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var content = repository.Get(NodeDto.NodeIdSeed + 3);

                // Assert
                Assert.That(content.Id, Is.EqualTo(NodeDto.NodeIdSeed + 3));
                Assert.That(content.CreateDate, Is.GreaterThan(DateTime.MinValue));
                Assert.That(content.UpdateDate, Is.GreaterThan(DateTime.MinValue));
                Assert.That(content.ParentId, Is.Not.EqualTo(0));
                Assert.That(content.Name, Is.EqualTo(&quot;Text Page 2&quot;));
                //Assert.That(content.SortOrder, Is.EqualTo(1));
                Assert.That(content.Version, Is.Not.EqualTo(Guid.Empty));
                Assert.That(content.ContentTypeId, Is.EqualTo(NodeDto.NodeIdSeed));
                Assert.That(content.Path, Is.Not.Empty);
                Assert.That(content.Properties.Any(), Is.True);
            }
        }

        [Test]
        public void Can_Perform_GetByQuery_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Level == 2);
                var result = repository.GetByQuery(query);

                // Assert
                Assert.That(result.Count(), Is.GreaterThanOrEqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_Get_All_With_Many_Version()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                var result = repository.GetAll().ToArray();
                foreach (var content in result)
                {
                    content.ChangePublishedState(PublishedState.Saved);
                    repository.AddOrUpdate(content);
                }
                unitOfWork.Commit();
                foreach (var content in result)
                {
                    content.ChangePublishedState(PublishedState.Published);
                    repository.AddOrUpdate(content);
                }
                unitOfWork.Commit();

                //re-get

                var result2 = repository.GetAll().ToArray();

                Assert.AreEqual(result.Count(), result2.Count());
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_Sorting_On_Custom_Property()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Name.Contains(&quot;Text&quot;));
                long totalRecords;

                try
                {
                    DatabaseContext.Database.EnableSqlTrace = true;
                    DatabaseContext.Database.EnableSqlCount();

                    var result = repository.GetPagedResultsByQuery(query, 0, 2, out totalRecords, &quot;title&quot;, Direction.Ascending, false);

                    Assert.AreEqual(3, totalRecords);
                    Assert.AreEqual(2, result.Count());

                    result = repository.GetPagedResultsByQuery(query, 1, 2, out totalRecords, &quot;title&quot;, Direction.Ascending, false);

                    Assert.AreEqual(1, result.Count());
                }
                finally
                {
                    DatabaseContext.Database.EnableSqlTrace = false;
                    DatabaseContext.Database.DisableSqlCount();
                }
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_ForFirstPage_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;

                try
                {
                    DatabaseContext.Database.EnableSqlTrace = true;
                    DatabaseContext.Database.EnableSqlCount();
                    var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;Name&quot;, Direction.Ascending, true);

                    // Assert
                    Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                    Assert.That(result.Count(), Is.EqualTo(1));
                    Assert.That(result.First().Name, Is.EqualTo(&quot;Text Page 1&quot;));
                }
                finally
                {
                    DatabaseContext.Database.EnableSqlTrace = false;
                    DatabaseContext.Database.DisableSqlCount();
                }
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_ForSecondPage_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 1, 1, out totalRecords, &quot;Name&quot;, Direction.Ascending, true);

                // Assert
                Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Text Page 2&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WithSinglePage_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 2, out totalRecords, &quot;Name&quot;, Direction.Ascending, true);

                // Assert
                Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(2));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Text Page 1&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WithDescendingOrder_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;Name&quot;, Direction.Descending, true);

                // Assert
                Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Text Page 2&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WithFilterMatchingSome_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Level == 2);
                var filterQuery = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Name.Contains(&quot;Page 2&quot;));

                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;Name&quot;, Direction.Ascending, true, filterQuery);

                // Assert
                Assert.That(totalRecords, Is.EqualTo(1));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Text Page 2&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WithFilterMatchingAll_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Level == 2);
                var filterQuery = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Name.Contains(&quot;Page&quot;));

                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;Name&quot;, Direction.Ascending, true, filterQuery);

                // Assert
                Assert.That(totalRecords, Is.EqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Text Page 1&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetAll_By_Param_Ids_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var contents = repository.GetAll(NodeDto.NodeIdSeed + 2, NodeDto.NodeIdSeed + 3);

                // Assert
                Assert.That(contents, Is.Not.Null);
                Assert.That(contents.Any(), Is.True);
                Assert.That(contents.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_GetAll_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var contents = repository.GetAll();

                // Assert
                Assert.That(contents, Is.Not.Null);
                Assert.That(contents.Any(), Is.True);
                Assert.That(contents.Count(), Is.GreaterThanOrEqualTo(4));
            }


        }

        [Test]
        public void Can_Perform_Exists_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var exists = repository.Exists(NodeDto.NodeIdSeed + 1);

                // Assert
                Assert.That(exists, Is.True);
            }


        }

        [Test]
        public void Can_Perform_Count_On_ContentRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                int level = 2;
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Level == level);
                var result = repository.Count(query);

                // Assert
                Assert.That(result, Is.GreaterThanOrEqualTo(2));
            }
        }

        [Test]
        public void Can_Verify_Keys_Set()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var textpage = repository.Get(NodeDto.NodeIdSeed + 1);
                var subpage = repository.Get(NodeDto.NodeIdSeed + 2);
                var trashed = repository.Get(NodeDto.NodeIdSeed + 4);

                // Assert
                Assert.That(textpage.Key.ToString().ToUpper(), Is.EqualTo(&quot;B58B3AD4-62C2-4E27-B1BE-837BD7C533E0&quot;));
                Assert.That(subpage.Key.ToString().ToUpper(), Is.EqualTo(&quot;FF11402B-7E53-4654-81A7-462AC2108059&quot;));
                Assert.That(trashed.Key, Is.Not.EqualTo(Guid.Empty));
            }
        }

        [Test]
        public void Can_Get_Content_By_Guid_Key()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out contentTypeRepository))
            {
                // Act
                var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Key == new Guid(&quot;B58B3AD4-62C2-4E27-B1BE-837BD7C533E0&quot;));
                var content = repository.GetByQuery(query).SingleOrDefault();

                // Assert
                Assert.That(content, Is.Not.Null);
                Assert.That(content.Id, Is.EqualTo(NodeDto.NodeIdSeed + 1));
            }

        }

        public void CreateTestData()
        {
            //Create and Save ContentType &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed)
            ContentType contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage&quot;, &quot;Textpage&quot;);
            contentType.Key = new Guid(&quot;1D3A8E6E-2EA9-4CC1-B229-1AEE19821522&quot;);
            ServiceContext.ContentTypeService.Save(contentType);

            //Create and Save Content &quot;Homepage&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 1)
            Content textpage = MockedContent.CreateSimpleContent(contentType);
            textpage.Key = new Guid(&quot;B58B3AD4-62C2-4E27-B1BE-837BD7C533E0&quot;);
            ServiceContext.ContentService.Save(textpage, 0);

            //Create and Save Content &quot;Text Page 1&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 2)
            Content subpage = MockedContent.CreateSimpleContent(contentType, &quot;Text Page 1&quot;, textpage.Id);
            subpage.Key = new Guid(&quot;FF11402B-7E53-4654-81A7-462AC2108059&quot;);
            ServiceContext.ContentService.Save(subpage, 0);

            //Create and Save Content &quot;Text Page 1&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 3)
            Content subpage2 = MockedContent.CreateSimpleContent(contentType, &quot;Text Page 2&quot;, textpage.Id);
            ServiceContext.ContentService.Save(subpage2, 0);

            //Create and Save Content &quot;Text Page Deleted&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 4)
            Content trashed = MockedContent.CreateSimpleContent(contentType, &quot;Text Page Deleted&quot;, -20);
            trashed.Trashed = true;
            ServiceContext.ContentService.Save(trashed, 0);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[35,9,35,10,1],[36,13,36,31,1],[38,13,38,30,1],[40,13,40,76,1],[41,9,41,10,1],[45,9,45,10,1],[46,13,46,77,1],[48,13,48,29,1],[49,9,49,10,1],[52,9,52,10,1],[54,13,54,96,1],[55,13,55,129,1],[56,13,56,33,1],[57,9,57,10,1],[60,9,60,10,1],[62,13,62,84,1],[63,9,63,10,1],[66,9,66,10,1],[67,13,67,179,1],[68,13,68,95,1],[69,13,69,127,1],[70,13,70,182,1],[71,13,71,31,1],[72,9,72,10,1],[76,9,76,10,1],[78,13,78,67,1],[79,13,79,55,1],[83,13,83,45,1],[84,20,84,92,1],[85,13,85,14,1],[86,17,86,119,1],[87,17,87,88,1],[90,17,90,77,1],[91,17,91,50,1],[92,17,92,37,1],[93,17,93,48,1],[96,17,96,73,1],[97,17,97,50,1],[98,17,98,37,1],[99,17,99,48,1],[102,17,102,44,1],[103,17,103,69,1],[104,17,104,50,1],[105,17,105,37,1],[106,17,106,48,1],[107,13,107,14,1],[110,13,110,61,1],[111,20,111,92,1],[112,13,112,14,1],[113,17,113,121,1],[114,17,114,63,1],[116,17,116,55,1],[117,17,117,63,1],[119,17,119,24,1],[119,26,119,37,1],[119,38,119,40,1],[119,41,119,49,1],[120,17,120,18,1],[121,21,121,64,1],[122,21,122,47,1],[123,21,123,63,1],[124,17,124,18,1],[125,13,125,14,1],[126,9,126,10,1],[130,9,130,10,1],[132,13,132,67,1],[133,13,133,55,1],[137,20,137,92,1],[138,13,138,14,1],[139,17,139,119,1],[140,17,140,88,1],[142,17,142,77,1],[143,17,143,50,1],[144,17,144,37,1],[145,13,145,14,1],[147,13,147,61,1],[150,13,150,69,1],[151,18,151,31,1],[151,33,151,56,1],[151,58,151,65,1],[152,13,152,14,1],[153,17,153,47,1],[154,17,154,66,1],[155,17,160,19,1],[161,17,161,66,1],[162,17,162,45,1],[163,17,173,20,1],[174,13,174,14,1],[177,20,177,92,1],[178,13,178,14,1],[179,17,179,118,1],[180,17,180,52,1],[181,17,181,77,1],[181,77,181,106,1],[181,106,181,110,1],[181,110,181,111,1],[181,77,181,111,1],[181,111,181,124,1],[181,17,181,124,1],[182,17,182,119,1],[182,119,182,148,1],[182,148,182,152,1],[182,152,182,153,1],[182,119,182,153,1],[182,153,182,207,1],[182,17,182,207,1],[184,17,184,77,1],[185,17,185,47,1],[187,17,187,59,1],[188,17,188,47,1],[189,17,189,120,1],[189,120,189,149,1],[189,149,189,153,1],[189,153,189,154,1],[189,120,189,154,1],[189,154,189,208,1],[189,17,189,208,1],[190,17,190,78,1],[190,78,190,107,1],[190,107,190,111,1],[190,111,190,112,1],[190,78,190,112,1],[190,112,190,125,1],[190,17,190,125,1],[192,17,192,76,1],[193,17,193,64,1],[193,64,193,75,1],[193,75,193,120,1],[193,17,193,120,1],[194,17,194,84,1],[194,84,194,93,1],[194,93,194,97,1],[194,17,194,97,1],[195,17,195,55,1],[195,55,195,64,1],[195,64,195,97,1],[195,17,195,97,1],[196,13,196,14,1],[197,9,197,10,1],[209,9,209,10,1],[211,13,211,67,1],[212,13,212,55,1],[215,13,215,51,1],[216,20,216,92,1],[217,13,217,14,1],[218,17,218,84,1],[219,17,219,119,1],[220,17,220,92,1],[221,17,221,83,1],[222,17,222,92,1],[225,17,225,69,1],[226,17,226,77,1],[227,17,227,50,1],[228,17,228,50,1],[229,17,229,50,1],[230,17,230,37,1],[232,17,232,42,1],[233,17,233,42,1],[234,17,234,42,1],[235,13,235,14,1],[238,20,238,92,1],[239,13,239,14,1],[242,17,242,71,1],[242,71,242,75,1],[242,75,242,98,1],[242,17,242,98,1],[244,17,244,24,1],[244,26,244,37,1],[244,38,244,40,1],[244,41,244,47,1],[245,17,245,18,1],[246,21,246,28,1],[246,30,246,49,1],[246,50,246,52,1],[246,53,246,71,1],[247,21,247,22,1],[253,25,253,68,1],[254,21,254,22,1],[255,17,255,18,1],[256,13,256,14,1],[257,9,257,10,1],[261,9,261,10,1],[262,13,262,67,1],[263,13,263,55,1],[265,20,265,92,1],[266,13,266,14,1],[267,17,267,105,1],[268,17,268,65,1],[270,17,270,55,1],[273,22,273,31,1],[273,33,273,40,1],[273,42,273,45,1],[274,17,274,18,1],[275,21,275,78,1],[276,21,276,48,1],[277,21,277,40,1],[278,17,278,18,1],[280,22,280,31,1],[280,33,280,40,1],[280,42,280,45,1],[281,17,281,18,1],[282,21,282,78,1],[283,21,283,71,1],[284,21,284,48,1],[285,21,285,40,1],[286,17,286,18,1],[287,17,287,37,1],[290,22,290,31,1],[290,33,290,53,1],[290,55,290,58,1],[291,17,291,18,1],[292,21,292,53,1],[296,21,296,78,1],[297,21,297,59,1],[298,17,298,18,1],[299,17,299,37,1],[302,17,302,74,1],[303,17,303,114,1],[305,17,305,58,1],[305,58,305,78,1],[305,78,305,84,1],[305,17,305,84,1],[307,17,307,116,1],[308,13,308,14,1],[309,9,309,10,1],[313,9,313,10,1],[314,13,314,67,1],[315,13,315,55,1],[317,20,317,92,1],[318,13,318,14,1],[320,17,320,105,1],[321,17,321,65,1],[322,17,322,55,1],[324,22,324,31,1],[324,33,324,40,1],[324,42,324,45,1],[325,17,325,18,1],[327,21,327,78,1],[328,21,328,48,1],[329,21,329,40,1],[330,17,330,18,1],[331,22,331,31,1],[331,33,331,40,1],[331,42,331,45,1],[332,17,332,18,1],[333,21,333,78,1],[334,21,334,71,1],[335,21,335,48,1],[336,21,336,40,1],[337,17,337,18,1],[338,17,338,37,1],[341,22,341,31,1],[341,33,341,53,1],[341,55,341,58,1],[342,17,342,18,1],[343,21,343,53,1],[344,21,344,59,1],[345,17,345,18,1],[346,17,346,37,1],[349,17,349,74,1],[350,17,350,114,1],[352,17,352,58,1],[352,58,352,78,1],[352,78,352,84,1],[352,17,352,84,1],[354,17,354,116,1],[355,13,355,14,1],[356,9,356,10,1],[360,9,360,10,1],[361,13,361,67,1],[362,13,362,55,1],[364,20,364,92,1],[365,13,365,14,1],[367,17,367,74,1],[369,17,369,105,1],[370,17,370,65,1],[371,17,371,55,1],[373,22,373,31,1],[373,33,373,40,1],[373,42,373,45,1],[374,17,374,18,1],[376,21,376,78,1],[377,21,377,48,1],[378,21,378,40,1],[379,17,379,18,1],[380,22,380,31,1],[380,33,380,40,1],[380,42,380,45,1],[381,17,381,18,1],[382,21,382,78,1],[383,21,383,71,1],[384,21,384,48,1],[385,21,385,40,1],[386,17,386,18,1],[387,17,387,37,1],[390,22,390,31,1],[390,33,390,53,1],[390,55,390,58,1],[391,17,391,18,1],[392,21,392,53,1],[393,21,393,59,1],[394,17,394,18,1],[395,17,395,37,1],[398,17,398,84,1],[399,17,399,54,1],[400,17,400,37,1],[402,17,406,20,1],[408,17,408,58,1],[408,58,408,78,1],[408,78,408,84,1],[408,17,408,84,1],[410,17,410,116,1],[411,13,411,14,1],[412,9,412,10,1],[416,9,416,10,1],[417,13,417,67,1],[418,13,418,55,1],[420,20,420,92,1],[421,13,421,14,1],[422,17,422,105,1],[423,17,423,105,1],[424,17,424,105,1],[425,17,425,65,1],[426,17,426,65,1],[427,17,427,65,1],[429,17,429,55,1],[431,22,431,31,1],[431,33,431,39,1],[431,41,431,44,1],[432,17,432,18,1],[434,21,434,78,1],[435,21,435,48,1],[436,21,436,40,1],[437,17,437,18,1],[438,22,438,31,1],[438,33,438,39,1],[438,41,438,44,1],[439,17,439,18,1],[440,21,440,78,1],[441,21,441,71,1],[442,21,442,48,1],[443,21,443,40,1],[444,17,444,18,1],[445,22,445,31,1],[445,33,445,39,1],[445,41,445,44,1],[446,17,446,18,1],[447,21,447,78,1],[448,21,448,71,1],[449,21,449,48,1],[450,21,450,40,1],[451,17,451,18,1],[452,22,452,31,1],[452,33,452,39,1],[452,41,452,44,1],[453,17,453,18,1],[454,21,454,78,1],[455,21,455,71,1],[456,21,456,48,1],[457,21,457,40,1],[458,17,458,18,1],[459,17,459,37,1],[462,22,462,31,1],[462,33,462,53,1],[462,55,462,58,1],[463,17,463,18,1],[464,21,464,53,1],[465,21,465,59,1],[466,17,466,18,1],[467,17,467,37,1],[470,17,470,74,1],[471,17,471,114,1],[473,17,473,58,1],[473,58,473,78,1],[473,78,473,144,1],[473,17,473,144,1],[475,17,475,115,1],[476,13,476,14,1],[477,9,477,10,1],[490,9,490,10,1],[491,13,491,67,1],[492,13,492,55,1],[495,20,495,126,1],[496,13,496,14,1],[498,17,498,157,1],[499,17,499,63,1],[500,17,500,37,1],[505,17,505,58,1],[507,17,513,24,1],[514,17,514,130,1],[515,17,515,64,1],[516,17,516,37,1],[519,17,519,152,1],[522,17,522,50,1],[523,17,523,37,1],[526,17,526,63,1],[527,17,527,60,1],[529,17,529,69,1],[530,17,530,80,1],[531,17,531,89,1],[532,17,532,124,1],[533,17,533,84,1],[534,17,534,116,1],[535,17,535,95,1],[536,17,536,126,1],[537,13,537,14,1],[538,9,538,10,1],[542,9,542,10,1],[544,13,544,67,1],[545,13,545,55,1],[548,20,548,92,1],[549,13,549,14,1],[550,17,550,106,1],[551,17,553,61,1],[553,61,553,75,1],[553,75,554,19,1],[551,17,554,19,1],[555,17,555,81,1],[556,17,556,64,1],[557,17,557,52,1],[558,17,558,37,1],[561,17,561,85,1],[562,17,562,101,1],[563,17,563,51,1],[564,17,564,37,1],[567,17,567,84,1],[568,17,568,57,1],[569,17,569,88,1],[570,13,570,14,1],[572,9,572,10,1],[576,9,576,10,1],[578,13,578,67,1],[579,13,579,55,1],[581,20,581,92,1],[582,13,582,14,1],[583,17,583,114,1],[584,17,584,84,1],[587,17,587,64,1],[588,17,588,50,1],[589,17,589,37,1],[592,17,592,63,1],[593,17,593,60,1],[596,13,596,14,1],[597,9,597,10,1],[601,9,601,10,1],[603,13,603,67,1],[604,13,604,55,1],[607,20,607,116,1],[608,13,608,14,1],[609,17,609,63,1],[610,17,610,58,1],[611,17,611,37,1],[613,17,613,114,1],[614,17,614,78,1],[615,17,615,58,1],[616,17,616,83,1],[620,17,620,64,1],[621,17,621,50,1],[622,17,622,37,1],[624,17,624,59,1],[627,17,627,61,1],[628,17,628,89,1],[630,17,630,103,1],[631,13,631,14,1],[632,9,632,10,1],[637,9,637,10,1],[639,13,639,67,1],[640,13,640,55,1],[642,20,642,92,1],[643,13,643,14,1],[644,17,644,106,1],[645,17,645,64,1],[646,17,646,37,1],[648,17,648,103,1],[649,17,649,106,1],[653,17,653,50,1],[654,17,654,57,1],[655,17,655,37,1],[658,17,658,63,1],[659,17,659,60,1],[661,17,661,59,1],[662,17,662,70,1],[664,17,664,67,1],[665,17,665,78,1],[666,13,666,14,1],[667,9,667,10,1],[671,9,671,10,1],[673,13,673,67,1],[674,13,674,55,1],[676,20,676,92,1],[677,13,677,14,1],[678,17,678,114,1],[679,17,679,83,1],[682,17,682,64,1],[683,17,683,50,1],[684,17,684,37,1],[686,17,686,110,1],[687,17,687,49,1],[688,17,688,37,1],[691,17,691,63,1],[692,17,692,60,1],[693,17,693,59,1],[694,17,694,72,1],[695,13,695,14,1],[697,9,697,10,1],[702,9,702,10,1],[704,13,704,67,1],[705,13,705,55,1],[707,20,707,92,1],[708,13,708,14,1],[710,17,710,70,1],[711,17,711,59,1],[714,17,714,46,1],[715,13,715,14,1],[716,9,716,10,1],[720,9,720,10,1],[722,13,722,67,1],[723,13,723,55,1],[725,20,725,92,1],[726,13,726,14,1],[728,17,728,70,1],[729,17,729,42,1],[730,17,730,49,1],[731,17,731,37,1],[732,17,732,77,1],[735,17,735,72,1],[736,17,736,76,1],[737,13,737,14,1],[739,9,739,10,1],[743,9,743,10,1],[745,13,745,67,1],[746,13,746,55,1],[748,20,748,92,1],[749,13,749,14,1],[751,17,751,70,1],[752,17,752,41,1],[753,17,753,49,1],[754,17,754,37,1],[755,17,755,77,1],[758,17,758,63,1],[759,13,759,14,1],[761,9,761,10,1],[765,9,765,10,1],[767,13,767,67,1],[768,13,768,55,1],[770,20,770,92,1],[771,13,771,14,1],[772,17,772,81,1],[773,17,773,105,1],[774,17,774,39,1],[775,17,775,38,1],[778,17,778,49,1],[779,17,779,37,1],[780,17,780,37,1],[782,17,782,44,1],[783,17,783,37,1],[785,17,785,51,1],[788,17,788,48,1],[789,13,789,14,1],[790,9,790,10,1],[794,9,794,10,1],[796,13,796,67,1],[797,13,797,55,1],[799,20,799,92,1],[800,13,800,14,1],[802,17,802,70,1],[805,17,805,77,1],[806,17,806,84,1],[807,17,807,84,1],[808,17,808,66,1],[809,17,809,70,1],[811,17,811,74,1],[812,17,812,84,1],[813,17,813,57,1],[814,17,814,64,1],[815,13,815,14,1],[816,9,816,10,1],[820,9,820,10,1],[822,13,822,67,1],[823,13,823,55,1],[825,20,825,92,1],[826,13,826,14,1],[828,17,828,78,1],[829,17,829,59,1],[832,17,832,73,1],[833,13,833,14,1],[834,9,834,10,1],[838,9,838,10,1],[840,13,840,67,1],[841,13,841,55,1],[843,20,843,92,1],[844,13,844,14,1],[845,17,845,60,1],[846,17,846,24,1],[846,26,846,37,1],[846,38,846,40,1],[846,41,846,47,1],[847,17,847,18,1],[848,21,848,72,1],[849,21,849,53,1],[850,17,850,18,1],[851,17,851,37,1],[852,17,852,24,1],[852,26,852,37,1],[852,38,852,40,1],[852,41,852,47,1],[853,17,853,18,1],[854,21,854,76,1],[855,21,855,53,1],[856,17,856,18,1],[857,17,857,37,1],[861,17,861,61,1],[863,17,863,66,1],[864,13,864,14,1],[865,9,865,10,1],[869,9,869,10,1],[871,13,871,67,1],[872,13,872,55,1],[874,20,874,92,1],[875,13,875,14,1],[877,17,877,89,1],[881,17,881,18,1],[882,21,882,68,1],[883,21,883,63,1],[885,21,885,136,1],[887,21,887,54,1],[888,21,888,56,1],[890,21,890,132,1],[892,21,892,56,1],[893,17,893,18,1],[895,17,895,18,1],[896,21,896,69,1],[897,21,897,64,1],[898,17,898,18,1],[899,13,899,14,1],[900,9,900,10,1],[904,9,904,10,1],[906,13,906,67,1],[907,13,907,55,1],[909,20,909,92,1],[910,13,910,14,1],[912,17,912,78,1],[916,17,916,18,1],[917,21,917,68,1],[918,21,918,63,1],[919,21,919,134,1],[922,21,922,75,1],[923,21,923,64,1],[924,21,924,81,1],[925,17,925,18,1],[927,17,927,18,1],[928,21,928,69,1],[929,21,929,64,1],[930,17,930,18,1],[931,13,931,14,1],[932,9,932,10,1],[936,9,936,10,1],[938,13,938,67,1],[939,13,939,55,1],[941,20,941,92,1],[942,13,942,14,1],[944,17,944,78,1],[946,17,946,130,1],[949,17,949,71,1],[950,17,950,60,1],[951,17,951,77,1],[952,13,952,14,1],[953,9,953,10,1],[957,9,957,10,1],[959,13,959,67,1],[960,13,960,55,1],[962,20,962,92,1],[963,13,963,14,1],[965,17,965,78,1],[967,17,967,130,1],[970,17,970,71,1],[971,17,971,60,1],[972,17,972,77,1],[973,13,973,14,1],[974,9,974,10,1],[978,9,978,10,1],[980,13,980,67,1],[981,13,981,55,1],[983,20,983,92,1],[984,13,984,14,1],[986,17,986,78,1],[988,17,988,131,1],[991,17,991,71,1],[992,17,992,60,1],[993,17,993,77,1],[994,13,994,14,1],[995,9,995,10,1],[999,9,999,10,1],[1001,13,1001,67,1],[1002,13,1002,55,1],[1004,20,1004,92,1],[1005,13,1005,14,1],[1007,17,1007,78,1],[1008,17,1008,97,1],[1011,17,1011,143,1],[1014,17,1014,58,1],[1015,17,1015,60,1],[1016,17,1016,77,1],[1017,13,1017,14,1],[1018,9,1018,10,1],[1022,9,1022,10,1],[1024,13,1024,67,1],[1025,13,1025,55,1],[1027,20,1027,92,1],[1028,13,1028,14,1],[1030,17,1030,78,1],[1031,17,1031,95,1],[1034,17,1034,143,1],[1037,17,1037,58,1],[1038,17,1038,60,1],[1039,17,1039,77,1],[1040,13,1040,14,1],[1041,9,1041,10,1],[1045,9,1045,10,1],[1047,13,1047,67,1],[1048,13,1048,55,1],[1050,20,1050,92,1],[1051,13,1051,14,1],[1053,17,1053,98,1],[1056,17,1056,52,1],[1057,17,1057,54,1],[1058,17,1058,62,1],[1059,13,1059,14,1],[1060,9,1060,10,1],[1064,9,1064,10,1],[1066,13,1066,67,1],[1067,13,1067,55,1],[1069,20,1069,92,1],[1070,13,1070,14,1],[1072,17,1072,52,1],[1075,17,1075,52,1],[1076,17,1076,54,1],[1077,17,1077,75,1],[1078,13,1078,14,1],[1081,9,1081,10,1],[1085,9,1085,10,1],[1087,13,1087,67,1],[1088,13,1088,55,1],[1090,20,1090,92,1],[1091,13,1091,14,1],[1093,17,1093,72,1],[1096,17,1096,46,1],[1097,13,1097,14,1],[1100,9,1100,10,1],[1104,9,1104,10,1],[1106,13,1106,67,1],[1107,13,1107,55,1],[1109,20,1109,92,1],[1110,13,1110,14,1],[1112,17,1112,31,1],[1113,17,1113,82,1],[1114,17,1114,54,1],[1117,17,1117,65,1],[1118,13,1118,14,1],[1119,9,1119,10,1],[1123,9,1123,10,1],[1125,13,1125,67,1],[1126,13,1126,55,1],[1128,20,1128,92,1],[1129,13,1129,14,1],[1131,17,1131,71,1],[1132,17,1132,70,1],[1133,17,1133,70,1],[1136,17,1136,116,1],[1137,17,1137,115,1],[1138,17,1138,70,1],[1139,13,1139,14,1],[1140,9,1140,10,1],[1144,9,1144,10,1],[1146,13,1146,67,1],[1147,13,1147,55,1],[1149,20,1149,92,1],[1150,13,1150,14,1],[1152,17,1152,123,1],[1153,17,1153,78,1],[1156,17,1156,51,1],[1157,17,1157,77,1],[1158,13,1158,14,1],[1160,9,1160,10,1],[1163,9,1163,10,1],[1165,13,1165,109,1],[1166,13,1166,80,1],[1167,13,1167,65,1],[1170,13,1170,79,1],[1171,13,1171,77,1],[1172,13,1172,61,1],[1175,13,1175,106,1],[1176,13,1176,76,1],[1177,13,1177,60,1],[1180,13,1180,107,1],[1181,13,1181,61,1],[1184,13,1184,104,1],[1185,13,1185,36,1],[1186,13,1186,60,1],[1187,9,1187,10,1]]);
    </script>
  </body>
</html>