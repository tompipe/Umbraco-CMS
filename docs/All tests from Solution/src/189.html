<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Resolvers\LazyManyObjectResolverTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;

namespace Umbraco.Tests.Resolvers
{
	[TestFixture]
	public class LazyManyObjectResolverTests
	{

		[SetUp]
		public void Initialize()
		{
		    LazyResolver.Reset();
        }

		[TearDown]
		public void TearDown()
		{
            LazyResolver.Reset();
		}

		[Test]
		public void LazyResolverResolvesLazyTypes()
		{
			var resolver = new LazyResolver(
                new ActivatorServiceProvider(),
                Mock.Of&lt;ILogger&gt;(),
                new[] { new Lazy&lt;Type&gt;(() =&gt; typeof (TransientObject3)) });

			resolver.AddType&lt;TransientObject1&gt;();
			resolver.AddType(new Lazy&lt;Type&gt;(() =&gt; typeof(TransientObject2)));			

			Resolution.Freeze();

			Assert.IsFalse(resolver.HasResolvedTypes);

			var values = resolver.Objects;
			
			Assert.IsTrue(resolver.HasResolvedTypes);

            Assert.AreEqual(3, values.Count());
            Assert.IsTrue(values.Select(x =&gt; x.GetType())
                .ContainsAll(new [] { typeof(TransientObject1), typeof(TransientObject2), typeof(TransientObject3) }));
		}

		[Test]
		public void LazyResolverResolvesTypeProducers()
		{
			Func&lt;IEnumerable&lt;Type&gt;&gt; types = () =&gt; new[] { typeof(TransientObject3), typeof(TransientObject2) };

			var resolver = new LazyResolver(
                new ActivatorServiceProvider(),
                Mock.Of&lt;ILogger&gt;(),
                types);
			resolver.AddTypeListDelegate(() =&gt; new[] { typeof(TransientObject1)});

			Resolution.Freeze();

			var values = resolver.Objects;

			Assert.AreEqual(3, values.Count());
			Assert.IsTrue(values.Select(x =&gt; x.GetType())
                .ContainsAll(new[] { typeof(TransientObject1), typeof(TransientObject2), typeof(TransientObject3) }));
		}

		[Test]
		public void LazyResolverResolvesBothWays()
		{
			Func&lt;IEnumerable&lt;Type&gt;&gt; types = () =&gt; new[] { typeof(TransientObject3) };

			var resolver = new LazyResolver(
                new ActivatorServiceProvider(),
                Mock.Of&lt;ILogger&gt;(),
                types);
			resolver.AddType(new Lazy&lt;Type&gt;(() =&gt; typeof(TransientObject2)));
			resolver.AddType&lt;TransientObject1&gt;();

			Resolution.Freeze();

			var values = resolver.Objects;

			Assert.AreEqual(3, values.Count());
			Assert.IsTrue(values.Select(x =&gt; x.GetType())
                .ContainsAll(new[] { typeof(TransientObject1), typeof(TransientObject2), typeof(TransientObject3) }));
		}

		[Test]
		public void LazyResolverThrowsOnDuplicate()
		{
			Func&lt;IEnumerable&lt;Type&gt;&gt; types = () =&gt; new[] { typeof(TransientObject3), typeof(TransientObject2), typeof(TransientObject1) };

			var resolver = new LazyResolver(
                new ActivatorServiceProvider(),
                Mock.Of&lt;ILogger&gt;(),
                types);

			// duplicate, but will not throw here
			resolver.AddType&lt;TransientObject1&gt;();

			Resolution.Freeze();

			Assert.Throws&lt;InvalidOperationException&gt;(() =&gt;
				{
					var values = resolver.Objects;
				});
		}

        [Test]
        public void LazyResolverThrowsOnInvalidType()
        {
            Func&lt;IEnumerable&lt;Type&gt;&gt; types = () =&gt; new[] { typeof(TransientObject3), typeof(TransientObject2), typeof(TransientObject1) };

            var resolver = new LazyResolver(
                new ActivatorServiceProvider(),
                Mock.Of&lt;ILogger&gt;(),
                types);

            // invalid, but will not throw here
            resolver.AddType(new Lazy&lt;Type&gt;(() =&gt; typeof(TransientObject4)));

            Resolution.Freeze();

            Assert.Throws&lt;InvalidOperationException&gt;(() =&gt;
            {
                var values = resolver.Objects;
            });
        }

        [Test]
        public void LazyResolverSupportsRemove()
        {
            Func&lt;IEnumerable&lt;Type&gt;&gt; types = () =&gt; new[] { typeof(TransientObject3), typeof(TransientObject2), typeof(TransientObject1) };

            var resolver = new LazyResolver(
                new ActivatorServiceProvider(),
                Mock.Of&lt;ILogger&gt;(),
                types);

            resolver.RemoveType(typeof(TransientObject3));

            Resolution.Freeze();

            var values = resolver.Objects;
            Assert.IsFalse(values.Select(x =&gt; x.GetType()).Contains(typeof(TransientObject3)));
            Assert.IsTrue(values.Select(x =&gt; x.GetType()).ContainsAll(new[] { typeof(TransientObject2), typeof(TransientObject1) }));
        }
        
		#region Test classes

		private interface ITestInterface
		{ }

		private class TransientObject1 : ITestInterface
		{ }

		private class TransientObject2 : ITestInterface
		{ }

		private class TransientObject3 : ITestInterface
		{ }

        private class TransientObject4
        { }

		private sealed class LazyResolver : LazyManyObjectsResolverBase&lt;LazyResolver, ITestInterface&gt;
		{
			public LazyResolver(IServiceProvider serviceProvider, ILogger logger)
                : base(serviceProvider, logger, ObjectLifetimeScope.Transient)
			{ }

			public LazyResolver(IServiceProvider serviceProvider, ILogger logger, IEnumerable&lt;Lazy&lt;Type&gt;&gt; values)
				:base (serviceProvider, logger, values, ObjectLifetimeScope.Transient)
			{ }

            public LazyResolver(IServiceProvider serviceProvider, ILogger logger, Func&lt;IEnumerable&lt;Type&gt;&gt; typeList)
                : base(serviceProvider, logger, typeList, ObjectLifetimeScope.Transient)
            { }

			public IEnumerable&lt;ITestInterface&gt; Objects
			{
				get { return Values; }
			}
		}
		
		#endregion
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,3,19,4,1],[20,7,20,28,1],[21,9,21,10,1],[25,3,25,4,1],[26,13,26,34,1],[27,3,27,4,1],[31,3,31,4,1],[32,4,35,46,1],[35,46,35,71,1],[35,71,35,76,1],[32,4,35,76,1],[37,4,37,41,1],[38,4,38,42,1],[38,42,38,66,1],[38,66,38,69,1],[38,4,38,69,1],[40,4,40,24,1],[42,4,42,46,1],[44,4,44,34,1],[46,4,46,45,1],[48,13,48,48,1],[49,13,49,46,1],[49,46,49,57,1],[49,57,50,120,1],[49,13,50,120,1],[51,3,51,4,1],[55,3,55,4,1],[56,4,56,42,1],[56,42,56,102,1],[56,102,56,103,1],[56,4,56,103,1],[58,4,61,24,1],[62,4,62,39,1],[62,39,62,72,1],[62,72,62,74,1],[62,4,62,74,1],[64,4,64,24,1],[66,4,66,34,1],[68,4,68,39,1],[69,4,69,37,1],[69,37,69,48,1],[69,48,70,119,1],[69,4,70,119,1],[71,3,71,4,1],[75,3,75,4,1],[76,4,76,42,1],[76,42,76,76,1],[76,76,76,77,1],[76,4,76,77,1],[78,4,81,24,1],[82,4,82,42,1],[82,42,82,66,1],[82,66,82,69,1],[82,4,82,69,1],[83,4,83,41,1],[85,4,85,24,1],[87,4,87,34,1],[89,4,89,39,1],[90,4,90,37,1],[90,37,90,48,1],[90,48,91,119,1],[90,4,91,119,1],[92,3,92,4,1],[96,3,96,4,1],[97,4,97,42,1],[97,42,97,128,1],[97,128,97,129,1],[97,4,97,129,1],[99,4,102,24,1],[105,4,105,41,1],[107,4,107,24,1],[109,4,110,5,1],[110,5,110,6,1],[110,6,111,6,1],[111,6,111,36,1],[111,36,112,5,1],[112,5,112,6,0],[112,6,112,8,1],[109,4,112,8,1],[113,3,113,4,1],[117,9,117,10,1],[118,13,118,51,1],[118,51,118,137,1],[118,137,118,138,1],[118,13,118,138,1],[120,13,123,24,1],[126,13,126,51,1],[126,51,126,75,1],[126,75,126,78,1],[126,13,126,78,1],[128,13,128,33,1],[130,13,131,13,1],[131,13,131,14,1],[131,14,132,17,1],[132,17,132,47,1],[132,47,133,13,1],[133,13,133,14,0],[133,14,133,16,1],[130,13,133,16,1],[134,9,134,10,1],[138,9,138,10,1],[139,13,139,51,1],[139,51,139,137,1],[139,137,139,138,1],[139,13,139,138,1],[141,13,144,24,1],[146,13,146,59,1],[148,13,148,33,1],[150,13,150,43,1],[151,13,151,47,1],[151,47,151,58,1],[151,58,151,96,1],[151,13,151,96,1],[152,13,152,46,1],[152,46,152,57,1],[152,57,152,134,1],[152,13,152,134,1],[153,9,153,10,1],[175,19,175,79,0],[176,4,176,5,0],[176,6,176,7,0],[179,6,179,75,1],[180,4,180,5,1],[180,6,180,7,1],[183,19,183,89,1],[184,13,184,14,1],[184,15,184,16,1],[188,9,188,10,1],[188,11,188,25,1],[188,26,188,27,1]]);
    </script>
  </body>
</html>