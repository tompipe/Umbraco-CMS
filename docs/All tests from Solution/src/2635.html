<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\uploadfield\uploadFieldPreValue.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Web.UI;
using System.Web.UI.WebControls;

using umbraco.BusinessLogic;
using umbraco.DataLayer;

namespace umbraco.editorControls.uploadfield
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    class uploadFieldPreValue : System.Web.UI.WebControls.PlaceHolder, interfaces.IDataPrevalue
	{
	
		// UI controls
        private TextBox _textboxThumbnails;
		private DropDownList _dropdownlist;
				
		// referenced datatype
		private cms.businesslogic.datatype.BaseDataType _datatype;

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        public static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        public uploadFieldPreValue(cms.businesslogic.datatype.BaseDataType DataType) 
		{
			// state it knows its datatypedefinitionid
			_datatype = DataType;
			setupChildControls();

		}
		
		private void setupChildControls() 
		{
			_dropdownlist = new DropDownList();
			_dropdownlist.ID = &quot;dbtype&quot;;
			_dropdownlist.Items.Add(DBTypes.Date.ToString());
			_dropdownlist.Items.Add(DBTypes.Integer.ToString());
			_dropdownlist.Items.Add(DBTypes.Ntext.ToString());
			_dropdownlist.Items.Add(DBTypes.Nvarchar.ToString());


			_textboxThumbnails = new TextBox();
            _textboxThumbnails.ID = &quot;thumbNailSizes&quot;;

			// put the childcontrols in context - ensuring that
			// the viewstate is persisted etc.
			this.Controls.Add(_dropdownlist);
            this.Controls.Add(_textboxThumbnails);

		}
		
		protected override void OnLoad(EventArgs e)
		{
			base.OnLoad (e);
			if (!Page.IsPostBack)
			{
				string[] config = Configuration.Split(&quot;|&quot;.ToCharArray());
				if (config.Length &gt; 0) 
				{
                    _textboxThumbnails.Text = config[0];
				}
                _dropdownlist.SelectedValue = _datatype.DBType.ToString();
			}
		}
		
		public Control Editor 
		{
			get
			{
				return this;
			}
		}

		public void Save() 
		{
            _datatype.DBType = (umbraco.cms.businesslogic.datatype.DBTypes)Enum.Parse(typeof(umbraco.cms.businesslogic.datatype.DBTypes), _dropdownlist.SelectedValue, true);

			// Generate data-string
            string data = _textboxThumbnails.Text;
            // If the add new prevalue textbox is filled out - add the value to the collection.
            using (var sqlHelper = Application.SqlHelper)
            {
                IParameter[] SqlParams = new IParameter[] {
                                            sqlHelper.CreateParameter(&quot;@value&quot;,data),
                                            sqlHelper.CreateParameter(&quot;@dtdefid&quot;,_datatype.DataTypeDefinitionId)};
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsDataTypePreValues where datatypenodeid = @dtdefid&quot;, SqlParams);
                // need to unlock the parameters (for SQL CE compat)
                SqlParams = new IParameter[] {
                                            sqlHelper.CreateParameter(&quot;@value&quot;,data),
                                            sqlHelper.CreateParameter(&quot;@dtdefid&quot;,_datatype.DataTypeDefinitionId)};
                sqlHelper.ExecuteNonQuery(&quot;insert into cmsDataTypePreValues (datatypenodeid,[value],sortorder,alias) values (@dtdefid,@value,0,&#39;&#39;)&quot;, SqlParams);
            }
		}

		protected override void Render(HtmlTextWriter writer)
		{
			writer.WriteLine(&quot;&lt;table&gt;&quot;);
			writer.WriteLine(&quot;&lt;tr&gt;&lt;th&gt;Database datatype&lt;/th&gt;&lt;td&gt;&quot;);
			_dropdownlist.RenderControl(writer);
			writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
			writer.Write(&quot;&lt;tr&gt;&lt;th&gt;Thumbnail sizes (max width/height, semicolon separated for multiples):&lt;/th&gt;&lt;td&gt;&quot;);
            _textboxThumbnails.RenderControl(writer);
			writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
			writer.Write(&quot;&lt;/table&gt;&quot;);
		}

		public string Configuration 
		{
			get 
			{
                using (var sqlHelper = Application.SqlHelper)
                {
                    object configVal = sqlHelper.ExecuteScalar&lt;object&gt;(&quot;select value from cmsDataTypePreValues where datatypenodeid = @datatypenodeid&quot;, sqlHelper.CreateParameter(&quot;@datatypenodeid&quot;, _datatype.DataTypeDefinitionId));
                    if (configVal != null)
                        return configVal.ToString();
                    else
                        return &quot;&quot;;
                }
			}
		}

	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,17,28,18,0],[28,19,28,48,0],[28,49,28,50,0],[31,9,31,85,0],[32,3,32,4,0],[34,4,34,25,0],[35,4,35,25,0],[37,3,37,4,0],[40,3,40,4,0],[41,4,41,39,0],[42,4,42,32,0],[43,4,43,53,0],[44,4,44,56,0],[45,4,45,54,0],[46,4,46,57,0],[49,4,49,39,0],[50,13,50,54,0],[54,4,54,37,0],[55,13,55,51,0],[57,3,57,4,0],[60,3,60,4,0],[61,4,61,20,0],[62,4,62,25,0],[63,4,63,5,0],[64,5,64,62,0],[65,5,65,27,0],[66,5,66,6,0],[67,21,67,57,0],[68,5,68,6,0],[69,17,69,75,0],[70,4,70,5,0],[71,3,71,4,0],[76,4,76,5,0],[77,5,77,17,0],[78,4,78,5,0],[82,3,82,4,0],[83,13,83,174,0],[86,13,86,51,0],[88,20,88,57,0],[89,13,89,14,0],[90,17,92,115,0],[93,17,93,122,0],[95,17,97,115,0],[98,17,98,161,0],[99,13,99,14,0],[100,3,100,4,0],[103,3,103,4,0],[104,4,104,32,0],[105,4,105,59,0],[106,4,106,40,0],[107,4,107,31,0],[108,4,108,108,0],[109,13,109,54,0],[110,4,110,31,0],[111,4,111,29,0],[112,3,112,4,0],[117,4,117,5,0],[118,24,118,61,0],[119,17,119,18,0],[120,21,120,231,0],[121,21,121,43,0],[122,25,122,53,0],[124,25,124,35,0],[126,4,126,5,0]]);
    </script>
  </body>
</html>