<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\File.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Reflection;
using System.Runtime.Serialization;
using System.Text;
using Umbraco.Core.IO;
using Umbraco.Core.Models.EntityBase;

namespace Umbraco.Core.Models
{
    /// &lt;summary&gt;
    /// Represents an abstract file which provides basic functionality for a File with an Alias and Name
    /// &lt;/summary&gt;
    [Serializable]
    [DataContract(IsReference = true)]
    public abstract class File : Entity, IFile
    {
        private string _path;
        private string _originalPath;

        // initialize to string.Empty so that it is possible to save a new file,
        // should use the lazyContent ctor to set it to null when loading existing.
        // cannot simply use HasIdentity as some classes (eg Script) override it
        // in a weird way.
        private string _content;
        internal Func&lt;File, string&gt; GetFileContent { get; set; }

        protected File(string path, Func&lt;File, string&gt; getFileContent = null)
        {
            _path = SanitizePath(path);
            _originalPath = _path;
            GetFileContent = getFileContent;
            _content = getFileContent != null ? null : string.Empty;
        }

        private static readonly Lazy&lt;PropertySelectors&gt; Ps = new Lazy&lt;PropertySelectors&gt;();

        private class PropertySelectors
        {
            public readonly PropertyInfo ContentSelector = ExpressionHelper.GetPropertyInfo&lt;File, string&gt;(x =&gt; x.Content);
            public readonly PropertyInfo PathSelector = ExpressionHelper.GetPropertyInfo&lt;File, string&gt;(x =&gt; x.Path);
        }

        private string _alias;
        private string _name;

        private static string SanitizePath(string path)
        {
            return path
                .Replace(&#39;\\&#39;, System.IO.Path.DirectorySeparatorChar)
                .Replace(&#39;/&#39;, System.IO.Path.DirectorySeparatorChar);
                //.TrimStart(System.IO.Path.DirectorySeparatorChar);
        }

        /// &lt;summary&gt;
        /// Gets or sets the Name of the File including extension
        /// &lt;/summary&gt;
        [DataMember]
        public virtual string Name
        {
            get { return _name ?? (_name = System.IO.Path.GetFileName(Path)); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the Alias of the File, which is the name without the extension
        /// &lt;/summary&gt;
        [DataMember]
        public virtual string Alias
        {
            get
            {
                if (_alias == null)
                {                   
                    var name = System.IO.Path.GetFileName(Path);
                    if (name == null) return string.Empty;
                    var lastIndexOf = name.LastIndexOf(&quot;.&quot;, StringComparison.InvariantCultureIgnoreCase);
                    _alias = name.Substring(0, lastIndexOf);
                }
                return _alias;
            }
        }

        /// &lt;summary&gt;
        /// Gets or sets the Path to the File from the root of the file&#39;s associated IFileSystem
        /// &lt;/summary&gt;
        [DataMember]
        public virtual string Path
        {
            get { return _path; }
            set
            {
                //reset
                _alias = null;
                _name = null;

                SetPropertyValueAndDetectChanges(SanitizePath(value), ref _path, Ps.Value.PathSelector);                
            }
        }

        /// &lt;summary&gt;
        /// Gets the original path of the file
        /// &lt;/summary&gt;
        public string OriginalPath
        {
            get { return _originalPath; }
        }

        /// &lt;summary&gt;
        /// Called to re-set the OriginalPath to the Path
        /// &lt;/summary&gt;
        public void ResetOriginalPath()
        {
            _originalPath = _path;
        }

        /// &lt;summary&gt;
        /// Gets or sets the Content of a File
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Marked as DoNotClone, because it should be lazy-reloaded from disk.&lt;/remarks&gt;
        [DataMember]
        [DoNotClone]
        public virtual string Content
        {
            get
            {
                if (_content != null)
                    return _content;

                // else, must lazy-load, and ensure it&#39;s not null
                if (GetFileContent != null)
                    _content = GetFileContent(this);
                return _content ?? (_content = string.Empty);
            }
            set
            {
                SetPropertyValueAndDetectChanges(
                    value ?? string.Empty, // cannot set to null
                    ref _content, Ps.Value.ContentSelector);                
            }
        }

        /// &lt;summary&gt;
        /// Gets or sets the file&#39;s virtual path (i.e. the file path relative to the root of the website)
        /// &lt;/summary&gt;
        public string VirtualPath { get; set; }

        [Obsolete(&quot;This is no longer used and will be removed from the codebase in future versions&quot;)]
        public virtual bool IsValid()
        {
            return true;
        }

        // this exists so that class that manage name and alias differently, eg Template,
        // can implement their own cloning - (though really, not sure it&#39;s even needed)
        protected virtual void DeepCloneNameAndAlias(File clone)
        {
            // set fields that have a lazy value, by forcing evaluation of the lazy
            clone._name = Name;
            clone._alias = Alias;
        }

        public override object DeepClone()
        {
            var clone = (File) base.DeepClone();

            // clear fields that were memberwise-cloned and that we don&#39;t want to clone
            clone._content = null;

            // turn off change tracking
            clone.DisableChangeTracking();

            // ...
            DeepCloneNameAndAlias(clone);

            // this shouldn&#39;t really be needed since we&#39;re not tracking
            clone.ResetDirtyProperties(false);

            // re-enable tracking
            clone.EnableChangeTracking();

            return clone;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,54,26,58,1],[26,59,26,63,1],[28,9,28,78,1],[29,9,29,10,1],[30,13,30,40,1],[31,13,31,35,1],[32,13,32,45,1],[33,13,33,69,1],[34,9,34,10,1],[36,9,36,92,1],[40,13,40,123,1],[41,13,41,117,1],[48,9,48,10,1],[49,13,51,70,1],[53,9,53,10,1],[61,17,61,18,1],[61,19,61,78,1],[61,79,61,80,1],[71,13,71,14,1],[72,17,72,36,1],[73,17,73,18,1],[74,21,74,65,1],[75,21,75,38,1],[75,39,75,59,0],[76,21,76,106,1],[77,21,77,61,1],[78,17,78,18,1],[79,17,79,31,1],[80,13,80,14,1],[89,17,89,18,1],[89,19,89,32,1],[89,33,89,34,1],[91,13,91,14,1],[93,17,93,31,1],[94,17,94,30,1],[96,17,96,105,1],[97,13,97,14,1],[105,17,105,18,1],[105,19,105,40,1],[105,41,105,42,1],[112,9,112,10,1],[113,13,113,35,1],[114,9,114,10,1],[125,13,125,14,1],[126,17,126,38,1],[127,21,127,37,1],[130,17,130,44,1],[131,21,131,53,1],[132,17,132,62,1],[133,13,133,14,1],[135,13,135,14,1],[136,17,138,61,1],[139,13,139,14,1],[145,37,145,41,1],[145,42,145,46,1],[149,9,149,10,0],[150,13,150,25,0],[151,9,151,10,0],[156,9,156,10,0],[158,13,158,32,0],[159,13,159,34,0],[160,9,160,10,0],[163,9,163,10,1],[164,13,164,49,1],[167,13,167,35,1],[170,13,170,43,1],[173,13,173,42,1],[176,13,176,47,1],[179,13,179,42,1],[181,13,181,26,1],[182,9,182,10,1]]);
    </script>
  </body>
</html>