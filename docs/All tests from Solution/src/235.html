<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Cache\DefaultCachePolicyTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Web.Caching;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Cache;
using Umbraco.Core.Models;

namespace Umbraco.Tests.Cache
{
    [TestFixture]
    public class DefaultCachePolicyTests
    {
        [Test]
        public void Caches_Single()
        {
            var isCached = false;
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.InsertCacheItem(It.IsAny&lt;string&gt;(), It.IsAny&lt;Func&lt;object&gt;&gt;(), It.IsAny&lt;TimeSpan?&gt;(), It.IsAny&lt;bool&gt;(),
                It.IsAny&lt;CacheItemPriority&gt;(), It.IsAny&lt;CacheItemRemovedCallback&gt;(), It.IsAny&lt;string[]&gt;()))
                .Callback(() =&gt;
                {
                    isCached = true;
                });

            var defaultPolicy = new DefaultRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, new RepositoryCachePolicyOptions());
            using (defaultPolicy)
            {
                var found = defaultPolicy.Get(1, o =&gt; new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123));
            }
            Assert.IsTrue(isCached);
        }

        [Test]
        public void Get_Single_From_Cache()
        {
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.GetCacheItem(It.IsAny&lt;string&gt;())).Returns(new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123));

            var defaultPolicy = new DefaultRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, new RepositoryCachePolicyOptions());
            using (defaultPolicy)
            {
                var found = defaultPolicy.Get(1, o =&gt; (AuditItem) null);
                Assert.IsNotNull(found);
            }
        }

        [Test]
        public void Caches_Per_Id_For_Get_All()
        {
            var cached = new List&lt;string&gt;();
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.InsertCacheItem(It.IsAny&lt;string&gt;(), It.IsAny&lt;Func&lt;object&gt;&gt;(), It.IsAny&lt;TimeSpan?&gt;(), It.IsAny&lt;bool&gt;(),
                It.IsAny&lt;CacheItemPriority&gt;(), It.IsAny&lt;CacheItemRemovedCallback&gt;(), It.IsAny&lt;string[]&gt;()))
                .Callback((string cacheKey, Func&lt;object&gt; o, TimeSpan? t, bool b, CacheItemPriority cip, CacheItemRemovedCallback circ, string[] s) =&gt;
                {
                    cached.Add(cacheKey);
                });
            cache.Setup(x =&gt; x.GetCacheItemsByKeySearch(It.IsAny&lt;string&gt;())).Returns(new AuditItem[] {});

            var defaultPolicy = new DefaultRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, new RepositoryCachePolicyOptions());
            using (defaultPolicy)
            {
                var found = defaultPolicy.GetAll(new object[] {}, o =&gt; new[]
                {
                    new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123),
                    new AuditItem(2, &quot;blah2&quot;, AuditType.Copy, 123)
                });
            }

            Assert.AreEqual(2, cached.Count);
        }

        [Test]
        public void Get_All_Without_Ids_From_Cache()
        {
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.GetCacheItemsByKeySearch(It.IsAny&lt;string&gt;())).Returns(new[]
            {
                new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123),
                new AuditItem(2, &quot;blah2&quot;, AuditType.Copy, 123)
            });

            var defaultPolicy = new DefaultRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, new RepositoryCachePolicyOptions());
            using (defaultPolicy)
            {
                var found = defaultPolicy.GetAll(new object[] {}, o =&gt; new[] {(AuditItem) null});
                Assert.AreEqual(2, found.Length);
            }
        }

        [Test]
        public void If_CreateOrUpdate_Throws_Cache_Is_Removed()
        {
            var cacheCleared = false;
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.ClearCacheItem(It.IsAny&lt;string&gt;()))
                .Callback(() =&gt;
                {
                    cacheCleared = true;
                });

            var defaultPolicy = new DefaultRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, new RepositoryCachePolicyOptions());
            try
            {
                using (defaultPolicy)
                {
                    defaultPolicy.CreateOrUpdate(new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123), item =&gt;
                    {
                        throw new Exception(&quot;blah!&quot;);
                    });
                }
            }
            catch
            {
                //we need this catch or nunit throw up
            }
            finally
            {
                Assert.IsTrue(cacheCleared);
            }
        }

        [Test]
        public void If_Removes_Throws_Cache_Is_Removed()
        {
            var cacheCleared = false;
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.ClearCacheItem(It.IsAny&lt;string&gt;()))
                .Callback(() =&gt;
                {
                    cacheCleared = true;
                });

            var defaultPolicy = new DefaultRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, new RepositoryCachePolicyOptions());
            try
            {
                using (defaultPolicy)
                {
                    defaultPolicy.Remove(new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123), item =&gt;
                    {
                        throw new Exception(&quot;blah!&quot;);
                    });
                }
            }
            catch
            {
                //we need this catch or nunit throw up
            }
            finally
            {
                Assert.IsTrue(cacheCleared);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,1],[17,13,17,34,1],[18,13,18,59,1],[19,13,22,17,1],[22,17,22,18,1],[22,18,23,21,1],[23,21,23,37,1],[23,37,24,17,1],[24,17,24,18,1],[24,18,24,20,1],[19,13,24,20,1],[26,13,26,135,1],[27,13,27,34,1],[28,13,28,14,1],[29,17,29,55,1],[29,55,29,100,1],[29,100,29,102,1],[29,17,29,102,1],[30,13,30,14,1],[31,13,31,37,1],[32,9,32,10,1],[36,9,36,10,1],[37,13,37,59,1],[38,13,38,121,1],[40,13,40,135,1],[41,13,41,34,1],[42,13,42,14,1],[43,17,43,55,1],[43,55,43,71,0],[43,71,43,73,1],[43,17,43,73,1],[44,17,44,41,1],[45,13,45,14,1],[46,9,46,10,1],[50,9,50,10,1],[51,13,51,45,1],[52,13,52,59,1],[53,13,56,17,1],[56,17,56,18,1],[56,18,57,21,1],[57,21,57,42,1],[57,42,58,17,1],[58,17,58,18,1],[58,18,58,20,1],[53,13,58,20,1],[59,13,59,106,1],[61,13,61,135,1],[62,13,62,34,1],[63,13,63,14,1],[64,17,64,72,1],[64,72,68,18,1],[68,18,68,20,1],[64,17,68,20,1],[69,13,69,14,1],[71,13,71,46,1],[72,9,72,10,1],[76,9,76,10,1],[77,13,77,59,1],[78,13,82,16,1],[84,13,84,135,1],[85,13,85,34,1],[86,13,86,14,1],[87,17,87,72,1],[87,72,87,96,0],[87,96,87,98,1],[87,17,87,98,1],[88,17,88,50,1],[89,13,89,14,1],[90,9,90,10,1],[94,9,94,10,1],[95,13,95,38,1],[96,13,96,59,1],[97,13,99,17,1],[99,17,99,18,1],[99,18,100,21,1],[100,21,100,41,1],[100,41,101,17,1],[101,17,101,18,1],[101,18,101,20,1],[97,13,101,20,1],[103,13,103,135,1],[105,13,105,14,1],[106,17,106,38,1],[107,17,107,18,1],[108,21,109,21,1],[109,21,109,22,1],[109,22,110,25,1],[110,25,110,54,1],[110,54,111,24,1],[108,21,111,24,1],[112,17,112,18,0],[113,13,113,14,0],[114,13,114,18,1],[115,13,115,14,1],[117,13,117,14,1],[119,13,119,14,1],[120,17,120,45,1],[121,13,121,14,1],[122,9,122,10,1],[126,9,126,10,1],[127,13,127,38,1],[128,13,128,59,1],[129,13,131,17,1],[131,17,131,18,1],[131,18,132,21,1],[132,21,132,41,1],[132,41,133,17,1],[133,17,133,18,1],[133,18,133,20,1],[129,13,133,20,1],[135,13,135,135,1],[137,13,137,14,1],[138,17,138,38,1],[139,17,139,18,1],[140,21,141,21,1],[141,21,141,22,1],[141,22,142,25,1],[142,25,142,54,1],[142,54,143,24,1],[140,21,143,24,1],[144,17,144,18,0],[145,13,145,14,0],[146,13,146,18,1],[147,13,147,14,1],[149,13,149,14,1],[151,13,151,14,1],[152,17,152,45,1],[153,13,153,14,1],[154,9,154,10,1]]);
    </script>
  </body>
</html>