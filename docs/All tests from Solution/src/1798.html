<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Syntax\Alter\Table\AlterTableBuilder.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Data;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.Migrations.Syntax.Alter.Expressions;
using Umbraco.Core.Persistence.Migrations.Syntax.Expressions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Syntax.Alter.Table
{
    public class AlterTableBuilder : ExpressionBuilder&lt;AlterTableExpression, IAlterTableColumnOptionSyntax&gt;,
                                               IAlterTableColumnTypeSyntax,
                                               IAlterTableColumnOptionForeignKeyCascadeSyntax
    {
        private readonly IMigrationContext _context;
        private readonly DatabaseProviders[] _databaseProviders;

        public AlterTableBuilder(IMigrationContext context, DatabaseProviders[] databaseProviders, AlterTableExpression expression)
            : base(expression)
        {
            _context = context;
            _databaseProviders = databaseProviders;
        }

        public ColumnDefinition CurrentColumn { get; set; }

        public ForeignKeyDefinition CurrentForeignKey { get; set; }

        public override ColumnDefinition GetColumnForType()
        {
            return CurrentColumn;
        }

        public IAlterTableColumnOptionSyntax WithDefault(SystemMethods method)
        {
            CurrentColumn.DefaultValue = method;
            return this;
        }

        public IAlterTableColumnOptionSyntax WithDefaultValue(object value)
        {
            if (CurrentColumn.ModificationType == ModificationType.Alter)
            {
                var dc = new AlterDefaultConstraintExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax)
                             {
                                 TableName = Expression.TableName,
                                 SchemaName = Expression.SchemaName,
                                 ColumnName = CurrentColumn.Name,
                                 DefaultValue = value
                             };

                _context.Expressions.Add(dc);
            }

            CurrentColumn.DefaultValue = value;
            return this;
        }

        public IAlterTableColumnOptionSyntax Identity()
        {
            CurrentColumn.IsIdentity = true;
            return this;
        }

        public IAlterTableColumnOptionSyntax Indexed()
        {
            return Indexed(null);
        }

        public IAlterTableColumnOptionSyntax Indexed(string indexName)
        {
            CurrentColumn.IsIndexed = true;

            var index = new CreateIndexExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new IndexDefinition
            {
                Name = indexName,
                SchemaName = Expression.SchemaName,
                TableName = Expression.TableName
            });

            index.Index.Columns.Add(new IndexColumnDefinition
                                        {
                                            Name = CurrentColumn.Name
                                        });

            _context.Expressions.Add(index);

            return this;
        }

        public IAlterTableColumnOptionSyntax PrimaryKey()
        {
            CurrentColumn.IsPrimaryKey = true;
            return this;
        }

        public IAlterTableColumnOptionSyntax PrimaryKey(string primaryKeyName)
        {
            CurrentColumn.IsPrimaryKey = true;
            CurrentColumn.PrimaryKeyName = primaryKeyName;
            return this;
        }

        public IAlterTableColumnOptionSyntax Nullable()
        {
            CurrentColumn.IsNullable = true;
            return this;
        }

        public IAlterTableColumnOptionSyntax NotNullable()
        {
            CurrentColumn.IsNullable = false;
            return this;
        }

        public IAlterTableColumnOptionSyntax Unique()
        {
            return Unique(null);
        }

        public IAlterTableColumnOptionSyntax Unique(string indexName)
        {
            CurrentColumn.IsUnique = true;

            var index = new CreateIndexExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new IndexDefinition
            {
                Name = indexName,
                SchemaName = Expression.SchemaName,
                TableName = Expression.TableName,
                IsUnique = true
            });

            index.Index.Columns.Add(new IndexColumnDefinition
                                        {
                                            Name = CurrentColumn.Name
                                        });

            _context.Expressions.Add(index);

            return this;
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax ForeignKey(string primaryTableName, string primaryColumnName)
        {
            return ForeignKey(null, null, primaryTableName, primaryColumnName);
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax ForeignKey(string foreignKeyName, string primaryTableName,
                                                                         string primaryColumnName)
        {
            return ForeignKey(foreignKeyName, null, primaryTableName, primaryColumnName);
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax ForeignKey(string foreignKeyName, string primaryTableSchema,
                                                                         string primaryTableName, string primaryColumnName)
        {
            CurrentColumn.IsForeignKey = true;

            var fk = new CreateForeignKeyExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new ForeignKeyDefinition
            {
                Name = foreignKeyName,
                PrimaryTable = primaryTableName,
                PrimaryTableSchema = primaryTableSchema,
                ForeignTable = Expression.TableName,
                ForeignTableSchema = Expression.SchemaName
            });

            fk.ForeignKey.PrimaryColumns.Add(primaryColumnName);
            fk.ForeignKey.ForeignColumns.Add(CurrentColumn.Name);

            _context.Expressions.Add(fk);
            CurrentForeignKey = fk.ForeignKey;
            return this;
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax ForeignKey()
        {
            CurrentColumn.IsForeignKey = true;
            return this;
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignTableName, string foreignColumnName)
        {
            return ReferencedBy(null, null, foreignTableName, foreignColumnName);
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignKeyName, string foreignTableName,
                                                                           string foreignColumnName)
        {
            return ReferencedBy(foreignKeyName, null, foreignTableName, foreignColumnName);
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignKeyName, string foreignTableSchema,
                                                                           string foreignTableName, string foreignColumnName)
        {
            var fk = new CreateForeignKeyExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new ForeignKeyDefinition
            {
                Name = foreignKeyName,
                PrimaryTable = Expression.TableName,
                PrimaryTableSchema = Expression.SchemaName,
                ForeignTable = foreignTableName,
                ForeignTableSchema = foreignTableSchema
            });

            fk.ForeignKey.PrimaryColumns.Add(CurrentColumn.Name);
            fk.ForeignKey.ForeignColumns.Add(foreignColumnName);

            _context.Expressions.Add(fk);
            CurrentForeignKey = fk.ForeignKey;
            return this;
        }

        public IAlterTableColumnTypeSyntax AddColumn(string name)
        {
            var column = new ColumnDefinition { Name = name, ModificationType = ModificationType.Create };
            var createColumn = new CreateColumnExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax)
                                   {
                                       Column = column,
                                       SchemaName = Expression.SchemaName,
                                       TableName = Expression.TableName
                                   };

            CurrentColumn = column;

            _context.Expressions.Add(createColumn);
            return this;
        }

        public IAlterTableColumnTypeSyntax AlterColumn(string name)
        {
            var column = new ColumnDefinition { Name = name, ModificationType = ModificationType.Alter };
            var alterColumn = new AlterColumnExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax)
            {
                Column = column,
                SchemaName = Expression.SchemaName,
                TableName = Expression.TableName
            };

            CurrentColumn = column;

            _context.Expressions.Add(alterColumn);
            return this;
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax OnDelete(Rule rule)
        {
            CurrentForeignKey.OnDelete = rule;
            return this;
        }

        public IAlterTableColumnOptionForeignKeyCascadeSyntax OnUpdate(Rule rule)
        {
            CurrentForeignKey.OnUpdate = rule;
            return this;
        }

        public IAlterTableColumnOptionSyntax OnDeleteOrUpdate(Rule rule)
        {
            OnDelete(rule);
            OnUpdate(rule);
            return this;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,15,17,31,1],[18,9,18,10,1],[19,13,19,32,1],[20,13,20,52,1],[21,9,21,10,1],[23,49,23,53,1],[23,54,23,58,1],[25,57,25,61,0],[25,62,25,66,0],[28,9,28,10,1],[29,13,29,34,1],[30,9,30,10,1],[33,9,33,10,0],[34,13,34,49,0],[35,13,35,25,0],[36,9,36,10,0],[39,9,39,10,1],[40,13,40,74,1],[41,13,41,14,0],[42,17,48,32,0],[50,17,50,46,0],[51,13,51,14,0],[53,13,53,48,1],[54,13,54,25,1],[55,9,55,10,1],[58,9,58,10,0],[59,13,59,45,0],[60,13,60,25,0],[61,9,61,10,0],[64,9,64,10,0],[65,13,65,34,0],[66,9,66,10,0],[69,9,69,10,0],[70,13,70,44,0],[72,13,77,16,0],[79,13,82,44,0],[84,13,84,45,0],[86,13,86,25,0],[87,9,87,10,0],[90,9,90,10,0],[91,13,91,47,0],[92,13,92,25,0],[93,9,93,10,0],[96,9,96,10,0],[97,13,97,47,0],[98,13,98,59,0],[99,13,99,25,0],[100,9,100,10,0],[103,9,103,10,1],[104,13,104,45,1],[105,13,105,25,1],[106,9,106,10,1],[109,9,109,10,1],[110,13,110,46,1],[111,13,111,25,1],[112,9,112,10,1],[115,9,115,10,0],[116,13,116,33,0],[117,9,117,10,0],[120,9,120,10,0],[121,13,121,43,0],[123,13,129,16,0],[131,13,134,44,0],[136,13,136,45,0],[138,13,138,25,0],[139,9,139,10,0],[142,9,142,10,0],[143,13,143,80,0],[144,9,144,10,0],[148,9,148,10,0],[149,13,149,90,0],[150,9,150,10,0],[154,9,154,10,0],[155,13,155,47,0],[157,13,164,16,0],[166,13,166,65,0],[167,13,167,66,0],[169,13,169,42,0],[170,13,170,47,0],[171,13,171,25,0],[172,9,172,10,0],[175,9,175,10,0],[176,13,176,47,0],[177,13,177,25,0],[178,9,178,10,0],[181,9,181,10,0],[182,13,182,82,0],[183,9,183,10,0],[187,9,187,10,0],[188,13,188,92,0],[189,9,189,10,0],[193,9,193,10,0],[194,13,201,16,0],[203,13,203,66,0],[204,13,204,65,0],[206,13,206,42,0],[207,13,207,47,0],[208,13,208,25,0],[209,9,209,10,0],[212,9,212,10,1],[213,13,213,107,1],[214,13,219,38,1],[221,13,221,36,1],[223,13,223,52,1],[224,13,224,25,1],[225,9,225,10,1],[228,9,228,10,0],[229,13,229,106,0],[230,13,235,15,0],[237,13,237,36,0],[239,13,239,51,0],[240,13,240,25,0],[241,9,241,10,0],[244,9,244,10,0],[245,13,245,47,0],[246,13,246,25,0],[247,9,247,10,0],[250,9,250,10,0],[251,13,251,47,0],[252,13,252,25,0],[253,9,253,10,0],[256,9,256,10,0],[257,13,257,28,0],[258,13,258,28,0],[259,13,259,25,0],[260,9,260,10,0]]);
    </script>
  </body>
</html>