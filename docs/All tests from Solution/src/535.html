<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\publishingService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Diagnostics;
using System.Net;
using System.Web;
using System.Xml;
using Umbraco.Core.Configuration;
using Umbraco.Core;
using Umbraco.Core.Logging;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.web;
using Umbraco.Core.Publishing;

namespace umbraco.presentation
{
    [Obsolete(&quot;This is no longer used and will be removed in future versions&quot;)]
	public class publishingService
	{
		private static readonly Hashtable ScheduledTaskTimes = new Hashtable();
		private static bool _isPublishingRunning = false;
		
        //NOTE: sender will be the umbraco ApplicationContext
		public static void CheckPublishing(object sender)
		{
			if(_isPublishingRunning)
				return;
			_isPublishingRunning = true;
			try
			{
                //run the scheduled publishing - we need to determine if this server 

                var publisher = new ScheduledPublisher(ApplicationContext.Current.Services.ContentService);
                publisher.CheckPendingAndProcess();

				// run scheduled url tasks
				try
				{
                    foreach (var t in UmbracoConfig.For.UmbracoSettings().ScheduledTasks.Tasks)
                    {
                        bool runTask = false;
                        if (!ScheduledTaskTimes.ContainsKey(t.Alias))
                        {
                            runTask = true;
                            ScheduledTaskTimes.Add(t.Alias, DateTime.Now);
                        }
                        // Add 1 second to timespan to compensate for differencies in timer
                        else if (
                            new TimeSpan(
                                DateTime.Now.Ticks - ((DateTime)ScheduledTaskTimes[t.Alias]).Ticks).TotalSeconds + 1 &gt;= t.Interval)
                        {
                            runTask = true;
                            ScheduledTaskTimes[t.Alias] = DateTime.Now;
                        }

                        if (runTask)
                        {
                            bool taskResult = GetTaskByHttp(t.Url);
                            if (t.Log)
                                LogHelper.Info&lt;publishingService&gt;(string.Format(&quot;{0} has been called with response: {1}&quot;, t.Alias, taskResult));
                        }
                    }
				}
				catch(Exception ee)
				{
                    LogHelper.Error&lt;publishingService&gt;(&quot;Error executing scheduled task&quot;, ee);
				}
			}
			catch(Exception x)
			{
                LogHelper.Error&lt;publishingService&gt;(&quot;Error executing scheduled publishing&quot;, x);
			}
			finally
			{
				_isPublishingRunning = false;
			}
		}

		private static bool GetTaskByHttp(string url)
		{
			var myHttpWebRequest = (HttpWebRequest)WebRequest.Create(url);

            try
            {
                using (var myHttpWebResponse = (HttpWebResponse)myHttpWebRequest.GetResponse())
                {
                    return myHttpWebResponse.StatusCode == HttpStatusCode.OK;
                }
            }
            catch (Exception ex)
            {
                LogHelper.Error&lt;publishingService&gt;(&quot;Error sending url request for scheduled task&quot;, ex);
            }

		    return false;
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,3,19,74,0],[20,3,20,52,0],[24,3,24,4,0],[25,4,25,28,0],[26,5,26,12,0],[27,4,27,32,0],[29,4,29,5,0],[32,17,32,108,0],[33,17,33,52,0],[37,5,37,6,0],[38,21,38,28,0],[38,30,38,35,0],[38,36,38,38,0],[38,39,38,95,0],[39,21,39,22,0],[40,25,40,46,0],[41,25,41,70,0],[42,25,42,26,0],[43,29,43,44,0],[44,29,44,75,0],[45,25,45,26,0],[47,30,49,132,0],[50,25,50,26,0],[51,29,51,44,0],[52,29,52,72,0],[53,25,53,26,0],[55,25,55,37,0],[56,25,56,26,0],[57,29,57,68,0],[58,29,58,39,0],[59,33,59,145,0],[60,25,60,26,0],[61,21,61,22,0],[62,5,62,6,0],[63,5,63,24,0],[64,5,64,6,0],[65,21,65,94,0],[66,5,66,6,0],[67,4,67,5,0],[68,4,68,22,0],[69,4,69,5,0],[70,17,70,95,0],[71,4,71,5,0],[73,4,73,5,0],[74,5,74,34,0],[75,4,75,5,0],[76,3,76,4,0],[79,3,79,4,0],[80,4,80,66,0],[83,13,83,14,0],[84,24,84,95,0],[85,17,85,18,0],[86,21,86,78,0],[89,13,89,33,0],[90,13,90,14,0],[91,17,91,104,0],[92,13,92,14,0],[94,7,94,20,0],[95,3,95,4,0]]);
    </script>
  </body>
</html>