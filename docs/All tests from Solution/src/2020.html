<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\ContentType.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization;

namespace Umbraco.Core.Models
{
    /// &lt;summary&gt;
    /// Represents the content type that a &lt;see cref=&quot;Content&quot;/&gt; object is based on
    /// &lt;/summary&gt;
    [Serializable]
    [DataContract(IsReference = true)]
    public class ContentType : ContentTypeCompositionBase, IContentType
    {
        private int _defaultTemplate;
        private IEnumerable&lt;ITemplate&gt; _allowedTemplates;

        /// &lt;summary&gt;
        /// Constuctor for creating a ContentType with the parent&#39;s id.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Only use this for creating ContentTypes at the root (with ParentId -1).&lt;/remarks&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;&lt;/param&gt;
        public ContentType(int parentId) : base(parentId)
        {
            _allowedTemplates = new List&lt;ITemplate&gt;();
        }

        /// &lt;summary&gt;
        /// Constuctor for creating a ContentType with the parent as an inherited type.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Use this to ensure inheritance from parent.&lt;/remarks&gt;
        /// &lt;param name=&quot;parent&quot;&gt;&lt;/param&gt;
        [Obsolete(&quot;This method is obsolete, use ContentType(IContentType parent, string alias) instead.&quot;, false)]
        public ContentType(IContentType parent) : this(parent, null)
        {
        }

        /// &lt;summary&gt;
        /// Constuctor for creating a ContentType with the parent as an inherited type.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Use this to ensure inheritance from parent.&lt;/remarks&gt;
        /// &lt;param name=&quot;parent&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
        public ContentType(IContentType parent, string alias)
            : base(parent, alias)
        {
            _allowedTemplates = new List&lt;ITemplate&gt;();
        }

        private static readonly Lazy&lt;PropertySelectors&gt; Ps = new Lazy&lt;PropertySelectors&gt;();

        private class PropertySelectors
        {
            public readonly PropertyInfo DefaultTemplateSelector = ExpressionHelper.GetPropertyInfo&lt;ContentType, int&gt;(x =&gt; x.DefaultTemplateId);
            public readonly PropertyInfo AllowedTemplatesSelector = ExpressionHelper.GetPropertyInfo&lt;ContentType, IEnumerable&lt;ITemplate&gt;&gt;(x =&gt; x.AllowedTemplates);
        }

        /// &lt;summary&gt;
        /// Gets or sets the alias of the default Template.
        /// TODO: This should be ignored from cloning!!!!!!!!!!!!!!
        ///  - but to do that we have to implement callback hacks, this needs to be fixed in v8, 
        ///     we should not store direct entity
        /// &lt;/summary&gt;
        [IgnoreDataMember]
        public ITemplate DefaultTemplate
        {
            get { return AllowedTemplates.FirstOrDefault(x =&gt; x != null &amp;&amp; x.Id == DefaultTemplateId); }
        }

        /// &lt;summary&gt;
        /// Internal property to store the Id of the default template
        /// &lt;/summary&gt;
        [DataMember]
        internal int DefaultTemplateId
        {
            get { return _defaultTemplate; }
            set { SetPropertyValueAndDetectChanges(value, ref _defaultTemplate, Ps.Value.DefaultTemplateSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or Sets a list of Templates which are allowed for the ContentType
        /// TODO: This should be ignored from cloning!!!!!!!!!!!!!!
        ///  - but to do that we have to implement callback hacks, this needs to be fixed in v8, 
        ///     we should not store direct entity
        /// &lt;/summary&gt;
        [DataMember]
        public IEnumerable&lt;ITemplate&gt; AllowedTemplates
        {
            get { return _allowedTemplates; }
            set
            {
                SetPropertyValueAndDetectChanges(value, ref _allowedTemplates, Ps.Value.AllowedTemplatesSelector,
                    //Custom comparer for enumerable
                    new DelegateEqualityComparer&lt;IEnumerable&lt;ITemplate&gt;&gt;(
                        (templates, enumerable) =&gt; templates.UnsortedSequenceEqual(enumerable),
                        templates =&gt; templates.GetHashCode()));
            }
        }

        /// &lt;summary&gt;
        /// Sets the default template for the ContentType
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;template&quot;&gt;Default &lt;see cref=&quot;ITemplate&quot;/&gt;&lt;/param&gt;
        public void SetDefaultTemplate(ITemplate template)
        {
            if (template == null)
            {
                DefaultTemplateId = 0;
                return;
            }

            DefaultTemplateId = template.Id;
            if (_allowedTemplates.Any(x =&gt; x != null &amp;&amp; x.Id == template.Id) == false)
            {
                var templates = AllowedTemplates.ToList();
                templates.Add(template);
                AllowedTemplates = templates;
            }
        }

        /// &lt;summary&gt;
        /// Removes a template from the list of allowed templates
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;template&quot;&gt;&lt;see cref=&quot;ITemplate&quot;/&gt; to remove&lt;/param&gt;
        /// &lt;returns&gt;True if template was removed, otherwise False&lt;/returns&gt;
        public bool RemoveTemplate(ITemplate template)
        {
            if (DefaultTemplateId == template.Id)
                DefaultTemplateId = default(int);

            var templates = AllowedTemplates.ToList();
            var remove = templates.FirstOrDefault(x =&gt; x.Id == template.Id);
            var result = templates.Remove(remove);
            AllowedTemplates = templates;

            return result;
        }

        /// &lt;summary&gt;
        /// Creates a deep clone of the current entity with its identity/alias and it&#39;s property identities reset
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use DeepCloneWithResetIdentities instead&quot;)]
        public IContentType Clone(string alias)
        {
            return DeepCloneWithResetIdentities(alias);
        }

        /// &lt;summary&gt;
        /// Creates a deep clone of the current entity with its identity/alias and it&#39;s property identities reset
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IContentType DeepCloneWithResetIdentities(string alias)
        {
            var clone = (ContentType)DeepClone();
            clone.Alias = alias;
            clone.Key = Guid.Empty;
            foreach (var propertyGroup in clone.PropertyGroups)
            {
                propertyGroup.ResetIdentity();
                propertyGroup.ResetDirtyProperties(false);
            }
            foreach (var propertyType in clone.PropertyTypes)
            {
                propertyType.ResetIdentity();
                propertyType.ResetDirtyProperties(false);
            }

            clone.ResetIdentity();
            clone.ResetDirtyProperties(false);
            return clone;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,44,24,58,1],[25,9,25,10,1],[26,13,26,55,1],[27,9,27,10,1],[35,51,35,69,0],[36,9,36,10,0],[37,9,37,10,0],[46,15,46,34,1],[47,9,47,10,1],[48,13,48,55,1],[49,9,49,10,1],[51,9,51,92,1],[55,13,55,145,1],[56,13,56,164,1],[68,17,68,18,1],[68,19,68,63,1],[68,63,68,101,1],[68,101,68,103,1],[68,19,68,103,1],[68,104,68,105,1],[77,17,77,18,1],[77,19,77,43,1],[77,44,77,45,1],[78,17,78,18,1],[78,19,78,115,1],[78,116,78,117,1],[90,17,90,18,1],[90,19,90,44,1],[90,45,90,46,1],[92,13,92,14,1],[93,17,96,52,1],[96,52,96,95,1],[96,95,97,38,1],[97,38,97,61,0],[97,61,97,64,1],[93,17,97,64,1],[98,13,98,14,1],[106,9,106,10,1],[107,13,107,34,1],[108,13,108,14,1],[109,17,109,39,1],[110,17,110,24,1],[113,13,113,45,1],[114,13,114,44,1],[114,44,114,76,1],[114,76,114,87,1],[114,13,114,87,1],[115,13,115,14,1],[116,17,116,59,1],[117,17,117,41,1],[118,17,118,46,1],[119,13,119,14,1],[120,9,120,10,1],[128,9,128,10,0],[129,13,129,50,0],[130,17,130,50,0],[132,13,132,55,0],[133,13,133,56,0],[133,56,133,75,0],[133,75,133,77,0],[133,13,133,77,0],[134,13,134,51,0],[135,13,135,42,0],[137,13,137,27,0],[138,9,138,10,0],[146,9,146,10,1],[147,13,147,56,1],[148,9,148,10,1],[155,9,155,10,1],[156,13,156,50,1],[157,13,157,33,1],[158,13,158,36,1],[159,13,159,20,1],[159,22,159,39,1],[159,40,159,42,1],[159,43,159,63,1],[160,13,160,14,1],[161,17,161,47,1],[162,17,162,59,1],[163,13,163,14,1],[164,13,164,20,1],[164,22,164,38,1],[164,39,164,41,1],[164,42,164,61,1],[165,13,165,14,1],[166,17,166,46,1],[167,17,167,58,1],[168,13,168,14,1],[170,13,170,35,1],[171,13,171,47,1],[172,13,172,26,1],[173,9,173,10,1]]);
    </script>
  </body>
</html>