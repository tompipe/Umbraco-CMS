<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\MemberAuthorizeAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using System.Web.Security;
using Umbraco.Web.Security;
using umbraco.cms.businesslogic.member;
using AuthorizeAttribute = System.Web.Mvc.AuthorizeAttribute;
using Umbraco.Core;

namespace Umbraco.Web.Mvc
{
    /// &lt;summary&gt;
    /// Attribute for attributing controller actions to restrict them
    /// to just authenticated members, and optionally of a particular type and/or group
    /// &lt;/summary&gt;
    public sealed class MemberAuthorizeAttribute : AuthorizeAttribute
    {

        private readonly UmbracoContext _umbracoContext;

        private UmbracoContext GetUmbracoContext()
        {
            return _umbracoContext ?? UmbracoContext.Current;
        }

        /// &lt;summary&gt;
        /// THIS SHOULD BE ONLY USED FOR UNIT TESTS
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        public MemberAuthorizeAttribute(UmbracoContext umbracoContext)
        {
            if (umbracoContext == null) throw new ArgumentNullException(&quot;umbracoContext&quot;);
            _umbracoContext = umbracoContext;
        }

        public MemberAuthorizeAttribute()
        {

        }

        /// &lt;summary&gt;
        /// Flag for whether to allow all site visitors or just authenticated members
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// This is the same as applying the [AllowAnonymous] attribute
        /// &lt;/remarks&gt;
        [Obsolete(&quot;Use [AllowAnonymous] instead&quot;)]
        public bool AllowAll { get; set; }

        /// &lt;summary&gt;
        /// Comma delimited list of allowed member types
        /// &lt;/summary&gt;
        public string AllowType { get; set; }

        /// &lt;summary&gt;
        /// Comma delimited list of allowed member groups
        /// &lt;/summary&gt;
        public string AllowGroup { get; set; }

        /// &lt;summary&gt;
        /// Comma delimited list of allowed members
        /// &lt;/summary&gt;
        public string AllowMembers { get; set; }

        protected override bool AuthorizeCore(HttpContextBase httpContext)
        {
            if (AllowMembers.IsNullOrWhiteSpace())
                AllowMembers = &quot;&quot;;
            if (AllowGroup.IsNullOrWhiteSpace())
                AllowGroup = &quot;&quot;;
            if (AllowType.IsNullOrWhiteSpace())
                AllowType = &quot;&quot;;

            var members = new List&lt;int&gt;();
            foreach (var s in AllowMembers.Split(&#39;,&#39;))
            {
                int id;
                if (int.TryParse(s, out id))
                {
                    members.Add(id);
                }
            }

            return GetUmbracoContext().Security.IsMemberAuthorized(AllowAll,
                                                  AllowType.Split(&#39;,&#39;),
                                                  AllowGroup.Split(&#39;,&#39;),
                                                  members);
        }

        /// &lt;summary&gt;
        /// Override method to throw exception instead of returning a 401 result
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;filterContext&quot;&gt;&lt;/param&gt;
        protected override void HandleUnauthorizedRequest(AuthorizationContext filterContext)
        {
            throw new HttpException(403, &quot;Resource restricted: either member is not logged on or is not of a permitted type or group.&quot;);
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,0],[25,13,25,62,0],[26,9,26,10,0],[32,9,32,71,0],[33,9,33,10,0],[34,13,34,40,0],[34,41,34,91,0],[35,13,35,46,0],[36,9,36,10,0],[38,9,38,42,0],[39,9,39,10,0],[41,9,41,10,0],[50,32,50,36,0],[50,37,50,41,0],[55,35,55,39,0],[55,40,55,44,0],[60,36,60,40,0],[60,41,60,45,0],[65,38,65,42,0],[65,43,65,47,0],[68,9,68,10,0],[69,13,69,51,0],[70,17,70,35,0],[71,13,71,49,0],[72,17,72,33,0],[73,13,73,48,0],[74,17,74,32,0],[76,13,76,43,0],[77,13,77,20,0],[77,22,77,27,0],[77,28,77,30,0],[77,31,77,54,0],[78,13,78,14,0],[80,17,80,45,0],[81,17,81,18,0],[82,21,82,37,0],[83,17,83,18,0],[84,13,84,14,0],[86,13,89,60,0],[90,9,90,10,0],[97,9,97,10,0],[98,13,98,137,0]]);
    </script>
  </body>
</html>