<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.MacroEngines\RazorDynamicNode\DynamicNodeWalker.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using umbraco.interfaces;

namespace umbraco.MacroEngines
{
    public static class DynamicNodeWalker
    {
        public static DynamicNode Up(this DynamicNode context)
        {
            return context.Up(0);
        }
        public static DynamicNode Up(this DynamicNode context, int number)
        {
            if (number == 0)
            {
                return context.Parent;
            }
            else
            {
                while ((context = context.Parent) != null &amp;&amp; --number &gt;= 0) ;
                return context;
            }
        }
        public static DynamicNode Up(this DynamicNode context, string nodeTypeAlias)
        {
            if (string.IsNullOrEmpty(nodeTypeAlias))
            {
                return context.Parent;
            }
            else
            {
                while ((context = context.Parent) != null &amp;&amp; context.NodeTypeAlias != nodeTypeAlias) ;
                return context;
            }
        }

        public static DynamicNode Down(this DynamicNode context)
        {
            return context.Down(0);
        }
        public static DynamicNode Down(this DynamicNode context, int number)
        {
            DynamicNodeList children = new DynamicNodeList(context.ChildrenAsList);
            if (number == 0)
            {
                return children.Items.First();
            }
            else
            {
                DynamicNode working = context;
                while (number-- &gt;= 0)
                {
                    working = children.Items.First();
                    children = new DynamicNodeList(working.ChildrenAsList);
                }
                return working;
            }
        }
        public static DynamicNode Down(this DynamicNode context, string nodeTypeAlias)
        {

            if (string.IsNullOrEmpty(nodeTypeAlias))
            {
                DynamicNodeList children = new DynamicNodeList(context.ChildrenAsList);
                return children.Items.First();
            }
            else
            {
                return context.Descendants(nodeTypeAlias).Items.FirstOrDefault();
            }
        }
        public static DynamicNode Next(this DynamicNode context)
        {
            return context.Next(0);
        }
        public static DynamicNode Next(this DynamicNode context, int number)
        {
            if (context.ownerList == null &amp;&amp; context.Parent != null)
            {
                //var list = context.Parent.ChildrenAsList.Select(n =&gt; new DynamicNode(n));
                //context.ownerList = new DynamicNodeList(list);
            	context.ownerList = context.Parent.ChildrenAsList;
            }
            if (context.ownerList != null)
            {
                List&lt;DynamicNode&gt; container = context.ownerList.Items.ToList();
                int currentIndex = container.FindIndex(n =&gt; n.Id == context.Id);
                if (currentIndex != -1)
                {
                    return container.ElementAtOrDefault(currentIndex + (number + 1));
                }
                else
                {
                    throw new IndexOutOfRangeException(string.Format(&quot;Node {0} belongs to a DynamicNodeList but could not retrieve the index for it&#39;s position in the list&quot;, context.Id));
                }
            }
            else
            {
                throw new ArgumentNullException(string.Format(&quot;Node {0} has been orphaned and doesn&#39;t belong to a DynamicNodeList&quot;, context.Id));
            }
        }
        public static DynamicNode Sibling(this DynamicNode context, int number)
        {
            if (context.ownerList == null &amp;&amp; context.Parent != null)
            {
                var list = context.Parent.ChildrenAsList.Select(n =&gt; new DynamicNode(n));
                context.ownerList = new DynamicNodeList(list);
            }
            if (context.ownerList != null)
            {
                List&lt;DynamicNode&gt; container = context.ownerList.Items.ToList();
                int currentIndex = container.FindIndex(n =&gt; n.Id == context.Id);
                if (currentIndex != -1)
                {
                    return container.ElementAtOrDefault(currentIndex + number);
                }
                else
                {
                    throw new IndexOutOfRangeException(string.Format(&quot;Node {0} belongs to a DynamicNodeList but could not retrieve the index for it&#39;s position in the list&quot;, context.Id));
                }
            }
            else
            {
                throw new ArgumentNullException(string.Format(&quot;Node {0} has been orphaned and doesn&#39;t belong to a DynamicNodeList&quot;, context.Id));
            }
        }
        public static DynamicNode Sibling(this DynamicNode context, string nodeTypeAlias)
        {
            if (context.ownerList == null &amp;&amp; context.Parent != null)
            {
                var list = context.Parent.ChildrenAsList.Select(n =&gt; new DynamicNode(n));
                context.ownerList = new DynamicNodeList(list);
            }
            if (context.ownerList != null)
            {
                List&lt;DynamicNode&gt; container = context.ownerList.Items.ToList();
                int currentIndex = container.FindIndex(n =&gt; n.Id == context.Id);
                if (currentIndex != -1)
                {
                    int workingIndex = currentIndex + 1;
                    while (workingIndex != currentIndex)
                    {
                        var working = container.ElementAtOrDefault(workingIndex);
                        if (working != null &amp;&amp; working.NodeTypeAlias == nodeTypeAlias)
                        {
                            return working;
                        }
                        workingIndex++;
                        if (workingIndex &gt; container.Count)
                        {
                            workingIndex = 0;
                        }
                    }
                    return null;
                }
                else
                {
                    throw new IndexOutOfRangeException(string.Format(&quot;Node {0} belongs to a DynamicNodeList but could not retrieve the index for it&#39;s position in the list&quot;, context.Id));
                }
            }
            else
            {
                throw new ArgumentNullException(string.Format(&quot;Node {0} has been orphaned and doesn&#39;t belong to a DynamicNodeList&quot;, context.Id));
            }
        }
        public static DynamicNode Next(this DynamicNode context, string nodeTypeAlias)
        {
            if (context.ownerList == null &amp;&amp; context.Parent != null)
            {
                var list = context.Parent.ChildrenAsList.Select(n =&gt; new DynamicNode(n));
                context.ownerList = new DynamicNodeList(list);
            }
            if (context.ownerList != null)
            {
                List&lt;DynamicNode&gt; container = context.ownerList.Items.ToList();
                int currentIndex = container.FindIndex(n =&gt; n.Id == context.Id);
                if (currentIndex != -1)
                {
                    int newIndex = container.FindIndex(currentIndex, n =&gt; n.NodeTypeAlias == nodeTypeAlias);
                    if (newIndex != -1)
                    {
                        return container.ElementAt(newIndex);
                    }
                    return null;
                }
                else
                {
                    throw new IndexOutOfRangeException(string.Format(&quot;Node {0} belongs to a DynamicNodeList but could not retrieve the index for it&#39;s position in the list&quot;, context.Id));
                }
            }
            else
            {
                throw new ArgumentNullException(string.Format(&quot;Node {0} has been orphaned and doesn&#39;t belong to a DynamicNodeList&quot;, context.Id));
            }
        }
        public static DynamicNode Previous(this DynamicNode context)
        {
            return context.Previous(0);
        }
        public static DynamicNode Previous(this DynamicNode context, int number)
        {
            if (context.ownerList == null &amp;&amp; context.Parent != null)
            {
                //var list = context.Parent.ChildrenAsList.Select(n =&gt; new DynamicNode(n));
                //context.ownerList = new DynamicNodeList(list);
            	context.ownerList = context.Parent.ChildrenAsList;
            }
            if (context.ownerList != null)
            {
                List&lt;DynamicNode&gt; container = context.ownerList.Items.ToList();
                int currentIndex = container.FindIndex(n =&gt; n.Id == context.Id);
                if (currentIndex != -1)
                {
                    return container.ElementAtOrDefault(currentIndex + (number - 1));
                }
                else
                {
                    throw new IndexOutOfRangeException(string.Format(&quot;Node {0} belongs to a DynamicNodeList but could not retrieve the index for it&#39;s position in the list&quot;, context.Id));
                }
            }
            else
            {
                throw new ArgumentNullException(string.Format(&quot;Node {0} has been orphaned and doesn&#39;t belong to a DynamicNodeList&quot;, context.Id));
            }
        }
        public static DynamicNode Previous(this DynamicNode context, string nodeTypeAlias)
        {
            if (context.ownerList == null &amp;&amp; context.Parent != null)
            {
                var list = context.Parent.ChildrenAsList.Select(n =&gt; new DynamicNode(n));
                context.ownerList = new DynamicNodeList(list);
            }
            if (context.ownerList != null)
            {
                List&lt;DynamicNode&gt; container = context.ownerList.Items.ToList();
                int currentIndex = container.FindIndex(n =&gt; n.Id == context.Id);
                if (currentIndex != -1)
                {
                    var previousNodes = container.Take(currentIndex).ToList();
                    int newIndex = previousNodes.FindIndex(n =&gt; n.NodeTypeAlias == nodeTypeAlias);
                    if (newIndex != -1)
                    {
                        return container.ElementAt(newIndex);
                    }
                    return null;
                }
                else
                {
                    throw new IndexOutOfRangeException(string.Format(&quot;Node {0} belongs to a DynamicNodeList but could not retrieve the index for it&#39;s position in the list&quot;, context.Id));
                }
            }
            else
            {
                throw new ArgumentNullException(string.Format(&quot;Node {0} has been orphaned and doesn&#39;t belong to a DynamicNodeList&quot;, context.Id));
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[12,9,12,10,1],[13,13,13,34,1],[14,9,14,10,1],[16,9,16,10,1],[17,13,17,29,1],[18,13,18,14,1],[19,17,19,39,1],[22,13,22,14,0],[23,17,23,76,0],[23,77,23,78,0],[24,17,24,32,0],[26,9,26,10,1],[28,9,28,10,0],[29,13,29,53,0],[30,13,30,14,0],[31,17,31,39,0],[34,13,34,14,0],[35,17,35,101,0],[35,102,35,103,0],[36,17,36,32,0],[38,9,38,10,0],[41,9,41,10,1],[42,13,42,36,1],[43,9,43,10,1],[45,9,45,10,1],[46,13,46,84,1],[47,13,47,29,1],[48,13,48,14,1],[49,17,49,47,1],[52,13,52,14,0],[53,17,53,47,0],[54,17,54,38,0],[55,17,55,18,0],[56,21,56,54,0],[57,21,57,76,0],[58,17,58,18,0],[59,17,59,32,0],[61,9,61,10,1],[63,9,63,10,0],[65,13,65,53,0],[66,13,66,14,0],[67,17,67,88,0],[68,17,68,47,0],[71,13,71,14,0],[72,17,72,82,0],[74,9,74,10,0],[76,9,76,10,1],[77,13,77,36,1],[78,9,78,10,1],[80,9,80,10,1],[81,13,81,69,1],[82,13,82,14,1],[85,14,85,64,1],[86,13,86,14,1],[87,13,87,43,1],[88,13,88,14,1],[89,17,89,80,1],[90,17,90,61,1],[90,61,90,79,1],[90,79,90,81,1],[90,17,90,81,1],[91,17,91,40,1],[92,17,92,18,1],[93,21,93,86,1],[96,17,96,18,0],[97,21,97,187,0],[101,13,101,14,0],[102,17,102,146,0],[104,9,104,10,1],[106,9,106,10,0],[107,13,107,69,0],[108,13,108,14,0],[109,17,109,70,0],[109,70,109,88,0],[109,88,109,90,0],[109,17,109,90,0],[110,17,110,63,0],[111,13,111,14,0],[112,13,112,43,0],[113,13,113,14,0],[114,17,114,80,0],[115,17,115,61,0],[115,61,115,79,0],[115,79,115,81,0],[115,17,115,81,0],[116,17,116,40,0],[117,17,117,18,0],[118,21,118,80,0],[121,17,121,18,0],[122,21,122,187,0],[126,13,126,14,0],[127,17,127,146,0],[129,9,129,10,0],[131,9,131,10,0],[132,13,132,69,0],[133,13,133,14,0],[134,17,134,70,0],[134,70,134,88,0],[134,88,134,90,0],[134,17,134,90,0],[135,17,135,63,0],[136,13,136,14,0],[137,13,137,43,0],[138,13,138,14,0],[139,17,139,80,0],[140,17,140,61,0],[140,61,140,79,0],[140,79,140,81,0],[140,17,140,81,0],[141,17,141,40,0],[142,17,142,18,0],[143,21,143,57,0],[144,21,144,57,0],[145,21,145,22,0],[146,25,146,82,0],[147,25,147,87,0],[148,25,148,26,0],[149,29,149,44,0],[151,25,151,40,0],[152,25,152,60,0],[153,25,153,26,0],[154,29,154,46,0],[155,25,155,26,0],[156,21,156,22,0],[157,21,157,33,0],[160,17,160,18,0],[161,21,161,187,0],[165,13,165,14,0],[166,17,166,146,0],[168,9,168,10,0],[170,9,170,10,0],[171,13,171,69,0],[172,13,172,14,0],[173,17,173,70,0],[173,70,173,88,0],[173,88,173,90,0],[173,17,173,90,0],[174,17,174,63,0],[175,13,175,14,0],[176,13,176,43,0],[177,13,177,14,0],[178,17,178,80,0],[179,17,179,61,0],[179,61,179,79,0],[179,79,179,81,0],[179,17,179,81,0],[180,17,180,40,0],[181,17,181,18,0],[182,21,182,75,0],[182,75,182,107,0],[182,107,182,109,0],[182,21,182,109,0],[183,21,183,40,0],[184,21,184,22,0],[185,25,185,62,0],[187,21,187,33,0],[190,17,190,18,0],[191,21,191,187,0],[195,13,195,14,0],[196,17,196,146,0],[198,9,198,10,0],[200,9,200,10,1],[201,13,201,40,1],[202,9,202,10,1],[204,9,204,10,1],[205,13,205,69,1],[206,13,206,14,1],[209,14,209,64,1],[210,13,210,14,1],[211,13,211,43,1],[212,13,212,14,1],[213,17,213,80,1],[214,17,214,61,1],[214,61,214,79,1],[214,79,214,81,1],[214,17,214,81,1],[215,17,215,40,1],[216,17,216,18,1],[217,21,217,86,1],[220,17,220,18,0],[221,21,221,187,0],[225,13,225,14,0],[226,17,226,146,0],[228,9,228,10,1],[230,9,230,10,0],[231,13,231,69,0],[232,13,232,14,0],[233,17,233,70,0],[233,70,233,88,0],[233,88,233,90,0],[233,17,233,90,0],[234,17,234,63,0],[235,13,235,14,0],[236,13,236,43,0],[237,13,237,14,0],[238,17,238,80,0],[239,17,239,61,0],[239,61,239,79,0],[239,79,239,81,0],[239,17,239,81,0],[240,17,240,40,0],[241,17,241,18,0],[242,21,242,79,0],[243,21,243,65,0],[243,65,243,97,0],[243,97,243,99,0],[243,21,243,99,0],[244,21,244,40,0],[245,21,245,22,0],[246,25,246,62,0],[248,21,248,33,0],[251,17,251,18,0],[252,21,252,187,0],[256,13,256,14,0],[257,17,257,146,0],[259,9,259,10,0]]);
    </script>
  </body>
</html>