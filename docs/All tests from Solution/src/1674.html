<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\SqlSyntax\MySqlSyntaxProvider.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence.DatabaseAnnotations;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;

namespace Umbraco.Core.Persistence.SqlSyntax
{
    /// &lt;summary&gt;
    /// Represents an SqlSyntaxProvider for MySql
    /// &lt;/summary&gt;
    [SqlSyntaxProvider(Constants.DatabaseProviders.MySql)]
    public class MySqlSyntaxProvider : SqlSyntaxProviderBase&lt;MySqlSyntaxProvider&gt;
    {
        private readonly ILogger _logger;

        public MySqlSyntaxProvider(ILogger logger)
        {
            _logger = logger;

            AutoIncrementDefinition = &quot;AUTO_INCREMENT&quot;;
            IntColumnDefinition = &quot;int(11)&quot;;
            BoolColumnDefinition = &quot;tinyint(1)&quot;;
            DateTimeColumnDefinition = &quot;TIMESTAMP&quot;;
            TimeColumnDefinition = &quot;time&quot;;
            DecimalColumnDefinition = &quot;decimal(38,6)&quot;;
            GuidColumnDefinition = &quot;char(36)&quot;;

            DefaultValueFormat = &quot;DEFAULT {0}&quot;;

            InitColumnTypeMap();
        }

        public override IEnumerable&lt;string&gt; GetTablesInSchema(Database db)
        {
            List&lt;string&gt; list;
            try
            {
                //needs to be open to read the schema name
                db.OpenSharedConnection();

                var items =
                    db.Fetch&lt;dynamic&gt;(
                        &quot;SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = @TableSchema&quot;,
                        new { TableSchema = db.Connection.Database });
                list = items.Select(x =&gt; x.TABLE_NAME).Cast&lt;string&gt;().ToList();
            }
            finally
            {
                db.CloseSharedConnection();
            }
            return list;
        }

        public override IEnumerable&lt;ColumnInfo&gt; GetColumnsInSchema(Database db)
        {
            List&lt;ColumnInfo&gt; list;
            try
            {
                //needs to be open to read the schema name
                db.OpenSharedConnection();

                var items =
                    db.Fetch&lt;dynamic&gt;(
                        &quot;SELECT TABLE_NAME, COLUMN_NAME, ORDINAL_POSITION, COLUMN_DEFAULT, IS_NULLABLE, DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = @TableSchema&quot;,
                        new { TableSchema = db.Connection.Database });
                list =
                    items.Select(
                        item =&gt;
                        new ColumnInfo(item.TABLE_NAME, item.COLUMN_NAME, int.Parse(item.ORDINAL_POSITION.ToString()), item.COLUMN_DEFAULT ?? &quot;&quot;,
                                       item.IS_NULLABLE, item.DATA_TYPE)).ToList();
            }
            finally
            {
                db.CloseSharedConnection();
            }
            return list;
        }

        public override IEnumerable&lt;Tuple&lt;string, string&gt;&gt; GetConstraintsPerTable(Database db)
        {
            List&lt;Tuple&lt;string, string&gt;&gt; list;
            try
            {
                //needs to be open to read the schema name
                db.OpenSharedConnection();

                //Does not include indexes and constraints are named differently
                var items =
                    db.Fetch&lt;dynamic&gt;(
                        &quot;SELECT TABLE_NAME, CONSTRAINT_NAME FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE TABLE_SCHEMA = @TableSchema&quot;,
                        new { TableSchema = db.Connection.Database });
                list = items.Select(item =&gt; new Tuple&lt;string, string&gt;(item.TABLE_NAME, item.CONSTRAINT_NAME)).ToList();
            }
            finally
            {
                db.CloseSharedConnection();
            }
            return list;
        }

        public override IEnumerable&lt;Tuple&lt;string, string, string&gt;&gt; GetConstraintsPerColumn(Database db)
        {
            List&lt;Tuple&lt;string, string, string&gt;&gt; list;
            try
            {
                //needs to be open to read the schema name
                db.OpenSharedConnection();

                //Does not include indexes and constraints are named differently
                var items =
                    db.Fetch&lt;dynamic&gt;(
                        &quot;SELECT TABLE_NAME, COLUMN_NAME, CONSTRAINT_NAME FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE WHERE TABLE_SCHEMA = @TableSchema&quot;,
                        new { TableSchema = db.Connection.Database });
                list =
                    items.Select(
                        item =&gt;
                        new Tuple&lt;string, string, string&gt;(item.TABLE_NAME, item.COLUMN_NAME, item.CONSTRAINT_NAME))
                         .ToList();
            }
            finally
            {
                db.CloseSharedConnection();
            }
            return list;
        }

        public override IEnumerable&lt;Tuple&lt;string, string, string, bool&gt;&gt; GetDefinedIndexes(Database db)
        {
            List&lt;Tuple&lt;string, string, string, bool&gt;&gt; list;
            try
            {
                //needs to be open to read the schema name
                db.OpenSharedConnection();

                var indexes =
                db.Fetch&lt;dynamic&gt;(@&quot;SELECT DISTINCT
    TABLE_NAME, INDEX_NAME, COLUMN_NAME, CASE NON_UNIQUE WHEN 1 THEN 0 ELSE 1 END AS `UNIQUE`
FROM INFORMATION_SCHEMA.STATISTICS
WHERE TABLE_SCHEMA = @TableSchema
AND INDEX_NAME &lt;&gt; COLUMN_NAME AND INDEX_NAME &lt;&gt; &#39;PRIMARY&#39;
ORDER BY TABLE_NAME, INDEX_NAME&quot;,
                    new { TableSchema = db.Connection.Database });
                list =
                    indexes.Select(
                        item =&gt;
                        new Tuple&lt;string, string, string, bool&gt;(item.TABLE_NAME, item.INDEX_NAME, item.COLUMN_NAME, item.UNIQUE == 1))
                         .ToList();
            }
            finally
            {
                db.CloseSharedConnection();
            }
            return list;
        }

        public override bool DoesTableExist(Database db, string tableName)
        {
            long result;
            try
            {
                //needs to be open to read the schema name
                db.OpenSharedConnection();

                result =
                    db.ExecuteScalar&lt;long&gt;(&quot;SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES &quot; +
                                           &quot;WHERE TABLE_NAME = @TableName AND &quot; +
                                           &quot;TABLE_SCHEMA = @TableSchema&quot;,
                                           new { TableName = tableName, TableSchema = db.Connection.Database });

            }
            finally
            {
                db.CloseSharedConnection();
            }

            return result &gt; 0;
        }

        public override Sql SelectTop(Sql sql, int top)
        {
            return new Sql(string.Concat(sql.SQL, &quot; LIMIT &quot;, top), sql.Arguments);
        }

        public override bool SupportsClustered()
        {
            return true;
        }

        public override bool SupportsIdentityInsert()
        {
            return false;
        }

        /// &lt;summary&gt;
        /// This is used ONLY if we need to format datetime without using SQL parameters (i.e. during migrations)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;date&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;includeTime&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// MySQL has a DateTime standard that is unambiguous and works on all servers:
        /// YYYYMMDDHHMMSS
        /// &lt;/remarks&gt;
        public override string FormatDateTime(DateTime date, bool includeTime = true)
        {
            return includeTime ? date.ToString(&quot;yyyyMMddHHmmss&quot;) : date.ToString(&quot;yyyyMMdd&quot;);
        }

        public override string GetQuotedTableName(string tableName)
        {
            return string.Format(&quot;`{0}`&quot;, tableName);
        }

        public override string GetQuotedColumnName(string columnName)
        {
            return string.Format(&quot;`{0}`&quot;, columnName);
        }

        public override string GetQuotedName(string name)
        {
            return string.Format(&quot;`{0}`&quot;, name);
        }

        public override string GetSpecialDbType(SpecialDbTypes dbTypes)
        {
            if (dbTypes == SpecialDbTypes.NCHAR)
            {
                return &quot;CHAR&quot;;
            }
            else if (dbTypes == SpecialDbTypes.NTEXT)
                return &quot;LONGTEXT&quot;;

            return &quot;NVARCHAR&quot;;
        }

        public override string Format(TableDefinition table)
        {
            string primaryKey = string.Empty;
            var columnDefinition = table.Columns.FirstOrDefault(x =&gt; x.IsPrimaryKey);
            if (columnDefinition != null)
            {
                string columns = string.IsNullOrEmpty(columnDefinition.PrimaryKeyColumns)
                                 ? GetQuotedColumnName(columnDefinition.Name)
                                 : string.Join(&quot;, &quot;, columnDefinition.PrimaryKeyColumns
                                                                     .Split(new[] { &#39;,&#39;, &#39; &#39; }, StringSplitOptions.RemoveEmptyEntries)
                                                                     .Select(GetQuotedColumnName));

                primaryKey = string.Format(&quot;, \nPRIMARY KEY {0} ({1})&quot;, columnDefinition.IsIndexed ? &quot;CLUSTERED&quot; : &quot;NONCLUSTERED&quot;, columns);
            }

            var statement = string.Format(CreateTable, GetQuotedTableName(table.Name), Format(table.Columns), primaryKey);

            return statement;
        }

        public override string Format(IndexDefinition index)
        {
            string name = string.IsNullOrEmpty(index.Name)
                                  ? string.Format(&quot;IX_{0}_{1}&quot;, index.TableName, index.ColumnName)
                                  : index.Name;

            string columns = index.Columns.Any()
                                 ? string.Join(&quot;,&quot;, index.Columns.Select(x =&gt; GetQuotedColumnName(x.Name)))
                                 : GetQuotedColumnName(index.ColumnName);

            return string.Format(CreateIndex,
                                 GetQuotedName(name),
                                 GetQuotedTableName(index.TableName),
                                 columns);
        }

        public override string Format(ForeignKeyDefinition foreignKey)
        {
            return string.Format(CreateForeignKeyConstraint,
                                 GetQuotedTableName(foreignKey.ForeignTable),
                                 GetQuotedColumnName(foreignKey.ForeignColumns.First()),
                                 GetQuotedTableName(foreignKey.PrimaryTable),
                                 GetQuotedColumnName(foreignKey.PrimaryColumns.First()),
                                 FormatCascade(&quot;DELETE&quot;, foreignKey.OnDelete),
                                 FormatCascade(&quot;UPDATE&quot;, foreignKey.OnUpdate));
        }

        public override string FormatPrimaryKey(TableDefinition table)
        {
            return string.Empty;
        }

        protected override string FormatConstraint(ColumnDefinition column)
        {
            return string.Empty;
        }

        protected override string FormatIdentity(ColumnDefinition column)
        {
            return column.IsIdentity ? AutoIncrementDefinition : string.Empty;
        }

        protected override string FormatDefaultValue(ColumnDefinition column)
        {
            if (column.DefaultValue == null)
                return string.Empty;

            //hack - probably not needed with latest changes
            if (column.DefaultValue.ToString().ToLower().Equals(&quot;getdate()&quot;.ToLower()))
                column.DefaultValue = SystemMethods.CurrentDateTime;

            // see if this is for a system method
            if (column.DefaultValue is SystemMethods)
            {
                string method = FormatSystemMethods((SystemMethods)column.DefaultValue);
                if (string.IsNullOrEmpty(method))
                    return string.Empty;

                return string.Format(DefaultValueFormat, method);
            }

            //needs quote
            return string.Format(DefaultValueFormat, string.Format(&quot;&#39;{0}&#39;&quot;, column.DefaultValue));
        }

        protected override string FormatPrimaryKey(ColumnDefinition column)
        {
            return string.Empty;
        }

        protected override string FormatSystemMethods(SystemMethods systemMethod)
        {
            switch (systemMethod)
            {
                case SystemMethods.NewGuid:
                    return null; // NOT SUPPORTED!
                                 //return &quot;NEWID()&quot;;                
                case SystemMethods.CurrentDateTime:
                    return &quot;CURRENT_TIMESTAMP&quot;;
                    //case SystemMethods.NewSequentialId:
                    //    return &quot;NEWSEQUENTIALID()&quot;;
                    //case SystemMethods.CurrentUTCDateTime:
                    //    return &quot;GETUTCDATE()&quot;;
            }

            return null;
        }

        public override string DeleteDefaultConstraint
        {
            get
            {
                return &quot;ALTER TABLE {0} ALTER COLUMN {1} DROP DEFAULT&quot;;
            }
        }

        public override string AlterColumn { get { return &quot;ALTER TABLE {0} MODIFY COLUMN {1}&quot;; } }

        //CREATE TABLE {0} ({1}) ENGINE = INNODB versus CREATE TABLE {0} ({1}) ENGINE = MYISAM ?
        public override string CreateTable { get { return &quot;CREATE TABLE {0} ({1}{2})&quot;; } }

        public override string CreateIndex { get { return &quot;CREATE INDEX {0} ON {1} ({2})&quot;; } }

        public override string CreateForeignKeyConstraint { get { return &quot;ALTER TABLE {0} ADD FOREIGN KEY ({1}) REFERENCES {2} ({3}){4}{5}&quot;; } }

        public override string DeleteConstraint { get { return &quot;ALTER TABLE {0} DROP {1} {2}&quot;; } }

        public override string DropIndex { get { return &quot;DROP INDEX {0} ON {1}&quot;; } }

        public override string RenameColumn { get { return &quot;ALTER TABLE {0} CHANGE {1} {2}&quot;; } }
        public override string ConvertIntegerToOrderableString { get { return &quot;LPAD(FORMAT({0}, 0), 8, &#39;0&#39;)&quot;; } }
        public override string ConvertDateToOrderableString { get { return &quot;DATE_FORMAT({0}, &#39;%Y%m%d&#39;)&quot;; } }
        public override string ConvertDecimalToOrderableString { get { return &quot;LPAD(FORMAT({0}, 9), 20, &#39;0&#39;)&quot;; } }

        public override bool? SupportsCaseInsensitiveQueries(Database db)
        {
            bool? supportsCaseInsensitiveQueries = null;

            try
            {
                db.OpenSharedConnection();
                // Need 4 @ signs as it is regarded as a parameter, @@ escapes it once, @@@@ escapes it twice
                var lowerCaseTableNames = db.Fetch&lt;int&gt;(&quot;SELECT @@@@Global.lower_case_table_names&quot;);

                if (lowerCaseTableNames.Any())
                    supportsCaseInsensitiveQueries = lowerCaseTableNames.First() == 1;
            }
            catch (Exception ex)
            {
                _logger.Error&lt;MySqlSyntaxProvider&gt;(&quot;Error querying for lower_case support&quot;, ex);
            }
            finally
            {
                db.CloseSharedConnection();
            }

            // Could return null, which means testing failed, 
            // add message to check with their hosting provider
            return supportsCaseInsensitiveQueries;
        }

        public override string EscapeString(string val)
        {
            return PetaPocoExtensions.EscapeAtSymbols(MySql.Data.MySqlClient.MySqlHelper.EscapeString(val));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,51,1],[19,9,19,10,1],[20,13,20,30,1],[22,13,22,56,1],[23,13,23,45,1],[24,13,24,49,1],[25,13,25,52,1],[26,13,26,43,1],[27,13,27,55,1],[28,13,28,47,1],[30,13,30,48,1],[32,13,32,33,1],[33,9,33,10,1],[36,9,36,10,0],[39,13,39,14,0],[41,17,41,43,0],[43,17,46,71,0],[47,17,47,42,0],[47,42,47,54,0],[47,54,47,80,0],[47,17,47,80,0],[48,13,48,14,0],[50,13,50,14,0],[51,17,51,44,0],[52,13,52,14,0],[53,13,53,25,0],[54,9,54,10,0],[57,9,57,10,0],[60,13,60,14,0],[62,17,62,43,0],[64,17,67,71,0],[68,17,71,25,0],[71,25,72,73,0],[72,73,72,84,0],[68,17,72,84,0],[73,13,73,14,0],[75,13,75,14,0],[76,17,76,44,0],[77,13,77,14,0],[78,13,78,25,0],[79,9,79,10,0],[82,9,82,10,0],[85,13,85,14,0],[87,17,87,43,0],[90,17,93,71,0],[94,17,94,45,0],[94,45,94,109,0],[94,109,94,120,0],[94,17,94,120,0],[95,13,95,14,0],[97,13,97,14,0],[98,17,98,44,0],[99,13,99,14,0],[100,13,100,25,0],[101,9,101,10,0],[104,9,104,10,0],[107,13,107,14,0],[109,17,109,43,0],[112,17,115,71,0],[116,17,119,25,0],[119,25,119,115,0],[119,115,120,36,0],[116,17,120,36,0],[121,13,121,14,0],[123,13,123,14,0],[124,17,124,44,0],[125,13,125,14,0],[126,13,126,25,0],[127,9,127,10,0],[130,9,130,10,0],[133,13,133,14,0],[135,17,135,43,0],[137,17,144,67,0],[145,17,148,25,0],[148,25,148,134,0],[148,134,149,36,0],[145,17,149,36,0],[150,13,150,14,0],[152,13,152,14,0],[153,17,153,44,0],[154,13,154,14,0],[155,13,155,25,0],[156,9,156,10,0],[159,9,159,10,0],[162,13,162,14,0],[164,17,164,43,0],[166,17,170,113,0],[172,13,172,14,0],[174,13,174,14,0],[175,17,175,44,0],[176,13,176,14,0],[178,13,178,31,0],[179,9,179,10,0],[182,9,182,10,0],[183,13,183,83,0],[184,9,184,10,0],[187,9,187,10,0],[188,13,188,25,0],[189,9,189,10,0],[192,9,192,10,0],[193,13,193,26,0],[194,9,194,10,0],[207,9,207,10,0],[208,13,208,94,0],[209,9,209,10,0],[212,9,212,10,1],[213,13,213,54,1],[214,9,214,10,1],[217,9,217,10,1],[218,13,218,55,1],[219,9,219,10,1],[222,9,222,10,0],[223,13,223,49,0],[224,9,224,10,0],[227,9,227,10,0],[228,13,228,49,0],[229,13,229,14,0],[230,17,230,31,0],[232,18,232,54,0],[233,17,233,35,0],[235,13,235,31,0],[236,9,236,10,0],[239,9,239,10,0],[240,13,240,46,0],[241,13,241,70,0],[241,70,241,84,0],[241,84,241,86,0],[241,13,241,86,0],[242,13,242,42,0],[243,13,243,14,0],[244,17,248,100,0],[250,17,250,141,0],[251,13,251,14,0],[253,13,253,123,0],[255,13,255,30,0],[256,9,256,10,0],[259,9,259,10,0],[260,13,262,48,0],[264,13,265,79,0],[265,79,265,106,0],[265,106,266,74,0],[264,13,266,74,0],[268,13,271,43,0],[272,9,272,10,0],[275,9,275,10,0],[276,13,282,80,0],[283,9,283,10,0],[286,9,286,10,0],[287,13,287,33,0],[288,9,288,10,0],[291,9,291,10,1],[292,13,292,33,1],[293,9,293,10,1],[296,9,296,10,1],[297,13,297,79,1],[298,9,298,10,1],[301,9,301,10,1],[302,13,302,45,1],[303,17,303,37,0],[306,13,306,88,1],[307,17,307,69,0],[310,13,310,54,1],[311,13,311,14,1],[312,17,312,89,1],[313,17,313,50,1],[314,21,314,41,1],[316,17,316,66,0],[320,13,320,99,0],[321,9,321,10,1],[324,9,324,10,1],[325,13,325,33,1],[326,9,326,10,1],[329,9,329,10,1],[330,13,330,34,1],[333,21,333,33,1],[336,21,336,48,0],[343,13,343,25,0],[344,9,344,10,1],[349,13,349,14,0],[350,17,350,72,0],[351,13,351,14,0],[354,50,354,51,0],[354,52,354,95,0],[354,96,354,97,0],[357,50,357,51,0],[357,52,357,87,0],[357,88,357,89,0],[359,50,359,51,0],[359,52,359,91,0],[359,92,359,93,0],[361,65,361,66,0],[361,67,361,141,0],[361,142,361,143,0],[363,55,363,56,0],[363,57,363,95,0],[363,96,363,97,0],[365,48,365,49,0],[365,50,365,81,0],[365,82,365,83,0],[367,51,367,52,0],[367,53,367,93,0],[367,94,367,95,0],[368,70,368,71,0],[368,72,368,110,0],[368,111,368,112,0],[369,67,369,68,0],[369,69,369,105,0],[369,106,369,107,0],[370,70,370,71,0],[370,72,370,111,0],[370,112,370,113,0],[373,9,373,10,0],[374,13,374,57,0],[377,13,377,14,0],[378,17,378,43,0],[380,17,380,101,0],[382,17,382,47,0],[383,21,383,87,0],[384,13,384,14,0],[385,13,385,33,0],[386,13,386,14,0],[387,17,387,97,0],[388,13,388,14,0],[390,13,390,14,0],[391,17,391,44,0],[392,13,392,14,0],[396,13,396,51,0],[397,9,397,10,0],[400,9,400,10,0],[401,13,401,109,0],[402,9,402,10,0]]);
    </script>
  </body>
</html>