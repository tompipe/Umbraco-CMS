<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebApi\Filters\AngularAntiForgeryHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Web.Helpers;
using Umbraco.Core;
using Umbraco.Core.Logging;

namespace Umbraco.Web.WebApi.Filters
{
    /// &lt;summary&gt;
    /// A helper class to deal with csrf prevention with angularjs and webapi
    /// &lt;/summary&gt;
    public static class AngularAntiForgeryHelper
    {
        /// &lt;summary&gt;
        /// The cookie name that is used to store the validation value
        /// &lt;/summary&gt;
        public const string CsrfValidationCookieName = &quot;XSRF-V&quot;;

        /// &lt;summary&gt;
        /// The cookie name that is set for angular to use to pass in to the header value for &quot;X-XSRF-TOKEN&quot;
        /// &lt;/summary&gt;
        public const string AngularCookieName = &quot;XSRF-TOKEN&quot;;

        /// &lt;summary&gt;
        /// The header name that angular uses to pass in the token to validate the cookie
        /// &lt;/summary&gt;
        public const string AngularHeadername = &quot;X-XSRF-TOKEN&quot;;

        

        /// &lt;summary&gt;
        /// Returns 2 tokens - one for the cookie value and one that angular should set as the header value
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cookieToken&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;headerToken&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// .Net provides us a way to validate one token with another for added security. With the way angular works, this 
        /// means that we need to set 2 cookies since angular uses one cookie value to create the header value, then we want to validate
        /// this header value against our original cookie value.
        /// &lt;/remarks&gt;
        public static void GetTokens(out string cookieToken, out string headerToken)
        {
            AntiForgery.GetTokens(null, out cookieToken, out headerToken);
        }

        /// &lt;summary&gt;
        /// Validates the header token against the validation cookie value
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cookieToken&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;headerToken&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static bool ValidateTokens(string cookieToken, string headerToken)
        {
            // ensure that the cookie matches the header and then ensure it matches the correct value!
            try
            {
                AntiForgery.Validate(cookieToken, headerToken);
            }
            catch (Exception ex)
            {
                LogHelper.Error(typeof(AngularAntiForgeryHelper), &quot;Could not validate XSRF token&quot;, ex);
                return false;
            }
            return true;
        }

        internal static bool ValidateHeaders(            
            KeyValuePair&lt;string, IEnumerable&lt;string&gt;&gt;[] requestHeaders, 
            string cookieToken,
            out string failedReason)
        {
            failedReason = &quot;&quot;;

            if (requestHeaders.Any(z =&gt; z.Key.InvariantEquals(AngularHeadername)) == false)
            {
                failedReason = &quot;Missing token&quot;;
                return false;
            }

            var headerToken = requestHeaders
                .Where(z =&gt; z.Key.InvariantEquals(AngularHeadername))
                .Select(z =&gt; z.Value)
                .SelectMany(z =&gt; z)
                .FirstOrDefault();
            
            // both header and cookie must be there
            if (cookieToken == null || headerToken == null)
            {
                failedReason = &quot;Missing token null&quot;;
                return false;
            }

            if (ValidateTokens(cookieToken, headerToken) == false)
            {
                failedReason = &quot;Invalid token&quot;;
                return false;
            }

            return true;
        }

        /// &lt;summary&gt;
        /// Validates the headers/cookies passed in for the request
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;requestHeaders&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;failedReason&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static bool ValidateHeaders(HttpRequestHeaders requestHeaders, out string failedReason)
        {
            var cookieToken = requestHeaders
                .GetCookies()
                .Select(c =&gt; c[CsrfValidationCookieName])
                .FirstOrDefault();

            return ValidateHeaders(
                requestHeaders.ToDictionary(x =&gt; x.Key, x =&gt; x.Value).ToArray(),
                cookieToken == null ? null : cookieToken.Value,
                out failedReason);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[46,9,46,10,1],[47,13,47,75,1],[48,9,48,10,1],[57,9,57,10,1],[60,13,60,14,1],[61,17,61,64,1],[62,13,62,14,1],[63,13,63,33,0],[64,13,64,14,0],[65,17,65,104,0],[66,17,66,30,0],[68,13,68,25,1],[69,9,69,10,1],[75,9,75,10,0],[76,13,76,31,0],[78,13,78,41,0],[78,41,78,81,0],[78,81,78,92,0],[78,13,78,92,0],[79,13,79,14,0],[80,17,80,48,0],[81,17,81,30,0],[84,13,85,29,0],[85,29,85,69,0],[85,69,86,30,0],[86,30,86,37,0],[86,37,87,34,0],[87,34,87,35,0],[87,35,88,35,0],[84,13,88,35,0],[91,13,91,60,0],[92,13,92,14,0],[93,17,93,53,0],[94,17,94,30,0],[97,13,97,67,0],[98,13,98,14,0],[99,17,99,48,0],[100,17,100,30,0],[103,13,103,25,0],[104,9,104,10,0],[113,9,113,10,0],[114,13,116,30,0],[116,30,116,57,0],[116,57,117,35,0],[114,13,117,35,0],[119,13,120,50,0],[120,50,120,55,0],[120,55,120,62,0],[120,62,120,69,0],[120,69,122,35,0],[119,13,122,35,0],[123,9,123,10,0]]);
    </script>
  </body>
</html>