<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\webservices\TagsAutoCompleteHandler.ashx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Script.Serialization;
using System.Web.Services;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence.SqlSyntax;
using umbraco.DataLayer;
using umbraco.BusinessLogic;
using umbraco.presentation.webservices;

namespace umbraco.presentation.umbraco.webservices
{
    
    [WebService(Namespace = &quot;http://tempuri.org/&quot;)]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    public class TagsAutoCompleteHandler : IHttpHandler
    {

        public void ProcessRequest(HttpContext context)
        {
            legacyAjaxCalls.Authorize();

            string format = context.Request.QueryString[&quot;format&quot;];
            bool returnJson = format == &quot;json&quot;;

            context.Response.ContentType = returnJson ? &quot;application/json&quot; : &quot;text/plain&quot;;

            int count = 2;
            string prefixText = context.Request.QueryString[&quot;q&quot;];

            if (string.IsNullOrEmpty(prefixText))
                prefixText = context.Request.QueryString[&quot;term&quot;];

            string group = context.Request.QueryString[&quot;group&quot;];
            string id = context.Request.QueryString[&quot;id&quot;];
           
            string sql;
            IRecordsReader reader = null;

            try
            {
                //if all is correct
                if (!String.IsNullOrEmpty(group) &amp;&amp; !String.IsNullOrEmpty(id))
                {
                    sql = @&quot;SELECT TOP (20) tag FROM cmsTags WHERE tag LIKE @prefix AND cmsTags.id not in 
                        (SELECT tagID FROM cmsTagRelationShip WHERE NodeId = @nodeId) AND cmstags.&quot; + SqlSyntaxContext.SqlSyntaxProvider.GetQuotedColumnName(&quot;group&quot;) + &quot; = @group;&quot;;
                    using (var sqlHelper = Application.SqlHelper)
                    using (var rr = sqlHelper.ExecuteReader(sql,
                        sqlHelper.CreateParameter(&quot;@count&quot;, count),
                        sqlHelper.CreateParameter(&quot;@prefix&quot;, prefixText + &quot;%&quot;),
                        sqlHelper.CreateParameter(&quot;@nodeId&quot;, id),
                        sqlHelper.CreateParameter(&quot;@group&quot;, group)
                    ))
                    {
                        reader = rr;
                    }
                }
                else
                {
                    //fallback...
                    sql = &quot;SELECT TOP (20) tag FROM cmsTags WHERE tag LIKE @prefix&quot;;

                    using (var sqlHelper = Application.SqlHelper)
                    using (var rr = sqlHelper.ExecuteReader(sql,
                        sqlHelper.CreateParameter(&quot;@count&quot;, count),
                        sqlHelper.CreateParameter(&quot;@prefix&quot;, prefixText + &quot;%&quot;)
                    ))
                    {
                        reader = rr;
                    }
                }

                var tagList = new List&lt;string&gt;();
                while (reader.Read())
                {
                    tagList.Add(reader.GetString(&quot;tag&quot;));
                }

                context.Response.Write(returnJson
                    ? new JavaScriptSerializer().Serialize(tagList)
                    : string.Join(Environment.NewLine, tagList));
            }
            catch (Exception ex)
            {
                LogHelper.Error&lt;TagsAutoCompleteHandler&gt;(&quot;An error occurred&quot;, ex);
            }
            finally
            {
                if (reader != null)
                {
                    reader.Close();
                    reader.Dispose();
                }
            }

        }
        
        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        public static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }


        public bool IsReusable
        {
            get
            {
                return false;
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,0],[23,13,23,41,0],[25,13,25,67,0],[26,13,26,48,0],[28,13,28,91,0],[30,13,30,27,0],[31,13,31,66,0],[33,13,33,50,0],[34,17,34,66,0],[36,13,36,65,0],[37,13,37,59,0],[40,13,40,42,0],[43,13,43,14,0],[45,17,45,79,0],[46,17,46,18,0],[47,21,48,182,0],[49,28,49,65,0],[50,28,55,22,0],[56,21,56,22,0],[57,25,57,37,0],[58,21,58,22,0],[59,17,59,18,0],[61,17,61,18,0],[63,21,63,85,0],[65,28,65,65,0],[66,28,69,22,0],[70,21,70,22,0],[71,25,71,37,0],[72,21,72,22,0],[73,17,73,18,0],[75,17,75,50,0],[76,17,76,38,0],[77,17,77,18,0],[78,21,78,58,0],[79,17,79,18,0],[81,17,83,66,0],[84,13,84,14,0],[85,13,85,33,0],[86,13,86,14,0],[87,17,87,83,0],[88,13,88,14,0],[90,13,90,14,0],[91,17,91,36,0],[92,17,92,18,0],[93,21,93,36,0],[94,21,94,38,0],[95,17,95,18,0],[96,13,96,14,0],[98,9,98,10,0],[106,17,106,18,0],[106,19,106,48,0],[106,49,106,50,0],[113,13,113,14,0],[114,17,114,30,0],[115,13,115,14,0]]);
    </script>
  </body>
</html>