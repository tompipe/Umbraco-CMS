<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\XPathCheckBoxList\XPathCheckBoxListPreValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Xml.XPath;
using umbraco.cms.businesslogic.datatype;
using System.Linq;

namespace umbraco.editorControls.XPathCheckBoxList
{
    /// &lt;summary&gt;
    /// This PreValueEditor will require an XPath expression to define the nodes to pick as CheckBox options,
    /// TODO: [HR] min / max selections ?
    /// Uses the shared JsonPreValueEditor as nice way of lightweight serializing a config data class object into a single DB field
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    class XPathCheckBoxListPreValueEditor : AbstractJsonPrevalueEditor
    {
        /// &lt;summary&gt;
        /// Radio buttons to select type of node to pick from: Content / Media / Members
        /// &lt;/summary&gt;
        private RadioButtonList typeRadioButtonList = new RadioButtonList();

        /// &lt;summary&gt;
        /// TextBox control to get the XPath expression
        /// &lt;/summary&gt;
        private TextBox xPathTextBox = new TextBox();

        /// &lt;summary&gt;
        /// RequiredFieldValidator to ensure an XPath expression has been entered
        /// &lt;/summary&gt;
        private RequiredFieldValidator xPathRequiredFieldValidator = new RequiredFieldValidator();

        /// &lt;summary&gt;
        /// Server side validation of XPath expression
        /// &lt;/summary&gt;
        private CustomValidator xPathCustomValidator = new CustomValidator();

        /// &lt;summary&gt;
        /// Store an Xml fragment or a Csv
        /// &lt;/summary&gt;
        private RadioButtonList storageTypeRadioButtonList = new RadioButtonList() { RepeatDirection = RepeatDirection.Vertical, RepeatLayout = RepeatLayout.Flow };

        /// &lt;summary&gt;
        /// Select Node IDs or Node Names as the values to store
        /// &lt;/summary&gt;
        private DropDownList valueTypeDropDownList = new DropDownList();

        /// &lt;summary&gt;
        /// Data object used to define the configuration status of this PreValueEditor
        /// &lt;/summary&gt;
        private XPathCheckBoxListOptions options = null;

        /// &lt;summary&gt;
        /// Gets the options data object that represents the current state of this datatypes configuration
        /// &lt;/summary&gt;
        internal XPathCheckBoxListOptions Options
        {
            get
            {
                if (this.options == null)
                {
                    // Deserialize any stored settings for this PreValueEditor instance
                    this.options = this.GetPreValueOptions&lt;XPathCheckBoxListOptions&gt;();

                    // If still null, ie, object couldn&#39;t be de-serialized from PreValue[0] string value
                    if (this.options == null)
                    {
                        // Create a new Options data object with the default values
                        this.options = new XPathCheckBoxListOptions();
                    }
                }

                return this.options;
            }
        }

        /// &lt;summary&gt;
        /// Initialize a new instance of XPathCheckBoxlistPreValueEditor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataType&quot;&gt;XPathCheckBoxListDataType&lt;/param&gt;
        public XPathCheckBoxListPreValueEditor(umbraco.cms.businesslogic.datatype.BaseDataType dataType)
            : base(dataType, cms.businesslogic.datatype.DBTypes.Ntext)
        {
        }

        /// &lt;summary&gt;
        /// Creates all of the controls and assigns all of their properties
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            //radio buttons to select type of nodes that can be picked (Document, Media or Member)
            this.typeRadioButtonList.Items.Add(new ListItem(uQuery.UmbracoObjectType.Document.GetFriendlyName(), uQuery.UmbracoObjectType.Document.GetGuid().ToString()));
            this.typeRadioButtonList.Items.Add(new ListItem(uQuery.UmbracoObjectType.Media.GetFriendlyName(), uQuery.UmbracoObjectType.Media.GetGuid().ToString()));
            this.typeRadioButtonList.Items.Add(new ListItem(uQuery.UmbracoObjectType.Member.GetFriendlyName(), uQuery.UmbracoObjectType.Member.GetGuid().ToString()));
            
            this.xPathTextBox.ID = &quot;xPathTextBox&quot;;
            this.xPathTextBox.CssClass = &quot;umbEditorTextField&quot;;

            this.xPathRequiredFieldValidator.ControlToValidate = this.xPathTextBox.ID;
            this.xPathRequiredFieldValidator.Display = ValidatorDisplay.Dynamic;
            this.xPathRequiredFieldValidator.ErrorMessage = &quot; XPath expression required&quot;;

            this.xPathCustomValidator.ControlToValidate = this.xPathTextBox.ID;
            this.xPathCustomValidator.Display = ValidatorDisplay.Dynamic;
            this.xPathCustomValidator.ServerValidate += new ServerValidateEventHandler(this.XPathCustomValidator_ServerValidate);

            this.storageTypeRadioButtonList.ID = &quot;storageTypeRadioButtonList&quot;;
            this.storageTypeRadioButtonList.Items.Add(new ListItem(&quot;Xml&quot;, bool.TrueString));
            this.storageTypeRadioButtonList.Items.Add(new ListItem(&quot;Csv&quot;, bool.FalseString));

            this.valueTypeDropDownList.ID = &quot;valueTypeDropDownList&quot;;
            this.valueTypeDropDownList.Items.Add(new ListItem(&quot;Node Ids&quot;, bool.TrueString));
            this.valueTypeDropDownList.Items.Add(new ListItem(&quot;Node Names&quot;, bool.FalseString));

            this.Controls.AddPrevalueControls(
                this.typeRadioButtonList,
                this.xPathTextBox,
                this.xPathRequiredFieldValidator,
                this.xPathCustomValidator,
                this.storageTypeRadioButtonList,
                this.valueTypeDropDownList);
        }

        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;E:System.Web.UI.Control.Load&quot;/&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;T:System.EventArgs&quot;/&gt; object that contains the event data.&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            // Read in stored configuration values
            this.typeRadioButtonList.SelectedValue = this.Options.Type;
            this.xPathTextBox.Text = this.Options.XPath;
            this.storageTypeRadioButtonList.SelectedValue = this.Options.UseXml.ToString();
            this.valueTypeDropDownList.SelectedValue = this.Options.UseIds.ToString();
        }

        /// &lt;summary&gt;
        /// Will run the entered XPath expression to ensure it&#39;s valid
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;source&quot;&gt;xPathCustomValidator&lt;/param&gt;
        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;
        private void XPathCustomValidator_ServerValidate(object source, ServerValidateEventArgs args)
        {
            string xPath = args.Value;
            bool isValid = false;

            try
            {
                switch (this.options.UmbracoObjectType)
                {
                    case uQuery.UmbracoObjectType.Document:
                        if (uQuery.GetNodesByXPath(xPath).Count() &gt;= 0)
                        {
                            isValid = true;
                        }

                        break;

                    case uQuery.UmbracoObjectType.Media:
                        if (uQuery.GetMediaByXPath(xPath).Count() &gt;= 0)
                        {
                            isValid = true;
                        }

                        break;

                    case uQuery.UmbracoObjectType.Member:
                        if (uQuery.GetMembersByXPath(xPath).Count() &gt;= 0)
                        {
                            isValid = true;
                        }

                        break;
                }          
            }
            catch (XPathException)
            {
                this.xPathCustomValidator.ErrorMessage = &quot; Syntax error in XPath expression&quot;;
            }

            args.IsValid = isValid;
        }

        /// &lt;summary&gt;
        /// Saves the pre value data to Umbraco
        /// &lt;/summary&gt;
        public override void Save()
        {
            if (this.Page.IsValid)
            {
                this.Options.Type = this.typeRadioButtonList.SelectedValue;
                this.Options.XPath = this.xPathTextBox.Text;
                this.Options.UseXml = bool.Parse(this.storageTypeRadioButtonList.SelectedValue);
                this.Options.UseIds = bool.Parse(this.valueTypeDropDownList.SelectedValue);

                this.SaveAsJson(this.Options);  // Serialize to Umbraco database field
            }
        }

        /// &lt;summary&gt;
        /// Replaces the base class writer and instead uses the shared uComponents extension method, to inject consistant markup
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;writer&quot;&gt;&lt;/param&gt;
        protected override void RenderContents(HtmlTextWriter writer)
        {
            writer.AddPrevalueRow(
                &quot;Type&quot;,
                &quot;the xml schema to query&quot;,
                this.typeRadioButtonList);

            writer.AddPrevalueRow(
                &quot;XPath Expression&quot;, 
                &quot;can use the tokens &lt;strong&gt;$ancestorOrSelf&lt;/strong&gt;, &lt;strong&gt;$parentPage&lt;/strong&gt; and &lt;strong&gt;$currentPage&lt;/strong&gt;&quot;,
                this.xPathTextBox, 
                this.xPathRequiredFieldValidator, 
                this.xPathCustomValidator);

            writer.AddPrevalueRow(&quot;Storage Type&quot;, this.storageTypeRadioButtonList);
            writer.AddPrevalueRow(&quot;Values&quot;, this.valueTypeDropDownList);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,77,0],[26,9,26,54,0],[31,9,31,99,0],[36,9,36,78,0],[41,9,41,165,0],[46,9,46,73,0],[51,9,51,57,0],[59,13,59,14,0],[60,17,60,42,0],[61,17,61,18,0],[63,21,63,88,0],[66,21,66,46,0],[67,21,67,22,0],[69,25,69,71,0],[70,21,70,22,0],[71,17,71,18,0],[73,17,73,37,0],[74,13,74,14,0],[82,15,82,71,0],[83,9,83,10,0],[84,9,84,10,0],[90,9,90,10,0],[92,13,92,171,0],[93,13,93,165,0],[94,13,94,167,0],[96,13,96,51,0],[97,13,97,63,0],[99,13,99,87,0],[100,13,100,81,0],[101,13,101,90,0],[103,13,103,80,0],[104,13,104,74,0],[105,13,105,130,0],[107,13,107,79,0],[108,13,108,93,0],[109,13,109,94,0],[111,13,111,69,0],[112,13,112,93,0],[113,13,113,96,0],[115,13,121,45,0],[122,9,122,10,0],[129,9,129,10,0],[130,13,130,28,0],[133,13,133,72,0],[134,13,134,57,0],[135,13,135,92,0],[136,13,136,87,0],[137,9,137,10,0],[145,9,145,10,0],[146,13,146,39,0],[147,13,147,34,0],[150,13,150,14,0],[151,17,151,56,0],[154,25,154,72,0],[155,25,155,26,0],[156,29,156,44,0],[157,25,157,26,0],[159,25,159,31,0],[162,25,162,72,0],[163,25,163,26,0],[164,29,164,44,0],[165,25,165,26,0],[167,25,167,31,0],[170,25,170,74,0],[171,25,171,26,0],[172,29,172,44,0],[173,25,173,26,0],[175,25,175,31,0],[177,13,177,14,0],[178,13,178,35,0],[179,13,179,14,0],[180,17,180,94,0],[181,13,181,14,0],[183,13,183,36,0],[184,9,184,10,0],[190,9,190,10,0],[191,13,191,35,0],[192,13,192,14,0],[193,17,193,76,0],[194,17,194,61,0],[195,17,195,97,0],[196,17,196,92,0],[198,17,198,47,0],[199,13,199,14,0],[200,9,200,10,0],[207,9,207,10,0],[208,13,211,43,0],[213,13,218,44,0],[220,13,220,84,0],[221,13,221,73,0],[222,9,222,10,0]]);
    </script>
  </body>
</html>