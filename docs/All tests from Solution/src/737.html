<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebServices\DomainsApiController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Web.Http;
using System.Web.Services.Description;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Web.Routing;
using Umbraco.Web.WebApi;
//using umbraco.cms.businesslogic.language;
using umbraco.BusinessLogic.Actions;
using umbraco.cms.businesslogic.web;
using Umbraco.Web.WebApi.Filters;

namespace Umbraco.Web.WebServices
{
    /// &lt;summary&gt;
    /// A REST controller used for managing domains.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;Nothing to do with Active Directory.&lt;/remarks&gt;
    [ValidateAngularAntiForgeryToken]
    public class DomainsApiController : UmbracoAuthorizedApiController
    {
        [HttpPost]
        // can&#39;t pass multiple complex args in json post request...
        public PostBackModel SaveLanguageAndDomains(PostBackModel model)
        {
            var node = ApplicationContext.Current.Services.ContentService.GetById(model.NodeId);

            if (node == null)
            {
                var response = Request.CreateResponse(HttpStatusCode.BadRequest);
                response.Content = new StringContent(string.Format(&quot;There is no content node with id {0}.&quot;, model.NodeId));
                response.ReasonPhrase = &quot;Node Not Found.&quot;;
                throw new HttpResponseException(response);
            }

            if (UmbracoUser.GetPermissions(node.Path).Contains(ActionAssignDomain.Instance.Letter) == false)
            {
                var response = Request.CreateResponse(HttpStatusCode.BadRequest);
                response.Content = new StringContent(&quot;You do not have permission to assign domains on that node.&quot;);
                response.ReasonPhrase = &quot;Permission Denied.&quot;;
                throw new HttpResponseException(response);
            }

            model.Valid = true;
            var domains = Services.DomainService.GetAssignedDomains(model.NodeId, true).ToArray();
            var languages = Services.LocalizationService.GetAllLanguages().ToArray();
            var language = model.Language &gt; 0 ? languages.FirstOrDefault(l =&gt; l.Id == model.Language) : null;

            // process wildcard

            if (language != null)
            {
                // yet there is a race condition here...
                var wildcard = domains.FirstOrDefault(d =&gt; d.IsWildcard);
                if (wildcard != null)
                {
                    wildcard.LanguageId = language.Id;
                }
                else
                {
                    wildcard = new UmbracoDomain(&quot;*&quot; + model.NodeId)
                    {
                        LanguageId = model.Language,
                        RootContentId = model.NodeId
                    };
                }

                var saveAttempt = Services.DomainService.Save(wildcard);
                if (saveAttempt == false)
                {
                    var response = Request.CreateResponse(HttpStatusCode.BadRequest);
                    response.Content = new StringContent(&quot;Saving domain failed&quot;);
                    response.ReasonPhrase = saveAttempt.Result.StatusType.ToString();
                    throw new HttpResponseException(response);
                }
            }
            else
            {
                var wildcard = domains.FirstOrDefault(d =&gt; d.IsWildcard);
                if (wildcard != null)
                {
                    Services.DomainService.Delete(wildcard);
                }
            }

            // process domains

            // delete every (non-wildcard) domain, that exists in the DB yet is not in the model
            foreach (var domain in domains.Where(d =&gt; d.IsWildcard == false &amp;&amp; model.Domains.All(m =&gt; m.Name.InvariantEquals(d.DomainName) == false)))
            {
                Services.DomainService.Delete(domain);
            }


            var names = new List&lt;string&gt;();

            // create or update domains in the model
            foreach (var domainModel in model.Domains.Where(m =&gt; string.IsNullOrWhiteSpace(m.Name) == false))
            {
                language = languages.FirstOrDefault(l =&gt; l.Id == domainModel.Lang);
                if (language == null)
                    continue;
                var name = domainModel.Name.ToLowerInvariant();
                if (names.Contains(name))
                {
                    domainModel.Duplicate = true;
                    continue;
                }
                names.Add(name);
                var domain = domains.FirstOrDefault(d =&gt; d.DomainName.InvariantEquals(domainModel.Name));
                if (domain != null)
                {
                    domain.LanguageId = language.Id;
                    Services.DomainService.Save(domain);
                }
                else if (Services.DomainService.Exists(domainModel.Name))
                {
                    domainModel.Duplicate = true;
                    var xdomain = Services.DomainService.GetByName(domainModel.Name);
                    var xrcid = xdomain.RootContentId;
                    if (xrcid.HasValue)
                    {
                        var xcontent = Services.ContentService.GetById(xrcid.Value);
                        var xnames = new List&lt;string&gt;();
                        while (xcontent != null)
                        {
                            xnames.Add(xcontent.Name);
                            if (xcontent.ParentId &lt; -1)
                                xnames.Add(&quot;Recycle Bin&quot;);
                            xcontent = xcontent.Parent();
                        }
                        xnames.Reverse();
                        domainModel.Other = &quot;/&quot; + string.Join(&quot;/&quot;, xnames);
                    }
                }
                else
                {
                    // yet there is a race condition here...
                    var newDomain = new UmbracoDomain(name)
                    {
                        LanguageId = domainModel.Lang,
                        RootContentId = model.NodeId
                    };
                    var saveAttempt = Services.DomainService.Save(newDomain);
                    if (saveAttempt == false)
                    {
                        var response = Request.CreateResponse(HttpStatusCode.BadRequest);
                        response.Content = new StringContent(&quot;Saving new domain failed&quot;);
                        response.ReasonPhrase = saveAttempt.Result.StatusType.ToString();
                        throw new HttpResponseException(response);
                    }
                }
            }

            model.Valid = model.Domains.All(m =&gt; m.Duplicate == false);

            return model;
        }

        #region Models

        public class PostBackModel
        {
            public bool Valid { get; set; }
            public int NodeId { get; set; }
            public int Language { get; set; }
            public DomainModel[] Domains { get; set; }
        }

        public class DomainModel
        {
            public DomainModel(string name, int lang)
            {
                Name = name;
                Lang = lang;
            }

            public string Name { get; private set; }
            public int Lang { get; private set; }
            public bool Duplicate { get; set; }
            public string Other { get; set; }
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,10,0],[31,13,31,97,0],[33,13,33,30,0],[34,13,34,14,0],[35,17,35,82,0],[36,17,36,124,0],[37,17,37,59,0],[38,17,38,59,0],[41,13,41,109,0],[42,13,42,14,0],[43,17,43,82,0],[44,17,44,116,0],[45,17,45,62,0],[46,17,46,59,0],[49,13,49,32,0],[50,13,50,99,0],[51,13,51,86,0],[52,13,52,79,0],[52,79,52,101,0],[52,101,52,110,0],[52,13,52,110,0],[56,13,56,34,0],[57,13,57,14,0],[59,17,59,60,0],[59,60,59,72,0],[59,72,59,74,0],[59,17,59,74,0],[60,17,60,38,0],[61,17,61,18,0],[62,21,62,55,0],[63,17,63,18,0],[65,17,65,18,0],[66,21,70,23,0],[71,17,71,18,0],[73,17,73,73,0],[74,17,74,42,0],[75,17,75,18,0],[76,21,76,86,0],[77,21,77,82,0],[78,21,78,86,0],[79,21,79,63,0],[81,13,81,14,0],[83,13,83,14,0],[84,17,84,60,0],[84,60,84,72,0],[84,72,84,74,0],[84,17,84,74,0],[85,17,85,38,0],[86,17,86,18,0],[87,21,87,61,0],[88,17,88,18,0],[89,13,89,14,0],[94,13,94,20,0],[94,22,94,32,0],[94,33,94,35,0],[94,36,94,55,0],[94,55,94,103,0],[94,103,94,148,0],[94,148,94,149,0],[94,55,94,149,0],[94,149,94,150,0],[94,36,94,150,0],[95,13,95,14,0],[96,17,96,55,0],[97,13,97,14,0],[100,13,100,44,0],[103,13,103,20,0],[103,22,103,37,0],[103,38,103,40,0],[103,41,103,66,0],[103,66,103,108,0],[103,108,103,109,0],[103,41,103,109,0],[104,13,104,14,0],[105,17,105,58,0],[105,58,105,82,0],[105,82,105,84,0],[105,17,105,84,0],[106,17,106,38,0],[107,21,107,30,0],[108,17,108,64,0],[109,17,109,42,0],[110,17,110,18,0],[111,21,111,50,0],[112,21,112,30,0],[114,17,114,33,0],[115,17,115,58,0],[115,58,115,104,0],[115,104,115,106,0],[115,17,115,106,0],[116,17,116,36,0],[117,17,117,18,0],[118,21,118,53,0],[119,21,119,57,0],[120,17,120,18,0],[121,22,121,74,0],[122,17,122,18,0],[123,21,123,50,0],[124,21,124,86,0],[125,21,125,55,0],[126,21,126,40,0],[127,21,127,22,0],[128,25,128,85,0],[129,25,129,57,0],[130,25,130,49,0],[131,25,131,26,0],[132,29,132,55,0],[133,29,133,56,0],[134,33,134,59,0],[135,29,135,58,0],[136,25,136,26,0],[137,25,137,42,0],[138,25,138,76,0],[139,21,139,22,0],[140,17,140,18,0],[142,17,142,18,0],[144,21,148,23,0],[149,21,149,78,0],[150,21,150,46,0],[151,21,151,22,0],[152,25,152,90,0],[153,25,153,90,0],[154,25,154,90,0],[155,25,155,67,0],[157,17,157,18,0],[158,13,158,14,0],[160,13,160,50,0],[160,50,160,70,0],[160,70,160,72,0],[160,13,160,72,0],[162,13,162,26,0],[163,9,163,10,0],[169,33,169,37,0],[169,38,169,42,0],[170,33,170,37,0],[170,38,170,42,0],[171,35,171,39,0],[171,40,171,44,0],[172,44,172,48,0],[172,49,172,53,0],[177,13,177,54,0],[178,13,178,14,0],[179,17,179,29,0],[180,17,180,29,0],[181,13,181,14,0],[183,34,183,38,0],[183,39,183,51,0],[184,31,184,35,0],[184,36,184,48,0],[185,37,185,41,0],[185,42,185,46,0],[186,35,186,39,0],[186,40,186,44,0]]);
    </script>
  </body>
</html>