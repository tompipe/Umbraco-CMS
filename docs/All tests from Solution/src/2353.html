<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\UmbracoExamine\XsltExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security;
using System.Xml.Linq;
using System.Xml.XPath;
using Examine;
using Examine.LuceneEngine.Providers;
using Examine.LuceneEngine.SearchCriteria;
using Examine.SearchCriteria;
using Examine.Providers;
using Umbraco.Core.Macros;
using UmbracoExamine.DataServices;

namespace UmbracoExamine
{
    /// &lt;summary&gt;
    /// Methods to support Umbraco XSLT extensions.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// XSLT extensions will ONLY work for provider that have a base class of BaseUmbracoIndexer
    /// &lt;/remarks&gt;
    [XsltExtension(&quot;Examine&quot;)]
    
    public class XsltExtensions
    {
        ///&lt;summary&gt;
        /// Uses the provider specified to search, returning an XPathNodeIterator
        ///&lt;/summary&gt;
        ///&lt;param name=&quot;searchText&quot;&gt;&lt;/param&gt;
        ///&lt;param name=&quot;useWildcards&quot;&gt;&lt;/param&gt;
        ///&lt;param name=&quot;provider&quot;&gt;&lt;/param&gt;
        ///&lt;param name=&quot;indexType&quot;&gt;&lt;/param&gt;
        ///&lt;returns&gt;&lt;/returns&gt;
        internal static XPathNodeIterator Search(string searchText, bool useWildcards, BaseSearchProvider provider, string indexType)
        {
            if (provider == null) throw new ArgumentNullException(&quot;provider&quot;);

            var results = provider.Search(searchText, useWildcards, indexType);
            return GetResultsAsXml(results);            
        }

        /// &lt;summary&gt;
        /// Uses the provider specified to search, returning an XPathNodeIterator
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;The search text.&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [use wildcards].&lt;/param&gt;
        /// &lt;param name=&quot;providerName&quot;&gt;Name of the provider.&lt;/param&gt;
        /// &lt;param name=&quot;indexType&quot;&gt;Type of the index.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator Search(string searchText, bool useWildcards, string providerName, string indexType)
        {
            var provider = ExamineManager.Instance.SearchProviderCollection[providerName];

            return Search(searchText, useWildcards, provider, indexType);
        }

        /// &lt;summary&gt;
        /// Uses the provider specified to search, returning an XPathNodeIterator
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;providerName&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator Search(string searchText, bool useWildcards, string providerName)
        {
            return Search(searchText, useWildcards, providerName, string.Empty);         
        }

        /// &lt;summary&gt;
        /// Uses the default provider specified to search, returning an XPathNodeIterator
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;The search query&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;Enable a wildcard search query&lt;/param&gt;
        /// &lt;returns&gt;A node-set of the search results&lt;/returns&gt;
        public static XPathNodeIterator Search(string searchText, bool useWildcards)
        {
            return Search(searchText, useWildcards, ExamineManager.Instance.DefaultSearchProvider.Name);
        }

        /// &lt;summary&gt;
        /// Uses the default provider specified to search, returning an XPathNodeIterator
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;The search query&lt;/param&gt;
        /// &lt;returns&gt;A node-set of the search results&lt;/returns&gt;
        public static XPathNodeIterator Search(string searchText)
        {
            return Search(searchText, true);
        }

        /// &lt;summary&gt;
        /// Will perform a search against the media index type only
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;providerName&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchMediaOnly(string searchText, bool useWildcards, string providerName)
        {
            return Search(searchText, useWildcards, providerName, IndexTypes.Media);
        }

        /// &lt;summary&gt;
        /// Will perform a search against the media index type only
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchMediaOnly(string searchText, bool useWildcards)
        {
            return SearchMediaOnly(searchText, useWildcards, ExamineManager.Instance.DefaultSearchProvider.Name);
        }

        /// &lt;summary&gt;
        /// Will perform a search against the media index type only
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchMediaOnly(string searchText)
        {
            return SearchMediaOnly(searchText, true);
        }

        /// &lt;summary&gt;
        /// Searches the member only.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;The search text.&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [use wildcards].&lt;/param&gt;
        /// &lt;param name=&quot;providerName&quot;&gt;Name of the provider.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchMemberOnly(string searchText, bool useWildcards, string providerName)
        {
            return Search(searchText, useWildcards, providerName, IndexTypes.Member);
        }

        /// &lt;summary&gt;
        /// Searches the member only.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;The search text.&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [use wildcards].&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchMemberOnly(string searchText, bool useWildcards)
        {
            return SearchMemberOnly(searchText, useWildcards, ExamineManager.Instance.DefaultSearchProvider.Name);
        }

        /// &lt;summary&gt;
        /// Searches the member only.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;The search text.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchMemberOnly(string searchText)
        {
            return SearchMemberOnly(searchText, true);
        }

        /// &lt;summary&gt;
        /// Will perform a search against the content index type only
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;providerName&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchContentOnly(string searchText, bool useWildcards, string providerName)
        {
            return Search(searchText, useWildcards, providerName, IndexTypes.Content);
        }


        /// &lt;summary&gt;
        /// Will perform a search against the content index type only
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;useWildcards&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchContentOnly(string searchText, bool useWildcards)
        {
            return SearchContentOnly(searchText, useWildcards, ExamineManager.Instance.DefaultSearchProvider.Name);
        }

        /// &lt;summary&gt;
        /// Will perform a search against the content index type only
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;searchText&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator SearchContentOnly(string searchText)
        {
            return SearchContentOnly(searchText, true);
        }

        /// &lt;summary&gt;
        /// Gets the results as XML.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;results&quot;&gt;The results.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static XPathNodeIterator GetResultsAsXml(ISearchResults results)
        {
            // create the XDocument
            XDocument doc = new XDocument();

            // check there are any search results
            if (results.TotalItemCount &gt; 0)
            {
                // create the root element
                XElement root = new XElement(&quot;nodes&quot;);

                // iterate through the search results
                foreach (SearchResult result in results)
                {
                    // create a new &lt;node&gt; element
                    XElement node = new XElement(&quot;node&quot;);

                    // create the @id attribute
                    XAttribute nodeId = new XAttribute(&quot;id&quot;, result.Id);

                    // create the @score attribute
                    XAttribute nodeScore = new XAttribute(&quot;score&quot;, result.Score);

                    // add the content
                    node.Add(nodeId, nodeScore);

                    foreach (KeyValuePair&lt;String, String&gt; field in result.Fields)
                    {
                        // create a new &lt;data&gt; element
                        XElement data = new XElement(&quot;data&quot;);

                        // create the @alias attribute
                        XAttribute alias = new XAttribute(&quot;alias&quot;, field.Key);

                        // assign the value to a CDATA section
                        XCData value = new XCData(field.Value);

                        // append the content
                        data.Add(alias, value);

                        // append the &lt;data&gt; element
                        node.Add(data);
                    }

                    // add the node
                    root.Add(node);
                }

                // add the root node
                doc.Add(root);
            }
            else
            {
                doc.Add(new XElement(&quot;error&quot;, &quot;There were no search results.&quot;));
            }

            return doc.CreateNavigator().Select(&quot;/&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[36,9,36,10,0],[37,13,37,34,0],[37,35,37,79,0],[39,13,39,80,0],[40,13,40,45,0],[41,9,41,10,0],[52,9,52,10,0],[53,13,53,91,0],[55,13,55,74,0],[56,9,56,10,0],[66,9,66,10,0],[67,13,67,81,0],[68,9,68,10,0],[77,9,77,10,0],[78,13,78,105,0],[79,9,79,10,0],[87,9,87,10,0],[88,13,88,45,0],[89,9,89,10,0],[99,9,99,10,0],[100,13,100,85,0],[101,9,101,10,0],[110,9,110,10,0],[111,13,111,114,0],[112,9,112,10,0],[120,9,120,10,0],[121,13,121,54,0],[122,9,122,10,0],[132,9,132,10,0],[133,13,133,86,0],[134,9,134,10,0],[143,9,143,10,0],[144,13,144,115,0],[145,9,145,10,0],[153,9,153,10,0],[154,13,154,55,0],[155,9,155,10,0],[165,9,165,10,0],[166,13,166,87,0],[167,9,167,10,0],[177,9,177,10,0],[178,13,178,116,0],[179,9,179,10,0],[187,9,187,10,0],[188,13,188,56,0],[189,9,189,10,0],[197,9,197,10,0],[199,13,199,45,0],[202,13,202,44,0],[203,13,203,14,0],[205,17,205,55,0],[208,17,208,24,0],[208,26,208,45,0],[208,46,208,48,0],[208,49,208,56,0],[209,17,209,18,0],[211,21,211,58,0],[214,21,214,73,0],[217,21,217,82,0],[220,21,220,49,0],[222,21,222,28,0],[222,30,222,64,0],[222,65,222,67,0],[222,68,222,81,0],[223,21,223,22,0],[225,25,225,62,0],[228,25,228,79,0],[231,25,231,64,0],[234,25,234,48,0],[237,25,237,40,0],[238,21,238,22,0],[241,21,241,36,0],[242,17,242,18,0],[245,17,245,31,0],[246,13,246,14,0],[248,13,248,14,0],[249,17,249,81,0],[250,13,250,14,0],[252,13,252,54,0],[253,9,253,10,0]]);
    </script>
  </body>
</html>