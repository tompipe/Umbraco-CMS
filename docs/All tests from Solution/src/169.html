<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\PackagingServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Xml.Linq;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Core.Packaging.Models;
using Umbraco.Core.Services;
using Umbraco.Tests.Services.Importing;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Services
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class PackagingServiceTests : BaseServiceTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        [Test]
        public void PackagingService_Can_Export_Macro()
        {
            // Arrange
            var macro = new Macro(&quot;test1&quot;, &quot;Test&quot;, &quot;~/usercontrol/blah.ascx&quot;, &quot;MyAssembly&quot;, &quot;test.xslt&quot;, &quot;~/views/macropartials/test.cshtml&quot;);
            ServiceContext.MacroService.Save(macro);

            // Act
            var element = ServiceContext.PackagingService.Export(macro);

            // Assert
            Assert.That(element, Is.Not.Null);
            Assert.That(element.Element(&quot;name&quot;).Value, Is.EqualTo(&quot;Test&quot;));
            Assert.That(element.Element(&quot;alias&quot;).Value, Is.EqualTo(&quot;test1&quot;));
            Debug.Print(element.ToString());
        }

        [Test]
        public void PackagingService_Can_Export_DictionaryItems()
        {
            // Arrange
            CreateDictionaryData();
            var dictionaryItem = ServiceContext.LocalizationService.GetDictionaryItemByKey(&quot;Parent&quot;);

            var newPackageXml = XElement.Parse(ImportResources.Dictionary_Package);
            var dictionaryItemsElement = newPackageXml.Elements(&quot;DictionaryItems&quot;).First();

            // Act
            var xml = ServiceContext.PackagingService.Export(new []{dictionaryItem});

            // Assert
            Assert.That(xml.ToString(), Is.EqualTo(dictionaryItemsElement.ToString()));
        }

        [Test]
        public void PackagingService_Can_Export_Languages()
        {
            // Arrange
            var languageNbNo = new Language(&quot;nb-NO&quot;) { CultureName = &quot;Norwegian&quot; };
            ServiceContext.LocalizationService.Save(languageNbNo);

            var languageEnGb = new Language(&quot;en-GB&quot;) { CultureName = &quot;English (United Kingdom)&quot; };
            ServiceContext.LocalizationService.Save(languageEnGb);

            var newPackageXml = XElement.Parse(ImportResources.Dictionary_Package);
            var languageItemsElement = newPackageXml.Elements(&quot;Languages&quot;).First();

            // Act
            var xml = ServiceContext.PackagingService.Export(new[] { languageNbNo, languageEnGb });

            // Assert
            Assert.That(xml.ToString(), Is.EqualTo(languageItemsElement.ToString()));
        }

        private static string GetTestPackagePath(string packageName)
        {
            const string testPackagesDirName = &quot;Packaging\\Packages&quot;;
            string path = Path.Combine(Core.Configuration.GlobalSettings.FullpathToRoot, testPackagesDirName, packageName);
            return path;
        }


        [Test]
        public void PackagingService_Can_ImportPackage()
        {
            var packagingService = (PackagingService)ServiceContext.PackagingService;

            const string documentTypePickerUmb = &quot;Document_Type_Picker_1.1.umb&quot;;

            string testPackagePath = GetTestPackagePath(documentTypePickerUmb);

            InstallationSummary installationSummary = packagingService.InstallPackage(testPackagePath);

            Assert.IsNotNull(installationSummary);
        }


        [Test]
        public void PackagingService_Can_GetPackageMetaData()
        {
            var packagingService = (PackagingService)ServiceContext.PackagingService;

            const string documentTypePickerUmb = &quot;Document_Type_Picker_1.1.umb&quot;;

            string testPackagePath = GetTestPackagePath(documentTypePickerUmb);

            MetaData packageMetaData = packagingService.GetPackageMetaData(testPackagePath);
            Assert.IsNotNull(packageMetaData);
        }

        [Test]
        public void PackagingService_Can_GetPackageWarnings()
        {
            var packagingService = (PackagingService)ServiceContext.PackagingService;

            const string documentTypePickerUmb = &quot;Document_Type_Picker_1.1.umb&quot;;

            string testPackagePath = GetTestPackagePath(documentTypePickerUmb);

            PreInstallWarnings preInstallWarnings = packagingService.GetPackageWarnings(testPackagePath);
            Assert.IsNotNull(preInstallWarnings);
        }

        private void CreateDictionaryData()
        {
            var languageNbNo = new Language(&quot;nb-NO&quot;) { CultureName = &quot;nb-NO&quot; };
            ServiceContext.LocalizationService.Save(languageNbNo);

            var languageEnGb = new Language(&quot;en-GB&quot;) { CultureName = &quot;en-GB&quot; };
            ServiceContext.LocalizationService.Save(languageEnGb);

            var parentItem = new DictionaryItem(&quot;Parent&quot;);
            var parentTranslations = new List&lt;IDictionaryTranslation&gt;
                                   {
                                       new DictionaryTranslation(languageNbNo, &quot;ForelderVerdi&quot;),
                                       new DictionaryTranslation(languageEnGb, &quot;ParentValue&quot;)
                                   };
            parentItem.Translations = parentTranslations;
            ServiceContext.LocalizationService.Save(parentItem);

            var childItem = new DictionaryItem(parentItem.Key, &quot;Child&quot;);
            var childTranslations = new List&lt;IDictionaryTranslation&gt;
                                   {
                                       new DictionaryTranslation(languageNbNo, &quot;BarnVerdi&quot;),
                                       new DictionaryTranslation(languageEnGb, &quot;ChildValue&quot;)
                                   };
            childItem.Translations = childTranslations;
            ServiceContext.LocalizationService.Save(childItem);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,31,1],[24,9,24,10,1],[28,9,28,10,1],[29,13,29,29,1],[30,9,30,10,1],[34,9,34,10,1],[36,13,36,143,1],[37,13,37,53,1],[40,13,40,73,1],[43,13,43,47,1],[44,13,44,76,1],[45,13,45,78,1],[46,13,46,45,1],[47,9,47,10,1],[51,9,51,10,1],[53,13,53,36,1],[54,13,54,102,1],[56,13,56,84,1],[57,13,57,92,1],[60,13,60,86,1],[63,13,63,88,1],[64,9,64,10,1],[68,9,68,10,1],[70,13,70,84,1],[71,13,71,67,1],[73,13,73,99,1],[74,13,74,67,1],[76,13,76,84,1],[77,13,77,84,1],[80,13,80,100,1],[83,13,83,86,1],[84,9,84,10,1],[87,9,87,10,1],[89,13,89,124,1],[90,13,90,25,1],[91,9,91,10,1],[96,9,96,10,1],[97,13,97,86,1],[101,13,101,80,1],[103,13,103,104,1],[105,13,105,51,1],[106,9,106,10,1],[111,9,111,10,1],[112,13,112,86,1],[116,13,116,80,1],[118,13,118,93,1],[119,13,119,47,1],[120,9,120,10,1],[124,9,124,10,1],[125,13,125,86,1],[129,13,129,80,1],[131,13,131,106,1],[132,13,132,50,1],[133,9,133,10,1],[136,9,136,10,1],[137,13,137,80,1],[138,13,138,67,1],[140,13,140,80,1],[141,13,141,67,1],[143,13,143,59,1],[144,13,148,38,1],[149,13,149,58,1],[150,13,150,65,1],[152,13,152,73,1],[153,13,157,38,1],[158,13,158,56,1],[159,13,159,64,1],[160,9,160,10,1]]);
    </script>
  </body>
</html>