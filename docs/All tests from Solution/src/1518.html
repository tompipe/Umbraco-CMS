<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Services\ContentTypeService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using Umbraco.Core.Configuration;
using Umbraco.Core.Events;
using Umbraco.Core.Exceptions;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Services
{
    /// &lt;summary&gt;
    /// Represents the ContentType Service, which is an easy access to operations involving &lt;see cref=&quot;IContentType&quot;/&gt;
    /// &lt;/summary&gt;
    public class ContentTypeService : ContentTypeServiceBase, IContentTypeService
    {
        private readonly IContentService _contentService;
        private readonly IMediaService _mediaService;

        //Support recursive locks because some of the methods that require locking call other methods that require locking.
        //for example, the Move method needs to be locked but this calls the Save method which also needs to be locked.
        private static readonly ReaderWriterLockSlim Locker = new ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion);

        public ContentTypeService(IDatabaseUnitOfWorkProvider provider, RepositoryFactory repositoryFactory, ILogger logger, IEventMessagesFactory eventMessagesFactory, IContentService contentService,
            IMediaService mediaService)
            : base(provider, repositoryFactory, logger, eventMessagesFactory)
        {
            if (contentService == null) throw new ArgumentNullException(&quot;contentService&quot;);
            if (mediaService == null) throw new ArgumentNullException(&quot;mediaService&quot;);
            _contentService = contentService;
            _mediaService = mediaService;
        }

        #region Containers

        public Attempt&lt;OperationStatus&lt;EntityContainer, OperationStatusType&gt;&gt; CreateContentTypeContainer(int parentId, string name, int userId = 0)
        {
            var evtMsgs = EventMessagesFactory.Get();
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.DocumentTypeContainerGuid))
            {
                try
                {
                    var container = new EntityContainer(Constants.ObjectTypes.DocumentTypeGuid)
                    {
                        Name = name,
                        ParentId = parentId,
                        CreatorId = userId
                    };

                    if (SavingContentTypeContainer.IsRaisedEventCancelled(
                        new SaveEventArgs&lt;EntityContainer&gt;(container, evtMsgs),
                        this))
                    {
                        return Attempt.Fail(new OperationStatus&lt;EntityContainer, OperationStatusType&gt;(container, OperationStatusType.FailedCancelledByEvent, evtMsgs));
                    }

                    repo.AddOrUpdate(container);
                    uow.Commit();

                    SavedContentTypeContainer.RaiseEvent(new SaveEventArgs&lt;EntityContainer&gt;(container, evtMsgs), this);
                    //TODO: Audit trail ?

                    return Attempt.Succeed(new OperationStatus&lt;EntityContainer, OperationStatusType&gt;(container, OperationStatusType.Success, evtMsgs));
                }
                catch (Exception ex)
                {
                    return Attempt.Fail(new OperationStatus&lt;EntityContainer, OperationStatusType&gt;(null, OperationStatusType.FailedExceptionThrown, evtMsgs), ex);
                }
            }
        }

        public Attempt&lt;OperationStatus&lt;EntityContainer, OperationStatusType&gt;&gt; CreateMediaTypeContainer(int parentId, string name, int userId = 0)
        {
            var evtMsgs = EventMessagesFactory.Get();
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.MediaTypeContainerGuid))
            {
                try
                {
                    var container = new EntityContainer(Constants.ObjectTypes.MediaTypeGuid)
                    {
                        Name = name,
                        ParentId = parentId,
                        CreatorId = userId
                    };

                    if (SavingMediaTypeContainer.IsRaisedEventCancelled(
                        new SaveEventArgs&lt;EntityContainer&gt;(container, evtMsgs),
                        this))
                    {
                        return Attempt.Fail(new OperationStatus&lt;EntityContainer, OperationStatusType&gt;(container, OperationStatusType.FailedCancelledByEvent, evtMsgs));
                    }

                    repo.AddOrUpdate(container);
                    uow.Commit();

                    SavedMediaTypeContainer.RaiseEvent(new SaveEventArgs&lt;EntityContainer&gt;(container, evtMsgs), this);
                    //TODO: Audit trail ?

                    return Attempt.Succeed(new OperationStatus&lt;EntityContainer, OperationStatusType&gt;(container, OperationStatusType.Success, evtMsgs));
                }
                catch (Exception ex)
                {
                    return Attempt.Fail(new OperationStatus&lt;EntityContainer, OperationStatusType&gt;(null, OperationStatusType.FailedExceptionThrown, evtMsgs), ex);
                }
            }
        }

        public Attempt&lt;OperationStatus&gt; SaveContentTypeContainer(EntityContainer container, int userId = 0)
        {
            return SaveContainer(
                SavingContentTypeContainer, SavedContentTypeContainer,
                container, Constants.ObjectTypes.DocumentTypeContainerGuid, &quot;document type&quot;, userId);
        }

        public Attempt&lt;OperationStatus&gt; SaveMediaTypeContainer(EntityContainer container, int userId = 0)
        {
            return SaveContainer(
                SavingMediaTypeContainer, SavedMediaTypeContainer,
                container, Constants.ObjectTypes.MediaTypeContainerGuid, &quot;media type&quot;, userId);
        }

        private Attempt&lt;OperationStatus&gt; SaveContainer(
            TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;EntityContainer&gt;&gt; savingEvent,
            TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;EntityContainer&gt;&gt; savedEvent,
            EntityContainer container,
            Guid containerObjectType,
            string objectTypeName, int userId)
        {
            var evtMsgs = EventMessagesFactory.Get();

            if (container.ContainerObjectType != containerObjectType)
            {
                var ex = new InvalidOperationException(&quot;Not a &quot; + objectTypeName + &quot; container.&quot;);
                return OperationStatus.Exception(evtMsgs, ex);
            }

            if (container.HasIdentity &amp;&amp; container.IsPropertyDirty(&quot;ParentId&quot;))
            {
                var ex = new InvalidOperationException(&quot;Cannot save a container with a modified parent, move the container instead.&quot;);
                return OperationStatus.Exception(evtMsgs, ex);
            }

            if (savingEvent.IsRaisedEventCancelled(
                new SaveEventArgs&lt;EntityContainer&gt;(container, evtMsgs),
                this))
            {
                return OperationStatus.Cancelled(evtMsgs);
            }

            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, containerObjectType))
            {
                repo.AddOrUpdate(container);
                uow.Commit();
            }

            savedEvent.RaiseEvent(new SaveEventArgs&lt;EntityContainer&gt;(container, evtMsgs), this);

            //TODO: Audit trail ?

            return OperationStatus.Success(evtMsgs);
        }

        public EntityContainer GetContentTypeContainer(int containerId)
        {
            return GetContainer(containerId, Constants.ObjectTypes.DocumentTypeContainerGuid);
        }

        public EntityContainer GetMediaTypeContainer(int containerId)
        {
            return GetContainer(containerId, Constants.ObjectTypes.MediaTypeContainerGuid);
        }

        private EntityContainer GetContainer(int containerId, Guid containerObjectType)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, containerObjectType))
            {
                var container = repo.Get(containerId);
                return container;
            }
        }

        public IEnumerable&lt;EntityContainer&gt; GetMediaTypeContainers(int[] containerIds)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.MediaTypeContainerGuid))
            {
                return repo.GetAll(containerIds);
            }
        }

        public IEnumerable&lt;EntityContainer&gt; GetMediaTypeContainers(string name, int level)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.MediaTypeContainerGuid))
            {
                return repo.Get(name, level);
            }
        }

        public IEnumerable&lt;EntityContainer&gt; GetMediaTypeContainers(IMediaType mediaType)
        {
            var ancestorIds = mediaType.Path.Split(new[] {&#39;,&#39;}, StringSplitOptions.RemoveEmptyEntries)
                .Select(x =&gt;
                {
                    var asInt = x.TryConvertTo&lt;int&gt;();
                    if (asInt) return asInt.Result;
                    return int.MinValue;
                })
                .Where(x =&gt; x != int.MinValue &amp;&amp; x != mediaType.Id)
                .ToArray();

            return GetMediaTypeContainers(ancestorIds);
        }

        public EntityContainer GetContentTypeContainer(Guid containerId)
        {
            return GetContainer(containerId, Constants.ObjectTypes.DocumentTypeContainerGuid);
        }

        public IEnumerable&lt;EntityContainer&gt; GetContentTypeContainers(int[] containerIds)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.DocumentTypeContainerGuid))
            {
                return repo.GetAll(containerIds);
            }
        }

        public IEnumerable&lt;EntityContainer&gt; GetContentTypeContainers(IContentType contentType)
        {
            var ancestorIds = contentType.Path.Split(new[] {&#39;,&#39;}, StringSplitOptions.RemoveEmptyEntries)
                .Select(x =&gt;
                {
                    var asInt = x.TryConvertTo&lt;int&gt;();
                    if (asInt) return asInt.Result;
                    return int.MinValue;
                })
                .Where(x =&gt; x != int.MinValue &amp;&amp; x != contentType.Id)
                .ToArray();

            return GetContentTypeContainers(ancestorIds);
        }

        public EntityContainer GetMediaTypeContainer(Guid containerId)
        {
            return GetContainer(containerId, Constants.ObjectTypes.MediaTypeContainerGuid);
        }

        private EntityContainer GetContainer(Guid containerId, Guid containerObjectType)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, containerObjectType))
            {
                var container = repo.Get(containerId);
                return container;
            }
        }

        public IEnumerable&lt;EntityContainer&gt; GetContentTypeContainers(string name, int level)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.DocumentTypeContainerGuid))
            {
                return repo.Get(name, level);
            }
        }

        public Attempt&lt;OperationStatus&gt; DeleteContentTypeContainer(int containerId, int userId = 0)
        {
            var evtMsgs = EventMessagesFactory.Get();
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.DocumentTypeContainerGuid))
            {
                var container = repo.Get(containerId);
                if (container == null) return OperationStatus.NoOperation(evtMsgs);

                if (DeletingContentTypeContainer.IsRaisedEventCancelled(
                    new DeleteEventArgs&lt;EntityContainer&gt;(container, evtMsgs),
                    this))
                {
                    return Attempt.Fail(new OperationStatus(OperationStatusType.FailedCancelledByEvent, evtMsgs));
                }

                repo.Delete(container);
                uow.Commit();

                DeletedContentTypeContainer.RaiseEvent(new DeleteEventArgs&lt;EntityContainer&gt;(container, evtMsgs), this);

                return OperationStatus.Success(evtMsgs);
                //TODO: Audit trail ?
            }
        }

        public Attempt&lt;OperationStatus&gt; DeleteMediaTypeContainer(int containerId, int userId = 0)
        {
            var evtMsgs = EventMessagesFactory.Get();
            var uow = UowProvider.GetUnitOfWork();
            using (var repo = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.MediaTypeContainerGuid))
            {
                var container = repo.Get(containerId);
                if (container == null) return OperationStatus.NoOperation(evtMsgs);

                if (DeletingMediaTypeContainer.IsRaisedEventCancelled(
                    new DeleteEventArgs&lt;EntityContainer&gt;(container, evtMsgs),
                    this))
                {
                    return Attempt.Fail(new OperationStatus(OperationStatusType.FailedCancelledByEvent, evtMsgs));
                }

                repo.Delete(container);
                uow.Commit();

                DeletedMediaTypeContainer.RaiseEvent(new DeleteEventArgs&lt;EntityContainer&gt;(container, evtMsgs), this);

                return OperationStatus.Success(evtMsgs);
                //TODO: Audit trail ?
            }
        }

        #endregion

        /// &lt;summary&gt;
        /// Gets all property type aliases.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;string&gt; GetAllPropertyTypeAliases()
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAllPropertyTypeAliases();
            }
        }

        /// &lt;summary&gt;
        /// Gets all content type aliases
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;objectTypes&quot;&gt;
        /// If this list is empty, it will return all content type aliases for media, members and content, otherwise
        /// it will only return content type aliases for the object types specified
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;string&gt; GetAllContentTypeAliases(params Guid[] objectTypes)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAllContentTypeAliases(objectTypes);
            }
        }

        /// &lt;summary&gt;
        /// Copies a content type as a child under the specified parent if specified (otherwise to the root)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;original&quot;&gt;
        /// The content type to copy
        /// &lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;
        /// The new alias of the content type
        /// &lt;/param&gt;
        /// &lt;param name=&quot;name&quot;&gt;
        /// The new name of the content type
        /// &lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;
        /// The parent to copy the content type to, default is -1 (root)
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IContentType Copy(IContentType original, string alias, string name, int parentId = -1)
        {
            IContentType parent = null;
            if (parentId &gt; 0)
            {
                parent = GetContentType(parentId);
                if (parent == null)
                {
                    throw new InvalidOperationException(&quot;Could not find content type with id &quot; + parentId);
                }
            }
            return Copy(original, alias, name, parent);
        }

        /// &lt;summary&gt;
        /// Copies a content type as a child under the specified parent if specified (otherwise to the root)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;original&quot;&gt;
        /// The content type to copy
        /// &lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;
        /// The new alias of the content type
        /// &lt;/param&gt;
        /// &lt;param name=&quot;name&quot;&gt;
        /// The new name of the content type
        /// &lt;/param&gt;
        /// &lt;param name=&quot;parent&quot;&gt;
        /// The parent to copy the content type to, default is null (root)
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IContentType Copy(IContentType original, string alias, string name, IContentType parent)
        {
            Mandate.ParameterNotNull(original, &quot;original&quot;);
            Mandate.ParameterNotNullOrEmpty(alias, &quot;alias&quot;);
            if (parent != null)
            {
                Mandate.That(parent.HasIdentity, () =&gt; new InvalidOperationException(&quot;The parent content type must have an identity&quot;));
            }

            var clone = original.DeepCloneWithResetIdentities(alias);

            clone.Name = name;

            var compositionAliases = clone.CompositionAliases().Except(new[] {alias}).ToList();
            //remove all composition that is not it&#39;s current alias
            foreach (var a in compositionAliases)
            {
                clone.RemoveContentType(a);
            }

            //if a parent is specified set it&#39;s composition and parent
            if (parent != null)
            {
                //add a new parent composition
                clone.AddContentType(parent);
                clone.ParentId = parent.Id;
            }
            else
            {
                //set to root
                clone.ParentId = -1;
            }

            Save(clone);
            return clone;
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IContentType&quot;/&gt; object by its Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;IContentType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IContentType&quot;/&gt;&lt;/returns&gt;
        public IContentType GetContentType(int id)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(id);
            }
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IContentType&quot;/&gt; object by its Alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;Alias of the &lt;see cref=&quot;IContentType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IContentType&quot;/&gt;&lt;/returns&gt;
        public IContentType GetContentType(string alias)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(alias);
            }
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IContentType&quot;/&gt; object by its Key
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Alias of the &lt;see cref=&quot;IContentType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IContentType&quot;/&gt;&lt;/returns&gt;
        public IContentType GetContentType(Guid id)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(id);
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of all available &lt;see cref=&quot;IContentType&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ids&quot;&gt;Optional list of ids&lt;/param&gt;
        /// &lt;returns&gt;An Enumerable list of &lt;see cref=&quot;IContentType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IContentType&gt; GetAllContentTypes(params int[] ids)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(ids);
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of all available &lt;see cref=&quot;IContentType&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ids&quot;&gt;Optional list of ids&lt;/param&gt;
        /// &lt;returns&gt;An Enumerable list of &lt;see cref=&quot;IContentType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IContentType&gt; GetAllContentTypes(IEnumerable&lt;Guid&gt; ids)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(ids.ToArray());
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of children for a &lt;see cref=&quot;IContentType&quot;/&gt; object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the Parent&lt;/param&gt;
        /// &lt;returns&gt;An Enumerable list of &lt;see cref=&quot;IContentType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IContentType&gt; GetContentTypeChildren(int id)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var query = Query&lt;IContentType&gt;.Builder.Where(x =&gt; x.ParentId == id);
                var contentTypes = repository.GetByQuery(query);
                return contentTypes;
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of children for a &lt;see cref=&quot;IContentType&quot;/&gt; object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the Parent&lt;/param&gt;
        /// &lt;returns&gt;An Enumerable list of &lt;see cref=&quot;IContentType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IContentType&gt; GetContentTypeChildren(Guid id)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var found = GetContentType(id);
                if (found == null) return Enumerable.Empty&lt;IContentType&gt;();
                var query = Query&lt;IContentType&gt;.Builder.Where(x =&gt; x.ParentId == found.Id);
                var contentTypes = repository.GetByQuery(query);
                return contentTypes;
            }
        }

        /// &lt;summary&gt;
        /// Checks whether an &lt;see cref=&quot;IContentType&quot;/&gt; item has any children
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;IContentType&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;True if the content type has any children otherwise False&lt;/returns&gt;
        public bool HasChildren(int id)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var query = Query&lt;IContentType&gt;.Builder.Where(x =&gt; x.ParentId == id);
                int count = repository.Count(query);
                return count &gt; 0;
            }
        }

        /// &lt;summary&gt;
        /// Checks whether an &lt;see cref=&quot;IContentType&quot;/&gt; item has any children
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;IContentType&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;True if the content type has any children otherwise False&lt;/returns&gt;
        public bool HasChildren(Guid id)
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var found = GetContentType(id);
                if (found == null) return false;
                var query = Query&lt;IContentType&gt;.Builder.Where(x =&gt; x.ParentId == found.Id);
                int count = repository.Count(query);
                return count &gt; 0;
            }
        }

        /// &lt;summary&gt;
        /// This is called after an IContentType is saved and is used to update the content xml structures in the database
        /// if they are required to be updated.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentTypes&quot;&gt;A tuple of a content type and a boolean indicating if it is new (HasIdentity was false before committing)&lt;/param&gt;
        private void UpdateContentXmlStructure(params IContentTypeBase[] contentTypes)
        {

            var toUpdate = GetContentTypesForXmlUpdates(contentTypes).ToArray();

            if (toUpdate.Any())
            {
                var firstType = toUpdate.First();
                //if it is a content type then call the rebuilding methods or content
                if (firstType is IContentType)
                {
                    var typedContentService = _contentService as ContentService;
                    if (typedContentService != null)
                    {
                        typedContentService.RePublishAll(toUpdate.Select(x =&gt; x.Id).ToArray());
                    }
                    else
                    {
                        //this should never occur, the content service should always be typed but we&#39;ll check anyways.
                        _contentService.RePublishAll();
                    }
                }
                else if (firstType is IMediaType)
                {
                    //if it is a media type then call the rebuilding methods for media
                    var typedContentService = _mediaService as MediaService;
                    if (typedContentService != null)
                    {
                        typedContentService.RebuildXmlStructures(toUpdate.Select(x =&gt; x.Id).ToArray());
                    }
                }
            }

        }

        public int CountContentTypes()
        {
            using (var repository = RepositoryFactory.CreateContentTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Count(Query&lt;IContentType&gt;.Builder);
            }
        }

        public int CountMediaTypes()
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Count(Query&lt;IMediaType&gt;.Builder);
            }
        }

        /// &lt;summary&gt;
        /// Validates the composition, if its invalid a list of property type aliases that were duplicated is returned
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;compo&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Attempt&lt;string[]&gt; ValidateComposition(IContentTypeComposition compo)
        {
            using (new WriteLock(Locker))
            {
                try
                {
                    ValidateLocked(compo);
                    return Attempt&lt;string[]&gt;.Succeed();
                }
                catch (InvalidCompositionException ex)
                {
                    return Attempt.Fail(ex.PropertyTypeAliases, ex);
                }
            }
        }

        protected void ValidateLocked(IContentTypeComposition compositionContentType)
        {
            // performs business-level validation of the composition
            // should ensure that it is absolutely safe to save the composition

            // eg maybe a property has been added, with an alias that&#39;s OK (no conflict with ancestors)
            // but that cannot be used (conflict with descendants)

            var contentType = compositionContentType as IContentType;
            var mediaType = compositionContentType as IMediaType;
            var memberType = compositionContentType as IMemberType; // should NOT do it here but... v8!

            IContentTypeComposition[] allContentTypes;
            if (contentType != null)
                allContentTypes = GetAllContentTypes().Cast&lt;IContentTypeComposition&gt;().ToArray();
            else if (mediaType != null)
                allContentTypes = GetAllMediaTypes().Cast&lt;IContentTypeComposition&gt;().ToArray();
            else if (memberType != null)
                return; // no compositions on members, always validate
            else
                throw new Exception(&quot;Composition is neither IContentType nor IMediaType nor IMemberType?&quot;);

            var compositionAliases = compositionContentType.CompositionAliases();
            var compositions = allContentTypes.Where(x =&gt; compositionAliases.Any(y =&gt; x.Alias.Equals(y)));
            var propertyTypeAliases = compositionContentType.PropertyTypes.Select(x =&gt; x.Alias.ToLowerInvariant()).ToArray();
            var indirectReferences = allContentTypes.Where(x =&gt; x.ContentTypeComposition.Any(y =&gt; y.Id == compositionContentType.Id));
            var comparer = new DelegateEqualityComparer&lt;IContentTypeComposition&gt;((x, y) =&gt; x.Id == y.Id, x =&gt; x.Id);
            var dependencies = new HashSet&lt;IContentTypeComposition&gt;(compositions, comparer);
            var stack = new Stack&lt;IContentTypeComposition&gt;();
            indirectReferences.ForEach(stack.Push); //Push indirect references to a stack, so we can add recursively
            while (stack.Count &gt; 0)
            {
                var indirectReference = stack.Pop();
                dependencies.Add(indirectReference);
                //Get all compositions for the current indirect reference
                var directReferences = indirectReference.ContentTypeComposition;

                foreach (var directReference in directReferences)
                {
                    if (directReference.Id == compositionContentType.Id || directReference.Alias.Equals(compositionContentType.Alias)) continue;
                    dependencies.Add(directReference);
                    //A direct reference has compositions of its own - these also need to be taken into account
                    var directReferenceGraph = directReference.CompositionAliases();
                    allContentTypes.Where(x =&gt; directReferenceGraph.Any(y =&gt; x.Alias.Equals(y, StringComparison.InvariantCultureIgnoreCase))).ForEach(c =&gt; dependencies.Add(c));
                }
                //Recursive lookup of indirect references
                allContentTypes.Where(x =&gt; x.ContentTypeComposition.Any(y =&gt; y.Id == indirectReference.Id)).ForEach(stack.Push);
            }

            foreach (var dependency in dependencies)
            {
                if (dependency.Id == compositionContentType.Id) continue;
                var contentTypeDependency = allContentTypes.FirstOrDefault(x =&gt; x.Alias.Equals(dependency.Alias, StringComparison.InvariantCultureIgnoreCase));
                if (contentTypeDependency == null) continue;
                var intersect = contentTypeDependency.PropertyTypes.Select(x =&gt; x.Alias.ToLowerInvariant()).Intersect(propertyTypeAliases).ToArray();
                if (intersect.Length == 0) continue;

                throw new InvalidCompositionException(compositionContentType.Alias, intersect.ToArray());
            }
        }

        /// &lt;summary&gt;
        /// Saves a single &lt;see cref=&quot;IContentType&quot;/&gt; object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentType&quot;&gt;&lt;see cref=&quot;IContentType&quot;/&gt; to save&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;Optional id of the user saving the ContentType&lt;/param&gt;
        public void Save(IContentType contentType, int userId = 0)
        {
            if (SavingContentType.IsRaisedEventCancelled(new SaveEventArgs&lt;IContentType&gt;(contentType), this))
                return;

            if (string.IsNullOrWhiteSpace(contentType.Name))
            {
                throw new ArgumentException(&quot;Cannot save content type with empty name.&quot;);
            }

            using (new WriteLock(Locker))
            {
                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateContentTypeRepository(uow))
                {
                    ValidateLocked(contentType); // throws if invalid
                    contentType.CreatorId = userId;
                    if (contentType.Description == string.Empty)
                        contentType.Description = null;
                    repository.AddOrUpdate(contentType);

                    uow.Commit();
                }

                UpdateContentXmlStructure(contentType);
            }
            SavedContentType.RaiseEvent(new SaveEventArgs&lt;IContentType&gt;(contentType, false), this);
            Audit(AuditType.Save, string.Format(&quot;Save ContentType performed by user&quot;), userId, contentType.Id);
        }

        /// &lt;summary&gt;
        /// Saves a collection of &lt;see cref=&quot;IContentType&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentTypes&quot;&gt;Collection of &lt;see cref=&quot;IContentType&quot;/&gt; to save&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;Optional id of the user saving the ContentType&lt;/param&gt;
        public void Save(IEnumerable&lt;IContentType&gt; contentTypes, int userId = 0)
        {
            var asArray = contentTypes.ToArray();

            if (SavingContentType.IsRaisedEventCancelled(new SaveEventArgs&lt;IContentType&gt;(asArray), this))
                return;

            using (new WriteLock(Locker))
            {
                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateContentTypeRepository(uow))
                {
                    // all-or-nothing, validate them all first
                    foreach (var contentType in asArray)
                    {
                        ValidateLocked(contentType); // throws if invalid
                    }
                    foreach (var contentType in asArray)
                    {
                        contentType.CreatorId = userId;
                        if (contentType.Description == string.Empty)
                            contentType.Description = null;
                        repository.AddOrUpdate(contentType);
                    }

                    //save it all in one go
                    uow.Commit();
                }

                UpdateContentXmlStructure(asArray.Cast&lt;IContentTypeBase&gt;().ToArray());
            }
            SavedContentType.RaiseEvent(new SaveEventArgs&lt;IContentType&gt;(asArray, false), this);
            Audit(AuditType.Save, string.Format(&quot;Save ContentTypes performed by user&quot;), userId, -1);
        }

        /// &lt;summary&gt;
        /// Deletes a single &lt;see cref=&quot;IContentType&quot;/&gt; object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentType&quot;&gt;&lt;see cref=&quot;IContentType&quot;/&gt; to delete&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;Optional id of the user issueing the delete&lt;/param&gt;
        /// &lt;remarks&gt;Deleting a &lt;see cref=&quot;IContentType&quot;/&gt; will delete all the &lt;see cref=&quot;IContent&quot;/&gt; objects based on this &lt;see cref=&quot;IContentType&quot;/&gt;&lt;/remarks&gt;
        public void Delete(IContentType contentType, int userId = 0)
        {
            if (DeletingContentType.IsRaisedEventCancelled(new DeleteEventArgs&lt;IContentType&gt;(contentType), this))
                return;

            using (new WriteLock(Locker))
            {
                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateContentTypeRepository(uow))
                {
                    //TODO: This needs to change, if we are deleting a content type, we should just delete the data,
                    // this method will recursively go lookup every content item, check if any of it&#39;s descendants are
                    // of a different type, move them to the recycle bin, then permanently delete the content items.
                    // The main problem with this is that for every content item being deleted, events are raised...
                    // which we need for many things like keeping caches in sync, but we can surely do this MUCH better.

                    var deletedContentTypes = new List&lt;IContentType&gt;() {contentType};
                    deletedContentTypes.AddRange(contentType.Descendants().OfType&lt;IContentType&gt;());

                    foreach (var deletedContentType in deletedContentTypes)
                    {
                        _contentService.DeleteContentOfType(deletedContentType.Id);
                    }

                    repository.Delete(contentType);
                    uow.Commit();

                    DeletedContentType.RaiseEvent(new DeleteEventArgs&lt;IContentType&gt;(deletedContentTypes.DistinctBy(x =&gt; x.Id), false), this);
                }

                Audit(AuditType.Delete, string.Format(&quot;Delete ContentType performed by user&quot;), userId, contentType.Id);
            }
        }

        /// &lt;summary&gt;
        /// Deletes a collection of &lt;see cref=&quot;IContentType&quot;/&gt; objects.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentTypes&quot;&gt;Collection of &lt;see cref=&quot;IContentType&quot;/&gt; to delete&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;Optional id of the user issueing the delete&lt;/param&gt;
        /// &lt;remarks&gt;
        /// Deleting a &lt;see cref=&quot;IContentType&quot;/&gt; will delete all the &lt;see cref=&quot;IContent&quot;/&gt; objects based on this &lt;see cref=&quot;IContentType&quot;/&gt;
        /// &lt;/remarks&gt;
        public void Delete(IEnumerable&lt;IContentType&gt; contentTypes, int userId = 0)
        {
            var asArray = contentTypes.ToArray();

            if (DeletingContentType.IsRaisedEventCancelled(new DeleteEventArgs&lt;IContentType&gt;(asArray), this))
                return;

            using (new WriteLock(Locker))
            {
                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateContentTypeRepository(uow))
                {
                    var deletedContentTypes = new List&lt;IContentType&gt;();
                    deletedContentTypes.AddRange(asArray);

                    foreach (var contentType in asArray)
                    {
                        deletedContentTypes.AddRange(contentType.Descendants().OfType&lt;IContentType&gt;());
                    }

                    foreach (var deletedContentType in deletedContentTypes)
                    {
                        _contentService.DeleteContentOfType(deletedContentType.Id);
                    }

                    foreach (var contentType in asArray)
                    {
                        repository.Delete(contentType);
                    }

                    uow.Commit();

                    DeletedContentType.RaiseEvent(new DeleteEventArgs&lt;IContentType&gt;(deletedContentTypes.DistinctBy(x =&gt; x.Id), false), this);
                }

                Audit(AuditType.Delete, string.Format(&quot;Delete ContentTypes performed by user&quot;), userId, -1);
            }
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IMediaType&quot;/&gt; object by its Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;IMediaType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IMediaType&quot;/&gt;&lt;/returns&gt;
        public IMediaType GetMediaType(int id)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(id);
            }
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IMediaType&quot;/&gt; object by its Alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;Alias of the &lt;see cref=&quot;IMediaType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IMediaType&quot;/&gt;&lt;/returns&gt;
        public IMediaType GetMediaType(string alias)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(alias);
            }
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IMediaType&quot;/&gt; object by its Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;IMediaType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IMediaType&quot;/&gt;&lt;/returns&gt;
        public IMediaType GetMediaType(Guid id)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(id);
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of all available &lt;see cref=&quot;IMediaType&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ids&quot;&gt;Optional list of ids&lt;/param&gt;
        /// &lt;returns&gt;An Enumerable list of &lt;see cref=&quot;IMediaType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IMediaType&gt; GetAllMediaTypes(params int[] ids)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(ids);
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of all available &lt;see cref=&quot;IMediaType&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ids&quot;&gt;Optional list of ids&lt;/param&gt;
        /// &lt;returns&gt;An Enumerable list of &lt;see cref=&quot;IMediaType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IMediaType&gt; GetAllMediaTypes(IEnumerable&lt;Guid&gt; ids)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(ids.ToArray());
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of children for a &lt;see cref=&quot;IMediaType&quot;/&gt; object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the Parent&lt;/param&gt;
        /// &lt;returns&gt;An Enumerable list of &lt;see cref=&quot;IMediaType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IMediaType&gt; GetMediaTypeChildren(int id)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var query = Query&lt;IMediaType&gt;.Builder.Where(x =&gt; x.ParentId == id);
                var contentTypes = repository.GetByQuery(query);
                return contentTypes;
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of children for a &lt;see cref=&quot;IMediaType&quot;/&gt; object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the Parent&lt;/param&gt;
        /// &lt;returns&gt;An Enumerable list of &lt;see cref=&quot;IMediaType&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;IMediaType&gt; GetMediaTypeChildren(Guid id)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var found = GetMediaType(id);
                if (found == null) return Enumerable.Empty&lt;IMediaType&gt;();
                var query = Query&lt;IMediaType&gt;.Builder.Where(x =&gt; x.ParentId == found.Id);
                var contentTypes = repository.GetByQuery(query);
                return contentTypes;
            }
        }

        /// &lt;summary&gt;
        /// Checks whether an &lt;see cref=&quot;IMediaType&quot;/&gt; item has any children
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;IMediaType&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;True if the media type has any children otherwise False&lt;/returns&gt;
        public bool MediaTypeHasChildren(int id)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var query = Query&lt;IMediaType&gt;.Builder.Where(x =&gt; x.ParentId == id);
                int count = repository.Count(query);
                return count &gt; 0;
            }
        }

        /// &lt;summary&gt;
        /// Checks whether an &lt;see cref=&quot;IMediaType&quot;/&gt; item has any children
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;IMediaType&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;True if the media type has any children otherwise False&lt;/returns&gt;
        public bool MediaTypeHasChildren(Guid id)
        {
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(UowProvider.GetUnitOfWork()))
            {
                var found = GetMediaType(id);
                if (found == null) return false;
                var query = Query&lt;IMediaType&gt;.Builder.Where(x =&gt; x.ParentId == found.Id);
                int count = repository.Count(query);
                return count &gt; 0;
            }
        }

        public Attempt&lt;OperationStatus&lt;MoveOperationStatusType&gt;&gt; MoveMediaType(IMediaType toMove, int containerId)
        {
            var evtMsgs = EventMessagesFactory.Get();

            if (MovingMediaType.IsRaisedEventCancelled(
                new MoveEventArgs&lt;IMediaType&gt;(evtMsgs, new MoveEventInfo&lt;IMediaType&gt;(toMove, toMove.Path, containerId)),
                this))
            {
                return Attempt.Fail(
                    new OperationStatus&lt;MoveOperationStatusType&gt;(
                        MoveOperationStatusType.FailedCancelledByEvent, evtMsgs));
            }

            var moveInfo = new List&lt;MoveEventInfo&lt;IMediaType&gt;&gt;();
            var uow = UowProvider.GetUnitOfWork();
            using (var containerRepository = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.MediaTypeContainerGuid))
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(uow))
            {
                try
                {
                    EntityContainer container = null;
                    if (containerId &gt; 0)
                    {
                        container = containerRepository.Get(containerId);
                        if (container == null)
                            throw new DataOperationException&lt;MoveOperationStatusType&gt;(MoveOperationStatusType.FailedParentNotFound);
                    }
                    moveInfo.AddRange(repository.Move(toMove, container));
                }
                catch (DataOperationException&lt;MoveOperationStatusType&gt; ex)
                {
                    return Attempt.Fail(
                        new OperationStatus&lt;MoveOperationStatusType&gt;(ex.Operation, evtMsgs));
                }
                uow.Commit();
            }

            MovedMediaType.RaiseEvent(new MoveEventArgs&lt;IMediaType&gt;(false, evtMsgs, moveInfo.ToArray()), this);

            return Attempt.Succeed(
                new OperationStatus&lt;MoveOperationStatusType&gt;(MoveOperationStatusType.Success, evtMsgs));
        }

        public Attempt&lt;OperationStatus&lt;MoveOperationStatusType&gt;&gt; MoveContentType(IContentType toMove, int containerId)
        {
            var evtMsgs = EventMessagesFactory.Get();

            if (MovingContentType.IsRaisedEventCancelled(
                new MoveEventArgs&lt;IContentType&gt;(evtMsgs, new MoveEventInfo&lt;IContentType&gt;(toMove, toMove.Path, containerId)),
                this))
            {
                return Attempt.Fail(
                    new OperationStatus&lt;MoveOperationStatusType&gt;(
                        MoveOperationStatusType.FailedCancelledByEvent, evtMsgs));
            }

            var moveInfo = new List&lt;MoveEventInfo&lt;IContentType&gt;&gt;();
            var uow = UowProvider.GetUnitOfWork();
            using (var containerRepository = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.DocumentTypeContainerGuid))
            using (var repository = RepositoryFactory.CreateContentTypeRepository(uow))
            {
                try
                {
                    EntityContainer container = null;
                    if (containerId &gt; 0)
                    {
                        container = containerRepository.Get(containerId);
                        if (container == null)
                            throw new DataOperationException&lt;MoveOperationStatusType&gt;(MoveOperationStatusType.FailedParentNotFound);
                    }
                    moveInfo.AddRange(repository.Move(toMove, container));
                }
                catch (DataOperationException&lt;MoveOperationStatusType&gt; ex)
                {
                    return Attempt.Fail(
                        new OperationStatus&lt;MoveOperationStatusType&gt;(ex.Operation, evtMsgs));
                }
                uow.Commit();
            }

            MovedContentType.RaiseEvent(new MoveEventArgs&lt;IContentType&gt;(false, evtMsgs, moveInfo.ToArray()), this);

            return Attempt.Succeed(
                new OperationStatus&lt;MoveOperationStatusType&gt;(MoveOperationStatusType.Success, evtMsgs));
        }

        public Attempt&lt;OperationStatus&lt;IMediaType, MoveOperationStatusType&gt;&gt; CopyMediaType(IMediaType toCopy, int containerId)
        {
            var evtMsgs = EventMessagesFactory.Get();

            IMediaType copy;
            var uow = UowProvider.GetUnitOfWork();
            using (var containerRepository = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.MediaTypeContainerGuid))
            using (var repository = RepositoryFactory.CreateMediaTypeRepository(uow))
            {
                try
                {
                    if (containerId &gt; 0)
                    {
                        var container = containerRepository.Get(containerId);
                        if (container == null)
                            throw new DataOperationException&lt;MoveOperationStatusType&gt;(MoveOperationStatusType.FailedParentNotFound);
                    }
                    var alias = repository.GetUniqueAlias(toCopy.Alias);
                    copy = toCopy.DeepCloneWithResetIdentities(alias);
                    copy.Name = copy.Name + &quot; (copy)&quot;; // might not be unique

                    // if it has a parent, and the parent is a content type, unplug composition
                    // all other compositions remain in place in the copied content type
                    if (copy.ParentId &gt; 0)
                    {
                        var parent = repository.Get(copy.ParentId);
                        if (parent != null)
                            copy.RemoveContentType(parent.Alias);
                    }

                    copy.ParentId = containerId;
                    repository.AddOrUpdate(copy);
                }
                catch (DataOperationException&lt;MoveOperationStatusType&gt; ex)
                {
                    return Attempt.Fail(new OperationStatus&lt;IMediaType, MoveOperationStatusType&gt;(null, ex.Operation, evtMsgs));
                }
                uow.Commit();
            }

            return Attempt.Succeed(new OperationStatus&lt;IMediaType, MoveOperationStatusType&gt;(copy, MoveOperationStatusType.Success, evtMsgs));
        }

        public Attempt&lt;OperationStatus&lt;IContentType, MoveOperationStatusType&gt;&gt; CopyContentType(IContentType toCopy, int containerId)
        {
            var evtMsgs = EventMessagesFactory.Get();

            IContentType copy;
            var uow = UowProvider.GetUnitOfWork();
            using (var containerRepository = RepositoryFactory.CreateEntityContainerRepository(uow, Constants.ObjectTypes.DocumentTypeContainerGuid))
            using (var repository = RepositoryFactory.CreateContentTypeRepository(uow))
            {
                try
                {
                    if (containerId &gt; 0)
                    {
                        var container = containerRepository.Get(containerId);
                        if (container == null)
                            throw new DataOperationException&lt;MoveOperationStatusType&gt;(MoveOperationStatusType.FailedParentNotFound);
                    }
                    var alias = repository.GetUniqueAlias(toCopy.Alias);
                    copy = toCopy.DeepCloneWithResetIdentities(alias);
                    copy.Name = copy.Name + &quot; (copy)&quot;; // might not be unique

                    // if it has a parent, and the parent is a content type, unplug composition
                    // all other compositions remain in place in the copied content type
                    if (copy.ParentId &gt; 0)
                    {
                        var parent = repository.Get(copy.ParentId);
                        if (parent != null)
                            copy.RemoveContentType(parent.Alias);
                    }

                    copy.ParentId = containerId;
                    repository.AddOrUpdate(copy);
                }
                catch (DataOperationException&lt;MoveOperationStatusType&gt; ex)
                {
                    return Attempt.Fail(new OperationStatus&lt;IContentType, MoveOperationStatusType&gt;(null, ex.Operation, evtMsgs));
                }
                uow.Commit();
            }

            return Attempt.Succeed(new OperationStatus&lt;IContentType, MoveOperationStatusType&gt;(copy, MoveOperationStatusType.Success, evtMsgs));
        }

        /// &lt;summary&gt;
        /// Saves a single &lt;see cref=&quot;IMediaType&quot;/&gt; object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaType&quot;&gt;&lt;see cref=&quot;IMediaType&quot;/&gt; to save&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;Optional Id of the user saving the MediaType&lt;/param&gt;
        public void Save(IMediaType mediaType, int userId = 0)
        {
            if (SavingMediaType.IsRaisedEventCancelled(new SaveEventArgs&lt;IMediaType&gt;(mediaType), this))
                return;

            using (new WriteLock(Locker))
            {
                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateMediaTypeRepository(uow))
                {
                    ValidateLocked(mediaType); // throws if invalid
                    mediaType.CreatorId = userId;
                    if (mediaType.Description == string.Empty)
                        mediaType.Description = null;
                    repository.AddOrUpdate(mediaType);
                    uow.Commit();

                }

                UpdateContentXmlStructure(mediaType);
            }

            SavedMediaType.RaiseEvent(new SaveEventArgs&lt;IMediaType&gt;(mediaType, false), this);
            Audit(AuditType.Save, string.Format(&quot;Save MediaType performed by user&quot;), userId, mediaType.Id);
        }

        /// &lt;summary&gt;
        /// Saves a collection of &lt;see cref=&quot;IMediaType&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaTypes&quot;&gt;Collection of &lt;see cref=&quot;IMediaType&quot;/&gt; to save&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;Optional Id of the user savging the MediaTypes&lt;/param&gt;
        public void Save(IEnumerable&lt;IMediaType&gt; mediaTypes, int userId = 0)
        {
            var asArray = mediaTypes.ToArray();

            if (SavingMediaType.IsRaisedEventCancelled(new SaveEventArgs&lt;IMediaType&gt;(asArray), this))
                return;

            using (new WriteLock(Locker))
            {
                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateMediaTypeRepository(uow))
                {
                    // all-or-nothing, validate them all first
                    foreach (var mediaType in asArray)
                    {
                        ValidateLocked(mediaType); // throws if invalid
                    }
                    foreach (var mediaType in asArray)
                    {
                        mediaType.CreatorId = userId;
                        if (mediaType.Description == string.Empty)
                            mediaType.Description = null;
                        repository.AddOrUpdate(mediaType);
                    }

                    //save it all in one go
                    uow.Commit();
                }

                UpdateContentXmlStructure(asArray.Cast&lt;IContentTypeBase&gt;().ToArray());
            }

            SavedMediaType.RaiseEvent(new SaveEventArgs&lt;IMediaType&gt;(asArray, false), this);
            Audit(AuditType.Save, string.Format(&quot;Save MediaTypes performed by user&quot;), userId, -1);
        }

        /// &lt;summary&gt;
        /// Deletes a single &lt;see cref=&quot;IMediaType&quot;/&gt; object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaType&quot;&gt;&lt;see cref=&quot;IMediaType&quot;/&gt; to delete&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;Optional Id of the user deleting the MediaType&lt;/param&gt;
        /// &lt;remarks&gt;Deleting a &lt;see cref=&quot;IMediaType&quot;/&gt; will delete all the &lt;see cref=&quot;IMedia&quot;/&gt; objects based on this &lt;see cref=&quot;IMediaType&quot;/&gt;&lt;/remarks&gt;
        public void Delete(IMediaType mediaType, int userId = 0)
        {
            if (DeletingMediaType.IsRaisedEventCancelled(new DeleteEventArgs&lt;IMediaType&gt;(mediaType), this))
                return;
            using (new WriteLock(Locker))
            {
                _mediaService.DeleteMediaOfType(mediaType.Id, userId);

                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateMediaTypeRepository(uow))
                {
                    var deletedMediaTypes = new List&lt;IMediaType&gt;() {mediaType};
                    deletedMediaTypes.AddRange(mediaType.Descendants().OfType&lt;IMediaType&gt;());

                    repository.Delete(mediaType);
                    uow.Commit();

                    DeletedMediaType.RaiseEvent(new DeleteEventArgs&lt;IMediaType&gt;(deletedMediaTypes.DistinctBy(x =&gt; x.Id), false), this);
                }

                Audit(AuditType.Delete, string.Format(&quot;Delete MediaType performed by user&quot;), userId, mediaType.Id);
            }
        }

        /// &lt;summary&gt;
        /// Deletes a collection of &lt;see cref=&quot;IMediaType&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaTypes&quot;&gt;Collection of &lt;see cref=&quot;IMediaType&quot;/&gt; to delete&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;Deleting a &lt;see cref=&quot;IMediaType&quot;/&gt; will delete all the &lt;see cref=&quot;IMedia&quot;/&gt; objects based on this &lt;see cref=&quot;IMediaType&quot;/&gt;&lt;/remarks&gt;
        public void Delete(IEnumerable&lt;IMediaType&gt; mediaTypes, int userId = 0)
        {
            var asArray = mediaTypes.ToArray();

            if (DeletingMediaType.IsRaisedEventCancelled(new DeleteEventArgs&lt;IMediaType&gt;(asArray), this))
                return;
            using (new WriteLock(Locker))
            {
                foreach (var mediaType in asArray)
                {
                    _mediaService.DeleteMediaOfType(mediaType.Id);
                }

                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateMediaTypeRepository(uow))
                {
                    var deletedMediaTypes = new List&lt;IMediaType&gt;();
                    deletedMediaTypes.AddRange(asArray);

                    foreach (var mediaType in asArray)
                    {
                        deletedMediaTypes.AddRange(mediaType.Descendants().OfType&lt;IMediaType&gt;());
                        repository.Delete(mediaType);
                    }
                    uow.Commit();

                    DeletedMediaType.RaiseEvent(new DeleteEventArgs&lt;IMediaType&gt;(deletedMediaTypes.DistinctBy(x =&gt; x.Id), false), this);
                }

                Audit(AuditType.Delete, string.Format(&quot;Delete MediaTypes performed by user&quot;), userId, -1);
            }
        }

        /// &lt;summary&gt;
        /// Generates the complete (simplified) XML DTD.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The DTD as a string&lt;/returns&gt;
        public string GetDtd()
        {
            var dtd = new StringBuilder();
            dtd.AppendLine(&quot;&lt;!DOCTYPE root [ &quot;);

            dtd.AppendLine(GetContentTypesDtd());
            dtd.AppendLine(&quot;]&gt;&quot;);

            return dtd.ToString();
        }

        /// &lt;summary&gt;
        /// Generates the complete XML DTD without the root.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The DTD as a string&lt;/returns&gt;
        public string GetContentTypesDtd()
        {
            var dtd = new StringBuilder();
            if (UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema)
            {
                dtd.AppendLine(&quot;&lt;!ELEMENT node ANY&gt; &lt;!ATTLIST node id ID #REQUIRED&gt;  &lt;!ELEMENT data ANY&gt;&quot;);
            }
            else
            {
                try
                {
                    var strictSchemaBuilder = new StringBuilder();

                    var contentTypes = GetAllContentTypes();
                    foreach (ContentType contentType in contentTypes)
                    {
                        string safeAlias = contentType.Alias.ToUmbracoAlias();
                        if (safeAlias != null)
                        {
                            strictSchemaBuilder.AppendLine(String.Format(&quot;&lt;!ELEMENT {0} ANY&gt;&quot;, safeAlias));
                            strictSchemaBuilder.AppendLine(String.Format(&quot;&lt;!ATTLIST {0} id ID #REQUIRED&gt;&quot;, safeAlias));
                        }
                    }

                    // Only commit the strong schema to the container if we didn&#39;t generate an error building it
                    dtd.Append(strictSchemaBuilder);
                }
                catch (Exception exception)
                {
                    LogHelper.Error&lt;ContentTypeService&gt;(&quot;Error while trying to build DTD for Xml schema; is Umbraco installed correctly and the connection string configured?&quot;, exception);
                }

            }
            return dtd.ToString();
        }

        private void Audit(AuditType type, string message, int userId, int objectId)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var auditRepo = RepositoryFactory.CreateAuditRepository(uow))
            {
                auditRepo.AddOrUpdate(new AuditItem(objectId, message, type, userId));
                uow.Commit();
            }
        }

        #region Event Handlers

        public static event TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;EntityContainer&gt;&gt; SavingContentTypeContainer;
        public static event TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;EntityContainer&gt;&gt; SavedContentTypeContainer;
        public static event TypedEventHandler&lt;IContentTypeService, DeleteEventArgs&lt;EntityContainer&gt;&gt; DeletingContentTypeContainer;
        public static event TypedEventHandler&lt;IContentTypeService, DeleteEventArgs&lt;EntityContainer&gt;&gt; DeletedContentTypeContainer;
        public static event TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;EntityContainer&gt;&gt; SavingMediaTypeContainer;
        public static event TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;EntityContainer&gt;&gt; SavedMediaTypeContainer;
        public static event TypedEventHandler&lt;IContentTypeService, DeleteEventArgs&lt;EntityContainer&gt;&gt; DeletingMediaTypeContainer;
        public static event TypedEventHandler&lt;IContentTypeService, DeleteEventArgs&lt;EntityContainer&gt;&gt; DeletedMediaTypeContainer;


        /// &lt;summary&gt;
        /// Occurs before Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, DeleteEventArgs&lt;IContentType&gt;&gt; DeletingContentType;

        /// &lt;summary&gt;
        /// Occurs after Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, DeleteEventArgs&lt;IContentType&gt;&gt; DeletedContentType;

        /// &lt;summary&gt;
        /// Occurs before Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, DeleteEventArgs&lt;IMediaType&gt;&gt; DeletingMediaType;

        /// &lt;summary&gt;
        /// Occurs after Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, DeleteEventArgs&lt;IMediaType&gt;&gt; DeletedMediaType;

        /// &lt;summary&gt;
        /// Occurs before Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;IContentType&gt;&gt; SavingContentType;

        /// &lt;summary&gt;
        /// Occurs after Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;IContentType&gt;&gt; SavedContentType;

        /// &lt;summary&gt;
        /// Occurs before Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;IMediaType&gt;&gt; SavingMediaType;

        /// &lt;summary&gt;
        /// Occurs after Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, SaveEventArgs&lt;IMediaType&gt;&gt; SavedMediaType;

        /// &lt;summary&gt;
        /// Occurs before Move
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, MoveEventArgs&lt;IMediaType&gt;&gt; MovingMediaType;

        /// &lt;summary&gt;
        /// Occurs after Move
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, MoveEventArgs&lt;IMediaType&gt;&gt; MovedMediaType;

        /// &lt;summary&gt;
        /// Occurs before Move
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, MoveEventArgs&lt;IContentType&gt;&gt; MovingContentType;

        /// &lt;summary&gt;
        /// Occurs after Move
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IContentTypeService, MoveEventArgs&lt;IContentType&gt;&gt; MovedContentType;

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,127,1],[31,15,31,78,1],[32,9,32,10,1],[33,13,33,40,1],[33,41,33,91,0],[34,13,34,38,1],[34,39,34,87,0],[35,13,35,46,1],[36,13,36,42,1],[37,9,37,10,1],[42,9,42,10,0],[43,13,43,54,0],[44,13,44,51,0],[45,20,45,134,0],[46,13,46,14,0],[48,17,48,18,0],[49,21,54,23,0],[56,21,58,31,0],[59,21,59,22,0],[60,25,60,168,0],[63,21,63,49,0],[64,21,64,34,0],[66,21,66,120,0],[69,21,69,152,0],[71,17,71,37,0],[72,17,72,18,0],[73,21,73,162,0],[76,9,76,10,0],[79,9,79,10,0],[80,13,80,54,0],[81,13,81,51,0],[82,20,82,131,0],[83,13,83,14,0],[85,17,85,18,0],[86,21,91,23,0],[93,21,95,31,0],[96,21,96,22,0],[97,25,97,168,0],[100,21,100,49,0],[101,21,101,34,0],[103,21,103,118,0],[106,21,106,152,0],[108,17,108,37,0],[109,17,109,18,0],[110,21,110,162,0],[113,9,113,10,0],[116,9,116,10,1],[117,13,119,102,1],[120,9,120,10,1],[123,9,123,10,0],[124,13,126,96,0],[127,9,127,10,0],[135,9,135,10,1],[136,13,136,54,1],[138,13,138,70,1],[139,13,139,14,0],[140,17,140,99,0],[141,17,141,63,0],[144,13,144,80,1],[145,13,145,14,0],[146,17,146,135,0],[147,17,147,63,0],[150,13,152,23,1],[153,13,153,14,0],[154,17,154,59,0],[157,13,157,51,1],[158,20,158,106,1],[159,13,159,14,1],[160,17,160,45,1],[161,17,161,30,1],[162,13,162,14,1],[164,13,164,97,1],[168,13,168,53,1],[169,9,169,10,1],[172,9,172,10,1],[173,13,173,95,1],[174,9,174,10,1],[177,9,177,10,0],[178,13,178,92,0],[179,9,179,10,0],[182,9,182,10,1],[183,13,183,51,1],[184,20,184,106,1],[185,13,185,14,1],[186,17,186,55,1],[187,17,187,34,1],[189,9,189,10,1],[192,9,192,10,0],[193,13,193,51,0],[194,20,194,131,0],[195,13,195,14,0],[196,17,196,50,0],[198,9,198,10,0],[201,9,201,10,0],[202,13,202,51,0],[203,20,203,131,0],[204,13,204,14,0],[205,17,205,46,0],[207,9,207,10,0],[210,9,210,10,0],[211,13,213,17,0],[213,17,213,18,0],[213,18,214,21,0],[214,21,214,55,0],[214,55,215,21,0],[215,21,215,31,0],[215,31,215,32,0],[215,32,215,52,0],[215,52,216,21,0],[216,21,216,41,0],[216,41,217,17,0],[217,17,217,18,0],[217,18,218,29,0],[218,29,218,67,0],[218,67,219,28,0],[211,13,219,28,0],[221,13,221,56,0],[222,9,222,10,0],[225,9,225,10,0],[226,13,226,95,0],[227,9,227,10,0],[230,9,230,10,1],[231,13,231,51,1],[232,20,232,134,1],[233,13,233,14,1],[234,17,234,50,1],[236,9,236,10,1],[239,9,239,10,0],[240,13,242,17,0],[242,17,242,18,0],[242,18,243,21,0],[243,21,243,55,0],[243,55,244,21,0],[244,21,244,31,0],[244,31,244,32,0],[244,32,244,52,0],[244,52,245,21,0],[245,21,245,41,0],[245,41,246,17,0],[246,17,246,18,0],[246,18,247,29,0],[247,29,247,69,0],[247,69,248,28,0],[240,13,248,28,0],[250,13,250,58,0],[251,9,251,10,0],[254,9,254,10,0],[255,13,255,92,0],[256,9,256,10,0],[259,9,259,10,0],[260,13,260,51,0],[261,20,261,106,0],[262,13,262,14,0],[263,17,263,55,0],[264,17,264,34,0],[266,9,266,10,0],[269,9,269,10,0],[270,13,270,51,0],[271,20,271,134,0],[272,13,272,14,0],[273,17,273,46,0],[275,9,275,10,0],[278,9,278,10,0],[279,13,279,54,0],[280,13,280,51,0],[281,20,281,134,0],[282,13,282,14,0],[283,17,283,55,0],[284,17,284,39,0],[284,40,284,84,0],[286,17,288,27,0],[289,17,289,18,0],[290,21,290,115,0],[293,17,293,40,0],[294,17,294,30,0],[296,17,296,120,0],[298,17,298,57,0],[301,9,301,10,0],[304,9,304,10,0],[305,13,305,54,0],[306,13,306,51,0],[307,20,307,131,0],[308,13,308,14,0],[309,17,309,55,0],[310,17,310,39,0],[310,40,310,84,0],[312,17,314,27,0],[315,17,315,18,0],[316,21,316,115,0],[319,17,319,40,0],[320,17,320,30,0],[322,17,322,118,0],[324,17,324,57,0],[327,9,327,10,0],[336,9,336,10,0],[337,20,337,111,0],[338,13,338,14,0],[339,17,339,63,0],[341,9,341,10,0],[352,9,352,10,0],[353,20,353,111,0],[354,13,354,14,0],[355,17,355,73,0],[357,9,357,10,0],[376,9,376,10,1],[377,13,377,40,1],[378,13,378,30,1],[379,13,379,14,0],[380,17,380,51,0],[381,17,381,36,0],[382,17,382,18,0],[383,21,383,108,0],[385,13,385,14,0],[386,13,386,56,1],[387,9,387,10,1],[406,9,406,10,1],[407,13,407,60,1],[408,13,408,61,1],[409,13,409,32,1],[410,13,410,14,1],[411,17,411,56,1],[411,56,411,134,0],[411,134,411,136,1],[411,17,411,136,1],[412,13,412,14,1],[414,13,414,70,1],[416,13,416,31,1],[418,13,418,96,1],[420,13,420,20,1],[420,22,420,27,1],[420,28,420,30,1],[420,31,420,49,1],[421,13,421,14,1],[422,17,422,44,1],[423,13,423,14,1],[426,13,426,32,1],[427,13,427,14,1],[429,17,429,46,1],[430,17,430,44,1],[431,13,431,14,1],[433,13,433,14,1],[435,17,435,37,1],[436,13,436,14,1],[438,13,438,25,1],[439,13,439,26,1],[440,9,440,10,1],[448,9,448,10,1],[449,20,449,111,1],[450,13,450,14,1],[451,17,451,43,1],[453,9,453,10,1],[461,9,461,10,1],[462,20,462,111,1],[463,13,463,14,1],[464,17,464,46,1],[466,9,466,10,1],[474,9,474,10,0],[475,20,475,111,0],[476,13,476,14,0],[477,17,477,43,0],[479,9,479,10,0],[487,9,487,10,1],[488,20,488,111,1],[489,13,489,14,1],[490,17,490,47,1],[492,9,492,10,1],[500,9,500,10,0],[501,20,501,111,0],[502,13,502,14,0],[503,17,503,57,0],[505,9,505,10,0],[513,9,513,10,1],[514,20,514,111,1],[515,13,515,14,1],[516,17,516,86,1],[517,17,517,65,1],[518,17,518,37,1],[520,9,520,10,1],[528,9,528,10,0],[529,20,529,111,0],[530,13,530,14,0],[531,17,531,48,0],[532,17,532,35,0],[532,36,532,76,0],[533,17,533,92,0],[534,17,534,65,0],[535,17,535,37,0],[537,9,537,10,0],[545,9,545,10,0],[546,20,546,111,0],[547,13,547,14,0],[548,17,548,86,0],[549,17,549,53,0],[550,17,550,34,0],[552,9,552,10,0],[560,9,560,10,0],[561,20,561,111,0],[562,13,562,14,0],[563,17,563,48,0],[564,17,564,35,0],[564,36,564,49,0],[565,17,565,92,0],[566,17,566,53,0],[567,17,567,34,0],[569,9,569,10,0],[577,9,577,10,1],[579,13,579,81,1],[581,13,581,32,1],[582,13,582,14,1],[583,17,583,50,1],[585,17,585,47,1],[586,17,586,18,1],[587,21,587,81,1],[588,21,588,53,1],[589,21,589,22,1],[590,25,590,79,1],[590,79,590,83,1],[590,83,590,96,1],[590,25,590,96,1],[591,21,591,22,1],[593,21,593,22,0],[595,25,595,56,0],[596,21,596,22,0],[597,17,597,18,1],[598,22,598,50,0],[599,17,599,18,0],[601,21,601,77,0],[602,21,602,53,0],[603,21,603,22,0],[604,25,604,87,0],[604,87,604,91,0],[604,91,604,104,0],[604,25,604,104,0],[605,21,605,22,0],[606,17,606,18,0],[607,13,607,14,1],[609,9,609,10,1],[612,9,612,10,0],[613,20,613,111,0],[614,13,614,14,0],[615,17,615,70,0],[617,9,617,10,0],[620,9,620,10,0],[621,20,621,109,0],[622,13,622,14,0],[623,17,623,68,0],[625,9,625,10,0],[633,9,633,10,0],[634,13,634,42,0],[635,13,635,14,0],[637,17,637,18,0],[638,21,638,43,0],[639,21,639,56,0],[641,17,641,55,0],[642,17,642,18,0],[643,21,643,69,0],[646,9,646,10,0],[649,9,649,10,1],[656,13,656,70,1],[657,13,657,66,1],[658,13,658,68,1],[661,13,661,37,1],[662,17,662,98,1],[663,18,663,40,1],[664,17,664,96,1],[665,18,665,41,0],[666,17,666,24,0],[668,17,668,108,0],[670,13,670,82,1],[671,13,671,59,1],[671,59,671,87,1],[671,87,671,104,1],[671,104,671,105,1],[671,59,671,105,1],[671,105,671,107,1],[671,13,671,107,1],[672,13,672,88,1],[672,88,672,114,1],[672,114,672,126,1],[672,13,672,126,1],[673,13,673,65,1],[673,65,673,99,1],[673,99,673,132,1],[673,132,673,133,1],[673,65,673,133,1],[673,133,673,135,1],[673,13,673,135,1],[674,13,674,92,1],[674,92,674,104,1],[674,104,674,111,1],[674,111,674,115,1],[674,115,674,117,1],[674,13,674,117,1],[675,13,675,93,1],[676,13,676,62,1],[677,13,677,52,1],[678,13,678,36,1],[679,13,679,14,1],[680,17,680,53,1],[681,17,681,53,1],[683,17,683,81,1],[685,17,685,24,1],[685,26,685,45,1],[685,46,685,48,1],[685,49,685,65,1],[686,17,686,18,1],[687,21,687,135,1],[687,136,687,145,1],[688,21,688,55,1],[690,21,690,85,1],[691,21,691,48,1],[691,48,691,78,1],[691,78,691,140,1],[691,140,691,141,1],[691,48,691,141,1],[691,141,691,156,1],[691,156,691,175,1],[691,175,691,177,1],[691,21,691,177,1],[692,17,692,18,1],[694,17,694,44,1],[694,44,694,78,1],[694,78,694,106,1],[694,106,694,107,1],[694,44,694,107,1],[694,107,694,129,1],[694,17,694,129,1],[695,13,695,14,1],[697,13,697,20,1],[697,22,697,36,1],[697,37,697,39,1],[697,40,697,52,1],[698,13,698,14,1],[699,17,699,64,1],[699,65,699,74,1],[700,17,700,81,1],[700,81,700,158,1],[700,158,700,160,1],[700,17,700,160,1],[701,17,701,51,1],[701,52,701,61,0],[702,17,702,81,1],[702,81,702,107,1],[702,107,702,150,1],[702,17,702,150,1],[703,17,703,43,1],[703,44,703,53,1],[705,17,705,106,1],[707,9,707,10,1],[715,9,715,10,1],[716,13,716,110,1],[717,17,717,24,0],[719,13,719,61,1],[720,13,720,14,1],[721,17,721,90,1],[724,13,724,42,1],[725,13,725,14,1],[726,17,726,55,1],[727,24,727,91,1],[728,17,728,18,1],[729,21,729,49,1],[730,21,730,52,1],[731,21,731,65,1],[732,25,732,56,1],[733,21,733,57,1],[735,21,735,34,1],[736,17,736,18,1],[738,17,738,56,1],[739,13,739,14,1],[740,13,740,100,1],[741,13,741,112,1],[742,9,742,10,1],[750,9,750,10,1],[751,13,751,50,1],[753,13,753,106,1],[754,17,754,24,0],[756,13,756,42,1],[757,13,757,14,1],[758,17,758,55,1],[759,24,759,91,1],[760,17,760,18,1],[762,21,762,28,1],[762,30,762,45,1],[762,46,762,48,1],[762,49,762,56,1],[763,21,763,22,1],[764,25,764,53,1],[765,21,765,22,1],[766,21,766,28,1],[766,30,766,45,1],[766,46,766,48,1],[766,49,766,56,1],[767,21,767,22,1],[768,25,768,56,1],[769,25,769,69,1],[770,29,770,60,1],[771,25,771,61,1],[772,21,772,22,1],[775,21,775,34,1],[776,17,776,18,1],[778,17,778,87,1],[779,13,779,14,1],[780,13,780,96,1],[781,13,781,101,1],[782,9,782,10,1],[791,9,791,10,1],[792,13,792,114,1],[793,17,793,24,0],[795,13,795,42,1],[796,13,796,14,1],[797,17,797,55,1],[798,24,798,91,1],[799,17,799,18,1],[806,21,806,86,1],[807,21,807,100,1],[809,21,809,28,1],[809,30,809,52,1],[809,53,809,55,1],[809,56,809,75,1],[810,21,810,22,1],[811,25,811,84,1],[812,21,812,22,1],[814,21,814,52,1],[815,21,815,34,1],[817,21,817,121,1],[817,121,817,125,1],[817,125,817,142,1],[817,21,817,142,1],[818,17,818,18,1],[820,17,820,120,1],[821,13,821,14,1],[822,9,822,10,1],[833,9,833,10,0],[834,13,834,50,0],[836,13,836,110,0],[837,17,837,24,0],[839,13,839,42,0],[840,13,840,14,0],[841,17,841,55,0],[842,24,842,91,0],[843,17,843,18,0],[844,21,844,72,0],[845,21,845,59,0],[847,21,847,28,0],[847,30,847,45,0],[847,46,847,48,0],[847,49,847,56,0],[848,21,848,22,0],[849,25,849,104,0],[850,21,850,22,0],[852,21,852,28,0],[852,30,852,52,0],[852,53,852,55,0],[852,56,852,75,0],[853,21,853,22,0],[854,25,854,84,0],[855,21,855,22,0],[857,21,857,28,0],[857,30,857,45,0],[857,46,857,48,0],[857,49,857,56,0],[858,21,858,22,0],[859,25,859,56,0],[860,21,860,22,0],[862,21,862,34,0],[864,21,864,121,0],[864,121,864,125,0],[864,125,864,142,0],[864,21,864,142,0],[865,17,865,18,0],[867,17,867,109,0],[868,13,868,14,0],[869,9,869,10,0],[877,9,877,10,1],[878,20,878,109,1],[879,13,879,14,1],[880,17,880,43,1],[882,9,882,10,1],[890,9,890,10,0],[891,20,891,109,0],[892,13,892,14,0],[893,17,893,46,0],[895,9,895,10,0],[903,9,903,10,1],[904,20,904,109,1],[905,13,905,14,1],[906,17,906,43,1],[908,9,908,10,1],[916,9,916,10,1],[917,20,917,109,1],[918,13,918,14,1],[919,17,919,47,1],[921,9,921,10,1],[929,9,929,10,0],[930,20,930,109,0],[931,13,931,14,0],[932,17,932,57,0],[934,9,934,10,0],[942,9,942,10,0],[943,20,943,109,0],[944,13,944,14,0],[945,17,945,84,0],[946,17,946,65,0],[947,17,947,37,0],[949,9,949,10,0],[957,9,957,10,0],[958,20,958,109,0],[959,13,959,14,0],[960,17,960,46,0],[961,17,961,35,0],[961,36,961,74,0],[962,17,962,90,0],[963,17,963,65,0],[964,17,964,37,0],[966,9,966,10,0],[974,9,974,10,0],[975,20,975,109,0],[976,13,976,14,0],[977,17,977,84,0],[978,17,978,53,0],[979,17,979,34,0],[981,9,981,10,0],[989,9,989,10,0],[990,20,990,109,0],[991,13,991,14,0],[992,17,992,46,0],[993,17,993,35,0],[993,36,993,49,0],[994,17,994,90,0],[995,17,995,53,0],[996,17,996,34,0],[998,9,998,10,0],[1001,9,1001,10,0],[1002,13,1002,54,0],[1004,13,1006,23,0],[1007,13,1007,14,0],[1008,17,1010,83,0],[1013,13,1013,66,0],[1014,13,1014,51,0],[1015,20,1015,146,0],[1016,20,1016,85,0],[1017,13,1017,14,0],[1019,17,1019,18,0],[1020,21,1020,54,0],[1021,21,1021,41,0],[1022,21,1022,22,0],[1023,25,1023,74,0],[1024,25,1024,47,0],[1025,29,1025,133,0],[1026,21,1026,22,0],[1027,21,1027,75,0],[1028,17,1028,18,0],[1029,17,1029,75,0],[1030,17,1030,18,0],[1031,21,1032,94,0],[1034,17,1034,30,0],[1035,13,1035,14,0],[1037,13,1037,112,0],[1039,13,1040,105,0],[1041,9,1041,10,0],[1044,9,1044,10,0],[1045,13,1045,54,0],[1047,13,1049,23,0],[1050,13,1050,14,0],[1051,17,1053,83,0],[1056,13,1056,68,0],[1057,13,1057,51,0],[1058,20,1058,149,0],[1059,20,1059,87,0],[1060,13,1060,14,0],[1062,17,1062,18,0],[1063,21,1063,54,0],[1064,21,1064,41,0],[1065,21,1065,22,0],[1066,25,1066,74,0],[1067,25,1067,47,0],[1068,29,1068,133,0],[1069,21,1069,22,0],[1070,21,1070,75,0],[1071,17,1071,18,0],[1072,17,1072,75,0],[1073,17,1073,18,0],[1074,21,1075,94,0],[1077,17,1077,30,0],[1078,13,1078,14,0],[1080,13,1080,116,0],[1082,13,1083,105,0],[1084,9,1084,10,0],[1087,9,1087,10,0],[1088,13,1088,54,0],[1091,13,1091,51,0],[1092,20,1092,146,0],[1093,20,1093,85,0],[1094,13,1094,14,0],[1096,17,1096,18,0],[1097,21,1097,41,0],[1098,21,1098,22,0],[1099,25,1099,78,0],[1100,25,1100,47,0],[1101,29,1101,133,0],[1102,21,1102,22,0],[1103,21,1103,73,0],[1104,21,1104,71,0],[1105,21,1105,55,0],[1109,21,1109,43,0],[1110,21,1110,22,0],[1111,25,1111,68,0],[1112,25,1112,44,0],[1113,29,1113,66,0],[1114,21,1114,22,0],[1116,21,1116,49,0],[1117,21,1117,50,0],[1118,17,1118,18,0],[1119,17,1119,75,0],[1120,17,1120,18,0],[1121,21,1121,128,0],[1123,17,1123,30,0],[1124,13,1124,14,0],[1126,13,1126,142,0],[1127,9,1127,10,0],[1130,9,1130,10,0],[1131,13,1131,54,0],[1134,13,1134,51,0],[1135,20,1135,149,0],[1136,20,1136,87,0],[1137,13,1137,14,0],[1139,17,1139,18,0],[1140,21,1140,41,0],[1141,21,1141,22,0],[1142,25,1142,78,0],[1143,25,1143,47,0],[1144,29,1144,133,0],[1145,21,1145,22,0],[1146,21,1146,73,0],[1147,21,1147,71,0],[1148,21,1148,55,0],[1152,21,1152,43,0],[1153,21,1153,22,0],[1154,25,1154,68,0],[1155,25,1155,44,0],[1156,29,1156,66,0],[1157,21,1157,22,0],[1159,21,1159,49,0],[1160,21,1160,50,0],[1161,17,1161,18,0],[1162,17,1162,75,0],[1163,17,1163,18,0],[1164,21,1164,130,0],[1166,17,1166,30,0],[1167,13,1167,14,0],[1169,13,1169,144,0],[1170,9,1170,10,0],[1178,9,1178,10,1],[1179,13,1179,104,1],[1180,17,1180,24,0],[1182,13,1182,42,1],[1183,13,1183,14,1],[1184,17,1184,55,1],[1185,24,1185,89,1],[1186,17,1186,18,1],[1187,21,1187,47,1],[1188,21,1188,50,1],[1189,21,1189,63,1],[1190,25,1190,54,1],[1191,21,1191,55,1],[1192,21,1192,34,1],[1194,17,1194,18,1],[1196,17,1196,54,1],[1197,13,1197,14,1],[1199,13,1199,94,1],[1200,13,1200,108,1],[1201,9,1201,10,1],[1209,9,1209,10,0],[1210,13,1210,48,0],[1212,13,1212,102,0],[1213,17,1213,24,0],[1215,13,1215,42,0],[1216,13,1216,14,0],[1217,17,1217,55,0],[1218,24,1218,89,0],[1219,17,1219,18,0],[1221,21,1221,28,0],[1221,30,1221,43,0],[1221,44,1221,46,0],[1221,47,1221,54,0],[1222,21,1222,22,0],[1223,25,1223,51,0],[1224,21,1224,22,0],[1225,21,1225,28,0],[1225,30,1225,43,0],[1225,44,1225,46,0],[1225,47,1225,54,0],[1226,21,1226,22,0],[1227,25,1227,54,0],[1228,25,1228,67,0],[1229,29,1229,58,0],[1230,25,1230,59,0],[1231,21,1231,22,0],[1234,21,1234,34,0],[1235,17,1235,18,0],[1237,17,1237,87,0],[1238,13,1238,14,0],[1240,13,1240,92,0],[1241,13,1241,99,0],[1242,9,1242,10,0],[1251,9,1251,10,0],[1252,13,1252,108,0],[1253,17,1253,24,0],[1254,13,1254,42,0],[1255,13,1255,14,0],[1256,17,1256,71,0],[1258,17,1258,55,0],[1259,24,1259,89,0],[1260,17,1260,18,0],[1261,21,1261,80,0],[1262,21,1262,94,0],[1264,21,1264,50,0],[1265,21,1265,34,0],[1267,21,1267,115,0],[1267,115,1267,119,0],[1267,119,1267,136,0],[1267,21,1267,136,0],[1268,17,1268,18,0],[1270,17,1270,116,0],[1271,13,1271,14,0],[1272,9,1272,10,0],[1281,9,1281,10,0],[1282,13,1282,48,0],[1284,13,1284,106,0],[1285,17,1285,24,0],[1286,13,1286,42,0],[1287,13,1287,14,0],[1288,17,1288,24,0],[1288,26,1288,39,0],[1288,40,1288,42,0],[1288,43,1288,50,0],[1289,17,1289,18,0],[1290,21,1290,67,0],[1291,17,1291,18,0],[1293,17,1293,55,0],[1294,24,1294,89,0],[1295,17,1295,18,0],[1296,21,1296,68,0],[1297,21,1297,57,0],[1299,21,1299,28,0],[1299,30,1299,43,0],[1299,44,1299,46,0],[1299,47,1299,54,0],[1300,21,1300,22,0],[1301,25,1301,98,0],[1302,25,1302,54,0],[1303,21,1303,22,0],[1304,21,1304,34,0],[1306,21,1306,115,0],[1306,115,1306,119,0],[1306,119,1306,136,0],[1306,21,1306,136,0],[1307,17,1307,18,0],[1309,17,1309,107,0],[1310,13,1310,14,0],[1311,9,1311,10,0],[1318,9,1318,10,0],[1319,13,1319,43,0],[1320,13,1320,49,0],[1322,13,1322,50,0],[1323,13,1323,34,0],[1325,13,1325,35,0],[1326,9,1326,10,0],[1333,9,1333,10,0],[1334,13,1334,43,0],[1335,13,1335,80,0],[1336,13,1336,14,0],[1337,17,1337,108,0],[1338,13,1338,14,0],[1340,13,1340,14,0],[1342,17,1342,18,0],[1343,21,1343,67,0],[1345,21,1345,61,0],[1346,21,1346,28,0],[1346,30,1346,53,0],[1346,54,1346,56,0],[1346,57,1346,69,0],[1347,21,1347,22,0],[1348,25,1348,79,0],[1349,25,1349,47,0],[1350,25,1350,26,0],[1351,29,1351,108,0],[1352,29,1352,120,0],[1353,25,1353,26,0],[1354,21,1354,22,0],[1357,21,1357,53,0],[1358,17,1358,18,0],[1359,17,1359,44,0],[1360,17,1360,18,0],[1361,21,1361,188,0],[1362,17,1362,18,0],[1364,13,1364,14,0],[1365,13,1365,35,0],[1366,9,1366,10,0],[1369,9,1369,10,1],[1370,13,1370,51,1],[1371,20,1371,80,1],[1372,13,1372,14,1],[1373,17,1373,87,1],[1374,17,1374,30,1],[1375,13,1375,14,1],[1376,9,1376,10,1]]);
    </script>
  </body>
</html>