<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.MacroEngines\RazorDynamicNode\ExamineBackedMedia.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Xml.XPath;
using Examine;
using Examine.LuceneEngine.SearchCriteria;
using Examine.Providers;
using Umbraco.Core;
using UmbracoExamine;
using Lucene.Net.Documents;
using umbraco.interfaces;
using System.IO;


namespace umbraco.MacroEngines
{

    public class ExamineBackedMedia
    {
        private readonly BaseIndexProvider _indexer;
        private readonly BaseSearchProvider _searcher;
        //Custom properties won&#39;t be available
        public bool WasLoadedFromExamine;

        public static ExamineBackedMedia GetUmbracoMedia(int id)
        {

            try
            {
                //first check in Examine as this is WAY faster
                var criteria = ExamineManager.Instance
                    .SearchProviderCollection[Constants.Examine.InternalSearcher]
                    .CreateSearchCriteria(&quot;media&quot;);
                var filter = criteria.Id(id);
                var results = ExamineManager
                    .Instance.SearchProviderCollection[Constants.Examine.InternalSearcher]
                    .Search(filter.Compile());
                if (results.Any())
                {
                    return new ExamineBackedMedia(results.First());
                }
            }
            catch (FileNotFoundException)
            {
                //Currently examine is throwing FileNotFound exceptions when we have a loadbalanced filestore and a node is published in umbraco
                //See this thread: http://examine.cdodeplex.com/discussions/264341
                //Catch the exception here for the time being, and just fallback to GetMedia

            }

            var media = umbraco.library.GetMedia(id, true);
            if (media != null &amp;&amp; media.Current != null)
            {
                media.MoveNext();
                return new ExamineBackedMedia(media.Current);
            }

            return null;
        }

        public ExamineBackedMedia(XPathNavigator xpath)
        {
            if (xpath == null) throw new ArgumentNullException(&quot;xpath&quot;);
            Name = xpath.GetAttribute(&quot;nodeName&quot;, &quot;&quot;);
            Values = new Dictionary&lt;string, string&gt;();
            var result = xpath.SelectChildren(XPathNodeType.Element);
            //add the attributes e.g. id, parentId etc
            if (result.Current.HasAttributes)
            {
                if (result.Current.MoveToFirstAttribute())
                {
                    Values.Add(result.Current.Name, result.Current.Value);
                    while (result.Current.MoveToNextAttribute())
                    {
                        Values.Add(result.Current.Name, result.Current.Value);
                    }
                    result.Current.MoveToParent();
                }
            }
            while (result.MoveNext())
            {
                if (result.Current != null &amp;&amp; !result.Current.HasAttributes)
                {
                    string value = result.Current.Value;
                    if (string.IsNullOrEmpty(value))
                    {
                        if (result.Current.HasAttributes || result.Current.SelectChildren(XPathNodeType.Element).Count &gt; 0)
                        {
                            value = result.Current.OuterXml;
                        }
                    }
                    Values.Add(result.Current.Name, value);
                }

            }
            WasLoadedFromExamine = false;
        }

        public ExamineBackedMedia(SearchResult result)
        {
            if (result == null) throw new ArgumentNullException(&quot;result&quot;);
            Name = result.Fields[&quot;nodeName&quot;];
            Values = result.Fields;
            WasLoadedFromExamine = true;
        }

        /// &lt;summary&gt;
        /// Internal constructor used for unit tests
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;result&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;indexer&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;searcher&quot;&gt;&lt;/param&gt;
        internal ExamineBackedMedia(SearchResult result, BaseIndexProvider indexer, BaseSearchProvider searcher)
            : this(result)
        {
            _indexer = indexer;
            _searcher = searcher;
        }

        public IProperty LoadCustomPropertyNotFoundInExamine(string alias, out bool propertyExists)
        {
            //custom property, not loaded from examine
            //have to do a getmedia and get it that way, but then add it to the cache
            var media = umbraco.library.GetMedia(this.Id, true);
            if (media != null &amp;&amp; media.Current != null)
            {
                media.MoveNext();
                XPathNavigator xpath = media.Current;
                var result = xpath.SelectChildren(XPathNodeType.Element);
                while (result.MoveNext())
                {
                    if (result.Current != null &amp;&amp; !result.Current.HasAttributes)
                    {
                        if (string.Equals(result.Current.Name, alias))
                        {
                            string value = result.Current.Value;
                            if (string.IsNullOrEmpty(value))
                            {
                                value = result.Current.OuterXml;
                            }
                            Values.Add(result.Current.Name, value);
                            propertyExists = true;
                            return new PropertyResult(alias, value);
                        }
                    }
                }
            }
            propertyExists = false;
            return null;
        }
        public string Name { get; private set; }
        internal IDictionary&lt;string, string&gt; Values { get; set; }

        public Lazy&lt;ExamineBackedMedia&gt; Parent
        {
            get
            {
                var parentId = GetValueAsInt(&quot;parentID&quot;);
                return parentId != 0 
                    ? new Lazy&lt;ExamineBackedMedia&gt;(() =&gt; GetUmbracoMedia(parentId)) 
                    : null;
            }
        }

        public int ParentId
        {
            get
            {
                return GetValueAsInt(&quot;parentID&quot;);  
            }
        }

        public int Id
        {
            get
            {
                return GetValueAsInt(&quot;id&quot;);  
            }
        }

        public int SortOrder
        {
            get
            {
                return GetValueAsInt(&quot;sortOrder&quot;);  
            }
        }

        public string Url
        {
            get
            {
                return GetValueAsString(Constants.Conventions.Media.File);
            }
        }

        public string UrlName
        {
            get
            {
                return GetValueAsString(&quot;urlName&quot;);  
            }
        }

        public string NodeTypeAlias
        {
            get
            {
                return GetValueAsString(&quot;nodeTypeAlias&quot;);  
            }
        }

        public string WriterName
        {
            get
            {
                return GetValueAsString(&quot;writerName&quot;);  
            }
        }

        public string CreatorName
        {
            get
            {
                return GetValueAsString(&quot;writerName&quot;);  
            }
        }

        public int WriterID
        {
            get
            {
                return GetValueAsInt(&quot;writerID&quot;);                     
            }
        }

        public int CreatorID
        {
            get
            {
                //there is no creator id in xml, so will have to be the same as writer id :(
                return GetValueAsInt(&quot;writerID&quot;);                
            }
        }

        public string Path
        {
            get
            {
                return GetValueAsString(&quot;__Path&quot;);                
            }
        }

        public DateTime CreateDate
        {
            get
            {
                return GetvalueAsDateTime(&quot;createDate&quot;);                
            }
        }

        public DateTime UpdateDate
        {
            get
            {
                return GetvalueAsDateTime(&quot;updateDate&quot;);                
            }
        }

        public Guid Version
        {
            get
            {
                return GetValueAsGuid(&quot;version&quot;);               
            }
        }

        public string NiceUrl
        {
            get
            {
                return GetValueAsString(Constants.Conventions.Media.File);
            }
        }

        public int Level
        {
            get
            {
                var level = GetValueAsInt(&quot;level&quot;);
                if (level != 0) return level;

                //return it based on the path if level is not there
                string value;
                return Values.TryGetValue(&quot;__Path&quot;, out value) ? value.Split(&#39;,&#39;).Length : 0;
            }
        }

        private BaseIndexProvider GetIndexer()
        {
            return _indexer ?? ExamineManager.Instance.IndexProviderCollection[Constants.Examine.InternalIndexer];
        }

        private BaseSearchProvider GetSearcher()
        {
            return _searcher ?? ExamineManager.Instance.SearchProviderCollection[Constants.Examine.InternalSearcher];
        }

        private DateTime GetvalueAsDateTime(string key)
        {
            var dt = DateTime.MinValue;
            string value = null;
            if (Values.TryGetValue(key, out value))
            {
                if (DateTime.TryParse(value, out dt))
                {
                    return dt;
                }
                //normally dates in lucene are stored with a specific lucnene date format so we&#39;ll try to parse that.
                try
                {
                    return DateTools.StringToDate(value);
                }
                catch (FormatException)
                {
                    //it could not be formatted :(
                }
            }
            return dt;
        }

        private Guid GetValueAsGuid(string key)
        {
            string value;
            if (Values.TryGetValue(key, out value))
            {
                Guid gId;
                if (Guid.TryParse(value, out gId))
                {
                    return gId;
                }
            }
            return Guid.Empty;
        }

        private string GetValueAsString(string key)
        {
            string value;
            return Values.TryGetValue(key, out value) ? value : null;
        }

        private int GetValueAsInt(string key)
        {
            var val = 0;
            string value;
            if (Values.TryGetValue(key, out value))
            {                
                if (int.TryParse(value, out val))
                {
                    return val;
                }
            }
            return val;
        }

        public List&lt;IProperty&gt; PropertiesAsList
        {
            get
            {
                var internalProperties = new[] {
                    &quot;id&quot;, &quot;nodeName&quot;, &quot;updateDate&quot;, &quot;writerName&quot;, &quot;path&quot;, &quot;nodeTypeAlias&quot;,
                    &quot;parentID&quot;, &quot;__NodeId&quot;, &quot;__IndexType&quot;, &quot;__Path&quot;, &quot;__NodeTypeAlias&quot;, 
                    &quot;__nodeName&quot;
                };
                return Values
                    .Where(kvp =&gt; !internalProperties.Contains(kvp.Key))
                    .ToList()
                    .ConvertAll(kvp =&gt; new PropertyResult(kvp.Key, kvp.Value))
                    .Cast&lt;IProperty&gt;()
                    .ToList();
            }
        }

        public Lazy&lt;List&lt;ExamineBackedMedia&gt;&gt; ChildrenAsList
        {
            get
            {
                return new Lazy&lt;List&lt;ExamineBackedMedia&gt;&gt;(() =&gt; GetChildrenMedia(this.Id));
            }
        }

        private List&lt;ExamineBackedMedia&gt; GetChildrenMedia(int parentId)
        {
            try
            {
                //first check in Examine as this is WAY faster
                var searcher = GetSearcher();
                var indexer = GetIndexer();
                var criteria = searcher.CreateSearchCriteria(&quot;media&quot;);
                var filter = criteria.ParentId(parentId);
                ISearchResults results;
                var useLuceneSort = indexer != null &amp;&amp; indexer.IndexerData.StandardFields.Any(x =&gt; x.Name.InvariantEquals(&quot;sortOrder&quot;) &amp;&amp; x.EnableSorting);
                if (useLuceneSort)
                {
                    //we have a sortOrder field declared to be sorted, so we&#39;ll use Examine
                    results = searcher.Search(
                        filter.And().OrderBy(new SortableField(&quot;sortOrder&quot;, SortType.Int)).Compile());
                }
                else
                {
                    results = searcher.Search(filter.Compile());
                }
                
                if (results.Any())
                {
                    return useLuceneSort
                                ? results.Select(result =&gt; new ExamineBackedMedia(result)).ToList() //will already be sorted by lucene
                                : results.Select(result =&gt; new ExamineBackedMedia(result)).OrderBy(x =&gt; x.SortOrder).ToList();
                }
            }
            catch (FileNotFoundException)
            {
                //Currently examine is throwing FileNotFound exceptions when we have a loadbalanced filestore and a node is published in umbraco
                //See this thread: http://examine.cdodeplex.com/discussions/264341
                //Catch the exception here for the time being, and just fallback to GetMedia
            }

            var media = umbraco.library.GetMedia(parentId, true);
            if (media != null &amp;&amp; media.Current != null)
            {
                media.MoveNext();
                var children = media.Current.SelectChildren(XPathNodeType.Element);
                var mediaList = new List&lt;ExamineBackedMedia&gt;();
                while (children != null &amp;&amp; children.Current != null)
                {
                    if (children.MoveNext())
                    {
                        if (children.Current.Name != &quot;contents&quot;)
                        {
                            //make sure it&#39;s actually a node, not a property 
                            if (!string.IsNullOrEmpty(children.Current.GetAttribute(&quot;path&quot;, &quot;&quot;)) &amp;&amp;
                                !string.IsNullOrEmpty(children.Current.GetAttribute(&quot;id&quot;, &quot;&quot;)) &amp;&amp;
                                !string.IsNullOrEmpty(children.Current.GetAttribute(&quot;version&quot;, &quot;&quot;)))
                            {
                                mediaList.Add(new ExamineBackedMedia(children.Current));
                            }
                        }
                    }
                    else
                    {
                        break;
                    }
                }
                return mediaList;
            }

            return null;
        }

        public IProperty GetProperty(string Alias)
        {
            bool exists = false;
            return GetProperty(Alias, out exists);
        }

        public IProperty GetProperty(string alias, out bool propertyExists)
        {
            string value = null;

            //First, try to get the &#39;raw&#39; value, if that doesn&#39;t work try to get the normal one
            if (Values.TryGetValue(UmbracoContentIndexer.RawFieldPrefix + alias, out value)
                || Values.TryGetValue(alias, out value))
            {
                propertyExists = true;
                return new PropertyResult(alias, value);
            }

            propertyExists = false;
            return null;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,0],[30,13,30,14,0],[32,17,34,52,0],[35,17,35,46,0],[36,17,38,47,0],[39,17,39,35,0],[40,17,40,18,0],[41,21,41,68,0],[43,13,43,14,0],[44,13,44,42,0],[45,13,45,14,0],[50,13,50,14,0],[52,13,52,60,0],[53,13,53,56,0],[54,13,54,14,0],[55,17,55,34,0],[56,17,56,62,0],[59,13,59,25,0],[60,9,60,10,0],[62,9,62,56,0],[63,9,63,10,0],[64,13,64,31,0],[64,32,64,73,0],[65,13,65,55,0],[66,13,66,55,0],[67,13,67,70,0],[69,13,69,46,0],[70,13,70,14,0],[71,17,71,59,0],[72,17,72,18,0],[73,21,73,75,0],[74,21,74,65,0],[75,21,75,22,0],[76,25,76,79,0],[77,21,77,22,0],[78,21,78,51,0],[79,17,79,18,0],[80,13,80,14,0],[81,13,81,38,0],[82,13,82,14,0],[83,17,83,77,0],[84,17,84,18,0],[85,21,85,57,0],[86,21,86,53,0],[87,21,87,22,0],[88,25,88,124,0],[89,25,89,26,0],[90,29,90,61,0],[91,25,91,26,0],[92,21,92,22,0],[93,21,93,60,0],[94,17,94,18,0],[96,13,96,14,0],[97,13,97,42,0],[98,9,98,10,0],[100,9,100,55,1],[101,9,101,10,1],[102,13,102,32,1],[102,33,102,75,0],[103,13,103,46,1],[104,13,104,36,1],[105,13,105,41,1],[106,9,106,10,1],[115,15,115,27,1],[116,9,116,10,1],[117,13,117,32,1],[118,13,118,34,1],[119,9,119,10,1],[122,9,122,10,0],[125,13,125,65,0],[126,13,126,56,0],[127,13,127,14,0],[128,17,128,34,0],[129,17,129,54,0],[130,17,130,74,0],[131,17,131,42,0],[132,17,132,18,0],[133,21,133,81,0],[134,21,134,22,0],[135,25,135,71,0],[136,25,136,26,0],[137,29,137,65,0],[138,29,138,61,0],[139,29,139,30,0],[140,33,140,65,0],[141,29,141,30,0],[142,29,142,68,0],[143,29,143,51,0],[144,29,144,69,0],[146,21,146,22,0],[147,17,147,18,0],[148,13,148,14,0],[149,13,149,36,0],[150,13,150,25,0],[151,9,151,10,0],[152,30,152,34,0],[152,35,152,47,1],[153,55,153,59,1],[153,60,153,64,1],[158,13,158,14,0],[159,17,159,58,0],[160,17,161,58,0],[161,58,161,83,0],[161,83,162,28,0],[160,17,162,28,0],[163,13,163,14,0],[169,13,169,14,0],[170,17,170,50,0],[171,13,171,14,0],[177,13,177,14,1],[178,17,178,44,1],[179,13,179,14,1],[185,13,185,14,1],[186,17,186,51,1],[187,13,187,14,1],[193,13,193,14,0],[194,17,194,75,0],[195,13,195,14,0],[201,13,201,14,1],[202,17,202,52,1],[203,13,203,14,1],[209,13,209,14,0],[210,17,210,58,0],[211,13,211,14,0],[217,13,217,14,1],[218,17,218,55,1],[219,13,219,14,1],[225,13,225,14,1],[226,17,226,55,1],[227,13,227,14,1],[233,13,233,14,1],[234,17,234,50,1],[235,13,235,14,1],[241,13,241,14,1],[243,17,243,50,1],[244,13,244,14,1],[250,13,250,14,0],[251,17,251,51,0],[252,13,252,14,0],[258,13,258,14,1],[259,17,259,57,1],[260,13,260,14,1],[266,13,266,14,1],[267,17,267,57,1],[268,13,268,14,1],[274,13,274,14,1],[275,17,275,50,1],[276,13,276,14,1],[282,13,282,14,0],[283,17,283,75,0],[284,13,284,14,0],[290,13,290,14,1],[291,17,291,52,1],[292,17,292,32,1],[292,33,292,46,1],[296,17,296,94,0],[297,13,297,14,1],[301,9,301,10,1],[302,13,302,115,1],[303,9,303,10,1],[306,9,306,10,1],[307,13,307,118,1],[308,9,308,10,1],[311,9,311,10,1],[312,13,312,40,1],[313,13,313,33,1],[314,13,314,52,1],[315,13,315,14,1],[316,17,316,54,1],[317,17,317,18,0],[318,21,318,31,0],[322,17,322,18,1],[323,21,323,58,1],[325,17,325,40,0],[326,17,326,18,0],[328,17,328,18,0],[329,13,329,14,0],[330,13,330,23,0],[331,9,331,10,1],[334,9,334,10,1],[336,13,336,52,1],[337,13,337,14,1],[339,17,339,51,1],[340,17,340,18,1],[341,21,341,32,1],[343,13,343,14,0],[344,13,344,31,0],[345,9,345,10,1],[348,9,348,10,1],[350,13,350,70,1],[351,9,351,10,1],[354,9,354,10,1],[355,13,355,25,1],[357,13,357,52,1],[358,13,358,14,1],[359,17,359,50,1],[360,17,360,18,1],[361,21,361,32,1],[363,13,363,14,0],[364,13,364,24,0],[365,9,365,10,1],[370,13,370,14,0],[371,17,375,19,0],[376,17,377,35,0],[377,35,377,72,0],[377,72,379,40,0],[379,40,379,78,0],[379,78,381,31,0],[376,17,381,31,0],[382,13,382,14,0],[388,13,388,14,1],[389,17,389,65,1],[389,65,389,90,1],[389,90,389,92,1],[389,17,389,92,1],[390,13,390,14,1],[394,9,394,10,1],[396,13,396,14,1],[398,17,398,46,1],[399,17,399,44,1],[400,17,400,71,1],[401,17,401,58,1],[403,17,403,100,1],[403,100,403,154,1],[403,154,403,156,1],[403,17,403,156,1],[404,17,404,35,1],[405,17,405,18,1],[407,21,408,103,1],[409,17,409,18,1],[411,17,411,18,0],[412,21,412,65,0],[413,17,413,18,0],[415,17,415,35,1],[416,17,416,18,1],[417,21,418,60,1],[418,60,418,90,1],[418,90,419,60,1],[419,60,419,90,0],[419,90,419,105,1],[419,105,419,116,0],[419,116,419,127,1],[417,21,419,127,1],[421,13,421,14,0],[422,13,422,42,0],[423,13,423,14,0],[427,13,427,14,0],[429,13,429,66,0],[430,13,430,56,0],[431,13,431,14,0],[432,17,432,34,0],[433,17,433,84,0],[434,17,434,64,0],[435,17,435,69,0],[436,17,436,18,0],[437,21,437,45,0],[438,21,438,22,0],[439,25,439,65,0],[440,25,440,26,0],[442,29,444,101,0],[445,29,445,30,0],[446,33,446,89,0],[447,29,447,30,0],[448,25,448,26,0],[449,21,449,22,0],[451,21,451,22,0],[452,25,452,31,0],[454,17,454,18,0],[455,17,455,34,0],[458,13,458,25,0],[459,9,459,10,1],[462,9,462,10,0],[463,13,463,33,0],[464,13,464,51,0],[465,9,465,10,0],[468,9,468,10,0],[469,13,469,33,0],[472,13,473,57,0],[474,13,474,14,0],[475,17,475,39,0],[476,17,476,57,0],[479,13,479,36,0],[480,13,480,25,0],[481,9,481,10,0]]);
    </script>
  </body>
</html>