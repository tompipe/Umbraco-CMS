<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\macrocontainer\PrevalueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web.UI.WebControls;
using umbraco.uicontrols;
using umbraco.cms.businesslogic.macro;
using umbraco.BusinessLogic;
using System.Web.UI;


namespace umbraco.editorControls.macrocontainer
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class PrevalueEditor : System.Web.UI.WebControls.PlaceHolder, umbraco.interfaces.IDataPrevalue
    {

        #region Private fields
        private umbraco.cms.businesslogic.datatype.BaseDataType _datatype;

        private string _configuration;
        private List&lt;string&gt; _allowedMacros;
        private int? _maxNumber;
        private int? _preferedWidth;
        private int? _preferedHeight;

        private CheckBoxList _macroList = new CheckBoxList();
        private TextBox _txtMaxNumber;
        private TextBox _txtPreferedHeight;
        private TextBox _txtPreferedWidth;
 
        #endregion

        #region Constructor
        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataType&quot;&gt;&lt;/param&gt;
        public PrevalueEditor(umbraco.cms.businesslogic.datatype.BaseDataType dataType)
        {
            Datatype = dataType;
        }
        #endregion

        #region Overrides
        /// &lt;summary&gt;
        /// Initializes controls
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnInit(EventArgs e)
        {
            base.OnLoad(e);
            PropertyPanel allowedPropertyPanel = new PropertyPanel();
            allowedPropertyPanel.Text = &quot;Allowed Macros&quot;;
            allowedPropertyPanel.Controls.Add(_macroList);
            Controls.Add(allowedPropertyPanel);

            PropertyPanel numberPropertyPanel = new PropertyPanel();
            numberPropertyPanel.Text = &quot;Max Number&quot;;
            _txtMaxNumber = new TextBox();
            _txtMaxNumber.ID = &quot;maxnumber&quot;;
            numberPropertyPanel.Controls.Add(_txtMaxNumber);
            Controls.Add(numberPropertyPanel);

            PropertyPanel widthPropertyPanel = new PropertyPanel();
            widthPropertyPanel.Text = &quot;Prefered width&quot;;
            _txtPreferedWidth = new TextBox();
            _txtPreferedWidth.ID = &quot;prefwidth&quot;;
            widthPropertyPanel.Controls.Add(_txtPreferedWidth);
            Controls.Add(widthPropertyPanel);

            PropertyPanel heightPropertyPanel = new PropertyPanel();
            heightPropertyPanel.Text = &quot;Prefered height&quot;;
            _txtPreferedHeight = new TextBox();
            _txtPreferedHeight.ID = &quot;prefheight&quot;;
            heightPropertyPanel.Controls.Add(_txtPreferedHeight);
            Controls.Add(heightPropertyPanel);

        }

        /// &lt;summary&gt;
        /// Initialize the form
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            if (_macroList.Items.Count &lt; 1)
            {
                _macroList.DataValueField = &quot;Alias&quot;;
                _macroList.DataTextField = &quot;Name&quot;;
                _macroList.DataSource = Macro.GetAll();
                _macroList.DataBound += new EventHandler(MacroList_DataBound);
            }
            if (!Page.IsPostBack)
            {
                if(MaxNumber != 0)
                    _txtMaxNumber.Text = MaxNumber.ToString();
                if(PreferedWidth != 0)
                    _txtPreferedWidth.Text = PreferedWidth.ToString();
                if (PreferedHeight != 0)
                    _txtPreferedHeight.Text = PreferedHeight.ToString();
            }

            _macroList.DataBind();
        }

        #endregion

        #region EventHandlers
        private void MacroList_DataBound(object sender, EventArgs e)
        {
            CheckBoxList cbl = (CheckBoxList)sender;
            foreach (ListItem item in cbl.Items)
            {
                item.Selected = AllowedMacros.Contains(item.Value);
            }
        }
        #endregion

        #region Methods
        /// &lt;summary&gt;
        /// Returns the selected Macro&#39;s in a comma separated string
        /// &lt;/summary&gt;
        private string GetSelectedMacosFromCheckList()
        {
            StringBuilder  result = new StringBuilder();
            foreach (ListItem lst in _macroList.Items)
            {
                if (lst.Selected)
                {
                    //User Selected the Macro, add to the string builder  
                    if (result.Length &gt; 0)
                    {
                        //Allready item on the list add a comma first
                        result.Append(&quot;,&quot;);
                    }
                    result.Append(lst.Value);
                }
            }
            return result.ToString();
        }


        #endregion

        #region Properties

        public string Configuration
        {
            get
            {
                if (_configuration == null)
                {
                using (var sqlHelper = Application.SqlHelper)
                return sqlHelper.ExecuteScalar&lt;string&gt;(
                        &quot;select value from cmsDataTypePreValues where datatypenodeid = @datatypenodeid&quot;,
                        sqlHelper.CreateParameter(&quot;@datatypenodeid&quot;, Datatype.DataTypeDefinitionId));
                }
                else
                {
                    return _configuration;
                }
            }
        }

        public List&lt;string&gt; AllowedMacros
        {
            get
            {
                if (_allowedMacros == null)
                {
                    List&lt;string&gt; result = new List&lt;string&gt;();
                    string values = !String.IsNullOrEmpty(Configuration) ? Configuration.Split(&#39;|&#39;)[0] : &quot;&quot;;

                    if (!string.IsNullOrEmpty(values))
                    {
                        result.AddRange(values.Split(&#39;,&#39;));
                    }

                    _allowedMacros = result;

                    return _allowedMacros;                    

                }
                return _allowedMacros;
            }
        }

        public int? MaxNumber
        {
            get
            {
                if (_maxNumber == null)
                {
                    int output = 0;
                    if (Configuration != null &amp;&amp; Configuration.Split(&#39;|&#39;).Length &gt; 1)
                    {                        
                        int.TryParse(Configuration.Split(&#39;|&#39;)[1], out output);
                        return output;
                    }
                    return output;
                }
                else
                {
                    return _maxNumber;
                }

            }
        }


        public int? PreferedHeight
        {
            get
            {
                if (_preferedHeight == null)
                {
                    int output = 0;
                    if (Configuration != null &amp;&amp; Configuration.Split(&#39;|&#39;).Length &gt; 2)
                    {
                        int.TryParse(Configuration.Split(&#39;|&#39;)[2], out output);
                        return output;
                    }
                    return output;
                }
                else
                {
                    return _preferedHeight;
                }

            }
        }

        public int? PreferedWidth
        {
            get
            {
                if (_preferedWidth == null)
                {
                    int output = 0;
                    if (Configuration != null &amp;&amp; Configuration.Split(&#39;|&#39;).Length &gt; 3)
                    {
                        int.TryParse(Configuration.Split(&#39;|&#39;)[3], out output);
                        return output;
                    }
                    return output;
                }
                else
                {
                    return _preferedWidth;
                }

            }
        }
        
        #endregion

        #region IDataPrevalue Members
        /// &lt;summary&gt;
        /// Reference to the datatype 
        /// &lt;/summary&gt;
        public umbraco.cms.businesslogic.datatype.BaseDataType Datatype
        {
            get { return _datatype; }
            set { _datatype = value; }
        }

        /// &lt;summary&gt;
        /// Reference to the editor
        /// &lt;/summary&gt;
        public Control Editor
        {
            get { return this; }
        }

        /// &lt;summary&gt;
        /// Save settings
        /// &lt;/summary&gt;
        public void Save()
        {

            using (var sqlHelper = Application.SqlHelper)
            {
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsDataTypePreValues where datatypenodeid = @dtdefid&quot;, 
                    sqlHelper.CreateParameter(&quot;@dtdefid&quot;, Datatype.DataTypeDefinitionId));
            }

            StringBuilder config = new StringBuilder();
            config.Append(GetSelectedMacosFromCheckList());
            config.Append(&quot;|&quot;);
            int maxnumber = 0;
            int.TryParse(_txtMaxNumber.Text, out maxnumber);
            config.Append(maxnumber);
            config.Append(&quot;|&quot;);
            int prefheight = 0;
            int.TryParse(_txtPreferedHeight.Text, out prefheight);
            config.Append(prefheight);
            config.Append(&quot;|&quot;);
            int prefwidth = 0;
            int.TryParse(_txtPreferedWidth.Text, out prefwidth);
            config.Append(prefwidth);

            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;insert into cmsDataTypePreValues (datatypenodeid,[value],sortorder,alias) values (@dtdefid,@value,0,&#39;&#39;)&quot;,
                    sqlHelper.CreateParameter(&quot;@dtdefid&quot;, Datatype.DataTypeDefinitionId), sqlHelper.CreateParameter(&quot;@value&quot;, config.ToString()));
        }
        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,62,0],[39,9,39,88,0],[40,9,40,10,0],[41,13,41,33,0],[42,9,42,10,0],[51,9,51,10,0],[52,13,52,28,0],[53,13,53,70,0],[54,13,54,58,0],[55,13,55,59,0],[56,13,56,48,0],[58,13,58,69,0],[59,13,59,53,0],[60,13,60,43,0],[61,13,61,44,0],[62,13,62,61,0],[63,13,63,47,0],[65,13,65,68,0],[66,13,66,56,0],[67,13,67,47,0],[68,13,68,48,0],[69,13,69,64,0],[70,13,70,46,0],[72,13,72,69,0],[73,13,73,58,0],[74,13,74,48,0],[75,13,75,50,0],[76,13,76,66,0],[77,13,77,47,0],[79,9,79,10,0],[86,9,86,10,0],[87,13,87,28,0],[89,13,89,44,0],[90,13,90,14,0],[91,17,91,53,0],[92,17,92,51,0],[93,17,93,56,0],[94,17,94,79,0],[95,13,95,14,0],[96,13,96,34,0],[97,13,97,14,0],[98,17,98,35,0],[99,21,99,63,0],[100,17,100,39,0],[101,21,101,71,0],[102,17,102,41,0],[103,21,103,73,0],[104,13,104,14,0],[106,13,106,35,0],[107,9,107,10,0],[113,9,113,10,0],[114,13,114,53,0],[115,13,115,20,0],[115,22,115,35,0],[115,36,115,38,0],[115,39,115,48,0],[116,13,116,14,0],[117,17,117,68,0],[118,13,118,14,0],[119,9,119,10,0],[127,9,127,10,0],[128,13,128,57,0],[129,13,129,20,0],[129,22,129,34,0],[129,35,129,37,0],[129,38,129,54,0],[130,13,130,14,0],[131,17,131,34,0],[132,17,132,18,0],[134,21,134,43,0],[135,21,135,22,0],[137,25,137,44,0],[138,21,138,22,0],[139,21,139,46,0],[140,17,140,18,0],[141,13,141,14,0],[142,13,142,38,0],[143,9,143,10,0],[153,13,153,14,0],[154,17,154,44,0],[155,17,155,18,0],[156,24,156,61,0],[157,17,159,102,0],[162,17,162,18,0],[163,21,163,43,0],[165,13,165,14,0],[171,13,171,14,0],[172,17,172,44,0],[173,17,173,18,0],[174,21,174,62,0],[175,21,175,109,0],[177,21,177,55,0],[178,21,178,22,0],[179,25,179,60,0],[180,21,180,22,0],[182,21,182,45,0],[184,21,184,43,0],[187,17,187,39,0],[188,13,188,14,0],[194,13,194,14,0],[195,17,195,40,0],[196,17,196,18,0],[197,21,197,36,0],[198,21,198,86,0],[199,21,199,22,0],[200,25,200,79,0],[201,25,201,39,0],[203,21,203,35,0],[206,17,206,18,0],[207,21,207,39,0],[210,13,210,14,0],[217,13,217,14,0],[218,17,218,45,0],[219,17,219,18,0],[220,21,220,36,0],[221,21,221,86,0],[222,21,222,22,0],[223,25,223,79,0],[224,25,224,39,0],[226,21,226,35,0],[229,17,229,18,0],[230,21,230,44,0],[233,13,233,14,0],[239,13,239,14,0],[240,17,240,44,0],[241,17,241,18,0],[242,21,242,36,0],[243,21,243,86,0],[244,21,244,22,0],[245,25,245,79,0],[246,25,246,39,0],[248,21,248,35,0],[251,17,251,18,0],[252,21,252,43,0],[255,13,255,14,0],[266,17,266,18,0],[266,19,266,36,0],[266,37,266,38,0],[267,17,267,18,0],[267,19,267,37,0],[267,38,267,39,0],[275,17,275,18,0],[275,19,275,31,0],[275,32,275,33,0],[282,9,282,10,0],[284,20,284,57,0],[285,13,285,14,0],[286,17,287,91,0],[288,13,288,14,0],[290,13,290,56,0],[291,13,291,60,0],[292,13,292,32,0],[293,13,293,31,0],[294,13,294,61,0],[295,13,295,38,0],[296,13,296,32,0],[297,13,297,32,0],[298,13,298,67,0],[299,13,299,39,0],[300,13,300,32,0],[301,13,301,31,0],[302,13,302,65,0],[303,13,303,38,0],[305,20,305,57,0],[306,17,307,147,0],[308,9,308,10,0]]);
    </script>
  </body>
</html>