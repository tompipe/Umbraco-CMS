<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\insertMacro.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;

using System.Reflection;
using Umbraco.Core.IO;
using umbraco.BusinessLogic;
using umbraco.DataLayer;
using umbraco.businesslogic.Exceptions;

namespace umbraco.dialogs
{
    /// &lt;summary&gt;
    /// Summary description for insertMacro.
    /// &lt;/summary&gt;
    public partial class insertMacro : BasePages.UmbracoEnsuredPage
    {
        protected Button Button1;

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            //this could be used for media or content so we need to at least validate that the user has access to one or the other
            if (!ValidateUserApp(DefaultApps.content.ToString()) &amp;&amp; !ValidateUserApp(DefaultApps.media.ToString()))
                throw new UserAuthorizationException(&quot;The current user doesn&#39;t have access to the section/app&quot;);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            pane_edit.Text = ui.Text(&quot;general&quot;, &quot;edit&quot;, this.getUser()) + &quot; &quot; + ui.Text(&quot;general&quot;, &quot;macro&quot;, this.getUser());
            pane_insert.Text = ui.Text(&quot;general&quot;, &quot;insert&quot;, this.getUser()) + &quot; &quot; + ui.Text(&quot;general&quot;, &quot;macro&quot;, this.getUser());

            if (Request[&quot;macroID&quot;] != null || Request[&quot;macroAlias&quot;] != null)
            {
                // Put user code to initialize the page here
                cms.businesslogic.macro.Macro m;
                if (helper.Request(&quot;macroID&quot;) != &quot;&quot;)
                    m = new cms.businesslogic.macro.Macro(int.Parse(helper.Request(&quot;macroID&quot;)));
                else
                    m = cms.businesslogic.macro.Macro.GetByAlias(helper.Request(&quot;macroAlias&quot;));

			    foreach (var mp in m.Properties) {

                    var macroAssembly = mp.Type.Assembly;
                    var macroType = mp.Type.Type;
                    try
                    {

                        var assembly = Assembly.LoadFrom(IOHelper.MapPath(SystemDirectories.Bin + &quot;/&quot; + macroAssembly + &quot;.dll&quot;));

                        Type type = assembly.GetType(macroAssembly + &quot;.&quot; + macroType);
                        var typeInstance = Activator.CreateInstance(type) as interfaces.IMacroGuiRendering;
                        if (typeInstance != null)
                        {
                            var control = Activator.CreateInstance(type) as Control;
                            control.ID = mp.Alias;
                            if (Request[mp.Alias] != null)
                            {
                                if (Request[mp.Alias] != &quot;&quot;)
                                {
                                    type.GetProperty(&quot;Value&quot;).SetValue(control, Convert.ChangeType(Request[mp.Alias], type.GetProperty(&quot;Value&quot;).PropertyType), null);
                                }
                            }

                            // register alias
                            var pp = new uicontrols.PropertyPanel();
                            pp.Text = mp.Name;
                            pp.Controls.Add(control);

                            macroProperties.Controls.Add(pp);

                            /*
							macroProperties.Controls.Add(new LiteralControl(&quot;&lt;script&gt;\nregisterAlias(&#39;&quot; + control.ID + &quot;&#39;);\n&lt;/script&gt;&quot;));
							macroProperties.Controls.Add(new LiteralControl(&quot;&lt;tr&gt;&lt;td class=\&quot;propertyHeader\&quot;&gt;&quot; + mp.Name + &quot;&lt;/td&gt;&lt;td class=\&quot;propertyContent\&quot;&gt;&quot;));
							macroProperties.Controls.Add(control);
							macroProperties.Controls.Add(new LiteralControl(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;));
                            */
                        }
                        else
                        {
                            Trace.Warn(&quot;umbEditContent&quot;, &quot;Type doesn&#39;t exist or is not umbraco.interfaces.DataFieldI (&#39;&quot; + macroAssembly + &quot;.&quot; + macroType + &quot;&#39;)&quot;);
                        }

                    }
                    catch (Exception fieldException)
                    {
                        Trace.Warn(&quot;umbEditContent&quot;, &quot;Error creating type &#39;&quot; + macroAssembly + &quot;.&quot; + macroType + &quot;&#39;&quot;, fieldException);
                    }
                }
            }
            else
            {
                IRecordsReader macroRenderings;
				if (helper.Request(&quot;editor&quot;) != &quot;&quot;)
                {
                    const string query = &quot;select macroAlias, macroName from cmsMacro where macroUseInEditor = 1 order by macroName&quot;;
                    using (var sqlHelper = BusinessLogic.Application.SqlHelper)
                    using (var renderings = sqlHelper.ExecuteReader(query))
                        macroRenderings = renderings;
                }
                else
                {
                    const string query = &quot;select macroAlias, macroName from cmsMacro order by macroName&quot;;
                    using (var sqlHelper = BusinessLogic.Application.SqlHelper)
                    using (var renderings = sqlHelper.ExecuteReader(query))
                        macroRenderings = renderings;
                }

                macroAlias.DataSource = macroRenderings;
                macroAlias.DataValueField = &quot;macroAlias&quot;;
                macroAlias.DataTextField = &quot;macroName&quot;;
                macroAlias.DataBind();
                macroRenderings.Close();
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[29,13,29,28,0],[32,13,32,116,0],[33,17,33,113,0],[34,9,34,10,0],[37,9,37,10,0],[38,13,38,125,0],[39,13,39,129,0],[41,13,41,77,0],[42,13,42,14,0],[45,17,45,53,0],[46,21,46,97,0],[48,21,48,96,0],[50,8,50,15,0],[50,17,50,23,0],[50,24,50,26,0],[50,27,50,39,0],[50,41,50,42,0],[52,21,52,58,0],[53,21,53,50,0],[55,21,55,22,0],[57,25,57,130,0],[59,25,59,87,0],[60,25,60,108,0],[61,25,61,50,0],[62,25,62,26,0],[63,29,63,85,0],[64,29,64,51,0],[65,29,65,59,0],[66,29,66,30,0],[67,33,67,61,0],[68,33,68,34,0],[69,37,69,166,0],[70,33,70,34,0],[71,29,71,30,0],[74,29,74,69,0],[75,29,75,47,0],[76,29,76,54,0],[78,29,78,62,0],[86,25,86,26,0],[88,25,88,26,0],[89,29,89,164,0],[90,25,90,26,0],[92,21,92,22,0],[93,21,93,53,0],[94,21,94,22,0],[95,25,95,135,0],[96,21,96,22,0],[97,17,97,18,0],[98,13,98,14,0],[100,13,100,14,0],[102,5,102,40,0],[103,17,103,18,0],[105,28,105,79,0],[106,28,106,75,0],[107,25,107,54,0],[108,17,108,18,0],[110,17,110,18,0],[112,28,112,79,0],[113,28,113,75,0],[114,25,114,54,0],[115,17,115,18,0],[117,17,117,57,0],[118,17,118,58,0],[119,17,119,56,0],[120,17,120,39,0],[121,17,121,41,0],[122,13,122,14,0],[123,9,123,10,0]]);
    </script>
  </body>
</html>