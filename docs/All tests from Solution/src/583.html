<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\templateControls\Item.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.ComponentModel;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core.Models;
using umbraco.BusinessLogic.Actions;

namespace umbraco.presentation.templateControls
{
    /// &lt;summary&gt;
    /// Control that renders an Umbraco item on a page.
    /// &lt;/summary&gt;
    [DefaultProperty(&quot;Field&quot;)]
    [ToolboxData(&quot;&lt;{0}:Item runat=\&quot;server\&quot;&gt;&lt;/{0}:Item&gt;&quot;)]
	[Designer(&quot;umbraco.presentation.templateControls.ItemDesigner, umbraco&quot;)]
    public class Item : CompositeControl
    {
        
        #region Private Fields
        
        /// &lt;summary&gt;The item&#39;s unique ID on the page.&lt;/summary&gt;
        private readonly int m_ItemId;
        public AttributeCollectionAdapter LegacyAttributes;
        #endregion

        /// &lt;summary&gt;
        /// Used by the UmbracoHelper to assign an IPublishedContent to the Item which allows us to pass this in
        /// to the &#39;item&#39; ctor so that it renders with the new API instead of the old one.
        /// &lt;/summary&gt;
        internal IPublishedContent ContentItem { get; private set; }

        #region Public Control Properties
        
        /// &lt;summary&gt;
        /// Gets or sets the field name.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The field name.&lt;/value&gt;
        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public string Field
        {
            get { return (string)ViewState[&quot;Field&quot;] ?? String.Empty; }
            set { ViewState[&quot;Field&quot;] = value; }
        }

        /// &lt;summary&gt;
        /// Gets or sets the node id expression.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The node id expression.&lt;/value&gt;
        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public string NodeId
        {
            get { return (string)ViewState[&quot;NodeId&quot;] ?? String.Empty; }
            set { ViewState[&quot;NodeId&quot;] = value; }
        }

        /// &lt;summary&gt;
        /// Gets or sets the text to display if the control is empty.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The text to display if the control is empty.&lt;/value&gt;
        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public string TextIfEmpty
        {
            get { return (string)ViewState[&quot;TextIfEmpty&quot;] ?? String.Empty; }
            set { ViewState[&quot;TextIfEmpty&quot;] = value; }
        }

        /// &lt;summary&gt;
        /// Gets or sets the XPath expression used for the inline XSLT transformation.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// The XPath expression, or an empty string to disable XSLT transformation.
        /// The code &lt;c&gt;{0}&lt;/c&gt; is used as a placeholder for the rendered field contents.
        /// &lt;/value&gt;
        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public string Xslt
        {
            get { return (string)ViewState[&quot;Xslt&quot;] ?? String.Empty; }
            set { ViewState[&quot;Xslt&quot;] = value; }
        }

        /// &lt;summary&gt;
        /// Gets or sets a value indicating whether XML entity escaping of the XSLT transformation output is disabled.
        /// &lt;/summary&gt;
        /// &lt;value&gt;&lt;c&gt;true&lt;/c&gt; HTML escaping is disabled; otherwise, &lt;c&gt;false&lt;/c&gt; (default).&lt;/value&gt;
        /// &lt;remarks&gt;
        ///     This corresponds value to the &lt;c&gt;disable-output-escaping&lt;/c&gt; parameter
        ///     of the XSLT &lt;c&gt;value-of&lt;/c&gt; element.
        /// &lt;/remarks&gt;
        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(false)]
        [Localizable(true)]
        public bool XsltDisableEscaping
        {
            get { return ViewState[&quot;XsltEscape&quot;] == null ? false : (bool)ViewState[&quot;XsltEscape&quot;]; }
            set { ViewState[&quot;XsltEscape&quot;] = value; }
        }

        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public bool DebugMode
        {
            get { return ((ViewState[&quot;DebugMode&quot;] == null) ? false : (bool)ViewState[&quot;DebugMode&quot;]); }
            set { ViewState[&quot;DebugMode&quot;] = value; }
        }

        public ItemRenderer Renderer { get; set; }

        #endregion

        #region Public Readonly Properties
        
        /// &lt;summary&gt;
        /// Gets the item&#39;s unique ID on the page.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The item id.&lt;/value&gt;
        public int ItemId
        {
            get { return m_ItemId; }
        }
        
        /// &lt;summary&gt;
        /// Gets the Umbraco page elements.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The Umbraco page elements.&lt;/value&gt;
        public Hashtable PageElements
        {
            get
            {
                return Context.Items[&quot;pageElements&quot;] as Hashtable;
            }
        }

        #endregion

        #region Public Constructors
        
        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;Item&quot;/&gt; class.
        /// &lt;/summary&gt;
        public Item()
        {            
            Renderer = ItemRenderer.Instance;
        }

        /// &lt;summary&gt;
        /// Internal ctor used to assign an IPublishedContent object.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentItem&quot;&gt;&lt;/param&gt;
        internal Item(IPublishedContent contentItem)
            :this()
        {
            ContentItem = contentItem;
        }

        #endregion

        #region Overriden Control Methods
        
        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;E:System.Web.UI.Control.Init&quot;/&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;An &lt;see cref=&quot;T:System.EventArgs&quot;/&gt; object that contains the event data.&lt;/param&gt;
        protected override void OnInit(EventArgs e)
        {
            Attributes.Add(&quot;field&quot;, Field);
            LegacyAttributes = new AttributeCollectionAdapter(Attributes);
            Renderer.Init(this);

            base.OnInit(e);
        }  

        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;E:System.Web.UI.Control.Load&quot;/&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;T:System.EventArgs&quot;/&gt; object that contains the event data.&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            Renderer.Load(this);

            base.OnLoad(e);
        }

        /// &lt;summary&gt;
        /// Writes the &lt;see cref=&quot;T:System.Web.UI.WebControls.CompositeControl&quot;/&gt; content
        /// to the specified &lt;see cref=&quot;T:System.Web.UI.HtmlTextWriter&quot;/&gt; object, for display on the client.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;writer&quot;&gt;
        ///     An &lt;see cref=&quot;T:System.Web.UI.HtmlTextWriter&quot;/&gt; that represents
        ///     the output stream to render HTML content on the client.
        /// &lt;/param&gt;
        protected override void Render(HtmlTextWriter writer)
        {
            Renderer.Render(this, writer);
        }

        #endregion

        #region Helper Functions
        
        /// &lt;summary&gt;
        /// Gets the parsed node id. As a nodeid on a item element can be null, an integer or even a squarebracket syntax, this helper method
        /// is handy for getting the exact parsed nodeid back.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The parsed nodeid, the id of the current page OR null if it&#39;s not specified&lt;/returns&gt;
        public int? GetParsedNodeId()
        {
            if (!String.IsNullOrEmpty(NodeId))
            {
                string tempNodeId = helper.parseAttribute(PageElements, NodeId);
                int nodeIdInt = 0;
                if (int.TryParse(tempNodeId, out nodeIdInt))
                {
                    return nodeIdInt;
                }
            }
            else if (PageElements[&quot;pageID&quot;] != null)
            {
                return int.Parse(PageElements[&quot;pageID&quot;].ToString());
            }
            return null;
        }


        /// &lt;summary&gt;
        /// Gets a value indicating whether this control is inside the form tag.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if this control is inside the form tag; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/returns&gt;
        protected virtual bool IsInsideFormTag()
        {
            // check if this control has an ancestor that is the page form
            for (Control parent = this.Parent; parent != null; parent = parent.Parent)
                if (parent == Page.Form)
                    return true;

            return false;
        }

        /// &lt;summary&gt;
        /// Returns a &lt;see cref=&quot;T:System.String&quot;/&gt; that represents the current &lt;see cref=&quot;T:System.Object&quot;/&gt;.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// A &lt;see cref=&quot;T:System.String&quot;/&gt; that represents the current &lt;see cref=&quot;T:System.Object&quot;/&gt;.
        /// &lt;/returns&gt;
        public override string ToString()
        {
            return String.Format(&quot;Item {0} (NodeId &#39;{1}&#39; : {2})&quot;, ItemId, NodeId, Field);
        }

        #endregion

        #region Field Information Functions
        
        /// &lt;summary&gt;
        /// Determines whether the field is a dictionary item.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if the field is a dictionary item; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/returns&gt;
        protected virtual bool FieldIsDictionaryItem()
        {
            return helper.FindAttribute(new AttributeCollectionAdapter(Attributes), &quot;field&quot;).StartsWith(&quot;#&quot;);
        }

        /// &lt;summary&gt;
        /// Determines whether the field is recursive.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if the field is recursive; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/returns&gt;
        protected virtual bool FieldIsRercursive()
        {
            return helper.FindAttribute(new AttributeCollectionAdapter(Attributes), &quot;recursive&quot;) == &quot;true&quot;;
        }

        /// &lt;summary&gt;
        /// Determines whether field uses the API to lookup the value
        /// (if a NodeId attribute is specified and is different from the current page id).
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if API lookup is used; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/returns&gt;
        [Obsolete(&quot;Method never implemented&quot;, true)]
        protected virtual bool FieldIsApiLookup()
        {
            // TODO: remove false and add security
            return false;
        }

        /// &lt;summary&gt;
        /// Gets a value indicating whether the current item is editable by the current user.
        /// &lt;/summary&gt;
        /// &lt;value&gt;&lt;c&gt;true&lt;/c&gt; if the current item is editable by the current user; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/value&gt;
        protected virtual bool FieldEditableWithUserPermissions()
        {
            BusinessLogic.User u = helper.GetCurrentUmbracoUser();
            return u != null &amp;&amp; u.GetPermissions(PageElements[&quot;path&quot;].ToString()).Contains(ActionUpdate.Instance.Letter.ToString());
        } 

        #endregion
    }

    public class ItemDesigner : System.Web.UI.Design.ControlDesigner {

        private Item m_control;

        public override string GetDesignTimeHtml()
        {
            m_control =  this.Component as Item;
            return returnMarkup(String.Format(&quot;Getting &#39;{0}&#39;&quot;, m_control.Field));
        }

        private string returnMarkup(string message)
        {
            return &quot;&lt;span style=\&quot;background-color: #DDD; padding: 2px;\&quot;&gt;&quot; + message  + &quot;&lt;/span&gt;&quot;;
        }

        protected override string GetErrorDesignTimeHtml(Exception e)
        {
            if (this.Component != null) {
                m_control = this.Component as Item;
            }
            
            if (m_control != null &amp;&amp; !String.IsNullOrEmpty(m_control.Field))
            {
                return returnMarkup(String.Format(&quot;Getting &#39;{0}&#39;&quot;, m_control.Field));
            }
            else { return returnMarkup(&quot;&lt;em&gt;Please add a Field property&lt;/em&gt;&quot;); }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,50,32,54,0],[32,55,32,67,0],[46,17,46,18,0],[46,19,46,69,0],[46,70,46,71,0],[47,17,47,18,0],[47,19,47,46,0],[47,47,47,48,0],[60,17,60,18,0],[60,19,60,70,0],[60,71,60,72,0],[61,17,61,18,0],[61,19,61,47,0],[61,48,61,49,0],[74,17,74,18,0],[74,19,74,75,0],[74,76,74,77,0],[75,17,75,18,0],[75,19,75,52,0],[75,53,75,54,0],[91,17,91,18,0],[91,19,91,68,0],[91,69,91,70,0],[92,17,92,18,0],[92,19,92,45,0],[92,46,92,47,0],[109,17,109,18,0],[109,19,109,98,0],[109,99,109,100,0],[110,17,110,18,0],[110,19,110,51,0],[110,52,110,53,0],[119,17,119,18,0],[119,19,119,100,0],[119,101,119,102,0],[120,17,120,18,0],[120,19,120,50,0],[120,51,120,52,0],[123,40,123,44,0],[123,45,123,49,0],[135,17,135,18,0],[135,19,135,35,0],[135,36,135,37,0],[145,13,145,14,0],[146,17,146,67,0],[147,13,147,14,0],[157,9,157,22,0],[158,9,158,10,0],[159,13,159,46,0],[160,9,160,10,0],[167,14,167,20,0],[168,9,168,10,0],[169,13,169,39,0],[170,9,170,10,0],[181,9,181,10,0],[182,13,182,44,0],[183,13,183,75,0],[184,13,184,33,0],[186,13,186,28,0],[187,9,187,10,0],[194,9,194,10,0],[195,13,195,33,0],[197,13,197,28,0],[198,9,198,10,0],[209,9,209,10,0],[210,13,210,43,0],[211,9,211,10,0],[223,9,223,10,0],[224,13,224,47,0],[225,13,225,14,0],[226,17,226,81,0],[227,17,227,35,0],[228,17,228,61,0],[229,17,229,18,0],[230,21,230,38,0],[232,13,232,14,0],[233,18,233,53,0],[234,13,234,14,0],[235,17,235,69,0],[237,13,237,25,0],[238,9,238,10,0],[246,9,246,10,0],[248,18,248,46,0],[248,48,248,62,0],[248,64,248,86,0],[249,17,249,41,0],[250,21,250,33,0],[252,13,252,26,0],[253,9,253,10,0],[262,9,262,10,0],[263,13,263,90,0],[264,9,264,10,0],[275,9,275,10,0],[276,13,276,110,0],[277,9,277,10,0],[284,9,284,10,0],[285,13,285,108,0],[286,9,286,10,0],[295,9,295,10,0],[297,13,297,26,0],[298,9,298,10,0],[305,9,305,10,0],[306,13,306,67,0],[307,13,307,133,0],[308,9,308,10,0],[318,9,318,10,0],[319,13,319,49,0],[320,13,320,82,0],[321,9,321,10,0],[324,9,324,10,0],[325,13,325,100,0],[326,9,326,10,0],[329,9,329,10,0],[330,13,330,40,0],[330,41,330,42,0],[331,17,331,52,0],[332,13,332,14,0],[334,13,334,77,0],[335,13,335,14,0],[336,17,336,86,0],[338,18,338,19,0],[338,20,338,80,0],[339,9,339,10,0]]);
    </script>
  </body>
</html>