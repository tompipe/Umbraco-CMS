<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\NotFoundHandlers.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Diagnostics;
using System.Linq;
using System.Reflection;
using System.Web;
using System.Xml;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.member;
using umbraco.cms.businesslogic.template;
using umbraco.cms.businesslogic.web;
using umbraco.interfaces;
using Umbraco.Core.IO;
using umbraco.NodeFactory;
using Umbraco.Core;
using Umbraco.Web;
using Umbraco.Web.Routing;

namespace umbraco {


    /// &lt;summary&gt;
    /// THIS CLASS IS PURELY HERE TO SUPPORT THE QUERYBYXPATH METHOD WHICH IS USED BY OTHER LEGACY BITS
    /// &lt;/summary&gt;    
    internal class LegacyRequestHandler
    {
        private const string PageXPathQueryStart = &quot;/root&quot;;
        private const string UrlName = &quot;@urlName&quot;;
        
        public static string CreateXPathQuery(string url, bool checkDomain)
        {

            string _tempQuery = &quot;&quot;;
            if (GlobalSettings.HideTopLevelNodeFromPath &amp;&amp; checkDomain)
            {
                _tempQuery = &quot;/root&quot; + GetChildContainerName() + &quot;/*&quot;;
            }
            else if (checkDomain)
                _tempQuery = &quot;/root&quot; + GetChildContainerName();


            string[] requestRawUrl = url.Split(&quot;/&quot;.ToCharArray());

            // Check for Domain prefix
            string domainUrl = &quot;&quot;;
            if (checkDomain &amp;&amp; Domain.Exists(HttpContext.Current.Request.ServerVariables[&quot;SERVER_NAME&quot;]))
            {
                // we need to get the node based on domain
                INode n = new Node(Domain.GetRootFromDomain(HttpContext.Current.Request.ServerVariables[&quot;SERVER_NAME&quot;]));
                domainUrl = n.UrlName; // we don&#39;t use niceUrlFetch as we need more control
                if (n.Parent != null)
                {
                    while (n.Parent != null)
                    {
                        n = n.Parent;
                        domainUrl = n.UrlName + &quot;/&quot; + domainUrl;
                    }
                }
                domainUrl = &quot;/&quot; + domainUrl;

                // If at domain root
                if (url == &quot;&quot;)
                {
                    _tempQuery = &quot;&quot;;
                    requestRawUrl = domainUrl.Split(&quot;/&quot;.ToCharArray());
                    HttpContext.Current.Trace.Write(&quot;requestHandler&quot;,
                                                    &quot;Redirecting to domain: &quot; +
                                                    HttpContext.Current.Request.ServerVariables[&quot;SERVER_NAME&quot;] +
                                                    &quot;, nodeId: &quot; +
                                                    Domain.GetRootFromDomain(
                                                        HttpContext.Current.Request.ServerVariables[&quot;SERVER_NAME&quot;]).
                                                        ToString());
                }
                else
                {
                    // if it matches a domain url, skip all other xpaths and use this!
                    string langXpath = CreateXPathQuery(domainUrl + &quot;/&quot; + url, false);
                    if (content.Instance.XmlContent.DocumentElement.SelectSingleNode(langXpath) != null)
                        return langXpath;
                    else if (UmbracoConfig.For.UmbracoSettings().RequestHandler.UseDomainPrefixes)
                        return &quot;/domainprefixes-are-used-so-i-do-not-work&quot;;
                }
            }
            else if (url == &quot;&quot; &amp;&amp; !GlobalSettings.HideTopLevelNodeFromPath)
                _tempQuery += &quot;/*&quot;;

            bool rootAdded = false;
            if (GlobalSettings.HideTopLevelNodeFromPath &amp;&amp; requestRawUrl.Length == 1)
            {
                HttpContext.Current.Trace.Write(&quot;umbracoRequestHandler&quot;, &quot;xpath: &#39;&quot; + _tempQuery + &quot;&#39;&quot;);
                if (_tempQuery == &quot;&quot;)
                    _tempQuery = &quot;/root&quot; + GetChildContainerName() + &quot;/*&quot;;
                _tempQuery = &quot;/root&quot; + GetChildContainerName() + &quot;/* [&quot; + UrlName +
                             &quot; = \&quot;&quot; + requestRawUrl[0].Replace(&quot;.aspx&quot;, &quot;&quot;).ToLower() + &quot;\&quot;] | &quot; + _tempQuery;
                HttpContext.Current.Trace.Write(&quot;umbracoRequestHandler&quot;, &quot;xpath: &#39;&quot; + _tempQuery + &quot;&#39;&quot;);
                rootAdded = true;
            }


            for (int i = 0; i &lt;= requestRawUrl.GetUpperBound(0); i++)
            {
                if (requestRawUrl[i] != &quot;&quot;)
                    _tempQuery += GetChildContainerName() + &quot;/* [&quot; + UrlName + &quot; = \&quot;&quot; + requestRawUrl[i].Replace(&quot;.aspx&quot;, &quot;&quot;).ToLower() +
                                  &quot;\&quot;]&quot;;
            }

            if (GlobalSettings.HideTopLevelNodeFromPath &amp;&amp; requestRawUrl.Length == 2)
            {
                _tempQuery += &quot; | &quot; + PageXPathQueryStart + GetChildContainerName() + &quot;/* [&quot; + UrlName + &quot; = \&quot;&quot; +
                              requestRawUrl[1].Replace(&quot;.aspx&quot;, &quot;&quot;).ToLower() + &quot;\&quot;]&quot;;
            }
            HttpContext.Current.Trace.Write(&quot;umbracoRequestHandler&quot;, &quot;xpath: &#39;&quot; + _tempQuery + &quot;&#39;&quot;);

            Debug.Write(_tempQuery + &quot;(&quot; + PageXPathQueryStart + &quot;)&quot;);

            if (checkDomain)
                return _tempQuery;
            else if (!rootAdded)
                return PageXPathQueryStart + _tempQuery;
            else
                return _tempQuery;
        }

        private static string GetChildContainerName()
        {
            if (string.IsNullOrEmpty(UmbracoSettings.TEMP_FRIENDLY_XML_CHILD_CONTAINER_NODENAME) == false)
                return &quot;/&quot; + UmbracoSettings.TEMP_FRIENDLY_XML_CHILD_CONTAINER_NODENAME;
            return &quot;&quot;;
        }
    }

    public class SearchForAlias : INotFoundHandler {
        private int _redirectID = -1;
        private bool _cacheUrl = true;

        #region INotFoundHandler Members

        public bool Execute(string url) {
            bool _succes = false;
            string tempUrl = url.Trim(&#39;/&#39;).Replace(&quot;.aspx&quot;, string.Empty).ToLower();
            if (tempUrl.Length &gt; 0) {
                HttpContext.Current.Trace.Write(&quot;urlAlias&quot;, &quot;&#39;&quot; + tempUrl + &quot;&#39;&quot;);

                // Check for domain
                string currentDomain = System.Web.HttpContext.Current.Request.ServerVariables[&quot;SERVER_NAME&quot;];
                string prefixXPath = &quot;&quot;;
                if (Domain.Exists(currentDomain)) {
                    string xpathDomain = UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema ? &quot;//node [@id = &#39;{0}&#39;]&quot; : &quot;//* [@isDoc and @id = &#39;{0}&#39;]&quot;;
                    prefixXPath = string.Format(xpathDomain, Domain.GetRootFromDomain(currentDomain));
                    _cacheUrl = false;
                }


                // the reason we have almost two identical queries in the xpath is to support scenarios where the user have 
                // entered &quot;/my-url&quot; instead of &quot;my-url&quot; (ie. added a beginning slash)
                string xpath = UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema ? &quot;//node [contains(concat(&#39;,&#39;,translate(data [@alias = &#39;umbracoUrlAlias&#39;], &#39; &#39;, &#39;&#39;),&#39;,&#39;),&#39;,{0},&#39;) or contains(concat(&#39;,&#39;,translate(data [@alias = &#39;umbracoUrlAlias&#39;], &#39; &#39;, &#39;&#39;),&#39;,&#39;),&#39;,{1},&#39;)]&quot; :
                    &quot;//* [@isDoc and (contains(concat(&#39;,&#39;,translate(umbracoUrlAlias, &#39; &#39;, &#39;&#39;),&#39;,&#39;),&#39;,{0},&#39;) or contains(concat(&#39;,&#39;,translate(umbracoUrlAlias, &#39; &#39;, &#39;&#39;),&#39;,&#39;),&#39;,{1},&#39;))]&quot;;
                string query = String.Format(prefixXPath + xpath, tempUrl, &quot;/&quot; + tempUrl);
                XmlNode redir =
                    content.Instance.XmlContent.DocumentElement.SelectSingleNode(query);
                if (redir != null) {
                    _succes = true;
                    _redirectID = int.Parse(redir.Attributes.GetNamedItem(&quot;id&quot;).Value);
                }
            }
            return _succes;
        }

        public bool CacheUrl {
            get { return _cacheUrl; }
        }

        public int redirectID {
            get {
                // TODO:  Add SearchForAlias.redirectID getter implementation
                return _redirectID;
            }
        }

        #endregion
    }

    public class SearchForProfile : INotFoundHandler {
        private static int _profileId = -1;

        private int _redirectID = -1;

        #region INotFoundHandler Members

        public bool CacheUrl {
            get {
                // Do not cache profile urls, we need to store the login name
                return false;
            }
        }

        public bool Execute(string url) {
            bool _succes = false;
            url = url.Replace(&quot;.aspx&quot;, string.Empty);
            if (url.Length &gt; 0) {
                if (url.Substring(0, 1) == &quot;/&quot;)
                    url = url.Substring(1, url.Length - 1);

                if (url.IndexOf(&quot;/&quot;) &gt; 0) {
                    // Check if we&#39;re at the profile page
                    if (url.Substring(0, url.IndexOf(&quot;/&quot;)) == GlobalSettings.ProfileUrl) {
                        if (_profileId &lt; 0) {
                            // /root added to query to solve umbRuntime bug
                            string _tempQuery =
                                LegacyRequestHandler.CreateXPathQuery(url.Substring(0, url.IndexOf(&quot;/&quot;)), false);
                            _profileId =
                                int.Parse(
                                    content.Instance.XmlContent.SelectSingleNode(_tempQuery).Attributes.GetNamedItem(
                                        &quot;id&quot;).Value);
                        }

                        HttpContext.Current.Items[&quot;umbMemberLogin&quot;] =
                            url.Substring(url.IndexOf(&quot;/&quot;) + 1, url.Length - url.IndexOf(&quot;/&quot;) - 1);
                        _succes = true;
                        _redirectID = _profileId;
                    }
                }
            }
            return _succes;
        }

        public int redirectID {
            get {
                // TODO:  Add SearchForProfile.redirectID getter implementation
                return _redirectID;
            }
        }

        #endregion
    }

    public class SearchForTemplate : INotFoundHandler {
        private int _redirectID = -1;

        #region INotFoundHandler Members

        public bool CacheUrl {
            get {
                // Do not cache profile urls, we need to store the login name
                return false;
            }
        }

        public bool Execute(string url) {
            bool _succes = false;
            url = url.Replace(&quot;.aspx&quot;, string.Empty);
            string currentDomain = HttpContext.Current.Request.ServerVariables[&quot;SERVER_NAME&quot;];
            if (url.Length &gt; 0) {
                if (url.Substring(0, 1) == &quot;/&quot;)
                    url = url.Substring(1, url.Length - 1);

                XmlNode urlNode = null;
                string templateAlias = &quot;&quot;;

                // We&#39;re at domain root
                if (url.IndexOf(&quot;/&quot;) == -1)
                {
                    if (Domain.Exists(currentDomain))
                        urlNode = content.Instance.XmlContent.GetElementById(Domain.GetRootFromDomain(currentDomain).ToString());
                    else
                        urlNode = content.Instance.XmlContent.GetElementById(Document.GetRootDocuments()[0].Id.ToString());
                    templateAlias = url.ToLower();
                }
                else
                {
                    string theRealUrl = url.Substring(0, url.LastIndexOf(&quot;/&quot;));
                    string realUrlXPath = LegacyRequestHandler.CreateXPathQuery(theRealUrl, true);
                    urlNode = content.Instance.XmlContent.SelectSingleNode(realUrlXPath);
                    templateAlias =
                        url.Substring(url.LastIndexOf(&quot;/&quot;) + 1, url.Length - url.LastIndexOf((&quot;/&quot;)) - 1).ToLower();
                }

                if (urlNode != null &amp;&amp; Template.GetTemplateIdFromAlias(templateAlias) != 0)
                {
                    _redirectID = int.Parse(urlNode.Attributes.GetNamedItem(&quot;id&quot;).Value);

                    if (UmbracoConfig.For.UmbracoSettings().WebRouting.DisableAlternativeTemplates == false)
                    {
                        HttpContext.Current.Items[Constants.Conventions.Url.AltTemplate] = templateAlias;
                        HttpContext.Current.Trace.Write(&quot;umbraco.altTemplateHandler&quot;,
                            string.Format(&quot;Template changed to: &#39;{0}&#39;&quot;, HttpContext.Current.Items[Constants.Conventions.Url.AltTemplate]));
                    }

                    _succes = true;
                }
            }
            return _succes;
        }

        public int redirectID {
            get {
                // TODO:  Add SearchForProfile.redirectID getter implementation
                return _redirectID;
            }
        }

        #endregion
    }

    public class handle404 : INotFoundHandler {
        #region INotFoundHandler Members

        private int _redirectID = 0;

        public bool CacheUrl {
            get {
                return false;
            }
        }

        public bool Execute(string url) {
			try
			{
                LogHelper.Info&lt;handle404&gt;(string.Format(&quot;NotFound url {0} (from &#39;{1}&#39;)&quot;, url, HttpContext.Current.Request.UrlReferrer));

                // Test if the error404 not child elements
			    var error404 = NotFoundHandlerHelper.GetCurrentNotFoundPageId(
			        UmbracoConfig.For.UmbracoSettings().Content.Error404Collection.ToArray(),
			        HttpContext.Current.Request.ServerVariables[&quot;SERVER_NAME&quot;],
			        ApplicationContext.Current.Services.EntityService,
			        new PublishedContentQuery(UmbracoContext.Current.ContentCache, UmbracoContext.Current.MediaCache),
                    ApplicationContext.Current.Services.DomainService);

			    if (error404.HasValue)
			    {
			        _redirectID = error404.Value;
			        HttpContext.Current.Response.StatusCode = 404;
			        return true;
			    }

			    return false;
			}
			catch (Exception err)
			{
				LogHelper.Error&lt;handle404&gt;(&quot;An error occurred&quot;, err);
				return false;
			}
        }

        public int redirectID {
            get {
                return _redirectID;
            }
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,10,0],[35,13,35,36,0],[36,13,36,72,0],[37,13,37,14,0],[38,17,38,71,0],[39,13,39,14,0],[40,18,40,34,0],[41,17,41,64,0],[44,13,44,67,0],[47,13,47,35,0],[48,13,48,106,0],[49,13,49,14,0],[51,17,51,122,0],[52,17,52,39,0],[53,17,53,38,0],[54,17,54,18,0],[55,21,55,45,0],[56,21,56,22,0],[57,25,57,38,0],[58,25,58,65,0],[59,21,59,22,0],[60,17,60,18,0],[61,17,61,45,0],[64,17,64,31,0],[65,17,65,18,0],[66,21,66,37,0],[67,21,67,72,0],[68,21,74,69,0],[75,17,75,18,0],[77,17,77,18,0],[79,21,79,87,0],[80,21,80,105,0],[81,25,81,42,0],[82,26,82,99,0],[83,25,83,76,0],[84,17,84,18,0],[85,13,85,14,0],[86,18,86,76,0],[87,17,87,36,0],[89,13,89,36,0],[90,13,90,86,0],[91,13,91,14,0],[92,17,92,105,0],[93,17,93,38,0],[94,21,94,75,0],[95,17,96,112,0],[97,17,97,105,0],[98,17,98,34,0],[99,13,99,14,0],[102,18,102,27,0],[102,29,102,64,0],[102,66,102,69,0],[103,13,103,14,0],[104,17,104,44,0],[105,21,106,41,0],[107,13,107,14,0],[109,13,109,86,0],[110,13,110,14,0],[111,17,112,87,0],[113,13,113,14,0],[114,13,114,101,0],[116,13,116,71,0],[118,13,118,29,0],[119,17,119,35,0],[120,18,120,33,0],[121,17,121,57,0],[123,17,123,35,0],[124,9,124,10,0],[127,9,127,10,0],[128,13,128,107,0],[129,17,129,89,0],[130,13,130,23,0],[131,9,131,10,0],[135,9,135,38,0],[136,9,136,39,0],[140,41,140,42,0],[141,13,141,34,0],[142,13,142,85,0],[143,13,143,36,0],[143,37,143,38,0],[144,17,144,82,0],[147,17,147,110,0],[148,17,148,41,0],[149,17,149,50,0],[149,51,149,52,0],[150,21,150,163,0],[151,21,151,103,0],[152,21,152,39,0],[153,17,153,18,0],[158,17,159,185,0],[160,17,160,91,0],[161,17,162,89,0],[163,17,163,35,0],[163,36,163,37,0],[164,21,164,36,0],[165,21,165,88,0],[166,17,166,18,0],[167,13,167,14,0],[168,13,168,28,0],[169,9,169,10,0],[172,17,172,18,0],[172,19,172,36,0],[172,37,172,38,0],[176,17,176,18,0],[178,17,178,36,0],[179,13,179,14,0],[186,9,186,44,0],[188,9,188,38,0],[193,17,193,18,0],[195,17,195,30,0],[196,13,196,14,0],[199,41,199,42,0],[200,13,200,34,0],[201,13,201,54,0],[202,13,202,32,0],[202,33,202,34,0],[203,17,203,48,0],[204,21,204,60,0],[206,17,206,42,0],[206,43,206,44,0],[208,21,208,89,0],[208,90,208,91,0],[209,25,209,44,0],[209,45,209,46,0],[211,29,212,114,0],[213,29,216,54,0],[217,25,217,26,0],[219,25,220,100,0],[221,25,221,40,0],[222,25,222,50,0],[223,21,223,22,0],[224,17,224,18,0],[225,13,225,14,0],[226,13,226,28,0],[227,9,227,10,0],[230,17,230,18,0],[232,17,232,36,0],[233,13,233,14,0],[240,9,240,38,0],[245,17,245,18,0],[247,17,247,30,0],[248,13,248,14,0],[251,41,251,42,0],[252,13,252,34,0],[253,13,253,54,0],[254,13,254,95,0],[255,13,255,32,0],[255,33,255,34,0],[256,17,256,48,0],[257,21,257,60,0],[259,17,259,40,0],[260,17,260,43,0],[263,17,263,44,0],[264,17,264,18,0],[265,21,265,54,0],[266,25,266,130,0],[268,25,268,124,0],[269,21,269,51,0],[270,17,270,18,0],[272,17,272,18,0],[273,21,273,80,0],[274,21,274,99,0],[275,21,275,90,0],[276,21,277,116,0],[278,17,278,18,0],[280,17,280,92,0],[281,17,281,18,0],[282,21,282,90,0],[284,21,284,109,0],[285,21,285,22,0],[286,25,286,106,0],[287,25,288,140,0],[289,21,289,22,0],[291,21,291,36,0],[292,17,292,18,0],[293,13,293,14,0],[294,13,294,28,0],[295,9,295,10,0],[298,17,298,18,0],[300,17,300,36,0],[301,13,301,14,0],[310,9,310,37,0],[313,17,313,18,0],[314,17,314,30,0],[315,13,315,14,0],[318,41,318,42,0],[320,4,320,5,0],[321,17,321,137,0],[324,8,329,72,0],[331,8,331,30,0],[332,8,332,9,0],[333,12,333,41,0],[334,12,334,58,0],[335,12,335,24,0],[338,8,338,21,0],[340,4,340,25,0],[341,4,341,5,0],[342,5,342,58,0],[343,5,343,18,0],[345,9,345,10,0],[348,17,348,18,0],[349,17,349,36,0],[350,13,350,14,0]]);
    </script>
  </body>
</html>