<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Security\UmbracoBackOfficeIdentityTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using System.Web.Security;
using Newtonsoft.Json;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Security;
using Umbraco.Core.Services;

namespace Umbraco.Tests.Security
{
    [TestFixture]
    public class UmbracoBackOfficeIdentityTests
    {

        public const string TestIssuer = &quot;TestIssuer&quot;;

        [Test]
        public void Create_From_Claims_Identity()
        {
            var sessionId = Guid.NewGuid().ToString();
            var claimsIdentity = new ClaimsIdentity(new[]
            {             
                //This is the id that &#39;identity&#39; uses to check for the user id
                new Claim(ClaimTypes.NameIdentifier, &quot;1234&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer), 
                //This is the id that &#39;identity&#39; uses to check for the username
                new Claim(ClaimTypes.Name, &quot;testing&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer), 
                new Claim(ClaimTypes.GivenName, &quot;hello world&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer), 
                new Claim(Constants.Security.StartContentNodeIdClaimType, &quot;-1&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer),
                new Claim(Constants.Security.StartMediaNodeIdClaimType, &quot;5543&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer),
                new Claim(Constants.Security.AllowedApplicationsClaimType, &quot;content&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),
                new Claim(Constants.Security.AllowedApplicationsClaimType, &quot;media&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),
                new Claim(ClaimTypes.Locality, &quot;en-us&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),
                new Claim(Constants.Security.SessionIdClaimType, sessionId, Constants.Security.SessionIdClaimType, TestIssuer, TestIssuer),
                new Claim(ClaimsIdentity.DefaultRoleClaimType, &quot;admin&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),
            });
            
            var backofficeIdentity = UmbracoBackOfficeIdentity.FromClaimsIdentity(claimsIdentity);

            Assert.AreEqual(&quot;1234&quot;, backofficeIdentity.Id);
            Assert.AreEqual(sessionId, backofficeIdentity.SessionId);
            Assert.AreEqual(&quot;testing&quot;, backofficeIdentity.Username);
            Assert.AreEqual(&quot;hello world&quot;, backofficeIdentity.RealName);
            Assert.AreEqual(-1, backofficeIdentity.StartContentNode);
            Assert.AreEqual(5543, backofficeIdentity.StartMediaNode);
            Assert.IsTrue(new[] {&quot;content&quot;, &quot;media&quot;}.SequenceEqual(backofficeIdentity.AllowedApplications));
            Assert.AreEqual(&quot;en-us&quot;, backofficeIdentity.Culture);
            Assert.IsTrue(new[] { &quot;admin&quot; }.SequenceEqual(backofficeIdentity.Roles));

            Assert.AreEqual(10, backofficeIdentity.Claims.Count());
        }

        [Test]
        public void Create_From_Claims_Identity_Missing_Required_Claim()
        {
            var claimsIdentity = new ClaimsIdentity(new[]
            {             
                new Claim(ClaimTypes.NameIdentifier, &quot;1234&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer), 
                new Claim(ClaimTypes.Name, &quot;testing&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),                 
            });

            Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; UmbracoBackOfficeIdentity.FromClaimsIdentity(claimsIdentity));
        }

        [Test]
        public void Create_From_Claims_Identity_Required_Claim_Null()
        {
            var sessionId = Guid.NewGuid().ToString();
            var claimsIdentity = new ClaimsIdentity(new[]
            {             
                //null or empty
                new Claim(ClaimTypes.NameIdentifier, &quot;&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer), 
                new Claim(ClaimTypes.Name, &quot;testing&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer), 
                new Claim(ClaimTypes.GivenName, &quot;hello world&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer), 
                new Claim(Constants.Security.StartContentNodeIdClaimType, &quot;-1&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer),
                new Claim(Constants.Security.StartMediaNodeIdClaimType, &quot;5543&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer),
                new Claim(Constants.Security.AllowedApplicationsClaimType, &quot;content&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),
                new Claim(Constants.Security.AllowedApplicationsClaimType, &quot;media&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),
                new Claim(ClaimTypes.Locality, &quot;en-us&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),
                new Claim(Constants.Security.SessionIdClaimType, sessionId, Constants.Security.SessionIdClaimType, TestIssuer, TestIssuer),
                new Claim(ClaimsIdentity.DefaultRoleClaimType, &quot;admin&quot;, ClaimValueTypes.String, TestIssuer, TestIssuer),
            });

            Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; UmbracoBackOfficeIdentity.FromClaimsIdentity(claimsIdentity));
        }

        [Test]
        public void Create_With_User_Data()
        {
            var sessionId = Guid.NewGuid().ToString();
            var userData = new UserData(sessionId)
            {
                AllowedApplications = new[] {&quot;content&quot;, &quot;media&quot;},
                Culture = &quot;en-us&quot;,
                Id = 1234,
                RealName = &quot;hello world&quot;,
                Roles = new[] {&quot;admin&quot;},
                StartContentNode = -1,
                StartMediaNode = 654,
                Username = &quot;testing&quot;
            };

            var identity = new UmbracoBackOfficeIdentity(userData);

            Assert.AreEqual(11, identity.Claims.Count());
        }

        [Test]
        public void Create_With_Claims_And_User_Data()
        {
            var sessionId = Guid.NewGuid().ToString();
            var userData = new UserData(sessionId)
            {
                AllowedApplications = new[] { &quot;content&quot;, &quot;media&quot; },
                Culture = &quot;en-us&quot;,
                Id = 1234,
                RealName = &quot;hello world&quot;,
                Roles = new[] { &quot;admin&quot; },
                StartContentNode = -1,
                StartMediaNode = 654,
                Username = &quot;testing&quot;
            };

            var claimsIdentity = new ClaimsIdentity(new[]
            {                             
                new Claim(&quot;TestClaim1&quot;, &quot;test&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer), 
                new Claim(&quot;TestClaim1&quot;, &quot;test&quot;, ClaimValueTypes.Integer32, TestIssuer, TestIssuer)
            });

            var backofficeIdentity = new UmbracoBackOfficeIdentity(claimsIdentity, userData);

            Assert.AreEqual(13, backofficeIdentity.Claims.Count());
        }

        [Test]
        public void Create_With_Forms_Ticket()
        {
            var sessionId = Guid.NewGuid().ToString();
            var userData = new UserData(sessionId)
            {
                AllowedApplications = new[] { &quot;content&quot;, &quot;media&quot; },
                Culture = &quot;en-us&quot;,
                Id = 1234,
                RealName = &quot;hello world&quot;,
                Roles = new[] { &quot;admin&quot; },
                StartContentNode = -1,
                StartMediaNode = 654,
                Username = &quot;testing&quot;
            };

            var ticket = new FormsAuthenticationTicket(1, userData.Username, DateTime.Now, DateTime.Now.AddDays(1), true,
                JsonConvert.SerializeObject(userData));

            var identity = new UmbracoBackOfficeIdentity(ticket);

            Assert.AreEqual(12, identity.Claims.Count());
        }

        [Test]
        public void Clone()
        {
            var sessionId = Guid.NewGuid().ToString();
            var userData = new UserData(sessionId)
            {
                AllowedApplications = new[] { &quot;content&quot;, &quot;media&quot; },
                Culture = &quot;en-us&quot;,
                Id = 1234,
                RealName = &quot;hello world&quot;,
                Roles = new[] { &quot;admin&quot; },
                StartContentNode = -1,
                StartMediaNode = 654,
                Username = &quot;testing&quot;
            };

            var ticket = new FormsAuthenticationTicket(1, userData.Username, DateTime.Now, DateTime.Now.AddDays(1), true,
                JsonConvert.SerializeObject(userData));

            var identity = new UmbracoBackOfficeIdentity(ticket);

            var cloned = identity.Clone();

            Assert.AreEqual(12, cloned.Claims.Count());
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[24,13,24,55,1],[25,13,39,16,1],[41,13,41,99,1],[43,13,43,60,1],[44,13,44,70,1],[45,13,45,69,1],[46,13,46,73,1],[47,13,47,70,1],[48,13,48,70,1],[49,13,49,109,1],[50,13,50,66,1],[51,13,51,86,1],[53,13,53,68,1],[54,9,54,10,1],[58,9,58,10,1],[59,13,63,16,1],[65,13,65,60,1],[65,60,65,120,1],[65,120,65,122,1],[65,13,65,122,1],[66,9,66,10,1],[70,9,70,10,1],[71,13,71,55,1],[72,13,85,16,1],[87,13,87,60,1],[87,60,87,120,1],[87,120,87,122,1],[87,13,87,122,1],[88,9,88,10,1],[92,9,92,10,1],[93,13,93,55,1],[94,13,104,15,1],[106,13,106,68,1],[108,13,108,58,1],[109,9,109,10,1],[113,9,113,10,1],[114,13,114,55,1],[115,13,125,15,1],[127,13,131,16,1],[133,13,133,94,1],[135,13,135,68,1],[136,9,136,10,1],[140,9,140,10,1],[141,13,141,55,1],[142,13,152,15,1],[154,13,155,56,1],[157,13,157,66,1],[159,13,159,58,1],[160,9,160,10,1],[164,9,164,10,1],[165,13,165,55,1],[166,13,176,15,1],[178,13,179,56,1],[181,13,181,66,1],[183,13,183,43,1],[185,13,185,56,1],[186,9,186,10,1]]);
    </script>
  </body>
</html>