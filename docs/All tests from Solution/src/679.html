<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\users\PermissionsHandler.asmx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Web;
using System.Collections;
using System.Web.Services;
using System.Web.Services.Protocols;
using System.ComponentModel;
using System.Web.Script.Services;
using System.Web.UI;
using System.IO;
using System.Reflection;
using System.Web.UI.HtmlControls;
using umbraco.BasePages;
using System.Collections.Generic;
using umbraco.interfaces;
using umbraco.BusinessLogic.Actions;
using Umbraco.Core.IO;

namespace umbraco.cms.presentation.user
{
    /// &lt;summary&gt;
    /// Summary description for PermissionsHandler
    /// &lt;/summary&gt;
    [WebService(Namespace = &quot;http://tempuri.org/&quot;)]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    [ToolboxItem(false)]
    [ScriptService]
    public class PermissionsHandler : System.Web.Services.WebService
    {

        /// &lt;summary&gt;
        /// Loads the NodePermissions UserControl with the appropriate properties, renders the contents and returns the output html.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userID&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [WebMethod]        
        public string GetNodePermissions(int userID, string nodes)
        {
            Authorize();

            Page page = new Page();

            string path = SystemDirectories.Umbraco + &quot;/users/NodePermissions.ascx&quot;;
            NodePermissions nodePermissions = page.LoadControl(path) as NodePermissions;

            nodePermissions.UserID = userID;
            nodePermissions.NodeID = toIntArray(nodes);
            nodePermissions.ID = &quot;nodePermissions&quot;;
            
            page.Controls.Add(nodePermissions);
            StringWriter sw = new StringWriter();
            HttpContext.Current.Server.Execute(page, sw, false);
            return sw.ToString();
        }


        

        [WebMethod]
        public string SaveNodePermissions(int userID, string nodes, string permissions, bool replaceChild)
        {
			Authorize();

            UserPermissions uPermissions = new UserPermissions(BusinessLogic.User.GetUser(userID));
            List&lt;IAction&gt; actions = umbraco.BusinessLogic.Actions.Action.FromString(permissions);
            uPermissions.SaveNewPermissions(toIntArray(nodes), actions, replaceChild);

            return GetNodePermissions(userID, nodes);
        }

        private void Authorize()
        {
            if (!BasePage.ValidateUserContextID(BasePage.umbracoUserContextID))
                throw new Exception(&quot;Client authorization failed. User is not logged in&quot;);

        }

        private int[] toIntArray(string nodeIds) {

            string[] s_nodes = nodeIds.Split(&#39;,&#39;);
            int[] i_nodes = new int[s_nodes.Length];

            for (int i = 0; i &lt; s_nodes.Length; i++) {
                i_nodes[i] = int.Parse(s_nodes[i]);
            }

            return i_nodes;

        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[39,9,39,10,0],[40,13,40,25,0],[42,13,42,36,0],[44,13,44,85,0],[45,13,45,89,0],[47,13,47,45,0],[48,13,48,56,0],[49,13,49,52,0],[51,13,51,48,0],[52,13,52,50,0],[53,13,53,65,0],[54,13,54,34,0],[55,9,55,10,0],[62,9,62,10,0],[63,4,63,16,0],[65,13,65,100,0],[66,13,66,98,0],[67,13,67,87,0],[69,13,69,54,0],[70,9,70,10,0],[73,9,73,10,0],[74,13,74,80,0],[75,17,75,91,0],[77,9,77,10,0],[79,50,79,51,0],[81,13,81,51,0],[82,13,82,53,0],[84,18,84,27,0],[84,29,84,47,0],[84,49,84,52,0],[84,54,84,55,0],[85,17,85,52,0],[86,13,86,14,0],[88,13,88,28,0],[90,9,90,10,0]]);
    </script>
  </body>
</html>