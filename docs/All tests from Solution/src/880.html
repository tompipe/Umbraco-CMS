<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\LanguageTreeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data.SqlClient;
using System.Globalization;
using System.Net.Http.Formatting;
using System.Web.Services.Description;
using umbraco;
using umbraco.BusinessLogic.Actions;
using Umbraco.Core;
using Umbraco.Core.Models;
using umbraco.presentation.actions;
using Umbraco.Web.Models.Trees;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi.Filters;
using Constants = Umbraco.Core.Constants;

namespace Umbraco.Web.Trees
{
    [UmbracoTreeAuthorize(Constants.Trees.Languages)]
    [LegacyBaseTree(typeof(loadLanguages))]
    [Tree(Constants.Applications.Settings, Constants.Trees.Languages, null, sortOrder: 4)]
    [PluginController(&quot;UmbracoTrees&quot;)]
    [CoreTree]
    public class LanguageTreeController : TreeController
    {
        /// &lt;summary&gt;
        /// The method called to render the contents of the tree structure
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;
        /// All of the query string parameters passed from jsTree
        /// &lt;/param&gt;
        /// &lt;remarks&gt;
        /// We are allowing an arbitrary number of query strings to be pased in so that developers are able to persist custom data from the front-end
        /// to the back end to be used in the query for model data.
        /// &lt;/remarks&gt;
        protected override TreeNodeCollection GetTreeNodes(string id, FormDataCollection queryStrings)
        {
            var nodes = new TreeNodeCollection();

            if (id == Constants.System.Root.ToInvariantString())
            {
                var languages = Services.LocalizationService.GetAllLanguages();
                foreach (var language in languages)
                {
                    nodes.Add(
                        CreateTreeNode(
                            language.Id.ToString(CultureInfo.InvariantCulture), &quot;-1&quot;, queryStrings, language.CultureInfo.DisplayName, &quot;icon-flag-alt&quot;, false,
                            //TODO: Rebuild the language editor in angular, then we dont need to have this at all (which is just a path to the legacy editor)
                            &quot;/&quot; + queryStrings.GetValue&lt;string&gt;(&quot;application&quot;) + &quot;/framed/&quot; +
                            Uri.EscapeDataString(&quot;settings/editLanguage.aspx?id=&quot; + language.Id)));
                }
            }

            return nodes;
        }

        /// &lt;summary&gt;
        /// Returns the menu structure for the node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected override MenuItemCollection GetMenuForNode(string id, FormDataCollection queryStrings)
        {
            var menu = new MenuItemCollection();
            
            if (id == Constants.System.Root.ToInvariantString())
            {
                //Create the normal create action
                menu.Items.Add&lt;ActionNew&gt;(ui.Text(&quot;actions&quot;, ActionNew.Instance.Alias))
                    //Since we haven&#39;t implemented anything for languages in angular, this needs to be converted to 
                    //use the legacy format
                    .ConvertLegacyMenuItem(null, &quot;initlanguages&quot;, queryStrings.GetValue&lt;string&gt;(&quot;application&quot;));
               
                //refresh action
                menu.Items.Add&lt;RefreshNode, ActionRefresh&gt;(ui.Text(&quot;actions&quot;, ActionRefresh.Instance.Alias), true);

                return menu;
            }

            var lang = Services.LocalizationService.GetLanguageById(int.Parse(id));
            if (lang == null) return new MenuItemCollection();

            //add delete option for all languages
            menu.Items.Add&lt;ActionDelete&gt;(ui.Text(&quot;actions&quot;, ActionDelete.Instance.Alias))
                //Since we haven&#39;t implemented anything for languages in angular, this needs to be converted to 
                //use the legacy format
                .ConvertLegacyMenuItem(new UmbracoEntity
                {
                    Id = lang.Id,
                    Level = 1,
                    ParentId = -1,
                    Name = lang.CultureInfo.DisplayName                    
                }, &quot;language&quot;, queryStrings.GetValue&lt;string&gt;(&quot;application&quot;));

            return menu;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[37,9,37,10,0],[38,13,38,50,0],[40,13,40,65,0],[41,13,41,14,0],[42,17,42,80,0],[43,17,43,24,0],[43,26,43,38,0],[43,39,43,41,0],[43,42,43,51,0],[44,17,44,18,0],[45,21,50,100,0],[51,17,51,18,0],[52,13,52,14,0],[54,13,54,26,0],[55,9,55,10,0],[64,9,64,10,0],[65,13,65,49,0],[67,13,67,65,0],[68,13,68,14,0],[70,17,73,113,0],[76,17,76,116,0],[78,17,78,29,0],[81,13,81,84,0],[82,13,82,30,0],[82,31,82,63,0],[85,13,94,78,0],[96,13,96,25,0],[97,9,97,10,0]]);
    </script>
  </body>
</html>