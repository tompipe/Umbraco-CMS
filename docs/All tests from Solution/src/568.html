<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\plugins\tinymce3\JSON.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * $Id: JSON.cs 439 2007-11-26 13:26:10Z spocke $
 *
 * Copyright ï¿½ 2007, Moxiecode Systems AB, All rights reserved. 
 */

using System;
using System.IO;
using System.Collections;
using System.Collections.Specialized;

namespace umbraco.presentation.plugins.tinymce3
{
    /// &lt;summary&gt;
	/// Description of JSON.
	/// &lt;/summary&gt;
	public class JSON {
		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public static void SerializeRPC(string id, object error, object obj, Stream stream) {
			JSONWriter writer = new JSONWriter(new StreamWriter(stream));

			// Start JSON output
			writer.WriteStartObject();
			writer.WritePropertyName(&quot;result&quot;);
			WriteValue(writer, obj);

			// Write id
			writer.WritePropertyName(&quot;id&quot;);
			writer.WriteValue(id);

			// Write error
			writer.WritePropertyName(&quot;error&quot;);
			writer.WriteValue(null);

			// Close
			writer.WriteEndObject();
			writer.Close();
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;writer&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt;
		public static void WriteObject(TextWriter writer, object obj) {
			WriteValue(new JSONWriter(writer), obj);
			writer.Flush();
		}

		private static void WriteValue(JSONWriter writer, object obj) {
			if (obj == null)
				writer.WriteNull();

			if (obj is System.String)
				writer.WriteValue((string) obj);

			if (obj is System.Boolean)
				writer.WriteValue((bool) obj);

			if (obj is System.Double)
				writer.WriteValue(Convert.ToDouble(obj));

			if (obj is System.Int32)
				writer.WriteValue(Convert.ToInt32(obj));

			if (obj is System.Int64)
				writer.WriteValue(Convert.ToInt64(obj));

			if (obj is ArrayList) {
				writer.WriteStartArray();

				foreach (object val in ((ArrayList) obj))
					WriteValue(writer, val);

				writer.WriteEndArray();
			}

			if (obj is string[]) {
				writer.WriteStartArray();

				foreach (string val in ((string[]) obj))
					WriteValue(writer, val);

				writer.WriteEndArray();
			}

			if (obj is NameValueCollection) {
				writer.WriteStartObject();

				string[] keys = GetReversedKeys(obj);
				foreach (string key in keys) {
					writer.WritePropertyName(key);
					WriteValue(writer, ((NameValueCollection) obj)[key]);
				}

				writer.WriteEndObject();
			}

			if (obj is Hashtable) {
				writer.WriteStartObject();

				string[] keys = GetReversedKeys(obj);
				foreach (string key in keys) {
					writer.WritePropertyName((string) key);
					WriteValue(writer, ((Hashtable) obj)[key]);
				}

				writer.WriteEndObject();
			}
		}

		private static string[] GetReversedKeys(object obj) {
			ICollection keyCollection;
			string[] keys;
			int count;

			if (obj is Hashtable)
				keyCollection = ((Hashtable) obj).Keys;
			else
				keyCollection = ((NameValueCollection) obj).AllKeys;

			count = keyCollection.Count;
			keys = new string[count];

			foreach (string key in keyCollection)
				keys[--count] = key;

			Array.Sort(keys);

			return keys;
		}
		
		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;reader&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static object ParseJSON(TextReader reader) {
			return ReadValue(new JSONReader(reader));
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;reader&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static JSONRpcCall ParseRPC(TextReader reader) {
			JSONRpcCall call = new JSONRpcCall();
			object obj = ParseJSON(reader);
			Hashtable jsonRpc = (Hashtable) obj;

			call.Method = (string) jsonRpc[&quot;method&quot;];
			call.Id = (string) jsonRpc[&quot;id&quot;];
			call.Args = (ArrayList) jsonRpc[&quot;params&quot;];

			return call;
		}

		#region private methods

/*		private static void Debug(string str) {
			System.Web.HttpContext.Current.Trace.Write(str);
		}*/

		private static object ReadValue(JSONReader reader) {
			Stack parents = new Stack();
			object cur = null;
			string key = null;
			object obj;

			while (reader.Read()) {
				//Debug(reader.ToString());

				switch (reader.TokenType) {
					case JSONToken.Boolean:
					case JSONToken.Integer:
					case JSONToken.String:
					case JSONToken.Float:
					case JSONToken.Null:
						if (cur is Hashtable) {
							//Debug(key + &quot;=&quot; + reader.ToString());
							((Hashtable) cur)[key] = reader.Value;
						} else if (cur is ArrayList)
							((ArrayList) cur).Add(reader.Value);
						else
							return reader.Value;

						break;

					case JSONToken.PropertyName:
						key = (string) reader.Value;
						break;

					case JSONToken.StartArray:
					case JSONToken.StartObject:
						if (reader.TokenType == JSONToken.StartObject)
							obj = new Hashtable();
						else
							obj = new ArrayList();

						if (cur is Hashtable) {
							//Debug(key + &quot;=&quot; + reader.ToString());
							((Hashtable) cur)[key] = obj;
						} else if (cur is ArrayList)
							((ArrayList) cur).Add(obj);

						parents.Push(cur);
						cur = obj;

						break;

					case JSONToken.EndArray:
					case JSONToken.EndObject:
						obj = parents.Pop();

						if (obj != null)
							cur = obj;

						break;
				}
			}

			return cur;
		}
		
		private static object ReadValue2(JSONReader jsonReader) {
			jsonReader.Read();

			switch (jsonReader.TokenType) {
				case JSONToken.Boolean:
					return (bool) jsonReader.Value;

				case JSONToken.Integer:
					return Convert.ToInt32(jsonReader.Value);

				case JSONToken.String:
					return (string) jsonReader.Value;

				case JSONToken.Float:
					return (double) jsonReader.Value;

				case JSONToken.Null:
					return null;

				case JSONToken.StartObject:
					Hashtable hash = new Hashtable();

					while (jsonReader.TokenType != JSONToken.EndObject) {
						if (jsonReader.TokenType == JSONToken.PropertyName)
							hash[jsonReader.Value] = ReadValue(jsonReader);
						else
							jsonReader.Read();
					}

					return hash;

				case JSONToken.StartArray:
					ArrayList list = new ArrayList();

					while (jsonReader.TokenType != JSONToken.EndArray) {
						if (jsonReader.TokenType == JSONToken.EndArray &amp;&amp; jsonReader.Value == null)
							break;

						list.Add(ReadValue(jsonReader));
					}

					return list;
			}

			return null;
		}

		private static bool FindNext(JSONReader reader, JSONToken token) {
			if (reader.TokenType == token)
				return true;

			while (reader.Read() &amp;&amp; reader.TokenType != JSONToken.EndObject &amp;&amp; reader.TokenType != JSONToken.EndArray) {
				if (reader.TokenType == token)
					return true;
			}

			return false;
		}

		private static bool FindNextValue(JSONReader reader) {
			switch (reader.TokenType) {
				case JSONToken.Boolean:
				case JSONToken.Float:
				case JSONToken.Integer:
				case JSONToken.Null:
				case JSONToken.String:
					return true;
			}

			while (reader.Read() &amp;&amp; reader.TokenType != JSONToken.EndObject) {
				switch (reader.TokenType) {
					case JSONToken.Boolean:
					case JSONToken.Float:
					case JSONToken.Integer:
					case JSONToken.Null:
					case JSONToken.String:
						return true;
				}
			}

			return false;
		}

		#endregion
	}

	/// &lt;summary&gt;
	/// 
	/// &lt;/summary&gt;
	public class JSONRpcCall {
		private string id, method;
		private ArrayList args;

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public JSONRpcCall() {
			this.args = new ArrayList();
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public string Method {
			get { return method; }
			set { method = value; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public string Id {
			get { return id; }
			set { id = value; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public ArrayList Args {
			get { return args; }
			set { args = value; }
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,87,21,88,0],[22,4,22,65,0],[25,4,25,30,0],[26,4,26,39,0],[27,4,27,28,0],[30,4,30,35,0],[31,4,31,26,0],[34,4,34,38,0],[35,4,35,28,0],[38,4,38,28,0],[39,4,39,19,0],[40,3,40,4,0],[47,65,47,66,0],[48,4,48,44,0],[49,4,49,19,0],[50,3,50,4,0],[52,65,52,66,0],[53,4,53,20,0],[54,5,54,24,0],[56,4,56,29,0],[57,5,57,37,0],[59,4,59,30,0],[60,5,60,35,0],[62,4,62,29,0],[63,5,63,46,0],[65,4,65,28,0],[66,5,66,45,0],[68,4,68,28,0],[69,5,69,45,0],[71,4,71,25,0],[71,26,71,27,0],[72,5,72,30,0],[74,5,74,12,0],[74,14,74,24,0],[74,25,74,27,0],[74,28,74,45,0],[75,6,75,30,0],[77,5,77,28,0],[78,4,78,5,0],[80,4,80,24,0],[80,25,80,26,0],[81,5,81,30,0],[83,5,83,12,0],[83,14,83,24,0],[83,25,83,27,0],[83,28,83,44,0],[84,6,84,30,0],[86,5,86,28,0],[87,4,87,5,0],[89,4,89,35,0],[89,36,89,37,0],[90,5,90,31,0],[92,5,92,42,0],[93,5,93,12,0],[93,14,93,24,0],[93,25,93,27,0],[93,28,93,32,0],[93,34,93,35,0],[94,6,94,36,0],[95,6,95,59,0],[96,5,96,6,0],[98,5,98,29,0],[99,4,99,5,0],[101,4,101,25,0],[101,26,101,27,0],[102,5,102,31,0],[104,5,104,42,0],[105,5,105,12,0],[105,14,105,24,0],[105,25,105,27,0],[105,28,105,32,0],[105,34,105,35,0],[106,6,106,45,0],[107,6,107,49,0],[108,5,108,6,0],[110,5,110,29,0],[111,4,111,5,0],[112,3,112,4,0],[114,55,114,56,0],[119,4,119,25,0],[120,5,120,44,0],[122,5,122,57,0],[124,4,124,32,0],[125,4,125,29,0],[127,4,127,11,0],[127,13,127,23,0],[127,24,127,26,0],[127,27,127,40,0],[128,5,128,25,0],[130,4,130,21,0],[132,4,132,16,0],[133,3,133,4,0],[140,53,140,54,0],[141,4,141,45,0],[142,3,142,4,0],[149,57,149,58,0],[150,4,150,41,0],[151,4,151,35,0],[152,4,152,40,0],[154,4,154,45,0],[155,4,155,37,0],[156,4,156,46,0],[158,4,158,16,0],[159,3,159,4,0],[167,54,167,55,0],[168,4,168,32,0],[169,4,169,22,0],[170,4,170,22,0],[173,4,173,25,0],[173,26,173,27,0],[176,5,176,30,0],[182,7,182,28,0],[182,29,182,30,0],[184,8,184,46,0],[185,7,185,8,0],[185,14,185,35,0],[186,8,186,44,0],[188,8,188,28,0],[190,7,190,13,0],[193,7,193,35,0],[194,7,194,13,0],[198,7,198,53,0],[199,8,199,30,0],[201,8,201,30,0],[203,7,203,28,0],[203,29,203,30,0],[205,8,205,37,0],[206,7,206,8,0],[206,14,206,35,0],[207,8,207,35,0],[209,7,209,25,0],[210,7,210,17,0],[212,7,212,13,0],[216,7,216,27,0],[218,7,218,23,0],[219,8,219,18,0],[221,7,221,13,0],[223,4,223,5,0],[225,4,225,15,0],[226,3,226,4,0],[228,59,228,60,0],[229,4,229,22,0],[231,4,231,33,0],[233,6,233,37,0],[236,6,236,47,0],[239,6,239,39,0],[242,6,242,39,0],[245,6,245,18,0],[248,6,248,39,0],[250,6,250,57,0],[250,58,250,59,0],[251,7,251,58,0],[252,8,252,55,0],[254,8,254,26,0],[255,6,255,7,0],[257,6,257,18,0],[260,6,260,39,0],[262,6,262,56,0],[262,57,262,58,0],[263,7,263,82,0],[264,8,264,14,0],[266,7,266,39,0],[267,6,267,7,0],[269,6,269,18,0],[272,4,272,16,0],[273,3,273,4,0],[275,68,275,69,0],[276,4,276,34,0],[277,5,277,17,0],[279,4,279,110,0],[279,111,279,112,0],[280,5,280,35,0],[281,6,281,18,0],[282,4,282,5,0],[284,4,284,17,0],[285,3,285,4,0],[287,56,287,57,0],[288,4,288,29,0],[294,6,294,18,0],[297,4,297,68,0],[297,69,297,70,0],[298,5,298,30,0],[304,7,304,19,0],[306,4,306,5,0],[308,4,308,17,0],[309,3,309,4,0],[324,3,324,23,0],[324,24,324,25,0],[325,4,325,32,0],[326,3,326,4,0],[332,8,332,9,0],[332,10,332,24,0],[332,25,332,26,0],[333,8,333,9,0],[333,10,333,25,0],[333,26,333,27,0],[340,8,340,9,0],[340,10,340,20,0],[340,21,340,22,0],[341,8,341,9,0],[341,10,341,21,0],[341,22,341,23,0],[348,8,348,9,0],[348,10,348,22,0],[348,23,348,24,0],[349,8,349,9,0],[349,10,349,23,0],[349,24,349,25,0]]);
    </script>
  </body>
</html>