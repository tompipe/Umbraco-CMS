<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\Dictionary.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Concurrent;
using System.ComponentModel;
using System.Data;
using System.Globalization;
using System.Threading;
using System.Xml;
using System.Linq;
using Umbraco.Core;
using umbraco.cms.businesslogic.language;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using umbraco.DataLayer;
using umbraco.BusinessLogic;
using System.Runtime.CompilerServices;
using Language = umbraco.cms.businesslogic.language.Language;

namespace umbraco.cms.businesslogic
{
    [Obsolete(&quot;Obsolete, Umbraco.Core.Services.ILocalizationService&quot;)]
    public class Dictionary
    {
        private static readonly Guid TopLevelParent = new Guid(Constants.Conventions.Localization.DictionaryItemRootId);

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;)]
        protected static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }
        
        /// &lt;summary&gt;
        /// Retrieve a list of toplevel DictionaryItems
        /// &lt;/summary&gt;
        public static DictionaryItem[] getTopMostItems
        {
            get
            {
                return ApplicationContext.Current.Services.LocalizationService.GetRootDictionaryItems()
                    .Select(x =&gt; new DictionaryItem(x))
                    .ToArray();
            }
        }

        /// &lt;summary&gt;
        /// A DictionaryItem is basically a key/value pair (key/language key/value) which holds the data
        /// associated to a key in various language translations
        /// &lt;/summary&gt;
        public class DictionaryItem
        {
            public DictionaryItem()
            {
                
            }

            internal DictionaryItem(IDictionaryItem item)
            {
                _dictionaryItem = item;
            }

            private readonly IDictionaryItem _dictionaryItem;
            private DictionaryItem _parent;
           
            public DictionaryItem(string key)
            {
                _dictionaryItem = ApplicationContext.Current.Services.LocalizationService.GetDictionaryItemByKey(key);

                if (_dictionaryItem == null)
                {
                    throw new ArgumentException(&quot;No key &quot; + key + &quot; exists in dictionary&quot;);
                }
            }

            public DictionaryItem(Guid id)
            {
                _dictionaryItem = ApplicationContext.Current.Services.LocalizationService.GetDictionaryItemById(id);

                if (_dictionaryItem == null)
                {
                    throw new ArgumentException(&quot;No unique id &quot; + id + &quot; exists in dictionary&quot;);
                }
            }

            public DictionaryItem(int id)
            {
                _dictionaryItem = ApplicationContext.Current.Services.LocalizationService.GetDictionaryItemById(id);

                if (_dictionaryItem == null)
                {
                    throw new ArgumentException(&quot;No id &quot; + id + &quot; exists in dictionary&quot;);
                }
            }

            [Obsolete(&quot;This is no longer used and will be removed from the codebase in future versions&quot;)]
            public bool IsTopMostItem()
            {
                return _dictionaryItem.ParentId.HasValue == false;
            }

            /// &lt;summary&gt;
            /// Returns the parent.
            /// &lt;/summary&gt;
            public DictionaryItem Parent
            {
                get
                {
                    //EnsureCache();
                    if (_parent == null &amp;&amp; _dictionaryItem.ParentId.HasValue)
                    {
                        var p = ApplicationContext.Current.Services.LocalizationService.GetDictionaryItemById(_dictionaryItem.ParentId.Value);

                        if (p == null)
                        {
                            throw new ArgumentException(&quot;Top most dictionary items doesn&#39;t have a parent&quot;);
                        }
                        else
                        {
                            _parent = new DictionaryItem(p);
                        }
                    }

                    return _parent;
                }
            }

            /// &lt;summary&gt;
            /// The primary key in the database
            /// &lt;/summary&gt;
            public int id
            {
                get { return _dictionaryItem.Id; }
            }

            public DictionaryItem[] Children
            {
                get
                {
                    return ApplicationContext.Current.Services.LocalizationService.GetDictionaryItemChildren(_dictionaryItem.Key)
                        .WhereNotNull()
                        .Select(x =&gt; new DictionaryItem(x))
                        .ToArray();
                }
            }

            public static bool hasKey(string key)
            {
                return ApplicationContext.Current.Services.LocalizationService.DictionaryItemExists(key);
            }

            public bool hasChildren
            {
                get { return Children.Any(); }
            }

            /// &lt;summary&gt;
            /// Returns or sets the key.
            /// &lt;/summary&gt;
            public string key
            {
                get { return _dictionaryItem.ItemKey; }
                set
                {
                    if (hasKey(value) == false)
                    {                        
                        _dictionaryItem.ItemKey = value;
                    }
                    else
                        throw new ArgumentException(&quot;New value of key already exists (is key)&quot;);
                }
            }

            public void setKey(string value)
            {
                key = value;
                Save();
            }

            public string Value(int languageId)
            {
                if (languageId == 0)
                    return Value();

                var translation = _dictionaryItem.Translations.FirstOrDefault(x =&gt; x.Language.Id == languageId);
                return translation == null ? string.Empty : translation.Value;
            }

            public void setValue(int languageId, string value)
            {
                ApplicationContext.Current.Services.LocalizationService.AddOrUpdateDictionaryValue(
                    _dictionaryItem,
                    ApplicationContext.Current.Services.LocalizationService.GetLanguageById(languageId),
                    value);

                Save();
            }

            /// &lt;summary&gt;
            /// Returns the default value based on the default language for this item
            /// &lt;/summary&gt;
            /// &lt;returns&gt;&lt;/returns&gt;
            public string Value()
            {
                var defaultTranslation = _dictionaryItem.Translations.FirstOrDefault(x =&gt; x.Language.Id == 1);
                return defaultTranslation == null ? string.Empty : defaultTranslation.Value;
            }

            [EditorBrowsable(EditorBrowsableState.Never)]
            [Obsolete(&quot;This is not used and should never be used, it will be removed from the codebase in future versions&quot;)]
            public void setValue(string value)
            {
                if (Item.hasText(_dictionaryItem.Key, 0))
                    Item.setText(0, _dictionaryItem.Key, value);
                else
                    Item.addText(0, _dictionaryItem.Key, value);

                Save();
            }

            public static int addKey(string key, string defaultValue, string parentKey)
            {
                //EnsureCache();

                if (hasKey(parentKey))
                {
                    int retval = CreateKey(key, new DictionaryItem(parentKey)._dictionaryItem.Key, defaultValue);
                    return retval;
                }
                else
                    throw new ArgumentException(&quot;Parentkey doesnt exist&quot;);
            }

            public static int addKey(string key, string defaultValue)
            {
                int retval = CreateKey(key, TopLevelParent, defaultValue);
                return retval;
            }

            public void delete()
            {
                OnDeleting(EventArgs.Empty);

                ApplicationContext.Current.Services.LocalizationService.Delete(_dictionaryItem);

                OnDeleted(EventArgs.Empty);
            }

            /// &lt;summary&gt;
            /// ensures events fire after setting proeprties
            /// &lt;/summary&gt;
            public void Save()
            {
                OnSaving(EventArgs.Empty);

                ApplicationContext.Current.Services.LocalizationService.Save(_dictionaryItem);
            }


            public XmlNode ToXml(XmlDocument xd)
            {
                var serializer = new EntityXmlSerializer();
                var xml = serializer.Serialize(_dictionaryItem);
                var xmlNode = xml.GetXmlNode(xd);
                if (this.hasChildren)
                {
                    foreach (var di in this.Children)
                    {
                        xmlNode.AppendChild(di.ToXml(xd));
                    }
                }
                return xmlNode;
            }

            public static DictionaryItem Import(XmlNode xmlData)
            {
                return Import(xmlData, null);
            }

            public static DictionaryItem Import(XmlNode xmlData, DictionaryItem parent)
            {
                string key = xmlData.Attributes[&quot;Key&quot;].Value;

                XmlNodeList values = xmlData.SelectNodes(&quot;./Value&quot;);
                XmlNodeList childItems = xmlData.SelectNodes(&quot;./DictionaryItem&quot;);
                DictionaryItem newItem;
                bool retVal = false;

                if (!hasKey(key))
                {
                    if (parent != null)
                        addKey(key, &quot; &quot;, parent.key);
                    else
                        addKey(key, &quot; &quot;);

                    if (values.Count &gt; 0)
                    {
                        //Set language values on the dictionary item
                        newItem = new DictionaryItem(key);
                        foreach (XmlNode xn in values)
                        {
                            string cA = xn.Attributes[&quot;LanguageCultureAlias&quot;].Value;
                            string keyValue = xmlHelper.GetNodeValue(xn);

                            Language valueLang = Language.GetByCultureCode(cA);

                            if (valueLang != null)
                            {
                                newItem.setValue(valueLang.id, keyValue);
                            }
                        }
                    }

                    if (parent == null)
                        retVal = true;
                }

                newItem = new DictionaryItem(key);

                foreach (XmlNode childItem in childItems)
                {
                    Import(childItem, newItem);
                }

                if (retVal)
                    return newItem;
                else
                    return null;
            }

            private static int CreateKey(string key, Guid parentId, string defaultValue)
            {
                if (!hasKey(key))
                {
                    var item = ApplicationContext.Current.Services.LocalizationService.CreateDictionaryItemWithIdentity(
                        key,
                        parentId == TopLevelParent ? (Guid?)null : parentId, 
                        defaultValue);

                    return item.Id;
                }
                else
                {
                    throw new ArgumentException(&quot;Key being added already exists!&quot;);
                }
            }

            #region Events
            public delegate void SaveEventHandler(DictionaryItem sender, EventArgs e);
            public delegate void NewEventHandler(DictionaryItem sender, EventArgs e);
            public delegate void DeleteEventHandler(DictionaryItem sender, EventArgs e);

            public static event SaveEventHandler Saving;
            protected virtual void OnSaving(EventArgs e)
            {
                if (Saving != null)
                    Saving(this, e);
            }

            public static event NewEventHandler New;
            protected virtual void OnNew(EventArgs e)
            {
                if (New != null)
                    New(this, e);
            }

            public static event DeleteEventHandler Deleting;
            protected virtual void OnDeleting(EventArgs e)
            {
                if (Deleting != null)
                    Deleting(this, e);
            }

            public static event DeleteEventHandler Deleted;
            protected virtual void OnDeleted(EventArgs e)
            {
                if (Deleted != null)
                    Deleted(this, e);
            }
            #endregion
        }

        // zb023 - utility method
        public static string ReplaceKey(string text)
        {
            if (text.StartsWith(&quot;#&quot;) == false)
                return text;

            var lang = Language.GetByCultureCode(Thread.CurrentThread.CurrentCulture.Name);

            if (lang == null)
                return &quot;[&quot; + text + &quot;]&quot;;

            if (DictionaryItem.hasKey(text.Substring(1, text.Length - 1)) == false)
                return &quot;[&quot; + text + &quot;]&quot;;

            var di = new DictionaryItem(text.Substring(1, text.Length - 1));
            return di.Value(lang.id);
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,121,0],[32,17,32,18,0],[32,19,32,48,0],[32,49,32,50,0],[41,13,41,14,0],[42,17,43,34,0],[43,34,43,55,0],[43,55,44,32,0],[42,17,44,32,0],[45,13,45,14,0],[54,13,54,36,0],[55,13,55,14,0],[57,13,57,14,0],[59,13,59,58,0],[60,13,60,14,0],[61,17,61,40,0],[62,13,62,14,0],[67,13,67,46,0],[68,13,68,14,0],[69,17,69,119,0],[71,17,71,45,0],[72,17,72,18,0],[73,21,73,92,0],[75,13,75,14,0],[77,13,77,43,0],[78,13,78,14,0],[79,17,79,117,0],[81,17,81,45,0],[82,17,82,18,0],[83,21,83,97,0],[85,13,85,14,0],[87,13,87,42,0],[88,13,88,14,0],[89,17,89,117,0],[91,17,91,45,0],[92,17,92,18,0],[93,21,93,90,0],[95,13,95,14,0],[99,13,99,14,0],[100,17,100,67,0],[101,13,101,14,0],[109,17,109,18,0],[111,21,111,78,0],[112,21,112,22,0],[113,25,113,143,0],[115,25,115,39,0],[116,25,116,26,0],[117,29,117,108,0],[120,25,120,26,0],[121,29,121,61,0],[122,25,122,26,0],[123,21,123,22,0],[125,21,125,36,0],[126,17,126,18,0],[134,21,134,22,0],[134,23,134,49,0],[134,50,134,51,0],[140,17,140,18,0],[141,21,143,38,0],[143,38,143,59,0],[143,59,144,36,0],[141,21,144,36,0],[145,17,145,18,0],[149,13,149,14,0],[150,17,150,106,0],[151,13,151,14,0],[155,21,155,22,0],[155,23,155,45,0],[155,46,155,47,0],[163,21,163,22,0],[163,23,163,54,0],[163,55,163,56,0],[165,17,165,18,0],[166,21,166,48,0],[167,21,167,22,0],[168,25,168,57,0],[169,21,169,22,0],[171,25,171,97,0],[172,17,172,18,0],[176,13,176,14,0],[177,17,177,29,0],[178,17,178,24,0],[179,13,179,14,0],[182,13,182,14,0],[183,17,183,37,0],[184,21,184,36,0],[186,17,186,84,0],[186,84,186,111,0],[186,111,186,113,0],[186,17,186,113,0],[187,17,187,79,0],[188,13,188,14,0],[191,13,191,14,0],[192,17,195,28,0],[197,17,197,24,0],[198,13,198,14,0],[205,13,205,14,0],[206,17,206,91,0],[206,91,206,109,0],[206,109,206,111,0],[206,17,206,111,0],[207,17,207,93,0],[208,13,208,14,0],[213,13,213,14,0],[214,17,214,58,0],[215,21,215,65,0],[217,21,217,65,0],[219,17,219,24,0],[220,13,220,14,0],[223,13,223,14,0],[226,17,226,39,0],[227,17,227,18,0],[228,21,228,114,0],[229,21,229,35,0],[232,21,232,75,0],[233,13,233,14,0],[236,13,236,14,0],[237,17,237,75,0],[238,17,238,31,0],[239,13,239,14,0],[242,13,242,14,0],[243,17,243,45,0],[245,17,245,97,0],[247,17,247,44,0],[248,13,248,14,0],[254,13,254,14,0],[255,17,255,43,0],[257,17,257,95,0],[258,13,258,14,0],[262,13,262,14,0],[263,17,263,60,0],[264,17,264,65,0],[265,17,265,50,0],[266,17,266,38,0],[267,17,267,18,0],[268,21,268,28,0],[268,30,268,36,0],[268,37,268,39,0],[268,40,268,53,0],[269,21,269,22,0],[270,25,270,59,0],[271,21,271,22,0],[272,17,272,18,0],[273,17,273,32,0],[274,13,274,14,0],[277,13,277,14,0],[278,17,278,46,0],[279,13,279,14,0],[282,13,282,14,0],[283,17,283,62,0],[285,17,285,69,0],[286,17,286,82,0],[288,17,288,37,0],[290,17,290,34,0],[291,17,291,18,0],[292,21,292,40,0],[293,25,293,54,0],[295,25,295,42,0],[297,21,297,42,0],[298,21,298,22,0],[300,25,300,59,0],[301,25,301,32,0],[301,34,301,44,0],[301,45,301,47,0],[301,48,301,54,0],[302,25,302,26,0],[303,29,303,85,0],[304,29,304,74,0],[306,29,306,80,0],[308,29,308,51,0],[309,29,309,30,0],[310,33,310,74,0],[311,29,311,30,0],[312,25,312,26,0],[313,21,313,22,0],[315,21,315,40,0],[316,25,316,39,0],[317,17,317,18,0],[319,17,319,51,0],[321,17,321,24,0],[321,26,321,43,0],[321,44,321,46,0],[321,47,321,57,0],[322,17,322,18,0],[323,21,323,48,0],[324,17,324,18,0],[326,17,326,28,0],[327,21,327,36,0],[329,21,329,33,0],[330,13,330,14,0],[333,13,333,14,0],[334,17,334,34,0],[335,17,335,18,0],[336,21,339,39,0],[341,21,341,36,0],[344,17,344,18,0],[345,21,345,84,0],[347,13,347,14,0],[356,13,356,14,0],[357,17,357,36,0],[358,21,358,37,0],[359,13,359,14,0],[363,13,363,14,0],[364,17,364,33,0],[365,21,365,34,0],[366,13,366,14,0],[370,13,370,14,0],[371,17,371,38,0],[372,21,372,39,0],[373,13,373,14,0],[377,13,377,14,0],[378,17,378,37,0],[379,21,379,38,0],[380,13,380,14,0],[386,9,386,10,0],[387,13,387,47,0],[388,17,388,29,0],[390,13,390,92,0],[392,13,392,30,0],[393,17,393,41,0],[395,13,395,84,0],[396,17,396,41,0],[398,13,398,77,0],[399,13,399,38,0],[400,9,400,10,0]]);
    </script>
  </body>
</html>