<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Web\Mvc\RenderIndexActionSelectorAttributeTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Reflection;
using System.Threading.Tasks;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Logging;
using Umbraco.Core.Profiling;
using Umbraco.Web;
using Umbraco.Web.Models;
using Umbraco.Web.Mvc;
using Umbraco.Web.Routing;
using Umbraco.Web.Security;

namespace Umbraco.Tests.Web.Mvc
{
    [TestFixture]
    public class RenderIndexActionSelectorAttributeTests
    {
        private MethodInfo GetRenderMvcControllerIndexMethodFromCurrentType(Type currType)
        {
            return currType.GetMethods().Single(x =&gt;
            {
                if (x.Name != &quot;Index&quot;) return false;
                if (x.ReturnParameter == null || x.ReturnParameter.ParameterType != typeof (ActionResult)) return false;
                var p = x.GetParameters();
                if (p.Length != 1) return false;
                if (p[0].ParameterType != typeof (RenderModel)) return false;
                return true;
            });
        }

        [Test]
        public void Matches_Default_Index()
        {
            var attr = new RenderIndexActionSelectorAttribute();
            var req = new RequestContext();
            var appCtx = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            var umbCtx = UmbracoContext.EnsureContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);
            var ctrl = new MatchesDefaultIndexController(umbCtx);
            var controllerCtx = new ControllerContext(req, ctrl);
            var result = attr.IsValidForRequest(controllerCtx,
                GetRenderMvcControllerIndexMethodFromCurrentType(ctrl.GetType()));

            Assert.IsTrue(result);
        }

        [Test]
        public void Matches_Overriden_Index()
        {
            var attr = new RenderIndexActionSelectorAttribute();
            var req = new RequestContext();
            var appCtx = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            var umbCtx = UmbracoContext.EnsureContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);
            var ctrl = new MatchesOverriddenIndexController(umbCtx);
            var controllerCtx = new ControllerContext(req, ctrl);
            var result = attr.IsValidForRequest(controllerCtx,
                GetRenderMvcControllerIndexMethodFromCurrentType(ctrl.GetType()));

            Assert.IsTrue(result);
        }

        [Test]
        public void Matches_Custom_Index()
        {
            var attr = new RenderIndexActionSelectorAttribute();
            var req = new RequestContext();
            var appCtx = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            var umbCtx = UmbracoContext.EnsureContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);
            var ctrl = new MatchesCustomIndexController(umbCtx);
            var controllerCtx = new ControllerContext(req, ctrl);
            var result = attr.IsValidForRequest(controllerCtx,
                GetRenderMvcControllerIndexMethodFromCurrentType(ctrl.GetType()));

            Assert.IsFalse(result);
        }

        [Test]
        public void Matches_Async_Index_Same_Signature()
        {
            var attr = new RenderIndexActionSelectorAttribute();
            var req = new RequestContext();
            var appCtx = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            var umbCtx = UmbracoContext.EnsureContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);
            var ctrl = new MatchesAsyncIndexController(umbCtx);
            var controllerCtx = new ControllerContext(req, ctrl);
            var result = attr.IsValidForRequest(controllerCtx,
                GetRenderMvcControllerIndexMethodFromCurrentType(ctrl.GetType()));

            Assert.IsFalse(result);
        }

        public class MatchesDefaultIndexController : RenderMvcController
        {
            public MatchesDefaultIndexController(UmbracoContext umbracoContext) : base(umbracoContext)
            {
            }
        }

        public class MatchesOverriddenIndexController : RenderMvcController
        {
            public MatchesOverriddenIndexController(UmbracoContext umbracoContext) : base(umbracoContext)
            {
            }
            
            public override ActionResult Index(RenderModel model)
            {
                return base.Index(model);
            }
        }

        public class MatchesCustomIndexController : RenderMvcController
        {
            public MatchesCustomIndexController(UmbracoContext umbracoContext) : base(umbracoContext)
            {
            }

            public ActionResult Index(RenderModel model, int page)
            {
                return base.Index(model);
            }
        }

        public class MatchesAsyncIndexController : RenderMvcController
        {
            public MatchesAsyncIndexController(UmbracoContext umbracoContext) : base(umbracoContext)
            {
            }

            public new async Task&lt;ActionResult&gt; Index(RenderModel model)
            {
                return await Task.FromResult(base.Index(model));
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,1],[27,13,28,13,1],[28,13,28,14,1],[28,14,29,17,1],[29,17,29,39,1],[29,39,29,40,1],[29,40,29,53,1],[29,53,30,17,1],[30,17,30,107,1],[30,107,30,108,1],[30,108,30,121,1],[30,121,31,17,1],[31,17,31,43,1],[31,43,32,17,1],[32,17,32,35,1],[32,35,32,36,1],[32,36,32,49,1],[32,49,33,17,1],[33,17,33,64,1],[33,64,33,65,1],[33,65,33,78,0],[33,78,34,17,1],[34,17,34,29,1],[34,29,35,13,1],[35,13,35,14,1],[35,14,35,16,1],[27,13,35,16,1],[36,9,36,10,1],[40,9,40,10,1],[41,13,41,65,1],[42,13,42,44,1],[43,13,45,80,1],[46,13,52,23,1],[53,13,53,66,1],[54,13,54,66,1],[55,13,56,83,1],[58,13,58,35,1],[59,9,59,10,1],[63,9,63,10,1],[64,13,64,65,1],[65,13,65,44,1],[66,13,68,80,1],[69,13,75,23,1],[76,13,76,69,1],[77,13,77,66,1],[78,13,79,83,1],[81,13,81,35,1],[82,9,82,10,1],[86,9,86,10,1],[87,13,87,65,1],[88,13,88,44,1],[89,13,91,80,1],[92,13,98,23,1],[99,13,99,65,1],[100,13,100,66,1],[101,13,102,83,1],[104,13,104,36,1],[105,9,105,10,1],[109,9,109,10,1],[110,13,110,65,1],[111,13,111,44,1],[112,13,114,80,1],[115,13,121,23,1],[122,13,122,64,1],[123,13,123,66,1],[124,13,125,83,1],[127,13,127,36,1],[128,9,128,10,1],[132,83,132,103,1],[133,13,133,14,1],[134,13,134,14,1],[139,86,139,106,1],[140,13,140,14,1],[141,13,141,14,1],[144,13,144,14,0],[145,17,145,42,0],[146,13,146,14,0],[151,82,151,102,1],[152,13,152,14,1],[153,13,153,14,1],[156,13,156,14,0],[157,17,157,42,0],[158,13,158,14,0],[163,81,163,101,1],[164,13,164,14,1],[165,13,165,14,1],[168,13,168,14,0],[169,17,169,65,0],[170,13,170,14,0]]);
    </script>
  </body>
</html>