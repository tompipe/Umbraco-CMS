<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\PartialViewRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence.Repositories
{
    internal class PartialViewRepository : FileRepository&lt;string, IPartialView&gt;, IPartialViewRepository
    {
        public PartialViewRepository(IUnitOfWork work)
			: this(work, new PhysicalFileSystem(SystemDirectories.MvcViews + &quot;/Partials/&quot;))
        {
        }

        public PartialViewRepository(IUnitOfWork work, IFileSystem fileSystem) : base(work, fileSystem)
        {
        }

        protected virtual PartialViewType ViewType { get { return PartialViewType.PartialView; } }

        public override IPartialView Get(string id)
        {
            // get the relative path within the filesystem
            // (though... id should be relative already)
            var path = FileSystem.GetRelativePath(id);

            if (FileSystem.FileExists(path) == false)
                return null;

            // content will be lazy-loaded when required
            var created = FileSystem.GetCreated(path).UtcDateTime;
            var updated = FileSystem.GetLastModified(path).UtcDateTime;
            //var content = GetFileContent(path);

            var view = new PartialView(path, file =&gt; GetFileContent(file.OriginalPath))
            {
                //id can be the hash
                Id = path.GetHashCode(),
                Key = path.EncodeAsGuid(),
                //Content = content,
                CreateDate = created,
                UpdateDate = updated,
                VirtualPath = FileSystem.GetUrl(id),
                ViewType = ViewType
            };

            //on initial construction we don&#39;t want to have dirty properties tracked
            // http://issues.umbraco.org/issue/U4-1946
            view.ResetDirtyProperties(false);

            return view;
        }

        public override void AddOrUpdate(IPartialView entity)
        {
            var partialView = entity as PartialView;
            if (partialView != null)
                partialView.ViewType = ViewType;

            base.AddOrUpdate(entity);

            // ensure that from now on, content is lazy-loaded
            if (partialView != null &amp;&amp; partialView.GetFileContent == null)
                partialView.GetFileContent = file =&gt; GetFileContent(file.OriginalPath);
        }

        public override IEnumerable&lt;IPartialView&gt; GetAll(params string[] ids)
        {
            //ensure they are de-duplicated, easy win if people don&#39;t do this as this can cause many excess queries
            ids = ids.Distinct().ToArray();

            if (ids.Any())
            {
                foreach (var id in ids)
                {
                    yield return Get(id);
                }
            }
            else
            {
                var files = FindAllFiles(&quot;&quot;, &quot;*.*&quot;);
                foreach (var file in files)
                {
                    yield return Get(file);
                }
            }
        }

        private static readonly List&lt;string&gt; ValidExtensions = new List&lt;string&gt; { &quot;cshtml&quot; };

        public virtual bool ValidatePartialView(IPartialView partialView)
        {
            // get full path
            string fullPath;
            try
            {
                // may throw for security reasons
                fullPath = FileSystem.GetFullPath(partialView.Path);
            }
            catch
            {
                return false;
            }

            // validate path &amp; extension
            var validDir = SystemDirectories.MvcViews;
            var isValidPath = IOHelper.VerifyEditPath(fullPath, validDir);
            var isValidExtension = IOHelper.VerifyFileExtension(fullPath, ValidExtensions);
            return isValidPath &amp;&amp; isValidExtension;
        }

        /// &lt;summary&gt;
        /// Gets a stream that is used to write to the file
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;content&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// This ensures the stream includes a utf8 BOM
        /// &lt;/remarks&gt;
        protected override Stream GetContentStream(string content)
        {
            var data = Encoding.UTF8.GetBytes(content);
            var withBom = Encoding.UTF8.GetPreamble().Concat(data).ToArray();
            return new MemoryStream(withBom);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,6,15,83,0],[16,9,16,10,0],[17,9,17,10,0],[19,82,19,104,1],[20,9,20,10,1],[21,9,21,10,1],[23,58,23,59,1],[23,60,23,95,1],[23,96,23,97,1],[26,9,26,10,1],[29,13,29,55,1],[31,13,31,54,1],[32,17,32,29,1],[35,13,35,67,1],[36,13,36,72,1],[39,13,39,54,1],[39,54,39,87,0],[39,87,49,15,1],[39,13,49,15,1],[53,13,53,46,1],[55,13,55,25,1],[56,9,56,10,1],[59,9,59,10,1],[60,13,60,53,1],[61,13,61,37,1],[62,17,62,49,1],[64,13,64,38,1],[67,13,67,75,1],[68,17,68,54,1],[68,54,68,87,0],[68,87,68,88,1],[68,17,68,88,1],[69,9,69,10,1],[93,9,93,94,1],[96,9,96,10,0],[100,13,100,14,0],[102,17,102,69,0],[103,13,103,14,0],[104,13,104,18,0],[105,13,105,14,0],[106,17,106,30,0],[110,13,110,55,0],[111,13,111,75,0],[112,13,112,92,0],[113,13,113,52,0],[114,9,114,10,0],[125,9,125,10,1],[126,13,126,56,1],[127,13,127,78,1],[128,13,128,46,1],[129,9,129,10,1]]);
    </script>
  </body>
</html>