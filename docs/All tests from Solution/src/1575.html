<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Security\AuthenticationExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.ComponentModel;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Security.Claims;
using System.Security.Principal;
using System.Threading;
using System.Web;
using System.Web.Security;
using AutoMapper;
using Microsoft.Owin;
using Newtonsoft.Json;
using Umbraco.Core.Configuration;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Logging;

namespace Umbraco.Core.Security
{
    /// &lt;summary&gt;
    /// Extensions to create and renew and remove authentication tickets for the Umbraco back office
    /// &lt;/summary&gt;
    public static class AuthenticationExtensions
    {
        /// &lt;summary&gt;
        /// This will check the ticket to see if it is valid, if it is it will set the current thread&#39;s user and culture
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;ticket&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;renewTicket&quot;&gt;If true will attempt to renew the ticket&lt;/param&gt;
        public static bool AuthenticateCurrentRequest(this HttpContextBase http, FormsAuthenticationTicket ticket, bool renewTicket)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);

            //if there was a ticket, it&#39;s not expired, - it should not be renewed or its renewable
            if (ticket != null &amp;&amp; ticket.Expired == false &amp;&amp; (renewTicket == false || http.RenewUmbracoAuthTicket()))
            {
                try
                {
                    //create the Umbraco user identity 
                    var identity = new UmbracoBackOfficeIdentity(ticket);

                    //set the principal object
                    var principal = new GenericPrincipal(identity, identity.Roles);

                    //It is actually not good enough to set this on the current app Context and the thread, it also needs
                    // to be set explicitly on the HttpContext.Current !! This is a strange web api thing that is actually 
                    // an underlying fault of asp.net not propogating the User correctly.
                    if (HttpContext.Current != null)
                    {
                        HttpContext.Current.User = principal;
                    }
                    http.User = principal;
                    Thread.CurrentPrincipal = principal;

                    //This is a back office request, we will also set the culture/ui culture
                    Thread.CurrentThread.CurrentCulture =
                        Thread.CurrentThread.CurrentUICulture =
                        new System.Globalization.CultureInfo(identity.Culture);

                    return true;
                }
                catch (Exception ex)
                {
                    if (ex is FormatException || ex is JsonReaderException)
                    {
                        //this will occur if the cookie data is invalid
                        http.UmbracoLogout();
                    }
                    else
                    {
                        throw;
                    }

                }
            }

            return false;
        }


        /// &lt;summary&gt;
        /// This will return the current back office identity. 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;authenticateRequestIfNotFound&quot;&gt; 
        /// If set to true and a back office identity is not found and not authenticated, this will attempt to authenticate the 
        /// request just as is done in the Umbraco module and then set the current identity if it is valid.
        /// Just like in the UmbracoModule, if this is true then the user&#39;s culture will be assigned to the request.
        /// &lt;/param&gt;
        /// &lt;returns&gt;
        /// Returns the current back office identity if an admin is authenticated otherwise null
        /// &lt;/returns&gt;
        public static UmbracoBackOfficeIdentity GetCurrentIdentity(this HttpContextBase http, bool authenticateRequestIfNotFound)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            if (http.User == null) return null; //there&#39;s no user at all so no identity

            //If it&#39;s already a UmbracoBackOfficeIdentity
            var backOfficeIdentity = http.User.Identity as UmbracoBackOfficeIdentity;
            if (backOfficeIdentity != null) return backOfficeIdentity;

            //Check if there&#39;s more than one identity assigned and see if it&#39;s a UmbracoBackOfficeIdentity and use that
            var claimsPrincipal = http.User as ClaimsPrincipal;
            if (claimsPrincipal != null)
            {
                backOfficeIdentity = claimsPrincipal.Identities.OfType&lt;UmbracoBackOfficeIdentity&gt;().FirstOrDefault();
                if (backOfficeIdentity != null) return backOfficeIdentity;
            }

            //Otherwise convert to a UmbracoBackOfficeIdentity if it&#39;s auth&#39;d and has the back office session            
            var claimsIdentity = http.User.Identity as ClaimsIdentity;
            if (claimsIdentity != null &amp;&amp; claimsIdentity.IsAuthenticated &amp;&amp; claimsIdentity.HasClaim(x =&gt; x.Type == Constants.Security.SessionIdClaimType))
            {                 
                try
                {
                    return UmbracoBackOfficeIdentity.FromClaimsIdentity(claimsIdentity);
                }
                catch (InvalidOperationException ex)
                {
                    //This will occur if the required claim types are missing which would mean something strange is going on
                    LogHelper.Error(typeof(AuthenticationExtensions), &quot;The current identity cannot be converted to &quot; + typeof(UmbracoBackOfficeIdentity), ex);
                }
            }

            if (authenticateRequestIfNotFound == false) return null;

            //even if authenticateRequestIfNotFound is true we cannot continue if the request is actually authenticated 
            // which would mean something strange is going on that it is not an umbraco identity.
            if (http.User.Identity.IsAuthenticated) return null;

            //So the user is not authed but we&#39;ve been asked to do the auth if authenticateRequestIfNotFound = true,
            // which might occur in old webforms style things or for routes that aren&#39;t included as a back office request.
            // in this case, we are just reverting to authing using the cookie.
            
            // TODO: Even though this is in theory legacy, we have legacy bits laying around and we&#39;d need to do the auth based on 
            // how the Module will eventually do it (by calling in to any registered authenticators).
            
            var ticket = http.GetUmbracoAuthTicket();
            if (http.AuthenticateCurrentRequest(ticket, true))
            {
                //now we &#39;should have an umbraco identity
                return http.User.Identity as UmbracoBackOfficeIdentity;
            }
            return null;
        }

        /// &lt;summary&gt;
        /// This will return the current back office identity. 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;authenticateRequestIfNotFound&quot;&gt;
        /// If set to true and a back office identity is not found and not authenticated, this will attempt to authenticate the 
        /// request just as is done in the Umbraco module and then set the current identity if it is valid
        /// &lt;/param&gt;
        /// &lt;returns&gt;
        /// Returns the current back office identity if an admin is authenticated otherwise null
        /// &lt;/returns&gt;
        internal static UmbracoBackOfficeIdentity GetCurrentIdentity(this HttpContext http, bool authenticateRequestIfNotFound)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            return new HttpContextWrapper(http).GetCurrentIdentity(authenticateRequestIfNotFound);
        }

        public static void UmbracoLogout(this HttpContextBase http)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            Logout(http, UmbracoConfig.For.UmbracoSettings().Security.AuthCookieName);
        }

        /// &lt;summary&gt;
        /// This clears the forms authentication cookie for webapi since cookies are handled differently
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;response&quot;&gt;&lt;/param&gt;
        [Obsolete(&quot;Use OWIN IAuthenticationManager.SignOut instead&quot;, true)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public static void UmbracoLogoutWebApi(this HttpResponseMessage response)
        {
            throw new NotSupportedException(&quot;This method is not supported and should not be used, it has been removed in Umbraco 7.4&quot;);
        }

        [Obsolete(&quot;Use WebSecurity.SetPrincipalForRequest&quot;, true)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public static FormsAuthenticationTicket UmbracoLoginWebApi(this HttpResponseMessage response, IUser user)
        {
            throw new NotSupportedException(&quot;This method is not supported and should not be used, it has been removed in Umbraco 7.4&quot;);            
        }

        /// &lt;summary&gt;
        /// This clears the forms authentication cookie
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        internal static void UmbracoLogout(this HttpContext http)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            new HttpContextWrapper(http).UmbracoLogout();
        }
        
        /// &lt;summary&gt;
        /// This will force ticket renewal in the OWIN pipeline
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static bool RenewUmbracoAuthTicket(this HttpContextBase http)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            http.Items[&quot;umbraco-force-auth&quot;] = true;
            return true;
        }

        /// &lt;summary&gt;
        /// This will force ticket renewal in the OWIN pipeline
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal static bool RenewUmbracoAuthTicket(this HttpContext http)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            http.Items[&quot;umbraco-force-auth&quot;] = true;
            return true;
        }

        /// &lt;summary&gt;
        /// Creates the umbraco authentication ticket
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;userdata&quot;&gt;&lt;/param&gt;
        public static FormsAuthenticationTicket CreateUmbracoAuthTicket(this HttpContextBase http, UserData userdata)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            if (userdata == null) throw new ArgumentNullException(&quot;userdata&quot;);
            var userDataString = JsonConvert.SerializeObject(userdata);
            return CreateAuthTicketAndCookie(
                http, 
                userdata.Username, 
                userDataString, 
                //use the configuration timeout - this is the same timeout that will be used when renewing the ticket.
                GlobalSettings.TimeOutInMinutes, 
                //Umbraco has always persisted it&#39;s original cookie for 1 day so we&#39;ll keep it that way
                1440, 
                UmbracoConfig.For.UmbracoSettings().Security.AuthCookieName,
                UmbracoConfig.For.UmbracoSettings().Security.AuthCookieDomain);
        }

        internal static FormsAuthenticationTicket CreateUmbracoAuthTicket(this HttpContext http, UserData userdata)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            if (userdata == null) throw new ArgumentNullException(&quot;userdata&quot;);
            return new HttpContextWrapper(http).CreateUmbracoAuthTicket(userdata);
        }

        /// &lt;summary&gt;
        /// returns the number of seconds the user has until their auth session times out
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static double GetRemainingAuthSeconds(this HttpContextBase http)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            var ticket = http.GetUmbracoAuthTicket();
            return ticket.GetRemainingAuthSeconds();
        }

        /// &lt;summary&gt;
        /// returns the number of seconds the user has until their auth session times out
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ticket&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static double GetRemainingAuthSeconds(this FormsAuthenticationTicket ticket)
        {
            if (ticket == null)
            {
                return 0;
            }
            var utcExpired = ticket.Expiration.ToUniversalTime();
            var secondsRemaining = utcExpired.Subtract(DateTime.UtcNow).TotalSeconds;
            return secondsRemaining;
        }

        /// &lt;summary&gt;
        /// Gets the umbraco auth ticket
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static FormsAuthenticationTicket GetUmbracoAuthTicket(this HttpContextBase http)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            return GetAuthTicket(http, UmbracoConfig.For.UmbracoSettings().Security.AuthCookieName);
        }

        internal static FormsAuthenticationTicket GetUmbracoAuthTicket(this HttpContext http)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            return new HttpContextWrapper(http).GetUmbracoAuthTicket();
        }

        internal static FormsAuthenticationTicket GetUmbracoAuthTicket(this IOwinContext ctx)
        {
            if (ctx == null) throw new ArgumentNullException(&quot;ctx&quot;);
            //get the ticket
            try
            {
                return GetAuthTicket(ctx.Request.Cookies.ToDictionary(x =&gt; x.Key, x =&gt; x.Value), UmbracoConfig.For.UmbracoSettings().Security.AuthCookieName);
            }
            catch (Exception)
            {
                ctx.Authentication.SignOut(
                    Constants.Security.BackOfficeAuthenticationType,
                    Constants.Security.BackOfficeExternalAuthenticationType);
                return null;
            }
        }

        /// &lt;summary&gt;
        /// This clears the forms authentication cookie
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cookieName&quot;&gt;&lt;/param&gt;
        private static void Logout(this HttpContextBase http, string cookieName)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            //clear the preview cookie and external login
            var cookies = new[] { cookieName, Constants.Web.PreviewCookieName, Constants.Security.BackOfficeExternalCookieName };
            foreach (var c in cookies)
            {
                //remove from the request
                http.Request.Cookies.Remove(c);

                //expire from the response
                var formsCookie = http.Response.Cookies[c];
                if (formsCookie != null)
                {
                    //this will expire immediately and be removed from the browser
                    formsCookie.Expires = DateTime.Now.AddYears(-1);
                }
                else
                {
                    //ensure there&#39;s def an expired cookie
                    http.Response.Cookies.Add(new HttpCookie(c) { Expires = DateTime.Now.AddYears(-1) });
                }               
            }
        }

        private static FormsAuthenticationTicket GetAuthTicket(this HttpContextBase http, string cookieName)
        {
            var asDictionary = new Dictionary&lt;string, string&gt;();
            for (var i = 0; i &lt; http.Request.Cookies.Keys.Count; i++)
            {
                var key = http.Request.Cookies.Keys.Get(i);
                asDictionary[key] = http.Request.Cookies[key].Value;
            }

            //get the ticket
            try
            {

                return GetAuthTicket(asDictionary, cookieName);
            }
            catch (Exception)
            {
                //occurs when decryption fails
                http.Logout(cookieName);
                return null;
            }
        }

        private static FormsAuthenticationTicket GetAuthTicket(IDictionary&lt;string, string&gt; cookies, string cookieName)
        {
            if (cookies == null) throw new ArgumentNullException(&quot;cookies&quot;);

            if (cookies.ContainsKey(cookieName) == false) return null;

            var formsCookie = cookies[cookieName];
            if (formsCookie == null)
            {
                return null;
            }
            //get the ticket
            return FormsAuthentication.Decrypt(formsCookie);
        }

        /// &lt;summary&gt;
        /// Creates a custom FormsAuthentication ticket with the data specified
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;http&quot;&gt;The HTTP.&lt;/param&gt;
        /// &lt;param name=&quot;username&quot;&gt;The username.&lt;/param&gt;
        /// &lt;param name=&quot;userData&quot;&gt;The user data.&lt;/param&gt;
        /// &lt;param name=&quot;loginTimeoutMins&quot;&gt;The login timeout mins.&lt;/param&gt;
        /// &lt;param name=&quot;minutesPersisted&quot;&gt;The minutes persisted.&lt;/param&gt;
        /// &lt;param name=&quot;cookieName&quot;&gt;Name of the cookie.&lt;/param&gt;
        /// &lt;param name=&quot;cookieDomain&quot;&gt;The cookie domain.&lt;/param&gt;
        private static FormsAuthenticationTicket CreateAuthTicketAndCookie(this HttpContextBase http,
                                            string username,
                                            string userData,
                                            int loginTimeoutMins,
                                            int minutesPersisted,
                                            string cookieName,
                                            string cookieDomain)
        {
            if (http == null) throw new ArgumentNullException(&quot;http&quot;);
            // Create a new ticket used for authentication
            var ticket = new FormsAuthenticationTicket(
                4,
                username,
                DateTime.Now,
                DateTime.Now.AddMinutes(loginTimeoutMins),
                true,
                userData,
                &quot;/&quot;
                );
	
            // Encrypt the cookie using the machine key for secure transport
            var hash = FormsAuthentication.Encrypt(ticket);
            var cookie = new HttpCookie(
                cookieName,
                hash)
                {
                    Expires = DateTime.Now.AddMinutes(minutesPersisted),
                    Domain = cookieDomain,
                    Path = &quot;/&quot;
                };

			if (GlobalSettings.UseSSL)
                cookie.Secure = true;

            //ensure http only, this should only be able to be accessed via the server
            cookie.HttpOnly = true;
				
            http.Response.Cookies.Set(cookie);

            return ticket;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[35,9,35,10,0],[36,13,36,30,0],[36,31,36,71,0],[39,13,39,118,0],[40,13,40,14,0],[42,17,42,18,0],[44,21,44,74,0],[47,21,47,84,0],[52,21,52,53,0],[53,21,53,22,0],[54,25,54,62,0],[55,21,55,22,0],[56,21,56,43,0],[57,21,57,57,0],[60,21,62,80,0],[64,21,64,33,0],[66,17,66,37,0],[67,17,67,18,0],[68,21,68,76,0],[69,21,69,22,0],[71,25,71,46,0],[72,21,72,22,0],[74,21,74,22,0],[75,25,75,31,0],[78,17,78,18,0],[79,13,79,14,0],[81,13,81,26,0],[82,9,82,10,0],[98,9,98,10,0],[99,13,99,30,0],[99,31,99,71,0],[100,13,100,35,0],[100,36,100,48,0],[103,13,103,86,0],[104,13,104,44,0],[104,45,104,71,0],[107,13,107,64,0],[108,13,108,41,0],[109,13,109,14,0],[110,17,110,118,0],[111,17,111,48,0],[111,49,111,75,0],[112,13,112,14,0],[115,13,115,71,0],[116,13,116,106,0],[116,106,116,153,0],[116,153,116,155,0],[116,13,116,155,0],[117,13,117,14,0],[119,17,119,18,0],[120,21,120,89,0],[122,17,122,53,0],[123,17,123,18,0],[125,21,125,159,0],[126,17,126,18,0],[127,13,127,14,0],[129,13,129,56,0],[129,57,129,69,0],[133,13,133,52,0],[133,53,133,65,0],[142,13,142,54,0],[143,13,143,63,0],[144,13,144,14,0],[146,17,146,72,0],[148,13,148,25,0],[149,9,149,10,0],[163,9,163,10,0],[164,13,164,30,0],[164,31,164,71,0],[165,13,165,99,0],[166,9,166,10,0],[169,9,169,10,0],[170,13,170,30,0],[170,31,170,71,0],[171,13,171,87,0],[172,9,172,10,0],[181,9,181,10,0],[182,13,182,136,0],[188,9,188,10,0],[189,13,189,136,0],[197,9,197,10,0],[198,13,198,30,0],[198,31,198,71,0],[199,13,199,58,0],[200,9,200,10,0],[208,9,208,10,0],[209,13,209,30,0],[209,31,209,71,0],[210,13,210,53,0],[211,13,211,25,0],[212,9,212,10,0],[220,9,220,10,0],[221,13,221,30,0],[221,31,221,71,0],[222,13,222,53,0],[223,13,223,25,0],[224,9,224,10,0],[232,9,232,10,0],[233,13,233,30,0],[233,31,233,71,0],[234,13,234,34,0],[234,35,234,79,0],[235,13,235,72,0],[236,13,245,80,0],[246,9,246,10,0],[249,9,249,10,0],[250,13,250,30,0],[250,31,250,71,0],[251,13,251,34,0],[251,35,251,79,0],[252,13,252,83,0],[253,9,253,10,0],[261,9,261,10,0],[262,13,262,30,0],[262,31,262,71,0],[263,13,263,54,0],[264,13,264,53,0],[265,9,265,10,0],[273,9,273,10,0],[274,13,274,32,0],[275,13,275,14,0],[276,17,276,26,0],[278,13,278,66,0],[279,13,279,86,0],[280,13,280,37,0],[281,9,281,10,0],[289,9,289,10,0],[290,13,290,30,0],[290,31,290,71,0],[291,13,291,101,0],[292,9,292,10,0],[295,9,295,10,0],[296,13,296,30,0],[296,31,296,71,0],[297,13,297,72,0],[298,9,298,10,0],[301,9,301,10,0],[302,13,302,29,0],[302,30,302,69,0],[305,13,305,14,0],[306,17,306,76,0],[306,76,306,81,0],[306,81,306,88,0],[306,88,306,95,0],[306,95,306,159,0],[306,17,306,159,0],[308,13,308,30,0],[309,13,309,14,0],[310,17,312,78,0],[313,17,313,29,0],[315,9,315,10,0],[323,9,323,10,0],[324,13,324,30,0],[324,31,324,71,0],[326,13,326,130,0],[327,13,327,20,0],[327,22,327,27,0],[327,28,327,30,0],[327,31,327,38,0],[328,13,328,14,0],[330,17,330,48,0],[333,17,333,60,0],[334,17,334,41,0],[335,17,335,18,0],[337,21,337,69,0],[338,17,338,18,0],[340,17,340,18,0],[342,21,342,106,0],[343,17,343,18,0],[344,13,344,14,0],[345,9,345,10,0],[348,9,348,10,0],[349,13,349,65,0],[350,18,350,27,0],[350,29,350,64,0],[350,66,350,69,0],[351,13,351,14,0],[352,17,352,60,0],[353,17,353,69,0],[354,13,354,14,0],[358,13,358,14,0],[360,17,360,64,0],[362,13,362,30,0],[363,13,363,14,0],[365,17,365,41,0],[366,17,366,29,0],[368,9,368,10,0],[371,9,371,10,0],[372,13,372,33,0],[372,34,372,77,0],[374,13,374,58,0],[374,59,374,71,0],[376,13,376,51,0],[377,13,377,37,0],[378,13,378,14,0],[379,17,379,29,0],[382,13,382,61,0],[383,9,383,10,0],[402,9,402,10,0],[403,13,403,30,0],[403,31,403,71,0],[405,13,413,19,0],[416,13,416,60,0],[417,13,424,19,0],[426,4,426,30,0],[427,17,427,38,0],[430,13,430,36,0],[432,13,432,47,0],[434,13,434,27,0],[435,9,435,10,0]]);
    </script>
  </body>
</html>