<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\helpers\url.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Xml;
using System.Text.RegularExpressions;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Core.CodeAnnotations;

namespace umbraco.cms.helpers
{
    /// &lt;summary&gt;
    /// Summary description for url.
    /// &lt;/summary&gt;
    public class url
    {
        public url()
        {
            //
            // TODO: Add constructor logic here
            //
        }

        [UmbracoWillObsolete(&quot;Use Umbraco.Core.StringExtensions.ToUrlSegment() instead.&quot;)]
        public static string FormatUrl(string url)
        {
            return url.ToUrlSegment();
        }

        /// &lt;summary&gt;
        /// Utility method for checking for valid proxy urls or redirect urls to prevent Open Redirect security issues
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;url&quot;&gt;The url to validate&lt;/param&gt;
        /// &lt;param name=&quot;callerUrl&quot;&gt;The url of the current local domain (to ensure we can validate if the requested url is local without dependency on the request)&lt;/param&gt;
        /// &lt;returns&gt;True if it&#39;s an allowed url&lt;/returns&gt;
        public static bool ValidateProxyUrl(string url, string callerUrl)
        {
            if (!Uri.IsWellFormedUriString(url, UriKind.RelativeOrAbsolute))
            {
                return false;
            }

            if (url.StartsWith(&quot;//&quot;))
                return false;

            Uri requestUri;
            if (Uri.TryCreate(url, UriKind.RelativeOrAbsolute, out requestUri))
            {
                if (!string.IsNullOrEmpty(callerUrl))
                {
                    Uri localUri;
                    if (Uri.TryCreate(callerUrl, UriKind.RelativeOrAbsolute, out localUri))
                    {
                        // check for local urls

                        //Cannot start with // since that is not a local url
                        if (!requestUri.OriginalString.StartsWith(&quot;//&quot;)
                            //cannot be non-absolute and also contain the char : since that will indicate a protocol
                            &amp;&amp; (!requestUri.IsAbsoluteUri &amp;&amp; !requestUri.OriginalString.Contains(&quot;:&quot;))
                            //needs to be non-absolute or the hosts must match the current request
                            &amp;&amp; (!requestUri.IsAbsoluteUri || requestUri.Host == localUri.Host))
                        {
                            return true;
                        }
                    }
                    else
                    {
                        //TODO: SD: why throw an exception?? shouldn&#39;t we just return false ?
                        throw new ArgumentException(&quot;CallerUrl is in a wrong format that couldn&#39;t be parsed as a valid URI. If you don&#39;t want to evaluate for local urls, but just proxy urls then leave callerUrl empty&quot;, &quot;callerUrl&quot;);
                    }
                }

                //we cannot continue if the url is not absolute
                if (!requestUri.IsAbsoluteUri)
                {
                    return false;
                }

                // check for valid proxy urls
                var feedProxyXml = XmlHelper.OpenAsXmlDocument(IOHelper.MapPath(SystemFiles.FeedProxyConfig));
                if (feedProxyXml != null &amp;&amp;
                    feedProxyXml.SelectSingleNode(string.Concat(&quot;//allow[@host = &#39;&quot;, requestUri.Host, &quot;&#39;]&quot;)) != null)
                {
                    return true;
                }
            } 
            else
            {
                //TODO: SD: why throw an exception?? shouldn&#39;t we just return false ?
                throw new ArgumentException(&quot;url is in a wrong format that couldn&#39;t be parsed as a valid URI&quot;, &quot;url&quot;);
                
            }
            return false;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[15,9,15,21,0],[16,9,16,10,0],[20,9,20,10,0],[24,9,24,10,0],[25,13,25,39,0],[26,9,26,10,0],[35,9,35,10,0],[36,13,36,77,0],[37,13,37,14,0],[38,17,38,30,0],[41,13,41,38,0],[42,17,42,30,0],[45,13,45,80,0],[46,13,46,14,0],[47,17,47,54,0],[48,17,48,18,0],[50,21,50,92,0],[51,21,51,22,0],[55,25,59,96,0],[60,25,60,26,0],[61,29,61,41,0],[63,21,63,22,0],[65,21,65,22,0],[67,25,67,233,0],[69,17,69,18,0],[72,17,72,47,0],[73,17,73,18,0],[74,21,74,34,0],[78,17,78,111,0],[79,17,80,118,0],[81,17,81,18,0],[82,21,82,33,0],[84,13,84,14,0],[86,13,86,14,0],[88,17,88,119,0],[91,13,91,26,0],[92,9,92,10,0]]);
    </script>
  </body>
</html>