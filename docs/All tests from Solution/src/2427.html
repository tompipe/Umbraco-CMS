<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\Packager\PackageActions\addProxyFeedHost.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Xml;
using Umbraco.Core.IO;

namespace umbraco.cms.businesslogic.packager.standardPackageActions
{
	public class addProxyFeedHost : umbraco.interfaces.IPackageAction
	{
		#region IPackageAction Members

		public bool Execute(string packageName, XmlNode xmlData)
		{
			var hostname = xmlData.Attributes[&quot;host&quot;].Value;
			if (string.IsNullOrEmpty(hostname))
				return false;

			var xdoc = xmlHelper.OpenAsXmlDocument(SystemFiles.FeedProxyConfig);

			xdoc.PreserveWhitespace = true;

			var xn = xdoc.SelectSingleNode(&quot;//feedProxy&quot;);
			if (xn != null)
			{
				var insert = true;

				if (xn.HasChildNodes)
				{
					foreach (XmlNode node in xn.SelectNodes(&quot;//allow&quot;))
					{
						if (node.Attributes[&quot;host&quot;] != null &amp;&amp; node.Attributes[&quot;host&quot;].Value == hostname)
							insert = false;
					}
				}

				if (insert)
				{
					var newHostname = xmlHelper.addTextNode(xdoc, &quot;allow&quot;, string.Empty);
					newHostname.Attributes.Append(xmlHelper.addAttribute(xdoc, &quot;host&quot;, hostname));
					xn.AppendChild(newHostname);

					xdoc.Save(IOHelper.MapPath(SystemFiles.FeedProxyConfig));

					return true;
				}
			}

			return false;
		}

		public string Alias()
		{
			return &quot;addProxyFeedHost&quot;;
		}

		public bool Undo(string packageName, XmlNode xmlData)
		{
			var hostname = xmlData.Attributes[&quot;host&quot;].Value;
			if (string.IsNullOrEmpty(hostname))
				return false;

			var xdoc = xmlHelper.OpenAsXmlDocument(SystemFiles.FeedProxyConfig);
			xdoc.PreserveWhitespace = true;

			var xn = xdoc.SelectSingleNode(&quot;//feedProxy&quot;);
			if (xn != null)
			{
				bool inserted = false;
				if (xn.HasChildNodes)
				{
					foreach (XmlNode node in xn.SelectNodes(&quot;//allow&quot;))
					{
						if (node.Attributes[&quot;host&quot;] != null &amp;&amp; node.Attributes[&quot;host&quot;].Value == hostname)
						{
							xn.RemoveChild(node);
							inserted = true;
						}
					}
				}

				if (inserted)
				{
					xdoc.Save(IOHelper.MapPath(SystemFiles.FeedProxyConfig));
					return true;
				}
			}

			return false;
		}

		#endregion

		public XmlNode SampleXml()
		{
			string sample = &quot;&lt;Action runat=\&quot;install\&quot; undo=\&quot;true\&quot; alias=\&quot;addProxyFeedHost\&quot; host=\&quot;umbraco.com\&quot;/&gt;&quot;;
			return helper.parseStringToXmlNode(sample);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[11,3,11,4,0],[12,4,12,52,0],[13,4,13,39,0],[14,5,14,18,0],[16,4,16,72,0],[18,4,18,35,0],[20,4,20,50,0],[21,4,21,19,0],[22,4,22,5,0],[23,5,23,23,0],[25,5,25,26,0],[26,5,26,6,0],[27,6,27,13,0],[27,15,27,27,0],[27,28,27,30,0],[27,31,27,56,0],[28,6,28,7,0],[29,7,29,88,0],[30,8,30,23,0],[31,6,31,7,0],[32,5,32,6,0],[34,5,34,16,0],[35,5,35,6,0],[36,6,36,75,0],[37,6,37,84,0],[38,6,38,34,0],[40,6,40,63,0],[42,6,42,18,0],[44,4,44,5,0],[46,4,46,17,0],[47,3,47,4,0],[50,3,50,4,0],[51,4,51,30,0],[52,3,52,4,0],[55,3,55,4,0],[56,4,56,52,0],[57,4,57,39,0],[58,5,58,18,0],[60,4,60,72,0],[61,4,61,35,0],[63,4,63,50,0],[64,4,64,19,0],[65,4,65,5,0],[66,5,66,27,0],[67,5,67,26,0],[68,5,68,6,0],[69,6,69,13,0],[69,15,69,27,0],[69,28,69,30,0],[69,31,69,56,0],[70,6,70,7,0],[71,7,71,88,0],[72,7,72,8,0],[73,8,73,29,0],[74,8,74,24,0],[75,7,75,8,0],[76,6,76,7,0],[77,5,77,6,0],[79,5,79,18,0],[80,5,80,6,0],[81,6,81,63,0],[82,6,82,18,0],[84,4,84,5,0],[86,4,86,17,0],[87,3,87,4,0],[92,3,92,4,0],[93,4,93,112,0],[94,4,94,47,0],[95,3,95,4,0]]);
    </script>
  </body>
</html>