<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\StylesheetRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence.Repositories
{
    /// &lt;summary&gt;
    /// Represents the Stylesheet Repository
    /// &lt;/summary&gt;
    internal class StylesheetRepository : FileRepository&lt;string, Stylesheet&gt;, IStylesheetRepository
    {
        public StylesheetRepository(IUnitOfWork work, IFileSystem fileSystem)
            : base(work, fileSystem)
        {
        }

        #region Overrides of FileRepository&lt;string,Stylesheet&gt;

        public override Stylesheet Get(string id)
        {
            // get the relative path within the filesystem
            // (though... id should be relative already)
            var path = FileSystem.GetRelativePath(id);

            path = path.EnsureEndsWith(&quot;.css&quot;);

            if (FileSystem.FileExists(path) == false)
                return null;

            // content will be lazy-loaded when required
            var created = FileSystem.GetCreated(path).UtcDateTime;
            var updated = FileSystem.GetLastModified(path).UtcDateTime;
            //var content = GetFileContent(path);

            var stylesheet = new Stylesheet(path, file =&gt; GetFileContent(file.OriginalPath))
            {
                //Content = content,
                Key = path.EncodeAsGuid(),
                CreateDate = created,
                UpdateDate = updated,
                Id = path.GetHashCode(),
                VirtualPath = FileSystem.GetUrl(path)
            };

            //on initial construction we don&#39;t want to have dirty properties tracked
            // http://issues.umbraco.org/issue/U4-1946
            stylesheet.ResetDirtyProperties(false);

            return stylesheet;

        }

        public override void AddOrUpdate(Stylesheet entity)
        {
            base.AddOrUpdate(entity);

            // ensure that from now on, content is lazy-loaded
            if (entity.GetFileContent == null)
                entity.GetFileContent = file =&gt; GetFileContent(file.OriginalPath);
        }

        public override IEnumerable&lt;Stylesheet&gt; GetAll(params string[] ids)
        {
            //ensure they are de-duplicated, easy win if people don&#39;t do this as this can cause many excess queries
            ids = ids
                .Select(x =&gt; x.EnsureEndsWith(&quot;.css&quot;))
                .Distinct()
                .ToArray();

            if (ids.Any())
            {
                foreach (var id in ids)
                {
                    yield return Get(id);
                }
            }
            else
            {
                var files = FindAllFiles(&quot;&quot;, &quot;*.css&quot;);
                foreach (var file in files)
                {
                    yield return Get(file);
                }
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of all &lt;see cref=&quot;Stylesheet&quot;/&gt; that exist at the relative path specified. 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;rootPath&quot;&gt;
        /// If null or not specified, will return the stylesheets at the root path relative to the IFileSystem
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;Stylesheet&gt; GetStylesheetsAtPath(string rootPath = null)
        {
            return FileSystem.GetFiles(rootPath ?? string.Empty, &quot;*.css&quot;).Select(Get);
        }

        private static readonly List&lt;string&gt; ValidExtensions = new List&lt;string&gt; { &quot;css&quot; };

        public bool ValidateStylesheet(Stylesheet stylesheet)
        {
            // get full path
            string fullPath;
            try
            {
                // may throw for security reasons
                fullPath = FileSystem.GetFullPath(stylesheet.Path);
            }
            catch
            {
                return false;
            }

            // validate path and extension
            var validDir = SystemDirectories.Css;
            var isValidPath = IOHelper.VerifyEditPath(fullPath, validDir);
            var isValidExtension = IOHelper.VerifyFileExtension(stylesheet.Path, ValidExtensions);
            return isValidPath &amp;&amp; isValidExtension;
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,15,19,37,1],[20,9,20,10,1],[21,9,21,10,1],[26,9,26,10,1],[29,13,29,55,1],[31,13,31,48,1],[33,13,33,54,1],[34,17,34,29,1],[37,13,37,67,1],[38,13,38,72,1],[41,13,41,59,1],[41,59,41,92,1],[41,92,49,15,1],[41,13,49,15,1],[53,13,53,52,1],[55,13,55,31,1],[57,9,57,10,1],[60,9,60,10,1],[61,13,61,38,1],[64,13,64,47,1],[65,17,65,49,1],[65,49,65,82,0],[65,82,65,83,1],[65,17,65,83,1],[66,9,66,10,1],[101,9,101,10,0],[102,13,102,87,0],[103,9,103,10,0],[105,9,105,91,1],[108,9,108,10,1],[112,13,112,14,1],[114,17,114,68,1],[115,13,115,14,1],[116,13,116,18,0],[117,13,117,14,0],[118,17,118,30,0],[122,13,122,50,1],[123,13,123,75,1],[124,13,124,99,1],[125,13,125,52,1],[126,9,126,10,1]]);
    </script>
  </body>
</html>