<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Syntax\Alter\Column\AlterColumnBuilder.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Data;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.Migrations.Syntax.Alter.Expressions;
using Umbraco.Core.Persistence.Migrations.Syntax.Expressions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Syntax.Alter.Column
{
    public class AlterColumnBuilder : ExpressionBuilder&lt;AlterColumnExpression, IAlterColumnOptionSyntax&gt;,
                                            IAlterColumnSyntax,
                                            IAlterColumnTypeSyntax,
                                            IAlterColumnOptionForeignKeyCascadeSyntax
    {
        private readonly IMigrationContext _context;
        private readonly DatabaseProviders[] _databaseProviders;

        public AlterColumnBuilder(IMigrationContext context, DatabaseProviders[] databaseProviders, AlterColumnExpression expression)
            : base(expression)
        {
            _context = context;
            _databaseProviders = databaseProviders;
        }

        public ForeignKeyDefinition CurrentForeignKey { get; set; }

        public override ColumnDefinition GetColumnForType()
        {
            return Expression.Column;
        }

        public IAlterColumnTypeSyntax OnTable(string name)
        {
            Expression.TableName = name;
            return this;
        }

        public IAlterColumnOptionSyntax WithDefault(SystemMethods method)
        {
            var dc = new AlterDefaultConstraintExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax)
                         {
                             TableName = Expression.TableName,
                             SchemaName = Expression.SchemaName,
                             ColumnName = Expression.Column.Name,
                             DefaultValue = method
                         };

            _context.Expressions.Add(dc);

            Expression.Column.DefaultValue = method;

            return this;
        }
        

        public IAlterColumnOptionSyntax WithDefaultValue(object value)
        {
            var dc = new AlterDefaultConstraintExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax)
                         {
                             TableName = Expression.TableName,
                             SchemaName = Expression.SchemaName,
                             ColumnName = Expression.Column.Name,
                             DefaultValue = value
                         };

            _context.Expressions.Add(dc);

            Expression.Column.DefaultValue = value;

            return this;
        }

        public IAlterColumnOptionSyntax Identity()
        {
            Expression.Column.IsIdentity = true;
            return this;
        }

        public IAlterColumnOptionSyntax Indexed()
        {
            return Indexed(null);
        }

        public IAlterColumnOptionSyntax Indexed(string indexName)
        {
            Expression.Column.IsIndexed = true;

            var index = new CreateIndexExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new IndexDefinition
            {
                Name = indexName,
                SchemaName = Expression.SchemaName,
                TableName = Expression.TableName
            });

            index.Index.Columns.Add(new IndexColumnDefinition
                                        {
                                            Name = Expression.Column.Name
                                        });

            _context.Expressions.Add(index);

            return this;
        }

        public IAlterColumnOptionSyntax PrimaryKey()
        {
            Expression.Column.IsPrimaryKey = true;
            return this;
        }

        public IAlterColumnOptionSyntax PrimaryKey(string primaryKeyName)
        {
            Expression.Column.IsPrimaryKey = true;
            Expression.Column.PrimaryKeyName = primaryKeyName;
            return this;
        }

        public IAlterColumnOptionSyntax Nullable()
        {
            Expression.Column.IsNullable = true;
            return this;
        }

        public IAlterColumnOptionSyntax NotNullable()
        {
            Expression.Column.IsNullable = false;
            return this;
        }

        public IAlterColumnOptionSyntax Unique()
        {
            return Unique(null);
        }

        public IAlterColumnOptionSyntax Unique(string indexName)
        {
            Expression.Column.IsUnique = true;

            var index = new CreateIndexExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new IndexDefinition
            {
                Name = indexName,
                SchemaName = Expression.SchemaName,
                TableName = Expression.TableName,
                IsUnique = true
            });

            index.Index.Columns.Add(new IndexColumnDefinition
                                        {
                                            Name = Expression.Column.Name
                                        });

            _context.Expressions.Add(index);

            return this;
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax ForeignKey(string primaryTableName, string primaryColumnName)
        {
            return ForeignKey(null, null, primaryTableName, primaryColumnName);
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax ForeignKey(string foreignKeyName, string primaryTableName,
                                                                    string primaryColumnName)
        {
            return ForeignKey(foreignKeyName, null, primaryTableName, primaryColumnName);
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax ForeignKey(string foreignKeyName, string primaryTableSchema,
                                                                    string primaryTableName, string primaryColumnName)
        {
            Expression.Column.IsForeignKey = true;

            var fk = new CreateForeignKeyExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new ForeignKeyDefinition
            {
                Name = foreignKeyName,
                PrimaryTable = primaryTableName,
                PrimaryTableSchema = primaryTableSchema,
                ForeignTable = Expression.TableName,
                ForeignTableSchema = Expression.SchemaName
            });

            fk.ForeignKey.PrimaryColumns.Add(primaryColumnName);
            fk.ForeignKey.ForeignColumns.Add(Expression.Column.Name);

            _context.Expressions.Add(fk);
            CurrentForeignKey = fk.ForeignKey;
            return this;
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax ForeignKey()
        {
            Expression.Column.IsForeignKey = true;
            return this;
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignTableName, string foreignColumnName)
        {
            return ReferencedBy(null, null, foreignTableName, foreignColumnName);
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignKeyName, string foreignTableName,
                                                                      string foreignColumnName)
        {
            return ReferencedBy(foreignKeyName, null, foreignTableName, foreignColumnName);
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignKeyName, string foreignTableSchema,
                                                                      string foreignTableName, string foreignColumnName)
        {
            var fk = new CreateForeignKeyExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new ForeignKeyDefinition
            {
                Name = foreignKeyName,
                PrimaryTable = Expression.TableName,
                PrimaryTableSchema = Expression.SchemaName,
                ForeignTable = foreignTableName,
                ForeignTableSchema = foreignTableSchema
            });

            fk.ForeignKey.PrimaryColumns.Add(Expression.Column.Name);
            fk.ForeignKey.ForeignColumns.Add(foreignColumnName);

            _context.Expressions.Add(fk);
            CurrentForeignKey = fk.ForeignKey;
            return this;
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax OnDelete(Rule rule)
        {
            CurrentForeignKey.OnDelete = rule;
            return this;
        }

        public IAlterColumnOptionForeignKeyCascadeSyntax OnUpdate(Rule rule)
        {
            CurrentForeignKey.OnUpdate = rule;
            return this;
        }

        public IAlterColumnOptionSyntax OnDeleteOrUpdate(Rule rule)
        {
            OnDelete(rule);
            OnUpdate(rule);
            return this;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,15,18,31,0],[19,9,19,10,0],[20,13,20,32,0],[21,13,21,52,0],[22,9,22,10,0],[24,57,24,61,0],[24,62,24,66,0],[27,9,27,10,0],[28,13,28,38,0],[29,9,29,10,0],[32,9,32,10,0],[33,13,33,41,0],[34,13,34,25,0],[35,9,35,10,0],[38,9,38,10,0],[39,13,45,28,0],[47,13,47,42,0],[49,13,49,53,0],[51,13,51,25,0],[52,9,52,10,0],[56,9,56,10,0],[57,13,63,28,0],[65,13,65,42,0],[67,13,67,52,0],[69,13,69,25,0],[70,9,70,10,0],[73,9,73,10,0],[74,13,74,49,0],[75,13,75,25,0],[76,9,76,10,0],[79,9,79,10,0],[80,13,80,34,0],[81,9,81,10,0],[84,9,84,10,0],[85,13,85,48,0],[87,13,92,16,0],[94,13,97,44,0],[99,13,99,45,0],[101,13,101,25,0],[102,9,102,10,0],[105,9,105,10,0],[106,13,106,51,0],[107,13,107,25,0],[108,9,108,10,0],[111,9,111,10,0],[112,13,112,51,0],[113,13,113,63,0],[114,13,114,25,0],[115,9,115,10,0],[118,9,118,10,0],[119,13,119,49,0],[120,13,120,25,0],[121,9,121,10,0],[124,9,124,10,0],[125,13,125,50,0],[126,13,126,25,0],[127,9,127,10,0],[130,9,130,10,0],[131,13,131,33,0],[132,9,132,10,0],[135,9,135,10,0],[136,13,136,47,0],[138,13,144,16,0],[146,13,149,44,0],[151,13,151,45,0],[153,13,153,25,0],[154,9,154,10,0],[157,9,157,10,0],[158,13,158,80,0],[159,9,159,10,0],[163,9,163,10,0],[164,13,164,90,0],[165,9,165,10,0],[169,9,169,10,0],[170,13,170,51,0],[172,13,179,16,0],[181,13,181,65,0],[182,13,182,70,0],[184,13,184,42,0],[185,13,185,47,0],[186,13,186,25,0],[187,9,187,10,0],[190,9,190,10,0],[191,13,191,51,0],[192,13,192,25,0],[193,9,193,10,0],[196,9,196,10,0],[197,13,197,82,0],[198,9,198,10,0],[202,9,202,10,0],[203,13,203,92,0],[204,9,204,10,0],[208,9,208,10,0],[209,13,216,16,0],[218,13,218,70,0],[219,13,219,65,0],[221,13,221,42,0],[222,13,222,47,0],[223,13,223,25,0],[224,9,224,10,0],[227,9,227,10,0],[228,13,228,47,0],[229,13,229,25,0],[230,9,230,10,0],[233,9,233,10,0],[234,13,234,47,0],[235,13,235,25,0],[236,9,236,10,0],[239,9,239,10,0],[240,13,240,28,0],[241,13,241,28,0],[242,13,242,25,0],[243,9,243,10,0]]);
    </script>
  </body>
</html>