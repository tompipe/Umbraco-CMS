<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\uQuery\ContentExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using umbraco.cms.businesslogic;
using umbraco.cms.businesslogic.datatype;
using System.Xml;
using Umbraco.Core;

namespace umbraco
{
	/// &lt;summary&gt;
	/// uQuery extensions for the Content object (the Document / Media and Memeber objects derive from Content, hence these extension methods are available to Documents / Media and Members)
	/// &lt;/summary&gt;
	public static class ContentExtensions
	{
		/// &lt;summary&gt;
		/// Determines whether the specified content item has property.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;item&quot;&gt;The content item.&lt;/param&gt;
		/// &lt;param name=&quot;propertyAlias&quot;&gt;The property alias.&lt;/param&gt;
		/// &lt;returns&gt;
		/// 	&lt;c&gt;true&lt;/c&gt; if the specified content item has property; otherwise, &lt;c&gt;false&lt;/c&gt;.
		/// &lt;/returns&gt;
		[Obsolete(&quot;Use the new Services APIs instead&quot;)]
		public static bool HasProperty(this Content item, string propertyAlias)
		{
			var property = item.getProperty(propertyAlias);
			return (property != null);
		}

		/// &lt;summary&gt;
		/// Get a value (of specified type) from a content item&#39;s property.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;T&quot;&gt;The type.&lt;/typeparam&gt;
		/// &lt;param name=&quot;item&quot;&gt;The content item.&lt;/param&gt;
		/// &lt;param name=&quot;propertyAlias&quot;&gt;alias of property to get&lt;/param&gt;
		/// &lt;returns&gt;default(T) or property value cast to (T)&lt;/returns&gt;
        [Obsolete(&quot;Use the new Services APIs instead&quot;)]
		public static T GetProperty&lt;T&gt;(this Content item, string propertyAlias)
        {
            // check to see if return object handles it&#39;s own object hydration
            if (typeof(uQuery.IGetProperty).IsAssignableFrom(typeof(T)))
            {
                // create new instance of T with empty constructor
                uQuery.IGetProperty t = (uQuery.IGetProperty)Activator.CreateInstance&lt;T&gt;();

                // call method to hydrate the object from a string value
                t.LoadPropertyValue(item.GetProperty&lt;string&gt;(propertyAlias));

                return (T)t;
            }

            var typeConverter = TypeDescriptor.GetConverter(typeof(T));
            if (typeConverter != null)
            {
                // Boolean
                if (typeof(T) == typeof(bool))
                {
                    return (T)typeConverter.ConvertFrom(item.GetPropertyAsBoolean(propertyAlias).ToString());
                }

                // XmlDocument
                else if (typeof(T) == typeof(XmlDocument))
                {
                    var xmlDocument = new XmlDocument();

                    try
                    {
                        xmlDocument.LoadXml(item.GetPropertyAsString(propertyAlias));
                    }
                    catch
                    {
                    }

                    return (T)((object)xmlDocument);
                }

//                // umbraco.MacroEngines.DynamicXml
//                else if (typeof(T) == typeof(DynamicXml))
//                {
//                    try
//                    {
//                        return (T)((object)new DynamicXml(item.GetPropertyAsString(propertyAlias)));
//                    }
//                    catch
//                    {
//                    }
//                }

                try
                {
                    return (T)typeConverter.ConvertFromString(item.GetPropertyAsString(propertyAlias));
                }
                catch
                {
                }
            }

            return default(T);
        }

		/// &lt;summary&gt;
		/// Get a string value from a content item&#39;s property.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;item&quot;&gt;The content item.&lt;/param&gt;
		/// &lt;param name=&quot;propertyAlias&quot;&gt;alias of propety to get&lt;/param&gt;
		/// &lt;returns&gt;
		/// empty string, or property value as string
		/// &lt;/returns&gt;
        [Obsolete(&quot;Use the new Services APIs instead&quot;)]
		private static string GetPropertyAsString(this Content item, string propertyAlias)
		{
			var propertyValue = string.Empty;
			var property = item.getProperty(propertyAlias);

			if (property != null &amp;&amp; property.Value != null)
			{
				propertyValue = Convert.ToString(property.Value);
			}

			return propertyValue;
		}

		/// &lt;summary&gt;
		/// Get a boolean value from a content item&#39;s property, (works with built in Yes/No dataype).
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;item&quot;&gt;The content item.&lt;/param&gt;
		/// &lt;param name=&quot;propertyAlias&quot;&gt;alias of propety to get&lt;/param&gt;
		/// &lt;returns&gt;
		/// true if can cast value, else false for all other circumstances
		/// &lt;/returns&gt;
        [Obsolete(&quot;Use the new Services APIs instead&quot;)]
        private static bool GetPropertyAsBoolean(this Content item, string propertyAlias)
		{
			var propertyValue = false;
			var property = item.getProperty(propertyAlias);

			if (property != null &amp;&amp; property.Value != null)
			{
				// Umbraco yes / no datatype stores a string value of &#39;1&#39; or &#39;0&#39;
				if (Convert.ToString(property.Value) == &quot;1&quot;)
				{
					propertyValue = true;
				}
				else
				{
					bool.TryParse(Convert.ToString(property.Value), out propertyValue);
				}
			}

			return propertyValue;
		}

		/// &lt;summary&gt;
		/// Gets the random content item.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TSource&quot;&gt;The type of the source.&lt;/typeparam&gt;
		/// &lt;param name=&quot;items&quot;&gt;The content items.&lt;/param&gt;
		/// &lt;returns&gt;
		/// Returns a random content item from a collection of content items.
		/// &lt;/returns&gt;
		public static TSource GetRandom&lt;TSource&gt;(this IList&lt;TSource&gt; items)
		{
			return items.RandomOrder().First();
		}

		/// &lt;summary&gt;
		/// Gets a collection of random content items.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TSource&quot;&gt;The type of the source.&lt;/typeparam&gt;
		/// &lt;param name=&quot;items&quot;&gt;The content items.&lt;/param&gt;
		/// &lt;param name=&quot;numberOfItems&quot;&gt;The number of items.&lt;/param&gt;
		/// &lt;returns&gt;
		/// Returns the specified number of random content items from a collection of content items.
		/// &lt;/returns&gt;
		public static IEnumerable&lt;TSource&gt; GetRandom&lt;TSource&gt;(this ICollection&lt;TSource&gt; items, int numberOfItems)
		{
			if (numberOfItems &gt; items.Count)
			{
				numberOfItems = items.Count;
			}

			return items.RandomOrder().Take(numberOfItems);
		}

		/// &lt;summary&gt;
		/// Sorts the by property.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;T&quot;&gt;The type of the property.&lt;/typeparam&gt;
		/// &lt;param name=&quot;items&quot;&gt;The items.&lt;/param&gt;
		/// &lt;param name=&quot;propertyAlias&quot;&gt;The property alias.&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use the new Services APIs instead&quot;)]
		public static IEnumerable&lt;Content&gt; OrderByProperty&lt;T&gt;(this IEnumerable&lt;Content&gt; items, string propertyAlias)
		{
			return items.OrderBy(x =&gt; x.GetProperty&lt;T&gt;(propertyAlias));

			////// [LK] Long-winded way! :-)
			////var tmp = new Dictionary&lt;Content, T&gt;();

			////foreach (var item in items)
			////{
			////    var property = item.GetProperty&lt;T&gt;(propertyAlias);
			////    if (property != null)
			////    {
			////        tmp.Add(item, property);
			////    }
			////}

			////return tmp.OrderBy(x =&gt; x.Value).Select(x =&gt; x.Key);
		}

		/// &lt;summary&gt;
		/// Orders the by property descending.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;T&quot;&gt;The type of the property.&lt;/typeparam&gt;
		/// &lt;param name=&quot;items&quot;&gt;The items.&lt;/param&gt;
		/// &lt;param name=&quot;propertyAlias&quot;&gt;The property alias.&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use the new Services APIs instead&quot;)]
		public static IEnumerable&lt;Content&gt; OrderByPropertyDescending&lt;T&gt;(this IEnumerable&lt;Content&gt; items, string propertyAlias)
		{
			return items.OrderByDescending(x =&gt; x.GetProperty&lt;T&gt;(propertyAlias));
		}

		/// &lt;summary&gt;
		/// Randomizes the order of the content items.
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;TSource&quot;&gt;The type of the source.&lt;/typeparam&gt;
		/// &lt;param name=&quot;items&quot;&gt;The content items.&lt;/param&gt;
		/// &lt;returns&gt;Returns a list of content items in a random order.&lt;/returns&gt;
		public static IEnumerable&lt;TSource&gt; RandomOrder&lt;TSource&gt;(this IEnumerable&lt;TSource&gt; items)
		{
			var random = umbraco.library.GetRandom();
			return items.OrderBy(x =&gt; (random.Next()));
		}

		/// &lt;summary&gt;
		/// Sets a property value, and returns self.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;item&quot;&gt;The content item.&lt;/param&gt;
		/// &lt;param name=&quot;propertyAlias&quot;&gt;The alias of property to set.&lt;/param&gt;
		/// &lt;param name=&quot;value&quot;&gt;The value to set.&lt;/param&gt;
		/// &lt;returns&gt;
		/// The same content item on which this is an extension method.
		/// &lt;/returns&gt;
        [Obsolete(&quot;Use the new Services APIs instead&quot;)]
		public static Content SetProperty(this Content item, string propertyAlias, object value)
		{
			var property = item.getProperty(propertyAlias);

			if (property != null)
			{
				if (value != null)
				{
					var dataTypeGuid = property.PropertyType.DataTypeDefinition.DataType.Id.ToString();

					// switch based on datatype of property being set - if setting a built in ddl or radion button list, then string supplied is checked against prevalues
					switch (dataTypeGuid.ToUpper())
					{
						case Constants.PropertyEditors.DropDownList: // DropDownList
						case Constants.PropertyEditors.RadioButtonList: // RadioButtonList

							var preValues = PreValues.GetPreValues(property.PropertyType.DataTypeDefinition.Id);
							PreValue preValue = null;

							// switch based on the supplied value type
							switch (Type.GetTypeCode(value.GetType()))
							{
								case TypeCode.String:
									// attempt to get prevalue from the label
									preValue = preValues.Values.Cast&lt;PreValue&gt;().Where(x =&gt; x.Value == (string)value).FirstOrDefault();
									break;

								case TypeCode.Int16:
								case TypeCode.Int32:
									// attempt to get prevalue from the id
									preValue = preValues.Values.Cast&lt;PreValue&gt;().Where(x =&gt; x.Id == (int)value).FirstOrDefault();
									break;
							}

							if (preValue != null)
							{
								// check db field type being saved to and store prevalue id as an int or a string - note can never save a prevalue id to a date field ! 
								switch (((DefaultData)property.PropertyType.DataTypeDefinition.DataType.Data).DatabaseType)
								{
									case DBTypes.Ntext:
									case DBTypes.Nvarchar:
										property.Value = preValue.Id.ToString();
										break;

									case DBTypes.Integer:
										property.Value = preValue.Id;
										break;
								}
							}

							break;

						case Constants.PropertyEditors.Date: // Date (NOTE: currently assumes database type is set to Date)

							switch (Type.GetTypeCode(value.GetType()))
							{
								case TypeCode.DateTime:
									property.Value = ((DateTime)value).Date;
									break;
								case TypeCode.String:
									DateTime valueDateTime;
									if (DateTime.TryParse((string)value, out valueDateTime))
									{
										property.Value = valueDateTime.Date;
									};
									break;
							}

							break;

						default:
							// This saves the property value
							property.Value = value;
							break;
					}
				}
				else
				{
					// the value is NULL
					property.Value = value;
				}
			}

			item.Save();

			return item;
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,3,27,4,0],[28,4,28,51,0],[29,4,29,30,0],[30,3,30,4,0],[41,9,41,10,0],[43,13,43,73,0],[44,13,44,14,0],[46,17,46,92,0],[49,17,49,78,0],[51,17,51,29,0],[54,13,54,72,0],[55,13,55,39,0],[56,13,56,14,0],[58,17,58,47,0],[59,17,59,18,0],[60,21,60,110,0],[64,22,64,59,0],[65,17,65,18,0],[66,21,66,57,0],[69,21,69,22,0],[70,25,70,86,0],[71,21,71,22,0],[72,21,72,26,0],[73,21,73,22,0],[74,21,74,22,0],[76,21,76,53,0],[92,17,92,18,0],[93,21,93,104,0],[95,17,95,22,0],[96,17,96,18,0],[97,17,97,18,0],[98,13,98,14,0],[100,13,100,31,0],[101,9,101,10,0],[113,3,113,4,0],[114,4,114,37,0],[115,4,115,51,0],[117,4,117,51,0],[118,4,118,5,0],[119,5,119,54,0],[120,4,120,5,0],[122,4,122,25,0],[123,3,123,4,0],[135,3,135,4,0],[136,4,136,30,0],[137,4,137,51,0],[139,4,139,51,0],[140,4,140,5,0],[142,5,142,49,0],[143,5,143,6,0],[144,6,144,27,0],[145,5,145,6,0],[147,5,147,6,0],[148,6,148,73,0],[149,5,149,6,0],[150,4,150,5,0],[152,4,152,25,0],[153,3,153,4,0],[164,3,164,4,0],[165,4,165,39,0],[166,3,166,4,0],[178,3,178,4,0],[179,4,179,36,0],[180,4,180,5,0],[181,5,181,33,0],[182,4,182,5,0],[184,4,184,51,0],[185,3,185,4,0],[196,3,196,4,0],[197,4,197,30,0],[197,30,197,61,0],[197,61,197,63,0],[197,4,197,63,0],[212,3,212,4,0],[223,3,223,4,0],[224,4,224,40,0],[224,40,224,71,0],[224,71,224,73,0],[224,4,224,73,0],[225,3,225,4,0],[234,3,234,4,0],[235,4,235,45,0],[236,4,236,30,0],[236,30,236,45,0],[236,45,236,47,0],[236,4,236,47,0],[237,3,237,4,0],[250,3,250,4,0],[251,4,251,51,0],[253,4,253,25,0],[254,4,254,5,0],[255,5,255,23,0],[256,5,256,6,0],[257,6,257,89,0],[260,6,260,37,0],[265,8,265,92,0],[266,8,266,33,0],[269,8,269,50,0],[273,10,273,66,0],[273,66,273,90,0],[273,90,273,109,0],[273,10,273,109,0],[274,10,274,16,0],[279,10,279,66,0],[279,66,279,84,0],[279,84,279,103,0],[279,10,279,103,0],[280,10,280,16,0],[283,8,283,29,0],[284,8,284,9,0],[286,9,286,100,0],[290,11,290,51,0],[291,11,291,17,0],[294,11,294,40,0],[295,11,295,17,0],[297,8,297,9,0],[299,8,299,14,0],[303,8,303,50,0],[306,10,306,50,0],[307,10,307,16,0],[310,10,310,66,0],[311,10,311,11,0],[312,11,312,47,0],[313,10,313,11,0],[313,11,313,12,0],[314,10,314,16,0],[317,8,317,14,0],[321,8,321,31,0],[322,8,322,14,0],[324,5,324,6,0],[326,5,326,6,0],[328,6,328,29,0],[329,5,329,6,0],[330,4,330,5,0],[332,4,332,16,0],[334,4,334,16,0],[335,3,335,4,0]]);
    </script>
  </body>
</html>