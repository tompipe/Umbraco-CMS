<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\AbstractJsonPrevalueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.Script.Serialization;
using Umbraco.Core.Logging;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.datatype;

namespace umbraco.editorControls
{
    /// &lt;summary&gt;
    /// Abstract class for the PreValue Editor.
    /// Specifically designed to serialize/deserialize the options as JSON.
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public abstract class AbstractJsonPrevalueEditor : AbstractPrevalueEditor
    {
        /// &lt;summary&gt;
        /// The underlying base data-type.
        /// &lt;/summary&gt;
        protected readonly umbraco.cms.businesslogic.datatype.BaseDataType m_DataType;

        /// &lt;summary&gt;
        /// An object to temporarily lock writing to the database.
        /// &lt;/summary&gt;
        private static readonly object m_Locker = new object();

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;AbstractJsonPrevalueEditor&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataType&quot;&gt;Type of the data.&lt;/param&gt;
        public AbstractJsonPrevalueEditor(umbraco.cms.businesslogic.datatype.BaseDataType dataType)
        {
            this.m_DataType = dataType;
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;AbstractJsonPrevalueEditor&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataType&quot;&gt;Type of the data.&lt;/param&gt;
        /// &lt;param name=&quot;dbType&quot;&gt;Type of the database field.&lt;/param&gt;
        public AbstractJsonPrevalueEditor(umbraco.cms.businesslogic.datatype.BaseDataType dataType, umbraco.cms.businesslogic.datatype.DBTypes dbType)
            : base()
        {
            this.m_DataType = dataType;
            this.m_DataType.DBType = dbType;
        }

        /// &lt;summary&gt;
        /// Gets the PreValue options for the data-type.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;The type of the resulting object.&lt;/typeparam&gt;
        /// &lt;returns&gt;
        /// Returns the options for the PreValue Editor
        /// &lt;/returns&gt;
        public T GetPreValueOptions&lt;T&gt;()
        {
            var prevalues = PreValues.GetPreValues(this.m_DataType.DataTypeDefinitionId);
            if (prevalues.Count &gt; 0)
            {
                var prevalue = (PreValue)prevalues[0];
                if (!string.IsNullOrEmpty(prevalue.Value))
                {
                    try
                    {
                        // deserialize the options
                        var serializer = new JavaScriptSerializer();

                        // return the options
                        return serializer.Deserialize&lt;T&gt;(prevalue.Value);
                    }
                    catch (Exception ex)
                    {
						LogHelper.Error&lt;AbstractJsonPrevalueEditor&gt;(&quot;umbraco.editorControls: Execption thrown&quot;, ex);
                    }
                }
            }

            // if all else fails, return default options
            return default(T);
        }

        /// &lt;summary&gt;
        /// Saves the data-type PreValue options.
        /// &lt;/summary&gt;
        public void SaveAsJson(object options)
        {
            // serialize the options into JSON
            var serializer = new JavaScriptSerializer();
            var json = serializer.Serialize(options);

            lock (m_Locker)
            {
                var prevalues = PreValues.GetPreValues(this.m_DataType.DataTypeDefinitionId);
                if (prevalues.Count &gt; 0)
                {
                    var prevalue = (PreValue)prevalues[0];

                    // update
                    prevalue.Value = json;
                    prevalue.Save();
                }
                else
                {
                    // insert
                    PreValue.MakeNew(this.m_DataType.DataTypeDefinitionId, json);
                }
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,64,0],[30,9,30,100,0],[31,9,31,10,0],[32,13,32,40,0],[33,9,33,10,0],[41,15,41,21,0],[42,9,42,10,0],[43,13,43,40,0],[44,13,44,45,0],[45,9,45,10,0],[55,9,55,10,0],[56,13,56,90,0],[57,13,57,37,0],[58,13,58,14,0],[59,17,59,55,0],[60,17,60,59,0],[61,17,61,18,0],[63,21,63,22,0],[65,25,65,69,0],[68,25,68,74,0],[70,21,70,41,0],[71,21,71,22,0],[72,7,72,99,0],[73,21,73,22,0],[74,17,74,18,0],[75,13,75,14,0],[78,13,78,31,0],[79,9,79,10,0],[85,9,85,10,0],[87,13,87,57,0],[88,13,88,54,0],[90,13,90,28,0],[91,13,91,14,0],[92,17,92,94,0],[93,17,93,41,0],[94,17,94,18,0],[95,21,95,59,0],[98,21,98,43,0],[99,21,99,37,0],[100,17,100,18,0],[102,17,102,18,0],[104,21,104,82,0],[105,17,105,18,0],[106,13,106,14,0],[107,9,107,10,0]]);
    </script>
  </body>
</html>