<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.datalayer\DataLayerHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/************************************************************************************
 * 
 *  Umbraco Data Layer
 *  MIT Licensed work
 *  ï¿½2008 Ruben Verborgh
 * 
 ***********************************************************************************/

using System;
using System.Configuration;
using System.Data.Common;
using System.Reflection;

namespace umbraco.DataLayer
{
    /// &lt;summary&gt;
    /// The DataLayerHelper class is the main interface to the data layer.
    /// &lt;/summary&gt;
    public class DataLayerHelper
    {
        #region Private Constants

        /// &lt;summary&gt;Name of the property that identifies the SQL helper type.&lt;/summary&gt;
        private const string ConnectionStringDataLayerIdentifier = &quot;datalayer&quot;;
        /// &lt;summary&gt;Name of the default data layer, that is used when nothing is specified.&lt;/summary&gt;
        private const string DefaultDataHelperName = &quot;SqlServer&quot;;
        /// &lt;summary&gt;Format used when the SQL helper is qualified by its simple name, instead of the full class name.&lt;/summary&gt;
        private const string DefaultDataHelperFormat = &quot;umbraco.DataLayer.SqlHelpers.{0}.{0}Helper&quot;;

        private static string _dataHelperTypeName;
        private static string _dataHelperAssemblyName;
        private static string _connectionString;

        #endregion

        #region Public Methods
        /// &lt;summary&gt;
        /// Creates a SQL helper for the specified connection string.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;connectionString&quot;&gt;The connection string containing the SQL helper type.&lt;/param&gt;
        /// &lt;returns&gt;A new SQL helper.&lt;/returns&gt;
        /// &lt;remarks&gt;This method will change to allow the addition of external SQL helpers.&lt;/remarks&gt;
        public static ISqlHelper CreateSqlHelper(string connectionString)
        {
            return CreateSqlHelper(connectionString, true);
        }

        public static ISqlHelper CreateSqlHelper(string connectionString, bool forceLegacyConnection)
        {
            /* check arguments */
            if (string.IsNullOrEmpty(connectionString))
                throw new ArgumentNullException(&quot;connectionString&quot;);

            if (forceLegacyConnection == false &amp;&amp; IsEmbeddedDatabase(connectionString) &amp;&amp; connectionString.ToLower().Contains(&quot;SQLCE4Umbraco&quot;.ToLower()) == false)
            {
                connectionString = connectionString.Replace(&quot;Datasource&quot;, &quot;Data Source&quot;);

                if(connectionString.Contains(@&quot;|\&quot;) == false)
                connectionString = connectionString.Insert(connectionString.LastIndexOf(&#39;|&#39;) + 1, &quot;\\&quot;);

                connectionString = string.Format(&quot;datalayer=SQLCE4Umbraco.SqlCEHelper,SQLCE4Umbraco;{0}&quot;, connectionString);
            }

            /* try to parse connection string */
            var connectionStringBuilder = new DbConnectionStringBuilder();
            try
            {
                connectionStringBuilder.ConnectionString = connectionString;
            }
            catch (Exception ex)
            {
                throw new ArgumentException(&quot;Bad connection string.&quot;, &quot;connectionString&quot;, ex);
            }

            var connectionStringSettings = ConfigurationManager.ConnectionStrings[Umbraco.Core.Configuration.GlobalSettings.UmbracoConnectionName];
            
            if (forceLegacyConnection == false &amp;&amp; connectionStringSettings != null)
                SetDataHelperNames(connectionStringSettings);
            else
                SetDataHelperNamesLegacyConnectionString(connectionStringBuilder);

            /* create the helper */
            // find the right assembly
            var helperAssembly = Assembly.GetExecutingAssembly();
            if (string.IsNullOrWhiteSpace(_dataHelperAssemblyName) == false)
            {
                try
                {
                    helperAssembly = Assembly.Load(_dataHelperAssemblyName);
                }
                catch (Exception exception)
                {
                    throw new UmbracoException(String.Format(&quot;Could not load assembly {0}.&quot;, _dataHelperAssemblyName), exception);
                }
            }

            // find the right type
            Type helperType;
            if (string.IsNullOrWhiteSpace(_dataHelperTypeName))
                _dataHelperTypeName = DefaultDataHelperName;

            if (_dataHelperTypeName.Contains(&quot;.&quot;) == false)
                _dataHelperTypeName = string.Format(DefaultDataHelperFormat, _dataHelperTypeName);

            try
            {
                helperType = helperAssembly.GetType(_dataHelperTypeName, true, true);
            }
            catch (Exception exception)
            {
                throw new UmbracoException(String.Format(&quot;Could not load type {0} ({1}).&quot;, _dataHelperTypeName, helperAssembly.FullName), exception);
            }

            // find the right constructor
            var constructor = helperType.GetConstructor(new[] { typeof(string) });
            if (constructor == null)
                throw new UmbracoException(String.Format(&quot;Could not find constructor that takes a connection string as parameter. ({0}, {1}).&quot;, _dataHelperTypeName, helperAssembly.FullName));

            // finally, return the helper
            try
            {
                return constructor.Invoke(new object[] { _connectionString }) as ISqlHelper;
            }
            catch (Exception exception)
            {
                throw new UmbracoException(String.Format(&quot;Could not execute constructor of type {0} ({1}).&quot;, _dataHelperTypeName, helperAssembly.FullName), exception);
            }
        }

        private static void SetDataHelperNames(ConnectionStringSettings connectionStringSettings)
        {
            _connectionString = connectionStringSettings.ConnectionString;

            var provider = connectionStringSettings.ProviderName;

            if (provider.StartsWith(&quot;MySql&quot;))
            {
                _dataHelperTypeName = &quot;MySql&quot;;
            }

            if (provider.StartsWith(&quot;System.Data.SqlServerCe&quot;))
            {
                _dataHelperTypeName = &quot;SQLCE4Umbraco.SqlCEHelper&quot;;
                _dataHelperAssemblyName = &quot;SQLCE4Umbraco&quot;;
            }
        }

        private static void SetDataHelperNamesLegacyConnectionString(DbConnectionStringBuilder connectionStringBuilder)
        {
            // get the data layer type and parse it
            var datalayerType = String.Empty;
            if (connectionStringBuilder.ContainsKey(ConnectionStringDataLayerIdentifier))
            {
                datalayerType = connectionStringBuilder[ConnectionStringDataLayerIdentifier].ToString();
                connectionStringBuilder.Remove(ConnectionStringDataLayerIdentifier);
            }

            _connectionString = connectionStringBuilder.ConnectionString;

            var datalayerTypeParts = datalayerType.Split(&quot;,&quot;.ToCharArray());

            _dataHelperTypeName = datalayerTypeParts[0].Trim();
            _dataHelperAssemblyName = datalayerTypeParts.Length &lt; 2
                                          ? string.Empty
                                          : datalayerTypeParts[1].Trim();

            if (datalayerTypeParts.Length &gt; 2 || (_dataHelperTypeName.Length == 0 &amp;&amp; _dataHelperAssemblyName.Length &gt; 0))
                throw new ArgumentException(&quot;Illegal format of data layer property. Should be &#39;DataLayer = Full_Type_Name [, Assembly_Name]&#39;.&quot;, &quot;connectionString&quot;);
        }

        public static bool IsEmbeddedDatabase(string connectionString)
        {
            return connectionString.ToLower().Contains(&quot;|DataDirectory|&quot;.ToLower());
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[44,9,44,10,0],[45,13,45,60,0],[46,9,46,10,0],[49,9,49,10,1],[51,13,51,56,1],[52,17,52,69,0],[54,13,54,163,1],[55,13,55,14,1],[56,17,56,90,1],[58,17,58,62,1],[59,17,59,105,1],[61,17,61,125,1],[62,13,62,14,1],[65,13,65,75,1],[67,13,67,14,1],[68,17,68,77,1],[69,13,69,14,1],[70,13,70,33,0],[71,13,71,14,0],[72,17,72,95,0],[75,13,75,148,1],[77,13,77,84,1],[78,17,78,62,1],[80,17,80,83,0],[84,13,84,66,1],[85,13,85,77,1],[86,13,86,14,1],[88,17,88,18,1],[89,21,89,77,1],[90,17,90,18,1],[91,17,91,44,0],[92,17,92,18,0],[93,21,93,131,0],[95,13,95,14,1],[99,13,99,64,1],[100,17,100,61,0],[102,13,102,60,1],[103,17,103,99,0],[106,13,106,14,1],[107,17,107,86,1],[108,13,108,14,1],[109,13,109,40,0],[110,13,110,14,0],[111,17,111,150,0],[115,13,115,83,1],[116,13,116,37,1],[117,17,117,192,0],[121,13,121,14,1],[122,17,122,93,1],[124,13,124,40,0],[125,13,125,14,0],[126,17,126,168,0],[128,9,128,10,1],[131,9,131,10,1],[132,13,132,75,1],[134,13,134,66,1],[136,13,136,46,1],[137,13,137,14,0],[138,17,138,47,0],[139,13,139,14,0],[141,13,141,64,1],[142,13,142,14,1],[143,17,143,67,1],[144,17,144,59,1],[145,13,145,14,1],[146,9,146,10,1],[149,9,149,10,0],[151,13,151,46,0],[152,13,152,90,0],[153,13,153,14,0],[154,17,154,105,0],[155,17,155,85,0],[156,13,156,14,0],[158,13,158,74,0],[160,13,160,77,0],[162,13,162,64,0],[163,13,165,74,0],[167,13,167,122,0],[168,17,168,165,0],[169,9,169,10,0],[172,9,172,10,1],[173,13,173,85,1],[174,9,174,10,1]]);
    </script>
  </body>
</html>