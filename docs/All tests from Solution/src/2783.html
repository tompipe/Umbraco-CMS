<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\tom pipe\documents\hexadigital\code\umbraco\umbraco-cms\src\umbraco.tests.benchmarks\modeltosqlexpressionhelperbenchmarks.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data.SqlServerCe;
using System.Diagnostics;
using System.IO;
using System.Linq.Expressions;
using System.Threading;
using System.Xml;
using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Columns;
using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Diagnosers;
using BenchmarkDotNet.Diagnostics.Windows;
using BenchmarkDotNet.Jobs;
using BenchmarkDotNet.Loggers;
using BenchmarkDotNet.Reports;
using BenchmarkDotNet.Running;
using BenchmarkDotNet.Validators;
using Moq;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Mappers;
using Umbraco.Core.Persistence.Migrations.Initial;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Tests.TestHelpers;
using ILogger = Umbraco.Core.Logging.ILogger;

namespace Umbraco.Tests.Benchmarks
{
    [Config(typeof(Config))]
    public class ModelToSqlExpressionHelperBenchmarks
    {
        private class Config : ManualConfig
        {
            public Config()
            {
                Add(new MemoryDiagnoser());                
            }
        }

        public ModelToSqlExpressionHelperBenchmarks()
        {
            var contentMapper = new ContentMapper(_syntaxProvider);
            contentMapper.BuildMap();
            _cachedExpression = new CachedExpression();
            var mappingResolver = new Mock&lt;MappingResolver&gt;();
            mappingResolver.Setup(resolver =&gt; resolver.ResolveMapperByType(It.IsAny&lt;Type&gt;())).Returns(contentMapper);
            _mappingResolver = mappingResolver.Object;
        }
        
        private readonly ISqlSyntaxProvider _syntaxProvider = new SqlCeSyntaxProvider();
        private readonly CachedExpression _cachedExpression;
        private readonly MappingResolver _mappingResolver;

        [Benchmark(Baseline = true)]
        public void WithNonCached()
        {
            for (int i = 0; i &lt; 100; i++)
            {
                var a = i;
                var b = i*10;
                Expression&lt;Func&lt;IContent, bool&gt;&gt; predicate = content =&gt;
                content.Path.StartsWith(&quot;-1&quot;) &amp;&amp; content.Published &amp;&amp; (content.ContentTypeId == a || content.ContentTypeId == b);

                var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IContent&gt;(_syntaxProvider, _mappingResolver);
                var result = modelToSqlExpressionHelper.Visit(predicate);
            }
            
        }

        

        [Benchmark()]
        public void WithCachedExpression()
        {
            for (int i = 0; i &lt; 100; i++)
            {
                var a = i;
                var b = i * 10;
                Expression&lt;Func&lt;IContent, bool&gt;&gt; predicate = content =&gt;
                content.Path.StartsWith(&quot;-1&quot;) &amp;&amp; content.Published &amp;&amp; (content.ContentTypeId == a || content.ContentTypeId == b);
                
                var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IContent&gt;(_syntaxProvider, _mappingResolver);

                //wrap it!
                _cachedExpression.Wrap(predicate);

                var result = modelToSqlExpressionHelper.Visit(_cachedExpression);
            }
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[39,13,39,28,0],[40,13,40,14,0],[41,17,41,44,0],[42,13,42,14,0],[45,9,45,54,0],[46,9,46,10,0],[47,13,47,68,0],[48,13,48,38,0],[49,13,49,56,0],[50,13,50,63,0],[51,13,51,118,0],[52,13,52,55,0],[53,9,53,10,0],[55,9,55,89,0],[61,9,61,10,0],[62,18,62,27,0],[62,29,62,36,0],[62,38,62,41,0],[63,13,63,14,0],[64,17,64,27,0],[65,17,65,30,0],[66,17,67,130,0],[69,17,69,127,0],[70,17,70,74,0],[71,13,71,14,0],[73,9,73,10,0],[79,9,79,10,0],[80,18,80,27,0],[80,29,80,36,0],[80,38,80,41,0],[81,13,81,14,0],[82,17,82,27,0],[83,17,83,32,0],[84,17,85,130,0],[87,17,87,127,0],[90,17,90,51,0],[92,17,92,82,0],[93,13,93,14,0],[94,9,94,10,0]]);
    </script>
  </body>
</html>