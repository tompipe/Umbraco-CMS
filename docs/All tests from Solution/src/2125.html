<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Logging\AsyncForwardingAppenderBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using log4net.Appender;
using log4net.Core;
using log4net.Util;
using System;
using System.Runtime.Remoting.Messaging;

namespace Umbraco.Core.Logging
{
    /// &lt;summary&gt;
    /// Borrowed from https://github.com/cjbhaines/Log4Net.Async - will reference Nuget packages directly in v8
    /// &lt;/summary&gt;
    public abstract class AsyncForwardingAppenderBase : ForwardingAppender
    {
        #region Private Members

        private const FixFlags DefaultFixFlags = FixFlags.Partial;
        private FixFlags fixFlags = DefaultFixFlags;
        private LoggingEventHelper loggingEventHelper;

        #endregion Private Members

        #region Properties

        public FixFlags Fix
        {
            get { return fixFlags; }
            set { SetFixFlags(value); }
        }

        /// &lt;summary&gt;
        /// Returns HttpContext.Current
        /// &lt;/summary&gt;
        protected internal object HttpContext
        {
            get
            {
                return CallContext.HostContext;
            }
            set
            {
                CallContext.HostContext = value;
            }
        }

        /// &lt;summary&gt;
        /// The logger name that will be used for logging internal errors.
        /// &lt;/summary&gt;
        protected abstract string InternalLoggerName { get; }

        public abstract int? BufferSize { get; set; }

        #endregion Properties

        public override void ActivateOptions()
        {
            base.ActivateOptions();
            loggingEventHelper = new LoggingEventHelper(InternalLoggerName, DefaultFixFlags);
            InitializeAppenders();
        }

        #region Appender Management

        public override void AddAppender(IAppender newAppender)
        {
            base.AddAppender(newAppender);
            SetAppenderFixFlags(newAppender);
        }

        private void SetFixFlags(FixFlags newFixFlags)
        {
            if (newFixFlags != fixFlags)
            {
                loggingEventHelper.Fix = newFixFlags;
                fixFlags = newFixFlags;
                InitializeAppenders();
            }
        }

        private void InitializeAppenders()
        {
            foreach (var appender in Appenders)
            {
                SetAppenderFixFlags(appender);
            }
        }

        private void SetAppenderFixFlags(IAppender appender)
        {
            var bufferingAppender = appender as BufferingAppenderSkeleton;
            if (bufferingAppender != null)
            {
                bufferingAppender.Fix = Fix;
            }
        }

        #endregion Appender Management

        #region Forwarding

        protected void ForwardInternalError(string message, Exception exception, Type thisType)
        {
            LogLog.Error(thisType, message, exception);
            var loggingEvent = loggingEventHelper.CreateLoggingEvent(Level.Error, message, exception);
            ForwardLoggingEvent(loggingEvent, thisType);
        }

        protected void ForwardLoggingEvent(LoggingEvent loggingEvent, Type thisType)
        {
            try
            {
                base.Append(loggingEvent);
            }
            catch (Exception exception)
            {
                LogLog.Error(thisType, &quot;Unable to forward logging event&quot;, exception);
            }
        }

        #endregion Forwarding
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,53,1],[26,17,26,18,1],[26,19,26,35,1],[26,36,26,37,1],[27,17,27,18,0],[27,19,27,38,0],[27,39,27,40,0],[36,13,36,14,1],[37,17,37,48,1],[38,13,38,14,1],[40,13,40,14,1],[41,17,41,49,1],[42,13,42,14,1],[55,9,55,10,1],[56,13,56,36,1],[57,13,57,94,1],[58,13,58,35,1],[59,9,59,10,1],[64,9,64,10,1],[65,13,65,43,1],[66,13,66,46,1],[67,9,67,10,1],[70,9,70,10,0],[71,13,71,41,0],[72,13,72,14,0],[73,17,73,54,0],[74,17,74,40,0],[75,17,75,39,0],[76,13,76,14,0],[77,9,77,10,0],[80,9,80,10,1],[81,13,81,20,1],[81,22,81,34,1],[81,35,81,37,1],[81,38,81,47,1],[82,13,82,14,1],[83,17,83,47,1],[84,13,84,14,1],[85,9,85,10,1],[88,9,88,10,1],[89,13,89,75,1],[90,13,90,43,1],[91,13,91,14,0],[92,17,92,45,0],[93,13,93,14,0],[94,9,94,10,1],[101,9,101,10,1],[102,13,102,56,1],[103,13,103,103,1],[104,13,104,57,1],[105,9,105,10,1],[108,9,108,10,1],[110,13,110,14,1],[111,17,111,43,1],[112,13,112,14,1],[113,13,113,40,0],[114,13,114,14,0],[115,17,115,86,0],[116,13,116,14,0],[117,9,117,10,1]]);
    </script>
  </body>
</html>