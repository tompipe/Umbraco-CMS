<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\users\NodePermissions.ascx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using umbraco.BusinessLogic.Actions;
using System.Collections.Generic;
using umbraco.interfaces;
using System.Drawing;
using umbraco.BusinessLogic;
using umbraco.BasePages;

namespace umbraco.cms.presentation.user
{

    /// &lt;summary&gt;
    /// An object to display the current permissions for a user and a node.
    /// &lt;/summary&gt;
    public partial class NodePermissions : System.Web.UI.UserControl
    {

        protected override void OnInit(EventArgs e) {
            base.OnInit(e);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            DataBind();
        }

        private User m_umbracoUser;
        private int[] m_nodeID = {-1};
        private UserPermissions m_userPermissions;
        private string m_clientItemChecked = &quot;void(0);&quot;;

        public int UserID
        {
            get { return m_umbracoUser.Id; }
            set
            {
                m_umbracoUser = BusinessLogic.User.GetUser(value);
                m_userPermissions = new UserPermissions(m_umbracoUser);
            }
        }

        private bool m_viewOnly = false;
        public bool ViewOnly {
            get { return m_viewOnly; }
            set { m_viewOnly = value; }
        }

        public int[] NodeID
        {
            get { return m_nodeID; }
            set { m_nodeID = value; }
        }

        /// &lt;summary&gt;
        /// The JavaScript method to call when a node is checked. The method will receive a comma separated list of node IDs that are checked.
        /// &lt;/summary&gt;
        public string OnClientItemChecked
        {
            get { return m_clientItemChecked; }
            set { m_clientItemChecked = value; }
        }

        public override void DataBind()
        {
            base.DataBind();
            
            
            if (m_umbracoUser == null)
                throw new ArgumentNullException(&quot;No User specified&quot;);

            //get the logged in user&#39;s permissions
            UserPermissions currUserPermissions = new UserPermissions(UmbracoEnsuredPage.CurrentUser);
            
            //lookup permissions for last node selected
            int selectedNodeId = m_nodeID[m_nodeID.Length - 1];
            
            List&lt;IAction&gt; lstCurrUserActions = currUserPermissions.GetExistingNodePermission(selectedNodeId);
            List&lt;IAction&gt; lstLookupUserActions = m_userPermissions.GetExistingNodePermission(selectedNodeId);
            
            List&lt;IAction&gt; lstAllActions = umbraco.BusinessLogic.Actions.Action.GetPermissionAssignable();

            //no node is selected, disable the check boxes
            if (m_nodeID[0] == -1)
            {
                ShowMessage(&quot;No node selected&quot;);
                return;
            }

            //ensure the current user has access to assign permissions.
            //if their actions list is null then it means that the node is not published.
            if (lstCurrUserActions == null || lstCurrUserActions.Contains(ActionRights.Instance))
                BindExistingPermissions(lstAllActions, lstLookupUserActions);
            else
                ShowMessage(&quot;You do not have access to assign permissions to this node&quot;);

            string names = &quot;&quot;;
            foreach (int id in m_nodeID) {
                if(id &gt; 0)
                    names += new cms.businesslogic.web.Document(id).Text + &quot;, &quot;;
            }

			lt_names.Text = names.Trim().Trim(&#39;,&#39;);
        }

        private void ShowMessage(string msg)
        {
            lblMessage.Visible = true;
            lblMessage.Text = msg;
            
        }

        private void BindExistingPermissions(List&lt;IAction&gt; allActions, List&lt;IAction&gt; userActions)
        {
            
            List&lt;AssignedPermission&gt; assignedPermissions = new List&lt;AssignedPermission&gt;();
            foreach (umbraco.interfaces.IAction a in allActions)
            {
                AssignedPermission p = new AssignedPermission();
                p.Permission = a;
                p.HasPermission = (userActions != null ? userActions.Contains(a) : false);
                assignedPermissions.Add(p);
            }
            
            rptPermissionsList.DataSource = assignedPermissions;
            rptPermissionsList.DataBind();
            
        }        

        protected struct AssignedPermission
        {
            public IAction Permission;
            public bool HasPermission;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,53,27,54,0],[28,13,28,28,0],[29,9,29,10,0],[32,9,32,10,0],[33,13,33,24,0],[34,9,34,10,0],[37,9,37,39,0],[39,9,39,57,0],[43,17,43,18,0],[43,19,43,43,0],[43,44,43,45,0],[45,13,45,14,0],[46,17,46,67,0],[47,17,47,72,0],[48,13,48,14,0],[51,9,51,41,0],[53,17,53,18,0],[53,19,53,37,0],[53,38,53,39,0],[54,17,54,18,0],[54,19,54,38,0],[54,39,54,40,0],[59,17,59,18,0],[59,19,59,35,0],[59,36,59,37,0],[60,17,60,18,0],[60,19,60,36,0],[60,37,60,38,0],[68,17,68,18,0],[68,19,68,46,0],[68,47,68,48,0],[69,17,69,18,0],[69,19,69,47,0],[69,48,69,49,0],[73,9,73,10,0],[74,13,74,29,0],[77,13,77,39,0],[78,17,78,70,0],[81,13,81,103,0],[84,13,84,64,0],[86,13,86,110,0],[87,13,87,110,0],[89,13,89,106,0],[92,13,92,35,0],[93,13,93,14,0],[94,17,94,49,0],[95,17,95,24,0],[100,13,100,98,0],[101,17,101,78,0],[103,17,103,90,0],[105,13,105,31,0],[106,13,106,20,0],[106,22,106,28,0],[106,29,106,31,0],[106,32,106,40,0],[106,42,106,43,0],[107,17,107,27,0],[108,21,108,81,0],[109,13,109,14,0],[111,4,111,43,0],[112,9,112,10,0],[115,9,115,10,0],[116,13,116,39,0],[117,13,117,35,0],[119,9,119,10,0],[122,9,122,10,0],[124,13,124,91,0],[125,13,125,20,0],[125,22,125,50,0],[125,51,125,53,0],[125,54,125,64,0],[126,13,126,14,0],[127,17,127,65,0],[128,17,128,34,0],[129,17,129,91,0],[130,17,130,44,0],[131,13,131,14,0],[133,13,133,65,0],[134,13,134,43,0],[136,9,136,10,0]]);
    </script>
  </body>
</html>