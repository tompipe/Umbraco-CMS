<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\Controllers\InstallPackageController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Web;
using System.Web.Http;
using Newtonsoft.Json.Linq;
using umbraco;
using Umbraco.Core;
using Umbraco.Web.Install.Models;
using Umbraco.Web.WebApi;

namespace Umbraco.Web.Install.Controllers
{
    /// &lt;summary&gt;
	/// A  controller for the installation process regarding packages
	/// &lt;/summary&gt;
	/// &lt;remarks&gt;
	/// Currently this is used for web services however we should/could eventually migrate the whole installer to MVC as it
	/// is a bit of a mess currently.
	/// &lt;/remarks&gt;
	[HttpInstallAuthorize]
    [AngularJsonOnlyConfiguration]
    [Obsolete(&quot;This is only used for the legacy way of installing starter kits in the back office&quot;)]
    public class InstallPackageController : ApiController
	{
		private readonly ApplicationContext _applicationContext;

		public InstallPackageController()
			: this(ApplicationContext.Current)
		{
			
		}

		public InstallPackageController(ApplicationContext applicationContext)
		{
			_applicationContext = applicationContext;
		}

		private const string RepoGuid = &quot;65194810-1f85-11dd-bd0b-0800200c9a66&quot;;

		/// &lt;summary&gt;
		/// Empty action, useful for retrieving the base url for this controller
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		[HttpGet]
        public HttpResponseMessage Index()
		{
			throw new NotImplementedException();
		}

        /// &lt;summary&gt;
        /// Connects to the repo, downloads the package and creates the manifest
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;model&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        public HttpResponseMessage DownloadPackageFiles(InstallPackageModel model)
		{
			var repo = global::umbraco.cms.businesslogic.packager.repositories.Repository.getByGuid(RepoGuid);
            if (repo == null)
            {
                return Json(
                    new {success = false, error = &quot;No repository found with id &quot; + RepoGuid},
                    HttpStatusCode.OK);
            }
			if (repo.HasConnection() == false)
			{
                return Json(
                    new { success = false, error = &quot;cannot_connect&quot; },
                    HttpStatusCode.OK);
			}
			var installer = new global::umbraco.cms.businesslogic.packager.Installer(UmbracoContext.Current.Security.CurrentUser.Id);

            var tempFile = installer.Import(repo.fetch(model.KitGuid.ToString(), UmbracoContext.Current.Security.CurrentUser.Id));
			installer.LoadConfig(tempFile);
            var pId = installer.CreateManifest(tempFile, model.KitGuid.ToString(), RepoGuid);
			return Json(new
				{
					success = true,
					manifestId = pId,
					packageFile = tempFile,
					percentage = 10,
					message = &quot;Downloading starter kit files...&quot;
				}, HttpStatusCode.OK);
		}

		/// &lt;summary&gt;
		/// Installs the files in the package
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		[HttpPost]
        public HttpResponseMessage InstallPackageFiles(InstallPackageModel model)
		{
            model.PackageFile = HttpUtility.UrlDecode(model.PackageFile);
            var installer = new global::umbraco.cms.businesslogic.packager.Installer(UmbracoContext.Current.Security.CurrentUser.Id);
            installer.LoadConfig(model.PackageFile);
            installer.InstallFiles(model.ManifestId, model.PackageFile);
			return Json(new
				{
					success = true,
                    model.ManifestId,
                    model.PackageFile,
					percentage = 20,
					message = &quot;Installing starter kit files&quot;
				}, HttpStatusCode.OK);
		}

		/// &lt;summary&gt;
		/// Ensures the app pool is restarted
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		[HttpPost]
        public HttpResponseMessage RestartAppPool()
		{
			_applicationContext.RestartApplicationPool(Request.TryGetHttpContext().Result);
			return Json(new
				{
					success = true,
					percentage = 25,
					message = &quot;Installing starter kit files&quot;
				}, HttpStatusCode.OK);
		}

		/// &lt;summary&gt;
		/// Checks if the app pool has completed restarted
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		[HttpPost]
        public HttpResponseMessage CheckAppPoolRestart()
		{
            if (Request.TryGetHttpContext().Result.Application.AllKeys.Contains(&quot;AppPoolRestarting&quot;))
			{
                return Request.CreateResponse(HttpStatusCode.BadRequest);
			}

			return Json(new
				{					
					percentage = 30,
                    success = true,
				}, HttpStatusCode.OK);
		}

		/// &lt;summary&gt;
		/// Installs the business logic portion of the package after app restart
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		[HttpPost]
        public HttpResponseMessage InstallBusinessLogic(InstallPackageModel model)
		{
            model.PackageFile = HttpUtility.UrlDecode(model.PackageFile);
            var installer = new global::umbraco.cms.businesslogic.packager.Installer(UmbracoContext.Current.Security.CurrentUser.Id);
            installer.LoadConfig(model.PackageFile);
            installer.InstallBusinessLogic(model.ManifestId, model.PackageFile);
			return Json(new
			{
				success = true,
                model.ManifestId,
                model.PackageFile,
				percentage = 70,
				message = &quot;Installing starter kit files&quot;
			}, HttpStatusCode.OK);
		}

		/// &lt;summary&gt;
		/// Cleans up the package installation
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		[HttpPost]
        public HttpResponseMessage CleanupInstallation(InstallPackageModel model)
		{
            model.PackageFile = HttpUtility.UrlDecode(model.PackageFile);
            var installer = new global::umbraco.cms.businesslogic.packager.Installer(UmbracoContext.Current.Security.CurrentUser.Id);
            installer.LoadConfig(model.PackageFile);
            installer.InstallCleanUp(model.ManifestId, model.PackageFile);

			library.RefreshContent();

			return Json(new
			{
				success = true,
                model.ManifestId,
                model.PackageFile,
				percentage = 100,
				message = &quot;Starter kit has been installed&quot;
			}, HttpStatusCode.OK);
		}

        private HttpResponseMessage Json(object jsonObject, HttpStatusCode status)
        {
            var response = Request.CreateResponse(status);
            var json = JObject.FromObject(jsonObject);
            response.Content = new StringContent(json.ToString(), Encoding.UTF8, &quot;application/json&quot;);
            return response;
        }
	}

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,6,31,38,0],[32,3,32,4,0],[34,3,34,4,0],[36,3,36,73,0],[37,3,37,4,0],[38,4,38,45,0],[39,3,39,4,0],[49,3,49,4,0],[50,4,50,40,0],[60,3,60,4,0],[61,4,61,102,0],[62,13,62,30,0],[63,13,63,14,0],[64,17,66,40,0],[68,4,68,38,0],[69,4,69,5,0],[70,17,72,40,0],[74,4,74,125,0],[76,13,76,131,0],[77,4,77,35,0],[78,13,78,94,0],[79,4,86,27,0],[87,3,87,4,0],[95,3,95,4,0],[96,13,96,74,0],[97,13,97,134,0],[98,13,98,53,0],[99,13,99,73,0],[100,4,107,27,0],[108,3,108,4,0],[116,3,116,4,0],[117,4,117,83,0],[118,4,123,27,0],[124,3,124,4,0],[132,3,132,4,0],[133,13,133,102,0],[134,4,134,5,0],[135,17,135,74,0],[138,4,142,27,0],[143,3,143,4,0],[151,3,151,4,0],[152,13,152,74,0],[153,13,153,134,0],[154,13,154,53,0],[155,13,155,81,0],[156,4,163,26,0],[164,3,164,4,0],[172,3,172,4,0],[173,13,173,74,0],[174,13,174,134,0],[175,13,175,53,0],[176,13,176,75,0],[178,4,178,29,0],[180,4,187,26,0],[188,3,188,4,0],[191,9,191,10,0],[192,13,192,59,0],[193,13,193,55,0],[194,13,194,102,0],[195,13,195,29,0],[196,9,196,10,0]]);
    </script>
  </body>
</html>