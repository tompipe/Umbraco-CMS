<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\Search\QuickSearchHandler.ashx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Services;
using System.Web.Services.Protocols;
using System.Xml.Linq;
using System.Collections.Generic;
using UmbracoExamine;
using System.Web.Script.Serialization;
using Examine;
using Examine.LuceneEngine.SearchCriteria;
using Umbraco.Core;

namespace umbraco.presentation.umbraco.Search
{
    /// &lt;summary&gt;
    /// Summary description for $codebehindclassname$
    /// &lt;/summary&gt;
    [WebService(Namespace = &quot;http://tempuri.org/&quot;)]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    [Obsolete(&quot;This is not used and will be removed in the future&quot;)]
    public class QuickSearchHandler : IHttpHandler
    {

        public void ProcessRequest(HttpContext context)
        {
            Authorize();

            context.Response.ContentType = &quot;application/json&quot;;

            var txt = UmbracoContext.Current.Request[&quot;q&quot;].ToLower();

            //the app can be Content or Media only, otherwise an exception will be thrown
            var app = UmbracoExamine.IndexTypes.Content;
            if (!string.IsNullOrEmpty(UmbracoContext.Current.Request[&quot;app&quot;]))
            {
                app = UmbracoContext.Current.Request[&quot;app&quot;].ToLower();
            }
            
            int limit;
            if (!int.TryParse(UmbracoContext.Current.Request[&quot;limit&quot;], out limit))
            {
                limit = 100;
            }
            
            //if it doesn&#39;t start with &quot;*&quot;, then search only nodeName and nodeId
            var internalSearcher = (app == Constants.Applications.Members)
                ? UmbracoContext.Current.InternalMemberSearchProvider 
                : UmbracoContext.Current.InternalSearchProvider;

            //create some search criteria, make everything combined to be &#39;And&#39; and only search the current app
            var criteria = internalSearcher.CreateSearchCriteria(app, Examine.SearchCriteria.BooleanOperation.And);

            IEnumerable&lt;SearchResult&gt; results;
            if (txt.StartsWith(&quot;*&quot;))
            {
                //if it starts with * then search all fields
                results = internalSearcher.Search(txt.Substring(1), true);
            }
            else
            {
				var words = txt.Split(new[] { &#39; &#39; }, StringSplitOptions.RemoveEmptyEntries).Select(w =&gt; w.ToLower().MultipleCharacterWildcard()).ToList();
                var operation = criteria.GroupedOr(new[] { &quot;__nodeName&quot;, &quot;__NodeId&quot;, &quot;id&quot; }, new[] { words[0] });
				words.RemoveAt(0);
				foreach (var word in words)
					operation = operation.And().GroupedOr(new[] { &quot;__nodeName&quot; }, new[] { word });

                // ensure the user can only find nodes they are allowed to see
                if (UmbracoContext.Current.UmbracoUser.StartNodeId &gt; 0)
                {
                    operation = operation.And().Id(UmbracoContext.Current.UmbracoUser.StartNodeId);
                }

                results = internalSearcher.Search(operation.Compile());
            }

            JavaScriptSerializer js = new JavaScriptSerializer();
            context.Response.Write(js.Serialize(results.Take(limit)));
        }

        public static void Authorize()
        {
            if (!BasePages.BasePage.ValidateUserContextID(BasePages.BasePage.umbracoUserContextID))
                throw new Exception(&quot;Client authorization failed. User is not logged in&quot;);

        }

        public bool IsReusable
        {
            get
            {
                return false;
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[29,13,29,25,0],[31,13,31,63,0],[33,13,33,69,0],[36,13,36,57,0],[37,13,37,78,0],[38,13,38,14,0],[39,17,39,71,0],[40,13,40,14,0],[43,13,43,83,0],[44,13,44,14,0],[45,17,45,29,0],[46,13,46,14,0],[49,13,51,65,0],[54,13,54,116,0],[57,13,57,37,0],[58,13,58,14,0],[60,17,60,75,0],[61,13,61,14,0],[63,13,63,14,0],[64,5,64,93,0],[64,93,64,132,0],[64,132,64,143,0],[64,5,64,143,0],[65,17,65,114,0],[66,5,66,23,0],[67,5,67,12,0],[67,14,67,22,0],[67,23,67,25,0],[67,26,67,31,0],[68,6,68,84,0],[71,17,71,72,0],[72,17,72,18,0],[73,21,73,100,0],[74,17,74,18,0],[76,17,76,72,0],[77,13,77,14,0],[79,13,79,66,0],[80,13,80,71,0],[81,9,81,10,0],[84,9,84,10,0],[85,13,85,100,0],[86,17,86,91,0],[88,9,88,10,0],[93,13,93,14,0],[94,17,94,30,0],[95,13,95,14,0]]);
    </script>
  </body>
</html>