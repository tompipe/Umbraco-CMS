<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\EnsurePartialViewMacroViewContextFilterAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.IO;
using System.Web.Mvc;

namespace Umbraco.Web.Mvc
{
    /// &lt;summary&gt;
    /// This is a special filter which is required for the RTE to be able to render Partial View Macros that 
    /// contain forms when the RTE value is resolved outside of an MVC view being rendered
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// The entire way that we support partial view macros that contain forms isn&#39;t really great, these forms
    /// need to be executed as ChildActions so that the ModelState,ViewData,TempData get merged into that action
    /// so the form can show errors, viewdata, etc...
    /// Under normal circumstances, macros will be rendered after a ViewContext is created but in some cases 
    /// developers will resolve the RTE value in the controller, in this case the Form won&#39;t be rendered correctly
    /// with merged ModelState from the controller because the special DataToken hasn&#39;t been set yet (which is 
    /// normally done in the UmbracoViewPageOfModel when a real ViewContext is available.
    /// So we need to detect if the currently rendering controller is IRenderController and if so we&#39;ll ensure that
    /// this DataToken exists before the action executes in case the developer resolves an RTE value that contains
    /// a partial view macro form.
    /// &lt;/remarks&gt;
    internal class EnsurePartialViewMacroViewContextFilterAttribute : ActionFilterAttribute
    {
        /// &lt;summary&gt;
        /// Ensures the custom ViewContext datatoken is set before the RenderController action is invoked,
        /// this ensures that any calls to GetPropertyValue with regards to RTE or Grid editors can still
        /// render any PartialViewMacro with a form and maintain ModelState
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;filterContext&quot;&gt;&lt;/param&gt;
        public override void OnActionExecuting(ActionExecutingContext filterContext)
        {
            //ignore anything that is not IRenderController
            if ((filterContext.Controller is IRenderController) == false &amp;&amp; filterContext.IsChildAction == false)
                return;

            SetViewContext(filterContext);
        }

        /// &lt;summary&gt;
        /// Ensures that the custom ViewContext datatoken is set after the RenderController action is invoked,
        /// this ensures that any custom ModelState that may have been added in the RenderController itself is 
        /// passed onwards in case it is required when rendering a PartialViewMacro with a form
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;filterContext&quot;&gt;The filter context.&lt;/param&gt;
        public override void OnResultExecuting(ResultExecutingContext filterContext)
        {
            //ignore anything that is not IRenderController
            if ((filterContext.Controller is IRenderController) == false &amp;&amp; filterContext.IsChildAction == false)
                return;

            SetViewContext(filterContext);
        }

        private void SetViewContext(ControllerContext controllerContext)
        {
            var viewCtx = new ViewContext(
                controllerContext,
                new DummyView(),
                controllerContext.Controller.ViewData, controllerContext.Controller.TempData,
                new StringWriter());

            //set the special data token
            controllerContext.RequestContext.RouteData.DataTokens[Constants.DataTokenCurrentViewContext] = viewCtx;
        }

        private class DummyView : IView
        {
            public void Render(ViewContext viewContext, TextWriter writer)
            {
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,10,0],[33,13,33,114,0],[34,17,34,24,0],[36,13,36,43,0],[37,9,37,10,0],[46,9,46,10,0],[48,13,48,114,0],[49,17,49,24,0],[51,13,51,43,0],[52,9,52,10,0],[55,9,55,10,0],[56,13,60,37,0],[63,13,63,116,0],[64,9,64,10,0],[69,13,69,14,0],[70,13,70,14,0]]);
    </script>
  </body>
</html>