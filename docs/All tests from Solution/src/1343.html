<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\ContentTypeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Net;
using System.Web.Http;
using AutoMapper;
using Umbraco.Core.Models;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Mvc;
using Constants = Umbraco.Core.Constants;
using Umbraco.Core.Services;
using Umbraco.Core.PropertyEditors;
using System.Net.Http;
using umbraco;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Core.Strings;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebApi.Filters;
using Umbraco.Core.Logging;
using Umbraco.Web.Models;

namespace Umbraco.Web.Editors
{
    //TODO:  We&#39;ll need to be careful about the security on this controller, when we start implementing
    // methods to modify content types we&#39;ll need to enforce security on the individual methods, we
    // cannot put security on the whole controller because things like
    //  GetAllowedChildren, GetPropertyTypeScaffold, GetAllPropertyTypeAliases are required for content editing.

    /// &lt;summary&gt;
    /// An API controller used for dealing with content types
    /// &lt;/summary&gt;
    [PluginController(&quot;UmbracoApi&quot;)]
    [UmbracoTreeAuthorize(Constants.Trees.DocumentTypes)]
    [EnableOverrideAuthorization]
    public class ContentTypeController : ContentTypeControllerBase
    {
        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        public ContentTypeController()
            : this(UmbracoContext.Current)
        {
        }

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        public ContentTypeController(UmbracoContext umbracoContext)
            : base(umbracoContext)
        {
        }

        public int GetCount()
        {
            return Services.ContentTypeService.CountContentTypes();
        }

        public DocumentTypeDisplay GetById(int id)
        {
            var ct = Services.ContentTypeService.GetContentType(id);
            if (ct == null)
            {
                throw new HttpResponseException(HttpStatusCode.NotFound);
            }

            var dto = Mapper.Map&lt;IContentType, DocumentTypeDisplay&gt;(ct);
            return dto;
        }

        /// &lt;summary&gt;
        /// Deletes a document type wth a given ID
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpDelete]
        [HttpPost]
        public HttpResponseMessage DeleteById(int id)
        {
            var foundType = Services.ContentTypeService.GetContentType(id);
            if (foundType == null)
            {
                throw new HttpResponseException(HttpStatusCode.NotFound);
            }

            Services.ContentTypeService.Delete(foundType, Security.CurrentUser.Id);
            return Request.CreateResponse(HttpStatusCode.OK);
        }

        /// &lt;summary&gt;
        /// Gets all user defined properties.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [UmbracoTreeAuthorize(
            Constants.Trees.DocumentTypes, Constants.Trees.Content,
            Constants.Trees.MediaTypes, Constants.Trees.Media,
            Constants.Trees.MemberTypes, Constants.Trees.Members)]
        public IEnumerable&lt;string&gt; GetAllPropertyTypeAliases()
        {
            return ApplicationContext.Services.ContentTypeService.GetAllPropertyTypeAliases();
        }

        /// &lt;summary&gt;
        /// Returns the avilable compositions for this content type
        /// This has been wrapped in a dto instead of simple parameters to support having multiple parameters in post request body
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentTypeId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;filterContentTypes&quot;&gt;
        /// This is normally an empty list but if additional content type aliases are passed in, any content types containing those aliases will be filtered out
        /// along with any content types that have matching property types that are included in the filtered content types
        /// &lt;/param&gt;
        /// &lt;param name=&quot;filterPropertyTypes&quot;&gt;
        /// This is normally an empty list but if additional property type aliases are passed in, any content types that have these aliases will be filtered out.
        /// This is required because in the case of creating/modifying a content type because new property types being added to it are not yet persisted so cannot
        /// be looked up via the db, they need to be passed in.
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        public HttpResponseMessage GetAvailableCompositeContentTypes(GetAvailableCompositionsFilter filter)
        {
            var result = PerformGetAvailableCompositeContentTypes(filter.ContentTypeId, UmbracoObjectTypes.DocumentType, filter.FilterContentTypes, filter.FilterPropertyTypes)
                .Select(x =&gt; new
                {
                    contentType = x.Item1,
                    allowed = x.Item2
                });
            return Request.CreateResponse(result);
        }

        [UmbracoTreeAuthorize(
            Constants.Trees.DocumentTypes, Constants.Trees.Content,
            Constants.Trees.MediaTypes, Constants.Trees.Media,
            Constants.Trees.MemberTypes, Constants.Trees.Members)]
        public ContentPropertyDisplay GetPropertyTypeScaffold(int id)
        {
            var dataTypeDiff = Services.DataTypeService.GetDataTypeDefinitionById(id);

            if (dataTypeDiff == null)
            {
                throw new HttpResponseException(HttpStatusCode.NotFound);
            }

            var preVals = UmbracoContext.Current.Application.Services.DataTypeService.GetPreValuesCollectionByDataTypeId(id);
            var editor = PropertyEditorResolver.Current.GetByAlias(dataTypeDiff.PropertyEditorAlias);

            return new ContentPropertyDisplay()
            {
                Editor = dataTypeDiff.PropertyEditorAlias,
                Validation = new PropertyTypeValidation() { },
                View = editor.ValueEditor.View,
                Config = editor.PreValueEditor.ConvertDbToEditor(editor.DefaultPreValues, preVals)
            };
        }

        /// &lt;summary&gt;
        /// Deletes a document type container wth a given ID
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpDelete]
        [HttpPost]
        public HttpResponseMessage DeleteContainer(int id)
        {
            Services.ContentTypeService.DeleteContentTypeContainer(id, Security.CurrentUser.Id);

            return Request.CreateResponse(HttpStatusCode.OK);
        }

        public HttpResponseMessage PostCreateContainer(int parentId, string name)
        {
            var result = Services.ContentTypeService.CreateContentTypeContainer(parentId, name, Security.CurrentUser.Id);

            return result
                ? Request.CreateResponse(HttpStatusCode.OK, result.Result) //return the id
                : Request.CreateNotificationValidationErrorResponse(result.Exception.Message);
        }

        public DocumentTypeDisplay PostSave(DocumentTypeSave contentTypeSave)
        {
            var savedCt = PerformPostSave&lt;IContentType, DocumentTypeDisplay, DocumentTypeSave, PropertyTypeBasic&gt;(
                contentTypeSave:    contentTypeSave,
                getContentType:     i =&gt; Services.ContentTypeService.GetContentType(i),
                saveContentType:    type =&gt; Services.ContentTypeService.Save(type),
                beforeCreateNew:    ctSave =&gt;
                {
                    //create a default template if it doesnt exist -but only if default template is == to the content type
                    if (ctSave.DefaultTemplate.IsNullOrWhiteSpace() == false &amp;&amp; ctSave.DefaultTemplate == ctSave.Alias)
                    {
                        var template = Services.FileService.GetTemplate(ctSave.Alias);
                        if (template == null)
                        {
                            var tryCreateTemplate = Services.FileService.CreateTemplateForContentType(ctSave.Alias, ctSave.Name);
                            if (tryCreateTemplate == false)
                            {
                                Logger.Warn&lt;ContentTypeController&gt;(
                                    &quot;Could not create a template for the Content Type: {0}, status: {1}&quot;,
                                    () =&gt; ctSave.Alias,
                                    () =&gt; tryCreateTemplate.Result.StatusType);
                            }
                            template = tryCreateTemplate.Result.Entity;
                        }

                        //make sure the template alias is set on the default and allowed template so we can map it back
                        ctSave.DefaultTemplate = template.Alias;

                    }
                });

            var display = Mapper.Map&lt;DocumentTypeDisplay&gt;(savedCt);

            display.AddSuccessNotification(
                            Services.TextService.Localize(&quot;speechBubbles/contentTypeSavedHeader&quot;),
                            string.Empty);

            return display;
        }

        /// &lt;summary&gt;
        /// Returns an empty content type for use as a scaffold when creating a new type
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public DocumentTypeDisplay GetEmpty(int parentId)
        {
            IContentType ct;
            if (parentId != Constants.System.Root)
            {
                var parent = Services.ContentTypeService.GetContentType(parentId);
                ct = parent != null ? new ContentType(parent, string.Empty) : new ContentType(parentId);
            }
            else
                ct = new ContentType(parentId);

            ct.Icon = &quot;icon-document&quot;;

            var dto = Mapper.Map&lt;IContentType, DocumentTypeDisplay&gt;(ct);
            return dto;
        }


        /// &lt;summary&gt;
        /// Returns all content type objects
        /// &lt;/summary&gt;
        public IEnumerable&lt;ContentTypeBasic&gt; GetAll()
        {
            var types = Services.ContentTypeService.GetAllContentTypes();
            var basics = types.Select(Mapper.Map&lt;IContentType, ContentTypeBasic&gt;);

            return basics.Select(basic =&gt;
            {
                basic.Name = TranslateItem(basic.Name);
                basic.Description = TranslateItem(basic.Description);
                return basic;
            });
        }

        /// &lt;summary&gt;
        /// Returns the allowed child content type objects for the content item id passed in
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentId&quot;&gt;&lt;/param&gt;
        [UmbracoTreeAuthorize(Constants.Trees.DocumentTypes, Constants.Trees.Content)]
        public IEnumerable&lt;ContentTypeBasic&gt; GetAllowedChildren(int contentId)
        {
            if (contentId == Constants.System.RecycleBinContent)
                return Enumerable.Empty&lt;ContentTypeBasic&gt;();

            IEnumerable&lt;IContentType&gt; types;
            if (contentId == Constants.System.Root)
            {
                types = Services.ContentTypeService.GetAllContentTypes().ToList();

                //if no allowed root types are set, just return everything
                if (types.Any(x =&gt; x.AllowedAsRoot))
                    types = types.Where(x =&gt; x.AllowedAsRoot);
            }
            else
            {
                var contentItem = Services.ContentService.GetById(contentId);
                if (contentItem == null)
                {
                    return Enumerable.Empty&lt;ContentTypeBasic&gt;();
                }

                var ids = contentItem.ContentType.AllowedContentTypes.Select(x =&gt; x.Id.Value).ToArray();

                if (ids.Any() == false) return Enumerable.Empty&lt;ContentTypeBasic&gt;();

                types = Services.ContentTypeService.GetAllContentTypes(ids).ToList();
            }

            var basics = types.Select(Mapper.Map&lt;IContentType, ContentTypeBasic&gt;).ToList();

            var localizedTextService = Services.TextService;
            foreach (var basic in basics)
            {
                basic.Name = localizedTextService.UmbracoDictionaryTranslate(basic.Name);
                basic.Description = localizedTextService.UmbracoDictionaryTranslate(basic.Description);
            }

            return basics;
        }

        /// &lt;summary&gt;
        /// Move the content type
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;move&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public HttpResponseMessage PostMove(MoveOrCopy move)
        {
            return PerformMove(
                move,
                getContentType: i =&gt; Services.ContentTypeService.GetContentType(i),
                doMove: (type, i) =&gt; Services.ContentTypeService.MoveContentType(type, i));
        }

        /// &lt;summary&gt;
        /// Copy the content type
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;copy&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public HttpResponseMessage PostCopy(MoveOrCopy copy)
        {
            return PerformCopy(
                copy,
                getContentType: i =&gt; Services.ContentTypeService.GetContentType(i),
                doCopy: (type, i) =&gt; Services.ContentTypeService.CopyContentType(type, i));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[43,15,43,43,0],[44,9,44,10,0],[45,9,45,10,0],[52,15,52,35,0],[53,9,53,10,0],[54,9,54,10,0],[57,9,57,10,0],[58,13,58,68,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,69,0],[64,13,64,28,0],[65,13,65,14,0],[66,17,66,74,0],[69,13,69,73,0],[70,13,70,24,0],[71,9,71,10,0],[81,9,81,10,0],[82,13,82,76,0],[83,13,83,35,0],[84,13,84,14,0],[85,17,85,74,0],[88,13,88,84,0],[89,13,89,62,0],[90,9,90,10,0],[101,9,101,10,0],[102,13,102,95,0],[103,9,103,10,0],[122,9,122,10,0],[123,13,124,30,0],[124,30,128,18,0],[128,18,128,20,0],[123,13,128,20,0],[129,13,129,51,0],[130,9,130,10,0],[137,9,137,10,0],[138,13,138,87,0],[140,13,140,38,0],[141,13,141,14,0],[142,17,142,74,0],[145,13,145,126,0],[146,13,146,102,0],[148,13,154,15,0],[155,9,155,10,0],[165,9,165,10,0],[166,13,166,97,0],[168,13,168,62,0],[169,9,169,10,0],[172,9,172,10,0],[173,13,173,122,0],[175,13,177,95,0],[178,9,178,10,0],[181,9,181,10,0],[182,13,184,42,0],[184,42,184,87,0],[184,87,185,45,0],[185,45,185,83,0],[185,83,187,17,0],[187,17,187,18,0],[187,18,189,21,0],[189,21,189,120,0],[189,120,190,21,0],[190,21,190,22,0],[190,22,191,25,0],[191,25,191,87,0],[191,87,192,25,0],[192,25,192,46,0],[192,46,193,25,0],[193,25,193,26,0],[193,26,194,29,0],[194,29,194,130,0],[194,130,195,29,0],[195,29,195,60,0],[195,60,196,29,0],[196,29,196,30,0],[196,30,197,33,0],[197,33,199,43,0],[199,43,199,55,0],[199,55,200,43,0],[200,43,200,78,0],[200,78,200,80,0],[197,33,200,80,0],[200,80,201,29,0],[201,29,201,30,0],[201,30,202,29,0],[202,29,202,72,0],[202,72,203,25,0],[203,25,203,26,0],[203,26,206,25,0],[206,25,206,65,0],[206,65,208,21,0],[208,21,208,22,0],[208,22,209,17,0],[209,17,209,18,0],[209,18,209,20,0],[182,13,209,20,0],[211,13,211,68,0],[213,13,215,43,0],[217,13,217,28,0],[218,9,218,10,0],[226,9,226,10,0],[228,13,228,51,0],[229,13,229,14,0],[230,17,230,83,0],[231,17,231,105,0],[232,13,232,14,0],[234,17,234,48,0],[236,13,236,39,0],[238,13,238,73,0],[239,13,239,24,0],[240,9,240,10,0],[247,9,247,10,0],[248,13,248,74,0],[249,13,249,83,0],[251,13,252,13,0],[252,13,252,14,0],[252,14,253,17,0],[253,17,253,56,0],[253,56,254,17,0],[254,17,254,70,0],[254,70,255,17,0],[255,17,255,30,0],[255,30,256,13,0],[256,13,256,14,0],[256,14,256,16,0],[251,13,256,16,0],[257,9,257,10,0],[265,9,265,10,0],[266,13,266,65,0],[267,17,267,61,0],[270,13,270,52,0],[271,13,271,14,0],[272,17,272,83,0],[275,17,275,36,0],[275,36,275,51,0],[275,51,275,53,0],[275,17,275,53,0],[276,21,276,46,0],[276,46,276,61,0],[276,61,276,63,0],[276,21,276,63,0],[277,13,277,14,0],[279,13,279,14,0],[280,17,280,78,0],[281,17,281,41,0],[282,17,282,18,0],[283,21,283,65,0],[286,17,286,83,0],[286,83,286,93,0],[286,93,286,105,0],[286,17,286,105,0],[288,17,288,40,0],[288,41,288,85,0],[290,17,290,86,0],[291,13,291,14,0],[293,13,293,92,0],[295,13,295,61,0],[296,13,296,20,0],[296,22,296,31,0],[296,32,296,34,0],[296,35,296,41,0],[297,13,297,14,0],[298,17,298,90,0],[299,17,299,104,0],[300,13,300,14,0],[302,13,302,27,0],[303,9,303,10,0],[311,9,311,10,0],[312,13,314,38,0],[314,38,314,83,0],[314,83,315,38,0],[315,38,315,90,0],[315,90,315,92,0],[312,13,315,92,0],[316,9,316,10,0],[324,9,324,10,0],[325,13,327,38,0],[327,38,327,83,0],[327,83,328,38,0],[328,38,328,90,0],[328,90,328,92,0],[325,13,328,92,0],[329,9,329,10,0]]);
    </script>
  </body>
</html>