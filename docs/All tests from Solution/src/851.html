<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Strategies\Migrations\OverwriteStylesheetFilesFromTempFiles.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Umbraco.Core.Events;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence.Migrations;

namespace Umbraco.Web.Strategies.Migrations
{

    /// &lt;summary&gt;
    /// When upgrading version 7.3 the migration MigrateStylesheetDataToFile will execute but we don&#39;t want to overwrite the developers
    /// files during the migration since other parts of the migration might fail. So once the migration is complete, we&#39;ll then copy over the temp
    /// files that this migration created over top of the developer&#39;s files. We&#39;ll also create a backup of their files.
    /// &lt;/summary&gt;
    public sealed class OverwriteStylesheetFilesFromTempFiles : MigrationStartupHander
    {
        protected override void AfterMigration(MigrationRunner sender, MigrationEventArgs e)
        {
            if (e.ProductName != GlobalSettings.UmbracoMigrationName) return;

            var target73 = new Version(7, 3, 0);

            if (e.ConfiguredVersion &lt;= target73)
            {
                var tempCssFolder = IOHelper.MapPath(&quot;~/App_Data/TEMP/CssMigration/&quot;);
                var cssFolder = IOHelper.MapPath(&quot;~/css&quot;);
                if (Directory.Exists(tempCssFolder))
                {
                    var files = Directory.GetFiles(tempCssFolder, &quot;*.css&quot;, SearchOption.AllDirectories);
                    foreach (var file in files)
                    {
                        var relativePath = file.TrimStart(tempCssFolder).TrimStart(&quot;\\&quot;);
                        var cssFilePath = Path.Combine(cssFolder, relativePath);
                        if (File.Exists(cssFilePath))
                        {
                            //backup
                            var targetPath = Path.Combine(tempCssFolder, relativePath.EnsureEndsWith(&quot;.bak&quot;));
                            e.MigrationContext.Logger.Info&lt;OverwriteStylesheetFilesFromTempFiles&gt;(&quot;CSS file is being backed up from {0}, to {1} before being migrated to new format&quot;, () =&gt; cssFilePath, () =&gt; targetPath);
                            File.Copy(cssFilePath, targetPath, true);
                        }

                        //ensure the sub folder eixts
                        Directory.CreateDirectory(Path.GetDirectoryName(cssFilePath));
                        File.Copy(file, cssFilePath, true);
                    }
                }
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,0],[26,13,26,70,0],[26,71,26,78,0],[28,13,28,49,0],[30,13,30,49,0],[31,13,31,14,0],[32,17,32,87,0],[33,17,33,59,0],[34,17,34,53,0],[35,17,35,18,0],[36,21,36,105,0],[37,21,37,28,0],[37,30,37,38,0],[37,39,37,41,0],[37,42,37,47,0],[38,21,38,22,0],[39,25,39,90,0],[40,25,40,81,0],[41,25,41,54,0],[42,25,42,26,0],[44,29,44,111,0],[45,29,45,189,0],[45,189,45,200,0],[45,200,45,208,0],[45,208,45,218,0],[45,218,45,220,0],[45,29,45,220,0],[46,29,46,70,0],[47,25,47,26,0],[50,25,50,87,0],[51,25,51,60,0],[52,21,52,22,0],[53,17,53,18,0],[54,13,54,14,0],[55,9,55,10,0]]);
    </script>
  </body>
</html>