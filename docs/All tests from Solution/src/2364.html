<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\UmbracoExamine\DataServices\UmbracoContentService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security;
using System.Text;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Core.Services;
using umbraco;
using System.Xml.Linq;
using System.Xml;
using umbraco.cms.businesslogic.web;
using System.Collections;
using System.Xml.XPath;
using umbraco.DataLayer;
using umbraco.BusinessLogic;
using UmbracoExamine.Config;
using Examine.LuceneEngine;
using System.Data.SqlClient;
using System.Diagnostics;

namespace UmbracoExamine.DataServices
{
    public class UmbracoContentService : IContentService
    {

        private readonly ApplicationContext _applicationContext;

		public UmbracoContentService()
			: this(ApplicationContext.Current)
		{

		}

        public UmbracoContentService(ApplicationContext applicationContext)
		{
            _applicationContext = applicationContext;
		}

        /// &lt;summary&gt;
        /// removes html markup from a string
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;value&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
		public string StripHtml(string value)
        {
			return value.StripHtml();
        }

        /// &lt;summary&gt;
        /// Gets published content by xpath
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xpath&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
		public XDocument GetPublishedContentByXPath(string xpath)
        {
			//TODO: Remove the need for this, the best way would be to remove all requirements of examine based on Xml but that
			// would take some time. Another way in the in-term would be to add a static delegate to this class which can be set
			// on the WebBootManager to set how to get the XmlNodeByXPath but that is still ugly :(
            return LegacyLibrary.GetXmlNodeByXPath(xpath).ToXDocument();
        }

        /// &lt;summary&gt;
        /// This is quite an intensive operation...
        /// get all root content, then get the XML structure for all children,
        /// then run xpath against the navigator that&#39;s created
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xpath&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;This should no longer be used, latest content will be indexed by using the IContentService directly&quot;)]
		public XDocument GetLatestContentByXPath(string xpath)
        {
            var xmlContent = XDocument.Parse(&quot;&lt;content&gt;&lt;/content&gt;&quot;);
            foreach (var c in _applicationContext.Services.ContentService.GetRootContent())
            {
                xmlContent.Root.Add(c.ToDeepXml(_applicationContext.Services.PackagingService));				
            }
            var result = ((IEnumerable)xmlContent.XPathEvaluate(xpath)).Cast&lt;XElement&gt;();
            return result.ToXDocument();
        }

        /// &lt;summary&gt;
        /// Check if the node is protected
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool IsProtected(int nodeId, string path)
        {
            return _applicationContext.Services.PublicAccessService.IsProtected(path.EnsureEndsWith(&quot;,&quot; + nodeId));
        }

	    /// &lt;summary&gt;
        /// Returns a list of all of the user defined property names in Umbraco
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
		
		public IEnumerable&lt;string&gt; GetAllUserPropertyNames()
	    {
            try
            {
                
                var result = _applicationContext.DatabaseContext.Database.Fetch&lt;string&gt;(&quot;select distinct alias from cmsPropertyType order by alias&quot;);
                return result;
            }
            catch (Exception ex)
            {
                LogHelper.Error&lt;UmbracoContentService&gt;(&quot;EXCEPTION OCCURRED reading GetAllUserPropertyNames&quot;, ex);
                return Enumerable.Empty&lt;string&gt;();
            }      
	    }

        /// &lt;summary&gt;
        /// Returns a list of all system field names in Umbraco
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;string&gt; GetAllSystemPropertyNames()
        {
            return UmbracoContentIndexer.IndexFieldPolicies.Select(x =&gt; x.Name);
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[33,6,33,38,0],[34,3,34,4,0],[36,3,36,4,0],[38,9,38,76,1],[39,3,39,4,1],[40,13,40,54,1],[41,3,41,4,1],[49,9,49,10,0],[50,4,50,29,0],[51,9,51,10,0],[59,9,59,10,0],[63,13,63,73,0],[64,9,64,10,0],[75,9,75,10,0],[76,13,76,69,0],[77,13,77,20,0],[77,22,77,27,0],[77,28,77,30,0],[77,31,77,91,0],[78,13,78,14,0],[79,17,79,97,0],[80,13,80,14,0],[81,13,81,90,0],[82,13,82,41,0],[83,9,83,10,0],[92,9,92,10,0],[93,13,93,116,0],[94,9,94,10,0],[102,6,102,7,1],[104,13,104,14,1],[106,17,106,150,1],[107,17,107,31,1],[109,13,109,33,0],[110,13,110,14,0],[111,17,111,114,0],[112,17,112,51,0],[114,6,114,7,1],[121,9,121,10,0],[122,13,122,73,0],[122,73,122,79,0],[122,79,122,81,0],[122,13,122,81,0],[123,9,123,10,0]]);
    </script>
  </body>
</html>