<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\create\DLRScriptingTasks.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core;
using Umbraco.Web.UI;
using Umbraco.Core.Logging;
using umbraco.BusinessLogic;

namespace umbraco
{
    public class DLRScriptingTasks : LegacyDialogTask
    {
     
        public override bool PerformSave()
        {
            var template = Alias.Substring(0, Alias.IndexOf(&quot;|||&quot;)).Trim();
            var fileName = Alias.Substring(Alias.IndexOf(&quot;|||&quot;) + 3, Alias.Length - Alias.IndexOf(&quot;|||&quot;) - 3).Replace(&quot; &quot;, &quot;&quot;);

            if (!fileName.Contains(&quot;.&quot;))
                fileName = Alias + &quot;.py&quot;;

            var scriptContent = &quot;&quot;;
            if (!string.IsNullOrEmpty(template))
            {
                var templateFile = System.IO.File.OpenText(IOHelper.MapPath(SystemDirectories.Umbraco + &quot;/scripting/templates/&quot; + template));
                scriptContent = templateFile.ReadToEnd();
                templateFile.Close();
            }

			var abFileName = IOHelper.MapPath(SystemDirectories.MacroScripts + &quot;/&quot; + fileName);

			if (!System.IO.File.Exists(abFileName))
			{
				if (fileName.Contains(&quot;/&quot;)) //if there&#39;s a / create the folder structure for it
				{
					var folders = fileName.Split(&quot;/&quot;.ToCharArray());
					var basePath = IOHelper.MapPath(SystemDirectories.MacroScripts);
					for (var i = 0; i &lt; folders.Length - 1; i++)
					{
						basePath = System.IO.Path.Combine(basePath, folders[i]);
						System.IO.Directory.CreateDirectory(basePath);
					}
				}

			    var abFileFolder = Path.GetDirectoryName(abFileName);
                if (string.IsNullOrWhiteSpace(abFileFolder) == false)
			        if (Directory.Exists(abFileFolder) == false)
			            Directory.CreateDirectory(abFileFolder);

				var scriptWriter = System.IO.File.CreateText(abFileName);
				scriptWriter.Write(scriptContent);
				scriptWriter.Flush();
				scriptWriter.Close();

				if (ParentID == 1)
				{
                    var name = fileName
                        .Substring(0, (fileName.LastIndexOf(&#39;.&#39;) + 1)).Trim(&#39;.&#39;)
                        .SplitPascalCasing().ToFirstUpperInvariant();
					cms.businesslogic.macro.Macro m = cms.businesslogic.macro.Macro.MakeNew(name);
					m.ScriptingFile = fileName;
				    m.Save();
				}
			}

            _returnUrl = string.Format(SystemDirectories.Umbraco + &quot;/developer/python/editPython.aspx?file={0}&quot;, fileName);
            return true;
        }

        public override bool PerformDelete()
        {
            var path = IOHelper.MapPath(SystemDirectories.MacroScripts + &quot;/&quot; + Alias.TrimStart(&#39;/&#39;));
            try
            {
                System.IO.File.Delete(path);
            }
            catch (Exception ex)
            {
                LogHelper.Error&lt;DLRScriptingTasks&gt;(string.Format(&quot;Could not remove DLR file {0} - User {1}&quot;, Alias, User.Id), ex);
            }
            return true;
        }
        
        private string _returnUrl = &quot;&quot;;

        public override string ReturnUrl
        {
            get { return _returnUrl; }
        }

        public override string AssignedApp
        {
            get { return DefaultApps.developer.ToString(); }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,0],[17,13,17,76,0],[18,13,18,128,0],[20,13,20,41,0],[21,17,21,42,0],[23,13,23,36,0],[24,13,24,49,0],[25,13,25,14,0],[26,17,26,142,0],[27,17,27,58,0],[28,17,28,38,0],[29,13,29,14,0],[31,4,31,87,0],[33,4,33,43,0],[34,4,34,5,0],[35,5,35,32,0],[36,5,36,6,0],[37,6,37,54,0],[38,6,38,70,0],[39,11,39,20,0],[39,22,39,44,0],[39,46,39,49,0],[40,6,40,7,0],[41,7,41,63,0],[42,7,42,53,0],[43,6,43,7,0],[44,5,44,6,0],[46,8,46,61,0],[47,17,47,70,0],[48,12,48,56,0],[49,16,49,56,0],[51,5,51,62,0],[52,5,52,39,0],[53,5,53,26,0],[54,5,54,26,0],[56,5,56,23,0],[57,5,57,6,0],[58,21,60,70,0],[61,6,61,84,0],[62,6,62,33,0],[63,9,63,18,0],[64,5,64,6,0],[65,4,65,5,0],[67,13,67,124,0],[68,13,68,25,0],[69,9,69,10,0],[72,9,72,10,0],[73,13,73,102,0],[75,13,75,14,0],[76,17,76,45,0],[77,13,77,14,0],[78,13,78,33,0],[79,13,79,14,0],[80,17,80,131,0],[81,13,81,14,0],[82,13,82,25,0],[83,9,83,10,0],[85,9,85,40,1],[89,17,89,18,0],[89,19,89,37,0],[89,38,89,39,0],[94,17,94,18,1],[94,19,94,59,1],[94,60,94,61,1]]);
    </script>
  </body>
</html>