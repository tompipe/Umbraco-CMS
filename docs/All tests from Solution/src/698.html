<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\BatchedWebServiceServerMessenger.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Web;
using Umbraco.Core.Sync;
using Umbraco.Web.Routing;

namespace Umbraco.Web
{
    /// &lt;summary&gt;
    /// An &lt;see cref=&quot;IServerMessenger&quot;/&gt; that works by messaging servers via web services.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This binds to appropriate umbraco events in order to trigger the FlushBatch() calls
    /// &lt;/remarks&gt;
    internal class BatchedWebServiceServerMessenger : Core.Sync.BatchedWebServiceServerMessenger
    {
        internal BatchedWebServiceServerMessenger()
            : base()
        {
            UmbracoModule.EndRequest += UmbracoModule_EndRequest;
        }

        internal BatchedWebServiceServerMessenger(string login, string password) 
            : base(login, password)
        {
            UmbracoModule.EndRequest += UmbracoModule_EndRequest;
        }

        internal BatchedWebServiceServerMessenger(string login, string password, bool useDistributedCalls) 
            : base(login, password, useDistributedCalls)
        {
            UmbracoModule.EndRequest += UmbracoModule_EndRequest;
        }

        public BatchedWebServiceServerMessenger(Func&lt;Tuple&lt;string, string&gt;&gt; getLoginAndPassword)
            : base(getLoginAndPassword)
        {
            UmbracoModule.EndRequest += UmbracoModule_EndRequest;
        }

        protected override ICollection&lt;RefreshInstructionEnvelope&gt; GetBatch(bool ensureHttpContext)
        {
            //try get the http context from the UmbracoContext, we do this because in the case we are launching an async
            // thread and we know that the cache refreshers will execute, we will ensure the UmbracoContext and therefore we
            // can get the http context from it
            var httpContext = (UmbracoContext.Current == null ? null : UmbracoContext.Current.HttpContext)
                //if this is null, it could be that an async thread is calling this method that we weren&#39;t aware of and the UmbracoContext
                // wasn&#39;t ensured at the beginning of the thread. We can try to see if the HttpContext.Current is available which might be 
                // the case if the asp.net synchronization context has kicked in
                ?? (HttpContext.Current == null ? null : new HttpContextWrapper(HttpContext.Current));

            if (httpContext == null)
            {
                if (ensureHttpContext)
                    throw new NotSupportedException(&quot;Cannot execute without a valid/current HttpContext assigned.&quot;);
                return null;
            }

            var key = typeof(BatchedWebServiceServerMessenger).Name;

            // no thread-safety here because it&#39;ll run in only 1 thread (request) at a time
            var batch = (ICollection&lt;RefreshInstructionEnvelope&gt;)httpContext.Items[key];
            if (batch == null &amp;&amp; ensureHttpContext)
                httpContext.Items[key] = batch = new List&lt;RefreshInstructionEnvelope&gt;();
            return batch;
        }

        void UmbracoModule_EndRequest(object sender, UmbracoRequestEventArgs e)
        {
            FlushBatch();
        }

        protected override void ProcessBatch(RefreshInstructionEnvelope[] batch)
        {
            Message(batch);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,15,18,21,0],[19,9,19,10,0],[20,13,20,66,0],[21,9,21,10,0],[24,15,24,36,0],[25,9,25,10,0],[26,13,26,66,0],[27,9,27,10,0],[30,15,30,57,0],[31,9,31,10,0],[32,13,32,66,0],[33,9,33,10,0],[36,15,36,40,0],[37,9,37,10,0],[38,13,38,66,0],[39,9,39,10,0],[42,9,42,10,0],[46,13,50,103,0],[52,13,52,37,0],[53,13,53,14,0],[54,17,54,39,0],[55,21,55,117,0],[56,17,56,29,0],[59,13,59,69,0],[62,13,62,89,0],[63,13,63,52,0],[64,17,64,89,0],[65,13,65,26,0],[66,9,66,10,0],[69,9,69,10,0],[70,13,70,26,0],[71,9,71,10,0],[74,9,74,10,0],[75,13,75,28,0],[76,9,76,10,0]]);
    </script>
  </body>
</html>