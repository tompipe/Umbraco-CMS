<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Models\Mapping\MediaModelMapper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using AutoMapper;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Mapping;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Trees;

namespace Umbraco.Web.Models.Mapping
{
    /// &lt;summary&gt;
    /// Declares model mappings for media.
    /// &lt;/summary&gt;
    internal class MediaModelMapper : MapperConfiguration
    {
        public override void ConfigureMappings(IConfiguration config, ApplicationContext applicationContext)
        {
            //FROM IMedia TO MediaItemDisplay
            config.CreateMap&lt;IMedia, MediaItemDisplay&gt;()
                .ForMember(display =&gt; display.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IMedia&gt;()))
                .ForMember(display =&gt; display.Icon, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Icon))
                .ForMember(display =&gt; display.ContentTypeAlias, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Alias))
                .ForMember(display =&gt; display.IsChildOfListView, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Trashed, expression =&gt; expression.MapFrom(content =&gt; content.Trashed))
                .ForMember(display =&gt; display.ContentTypeName, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Name))
                .ForMember(display =&gt; display.Properties, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.TreeNodeUrl, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Notifications, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Errors, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Published, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Updater, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Alias, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.IsContainer, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.HasPublishedVersion, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Tabs, expression =&gt; expression.ResolveUsing(new TabsAndPropertiesResolver(applicationContext.Services.TextService)))
                .AfterMap((media, display) =&gt; AfterMap(media, display, applicationContext.Services.DataTypeService, applicationContext.Services.TextService, applicationContext.Services.ContentTypeService, applicationContext.ProfilingLogger.Logger));

            //FROM IMedia TO ContentItemBasic&lt;ContentPropertyBasic, IMedia&gt;
            config.CreateMap&lt;IMedia, ContentItemBasic&lt;ContentPropertyBasic, IMedia&gt;&gt;()
                .ForMember(dto =&gt; dto.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IMedia&gt;()))
                .ForMember(dto =&gt; dto.Icon, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Icon))
                .ForMember(dto =&gt; dto.Trashed, expression =&gt; expression.MapFrom(content =&gt; content.Trashed))
                .ForMember(dto =&gt; dto.ContentTypeAlias, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Alias))
                .ForMember(dto =&gt; dto.Published, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Updater, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Alias, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.HasPublishedVersion, expression =&gt; expression.Ignore());

            //FROM IMedia TO ContentItemDto&lt;IMedia&gt;
            config.CreateMap&lt;IMedia, ContentItemDto&lt;IMedia&gt;&gt;()
                .ForMember(dto =&gt; dto.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IMedia&gt;()))
                .ForMember(dto =&gt; dto.Published, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Updater, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Icon, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Alias, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.HasPublishedVersion, expression =&gt; expression.Ignore());
        }

        private static void AfterMap(IMedia media, MediaItemDisplay display, IDataTypeService dataTypeService, ILocalizedTextService localizedText, IContentTypeService contentTypeService, ILogger logger)
        {
            // Adapted from ContentModelMapper
            //map the IsChildOfListView (this is actually if it is a descendant of a list view!)
            var parent = media.Parent();
            display.IsChildOfListView = parent != null &amp;&amp; (parent.ContentType.IsContainer || contentTypeService.HasContainerInPath(parent.Path));
			
            //map the tree node url
            if (HttpContext.Current != null)
            {
                var urlHelper = new UrlHelper(new RequestContext(new HttpContextWrapper(HttpContext.Current), new RouteData()));
                var url = urlHelper.GetUmbracoApiService&lt;MediaTreeController&gt;(controller =&gt; controller.GetTreeNode(display.Id.ToString(), null));
                display.TreeNodeUrl = url;
            }
            
            if (media.ContentType.IsContainer)
            {
                TabsAndPropertiesResolver.AddListView(display, &quot;media&quot;, dataTypeService, localizedText);
            }
            
            var genericProperties = new List&lt;ContentPropertyDisplay&gt;
            {
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}doctype&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;content/mediatype&quot;),
                    Value = localizedText.UmbracoDictionaryTranslate(display.ContentTypeName),
                    View = PropertyEditorResolver.Current.GetByAlias(Constants.PropertyEditors.NoEditAlias).ValueEditor.View
                }
            };

            var links = media.GetUrls(UmbracoConfig.For.UmbracoSettings().Content, logger);

            if (links.Any())
            {
                var link = new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}urls&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;media/urls&quot;),
                    Value = string.Join(&quot;,&quot;, links),
                    View = &quot;urllist&quot;
                };
                genericProperties.Add(link);
            }

            TabsAndPropertiesResolver.MapGenericProperties(media, display, localizedText, genericProperties, properties =&gt;
            {
                if (HttpContext.Current != null &amp;&amp; UmbracoContext.Current != null &amp;&amp; UmbracoContext.Current.Security.CurrentUser != null
                    &amp;&amp; UmbracoContext.Current.Security.CurrentUser.AllowedSections.Any(x =&gt; x.Equals(Constants.Applications.Settings)))
                {
                    var mediaTypeLink = string.Format(&quot;#/settings/mediatypes/edit/{0}&quot;, media.ContentTypeId);

                    //Replace the doctype property
                    var docTypeProperty = properties.First(x =&gt; x.Alias == string.Format(&quot;{0}doctype&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix));
                    docTypeProperty.Value = new List&lt;object&gt;
                    {
                        new
                        {
                            linkText = media.ContentType.Name,
                            url = mediaTypeLink,
                            target = &quot;_self&quot;,
                            icon = &quot;icon-item-arrangement&quot;
                        }
                    };
                    docTypeProperty.View = &quot;urllist&quot;;
                }
            });
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,1],[27,13,28,68,1],[28,68,28,120,1],[28,120,29,67,1],[29,67,29,122,1],[29,122,30,79,1],[30,79,30,135,1],[30,135,31,80,1],[31,80,31,99,1],[31,99,32,70,1],[32,70,32,116,1],[32,116,33,78,1],[33,78,33,133,1],[33,133,34,73,1],[34,73,34,92,1],[34,92,35,74,1],[35,74,35,93,1],[35,93,36,76,1],[36,76,36,95,1],[36,95,37,69,1],[37,69,37,88,1],[37,88,38,72,1],[38,72,38,91,1],[38,91,39,70,1],[39,70,39,89,1],[39,89,40,68,1],[40,68,40,87,1],[40,87,41,74,1],[41,74,41,93,1],[41,93,42,82,1],[42,82,42,101,1],[42,101,43,67,1],[43,67,43,162,1],[43,162,44,47,1],[44,47,44,248,0],[44,248,44,250,1],[27,13,44,250,1],[47,13,48,60,1],[48,60,48,112,1],[48,112,49,59,1],[49,59,49,114,1],[49,114,50,62,1],[50,62,50,108,1],[50,108,51,71,1],[51,71,51,127,1],[51,127,52,64,1],[52,64,52,83,1],[52,83,53,62,1],[53,62,53,81,1],[53,81,54,60,1],[54,60,54,79,1],[54,79,55,74,1],[55,74,55,93,1],[55,93,55,95,1],[47,13,55,95,1],[58,13,59,60,1],[59,60,59,112,1],[59,112,60,64,1],[60,64,60,83,1],[60,83,61,62,1],[61,62,61,81,1],[61,81,62,59,1],[62,59,62,78,1],[62,78,63,60,1],[63,60,63,79,1],[63,79,64,74,1],[64,74,64,93,1],[64,93,64,95,1],[58,13,64,95,1],[65,9,65,10,1],[68,9,68,10,0],[71,13,71,41,0],[72,13,72,146,0],[75,13,75,45,0],[76,13,76,14,0],[77,17,77,129,0],[78,17,78,146,0],[79,17,79,43,0],[80,13,80,14,0],[82,13,82,47,0],[83,13,83,14,0],[84,17,84,105,0],[85,13,85,14,0],[87,13,96,15,0],[98,13,98,92,0],[100,13,100,29,0],[101,13,101,14,0],[102,17,108,19,0],[109,17,109,45,0],[110,13,110,14,0],[112,13,113,13,0],[113,13,113,14,0],[113,14,114,17,0],[114,17,115,93,0],[115,93,115,134,0],[115,134,115,136,0],[114,17,115,136,0],[115,136,116,17,0],[116,17,116,18,0],[116,18,117,21,0],[117,21,117,110,0],[117,110,120,21,0],[120,21,120,65,0],[120,65,120,162,0],[120,162,120,164,0],[120,21,120,164,0],[120,164,121,21,0],[121,21,130,23,0],[130,23,131,21,0],[131,21,131,54,0],[131,54,132,17,0],[132,17,132,18,0],[132,18,133,13,0],[133,13,133,14,0],[133,14,133,16,0],[112,13,133,16,0],[134,9,134,10,0]]);
    </script>
  </body>
</html>