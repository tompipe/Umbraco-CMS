<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UI\Controls\FolderBrowser.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Text;
using System.Web.UI;
using System.Web.UI.WebControls;
using ClientDependency.Core;
using Umbraco.Core;
using Umbraco.Web.UI.Bundles;
using umbraco.BasePages;
using Umbraco.Core.IO;

namespace Umbraco.Web.UI.Controls
{
    [ClientDependency(ClientDependencyType.Css, &quot;ContextMenu/Css/jquery.contextMenu.css&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Css, &quot;FolderBrowser/Css/folderbrowser.css&quot;, &quot;UmbracoClient&quot;)]    
    [ClientDependency(ClientDependencyType.Javascript, &quot;ContextMenu/Js/jquery.contextMenu.js&quot;, &quot;UmbracoClient&quot;, Priority = 5)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;FileUploader/js/jquery.fileUploader.js&quot;, &quot;UmbracoClient&quot;, Priority = 6)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;FolderBrowser/js/folderbrowser.js&quot;, &quot;UmbracoClient&quot;, Priority = 10)]
    [ToolboxData(&quot;&lt;{0}:FolderBrowser runat=server&gt;&lt;/{0}:FolderBrowser&gt;&quot;)]
    public class FolderBrowser : WebControl
    {
        protected Panel Panel;

        protected int ParentId
        {
            get
            {
                // Try and parse from querystring
                if (!string.IsNullOrEmpty(Context.Request.QueryString[&quot;id&quot;]))
                {
                    int id;
                    if (Int32.TryParse(Context.Request.QueryString[&quot;id&quot;], out id))
                        return id;
                }

                // Get users root media folder id
                var currentUser = UmbracoEnsuredPage.CurrentUser;
                if (currentUser != null)
                    return currentUser.StartMediaId;

                // Nothing else to check so just return -1
                return -1;
            }
        }

        protected global::umbraco.cms.businesslogic.media.Media ParentNode
        {
            get
            {
                return new global::umbraco.cms.businesslogic.media.Media(ParentId);
            }
        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            EnsureChildControls();

            //disable view state for this control
            this.EnableViewState = false;
        }

        /// &lt;summary&gt;
        /// Create the native .net child controls for this control
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            //Ensure the bundles are added
            Controls.Add(new JsApplicationLib());
            Controls.Add(new JsJQueryCore());

            // Create the panel surround
            Panel = new Panel
            {
                ID = &quot;FolderBrowser&quot;,
                CssClass = &quot;umbFolderBrowser&quot;
            };

            Panel.Attributes.Add(&quot;data-parentid&quot;, ParentId.ToString());

            var sb = new StringBuilder();

            // Create the breadcrumb
            var breadCrumb = new List&lt;global::umbraco.cms.businesslogic.media.Media&gt; { ParentNode };

            var parent = ParentNode;
            while (parent.Id != -1)
            {
                parent = new global::umbraco.cms.businesslogic.media.Media(parent.ParentId);
                breadCrumb.Add(parent);
            }

            breadCrumb.Reverse();

            sb.Append(&quot;&lt;ul class=&#39;breadcrumb&#39;&gt;&lt;li&gt;&lt;strong&gt;You are here:&lt;/strong&gt;&lt;/li&gt;&quot;);
            foreach (var media in breadCrumb)
            {
                if (media.Id == ParentId)
                    if (media.Id == -1)
                        sb.AppendFormat(&quot;&lt;li&gt;Media&lt;/li&gt;&quot;);
                    else
                        sb.AppendFormat(&quot;&lt;li&gt;{0}&lt;/li&gt;&quot;, media.Text);
                else
                    if (media.Id == -1)
                        sb.AppendFormat(&quot;&lt;li&gt;&lt;a href=&#39;dashboard.aspx?app=media&#39;&gt;Media&lt;/a&gt;&lt;/li&gt;&quot;);
                    else
                        sb.AppendFormat(&quot;&lt;li&gt;&lt;a href=&#39;editMedia.aspx?id={1}&#39;&gt;{0}&lt;/a&gt;&lt;/li&gt;&quot;, media.Text, media.Id);
            }
            sb.Append(&quot;&lt;/ul&gt;&quot;);

            // Path for tree refresh
            Panel.Attributes.Add(&quot;data-nodepath&quot;, ParentNode.Path);

            // Create size changer
            sb.Append(&quot;&lt;div class=&#39;thumb-sizer&#39;&gt;&quot; +
                      &quot;&lt;input type=&#39;radio&#39; name=&#39;thumb_size&#39; id=&#39;thumb_size_small&#39; value=&#39;small&#39; data-bind=&#39;checked: thumbSize&#39; /&gt;&quot; +
                      &quot;&lt;label for=&#39;thumb_size_small&#39;&gt;&lt;img src=&#39;images/thumbs_smll.png&#39; alt=&#39;Small thumbnails&#39; /&gt;&lt;/label&gt;&quot; +
                      &quot;&lt;input type=&#39;radio&#39; name=&#39;thumb_size&#39; id=&#39;thumb_size_medium&#39; value=&#39;medium&#39; data-bind=&#39;checked: thumbSize&#39; /&gt;&quot; +
                      &quot;&lt;label for=&#39;thumb_size_medium&#39;&gt;&lt;img src=&#39;images/thumbs_med.png&#39; alt=&#39;Medium thumbnails&#39; /&gt;&lt;/label&gt;&quot; +
                      &quot;&lt;input type=&#39;radio&#39; name=&#39;thumb_size&#39; id=&#39;thumb_size_large&#39; value=&#39;large&#39; data-bind=&#39;checked: thumbSize&#39; /&gt;&quot; +
                      &quot;&lt;label for=&#39;thumb_size_large&#39;&gt;&lt;img src=&#39;images/thumbs_lrg.png&#39; alt=&#39;Large thumbnails&#39; /&gt;&lt;/label&gt;&quot; +
                      &quot;&lt;/div&gt;&quot;);

            // Create the filter input
            sb.Append(&quot;&lt;div class=&#39;filter&#39;&gt;&lt;input type=&#39;text&#39; placeholder=&#39;filter...&#39; data-bind=\&quot;value: filterTerm, valueUpdate: &#39;afterkeydown&#39;\&quot; id=&#39;filterTerm&#39;/&gt;&lt;/div&gt;&quot;);

            // Create throbber to display whilst loading items
            sb.Append(&quot;&lt;img src=&#39;images/throbber.gif&#39; alt=&#39;&#39; class=&#39;throbber&#39; data-bind=\&quot;visible: filtered().length == 0\&quot; /&gt;&quot;);

            // Create thumbnails container
            sb.Append(&quot;&lt;ul class=&#39;items&#39; data-bind=&#39;foreach: filtered&#39;&gt;&quot; +
                      &quot;&lt;li data-bind=\&quot;attr: { &#39;data-id&#39;: Id, &#39;data-order&#39;: $index() }, css: { selected: selected() }, event: { mousedown: toggleSelected, contextmenu: toggleSelected, dblclick: edit }\&quot;&gt;&lt;div&gt;&lt;span class=&#39;img&#39;&gt;&lt;img data-bind=&#39;attr: { src: ThumbnailUrl }&#39; /&gt;&lt;/span&gt;&lt;span data-bind=&#39;text: Name&#39;&gt;&lt;/span&gt;&lt;/div&gt;&lt;/li&gt;&quot; +
                      &quot;&lt;/ul&gt;&quot;);

            Panel.Controls.Add(new LiteralControl(sb.ToString()));

            Controls.Add(Panel);

            Page.ClientScript.RegisterStartupScript(typeof(FolderBrowser),
                &quot;RegisterFolderBrowsers&quot;,
                string.Format(&quot;$(function () {{ $(\&quot;.umbFolderBrowser\&quot;).folderBrowser({{ umbracoPath : &#39;{0}&#39;, basePath : &#39;{1}&#39;, reqver : &#39;{2}&#39; }}); &quot; +
                 &quot;$(\&quot;.umbFolderBrowser #filterTerm\&quot;).keypress(function(event) {{ return event.keyCode != 13; }});}});&quot;,
                IOHelper.ResolveUrl(SystemDirectories.Umbraco),
                IOHelper.ResolveUrl(SystemDirectories.Base),
                UmbracoEnsuredPage.umbracoUserContextID.EncryptWithMachineKey() ),
                true);
        }

        protected override void Render(HtmlTextWriter writer)
        {
            this.RenderContents(writer);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[27,13,27,14,0],[29,17,29,78,0],[30,17,30,18,0],[32,21,32,83,0],[33,25,33,35,0],[34,17,34,18,0],[37,17,37,66,0],[38,17,38,41,0],[39,21,39,53,0],[42,17,42,27,0],[43,13,43,14,0],[49,13,49,14,0],[50,17,50,84,0],[51,13,51,14,0],[55,9,55,10,0],[56,13,56,28,0],[58,13,58,35,0],[61,13,61,42,0],[62,9,62,10,0],[68,9,68,10,0],[70,13,70,50,0],[71,13,71,46,0],[74,13,78,15,0],[80,13,80,72,0],[82,13,82,42,0],[85,13,85,101,0],[87,13,87,37,0],[88,13,88,36,0],[89,13,89,14,0],[90,17,90,93,0],[91,17,91,40,0],[92,13,92,14,0],[94,13,94,34,0],[96,13,96,89,0],[97,13,97,20,0],[97,22,97,31,0],[97,32,97,34,0],[97,35,97,45,0],[98,13,98,14,0],[99,17,99,42,0],[100,21,100,40,0],[101,25,101,59,0],[103,25,103,69,0],[105,21,105,40,0],[106,25,106,98,0],[108,25,108,115,0],[109,13,109,14,0],[110,13,110,32,0],[113,13,113,68,0],[116,13,123,33,0],[126,13,126,174,0],[129,13,129,130,0],[132,13,134,32,0],[136,13,136,67,0],[138,13,138,33,0],[140,13,147,23,0],[148,9,148,10,0],[151,9,151,10,0],[152,13,152,41,0],[153,9,153,10,0]]);
    </script>
  </body>
</html>