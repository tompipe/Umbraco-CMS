<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\PublishedContent\PublishedContentType.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Cache;

namespace Umbraco.Core.Models.PublishedContent
{
    /// &lt;summary&gt;
    /// Represents an &lt;see cref=&quot;IPublishedContent&quot;/&gt; type.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;Instances of the &lt;see cref=&quot;PublishedContentType&quot;/&gt; class are immutable, ie
    /// if the content type changes, then a new class needs to be created.&lt;/remarks&gt;
    public class PublishedContentType
    {
        private readonly PublishedPropertyType[] _propertyTypes;
        private readonly HashSet&lt;string&gt; _compositionAliases;

        // fast alias-to-index xref containing both the raw alias and its lowercase version
        private readonly Dictionary&lt;string, int&gt; _indexes = new Dictionary&lt;string, int&gt;();

        // internal so it can be used by PublishedNoCache which does _not_ want to cache anything and so will never
        // use the static cache getter PublishedContentType.GetPublishedContentType(alias) below - anything else
        // should use it.
        internal PublishedContentType(IContentTypeComposition contentType)
        {
            Id = contentType.Id;
            Alias = contentType.Alias;
            _compositionAliases = new HashSet&lt;string&gt;(contentType.CompositionAliases(), StringComparer.InvariantCultureIgnoreCase);
            _propertyTypes = contentType.CompositionPropertyTypes
                .Select(x =&gt; new PublishedPropertyType(this, x))
                .ToArray();
            InitializeIndexes();
        }

        // internal so it can be used for unit tests
        internal PublishedContentType(int id, string alias, IEnumerable&lt;string&gt; compositionAliases, IEnumerable&lt;PublishedPropertyType&gt; propertyTypes)
        {
            Id = id;
            Alias = alias;
            _compositionAliases = new HashSet&lt;string&gt;(compositionAliases, StringComparer.InvariantCultureIgnoreCase);
            _propertyTypes = propertyTypes.ToArray();
            foreach (var propertyType in _propertyTypes)
                propertyType.ContentType = this;
            InitializeIndexes();
        }

        // create detached content type - ie does not match anything in the DB
        internal PublishedContentType(string alias, IEnumerable&lt;string&gt; compositionAliases, IEnumerable&lt;PublishedPropertyType&gt; propertyTypes)
            : this(0, alias, compositionAliases, propertyTypes)
        { }

        private void InitializeIndexes()
        {
            for (var i = 0; i &lt; _propertyTypes.Length; i++)
            {
                var propertyType = _propertyTypes[i];
                _indexes[propertyType.PropertyTypeAlias] = i;
                _indexes[propertyType.PropertyTypeAlias.ToLowerInvariant()] = i;
            }
        }

        #region Content type

        public int Id { get; private set; }
        public string Alias { get; private set; }
        public HashSet&lt;string&gt; CompositionAliases { get { return _compositionAliases; } }

        #endregion

        #region Properties

        public IEnumerable&lt;PublishedPropertyType&gt; PropertyTypes
        {
            get { return _propertyTypes; }
        }

        // alias is case-insensitive
        // this is the ONLY place where we compare ALIASES!
        public int GetPropertyIndex(string alias)
        {
            int index;
            if (_indexes.TryGetValue(alias, out index)) return index; // fastest
            if (_indexes.TryGetValue(alias.ToLowerInvariant(), out index)) return index; // slower
            return -1;
        }

        // virtual for unit tests
        public virtual PublishedPropertyType GetPropertyType(string alias)
        {
            var index = GetPropertyIndex(alias);
            return GetPropertyType(index);
        }

        // virtual for unit tests
        public virtual PublishedPropertyType GetPropertyType(int index)
        {
            return index &gt;= 0 &amp;&amp; index &lt; _propertyTypes.Length ? _propertyTypes[index] : null;
        }

        #endregion

        #region Cache

        // these methods are called by ContentTypeCacheRefresher and DataTypeCacheRefresher

        internal static void ClearAll()
        {
            Logging.LogHelper.Debug&lt;PublishedContentType&gt;(&quot;Clear all.&quot;);
            // ok and faster to do it by types, assuming noone else caches PublishedContentType instances
            //ApplicationContext.Current.ApplicationCache.ClearStaticCacheByKeySearch(&quot;PublishedContentType_&quot;);
            ApplicationContext.Current.ApplicationCache.StaticCache.ClearCacheObjectTypes&lt;PublishedContentType&gt;();
        }

        internal static void ClearContentType(int id)
        {
            Logging.LogHelper.Debug&lt;PublishedContentType&gt;(&quot;Clear content type w/id {0}.&quot;, () =&gt; id);

            // we don&#39;t support &quot;get all&quot; at the moment - so, cheating
            var all = ApplicationContext.Current.ApplicationCache.StaticCache.GetCacheItemsByKeySearch&lt;PublishedContentType&gt;(&quot;PublishedContentType_&quot;).ToArray();

            // the one we want to clear
            var clr = all.FirstOrDefault(x =&gt; x.Id == id);
            if (clr == null) return;

            // those that have that one in their composition aliases
            // note: CompositionAliases contains all recursive aliases
            var oth = all.Where(x =&gt; x.CompositionAliases.InvariantContains(clr.Alias)).Select(x =&gt; x.Id);

            // merge ids
            var ids = oth.Concat(new[] { clr.Id }).ToArray();

            // clear them all at once
            // we don&#39;t support &quot;clear many at once&quot; at the moment - so, cheating
            ApplicationContext.Current.ApplicationCache.StaticCache.ClearCacheObjectTypes&lt;PublishedContentType&gt;(
                (key, value) =&gt; ids.Contains(value.Id));
        }

        internal static void ClearDataType(int id)
        {
            Logging.LogHelper.Debug&lt;PublishedContentType&gt;(&quot;Clear data type w/id {0}.&quot;, () =&gt; id);
            // there is no recursion to handle here because a PublishedContentType contains *all* its
            // properties ie both its own properties and those that were inherited (it&#39;s based upon an
            // IContentTypeComposition) and so every PublishedContentType having a property based upon
            // the cleared data type, be it local or inherited, will be cleared.
            ApplicationContext.Current.ApplicationCache.StaticCache.ClearCacheObjectTypes&lt;PublishedContentType&gt;(
                (key, value) =&gt; value.PropertyTypes.Any(x =&gt; x.DataTypeId == id));
        }

        public static PublishedContentType Get(PublishedItemType itemType, string alias)
        {
            var key = string.Format(&quot;PublishedContentType_{0}_{1}&quot;,
                itemType.ToString().ToLowerInvariant(), alias.ToLowerInvariant());

            var type = ApplicationContext.Current.ApplicationCache.StaticCache.GetCacheItem&lt;PublishedContentType&gt;(key,
                () =&gt; CreatePublishedContentType(itemType, alias));

            return type;
        }

        private static PublishedContentType CreatePublishedContentType(PublishedItemType itemType, string alias)
        {
            if (GetPublishedContentTypeCallback != null)
                return GetPublishedContentTypeCallback(alias);

            IContentTypeComposition contentType;
            switch (itemType)
            {
                case PublishedItemType.Content:
                    contentType = ApplicationContext.Current.Services.ContentTypeService.GetContentType(alias);
                    break;
                case PublishedItemType.Media:
                    contentType = ApplicationContext.Current.Services.ContentTypeService.GetMediaType(alias);
                    break;
                case PublishedItemType.Member:
                    contentType = ApplicationContext.Current.Services.MemberTypeService.Get(alias);
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;itemType&quot;);
            }

            if (contentType == null)
                throw new InvalidOperationException(string.Format(&quot;ContentTypeService failed to find a {0} type with alias \&quot;{1}\&quot;.&quot;,
                    itemType.ToString().ToLower(), alias));

            return new PublishedContentType(contentType);
        }

        // for unit tests - changing the callback must reset the cache obviously
        private static Func&lt;string, PublishedContentType&gt; _getPublishedContentTypeCallBack;
        internal static Func&lt;string, PublishedContentType&gt; GetPublishedContentTypeCallback
        {
            get { return _getPublishedContentTypeCallBack; }
            set
            {
                // see note above
                //ClearAll();
                ApplicationContext.Current.ApplicationCache.StaticCache.ClearCacheByKeySearch(&quot;PublishedContentType_&quot;);

                _getPublishedContentTypeCallBack = value;
            }
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,91,0],[19,9,19,91,1],[24,9,24,75,0],[25,9,25,10,0],[26,13,26,33,0],[27,13,27,39,0],[28,13,28,132,0],[29,13,30,30,0],[30,30,30,64,0],[30,64,31,28,0],[29,13,31,28,0],[32,13,32,33,0],[33,9,33,10,0],[36,9,36,150,1],[37,9,37,10,1],[38,13,38,21,1],[39,13,39,27,1],[40,13,40,118,1],[41,13,41,54,1],[42,13,42,20,1],[42,22,42,38,1],[42,39,42,41,1],[42,42,42,56,1],[43,17,43,49,1],[44,13,44,33,1],[45,9,45,10,1],[49,15,49,64,0],[50,9,50,10,0],[50,11,50,12,0],[53,9,53,10,1],[54,18,54,27,1],[54,29,54,54,1],[54,56,54,59,1],[55,13,55,14,1],[56,17,56,54,1],[57,17,57,62,1],[58,17,58,81,1],[59,13,59,14,1],[60,9,60,10,1],[64,25,64,29,1],[64,30,64,42,1],[65,31,65,35,1],[65,36,65,48,1],[66,57,66,58,1],[66,59,66,86,1],[66,87,66,88,1],[74,17,74,18,1],[74,19,74,41,1],[74,42,74,43,1],[80,9,80,10,1],[82,13,82,56,1],[82,57,82,70,1],[83,13,83,75,0],[83,76,83,89,0],[84,13,84,23,0],[85,9,85,10,1],[89,9,89,10,1],[90,13,90,49,1],[91,13,91,43,1],[92,9,92,10,1],[96,9,96,10,1],[97,13,97,95,1],[98,9,98,10,1],[107,9,107,10,0],[108,13,108,73,0],[111,13,111,115,0],[112,9,112,10,0],[115,9,115,10,0],[116,13,116,97,0],[116,97,116,99,0],[116,99,116,101,0],[116,13,116,101,0],[119,13,119,161,0],[122,13,122,47,0],[122,47,122,57,0],[122,57,122,59,0],[122,13,122,59,0],[123,13,123,29,0],[123,30,123,37,0],[127,13,127,38,0],[127,38,127,87,0],[127,87,127,101,0],[127,101,127,105,0],[127,105,127,107,0],[127,13,127,107,0],[130,13,130,62,0],[134,13,135,33,0],[135,33,135,55,0],[135,55,135,57,0],[134,13,135,57,0],[136,9,136,10,0],[139,9,139,10,0],[140,13,140,94,0],[140,94,140,96,0],[140,96,140,98,0],[140,13,140,98,0],[145,13,146,33,0],[146,33,146,62,0],[146,62,146,80,0],[146,80,146,81,0],[146,33,146,81,0],[146,81,146,83,0],[145,13,146,83,0],[147,9,147,10,0],[150,9,150,10,1],[151,13,152,83,1],[154,13,155,23,1],[155,23,155,66,1],[155,66,155,68,1],[154,13,155,68,1],[157,13,157,25,1],[158,9,158,10,1],[161,9,161,10,1],[162,13,162,57,1],[163,17,163,63,1],[166,13,166,30,0],[169,21,169,112,0],[170,21,170,27,0],[172,21,172,110,0],[173,21,173,27,0],[175,21,175,100,0],[176,21,176,27,0],[178,21,178,71,0],[181,13,181,37,0],[182,17,183,60,0],[185,13,185,58,0],[186,9,186,10,1],[192,17,192,18,1],[192,19,192,59,1],[192,60,192,61,1],[194,13,194,14,1],[197,17,197,120,1],[199,17,199,58,1],[200,13,200,14,1]]);
    </script>
  </body>
</html>