<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\MergeParentContextViewDataAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using System.Web.Mvc;

namespace Umbraco.Web.Mvc
{
    /// &lt;summary&gt;
    /// This attribute can be used for when child actions execute and will automatically merge in the viewdata from the parent context to the 
    /// child action result.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This will retain any custom viewdata put into the child viewdata if the same key persists in the parent context&#39;s view data. You can always still
    /// access the parent&#39;s view data normally. 
    /// This just simplifies working with ChildActions and view data.
    /// 
    /// NOTE: This does not mean that the parent context&#39;s view data will be merged before the action executes, if you need access to the parent context&#39;s view
    /// data during controller execution you can access it normally.
    /// 
    /// NOTE: This recursively merges in all ParentActionViewContext ancestry in case there&#39;s child actions inside of child actions.
    /// &lt;/remarks&gt;
    public class MergeParentContextViewDataAttribute : ActionFilterAttribute
    {
        /// &lt;summary&gt;
        /// Merge in the parent context&#39;s view data if this is a child action when the result is being executed
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;filterContext&quot;&gt;&lt;/param&gt;
        public override void OnResultExecuting(ResultExecutingContext filterContext)
        {
            if (filterContext.IsChildAction)
            {
                MergeCurrentParent(filterContext.Controller, filterContext.ParentActionViewContext);
            }

            base.OnResultExecuting(filterContext);
        }

        /// &lt;summary&gt;
        /// Recursively merges in each parent view context into the target
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;target&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;currentParent&quot;&gt;&lt;/param&gt;
        private static void MergeCurrentParent(ControllerBase target, ViewContext currentParent)
        {
            if (currentParent != null &amp;&amp; currentParent.ViewData != null &amp;&amp; currentParent.ViewData.Any())
            {
                target.ViewData.MergeViewDataFrom(currentParent.ViewData);

                //Recurse!
                if (currentParent.IsChildAction)
                {
                    MergeCurrentParent(target, currentParent.ParentActionViewContext);    
                }
                
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,1],[28,13,28,45,1],[29,13,29,14,1],[30,17,30,101,1],[31,13,31,14,1],[33,13,33,51,1],[34,9,34,10,1],[42,9,42,10,1],[43,13,43,105,1],[44,13,44,14,1],[45,17,45,75,1],[48,17,48,49,1],[49,17,49,18,1],[50,21,50,87,1],[51,17,51,18,1],[53,13,53,14,1],[54,9,54,10,1]]);
    </script>
  </body>
</html>