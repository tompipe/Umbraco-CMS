<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Membership\UmbracoServiceMembershipProviderTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Specialized;
using System.Configuration.Provider;
using System.Web.Security;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers.Entities;
using Umbraco.Web.Security.Providers;

namespace Umbraco.Tests.Membership
{
    [TestFixture, RequiresSTA]
    public class UmbracoServiceMembershipProviderTests
    {
        [Test]
        public void Sets_Default_Member_Type_From_Service_On_Init()
        {
            var mServiceMock = new Mock&lt;IMembershipMemberService&gt;();
            var provider = new MembersMembershipProvider(mServiceMock.Object);
            mServiceMock.Setup(service =&gt; service.GetDefaultMemberType()).Returns(&quot;Blah&quot;);
            provider.Initialize(&quot;test&quot;, new NameValueCollection());
            
            Assert.AreEqual(&quot;Blah&quot;, provider.DefaultMemberTypeAlias);
        }

        [Test]
        public void Sets_Default_Member_Type_From_Config_On_Init()
        {
            var mServiceMock = new Mock&lt;IMembershipMemberService&gt;();
            var provider = new MembersMembershipProvider(mServiceMock.Object);
            mServiceMock.Setup(service =&gt; service.GetDefaultMemberType()).Returns(&quot;Blah&quot;);
            provider.Initialize(&quot;test&quot;, new NameValueCollection { { &quot;defaultMemberTypeAlias&quot;, &quot;Hello&quot; } });

            Assert.AreEqual(&quot;Hello&quot;, provider.DefaultMemberTypeAlias);
        }

        [Test]
        public void Create_User_Already_Exists()
        {
            var mServiceMock = new Mock&lt;IMembershipMemberService&gt;();
            mServiceMock.Setup(service =&gt; service.Exists(&quot;test&quot;)).Returns(true);
            mServiceMock.Setup(service =&gt; service.GetDefaultMemberType()).Returns(&quot;Member&quot;);

            var provider = new MembersMembershipProvider(mServiceMock.Object);
            provider.Initialize(&quot;test&quot;, new NameValueCollection());

            MembershipCreateStatus status;
            var user = provider.CreateUser(&quot;test&quot;, &quot;test&quot;, &quot;testtest$1&quot;, &quot;test@test.com&quot;, &quot;test&quot;, &quot;test&quot;, true, &quot;test&quot;, out status);

            Assert.IsNull(user);
        }

        [Test]
        public void Create_User_Requires_Unique_Email()
        {
            var mServiceMock = new Mock&lt;IMembershipMemberService&gt;();
            mServiceMock.Setup(service =&gt; service.GetByEmail(&quot;test@test.com&quot;)).Returns(() =&gt; new Member(&quot;test&quot;, MockedContentTypes.CreateSimpleMemberType()));
            mServiceMock.Setup(service =&gt; service.GetDefaultMemberType()).Returns(&quot;Member&quot;);

            var provider = new MembersMembershipProvider(mServiceMock.Object);
            provider.Initialize(&quot;test&quot;, new NameValueCollection { { &quot;requiresUniqueEmail&quot;, &quot;true&quot; } });

            MembershipCreateStatus status;
            var user = provider.CreateUser(&quot;test&quot;, &quot;test&quot;, &quot;testtest$1&quot;, &quot;test@test.com&quot;, &quot;test&quot;, &quot;test&quot;, true, &quot;test&quot;, out status);

            Assert.IsNull(user);
        }

        [Test]
        public void Answer_Is_Encrypted()
        {
            IMember createdMember = null;
            var memberType = MockedContentTypes.CreateSimpleMemberType();
            foreach (var p in Constants.Conventions.Member.GetStandardPropertyTypeStubs())
            {
                memberType.AddPropertyType(p.Value);
            }
            var mServiceMock = new Mock&lt;IMembershipMemberService&gt;();
            mServiceMock.Setup(service =&gt; service.Exists(&quot;test&quot;)).Returns(false);
            mServiceMock.Setup(service =&gt; service.GetByEmail(&quot;test@test.com&quot;)).Returns(() =&gt; null);
            mServiceMock.Setup(service =&gt; service.GetDefaultMemberType()).Returns(&quot;Member&quot;);
            mServiceMock.Setup(
                service =&gt; service.CreateWithIdentity(It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;()))
                        .Callback((string u, string e, string p, string m) =&gt;
                            {
                                createdMember = new Member(&quot;test&quot;, e, u, p, memberType);
                            })
                        .Returns(() =&gt; createdMember);
            var provider = new MembersMembershipProvider(mServiceMock.Object);            
            provider.Initialize(&quot;test&quot;, new NameValueCollection());
            

            MembershipCreateStatus status;
            provider.CreateUser(&quot;test&quot;, &quot;test&quot;, &quot;testtest$1&quot;, &quot;test@test.com&quot;, &quot;test&quot;, &quot;test&quot;, true, &quot;test&quot;, out status);

            Assert.AreNotEqual(&quot;test&quot;, createdMember.RawPasswordAnswerValue);
            Assert.AreEqual(provider.EncryptString(&quot;test&quot;), createdMember.RawPasswordAnswerValue);
        }

        [Test]
        public void Password_Encrypted()
        {
            IMember createdMember = null;
            var memberType = MockedContentTypes.CreateSimpleMemberType();
            foreach (var p in Constants.Conventions.Member.GetStandardPropertyTypeStubs())
            {
                memberType.AddPropertyType(p.Value);
            }
            var mServiceMock = new Mock&lt;IMembershipMemberService&gt;();
            mServiceMock.Setup(service =&gt; service.Exists(&quot;test&quot;)).Returns(false);
            mServiceMock.Setup(service =&gt; service.GetByEmail(&quot;test@test.com&quot;)).Returns(() =&gt; null);
            mServiceMock.Setup(service =&gt; service.GetDefaultMemberType()).Returns(&quot;Member&quot;);
            mServiceMock.Setup(
                service =&gt; service.CreateWithIdentity(It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;()))
                        .Callback((string u, string e, string p, string m) =&gt;
                            {
                                createdMember = new Member(&quot;test&quot;, e, u, p, memberType);
                            })
                        .Returns(() =&gt; createdMember);

            var provider = new MembersMembershipProvider(mServiceMock.Object);
            provider.Initialize(&quot;test&quot;, new NameValueCollection { { &quot;passwordFormat&quot;, &quot;Encrypted&quot; } });
            

            MembershipCreateStatus status;
            provider.CreateUser(&quot;test&quot;, &quot;test&quot;, &quot;testtest$1&quot;, &quot;test@test.com&quot;, &quot;test&quot;, &quot;test&quot;, true, &quot;test&quot;, out status);

            Assert.AreNotEqual(&quot;test&quot;, createdMember.RawPasswordValue);
            var decrypted = provider.DecryptPassword(createdMember.RawPasswordValue);
            Assert.AreEqual(&quot;testtest$1&quot;, decrypted);
        }

        [Test]
        public void Password_Hashed_With_Salt()
        {
            IMember createdMember = null;
            var memberType = MockedContentTypes.CreateSimpleMemberType();
            foreach (var p in Constants.Conventions.Member.GetStandardPropertyTypeStubs())
            {
                memberType.AddPropertyType(p.Value);
            }
            var mServiceMock = new Mock&lt;IMembershipMemberService&gt;();
            mServiceMock.Setup(service =&gt; service.Exists(&quot;test&quot;)).Returns(false);
            mServiceMock.Setup(service =&gt; service.GetByEmail(&quot;test@test.com&quot;)).Returns(() =&gt; null);
            mServiceMock.Setup(service =&gt; service.GetDefaultMemberType()).Returns(&quot;Member&quot;);
            mServiceMock.Setup(
                service =&gt; service.CreateWithIdentity(It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;()))
                        .Callback((string u, string e, string p, string m) =&gt;
                        {
                            createdMember = new Member(&quot;test&quot;, e, u, p, memberType);
                        })
                        .Returns(() =&gt; createdMember);

            var provider = new MembersMembershipProvider(mServiceMock.Object);
            provider.Initialize(&quot;test&quot;, new NameValueCollection { { &quot;passwordFormat&quot;, &quot;Hashed&quot; }, { &quot;hashAlgorithmType&quot;, &quot;HMACSHA256&quot; } });
            

            MembershipCreateStatus status;
            provider.CreateUser(&quot;test&quot;, &quot;test&quot;, &quot;testtest$1&quot;, &quot;test@test.com&quot;, &quot;test&quot;, &quot;test&quot;, true, &quot;test&quot;, out status);

            Assert.AreNotEqual(&quot;test&quot;, createdMember.RawPasswordValue);
            
            string salt;
            var storedPassword = provider.StoredPassword(createdMember.RawPasswordValue, out salt);
            var hashedPassword = provider.EncryptOrHashPassword(&quot;testtest$1&quot;, salt);
            Assert.AreEqual(hashedPassword, storedPassword);
        }
        
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,69,1],[22,13,22,79,1],[23,13,23,91,1],[24,13,24,68,1],[26,13,26,70,1],[27,9,27,10,1],[31,9,31,10,1],[32,13,32,69,1],[33,13,33,79,1],[34,13,34,91,1],[35,13,35,108,1],[37,13,37,71,1],[38,9,38,10,1],[42,9,42,10,1],[43,13,43,69,1],[44,13,44,81,1],[45,13,45,93,1],[47,13,47,79,1],[48,13,48,68,1],[51,13,51,133,1],[53,13,53,33,1],[54,9,54,10,1],[58,9,58,10,1],[59,13,59,69,1],[60,13,60,94,1],[60,94,60,157,1],[60,157,60,159,1],[60,13,60,159,1],[61,13,61,93,1],[63,13,63,79,1],[64,13,64,104,1],[67,13,67,133,1],[69,13,69,33,1],[70,9,70,10,1],[74,9,74,10,1],[75,13,75,42,1],[76,13,76,74,1],[77,13,77,20,1],[77,22,77,27,1],[77,28,77,30,1],[77,31,77,90,1],[78,13,78,14,1],[79,17,79,53,1],[80,13,80,14,1],[81,13,81,69,1],[82,13,82,82,1],[83,13,83,94,1],[83,94,83,98,1],[83,98,83,100,1],[83,13,83,100,1],[84,13,84,93,1],[85,13,88,29,1],[88,29,88,30,1],[88,30,89,33,1],[89,33,89,89,1],[89,89,90,29,1],[90,29,90,30,1],[90,30,91,40,1],[91,40,91,53,1],[91,53,91,55,1],[85,13,91,55,1],[92,13,92,79,1],[93,13,93,68,1],[97,13,97,122,1],[99,13,99,78,1],[100,13,100,99,1],[101,9,101,10,1],[105,9,105,10,1],[106,13,106,42,1],[107,13,107,74,1],[108,13,108,20,1],[108,22,108,27,1],[108,28,108,30,1],[108,31,108,90,1],[109,13,109,14,1],[110,17,110,53,1],[111,13,111,14,1],[112,13,112,69,1],[113,13,113,82,1],[114,13,114,94,1],[114,94,114,98,1],[114,98,114,100,1],[114,13,114,100,1],[115,13,115,93,1],[116,13,119,29,1],[119,29,119,30,1],[119,30,120,33,1],[120,33,120,89,1],[120,89,121,29,1],[121,29,121,30,1],[121,30,122,40,1],[122,40,122,53,1],[122,53,122,55,1],[116,13,122,55,1],[124,13,124,79,1],[125,13,125,104,1],[129,13,129,122,1],[131,13,131,72,1],[132,13,132,86,1],[133,13,133,54,1],[134,9,134,10,1],[138,9,138,10,1],[139,13,139,42,1],[140,13,140,74,1],[141,13,141,20,1],[141,22,141,27,1],[141,28,141,30,1],[141,31,141,90,1],[142,13,142,14,1],[143,17,143,53,1],[144,13,144,14,1],[145,13,145,69,1],[146,13,146,82,1],[147,13,147,94,1],[147,94,147,98,1],[147,98,147,100,1],[147,13,147,100,1],[148,13,148,93,1],[149,13,152,25,1],[152,25,152,26,1],[152,26,153,29,1],[153,29,153,85,1],[153,85,154,25,1],[154,25,154,26,1],[154,26,155,40,1],[155,40,155,53,1],[155,53,155,55,1],[149,13,155,55,1],[157,13,157,79,1],[158,13,158,140,1],[162,13,162,122,1],[164,13,164,72,1],[167,13,167,100,1],[168,13,168,85,1],[169,13,169,61,1],[170,9,170,10,1]]);
    </script>
  </body>
</html>