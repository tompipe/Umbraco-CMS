<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\CanvasDesignerUtility.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Web.Http;
using AutoMapper;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Mvc;
using umbraco;
using Umbraco.Web.WebApi;
using System;
using System.Net.Http.Headers;
using System.Web;
using System.IO;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using System.Linq;
using System.Text.RegularExpressions;

namespace Umbraco.Web
{
    //TODO: This class needs to be overhauled:
    //  No statics that have dependencies!
    //  Make into a real class that accept the dependencies required.
    //  Remove all usages of singletons: HttpContext.Current, ApplicationContext.Current, UmbracoContext.Current, etc...

    internal static class CanvasDesignerUtility
    {

        internal static string canvasdesignerStylePath = &quot;/css/canvasdesigner/&quot;;
        internal static string resultLessPath = canvasdesignerStylePath + @&quot;{0}.less&quot;;
        internal static string resultCssPath = canvasdesignerStylePath + @&quot;{0}.css&quot;;
        internal static string frontBasePath = HttpContext.Current.Server.MapPath(@&quot;\css\canvasdesigner\&quot;);

        // get style box by tag
        internal static String GetStyleBlock(string source, string name) 
        {

            string startTag = string.Format(&quot;/***start-{0}***/&quot;, name);
            string endTag = string.Format(&quot;/***end-{0}***/&quot;, name);

            int indexStartTag = source.IndexOf(startTag);
            int indexEndTag = source.IndexOf(endTag);

            if (indexStartTag &gt;= 0 &amp;&amp; indexEndTag &gt;= 0)
                return source.Substring(indexStartTag, indexEndTag - indexStartTag).Replace(startTag, &quot;&quot;).Replace(endTag, &quot;&quot;);
            else
                return &quot;&quot;;

        }

        // Get less parameters from lessPath file, both general parameters and grid parameters
        internal static string GetLessParameters(int pageId)
        {

            // Load current page
            var contentService = ApplicationContext.Current.Services.ContentService;
            IContent content = contentService.GetById(pageId);

            // Get less file path from the page Id
            string lessPath = GetStylesheetPath(content.Path.Split(&#39;,&#39;), true);

            string paramBlock = string.Empty;
            if (System.IO.File.Exists(HttpContext.Current.Server.MapPath(lessPath)))
            {
                using (System.IO.StreamReader sr = new System.IO.StreamReader(HttpContext.Current.Server.MapPath(lessPath)))
                {

                    string lessContent = sr.ReadToEnd();
                    foreach (Match match in Regex.Matches(lessContent, string.Format(&quot;@([^;\n]*):([^;\n]*);&quot;)))
                    {
                        paramBlock = paramBlock + match.Groups[0].Value + &quot;\r\n&quot;;
                    }
                }
            }
            return paramBlock;

        }

        // Get inherited pageId with canvasdesigner
        internal static int GetParentOrSelfTunedPageId(string[] path, bool preview) 
        {

            string styleCanvasdesigner = preview ? @&quot;{0}{1}.less&quot; : &quot;{0}{1}.css&quot;;
            foreach (var page in path.OrderByDescending(r =&gt; path.IndexOf(r)))
            {
                string stylePath = HttpContext.Current.Server.MapPath(string.Format(styleCanvasdesigner, canvasdesignerStylePath, page));
                if (System.IO.File.Exists(stylePath))
                {
                    return int.Parse(page);
                }
            }

            if (preview)
                return int.Parse(path[1]);
            else
                return -1;
        }

        // Get stylesheet path for current page
        internal static string GetStylesheetPath(string[] path, bool preview)
        {
            string styleCanvasdesigner = preview ? @&quot;{0}{1}.less&quot; : &quot;{0}{1}.css&quot;;

            int tunedPageId = GetParentOrSelfTunedPageId(path, preview);

            if (tunedPageId &gt;0)
                return string.Format(styleCanvasdesigner, canvasdesignerStylePath, tunedPageId);
            else
                return string.Empty;
        }

        // Create new less file
        internal static string CreateOrUpdateLessFile(int pageId, string configs)
        {

            // Load current page
            var contentService = ApplicationContext.Current.Services.ContentService;
            IContent content = contentService.GetById(pageId);

            // Get less file path from the page Id
            string lessPath = GetStylesheetPath(content.Path.Split(&#39;,&#39;), true);

            // If less file exist, Load its  content
            string lessContent = string.Empty;
            if (System.IO.File.Exists(HttpContext.Current.Server.MapPath(lessPath)))
            {
                using (System.IO.StreamReader sr = new System.IO.StreamReader(HttpContext.Current.Server.MapPath(lessPath)))
                {
                    lessContent = sr.ReadToEnd();
                }
            }

            // Parse the config file
            // for each config read and add less script in global less
            dynamic canvasdesignerConfigs = Newtonsoft.Json.Linq.JObject.Parse(configs.ToString());
            foreach (var configuration in canvasdesignerConfigs.configs)
            {
                if (configuration.editors != null)
                {
                    foreach (var editorItem in configuration.editors)
                    {

                        var type = (editorItem.type != null &amp;&amp; !string.IsNullOrEmpty(editorItem.type.ToString())) ? editorItem.type.ToString() : string.Empty;
                        var alias = (editorItem.alias != null &amp;&amp; !string.IsNullOrEmpty(editorItem.alias.ToString())) ? editorItem.alias.ToString() : string.Empty;
                        var schema = (configuration.schema != null &amp;&amp; !string.IsNullOrEmpty(configuration.schema.ToString())) ? configuration.schema.ToString() : alias;
                        schema = (editorItem.schema != null &amp;&amp; !string.IsNullOrEmpty(editorItem.schema.ToString())) ? editorItem.schema.ToString() : schema;

                        if (string.IsNullOrEmpty(GetStyleBlock(lessContent, &quot;lessParam-&quot; + alias)))
                        {

                            // read the less model file
                            var lessModelPath = string.Format(&quot;/Umbraco/assets/less/{0}.less&quot;, type);
                            var lessModel = string.Empty;
                            if (System.IO.File.Exists(HttpContext.Current.Server.MapPath(lessModelPath)))
                            {
                                using (System.IO.StreamReader sr = new System.IO.StreamReader(HttpContext.Current.Server.MapPath(lessModelPath)))
                                {
                                    lessModel = sr.ReadToEnd();
                                }
                            }

                            lessContent = lessContent + Environment.NewLine + lessModel
                                .Replace(&quot;-ALIAS-&quot;, alias.ToLower())
                                .Replace(&quot;-SCHEMA-&quot;, schema);

                            foreach (var parameter in editorItem)
                            {
                                lessContent = lessContent.Replace(&quot;-&quot; + parameter.Name.ToString().ToUpper() + &quot;-&quot;, parameter.Value.ToString());
                            }

                        }
                    }
                }
            }

            //// Create front directory if necesary
            if (!Directory.Exists(frontBasePath))
                Directory.CreateDirectory(frontBasePath);

            // Save less file
            if (string.IsNullOrEmpty(lessPath)) lessPath = string.Format(&quot;{0}{1}.less&quot;, canvasdesignerStylePath, pageId);
            using (System.IO.StreamWriter file = new System.IO.StreamWriter(HttpContext.Current.Server.MapPath(lessPath)))
            {
                file.Write(lessContent);
            }

            return lessPath;

        }

        // Save and publish less style
        internal static void SaveAndPublishStyle(string parameters, int pageId, bool inherited) 
        {

            // Get inherited tuned pageId and path
            var contentService = ApplicationContext.Current.Services.ContentService;
            IContent content = contentService.GetById(pageId);
            int inheritedTunedPageId = CanvasDesignerUtility.GetParentOrSelfTunedPageId(content.Path.Split(&#39;,&#39;), true);

            // Load inherited Less content
            string inheritedLessContent = string.Empty;
            using (System.IO.StreamReader sr = new System.IO.StreamReader(HttpContext.Current.Server.MapPath(string.Format(resultLessPath, inheritedTunedPageId))))
            {
                inheritedLessContent = sr.ReadToEnd();
            }

            // Update pageId if parameters have changed
            if (inherited) pageId = inheritedTunedPageId;
            
            // Create front directory if necesary
            if (!Directory.Exists(frontBasePath))
                Directory.CreateDirectory(frontBasePath);

            // Prepare parameters and gf block and replace with the new value
            string newParamBlock = string.Empty;
            string newGfBlock = string.Empty;
            foreach (string parameter in parameters.Trim().Split(new string[] { &quot;;&quot; }, StringSplitOptions.RemoveEmptyEntries))
            {
                if (parameter.IndexOf(&quot;@import&quot;) &lt; 0)
                {
                    string name = parameter.Substring(0, parameter.IndexOf(&quot;:&quot;));
                    string value = parameter.Substring(parameter.IndexOf(&quot;:&quot;) + 1);
                    if (string.IsNullOrEmpty(value)) value = &quot;&#39;&#39;&quot;;
                    inheritedLessContent = Regex.Replace(inheritedLessContent, string.Format(&quot;{0}:([^;\n]*);&quot;, name), string.Format(&quot;{0}:{1};&quot;, name, value));
                }
                else
                {
                    newGfBlock += parameter + &quot;;&quot; + Environment.NewLine;
                }
            }

            // Save less file
            using (System.IO.StreamWriter file = new System.IO.StreamWriter(HttpContext.Current.Server.MapPath(string.Format(resultLessPath, pageId))))
            {
                file.Write(inheritedLessContent);
            }

            // Compile the Less file
            string compiledStyle = GetCssFromLessString(newGfBlock + inheritedLessContent, false, true, true).Replace(&quot;@import&quot;, &quot;@IMPORT&quot;);

            // Save compiled file
            using (System.IO.StreamWriter file = new System.IO.StreamWriter(HttpContext.Current.Server.MapPath(string.Format(resultCssPath, pageId))))
            {
                file.Write(compiledStyle);
            }

        }

        // Delete canvasdesigner style
        internal static void DeleteStyle(int pageId)
        {

            // Get inherited tuned pageId and path
            var contentService = ApplicationContext.Current.Services.ContentService;
            IContent content = contentService.GetById(pageId);
            int inheritedTunedPageId = CanvasDesignerUtility.GetParentOrSelfTunedPageId(content.Path.Split(&#39;,&#39;), true);

            // Path to the less and css files
            string newResultLessPath = HttpContext.Current.Server.MapPath(string.Format(resultLessPath, inheritedTunedPageId));
            string newResultCssPath = HttpContext.Current.Server.MapPath(string.Format(resultCssPath, inheritedTunedPageId));

            // Delete all style file for this page
            System.IO.File.Delete(newResultLessPath);
            System.IO.File.Delete(newResultCssPath);

        }

        // Compile and compress less style
        private static string GetCssFromLessString(string css, Boolean cacheEnabled, Boolean minifyOutput, Boolean disableVariableRedefines)
        {
            var config = dotless.Core.configuration.DotlessConfiguration.GetDefaultWeb();
            config.DisableVariableRedefines = disableVariableRedefines;
            config.CacheEnabled = cacheEnabled;
            config.MinifyOutput = minifyOutput;
            return dotless.Core.LessWeb.Parse(css, config);
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,81,0],[32,9,32,87,0],[33,9,33,85,0],[34,9,34,108,0],[38,9,38,10,0],[40,13,40,72,0],[41,13,41,68,0],[43,13,43,58,0],[44,13,44,54,0],[46,13,46,56,0],[47,17,47,127,0],[49,17,49,27,0],[51,9,51,10,0],[55,9,55,10,0],[58,13,58,85,0],[59,13,59,63,0],[62,13,62,80,0],[64,13,64,46,0],[65,13,65,85,0],[66,13,66,14,0],[67,24,67,124,0],[68,17,68,18,0],[70,21,70,57,0],[71,21,71,28,0],[71,30,71,41,0],[71,42,71,44,0],[71,45,71,111,0],[72,21,72,22,0],[73,25,73,82,0],[74,21,74,22,0],[75,17,75,18,0],[76,13,76,14,0],[77,13,77,31,0],[79,9,79,10,0],[83,9,83,10,0],[85,13,85,82,0],[86,13,86,20,0],[86,22,86,30,0],[86,31,86,33,0],[86,34,86,62,0],[86,62,86,77,0],[86,77,86,78,0],[86,34,86,78,0],[87,13,87,14,0],[88,17,88,138,0],[89,17,89,54,0],[90,17,90,18,0],[91,21,91,44,0],[93,13,93,14,0],[95,13,95,25,0],[96,17,96,43,0],[98,17,98,27,0],[99,9,99,10,0],[103,9,103,10,0],[104,13,104,82,0],[106,13,106,73,0],[108,13,108,32,0],[109,17,109,97,0],[111,17,111,37,0],[112,9,112,10,0],[116,9,116,10,0],[119,13,119,85,0],[120,13,120,63,0],[123,13,123,80,0],[126,13,126,47,0],[127,13,127,85,0],[128,13,128,14,0],[129,24,129,124,0],[130,17,130,18,0],[131,21,131,50,0],[132,17,132,18,0],[133,13,133,14,0],[137,13,137,100,0],[138,13,138,20,0],[138,22,138,39,0],[138,40,138,42,0],[138,43,138,72,0],[139,13,139,14,0],[140,17,140,51,0],[141,17,141,18,0],[142,21,142,28,0],[142,30,142,44,0],[142,45,142,47,0],[142,48,142,69,0],[143,21,143,22,0],[145,25,145,159,0],[146,25,146,163,0],[147,25,147,169,0],[148,25,148,157,0],[150,25,150,100,0],[151,25,151,26,0],[154,29,154,102,0],[155,29,155,58,0],[156,29,156,106,0],[157,29,157,30,0],[158,40,158,145,0],[159,33,159,34,0],[160,37,160,64,0],[161,33,161,34,0],[162,29,162,30,0],[164,29,166,62,0],[168,29,168,36,0],[168,38,168,51,0],[168,52,168,54,0],[168,55,168,65,0],[169,29,169,30,0],[170,33,170,144,0],[171,29,171,30,0],[173,25,173,26,0],[174,21,174,22,0],[175,17,175,18,0],[176,13,176,14,0],[179,13,179,50,0],[180,17,180,58,0],[183,13,183,48,0],[183,49,183,122,0],[184,20,184,122,0],[185,13,185,14,0],[186,17,186,41,0],[187,13,187,14,0],[189,13,189,29,0],[191,9,191,10,0],[195,9,195,10,0],[198,13,198,85,0],[199,13,199,63,0],[200,13,200,120,0],[203,13,203,56,0],[204,20,204,163,0],[205,13,205,14,0],[206,17,206,55,0],[207,13,207,14,0],[210,13,210,27,0],[210,28,210,58,0],[213,13,213,50,0],[214,17,214,58,0],[217,13,217,49,0],[218,13,218,46,0],[219,13,219,20,0],[219,22,219,38,0],[219,39,219,41,0],[219,42,219,126,0],[220,13,220,14,0],[221,17,221,54,0],[222,17,222,18,0],[223,21,223,82,0],[224,21,224,84,0],[225,21,225,53,0],[225,54,225,67,0],[226,21,226,159,0],[227,17,227,18,0],[229,17,229,18,0],[230,21,230,73,0],[231,17,231,18,0],[232,13,232,14,0],[235,20,235,151,0],[236,13,236,14,0],[237,17,237,50,0],[238,13,238,14,0],[241,13,241,141,0],[244,20,244,150,0],[245,13,245,14,0],[246,17,246,43,0],[247,13,247,14,0],[249,9,249,10,0],[253,9,253,10,0],[256,13,256,85,0],[257,13,257,63,0],[258,13,258,120,0],[261,13,261,128,0],[262,13,262,126,0],[265,13,265,54,0],[266,13,266,53,0],[268,9,268,10,0],[272,9,272,10,0],[273,13,273,90,0],[274,13,274,72,0],[275,13,275,48,0],[276,13,276,48,0],[277,13,277,60,0],[278,9,278,10,0]]);
    </script>
  </body>
</html>