<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Routing\ContentLastChanceFinderByNotFoundHandlers.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using umbraco.interfaces;

namespace Umbraco.Web.Routing
{
	/// &lt;summary&gt;
	/// Provides an implementation of &lt;see cref=&quot;IContentFinder&quot;/&gt; that runs legacy &lt;c&gt;INotFoundHandler&lt;/c&gt; in &quot;last chance&quot; situation.
	/// &lt;/summary&gt;
    public class ContentLastChanceFinderByNotFoundHandlers : IContentFinder
    {
		// notes
		//
		// at the moment we load the legacy INotFoundHandler
		// excluding those that have been replaced by proper finders,
		// and run them.

		/// &lt;summary&gt;
		/// Tries to find and assign an Umbraco document to a &lt;c&gt;PublishedContentRequest&lt;/c&gt;.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;docRequest&quot;&gt;The &lt;c&gt;PublishedContentRequest&lt;/c&gt;.&lt;/param&gt;
		/// &lt;returns&gt;A value indicating whether an Umbraco document was found and assigned.&lt;/returns&gt;
		public bool TryFindContent(PublishedContentRequest docRequest)
        {
			HandlePageNotFound(docRequest);
            return docRequest.HasPublishedContent;
        }

		#region Copied over and adapted from presentation.requestHandler

	    private static void HandlePageNotFound(PublishedContentRequest docRequest)
        {			
			var url = NotFoundHandlerHelper.GetLegacyUrlForNotFoundHandlers();
            LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Running for legacy url=&#39;{0}&#39;.&quot;, () =&gt; url);

	        var handler = NotFoundHandlerHelper.GetNotFoundLastChanceHandler();
            var handlerName = handler.GetType().FullName;
            LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39;.&quot;, () =&gt; handlerName);

            var finder = NotFoundHandlerHelper.SubsituteFinder(handler);
            if (finder != null)
            {
                var finderName = finder.GetType().FullName;
                LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Replace handler &#39;{0}&#39; by new finder &#39;{1}&#39;.&quot;, () =&gt; handlerName, () =&gt; finderName);

                // can&#39;t find a document =&gt; exit
                if (finder.TryFindContent(docRequest) == false)
                    return;

                // found a document =&gt; we&#39;re done

                // in theory an IContentFinder can return true yet set no document
                // but none of the substitued finders (see SubstituteFinder) do it.

                // do NOT set docRequest.PublishedContent again here
                // as it would clear any template that the finder might have set

                LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Finder &#39;{0}&#39; found node with id={1}.&quot;, () =&gt; finderName, () =&gt; docRequest.PublishedContent.Id);
                if (docRequest.Is404)
                    LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Finder &#39;{0}&#39; set status to 404.&quot;, () =&gt; finderName);

                LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39; found valid node with id={1}.&quot;, () =&gt; handlerName, () =&gt; docRequest.PublishedContent.Id);
                return;
            }

            // else it&#39;s a legacy handler, run

            // can&#39;t find a document =&gt; exit
            if (handler.Execute(url) == false || handler.redirectID &lt;= 0)
                return;

            // found a document ID =&gt; ensure it&#39;s a valid document
            var redirectId = handler.redirectID;
            docRequest.PublishedContent = docRequest.RoutingContext.UmbracoContext.ContentCache.GetById(redirectId);

            if (docRequest.HasPublishedContent == false)
            {
                // the handler said it could handle the url, and returned a content ID
                // yet that content ID is invalid... exit.

                LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39; found node with id={1} which is not valid.&quot;, () =&gt; handlerName, () =&gt; redirectId);
                return;
            }

            // found a valid document =&gt; return

            LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39; found valid node with id={1}.&quot;, () =&gt; handlerName, () =&gt; redirectId);

            if (docRequest.RoutingContext.UmbracoContext.HttpContext.Response.StatusCode == 404)
            {
                LogHelper.Debug&lt;ContentLastChanceFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39; set status code to 404.&quot;, () =&gt; handlerName);
                docRequest.Is404 = true;
            }
        }

		#endregion
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,0],[28,4,28,35,0],[29,13,29,51,0],[30,9,30,10,0],[35,9,35,10,0],[36,4,36,70,0],[37,13,37,111,0],[37,111,37,114,0],[37,114,37,116,0],[37,13,37,116,0],[39,10,39,77,0],[40,13,40,58,0],[41,13,41,96,0],[41,96,41,107,0],[41,107,41,109,0],[41,13,41,109,0],[43,13,43,73,0],[44,13,44,32,0],[45,13,45,14,0],[46,17,46,60,0],[47,17,47,128,0],[47,128,47,139,0],[47,139,47,147,0],[47,147,47,157,0],[47,157,47,159,0],[47,17,47,159,0],[50,17,50,64,0],[51,21,51,28,0],[61,17,61,122,0],[61,122,61,132,0],[61,132,61,140,0],[61,140,61,170,0],[61,170,61,172,0],[61,17,61,172,0],[62,17,62,38,0],[63,21,63,121,0],[63,121,63,131,0],[63,131,63,133,0],[63,21,63,133,0],[65,17,65,129,0],[65,129,65,140,0],[65,140,65,148,0],[65,148,65,178,0],[65,178,65,180,0],[65,17,65,180,0],[66,17,66,24,0],[72,13,72,74,0],[73,17,73,24,0],[76,13,76,49,0],[77,13,77,117,0],[79,13,79,57,0],[80,13,80,14,0],[84,17,84,142,0],[84,142,84,153,0],[84,153,84,161,0],[84,161,84,171,0],[84,171,84,173,0],[84,17,84,173,0],[85,17,85,24,0],[90,13,90,125,0],[90,125,90,136,0],[90,136,90,144,0],[90,144,90,154,0],[90,154,90,156,0],[90,13,90,156,0],[92,13,92,97,0],[93,13,93,14,0],[94,17,94,123,0],[94,123,94,134,0],[94,134,94,136,0],[94,17,94,136,0],[95,17,95,41,0],[96,13,96,14,0],[97,9,97,10,0]]);
    </script>
  </body>
</html>