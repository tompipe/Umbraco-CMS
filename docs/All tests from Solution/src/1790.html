<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Syntax\Create\Table\CreateTableBuilder.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Data;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.Migrations.Syntax.Create.Expressions;
using Umbraco.Core.Persistence.Migrations.Syntax.Expressions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Syntax.Create.Table
{
    public class CreateTableBuilder : ExpressionBuilder&lt;CreateTableExpression, ICreateTableColumnOptionSyntax&gt;,
                                                ICreateTableWithColumnSyntax,
                                                ICreateTableColumnAsTypeSyntax,
                                                ICreateTableColumnOptionForeignKeyCascadeSyntax
    {
        private readonly IMigrationContext _context;
        private readonly DatabaseProviders[] _databaseProviders;

        public CreateTableBuilder(IMigrationContext context, DatabaseProviders[] databaseProviders, CreateTableExpression expression)
            : base(expression)
        {
            _context = context;
            _databaseProviders = databaseProviders;
        }

        public ColumnDefinition CurrentColumn { get; set; }

        public ForeignKeyDefinition CurrentForeignKey { get; set; }

        public override ColumnDefinition GetColumnForType()
        {
            return CurrentColumn;
        }

        public ICreateTableColumnAsTypeSyntax WithColumn(string name)
        {
            var column = new ColumnDefinition { Name = name, TableName = Expression.TableName, ModificationType = ModificationType.Create };
            Expression.Columns.Add(column);
            CurrentColumn = column;
            return this;
        }

        public ICreateTableColumnOptionSyntax WithDefault(SystemMethods method)
        {
            CurrentColumn.DefaultValue = method;
            return this;
        }

        public ICreateTableColumnOptionSyntax WithDefaultValue(object value)
        {
            CurrentColumn.DefaultValue = value;
            return this;
        }

        public ICreateTableColumnOptionSyntax Identity()
        {
            CurrentColumn.IsIdentity = true;
            return this;
        }

        public ICreateTableColumnOptionSyntax Indexed()
        {
            return Indexed(null);
        }

        public ICreateTableColumnOptionSyntax Indexed(string indexName)
        {
            CurrentColumn.IsIndexed = true;

            var index = new CreateIndexExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new IndexDefinition
            {
                Name = indexName,
                SchemaName = Expression.SchemaName,
                TableName = Expression.TableName
            });

            index.Index.Columns.Add(new IndexColumnDefinition
                                        {
                                            Name = CurrentColumn.Name
                                        });

            _context.Expressions.Add(index);

            return this;
        }

        public ICreateTableColumnOptionSyntax PrimaryKey()
        {
            CurrentColumn.IsPrimaryKey = true;

            //For MySQL, the PK will be created WITH the create table expression, however for 
            // SQL Server, the PK get&#39;s created in a different Alter table expression afterwords.
            // MySQL will choke if the same constraint is again added afterword
            // TODO: This is a super hack, I&#39;d rather not add another property like &#39;CreatesPkInCreateTableDefinition&#39; to check
            // for this, but I don&#39;t see another way around. MySQL doesn&#39;t support checking for a constraint before creating
            // it... except in a very strange way but it doesn&#39;t actually provider error feedback if it doesn&#39;t work so we cannot use
            // it.  For now, this is what I&#39;m doing
            if (Expression.CurrentDatabaseProvider != DatabaseProviders.MySql)
            {
                var expression = new CreateConstraintExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, ConstraintType.PrimaryKey)
                {
                    Constraint =
                {
                    TableName = CurrentColumn.TableName,
                    Columns = new[] { CurrentColumn.Name }
                }
                };
                _context.Expressions.Add(expression);
            }

            return this;
        }

        public ICreateTableColumnOptionSyntax PrimaryKey(string primaryKeyName)
        {
            CurrentColumn.IsPrimaryKey = true;
            CurrentColumn.PrimaryKeyName = primaryKeyName;

            //For MySQL, the PK will be created WITH the create table expression, however for 
            // SQL Server, the PK get&#39;s created in a different Alter table expression afterwords.
            // MySQL will choke if the same constraint is again added afterword
            // TODO: This is a super hack, I&#39;d rather not add another property like &#39;CreatesPkInCreateTableDefinition&#39; to check
            // for this, but I don&#39;t see another way around. MySQL doesn&#39;t support checking for a constraint before creating
            // it... except in a very strange way but it doesn&#39;t actually provider error feedback if it doesn&#39;t work so we cannot use
            // it.  For now, this is what I&#39;m doing

            if (Expression.CurrentDatabaseProvider != DatabaseProviders.MySql)
            {
                var expression = new CreateConstraintExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, ConstraintType.PrimaryKey)
                {
                    Constraint =
                {
                    ConstraintName = primaryKeyName,
                    TableName = CurrentColumn.TableName,
                    Columns = new[] { CurrentColumn.Name }
                }
                };
                _context.Expressions.Add(expression);
            }
            
            return this;
        }

        public ICreateTableColumnOptionSyntax Nullable()
        {
            CurrentColumn.IsNullable = true;
            return this;
        }

        public ICreateTableColumnOptionSyntax NotNullable()
        {
            CurrentColumn.IsNullable = false;
            return this;
        }

        public ICreateTableColumnOptionSyntax Unique()
        {
            return Unique(null);
        }

        public ICreateTableColumnOptionSyntax Unique(string indexName)
        {
            CurrentColumn.IsUnique = true;

            var index = new CreateIndexExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new IndexDefinition
            {
                Name = indexName,
                SchemaName = Expression.SchemaName,
                TableName = Expression.TableName,
                IsUnique = true
            });

            index.Index.Columns.Add(new IndexColumnDefinition
                                        {
                                            Name = CurrentColumn.Name
                                        });

            _context.Expressions.Add(index);

            return this;
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax ForeignKey(string primaryTableName, string primaryColumnName)
        {
            return ForeignKey(null, null, primaryTableName, primaryColumnName);
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax ForeignKey(string foreignKeyName, string primaryTableName,
                                                                          string primaryColumnName)
        {
            return ForeignKey(foreignKeyName, null, primaryTableName, primaryColumnName);
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax ForeignKey(string foreignKeyName, string primaryTableSchema,
                                                                          string primaryTableName, string primaryColumnName)
        {
            CurrentColumn.IsForeignKey = true;

            var fk = new CreateForeignKeyExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new ForeignKeyDefinition
            {
                Name = foreignKeyName,
                PrimaryTable = primaryTableName,
                PrimaryTableSchema = primaryTableSchema,
                ForeignTable = Expression.TableName,
                ForeignTableSchema = Expression.SchemaName
            });

            fk.ForeignKey.PrimaryColumns.Add(primaryColumnName);
            fk.ForeignKey.ForeignColumns.Add(CurrentColumn.Name);

            _context.Expressions.Add(fk);
            CurrentForeignKey = fk.ForeignKey;
            return this;
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax ForeignKey()
        {
            CurrentColumn.IsForeignKey = true;
            return this;
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignTableName, string foreignColumnName)
        {
            return ReferencedBy(null, null, foreignTableName, foreignColumnName);
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignKeyName, string foreignTableName,
                                                                            string foreignColumnName)
        {
            return ReferencedBy(foreignKeyName, null, foreignTableName, foreignColumnName);
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax ReferencedBy(string foreignKeyName, string foreignTableSchema,
                                                                            string foreignTableName, string foreignColumnName)
        {
            var fk = new CreateForeignKeyExpression(_context.CurrentDatabaseProvider, _databaseProviders, Expression.SqlSyntax, new ForeignKeyDefinition
            {
                Name = foreignKeyName,
                PrimaryTable = Expression.TableName,
                PrimaryTableSchema = Expression.SchemaName,
                ForeignTable = foreignTableName,
                ForeignTableSchema = foreignTableSchema
            });

            fk.ForeignKey.PrimaryColumns.Add(CurrentColumn.Name);
            fk.ForeignKey.ForeignColumns.Add(foreignColumnName);

            _context.Expressions.Add(fk);
            CurrentForeignKey = fk.ForeignKey;
            return this;
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax OnDelete(Rule rule)
        {
            CurrentForeignKey.OnDelete = rule;
            return this;
        }

        public ICreateTableColumnOptionForeignKeyCascadeSyntax OnUpdate(Rule rule)
        {
            CurrentForeignKey.OnUpdate = rule;
            return this;
        }

        public ICreateTableColumnOptionSyntax OnDeleteOrUpdate(Rule rule)
        {
            OnDelete(rule);
            OnUpdate(rule);
            return this;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,15,18,31,1],[19,9,19,10,1],[20,13,20,32,1],[21,13,21,52,1],[22,9,22,10,1],[24,49,24,53,1],[24,54,24,58,1],[26,57,26,61,0],[26,62,26,66,0],[29,9,29,10,1],[30,13,30,34,1],[31,9,31,10,1],[34,9,34,10,1],[35,13,35,141,1],[36,13,36,44,1],[37,13,37,36,1],[38,13,38,25,1],[39,9,39,10,1],[42,9,42,10,0],[43,13,43,49,0],[44,13,44,25,0],[45,9,45,10,0],[48,9,48,10,0],[49,13,49,48,0],[50,13,50,25,0],[51,9,51,10,0],[54,9,54,10,0],[55,13,55,45,0],[56,13,56,25,0],[57,9,57,10,0],[60,9,60,10,0],[61,13,61,34,0],[62,9,62,10,0],[65,9,65,10,0],[66,13,66,44,0],[68,13,73,16,0],[75,13,78,44,0],[80,13,80,45,0],[82,13,82,25,0],[83,9,83,10,0],[86,9,86,10,0],[87,13,87,47,0],[96,13,96,79,0],[97,13,97,14,0],[98,17,105,19,0],[106,17,106,54,0],[107,13,107,14,0],[109,13,109,25,0],[110,9,110,10,0],[113,9,113,10,1],[114,13,114,47,1],[115,13,115,59,1],[125,13,125,79,1],[126,13,126,14,1],[127,17,135,19,1],[136,17,136,54,1],[137,13,137,14,1],[139,13,139,25,1],[140,9,140,10,1],[143,9,143,10,0],[144,13,144,45,0],[145,13,145,25,0],[146,9,146,10,0],[149,9,149,10,1],[150,13,150,46,1],[151,13,151,25,1],[152,9,152,10,1],[155,9,155,10,0],[156,13,156,33,0],[157,9,157,10,0],[160,9,160,10,0],[161,13,161,43,0],[163,13,169,16,0],[171,13,174,44,0],[176,13,176,45,0],[178,13,178,25,0],[179,9,179,10,0],[182,9,182,10,0],[183,13,183,80,0],[184,9,184,10,0],[188,9,188,10,0],[189,13,189,90,0],[190,9,190,10,0],[194,9,194,10,0],[195,13,195,47,0],[197,13,204,16,0],[206,13,206,65,0],[207,13,207,66,0],[209,13,209,42,0],[210,13,210,47,0],[211,13,211,25,0],[212,9,212,10,0],[215,9,215,10,0],[216,13,216,47,0],[217,13,217,25,0],[218,9,218,10,0],[221,9,221,10,0],[222,13,222,82,0],[223,9,223,10,0],[227,9,227,10,0],[228,13,228,92,0],[229,9,229,10,0],[233,9,233,10,0],[234,13,241,16,0],[243,13,243,66,0],[244,13,244,65,0],[246,13,246,42,0],[247,13,247,47,0],[248,13,248,25,0],[249,9,249,10,0],[252,9,252,10,0],[253,13,253,47,0],[254,13,254,25,0],[255,9,255,10,0],[258,9,258,10,0],[259,13,259,47,0],[260,13,260,25,0],[261,9,261,10,0],[264,9,264,10,0],[265,13,265,28,0],[266,13,266,28,0],[267,13,267,25,0],[268,9,268,10,0]]);
    </script>
  </body>
</html>