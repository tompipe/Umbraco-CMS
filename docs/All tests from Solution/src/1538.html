<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Services\TagExtractor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using Newtonsoft.Json;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Editors;
using Umbraco.Core.PropertyEditors;

namespace Umbraco.Core.Services
{
    /// &lt;summary&gt;
    /// A simple utility class to extract the tag values from a property/property editor and set them on the content
    /// &lt;/summary&gt;
    internal class TagExtractor
    {
        public static SupportTagsAttribute GetAttribute(PropertyEditor propEd)
        {
            if (propEd == null) return null;
            var tagSupport = propEd.GetType().GetCustomAttribute&lt;SupportTagsAttribute&gt;(false);
            return tagSupport;
        }

        /// &lt;summary&gt;
        /// Sets the tag values on the content property based on the property editor&#39;s tags attribute
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;property&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;propertyData&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;convertedPropertyValue&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;&lt;/param&gt;
        public static void SetPropertyTags(Property property, ContentPropertyData propertyData, object convertedPropertyValue, SupportTagsAttribute attribute)
        {
            //check for a custom definition
            if (attribute.TagPropertyDefinitionType != null)
            {
                //try to create it
                TagPropertyDefinition def;
                try
                {
                    def = (TagPropertyDefinition) Activator.CreateInstance(attribute.TagPropertyDefinitionType, propertyData, attribute);
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;TagExtractor&gt;(&quot;Could not create custom &quot; + attribute.TagPropertyDefinitionType + &quot; tag definition&quot;, ex);
                    throw;
                }
                SetPropertyTags(property, convertedPropertyValue, def.Delimiter, def.ReplaceTags, def.TagGroup, attribute.ValueType, def.StorageType);
            }
            else
            {
                SetPropertyTags(property, convertedPropertyValue, attribute.Delimiter, attribute.ReplaceTags, attribute.TagGroup, attribute.ValueType, attribute.StorageType);
            }
        }

        public static void SetPropertyTags(Property property, object convertedPropertyValue, string delimiter, bool replaceTags, string tagGroup, TagValueType valueType, TagCacheStorageType storageType)
        {
            if (convertedPropertyValue == null)
            {
                convertedPropertyValue = &quot;&quot;;
            }

            switch (valueType)
            {
                case TagValueType.FromDelimitedValue:
                    var tags = convertedPropertyValue.ToString().Split(new[] { delimiter }, StringSplitOptions.RemoveEmptyEntries);
                    property.SetTags(storageType, property.Alias, tags, replaceTags, tagGroup);
                    break;
                case TagValueType.CustomTagList:
                    //for this to work the object value must be IENumerable&lt;string&gt;
                    var stringList = convertedPropertyValue as IEnumerable&lt;string&gt;;
                    if (stringList != null)
                    {
                        property.SetTags(storageType, property.Alias, stringList, replaceTags, tagGroup);
                    }
                    else
                    {
                        //it&#39;s not enumerable string, so lets see if we can automatically make it that way based on the current storage type
                        switch (storageType)
                        {
                            case TagCacheStorageType.Csv:
                                var split = convertedPropertyValue.ToString().Split(new[] { delimiter }, StringSplitOptions.RemoveEmptyEntries);
                                //recurse with new value
                                SetPropertyTags(property, split, delimiter, replaceTags, tagGroup, valueType, storageType);
                                break;
                            case TagCacheStorageType.Json:
                                try
                                {
                                    var parsedJson = JsonConvert.DeserializeObject&lt;IEnumerable&lt;string&gt;&gt;(convertedPropertyValue.ToString());
                                    if (parsedJson != null)
                                    {
                                        //recurse with new value
                                        SetPropertyTags(property, parsedJson, delimiter, replaceTags, tagGroup, valueType, storageType);   
                                    }                                    
                                }
                                catch (Exception ex)
                                {
                                    LogHelper.WarnWithException&lt;TagExtractor&gt;(&quot;Could not automatically convert stored json value to an enumerable string&quot;, ex);
                                }
                                break;
                            default:
                                throw new ArgumentOutOfRangeException(&quot;storageType&quot;);
                        }
                    }
                    break;
            }
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,10,1],[18,13,18,32,1],[18,33,18,45,0],[19,13,19,95,1],[20,13,20,31,1],[21,9,21,10,1],[31,9,31,10,1],[33,13,33,61,1],[34,13,34,14,1],[38,17,38,18,1],[39,21,39,138,1],[40,17,40,18,1],[41,17,41,37,0],[42,17,42,18,0],[43,21,43,141,0],[44,21,44,27,0],[46,17,46,151,1],[47,13,47,14,1],[49,13,49,14,0],[50,17,50,175,0],[51,13,51,14,0],[52,9,52,10,1],[55,9,55,10,1],[56,13,56,48,1],[57,13,57,14,0],[58,17,58,45,0],[59,13,59,14,0],[61,13,61,31,1],[64,21,64,132,0],[65,21,65,96,0],[66,21,66,27,0],[69,21,69,84,1],[70,21,70,44,1],[71,21,71,22,1],[72,25,72,106,1],[73,21,73,22,1],[75,21,75,22,1],[77,25,77,45,1],[80,33,80,145,1],[82,33,82,124,1],[83,33,83,39,1],[86,33,86,34,0],[87,37,87,140,0],[88,37,88,60,0],[89,37,89,38,0],[91,41,91,137,0],[92,37,92,38,0],[93,33,93,34,0],[94,33,94,53,0],[95,33,95,34,0],[96,37,96,160,0],[97,33,97,34,0],[98,33,98,39,0],[100,33,100,86,0],[102,21,102,22,1],[103,21,103,27,1],[105,9,105,10,1]]);
    </script>
  </body>
</html>