<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Security\Providers\MembersMembershipProvider.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Specialized;
using System.ComponentModel.DataAnnotations;
using System.Configuration.Provider;
using System.Security.Cryptography;
using System.Text;
using System.Text.RegularExpressions;
using System.Web.Hosting;
using System.Web.Security;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Security;
using Umbraco.Core.Services;
using Umbraco.Core.Models.Membership;

namespace Umbraco.Web.Security.Providers
{
    /// &lt;summary&gt;
    /// Custom Membership Provider for Umbraco Members (User authentication for Frontend applications NOT umbraco CMS)  
    /// &lt;/summary&gt;
    public class MembersMembershipProvider : UmbracoMembershipProvider&lt;IMembershipMemberService, IMember&gt;, IUmbracoMemberTypeMembershipProvider
    {
        public MembersMembershipProvider()
            : this(ApplicationContext.Current.Services.MemberService)
        {
        }

        public MembersMembershipProvider(IMembershipMemberService&lt;IMember&gt; memberService)
            : base(memberService)
        {
            LockPropertyTypeAlias = Constants.Conventions.Member.IsLockedOut;
            LastLockedOutPropertyTypeAlias = Constants.Conventions.Member.LastLockoutDate;
            FailedPasswordAttemptsPropertyTypeAlias = Constants.Conventions.Member.FailedPasswordAttempts;
            ApprovedPropertyTypeAlias = Constants.Conventions.Member.IsApproved;
            CommentPropertyTypeAlias = Constants.Conventions.Member.Comments;
            LastLoginPropertyTypeAlias = Constants.Conventions.Member.LastLoginDate;
            LastPasswordChangedPropertyTypeAlias = Constants.Conventions.Member.LastPasswordChangeDate;
            PasswordRetrievalQuestionPropertyTypeAlias = Constants.Conventions.Member.PasswordQuestion;
            PasswordRetrievalAnswerPropertyTypeAlias = Constants.Conventions.Member.PasswordAnswer;
        }

        private string _defaultMemberTypeAlias = &quot;Member&quot;;
        private volatile bool _hasDefaultMember = false;
        private static readonly object Locker = new object();
        private bool _providerKeyAsGuid = false;

        public override string ProviderName
        {
            get { return &quot;MembersMembershipProvider&quot;; }
        }
        
        protected override MembershipUser ConvertToMembershipUser(IMember entity)
        {
            return entity.AsConcreteMembershipUser(Name, _providerKeyAsGuid);
        }

        public string LockPropertyTypeAlias { get; private set; }
        public string LastLockedOutPropertyTypeAlias { get; private set; }
        public string FailedPasswordAttemptsPropertyTypeAlias { get; private set; }
        public string ApprovedPropertyTypeAlias { get; private set; }
        public string CommentPropertyTypeAlias { get; private set; }
        public string LastLoginPropertyTypeAlias { get; private set; }
        public string LastPasswordChangedPropertyTypeAlias { get; private set; }
        public string PasswordRetrievalQuestionPropertyTypeAlias { get; private set; }
        public string PasswordRetrievalAnswerPropertyTypeAlias { get; private set; }

        public override void Initialize(string name, NameValueCollection config)
        {
            base.Initialize(name, config);

            // test for membertype (if not specified, choose the first member type available)
            if (config[&quot;defaultMemberTypeAlias&quot;] != null)
            {
                _defaultMemberTypeAlias = config[&quot;defaultMemberTypeAlias&quot;];
                if (_defaultMemberTypeAlias.IsNullOrWhiteSpace())
                {
                    throw new ProviderException(&quot;No default user type alias is specified in the web.config string. Please add a &#39;defaultUserTypeAlias&#39; to the add element in the provider declaration in web.config&quot;);
                }
                _hasDefaultMember = true;
            }

            //devs can configure the provider user key to be a guid if they want, by default it is int
            if (config[&quot;providerKeyType&quot;] != null)
            {
                if (config[&quot;providerKeyType&quot;] == &quot;guid&quot;)
                {
                    _providerKeyAsGuid = true;
                }
            }
        }

        public override string DefaultMemberTypeAlias
        {
            get
            {
                if (_hasDefaultMember == false)
                {
                    lock (Locker)
                    {
                        if (_hasDefaultMember == false)
                        {
                            _defaultMemberTypeAlias = MemberService.GetDefaultMemberType();
                            if (_defaultMemberTypeAlias.IsNullOrWhiteSpace())
                            {
                                throw new ProviderException(&quot;No default user type alias is specified in the web.config string. Please add a &#39;defaultUserTypeAlias&#39; to the add element in the provider declaration in web.config&quot;);
                            }
                            _hasDefaultMember = true;
                        }
                    }
                }
                return _defaultMemberTypeAlias;
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,15,24,70,0],[25,9,25,10,0],[26,9,26,10,0],[29,15,29,34,1],[30,9,30,10,1],[31,13,31,78,1],[32,13,32,91,1],[33,13,33,107,1],[34,13,34,81,1],[35,13,35,78,1],[36,13,36,85,1],[37,13,37,104,1],[38,13,38,104,1],[39,13,39,100,1],[40,9,40,10,1],[42,9,42,59,1],[43,9,43,57,1],[44,9,44,62,1],[45,9,45,49,1],[49,17,49,18,0],[49,19,49,54,0],[49,55,49,56,0],[53,9,53,10,1],[54,13,54,78,1],[55,9,55,10,1],[57,47,57,51,0],[57,52,57,64,1],[58,56,58,60,0],[58,61,58,73,1],[59,65,59,69,0],[59,70,59,82,1],[60,51,60,55,0],[60,56,60,68,1],[61,50,61,54,0],[61,55,61,67,1],[62,52,62,56,0],[62,57,62,69,1],[63,62,63,66,0],[63,67,63,79,1],[64,68,64,72,0],[64,73,64,85,1],[65,66,65,70,0],[65,71,65,83,1],[68,9,68,10,1],[69,13,69,43,1],[72,13,72,58,1],[73,13,73,14,1],[74,17,74,76,1],[75,17,75,66,1],[76,17,76,18,0],[77,21,77,215,0],[79,17,79,42,1],[80,13,80,14,1],[83,13,83,51,1],[84,13,84,14,0],[85,17,85,57,0],[86,17,86,18,0],[87,21,87,47,0],[88,17,88,18,0],[89,13,89,14,0],[90,9,90,10,1],[95,13,95,14,1],[96,17,96,48,1],[97,17,97,18,1],[98,21,98,34,1],[99,21,99,22,1],[100,25,100,56,1],[101,25,101,26,1],[102,29,102,92,1],[103,29,103,78,1],[104,29,104,30,0],[105,33,105,227,0],[107,29,107,54,1],[108,25,108,26,1],[109,21,109,22,1],[110,17,110,18,1],[111,17,111,48,1],[112,13,112,14,1]]);
    </script>
  </body>
</html>