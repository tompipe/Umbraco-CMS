<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\library.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Mail;
using System.Text;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.UI;
using System.Xml;
using System.Xml.Linq;
using System.Xml.XPath;
using Newtonsoft.Json;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Configuration;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Web;
using Umbraco.Web.Cache;
using Umbraco.Web.Templates;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic;
using umbraco.cms.businesslogic.web;
using umbraco.cms.helpers;
using umbraco.scripting;
using umbraco.DataLayer;
using Umbraco.Core.IO;
using Language = umbraco.cms.businesslogic.language.Language;
using Media = umbraco.cms.businesslogic.media.Media;
using Member = umbraco.cms.businesslogic.member.Member;
using PropertyType = umbraco.cms.businesslogic.propertytype.PropertyType;
using Relation = umbraco.cms.businesslogic.relation.Relation;
using UmbracoContext = umbraco.presentation.UmbracoContext;

namespace umbraco
{
    /// &lt;summary&gt;
    /// Function library for umbraco. Includes various helper-methods and methods to
    /// save and load data from umbraco. 
    /// 
    /// Especially usefull in XSLT where any of these methods can be accesed using the umbraco.library name-space. Example:
    /// &amp;lt;xsl:value-of select=&quot;umbraco.library:NiceUrl(@id)&quot;/&amp;gt;
    /// &lt;/summary&gt;
    public class library
    {
		/// &lt;summary&gt;
		/// Returns a new UmbracoHelper so that we can start moving the logic from some of these methods to it
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		private static UmbracoHelper GetUmbracoHelper()
		{
			return new UmbracoHelper(Umbraco.Web.UmbracoContext.Current);
		}

        #region Declarations

        /// &lt;summary&gt;
        /// Used by umbraco&#39;s publishing enginge, to determine if publishing is currently active
        /// &lt;/summary&gt;
        public static bool IsPublishing = false;
        /// &lt;summary&gt;
        /// Used by umbraco&#39;s publishing enginge, to how many nodes is publish in the current publishing cycle
        /// &lt;/summary&gt;
        public static int NodesPublished = 0;
        /// &lt;summary&gt;
        /// Used by umbraco&#39;s publishing enginge, to determine the start time of the current publishing cycle.
        /// &lt;/summary&gt;
        public static DateTime PublishStart;
        private page _page;
        private static readonly object libraryCacheLock = new object();

        #endregion

        #region Properties

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        protected static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        #endregion

        #region Constructors

        /// &lt;summary&gt;
        /// Empty constructor
        /// &lt;/summary&gt;
        public library()
        {
        }

        public library(int id)
        {
            _page = new page(((System.Xml.IHasXmlNode)GetXmlNodeById(id.ToString()).Current).GetNode());
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;library&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Page&quot;&gt;The page.&lt;/param&gt;
        public library(page page)
        {
            _page = page;
        }

        #endregion

        #region Python Helper functions

        /// &lt;summary&gt;
        /// Executes the given python script and returns the standardoutput.
        /// The Globals known from python macros are not accessible in this context.
        /// Neither macro or page nor the globals known from python macros are 
        /// accessible in this context. Only stuff we initialized in site.py
        /// can be used.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;file&quot;&gt;The filename of the python script including the extension .py&lt;/param&gt;
        /// &lt;returns&gt;Returns the StandardOutput&lt;/returns&gt;
        public static string PythonExecuteFile(string file)
        {
            try
            {
                string path = IOHelper.MapPath(SystemDirectories.MacroScripts + &quot;/&quot; + file);
                object res = python.executeFile(path);
                return res.ToString();
            }
            catch (Exception e)
            {
                return e.Message;
            }
        }

        /// &lt;summary&gt;
        /// Executes the given python expression and returns the standardoutput.
        /// The Globals known from python macros are not accessible in this context.
        /// Neighter macro or page nor the globals known from python macros are 
        /// accessible in this context. Only stuff we initialized in site.py
        /// can be used.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;expression&quot;&gt;Python expression to execute&lt;/param&gt;
        /// &lt;returns&gt;Returns the StandardOutput&lt;/returns&gt;
        public static string PythonExecute(string expression)
        {
            try
            {
                object res = python.execute(expression);
                return res.ToString();
            }
            catch (Exception e)
            {
                return e.Message;
            }
        }

        #endregion

        #region Publish Helper Methods

        
        /// &lt;summary&gt;
        /// Unpublish a node, by removing it from the runtime xml index. Note, prior to this the Document should be 
        /// marked unpublished by setting the publish property on the document object to false
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;DocumentId&quot;&gt;The Id of the Document to be unpublished&lt;/param&gt;
        [Obsolete(&quot;This method is no longer used, a document&#39;s cache will be removed automatically when the document is deleted or unpublished&quot;)]
        public static void UnPublishSingleNode(int DocumentId)
        {
            DistributedCache.Instance.RemovePageCache(DocumentId);
        }

        /// &lt;summary&gt;
        /// Publishes a Document by adding it to the runtime xml index. Note, prior to this the Document should be 
        /// marked published by calling Publish(User u) on the document object.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;documentId&quot;&gt;The Id of the Document to be published&lt;/param&gt;
        [Obsolete(&quot;This method is no longer used, a document&#39;s cache will be updated automatically when the document is published&quot;)]
        public static void UpdateDocumentCache(int documentId)
        {
            DistributedCache.Instance.RefreshPageCache(documentId);
        }

        /// &lt;summary&gt;
        /// Publishes the single node, this method is obsolete
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;DocumentId&quot;&gt;The document id.&lt;/param&gt;
        [Obsolete(&quot;Please use: umbraco.library.UpdateDocumentCache&quot;)]
        public static void PublishSingleNode(int DocumentId)
        {
            UpdateDocumentCache(DocumentId);
        }
        
        /// &lt;summary&gt;
        /// Refreshes the xml cache for all nodes
        /// &lt;/summary&gt;
        public static void RefreshContent()
        {
            DistributedCache.Instance.RefreshAllPageCache();
        }

        /// &lt;summary&gt;
        /// Re-publishes all nodes under a given node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;The ID of the node and childnodes that should be republished&lt;/param&gt;
        [Obsolete(&quot;Please use: umbraco.library.RefreshContent&quot;)]
        public static string RePublishNodes(int nodeID)
        {
            DistributedCache.Instance.RefreshAllPageCache();

            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Re-publishes all nodes under a given node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;The ID of the node and childnodes that should be republished&lt;/param&gt;
        [Obsolete(&quot;Please use: umbraco.library.RefreshContent&quot;)]
        public static void RePublishNodesDotNet(int nodeID)
        {
            DistributedCache.Instance.RefreshAllPageCache();
        }

        /// &lt;summary&gt;
        /// Refreshes the runtime xml index. 
        /// Note: This *doesn&#39;t* mark any non-published document objects as published
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;Always use -1&lt;/param&gt;
        /// &lt;param name=&quot;SaveToDisk&quot;&gt;Not used&lt;/param&gt;
        [Obsolete(&quot;Please use: content.Instance.RefreshContentFromDatabaseAsync&quot;)]
        public static void RePublishNodesDotNet(int nodeID, bool SaveToDisk)
        {
            DistributedCache.Instance.RefreshAllPageCache();
        }

        #endregion

        #region Xslt Helper functions

        /// &lt;summary&gt;
        /// This will convert a json structure to xml for use in xslt
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;json&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator JsonToXml(string json)
        {
            try
            {
                if (json.StartsWith(&quot;[&quot;))
                {
                    //we&#39;ll assume it&#39;s an array, in which case we need to add a root
                    json = &quot;{\&quot;arrayitem\&quot;:&quot; + json + &quot;}&quot;;
                }
                var xml = JsonConvert.DeserializeXmlNode(json, &quot;json&quot;, false);
                return xml.CreateNavigator().Select(&quot;/json&quot;);
            }
            catch (Exception ex)
            {
                var xd = new XmlDocument();
                xd.LoadXml(string.Format(&quot;&lt;error&gt;Could not convert JSON to XML. Error: {0}&lt;/error&gt;&quot;, ex));
                return xd.CreateNavigator().Select(&quot;/error&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Add a session variable to the current user
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The Key of the variable&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The Value&lt;/param&gt;
        public static void setSession(string key, string value)
        {
            if (HttpContext.Current.Session != null)
                HttpContext.Current.Session[key] = value;
        }

        /// &lt;summary&gt;
        /// Add a cookie variable to the current user
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The Key of the variable&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The Value of the variable&lt;/param&gt;
        public static void setCookie(string key, string value)
        {
            StateHelper.SetCookieValue(key, value);
        }

        /// &lt;summary&gt;
        /// Returns a string with a friendly url from a node.
        /// IE.: Instead of having /482 (id) as an url, you can have
        /// /screenshots/developer/macros (spoken url)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;Identifier for the node that should be returned&lt;/param&gt;
        /// &lt;returns&gt;String with a friendly url from a node&lt;/returns&gt;
        public static string NiceUrl(int nodeID)
        {
        	return GetUmbracoHelper().NiceUrl(nodeID);            
        }

        /// &lt;summary&gt;
        /// This method will always add the root node to the path. You should always use NiceUrl, as that is the
        /// only one who checks for toplevel node settings in the web.config
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;Identifier for the node that should be returned&lt;/param&gt;
        /// &lt;returns&gt;String with a friendly url from a node&lt;/returns&gt;
        [Obsolete]
        public static string NiceUrlFullPath(int nodeID)
        {
            throw new NotImplementedException(&quot;It was broken anyway...&quot;);
        }

        /// &lt;summary&gt;
        /// This method will always add the domain to the path if the hostnames are set up correctly. 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;Identifier for the node that should be returned&lt;/param&gt;
        /// &lt;returns&gt;String with a friendly url with full domain from a node&lt;/returns&gt;
        public static string NiceUrlWithDomain(int nodeID)
        {
        	return GetUmbracoHelper().NiceUrlWithDomain(nodeID);
        }

        /// &lt;summary&gt;
        /// This method will always add the domain to the path. 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;Identifier for the node that should be returned&lt;/param&gt;
        /// &lt;param name=&quot;ignoreUmbracoHostNames&quot;&gt;Ignores the umbraco hostnames and returns the url prefixed with the requested host (including scheme and port number)&lt;/param&gt;
        /// &lt;returns&gt;String with a friendly url with full domain from a node&lt;/returns&gt;
        internal static string NiceUrlWithDomain(int nodeID, bool ignoreUmbracoHostNames)
        {
            if (ignoreUmbracoHostNames)
                return HttpContext.Current.Request.Url.GetLeftPart(UriPartial.Authority) + NiceUrl(nodeID);

            return NiceUrlWithDomain(nodeID);
        }

        public static string ResolveVirtualPath(string path)
        {
			return Umbraco.Core.IO.IOHelper.ResolveUrl(path);
        }


        /// &lt;summary&gt;
        /// Returns a string with the data from the given element of a node. Both elements (data-fields)
        /// and properties can be used - ie:
        /// getItem(1, nodeName) will return a string with the name of the node with id=1 even though
        /// nodeName is a property and not an element (data-field).
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeID&quot;&gt;Identifier for the node that should be returned&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;The element that should be returned&lt;/param&gt;
        /// &lt;returns&gt;Returns a string with the data from the given element of a node&lt;/returns&gt;
        public static string GetItem(int nodeID, String alias)
        {
	        var doc = Umbraco.Web.UmbracoContext.Current.ContentCache.GetById(nodeID);

			if (doc == null)
				return string.Empty;

	        switch (alias)
	        {
				case &quot;id&quot;:
			        return doc.Id.ToString();
				case &quot;version&quot;:
			        return doc.Version.ToString();
				case &quot;parentID&quot;:
			        return doc.Parent.Id.ToString();
				case &quot;level&quot;:
			        return doc.Level.ToString();
				case &quot;writerID&quot;:
			        return doc.WriterId.ToString();
				case &quot;template&quot;:
			        return doc.TemplateId.ToString();
				case &quot;sortOrder&quot;:
			        return doc.SortOrder.ToString();
				case &quot;createDate&quot;:
					return doc.CreateDate.ToString(&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss&quot;);
				case &quot;updateDate&quot;:
					return doc.UpdateDate.ToString(&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss&quot;);
				case &quot;nodeName&quot;:
			        return doc.Name;
				case &quot;writerName&quot;:
			        return doc.WriterName;
				case &quot;path&quot;:
			        return doc.Path;
				case &quot;creatorName&quot;:
			        return doc.CreatorName;
	        }

            // in 4.9.0 the method returned the raw XML from the cache, unparsed
            // starting with 5c20f4f (4.10?) the method returns prop.Value.ToString()
            //   where prop.Value is parsed for internal links + resolve urls - but not for macros
            //   comments say &quot;fixing U4-917 and U4-821&quot; which are not related
            // if we return DataValue.ToString() we&#39;re back to the original situation
            // if we return Value.ToString() we&#39;ll have macros parsed and that&#39;s nice
            //
            // so, use Value.ToString() here.
	        var prop = doc.GetProperty(alias);
	        return prop == null ? string.Empty : prop.Value.ToString();
        }

        /// &lt;summary&gt;
        /// Checks with the Assigned domains settings and retuns an array the the Domains matching the node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;NodeId&quot;&gt;Identifier for the node that should be returned&lt;/param&gt;
        /// &lt;returns&gt;A Domain array with all the Domains that matches the nodeId&lt;/returns&gt;
        public static Domain[] GetCurrentDomains(int NodeId)
        {
            string[] pathIds = GetItem(NodeId, &quot;path&quot;).Split(&#39;,&#39;);
            for (int i = pathIds.Length - 1; i &gt; 0; i--)
            {
                Domain[] retVal = Domain.GetDomainsById(int.Parse(pathIds[i]));
                if (retVal.Length &gt; 0)
                {
                    return retVal;
                }
            }
            return null;
        }

        /// &lt;summary&gt;
        /// Returns a string with the data from the given element of the current node. Both elements (data-fields)
        /// and properties can be used - ie:
        /// getItem(nodeName) will return a string with the name of the current node/page even though
        /// nodeName is a property and not an element (data-field).
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetItem(String alias)
        {
            try
            {
                int currentID = int.Parse(HttpContext.Current.Items[&quot;pageID&quot;].ToString());
                return GetItem(currentID, alias);
            }
            catch (Exception ItemException)
            {
                HttpContext.Current.Trace.Warn(&quot;library.GetItem&quot;, &quot;Error reading &#39;&quot; + alias + &quot;&#39;&quot;, ItemException);
                return string.Empty;
            }
        }

        /// &lt;summary&gt;
        /// Returns that name of a generic property
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ContentTypeAlias&quot;&gt;The Alias of the content type (ie. Document Type, Member Type or Media Type)&lt;/param&gt;
        /// &lt;param name=&quot;PropertyTypeAlias&quot;&gt;The Alias of the Generic property (ie. bodyText or umbracoNaviHide)&lt;/param&gt;
        /// &lt;returns&gt;A string with the name. If nothing matches the alias, an empty string is returned&lt;/returns&gt;
        public static string GetPropertyTypeName(string ContentTypeAlias, string PropertyTypeAlias)
        {
            try
            {
                umbraco.cms.businesslogic.ContentType ct = umbraco.cms.businesslogic.ContentType.GetByAlias(ContentTypeAlias);
                PropertyType pt = ct.getPropertyType(PropertyTypeAlias);
                return pt.Name;
            }
            catch
            {
                return string.Empty;
            }
        }

        /// &lt;summary&gt;
        /// Returns the Member Name from an umbraco member object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;MemberId&quot;&gt;The identifier of the Member&lt;/param&gt;
        /// &lt;returns&gt;The Member name matching the MemberId, an empty string is member isn&#39;t found&lt;/returns&gt;
        public static string GetMemberName(int MemberId)
        {
            if (MemberId != 0)
            {
                try
                {
                    Member m = new Member(MemberId);
                    return m.Text;
                }
                catch
                {
                    return string.Empty;
                }
            }
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Get a media object as an xml object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;MediaId&quot;&gt;The identifier of the media object to be returned&lt;/param&gt;
        /// &lt;param name=&quot;Deep&quot;&gt;If true, children of the media object is returned&lt;/param&gt;
        /// &lt;returns&gt;An umbraco xml node of the media (same format as a document node)&lt;/returns&gt;
        public static XPathNodeIterator GetMedia(int MediaId, bool Deep)
        {
            try
            {
                if (UmbracoConfig.For.UmbracoSettings().Content.UmbracoLibraryCacheDuration &gt; 0)
                {
                    var xml = ApplicationContext.Current.ApplicationCache.RuntimeCache.GetCacheItem&lt;XElement&gt;(
                        string.Format(
                            &quot;{0}_{1}_{2}&quot;, CacheKeys.MediaCacheKey, MediaId, Deep),
                        timeout:        TimeSpan.FromSeconds(UmbracoConfig.For.UmbracoSettings().Content.UmbracoLibraryCacheDuration),
                        getCacheItem:   () =&gt; GetMediaDo(MediaId, Deep));

                    if (xml != null)
                    {                   
                        //returning the root element of the Media item fixes the problem
                        return xml.CreateNavigator().Select(&quot;/&quot;);
                    }
                        
                }
                else
                {
                    var xml = GetMediaDo(MediaId, Deep);
                    
                    //returning the root element of the Media item fixes the problem
                    return xml.CreateNavigator().Select(&quot;/&quot;);
                }
            }
            catch(Exception ex)
            {
                LogHelper.Error&lt;library&gt;(&quot;An error occurred looking up media&quot;, ex);
            }

            LogHelper.Debug&lt;library&gt;(&quot;No media result for id {0}&quot;, () =&gt; MediaId);

            var errorXml = new XElement(&quot;error&quot;, string.Format(&quot;No media is maching &#39;{0}&#39;&quot;, MediaId));
            return errorXml.CreateNavigator().Select(&quot;/&quot;);
        }

        private static XElement GetMediaDo(int mediaId, bool deep)
        {
            var media = ApplicationContext.Current.Services.MediaService.GetById(mediaId);
            if (media == null) return null;
            var serializer = new EntityXmlSerializer();
            var serialized = serializer.Serialize(
                ApplicationContext.Current.Services.MediaService, 
                ApplicationContext.Current.Services.DataTypeService,
                ApplicationContext.Current.Services.UserService,                
                media, 
                deep);
            return serialized;
        }

        /// &lt;summary&gt;
        /// Get a member as an xml object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;MemberId&quot;&gt;The identifier of the member object to be returned&lt;/param&gt;
        /// &lt;returns&gt;An umbraco xml node of the member (same format as a document node), but with two additional attributes on the &quot;node&quot; element:
        /// &quot;email&quot; and &quot;loginName&quot;.
        /// &lt;/returns&gt;
        public static XPathNodeIterator GetMember(int MemberId)
        {
            try
            {
                if (UmbracoConfig.For.UmbracoSettings().Content.UmbracoLibraryCacheDuration &gt; 0)
                {
                    var xml = ApplicationContext.Current.ApplicationCache.RuntimeCache.GetCacheItem&lt;XElement&gt;(
                        string.Format(
                            &quot;{0}_{1}&quot;, CacheKeys.MemberLibraryCacheKey, MemberId),
                        timeout:        TimeSpan.FromSeconds(UmbracoConfig.For.UmbracoSettings().Content.UmbracoLibraryCacheDuration),
                        getCacheItem:   () =&gt; GetMemberDo(MemberId));

                    if (xml != null)
                    {
                        return xml.CreateNavigator().Select(&quot;/&quot;);
                    }
                }
                else
                {
                    return GetMemberDo(MemberId).CreateNavigator().Select(&quot;/&quot;);
                }
            }
            catch (Exception ex)
            {
                LogHelper.Error&lt;library&gt;(&quot;An error occurred looking up member&quot;, ex);
            }

            LogHelper.Debug&lt;library&gt;(&quot;No member result for id {0}&quot;, () =&gt; MemberId);

            var xd = new XmlDocument();
            xd.LoadXml(string.Format(&quot;&lt;error&gt;No member is maching &#39;{0}&#39;&lt;/error&gt;&quot;, MemberId));
            return xd.CreateNavigator().Select(&quot;/&quot;);
        }

        private static XElement GetMemberDo(int MemberId)
        {
            var member = ApplicationContext.Current.Services.MemberService.GetById(MemberId);
            if (member == null) return null;
            var serializer = new EntityXmlSerializer();
            var serialized = serializer.Serialize(
                ApplicationContext.Current.Services.DataTypeService, member);
            return serialized;
        }

        /// &lt;summary&gt;
        /// Get the current member as an xml node
        /// &lt;/summary&gt;
        /// &lt;returns&gt;Look in documentation for umbraco.library.GetMember(MemberId) for more information&lt;/returns&gt;
        public static XPathNodeIterator GetCurrentMember()
        {
            Member m = Member.GetCurrentMember();
            if (m != null)
            {
                XmlDocument mXml = new XmlDocument();
                mXml.LoadXml(m.ToXml(mXml, false).OuterXml);
                XPathNavigator xp = mXml.CreateNavigator();
                return xp.Select(&quot;/node()&quot;);
            }

            XmlDocument xd = new XmlDocument();
            xd.LoadXml(
                &quot;&lt;error&gt;No current member exists (best practice is to validate with &#39;isloggedon()&#39; prior to this call)&lt;/error&gt;&quot;);
            return xd.CreateNavigator().Select(&quot;/&quot;);
        }

        /// &lt;summary&gt;
        /// Whether or not the current user is logged in (as a member)
        /// &lt;/summary&gt;
        /// &lt;returns&gt;True is the current user is logged in&lt;/returns&gt;
        public static bool IsLoggedOn()
        {
        	return GetUmbracoHelper().MemberIsLoggedOn();
        }

        public static XPathNodeIterator AllowedGroups(int documentId, string path)
        {
            XmlDocument xd = new XmlDocument();
            xd.LoadXml(&quot;&lt;roles/&gt;&quot;);
            foreach (string role in Access.GetAccessingMembershipRoles(documentId, path))
                xd.DocumentElement.AppendChild(xmlHelper.addTextNode(xd, &quot;role&quot;, role));
            return xd.CreateNavigator().Select(&quot;.&quot;);
        }

        /// &lt;summary&gt;
        /// Check if a document object is protected by the &quot;Protect Pages&quot; functionality in umbraco
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;DocumentId&quot;&gt;The identifier of the document object to check&lt;/param&gt;
        /// &lt;param name=&quot;Path&quot;&gt;The full path of the document object to check&lt;/param&gt;
        /// &lt;returns&gt;True if the document object is protected&lt;/returns&gt;
        public static bool IsProtected(int DocumentId, string Path)
        {
        	return GetUmbracoHelper().IsProtected(DocumentId, Path);
        }

        /// &lt;summary&gt;
        /// Check if the current user has access to a document
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;NodeId&quot;&gt;The identifier of the document object to check&lt;/param&gt;
        /// &lt;param name=&quot;Path&quot;&gt;The full path of the document object to check&lt;/param&gt;
        /// &lt;returns&gt;True if the current user has access or if the current document isn&#39;t protected&lt;/returns&gt;
        public static bool HasAccess(int NodeId, string Path)
        {
        	return GetUmbracoHelper().MemberHasAccess(NodeId, Path);
        }


        /// &lt;summary&gt;
        /// Returns an MD5 hash of the string specified
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The text to create a hash from&lt;/param&gt;
        /// &lt;returns&gt;Md5 has of the string&lt;/returns&gt;
        public static string md5(string text)
        {
			return text.ToMd5();
        }

        /// &lt;summary&gt;
        /// Compare two dates
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;firstDate&quot;&gt;The first date to compare&lt;/param&gt;
        /// &lt;param name=&quot;secondDate&quot;&gt;The second date to compare&lt;/param&gt;
        /// &lt;returns&gt;True if the first date is greater than the second date&lt;/returns&gt;
        public static bool DateGreaterThan(string firstDate, string secondDate)
        {
            if (DateTime.Parse(firstDate) &gt; DateTime.Parse(secondDate))
                return true;
            else
                return false;
        }

        /// &lt;summary&gt;
        /// Compare two dates
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;firstDate&quot;&gt;The first date to compare&lt;/param&gt;
        /// &lt;param name=&quot;secondDate&quot;&gt;The second date to compare&lt;/param&gt;
        /// &lt;returns&gt;True if the first date is greater than or equal the second date&lt;/returns&gt;
        public static bool DateGreaterThanOrEqual(string firstDate, string secondDate)
        {
            if (DateTime.Parse(firstDate) &gt;= DateTime.Parse(secondDate))
                return true;
            else
                return false;
        }

        /// &lt;summary&gt;
        /// Check if a date is greater than today
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;firstDate&quot;&gt;The date to check&lt;/param&gt;
        /// &lt;returns&gt;True if the date is greater that today (ie. at least the day of tomorrow)&lt;/returns&gt;
        public static bool DateGreaterThanToday(string firstDate)
        {
            DateTime first = DateTime.Parse(firstDate);
            first = new DateTime(first.Year, first.Month, first.Day);
            DateTime today = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
            TimeSpan TS = new TimeSpan(first.Ticks - today.Ticks);
            if (TS.Days &gt; 0)
                return true;
            else
                return false;
        }

        /// &lt;summary&gt;
        /// Check if a date is greater than or equal today
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;firstDate&quot;&gt;The date to check&lt;/param&gt;
        /// &lt;returns&gt;True if the date is greater that or equal today (ie. at least today or the day of tomorrow)&lt;/returns&gt;
        public static bool DateGreaterThanOrEqualToday(string firstDate)
        {
            DateTime first = DateTime.Parse(firstDate);
            first = new DateTime(first.Year, first.Month, first.Day);
            DateTime today = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
            TimeSpan TS = new TimeSpan(first.Ticks - today.Ticks);
            if (TS.Days &gt;= 0)
                return true;
            else
                return false;
        }

        /// &lt;summary&gt;
        /// Get the current date
        /// &lt;/summary&gt;
        /// &lt;returns&gt;Current date i xml format (ToString(&quot;s&quot;))&lt;/returns&gt;
        public static string CurrentDate()
        {
            return DateTime.Now.ToString(&quot;s&quot;);
        }

        /// &lt;summary&gt;
        /// Add a value to a date
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The Date to user&lt;/param&gt;
        /// &lt;param name=&quot;AddType&quot;&gt;The type to add: &quot;y&quot;: year, &quot;m&quot;: month, &quot;d&quot;: day, &quot;h&quot;: hour, &quot;min&quot;: minutes, &quot;s&quot;: seconds&lt;/param&gt;
        /// &lt;param name=&quot;add&quot;&gt;An integer value to add&lt;/param&gt;
        /// &lt;returns&gt;A date in xml format (ToString(&quot;s&quot;))&lt;/returns&gt;
        public static string DateAdd(string Date, string AddType, int add)
        {
            return DateAddWithDateTimeObject(DateTime.Parse(Date), AddType, add);
        }

        /// &lt;summary&gt;
        /// Get the day of week from a date matching the current culture settings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date to use&lt;/param&gt;
        /// &lt;returns&gt;A string with the DayOfWeek matching the current contexts culture settings&lt;/returns&gt;
        public static string GetWeekDay(string Date)
        {
            return DateTime.Parse(Date).ToString(&quot;dddd&quot;);
        }

        /// &lt;summary&gt;
        /// Add a value to a date. Similar to the other overload, but uses a datetime object instead of a string
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The Date to user&lt;/param&gt;
        /// &lt;param name=&quot;AddType&quot;&gt;The type to add: &quot;y&quot;: year, &quot;m&quot;: month, &quot;d&quot;: day, &quot;h&quot;: hour, &quot;min&quot;: minutes, &quot;s&quot;: seconds&lt;/param&gt;
        /// &lt;param name=&quot;add&quot;&gt;An integer value to add&lt;/param&gt;
        /// &lt;returns&gt;A date in xml format (ToString(&quot;s&quot;))&lt;/returns&gt;
        public static string DateAddWithDateTimeObject(DateTime Date, string AddType, int add)
        {
            switch (AddType.ToLower())
            {
                case &quot;y&quot;:
                    Date = Date.AddYears(add);
                    break;
                case &quot;m&quot;:
                    Date = Date.AddMonths(add);
                    break;
                case &quot;d&quot;:
                    Date = Date.AddDays(add);
                    break;
                case &quot;h&quot;:
                    Date = Date.AddHours(add);
                    break;
                case &quot;min&quot;:
                    Date = Date.AddMinutes(add);
                    break;
                case &quot;s&quot;:
                    Date = Date.AddSeconds(add);
                    break;
            }

            return Date.ToString(&quot;s&quot;);
        }

        /// &lt;summary&gt;
        /// Return the difference between 2 dates, in either minutes, seconds or years.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;firstDate&quot;&gt;The first date.&lt;/param&gt;
        /// &lt;param name=&quot;secondDate&quot;&gt;The second date.&lt;/param&gt;
        /// &lt;param name=&quot;diffType&quot;&gt;format to return, can only be: s,m or y:  s = seconds, m = minutes, y = years.&lt;/param&gt;
        /// &lt;returns&gt;A timespan as a integer&lt;/returns&gt;
        public static int DateDiff(string firstDate, string secondDate, string diffType)
        {
            TimeSpan TS = DateTime.Parse(firstDate).Subtract(DateTime.Parse(secondDate));

            switch (diffType.ToLower())
            {
                case &quot;m&quot;:
                    return Convert.ToInt32(TS.TotalMinutes);
                case &quot;s&quot;:
                    return Convert.ToInt32(TS.TotalSeconds);
                case &quot;y&quot;:
                    return Convert.ToInt32(TS.TotalDays / 365);
            }
            // return default
            return 0;
        }

        /// &lt;summary&gt;
        /// Formats a string to the specified formate.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;param name=&quot;Format&quot;&gt;The format, compatible with regular .net date formats&lt;/param&gt;
        /// &lt;returns&gt;A date in the new format as a string&lt;/returns&gt;
        public static string FormatDateTime(string Date, string Format)
        {
            DateTime result;
            if (DateTime.TryParse(Date, out result))
                return result.ToString(Format);
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Converts a string to Long Date and returns it as a string
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;param name=&quot;WithTime&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; the date will include time.&lt;/param&gt;
        /// &lt;param name=&quot;TimeSplitter&quot;&gt;The splitter between date and time.&lt;/param&gt;
        /// &lt;returns&gt;A Long Date as a string.&lt;/returns&gt;
        public static string LongDate(string Date, bool WithTime, string TimeSplitter)
        {
            DateTime result;
            if (DateTime.TryParse(Date, out result))
            {
                if (WithTime)
                    return result.ToLongDateString() + TimeSplitter + result.ToLongTimeString();
                return result.ToLongDateString();
            }
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Checks whether the Culture with the specified name exixts in the standard .net cultureInfo.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cultureName&quot;&gt;Name of the culture.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static bool CultureExists(string cultureName)
        {
            CultureInfo[] ci = CultureInfo.GetCultures(CultureTypes.AllCultures);
            CultureInfo c = Array.Find(ci, delegate(CultureInfo culture) { return culture.Name == cultureName; });
            return c != null;
        }

        /// &lt;summary&gt;
        /// Converts a string to datetime in the longdate with day name format.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;param name=&quot;DaySplitter&quot;&gt;String between day name and date&lt;/param&gt;
        /// &lt;param name=&quot;WithTime&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; the datetiem will include time.&lt;/param&gt;
        /// &lt;param name=&quot;TimeSplitter&quot;&gt;String between date and time.&lt;/param&gt;
        /// &lt;param name=&quot;GlobalAlias&quot;&gt;Culture name.&lt;/param&gt;
        /// &lt;returns&gt;A datetime in the longdate formate with day name, as a string&lt;/returns&gt;
        public static string LongDateWithDayName(string Date, string DaySplitter, bool WithTime, string TimeSplitter,
                                                 string GlobalAlias)
        {
            if (!CultureExists(GlobalAlias))
                return string.Empty;

            DateTime result;
            CultureInfo.GetCultureInfo(GlobalAlias);
            DateTimeFormatInfo dtInfo = CultureInfo.GetCultureInfo(GlobalAlias).DateTimeFormat;
            if (DateTime.TryParse(Date, dtInfo, DateTimeStyles.None, out result))
            {
                if (WithTime)
                    return
                        result.ToString(dtInfo.LongDatePattern) + TimeSplitter + result.ToString(dtInfo.LongTimePattern);
                return result.ToString(dtInfo.LongDatePattern);
            }
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Converts a string to a Long Date and returns it as a string
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;returns&gt;A Long Date as a string.&lt;/returns&gt;
        public static string LongDate(string Date)
        {
            DateTime result;
            if (DateTime.TryParse(Date, out result))
                return result.ToLongDateString();
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Converts a string to a Short Date and returns it as a string
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;returns&gt;A Short Date as a string.&lt;/returns&gt;
        public static string ShortDate(string Date)
        {
            DateTime result;
            if (DateTime.TryParse(Date, out result))
                return result.ToShortDateString();
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Converts a string to a Short Date, with a specific culture, and returns it as a string
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;param name=&quot;GlobalAlias&quot;&gt;Culture name&lt;/param&gt;
        /// &lt;returns&gt;A short date with a specific culture, as a string&lt;/returns&gt;
        public static string ShortDateWithGlobal(string Date, string GlobalAlias)
        {
            if (!CultureExists(GlobalAlias))
                return string.Empty;

            DateTime result;
            if (DateTime.TryParse(Date, out result))
            {
                DateTimeFormatInfo dtInfo = CultureInfo.GetCultureInfo(GlobalAlias).DateTimeFormat;
                return result.ToString(dtInfo.ShortDatePattern);
            }
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Converts a string to a Short Date with time, with a specific culture, and returns it as a string
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;param name=&quot;GlobalAlias&quot;&gt;Culture name&lt;/param&gt;
        /// &lt;returns&gt;A short date withi time, with a specific culture, as a string&lt;/returns&gt;
        public static string ShortDateWithTimeAndGlobal(string Date, string GlobalAlias)
        {
            if (!CultureExists(GlobalAlias))
                return string.Empty;

            DateTime result;
            if (DateTime.TryParse(Date, out result))
            {
                DateTimeFormatInfo dtInfo = CultureInfo.GetCultureInfo(GlobalAlias).DateTimeFormat;
                return result.ToString(dtInfo.ShortDatePattern) + &quot; &quot; +
                       result.ToString(dtInfo.ShortTimePattern);
            }
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Converts a datetime string to the ShortTime format.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string ShortTime(string Date)
        {
            DateTime result;
            if (DateTime.TryParse(Date, out result))
                return result.ToShortTimeString();
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Converts a datetime string to the ShortDate format.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Date&quot;&gt;The date.&lt;/param&gt;
        /// &lt;param name=&quot;WithTime&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; the date will include time.&lt;/param&gt;
        /// &lt;param name=&quot;TimeSplitter&quot;&gt;String dividing date and time&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string ShortDate(string Date, bool WithTime, string TimeSplitter)
        {
            DateTime result;
            if (DateTime.TryParse(Date, out result))
            {
                if (WithTime)
                    return result.ToShortDateString() + TimeSplitter + result.ToLongTimeString();
                return result.ToShortDateString();
            }
            return string.Empty;
        }

        /// &lt;summary&gt;
        /// Replaces text line breaks with html line breaks
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The text.&lt;/param&gt;
        /// &lt;returns&gt;The text with text line breaks replaced with html linebreaks (&lt;br/&gt;)&lt;/returns&gt;
        public static string ReplaceLineBreaks(string text)
        {
        	return GetUmbracoHelper().ReplaceLineBreaksForHtml(text);
        }

        /// &lt;summary&gt;
        /// Renders the content of a macro. Uses the normal template umbraco macro markup as input.
        /// This only works properly with xslt macros. 
        /// Python and .ascx based macros will not render properly, as viewstate is not included.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Text&quot;&gt;The macro markup to be rendered.&lt;/param&gt;
        /// &lt;param name=&quot;PageId&quot;&gt;The page id.&lt;/param&gt;
        /// &lt;returns&gt;The rendered macro as a string&lt;/returns&gt;
        public static string RenderMacroContent(string Text, int PageId)
        {
            try
            {
                page p = new page(((IHasXmlNode)GetXmlNodeById(PageId.ToString()).Current).GetNode());
                template t = new template(p.Template);
                Control c = t.parseStringBuilder(new StringBuilder(Text), p);

                StringWriter sw = new StringWriter();
                HtmlTextWriter hw = new HtmlTextWriter(sw);
                c.RenderControl(hw);

                return sw.ToString();
            }
            catch (Exception ee)
            {
                return string.Format(&quot;&lt;!-- Error generating macroContent: &#39;{0}&#39; --&gt;&quot;, ee);
            }
        }

        /// &lt;summary&gt;
        /// Renders a template.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;PageId&quot;&gt;The page id.&lt;/param&gt;
        /// &lt;param name=&quot;TemplateId&quot;&gt;The template id.&lt;/param&gt;
        /// &lt;returns&gt;The rendered template as a string&lt;/returns&gt;
        public static string RenderTemplate(int PageId, int TemplateId)
        {
            if (UmbracoConfig.For.UmbracoSettings().Templates.UseAspNetMasterPages)
            {
                using (var sw = new StringWriter())
                {
                    try
                    {
                        var altTemplate = TemplateId == -1 ? null : (int?)TemplateId;
                        var templateRenderer = new TemplateRenderer(Umbraco.Web.UmbracoContext.Current, PageId, altTemplate);
                        templateRenderer.Render(sw);
                    }
                    catch (Exception ee)
                    {
                        sw.Write(&quot;&lt;!-- Error rendering template with id {0}: &#39;{1}&#39; --&gt;&quot;, PageId, ee);
                    }

                    return sw.ToString();
                }
            }
            else
            {

                var p = new page(((IHasXmlNode)GetXmlNodeById(PageId.ToString()).Current).GetNode());
                p.RenderPage(TemplateId);
                var c = p.PageContentControl;
                
				using (var sw = new StringWriter())
                using(var hw = new HtmlTextWriter(sw))
                {
					c.RenderControl(hw);
					return sw.ToString();    
                }
                
            }
        }

        /// &lt;summary&gt;
        /// Renders the default template for a specific page.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;PageId&quot;&gt;The page id.&lt;/param&gt;
        /// &lt;returns&gt;The rendered template as a string.&lt;/returns&gt;
        public static string RenderTemplate(int PageId)
        {
	        return RenderTemplate(PageId, -1);
        }

        /// &lt;summary&gt;
        /// Registers the client script block.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;script&quot;&gt;The script.&lt;/param&gt;
        /// &lt;param name=&quot;addScriptTags&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [add script tags].&lt;/param&gt;
        public static void RegisterClientScriptBlock(string key, string script, bool addScriptTags)
        {
            Page p = HttpContext.Current.CurrentHandler as Page;

            if (p != null)
                p.ClientScript.RegisterClientScriptBlock(p.GetType(), key, script, addScriptTags);
        }

        /// &lt;summary&gt;
        /// Registers the client script include.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;The URL.&lt;/param&gt;
        public static void RegisterStyleSheetFile(string key, string url)
        {
            Page p = HttpContext.Current.CurrentHandler as Page;

            if (p != null)
            {
                System.Web.UI.HtmlControls.HtmlGenericControl include = new System.Web.UI.HtmlControls.HtmlGenericControl(&quot;link&quot;);
                include.ID = key;
                include.Attributes.Add(&quot;rel&quot;, &quot;stylesheet&quot;);
                include.Attributes.Add(&quot;type&quot;, &quot;text/css&quot;);
                include.Attributes.Add(&quot;href&quot;, url);

                if (p.Header != null)
                {
                    if (p.Header.FindControl(key) == null)
                    {
                        p.Header.Controls.Add(include);
                    }
                }
                else
                {
                    //This is a fallback in case there is no header
                    p.ClientScript.RegisterClientScriptBlock(p.GetType(), key, &quot;&lt;link rel=&#39;stylesheet&#39; href=&#39;&quot; + url + &quot;&#39; /&gt;&quot;);
                }
            }
        }

        /// &lt;summary&gt;
        /// Registers the client script include.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;The URL.&lt;/param&gt;
        public static void RegisterJavaScriptFile(string key, string url)
        {
            Page p = HttpContext.Current.CurrentHandler as Page;

            if (p != null)
            {

                if (ClientDependency.Core.Controls.ClientDependencyLoader.Instance == null)
                {
                    System.Web.UI.HtmlControls.HtmlGenericControl include = new System.Web.UI.HtmlControls.HtmlGenericControl(&quot;script&quot;);
                    include.ID = key;
                    include.Attributes.Add(&quot;type&quot;, &quot;text/javascript&quot;);
                    include.Attributes.Add(&quot;src&quot;, url);

                    if (p.Header != null)
                    {
                        if (p.Header.FindControl(key) == null)
                        {
                            p.Header.Controls.Add(include);
                        }
                    }
                    else
                    {
                        //This is a fallback in case there is no header
                        p.ClientScript.RegisterClientScriptInclude(p.GetType(), key, url);
                    }
                }
                else
                {
                    ClientDependency.Core.Controls.ClientDependencyLoader.Instance.RegisterDependency(url, ClientDependency.Core.ClientDependencyType.Javascript);
                }
            }
        }

        /// &lt;summary&gt;
        /// Adds a reference to the jQuery javascript file from the client/ui folder using &quot;jQuery&quot; as a key
        /// Recommended to use instead of RegisterJavaScriptFile for all nitros/packages that uses jQuery
        /// &lt;/summary&gt;
        public static void AddJquery()
        {
            RegisterJavaScriptFile(&quot;jQuery&quot;, String.Format(&quot;{0}/ui/jquery.js&quot;, IOHelper.ResolveUrl(SystemDirectories.UmbracoClient)));
        }


        /// &lt;summary&gt;
        /// Strips all html from a string.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The text.&lt;/param&gt;
        /// &lt;returns&gt;Returns the string without any html tags.&lt;/returns&gt;
        public static string StripHtml(string text)
        {
            string pattern = @&quot;&lt;(.|\n)*?&gt;&quot;;
            return Regex.Replace(text, pattern, string.Empty);
        }

        /// &lt;summary&gt;
        /// Truncates a string if it&#39;s too long
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Text&quot;&gt;The text to eventually truncate&lt;/param&gt;
        /// &lt;param name=&quot;MaxLength&quot;&gt;The maximum number of characters (length)&lt;/param&gt;
        /// &lt;param name=&quot;AddString&quot;&gt;String to append if text is truncated (ie &quot;...&quot;)&lt;/param&gt;
        /// &lt;returns&gt;A truncated string if text if longer than MaxLength appended with the addString parameters. If text is shorter
        /// then MaxLength then the full - non-truncated - string is returned&lt;/returns&gt;
        public static string TruncateString(string Text, int MaxLength, string AddString)
        {
            if (Text.Length &gt; MaxLength)
                return Text.Substring(0, MaxLength - AddString.Length) + AddString;
            else
                return Text;
        }

        /// &lt;summary&gt;
        /// Split a string into xml elements
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;StringToSplit&quot;&gt;The full text to spil&lt;/param&gt;
        /// &lt;param name=&quot;Separator&quot;&gt;The separator&lt;/param&gt;
        /// &lt;returns&gt;An XPathNodeIterator containing the substrings in the format of &lt;values&gt;&lt;value&gt;&lt;/value&gt;&lt;/values&gt;&lt;/returns&gt;
        public static XPathNodeIterator Split(string StringToSplit, string Separator)
        {
            string[] values = StringToSplit.Split(Convert.ToChar(Separator));
            XmlDocument xd = new XmlDocument();
            xd.LoadXml(&quot;&lt;values/&gt;&quot;);
            foreach (string id in values)
            {
                XmlNode node = xmlHelper.addTextNode(xd, &quot;value&quot;, id);
                xd.DocumentElement.AppendChild(node);
            }
            XPathNavigator xp = xd.CreateNavigator();
            return xp.Select(&quot;/values&quot;);
        }

        /// &lt;summary&gt;
        /// Removes the starting and ending paragraph tags in a string.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The text.&lt;/param&gt;
        /// &lt;returns&gt;Returns the string without starting and endning paragraph tags&lt;/returns&gt;
        public static string RemoveFirstParagraphTag(string text)
        {
            if (String.IsNullOrEmpty(text))
                return &quot;&quot;;

            if (text.Length &gt; 5)
            {
                if (text.ToUpper().Substring(0, 3) == &quot;&lt;P&gt;&quot;)
                    text = text.Substring(3, text.Length - 3);
                if (text.ToUpper().Substring(text.Length - 4, 4) == &quot;&lt;/P&gt;&quot;)
                    text = text.Substring(0, text.Length - 4);
            }
            return text;
        }

        /// &lt;summary&gt;
        /// Replaces a specified value with a new one.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The text.&lt;/param&gt;
        /// &lt;param name=&quot;oldValue&quot;&gt;The old value.&lt;/param&gt;
        /// &lt;param name=&quot;newValue&quot;&gt;The new value.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string Replace(string text, string oldValue, string newValue)
        {
            return text.Replace(oldValue, newValue);
        }

        /// &lt;summary&gt;
        /// Returns the Last index of the specified value
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Text&quot;&gt;The text.&lt;/param&gt;
        /// &lt;param name=&quot;Value&quot;&gt;The value.&lt;/param&gt;
        /// &lt;returns&gt;Return the last index of a value as a integer &lt;/returns&gt;
        public static int LastIndexOf(string Text, string Value)
        {
            return Text.LastIndexOf(Value);
        }

        /// &lt;summary&gt;
        /// Gets the prevalues from a umbraco DataType with the specified data type id.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;DataTypeId&quot;&gt;The data type id.&lt;/param&gt;
        /// &lt;returns&gt;Returns the prevalues as a XPathNodeIterator in the format:
        ///     &lt;preValues&gt;
        ///         &lt;prevalue id=&quot;[id]&quot;&gt;[value]&lt;/prevalue&gt;
        ///     &lt;/preValues&gt; 
        ///&lt;/returns&gt;
        public static XPathNodeIterator GetPreValues(int DataTypeId)
        {
            XmlDocument xd = new XmlDocument();
            xd.LoadXml(&quot;&lt;preValues/&gt;&quot;);

            using (var sqlHelper = Application.SqlHelper)
            using (IRecordsReader dr = sqlHelper.ExecuteReader(&quot;Select id, [value] from cmsDataTypeprevalues where DataTypeNodeId = @dataTypeId order by sortorder&quot;,
                sqlHelper.CreateParameter(&quot;@dataTypeId&quot;, DataTypeId)))
            {
                while (dr.Read())
                {
                    XmlNode n = xmlHelper.addTextNode(xd, &quot;preValue&quot;, dr.GetString(&quot;value&quot;));
                    n.Attributes.Append(xmlHelper.addAttribute(xd, &quot;id&quot;, dr.GetInt(&quot;id&quot;).ToString()));
                    xd.DocumentElement.AppendChild(n);
                }
            }
            XPathNavigator xp = xd.CreateNavigator();
            return xp.Select(&quot;/preValues&quot;);
        }

        /// &lt;summary&gt;
        /// Gets the umbraco data type prevalue with the specified Id as string.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Id&quot;&gt;The id.&lt;/param&gt;
        /// &lt;returns&gt;Returns the prevalue as a string&lt;/returns&gt;
        public static string GetPreValueAsString(int Id)
        {
            try
            {
                using (var sqlHelper = Application.SqlHelper)
                    return sqlHelper.ExecuteScalar&lt;string&gt;(&quot;select [value] from cmsDataTypePreValues where id = @id&quot;,
                        sqlHelper.CreateParameter(&quot;@id&quot;, Id));
            }
            catch
            {
                return string.Empty;
            }
        }

        /// &lt;summary&gt;
        /// Gets the dictionary item with the specified key and it&#39;s child dictionary items.
        /// The language version is based on the culture of the current Url.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;A XpathNodeIterator in the format:
        /// &lt;DictionaryItems&gt;
        ///     &lt;DictionaryItem key=&quot;[dictionaryItemKey]&quot;&gt;[dictionaryItemValue]&lt;/DictionaryItem&gt;
        /// &lt;/DictionaryItems&gt;
        /// &lt;/returns&gt;
        public static XPathNodeIterator GetDictionaryItems(string Key)
        {
            XmlDocument xd = new XmlDocument();
            xd.LoadXml(&quot;&lt;DictionaryItems/&gt;&quot;);

            try
            {
                //int languageId = GetCurrentLanguageId();
                int languageId = Language.GetByCultureCode(System.Threading.Thread.CurrentThread.CurrentUICulture.Name).id;

                Dictionary.DictionaryItem di = new Dictionary.DictionaryItem(Key);

                foreach (Dictionary.DictionaryItem item in di.Children)
                {
                    XmlNode xe;
                    try
                    {
                        if (languageId != 0)
                            xe = xmlHelper.addTextNode(xd, &quot;DictionaryItem&quot;, item.Value(languageId));
                        else
                            xe = xmlHelper.addTextNode(xd, &quot;DictionaryItem&quot;, item.Value());
                    }
                    catch
                    {
                        xe = xmlHelper.addTextNode(xd, &quot;DictionaryItem&quot;, string.Empty);
                    }
                    xe.Attributes.Append(xmlHelper.addAttribute(xd, &quot;key&quot;, item.key));
                    xd.DocumentElement.AppendChild(xe);
                }
            }
            catch (Exception ee)
            {
                xd.DocumentElement.AppendChild(
                    xmlHelper.addTextNode(xd, &quot;Error&quot;, ee.ToString()));
            }

            XPathNavigator xp = xd.CreateNavigator();
            return xp.Select(&quot;/&quot;);
        }

        /// &lt;summary&gt;
        /// Gets the dictionary item with the specified key.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;A dictionary items value as a string.&lt;/returns&gt;
        public static string GetDictionaryItem(string Key)
        {
	        return GetUmbracoHelper().GetDictionaryValue(Key);			
        }

        /// &lt;summary&gt;
        /// Gets the current page.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;An XpathNodeIterator containing the current page as Xml.&lt;/returns&gt;
        public static XPathNodeIterator GetXmlNodeCurrent()
        {
            try
            {
                var nav = Umbraco.Web.UmbracoContext.Current.ContentCache.GetXPathNavigator();
                nav.MoveToId(HttpContext.Current.Items[&quot;pageID&quot;].ToString());
                return nav.Select(&quot;.&quot;);
            }
            catch (Exception ex)
            {
                LogHelper.Error&lt;library&gt;(&quot;Could not retrieve current xml node&quot;, ex);
            }

            XmlDocument xd = new XmlDocument();
            xd.LoadXml(&quot;&lt;error&gt;No current node exists&lt;/error&gt;&quot;);
            return xd.CreateNavigator().Select(&quot;/&quot;);
        }

        /// &lt;summary&gt;
        /// Gets the page with the specified id.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The id.&lt;/param&gt;
        /// &lt;returns&gt;Returns the node with the specified id as xml in the form of a XPathNodeIterator&lt;/returns&gt;
        public static XPathNodeIterator GetXmlNodeById(string id)
        {
            // 4.7.1 UmbracoContext is null if we&#39;re running in publishing thread which we need to support
            XmlDocument xmlDoc = GetThreadsafeXmlDocument();

            if (xmlDoc.GetElementById(id) != null)
            {
                XPathNavigator xp = xmlDoc.CreateNavigator();
                xp.MoveToId(id);
                return xp.Select(&quot;.&quot;);
            }
            else
            {
                XmlDocument xd = new XmlDocument();
                xd.LoadXml(string.Format(&quot;&lt;error&gt;No published item exist with id {0}&lt;/error&gt;&quot;, id));
                return xd.CreateNavigator().Select(&quot;.&quot;);
            }
        }

        //TODO: WTF, why is this here? This won&#39;t matter if there&#39;s an UmbracoContext or not, it will call the same underlying method!
        // only difference is that the UmbracoContext way will check if its in preview mode.
        private static XmlDocument GetThreadsafeXmlDocument()
        {
            return UmbracoContext.Current != null
                       ? UmbracoContext.Current.GetXml()
                       : content.Instance.XmlContent;
        }

        /// &lt;summary&gt;
        /// Queries the umbraco Xml cache with the specified Xpath query
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xpathQuery&quot;&gt;The XPath query&lt;/param&gt;
        /// &lt;returns&gt;Returns nodes matching the xpath query as a XpathNodeIterator&lt;/returns&gt;
        public static XPathNodeIterator GetXmlNodeByXPath(string xpathQuery)
        {
            XPathNavigator xp = GetThreadsafeXmlDocument().CreateNavigator();

            return xp.Select(xpathQuery);
        }

        /// &lt;summary&gt;
        /// Gets the entire umbraco xml cache.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;Returns the entire umbraco Xml cache as a XPathNodeIterator&lt;/returns&gt;
        public static XPathNodeIterator GetXmlAll()
        {
            XPathNavigator xp = GetThreadsafeXmlDocument().CreateNavigator();
            return xp.Select(&quot;/root&quot;);
        }

        /// &lt;summary&gt;
        /// Fetches a xml file from the specified path on the server.
        /// The path can be relative (&quot;/path/to/file.xml&quot;) or absolute (&quot;c:\folder\file.xml&quot;)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Path&quot;&gt;The path.&lt;/param&gt;
        /// &lt;param name=&quot;Relative&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; the path is relative.&lt;/param&gt;
        /// &lt;returns&gt;The xml file as a XpathNodeIterator&lt;/returns&gt;
        public static XPathNodeIterator GetXmlDocument(string Path, bool Relative)
        {
            XmlDocument xmlDoc = new XmlDocument();
            try
            {
                if (Relative)
                    xmlDoc.Load(IOHelper.MapPath(Path));
                else
                    xmlDoc.Load(Path);
            }
            catch (Exception err)
            {
                xmlDoc.LoadXml(string.Format(&quot;&lt;error path=\&quot;{0}\&quot; relative=\&quot;{1}\&quot;&gt;{2}&lt;/error&gt;&quot;,
                                             HttpContext.Current.Server.HtmlEncode(Path), Relative, err));
            }
            XPathNavigator xp = xmlDoc.CreateNavigator();
            return xp.Select(&quot;/&quot;);
        }

        /// &lt;summary&gt;
        /// Fetches a xml file from the specified url.
        /// the Url can be a local url or even from a remote server.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Url&quot;&gt;The URL.&lt;/param&gt;
        /// &lt;returns&gt;The xml file as a XpathNodeIterator&lt;/returns&gt;
        public static XPathNodeIterator GetXmlDocumentByUrl(string Url)
        {
            XmlDocument xmlDoc = new XmlDocument();
            WebRequest request = WebRequest.Create(Url);
            try
            {
                WebResponse response = request.GetResponse();
                Stream responseStream = response.GetResponseStream();
                XmlTextReader reader = new XmlTextReader(responseStream);

                xmlDoc.Load(reader);

                response.Close();
                responseStream.Close();
            }
            catch (Exception err)
            {
                xmlDoc.LoadXml(string.Format(&quot;&lt;error url=\&quot;{0}\&quot;&gt;{1}&lt;/error&gt;&quot;,
                                             HttpContext.Current.Server.HtmlEncode(Url), err));
            }
            XPathNavigator xp = xmlDoc.CreateNavigator();
            return xp.Select(&quot;/&quot;);
        }

        /// &lt;summary&gt;
        /// Gets the XML document by URL Cached.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Url&quot;&gt;The URL.&lt;/param&gt;
        /// &lt;param name=&quot;CacheInSeconds&quot;&gt;The cache in seconds (so 900 would be 15 minutes). This is independent of the global cache refreshing, as it doesn&#39;t gets flushed on publishing (like the macros do)&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static XPathNodeIterator GetXmlDocumentByUrl(string Url, int CacheInSeconds)
        {

            object urlCache =
                            HttpContext.Current.Cache.Get(&quot;GetXmlDoc_&quot; + Url);
            if (urlCache != null)
                return (XPathNodeIterator)urlCache;
            else
            {
                XPathNodeIterator result =
                    GetXmlDocumentByUrl(Url);

                HttpContext.Current.Cache.Insert(&quot;GetXmlDoc_&quot; + Url,
                    result, null, DateTime.Now.Add(new TimeSpan(0, 0, CacheInSeconds)), TimeSpan.Zero, System.Web.Caching.CacheItemPriority.Low, null);
                return result;
            }

        }

        /// &lt;summary&gt;
        /// Returns the Xpath query for a node with the specified id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The id.&lt;/param&gt;
        /// &lt;returns&gt;The Xpath query for the node with the specified id as a string&lt;/returns&gt;
        public static string QueryForNode(string id)
        {
            string XPathQuery = string.Empty;
            if (UmbracoContext.Current.GetXml().GetElementById(id) != null)
            {
                string[] path =
                    UmbracoContext.Current.GetXml().GetElementById(id).Attributes[&quot;path&quot;].Value.Split((&quot;,&quot;).ToCharArray());
                for (int i = 1; i &lt; path.Length; i++)
                {
                    if (i &gt; 1)
                        XPathQuery += &quot;/node [@id = &quot; + path[i] + &quot;]&quot;;
                    else
                        XPathQuery += &quot; [@id = &quot; + path[i] + &quot;]&quot;;
                }
            }

            return XPathQuery;
        }

        /// &lt;summary&gt;
        /// Helper function to get a value from a comma separated string. Usefull to get
        /// a node identifier from a Page&#39;s path string
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;path&quot;&gt;The comma separated string&lt;/param&gt;
        /// &lt;param name=&quot;level&quot;&gt;The index to be returned&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the index&lt;/returns&gt;
        public static string GetNodeFromLevel(string path, int level)
        {
            try
            {
                string[] newPath = path.Split(&#39;,&#39;);
                if (newPath.Length &gt;= level)
                    return newPath[level].ToString();
                else
                    return string.Empty;
            }
            catch
            {
                return &quot;&lt;!-- error in GetNodeFromLevel --&gt;&quot;;
            }
        }

        /// &lt;summary&gt;
        /// Sends an e-mail using the System.Net.Mail.MailMessage object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;fromMail&quot;&gt;The sender of the e-mail&lt;/param&gt;
        /// &lt;param name=&quot;toMail&quot;&gt;The recipient(s) of the e-mail, add multiple email addresses by using a semicolon between them&lt;/param&gt;
        /// &lt;param name=&quot;subject&quot;&gt;E-mail subject&lt;/param&gt;
        /// &lt;param name=&quot;body&quot;&gt;The complete content of the e-mail&lt;/param&gt;
        /// &lt;param name=&quot;isHtml&quot;&gt;Set to true when using Html formatted mails&lt;/param&gt;
        public static void SendMail(string fromMail, string toMail, string subject, string body, bool isHtml)
        {
            try
            {
                using (var mail = new MailMessage())
                {
                    mail.From = new MailAddress(fromMail.Trim());
                    foreach (var mailAddress in toMail.Split(&#39;;&#39;))
                        mail.To.Add(new MailAddress(mailAddress.Trim()));
                    mail.Subject = subject;
                    mail.IsBodyHtml = isHtml;
                    mail.Body = body;
                    using (var smtpClient = new SmtpClient())
                        smtpClient.Send(mail);
                }
            }
            catch (Exception ee)
            {
                LogHelper.Error&lt;library&gt;(&quot;umbraco.library.SendMail: Error sending mail.&quot;, ee);
            }
        }

        /// &lt;summary&gt; 
        /// These random methods are from Eli Robillards blog - kudos for the work :-)
        /// http://weblogs.asp.net/erobillard/archive/2004/05/06/127374.aspx
        /// 
        /// Get a Random object which is cached between requests. 
        /// The advantage over creating the object locally is that the .Next 
        /// call will always return a new value. If creating several times locally 
        /// with a generated seed (like millisecond ticks), the same number can be 
        /// returned. 
        /// &lt;/summary&gt; 
        /// &lt;returns&gt;A Random object which is cached between calls.&lt;/returns&gt; 
        public static Random GetRandom(int seed)
        {
            Random r = (Random)HttpContext.Current.Cache.Get(&quot;RandomNumber&quot;);
            if (r == null)
            {
                if (seed == 0)
                    r = new Random();
                else
                    r = new Random(seed);
                HttpContext.Current.Cache.Insert(&quot;RandomNumber&quot;, r);
            }
            return r;
        }

        /// &lt;summary&gt; 
        /// GetRandom with no parameters. 
        /// &lt;/summary&gt; 
        /// &lt;returns&gt;A Random object which is cached between calls.&lt;/returns&gt; 
        public static Random GetRandom()
        {
            return GetRandom(0);
        }

        /// &lt;summary&gt;
        /// Get any value from the current Request collection. Please note that there also specialized methods for
        /// Querystring, Form, Servervariables and Cookie collections
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Name of the Request element to be returned&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the Requested element&lt;/returns&gt;
        public static string Request(string key)
        {
            if (HttpContext.Current.Request[key] != null)
                return HttpContext.Current.Request[key];
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Changes the mime type of the current page.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;MimeType&quot;&gt;The mime type (like text/xml)&lt;/param&gt;
        public static void ChangeContentType(string MimeType)
        {
            if (!String.IsNullOrEmpty(MimeType))
            {
                HttpContext.Current.Response.ContentType = MimeType;
            }
        }

        /// &lt;summary&gt;
        /// Get any value from the current Items collection.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Name of the Items element to be returned&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the Items element&lt;/returns&gt;
        public static string ContextKey(string key)
        {
            if (HttpContext.Current.Items[key] != null)
                return HttpContext.Current.Items[key].ToString();
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Get any value from the current Http Items collection
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Name of the Item element to be returned&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the Requested element&lt;/returns&gt;
        public static string GetHttpItem(string key)
        {
            if (HttpContext.Current.Items[key] != null)
                return HttpContext.Current.Items[key].ToString();
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Get any value from the current Form collection
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Name of the Form element to be returned&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the form element&lt;/returns&gt;
        public static string RequestForm(string key)
        {
            if (HttpContext.Current.Request.Form[key] != null)
                return HttpContext.Current.Request.Form[key];
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Get any value from the current Querystring collection
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Name of the querystring element to be returned&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the querystring element&lt;/returns&gt;
        public static string RequestQueryString(string key)
        {
            if (HttpContext.Current.Request.QueryString[key] != null)
                return HttpContext.Current.Request.QueryString[key];
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Get any value from the users cookie collection
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Name of the cookie to return&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the cookie&lt;/returns&gt;
        public static string RequestCookies(string key)
        {
            // zb-00004 #29956 : refactor cookies handling
            var value = StateHelper.GetCookieValue(key);
            return value ?? &quot;&quot;;
        }

        /// &lt;summary&gt;
        /// Get any element from the server variables collection
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key for the element to be returned&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the requested element&lt;/returns&gt;
        public static string RequestServerVariables(string key)
        {
            if (HttpContext.Current.Request.ServerVariables[key] != null)
                return HttpContext.Current.Request.ServerVariables[key];
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Get any element from current user session
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key for the element to be returned&lt;/param&gt;
        /// &lt;returns&gt;A string with the value of the requested element&lt;/returns&gt;
        public static string Session(string key)
        {
            if (HttpContext.Current.Session != null &amp;&amp; HttpContext.Current.Session[key] != null)
                return HttpContext.Current.Session[key].ToString();
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Returns the current ASP.NET session identifier
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The current ASP.NET session identifier&lt;/returns&gt;
        public static string SessionId()
        {
            if (HttpContext.Current.Session != null)
                return HttpContext.Current.Session.SessionID;
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// URL-encodes a string 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Text&quot;&gt;The string to be encoded&lt;/param&gt;
        /// &lt;returns&gt;A URL-encoded string&lt;/returns&gt;
        public static string UrlEncode(string Text)
        {
            return HttpUtility.UrlEncode(Text);
        }

        /// &lt;summary&gt;
        /// HTML-encodes a string 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Text&quot;&gt;The string to be encoded&lt;/param&gt;
        /// &lt;returns&gt;A HTML-encoded string&lt;/returns&gt;
        public static string HtmlEncode(string Text)
        {
            return HttpUtility.HtmlEncode(Text);
        }

        public static Relation[] GetRelatedNodes(int NodeId)
        {
            return new CMSNode(NodeId).Relations;
        }

        [Obsolete(&quot;Use DistributedCache.Instance.RemoveMediaCache instead&quot;)]
        public static void ClearLibraryCacheForMedia(int mediaId)
        {
            DistributedCache.Instance.RemoveMediaCache(mediaId);      
        }

        [Obsolete(&quot;Use DistributedCache.Instance.RemoveMediaCache instead&quot;)]
        public static void ClearLibraryCacheForMediaDo(int mediaId)
        {
            DistributedCache.Instance.RemoveMediaCache(mediaId);
        }

        [Obsolete(&quot;Use DistributedCache.Instance.RefreshMemberCache instead&quot;)]
        public static void ClearLibraryCacheForMember(int mediaId)
        {
            DistributedCache.Instance.RefreshMemberCache(mediaId);
        }

        [Obsolete(&quot;Use DistributedCache.Instance.RefreshMemberCache instead&quot;)]
        public static void ClearLibraryCacheForMemberDo(int memberId)
        {
            DistributedCache.Instance.RefreshMemberCache(memberId);
        }

        /// &lt;summary&gt;
        /// Gets the related nodes, of the node with the specified Id, as XML.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;NodeId&quot;&gt;The node id.&lt;/param&gt;
        /// &lt;returns&gt;The related nodes as a XpathNodeIterator in the format:
        ///     &lt;code&gt;
        ///         &lt;relations&gt;
        ///             &lt;relation typeId=&quot;[typeId]&quot; typeName=&quot;[typeName]&quot; createDate=&quot;[createDate]&quot; parentId=&quot;[parentId]&quot; childId=&quot;[childId]&quot;&gt;&lt;node&gt;[standard umbraco node Xml]&lt;/node&gt;&lt;/relation&gt;
        ///         &lt;/relations&gt;
        ///     &lt;/code&gt;
        /// &lt;/returns&gt;
        public static XPathNodeIterator GetRelatedNodesAsXml(int NodeId)
        {
            XmlDocument xd = new XmlDocument();
            xd.LoadXml(&quot;&lt;relations/&gt;&quot;);
            var rels = new CMSNode(NodeId).Relations;
            foreach (Relation r in rels)
            {
                XmlElement n = xd.CreateElement(&quot;relation&quot;);
                n.AppendChild(xmlHelper.addCDataNode(xd, &quot;comment&quot;, r.Comment));
                n.Attributes.Append(xmlHelper.addAttribute(xd, &quot;typeId&quot;, r.RelType.Id.ToString()));
                n.Attributes.Append(xmlHelper.addAttribute(xd, &quot;typeName&quot;, r.RelType.Name));
                n.Attributes.Append(xmlHelper.addAttribute(xd, &quot;createDate&quot;, r.CreateDate.ToString()));
                n.Attributes.Append(xmlHelper.addAttribute(xd, &quot;parentId&quot;, r.Parent.Id.ToString()));
                n.Attributes.Append(xmlHelper.addAttribute(xd, &quot;childId&quot;, r.Child.Id.ToString()));

                // Append the node that isn&#39;t the one we&#39;re getting the related nodes from
                if (NodeId == r.Child.Id)
                    n.AppendChild(r.Parent.ToXml(xd, false));
                else
                    n.AppendChild(r.Child.ToXml(xd, false));
                xd.DocumentElement.AppendChild(n);
            }
            XPathNavigator xp = xd.CreateNavigator();
            return xp.Select(&quot;.&quot;);
        }

        /// &lt;summary&gt;
        /// Returns the identifier of the current page
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The identifier of the current page&lt;/returns&gt;
        public int PageId()
        {
            if (_page != null)
                return _page.PageID;
            else
                return -1;
        }

        /// &lt;summary&gt;
        /// Returns the title of the current page
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The title of the current page&lt;/returns&gt;
        public string PageName()
        {
            if (_page != null)
                return _page.PageName;
            else
                return string.Empty;
        }

        /// &lt;summary&gt;
        /// Returns any element from the currentpage including generic properties
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The name of the page element to return&lt;/param&gt;
        /// &lt;returns&gt;A string with the element value&lt;/returns&gt;
        public string PageElement(string key)
        {
            if (_page != null)
            {
                if (_page.Elements[key] != null)
                    return _page.Elements[key].ToString();
                else
                    return string.Empty;
            }
            else
                return string.Empty;
        }



        /// &lt;summary&gt;
        /// Cleans the spified string with tidy
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;StringToTidy&quot;&gt;The string to tidy.&lt;/param&gt;
        /// &lt;param name=&quot;LiveEditing&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [Live Editing].&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string Tidy(string StringToTidy, bool LiveEditing)
        {
            return cms.helpers.xhtml.TidyHtml(StringToTidy);
        }

        

        #endregion

        #region Template Control Mapping Functions

        /// &lt;summary&gt;
        /// Creates an Umbraco item for the specified field of the specified node.
        /// This brings the &lt;c&gt;umbraco:Item&lt;/c&gt; element functionality to XSLT documents,
        /// which enables Live Editing of XSLT generated content.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeId&quot;&gt;The ID of the node to create.&lt;/param&gt;
        /// &lt;param name=&quot;fieldName&quot;&gt;Name of the field to create.&lt;/param&gt;
        /// &lt;returns&gt;An Umbraco item.&lt;/returns&gt;
        public string Item(int nodeId, string fieldName)
        {
            return Item(nodeId, fieldName, null);
        }

        /// &lt;summary&gt;
        /// Creates an Umbraco item for the specified field of the specified node.
        /// This brings the &lt;c&gt;umbraco:Item&lt;/c&gt; element functionality to XSLT documents,
        /// which enables Live Editing of XSLT generated content.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeId&quot;&gt;The ID of the node to create.&lt;/param&gt;
        /// &lt;param name=&quot;fieldName&quot;&gt;Name of the field to create.&lt;/param&gt;
        /// &lt;param name=&quot;displayValue&quot;&gt;
        ///     Value that is displayed to the user, which can be different from the field value.
        ///     Ignored if &lt;c&gt;null&lt;/c&gt;.
        ///     Inside an XSLT document, an XPath expression might be useful to generate this value,
        ///     analogous to the functionality of the &lt;c&gt;Xslt&lt;/c&gt; property of an &lt;c&gt;umbraco:Item&lt;/c&gt; element.
        /// &lt;/param&gt;
        /// &lt;returns&gt;An Umbraco item.&lt;/returns&gt;
        public string Item(int nodeId, string fieldName, string displayValue)
        {
            // require a field name
            if (String.IsNullOrEmpty(fieldName))
                throw new ArgumentNullException(&quot;fieldName&quot;);

            // encode the display value, if present, as an inline XSLT expression
            // escaping is disabled, since the user can choose to set
            // disable-output-escaping=&quot;yes&quot; on the value-of element calling this function.
            string xslt = displayValue == null
                          ? String.Empty
                          : string.Format(&quot;xslt=\&quot;&#39;{0}&#39;\&quot; xsltdisableescaping=\&quot;true\&quot;&quot;,
                                          HttpUtility.HtmlEncode(displayValue).Replace(&quot;&#39;&quot;, &quot;&amp;amp;apos;&quot;));

            // return a placeholder, the actual item will be created later on
            // in the CreateControlsFromText method of macro
            return string.Format(&quot;[[[[umbraco:Item nodeId=\&quot;{0}\&quot; field=\&quot;{1}\&quot; {2}]]]]&quot;, nodeId, fieldName, xslt);
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[55,3,55,4,0],[56,4,56,65,0],[57,3,57,4,0],[64,9,64,49,1],[68,9,68,46,1],[74,9,74,72,1],[86,17,86,18,0],[86,19,86,48,0],[86,49,86,50,0],[96,9,96,25,0],[97,9,97,10,0],[98,9,98,10,0],[100,9,100,31,0],[101,9,101,10,0],[102,13,102,105,0],[103,9,103,10,0],[109,9,109,34,0],[110,9,110,10,0],[111,13,111,26,0],[112,9,112,10,0],[128,9,128,10,0],[130,13,130,14,0],[131,17,131,93,0],[132,17,132,55,0],[133,17,133,39,0],[135,13,135,32,0],[136,13,136,14,0],[137,17,137,34,0],[139,9,139,10,0],[151,9,151,10,0],[153,13,153,14,0],[154,17,154,57,0],[155,17,155,39,0],[157,13,157,32,0],[158,13,158,14,0],[159,17,159,34,0],[161,9,161,10,0],[175,9,175,10,0],[176,13,176,67,0],[177,9,177,10,0],[186,9,186,10,0],[187,13,187,68,0],[188,9,188,10,0],[196,9,196,10,0],[197,13,197,45,0],[198,9,198,10,0],[204,9,204,10,0],[205,13,205,61,0],[206,9,206,10,0],[214,9,214,10,0],[215,13,215,61,0],[217,13,217,33,0],[218,9,218,10,0],[226,9,226,10,0],[227,13,227,61,0],[228,9,228,10,0],[238,9,238,10,0],[239,13,239,61,0],[240,9,240,10,0],[252,9,252,10,1],[254,13,254,14,1],[255,17,255,42,1],[256,17,256,18,1],[258,21,258,59,1],[259,17,259,18,1],[260,17,260,79,1],[261,17,261,62,1],[263,13,263,33,1],[264,13,264,14,1],[265,17,265,44,1],[266,17,266,107,1],[267,17,267,62,1],[269,9,269,10,1],[277,9,277,10,0],[278,13,278,53,0],[279,17,279,58,0],[280,9,280,10,0],[288,9,288,10,0],[289,13,289,52,0],[290,9,290,10,0],[300,9,300,10,0],[301,10,301,52,0],[302,9,302,10,0],[312,9,312,10,0],[313,13,313,74,0],[322,9,322,10,0],[323,10,323,62,0],[324,9,324,10,0],[333,9,333,10,0],[334,13,334,40,0],[335,17,335,108,0],[337,13,337,46,0],[338,9,338,10,0],[341,9,341,10,0],[342,4,342,53,0],[343,9,343,10,0],[356,9,356,10,1],[357,10,357,84,1],[359,4,359,20,1],[360,5,360,25,0],[362,10,362,24,1],[365,12,365,37,1],[367,12,367,42,0],[369,12,369,44,1],[371,12,371,40,1],[373,12,373,43,1],[375,12,375,45,1],[377,12,377,44,1],[379,6,379,62,1],[381,6,381,62,1],[383,12,383,28,1],[385,12,385,34,1],[387,12,387,28,1],[389,12,389,35,0],[400,10,400,44,1],[401,10,401,69,1],[402,9,402,10,1],[410,9,410,10,0],[411,13,411,67,0],[412,18,412,44,0],[412,46,412,51,0],[412,53,412,56,0],[413,13,413,14,0],[414,17,414,80,0],[415,17,415,39,0],[416,17,416,18,0],[417,21,417,35,0],[419,13,419,14,0],[420,13,420,25,0],[421,9,421,10,0],[432,9,432,10,0],[434,13,434,14,0],[435,17,435,91,0],[436,17,436,50,0],[438,13,438,44,0],[439,13,439,14,0],[440,17,440,115,0],[441,17,441,37,0],[443,9,443,10,0],[452,9,452,10,0],[454,13,454,14,0],[455,17,455,127,0],[456,17,456,73,0],[457,17,457,32,0],[459,13,459,18,0],[460,13,460,14,0],[461,17,461,37,0],[463,9,463,10,0],[471,9,471,10,0],[472,13,472,31,0],[473,13,473,14,0],[475,17,475,18,0],[476,21,476,53,0],[477,21,477,35,0],[479,17,479,22,0],[480,17,480,18,0],[481,21,481,41,0],[485,17,485,37,0],[486,9,486,10,0],[495,9,495,10,1],[497,13,497,14,1],[498,17,498,97,1],[499,17,499,18,1],[500,21,504,47,1],[504,47,504,72,1],[504,72,504,74,1],[500,21,504,74,1],[506,21,506,37,1],[507,21,507,22,1],[509,25,509,66,1],[512,17,512,18,0],[514,17,514,18,0],[515,21,515,57,0],[518,21,518,62,0],[520,13,520,14,0],[521,13,521,32,0],[522,13,522,14,0],[523,17,523,84,0],[524,13,524,14,0],[526,13,526,74,0],[526,74,526,81,0],[526,81,526,83,0],[526,13,526,83,0],[528,13,528,103,0],[529,13,529,59,0],[530,9,530,10,1],[533,9,533,10,1],[534,13,534,91,1],[535,13,535,31,1],[535,32,535,44,0],[536,13,536,56,1],[537,13,542,23,1],[543,13,543,31,1],[544,9,544,10,1],[554,9,554,10,0],[556,13,556,14,0],[557,17,557,97,0],[558,17,558,18,0],[559,21,563,47,0],[563,47,563,68,0],[563,68,563,70,0],[559,21,563,70,0],[565,21,565,37,0],[566,21,566,22,0],[567,25,567,66,0],[569,17,569,18,0],[571,17,571,18,0],[572,21,572,80,0],[574,13,574,14,0],[575,13,575,33,0],[576,13,576,14,0],[577,17,577,85,0],[578,13,578,14,0],[580,13,580,75,0],[580,75,580,83,0],[580,83,580,85,0],[580,13,580,85,0],[582,13,582,40,0],[583,13,583,94,0],[584,13,584,53,0],[585,9,585,10,0],[588,9,588,10,0],[589,13,589,94,0],[590,13,590,32,0],[590,33,590,45,0],[591,13,591,56,0],[592,13,593,78,0],[594,13,594,31,0],[595,9,595,10,0],[602,9,602,10,0],[603,13,603,50,0],[604,13,604,27,0],[605,13,605,14,0],[606,17,606,54,0],[607,17,607,61,0],[608,17,608,60,0],[609,17,609,45,0],[612,13,612,48,0],[613,13,614,130,0],[615,13,615,53,0],[616,9,616,10,0],[623,9,623,10,0],[624,10,624,55,0],[625,9,625,10,0],[628,9,628,10,0],[629,13,629,48,0],[630,13,630,36,0],[631,13,631,20,0],[631,22,631,33,0],[631,34,631,36,0],[631,37,631,89,0],[632,17,632,89,0],[633,13,633,53,0],[634,9,634,10,0],[643,9,643,10,0],[644,10,644,66,0],[645,9,645,10,0],[654,9,654,10,0],[655,10,655,66,0],[656,9,656,10,0],[665,9,665,10,0],[666,4,666,24,0],[667,9,667,10,0],[676,9,676,10,0],[677,13,677,72,0],[678,17,678,29,0],[680,17,680,30,0],[681,9,681,10,0],[690,9,690,10,0],[691,13,691,73,0],[692,17,692,29,0],[694,17,694,30,0],[695,9,695,10,0],[703,9,703,10,0],[704,13,704,56,0],[705,13,705,70,0],[706,13,706,100,0],[707,13,707,67,0],[708,13,708,29,0],[709,17,709,29,0],[711,17,711,30,0],[712,9,712,10,0],[720,9,720,10,0],[721,13,721,56,0],[722,13,722,70,0],[723,13,723,100,0],[724,13,724,67,0],[725,13,725,30,0],[726,17,726,29,0],[728,17,728,30,0],[729,9,729,10,0],[736,9,736,10,0],[737,13,737,47,0],[738,9,738,10,0],[748,9,748,10,0],[749,13,749,82,0],[750,9,750,10,0],[758,9,758,10,0],[759,13,759,58,0],[760,9,760,10,0],[770,9,770,10,0],[771,13,771,39,0],[774,21,774,47,0],[775,21,775,27,0],[777,21,777,48,0],[778,21,778,27,0],[780,21,780,46,0],[781,21,781,27,0],[783,21,783,47,0],[784,21,784,27,0],[786,21,786,49,0],[787,21,787,27,0],[789,21,789,49,0],[790,21,790,27,0],[793,13,793,39,0],[794,9,794,10,0],[804,9,804,10,0],[805,13,805,90,0],[807,13,807,40,0],[810,21,810,61,0],[812,21,812,61,0],[814,21,814,64,0],[817,13,817,22,0],[818,9,818,10,0],[827,9,827,10,0],[829,13,829,53,0],[830,17,830,48,0],[831,13,831,33,0],[832,9,832,10,0],[842,9,842,10,0],[844,13,844,53,0],[845,13,845,14,0],[846,17,846,30,0],[847,21,847,97,0],[848,17,848,50,0],[850,13,850,33,0],[851,9,851,10,0],[859,9,859,10,0],[860,13,860,82,0],[861,13,861,74,0],[861,74,861,75,0],[861,75,861,76,0],[861,76,861,111,0],[861,111,861,112,0],[861,112,861,113,0],[861,113,861,115,0],[861,13,861,115,0],[862,13,862,30,0],[863,9,863,10,0],[876,9,876,10,0],[877,13,877,45,0],[878,17,878,37,0],[881,13,881,53,0],[882,13,882,96,0],[883,13,883,82,0],[884,13,884,14,0],[885,17,885,30,0],[886,21,887,122,0],[888,17,888,64,0],[890,13,890,33,0],[891,9,891,10,0],[899,9,899,10,0],[901,13,901,53,0],[902,17,902,50,0],[903,13,903,33,0],[904,9,904,10,0],[912,9,912,10,0],[914,13,914,53,0],[915,17,915,51,0],[916,13,916,33,0],[917,9,917,10,0],[926,9,926,10,0],[927,13,927,45,0],[928,17,928,37,0],[931,13,931,53,0],[932,13,932,14,0],[933,17,933,100,0],[934,17,934,65,0],[936,13,936,33,0],[937,9,937,10,0],[946,9,946,10,0],[947,13,947,45,0],[948,17,948,37,0],[951,13,951,53,0],[952,13,952,14,0],[953,17,953,100,0],[954,17,955,65,0],[957,13,957,33,0],[958,9,958,10,0],[966,9,966,10,0],[968,13,968,53,0],[969,17,969,51,0],[970,13,970,33,0],[971,9,971,10,0],[981,9,981,10,0],[983,13,983,53,0],[984,13,984,14,0],[985,17,985,30,0],[986,21,986,98,0],[987,17,987,51,0],[989,13,989,33,0],[990,9,990,10,0],[998,9,998,10,0],[999,10,999,67,0],[1000,9,1000,10,0],[1011,9,1011,10,0],[1013,13,1013,14,0],[1014,17,1014,103,0],[1015,17,1015,55,0],[1016,17,1016,78,0],[1018,17,1018,54,0],[1019,17,1019,60,0],[1020,17,1020,37,0],[1022,17,1022,38,0],[1024,13,1024,33,0],[1025,13,1025,14,0],[1026,17,1026,91,0],[1028,9,1028,10,0],[1037,9,1037,10,0],[1038,13,1038,84,0],[1039,13,1039,14,0],[1040,24,1040,51,0],[1041,17,1041,18,0],[1043,21,1043,22,0],[1044,25,1044,86,0],[1045,25,1045,126,0],[1046,25,1046,53,0],[1047,21,1047,22,0],[1048,21,1048,41,0],[1049,21,1049,22,0],[1050,25,1050,102,0],[1051,21,1051,22,0],[1053,21,1053,42,0],[1057,13,1057,14,0],[1059,17,1059,102,0],[1060,17,1060,42,0],[1061,17,1061,46,0],[1063,12,1063,39,0],[1064,23,1064,54,0],[1065,17,1065,18,0],[1066,6,1066,26,0],[1067,6,1067,27,0],[1071,9,1071,10,0],[1079,9,1079,10,0],[1080,10,1080,44,0],[1081,9,1081,10,0],[1090,9,1090,10,0],[1091,13,1091,65,0],[1093,13,1093,27,0],[1094,17,1094,99,0],[1095,9,1095,10,0],[1103,9,1103,10,0],[1104,13,1104,65,0],[1106,13,1106,27,0],[1107,13,1107,14,0],[1108,17,1108,131,0],[1109,17,1109,34,0],[1110,17,1110,61,0],[1111,17,1111,60,0],[1112,17,1112,53,0],[1114,17,1114,38,0],[1115,17,1115,18,0],[1116,21,1116,59,0],[1117,21,1117,22,0],[1118,25,1118,56,0],[1119,21,1119,22,0],[1120,17,1120,18,0],[1122,17,1122,18,0],[1124,21,1124,128,0],[1125,17,1125,18,0],[1126,13,1126,14,0],[1127,9,1127,10,0],[1135,9,1135,10,0],[1136,13,1136,65,0],[1138,13,1138,27,0],[1139,13,1139,14,0],[1141,17,1141,92,0],[1142,17,1142,18,0],[1143,21,1143,137,0],[1144,21,1144,38,0],[1145,21,1145,71,0],[1146,21,1146,56,0],[1148,21,1148,42,0],[1149,21,1149,22,0],[1150,25,1150,63,0],[1151,25,1151,26,0],[1152,29,1152,60,0],[1153,25,1153,26,0],[1154,21,1154,22,0],[1156,21,1156,22,0],[1158,25,1158,91,0],[1159,21,1159,22,0],[1160,17,1160,18,0],[1162,17,1162,18,0],[1163,21,1163,163,0],[1164,17,1164,18,0],[1165,13,1165,14,0],[1166,9,1166,10,0],[1173,9,1173,10,0],[1174,13,1174,135,0],[1175,9,1175,10,0],[1184,9,1184,10,0],[1185,13,1185,44,0],[1186,13,1186,63,0],[1187,9,1187,10,0],[1198,9,1198,10,0],[1199,13,1199,41,0],[1200,17,1200,84,0],[1202,17,1202,29,0],[1203,9,1203,10,0],[1212,9,1212,10,0],[1213,13,1213,78,0],[1214,13,1214,48,0],[1215,13,1215,37,0],[1216,13,1216,20,0],[1216,22,1216,31,0],[1216,32,1216,34,0],[1216,35,1216,41,0],[1217,13,1217,14,0],[1218,17,1218,71,0],[1219,17,1219,54,0],[1220,13,1220,14,0],[1221,13,1221,54,0],[1222,13,1222,41,0],[1223,9,1223,10,0],[1231,9,1231,10,0],[1232,13,1232,44,0],[1233,17,1233,27,0],[1235,13,1235,33,0],[1236,13,1236,14,0],[1237,17,1237,61,0],[1238,21,1238,63,0],[1239,17,1239,76,0],[1240,21,1240,63,0],[1241,13,1241,14,0],[1242,13,1242,25,0],[1243,9,1243,10,0],[1253,9,1253,10,0],[1254,13,1254,53,0],[1255,9,1255,10,0],[1264,9,1264,10,0],[1265,13,1265,44,0],[1266,9,1266,10,0],[1278,9,1278,10,0],[1279,13,1279,48,0],[1280,13,1280,40,0],[1282,20,1282,57,0],[1283,20,1284,70,0],[1285,13,1285,14,0],[1286,17,1286,34,0],[1287,17,1287,18,0],[1288,21,1288,94,0],[1289,21,1289,103,0],[1290,21,1290,55,0],[1291,17,1291,18,0],[1292,13,1292,14,0],[1293,13,1293,54,0],[1294,13,1294,44,0],[1295,9,1295,10,0],[1303,9,1303,10,0],[1305,13,1305,14,0],[1306,24,1306,61,0],[1307,21,1308,63,0],[1310,13,1310,18,0],[1311,13,1311,14,0],[1312,17,1312,37,0],[1314,9,1314,10,0],[1327,9,1327,10,0],[1328,13,1328,48,0],[1329,13,1329,46,0],[1332,13,1332,14,0],[1334,17,1334,124,0],[1336,17,1336,83,0],[1338,17,1338,24,0],[1338,26,1338,56,0],[1338,57,1338,59,0],[1338,60,1338,71,0],[1339,17,1339,18,0],[1342,21,1342,22,0],[1343,25,1343,45,0],[1344,29,1344,102,0],[1346,29,1346,92,0],[1347,21,1347,22,0],[1348,21,1348,26,0],[1349,21,1349,22,0],[1350,25,1350,88,0],[1351,21,1351,22,0],[1352,21,1352,87,0],[1353,21,1353,56,0],[1354,17,1354,18,0],[1355,13,1355,14,0],[1356,13,1356,33,0],[1357,13,1357,14,0],[1358,17,1359,72,0],[1360,13,1360,14,0],[1362,13,1362,54,0],[1363,13,1363,35,0],[1364,9,1364,10,0],[1372,9,1372,10,0],[1373,10,1373,60,0],[1374,9,1374,10,0],[1381,9,1381,10,0],[1383,13,1383,14,0],[1384,17,1384,95,0],[1385,17,1385,78,0],[1386,17,1386,40,0],[1388,13,1388,33,0],[1389,13,1389,14,0],[1390,17,1390,85,0],[1391,13,1391,14,0],[1393,13,1393,48,0],[1394,13,1394,65,0],[1395,13,1395,53,0],[1396,9,1396,10,0],[1404,9,1404,10,0],[1406,13,1406,61,0],[1408,13,1408,51,0],[1409,13,1409,14,0],[1410,17,1410,62,0],[1411,17,1411,33,0],[1412,17,1412,39,0],[1415,13,1415,14,0],[1416,17,1416,52,0],[1417,17,1417,101,0],[1418,17,1418,57,0],[1420,9,1420,10,0],[1425,9,1425,10,0],[1426,13,1428,54,0],[1429,9,1429,10,0],[1437,9,1437,10,0],[1438,13,1438,78,0],[1440,13,1440,42,0],[1441,9,1441,10,0],[1448,9,1448,10,0],[1449,13,1449,78,0],[1450,13,1450,39,0],[1451,9,1451,10,0],[1461,9,1461,10,0],[1462,13,1462,52,0],[1464,13,1464,14,0],[1465,17,1465,30,0],[1466,21,1466,57,0],[1468,21,1468,39,0],[1469,13,1469,14,0],[1470,13,1470,34,0],[1471,13,1471,14,0],[1472,17,1473,107,0],[1474,13,1474,14,0],[1475,13,1475,58,0],[1476,13,1476,35,0],[1477,9,1477,10,0],[1486,9,1486,10,0],[1487,13,1487,52,0],[1488,13,1488,57,0],[1490,13,1490,14,0],[1491,17,1491,62,0],[1492,17,1492,70,0],[1493,17,1493,74,0],[1495,17,1495,37,0],[1497,17,1497,34,0],[1498,17,1498,40,0],[1499,13,1499,14,0],[1500,13,1500,34,0],[1501,13,1501,14,0],[1502,17,1503,96,0],[1504,13,1504,14,0],[1505,13,1505,58,0],[1506,13,1506,35,0],[1507,9,1507,10,0],[1516,9,1516,10,0],[1518,13,1519,79,0],[1520,13,1520,34,0],[1521,17,1521,52,0],[1523,13,1523,14,0],[1524,17,1525,46,0],[1527,17,1528,152,0],[1529,17,1529,31,0],[1532,9,1532,10,0],[1540,9,1540,10,0],[1541,13,1541,46,0],[1542,13,1542,76,0],[1543,13,1543,14,0],[1544,17,1545,124,0],[1546,22,1546,31,0],[1546,33,1546,48,0],[1546,50,1546,53,0],[1547,17,1547,18,0],[1548,21,1548,31,0],[1549,25,1549,71,0],[1551,25,1551,66,0],[1552,17,1552,18,0],[1553,13,1553,14,0],[1555,13,1555,31,0],[1556,9,1556,10,0],[1566,9,1566,10,0],[1568,13,1568,14,0],[1569,17,1569,52,0],[1570,17,1570,45,0],[1571,21,1571,54,0],[1573,21,1573,41,0],[1575,13,1575,18,0],[1576,13,1576,14,0],[1577,17,1577,61,0],[1579,9,1579,10,0],[1590,9,1590,10,0],[1592,13,1592,14,0],[1593,24,1593,52,0],[1594,17,1594,18,0],[1595,21,1595,66,0],[1596,21,1596,28,0],[1596,30,1596,45,0],[1596,46,1596,48,0],[1596,49,1596,66,0],[1597,25,1597,74,0],[1598,21,1598,44,0],[1599,21,1599,46,0],[1600,21,1600,38,0],[1601,28,1601,61,0],[1602,25,1602,47,0],[1603,17,1603,18,0],[1604,13,1604,14,0],[1605,13,1605,33,0],[1606,13,1606,14,0],[1607,17,1607,95,0],[1608,13,1608,14,0],[1609,9,1609,10,0],[1623,9,1623,10,0],[1624,13,1624,78,0],[1625,13,1625,27,0],[1626,13,1626,14,0],[1627,17,1627,31,0],[1628,21,1628,38,0],[1630,21,1630,42,0],[1631,17,1631,69,0],[1632,13,1632,14,0],[1633,13,1633,22,0],[1634,9,1634,10,0],[1641,9,1641,10,0],[1642,13,1642,33,0],[1643,9,1643,10,0],[1652,9,1652,10,0],[1653,13,1653,58,0],[1654,17,1654,57,0],[1656,17,1656,37,0],[1657,9,1657,10,0],[1664,9,1664,10,0],[1665,13,1665,49,0],[1666,13,1666,14,0],[1667,17,1667,69,0],[1668,13,1668,14,0],[1669,9,1669,10,0],[1677,9,1677,10,0],[1678,13,1678,56,0],[1679,17,1679,66,0],[1681,17,1681,37,0],[1682,9,1682,10,0],[1690,9,1690,10,0],[1691,13,1691,56,0],[1692,17,1692,66,0],[1694,17,1694,37,0],[1695,9,1695,10,0],[1703,9,1703,10,0],[1704,13,1704,63,0],[1705,17,1705,62,0],[1707,17,1707,37,0],[1708,9,1708,10,0],[1716,9,1716,10,0],[1717,13,1717,70,0],[1718,17,1718,69,0],[1720,17,1720,37,0],[1721,9,1721,10,0],[1729,9,1729,10,0],[1731,13,1731,57,0],[1732,13,1732,32,0],[1733,9,1733,10,0],[1741,9,1741,10,0],[1742,13,1742,74,0],[1743,17,1743,73,0],[1745,17,1745,37,0],[1746,9,1746,10,0],[1754,9,1754,10,0],[1755,13,1755,97,0],[1756,17,1756,68,0],[1758,17,1758,37,0],[1759,9,1759,10,0],[1766,9,1766,10,0],[1767,13,1767,53,0],[1768,17,1768,62,0],[1770,17,1770,37,0],[1771,9,1771,10,0],[1779,9,1779,10,0],[1780,13,1780,48,0],[1781,9,1781,10,0],[1789,9,1789,10,0],[1790,13,1790,49,0],[1791,9,1791,10,0],[1794,9,1794,10,0],[1795,13,1795,50,0],[1796,9,1796,10,0],[1800,9,1800,10,0],[1801,13,1801,65,0],[1802,9,1802,10,0],[1806,9,1806,10,0],[1807,13,1807,65,0],[1808,9,1808,10,0],[1812,9,1812,10,0],[1813,13,1813,67,0],[1814,9,1814,10,0],[1818,9,1818,10,0],[1819,13,1819,68,0],[1820,9,1820,10,0],[1834,9,1834,10,0],[1835,13,1835,48,0],[1836,13,1836,40,0],[1837,13,1837,54,0],[1838,13,1838,20,0],[1838,22,1838,32,0],[1838,33,1838,35,0],[1838,36,1838,40,0],[1839,13,1839,14,0],[1840,17,1840,61,0],[1841,17,1841,81,0],[1842,17,1842,100,0],[1843,17,1843,93,0],[1844,17,1844,104,0],[1845,17,1845,101,0],[1846,17,1846,99,0],[1849,17,1849,42,0],[1850,21,1850,62,0],[1852,21,1852,61,0],[1853,17,1853,51,0],[1854,13,1854,14,0],[1855,13,1855,54,0],[1856,13,1856,35,0],[1857,9,1857,10,0],[1864,9,1864,10,0],[1865,13,1865,31,0],[1866,17,1866,37,0],[1868,17,1868,27,0],[1869,9,1869,10,0],[1876,9,1876,10,0],[1877,13,1877,31,0],[1878,17,1878,39,0],[1880,17,1880,37,0],[1881,9,1881,10,0],[1889,9,1889,10,0],[1890,13,1890,31,0],[1891,13,1891,14,0],[1892,17,1892,49,0],[1893,21,1893,59,0],[1895,21,1895,41,0],[1898,17,1898,37,0],[1899,9,1899,10,0],[1910,9,1910,10,0],[1911,13,1911,61,0],[1912,9,1912,10,0],[1929,9,1929,10,0],[1930,13,1930,50,0],[1931,9,1931,10,0],[1948,9,1948,10,0],[1950,13,1950,49,0],[1951,17,1951,62,0],[1956,13,1959,108,0],[1963,13,1963,116,0],[1964,9,1964,10,0]]);
    </script>
  </body>
</html>