<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Resolvers\ResolutionTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

using Umbraco.Core;
using Umbraco.Core.ObjectResolution;
using NUnit.Framework;

namespace Umbraco.Tests.Resolvers
{
    [TestFixture]
    public class ResolutionTests
    {
        [SetUp]
        public void Setup()
        {
        }

        [TearDown]
        public void TearDown()
        {
            BaseResolver.Reset();
            BaseResolver2.Reset();
            BaseResolver3.Reset();
        }

        #region Resolvers and Resolved

        class BaseResolver : ResolverBase&lt;BaseResolver&gt;
        { }

        class BaseResolver2 : ResolverBase&lt;BaseResolver2&gt;
        { }

        class BaseResolver3 : ResolverBase&lt;BaseResolver3&gt;
        { }

        #endregion

        #region Test Resolution

        [Test]
        public void ResolutionCanFreeze()
        {
            Resolution.Freeze();
            Assert.IsTrue(Resolution.IsFrozen);
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ResolutionCannotFreezeAgain()
        {
            Resolution.Freeze();
            Resolution.Freeze(); // throws
        }

        [Test]
        public void ResolutionCanReset()
        {
            Resolution.Freeze();
            Resolution.Reset();
            Assert.IsFalse(Resolution.IsFrozen);
        }

        [Test]
        public void ResolutionCanConfigureBeforeFreeze()
        {
            using (Resolution.Configuration)
            { }
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ResolutionCannotConfigureOnceFrozen()
        {
            Resolution.Freeze();

            using (Resolution.Configuration) // throws
            { }
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ResolutionCanDetectIfNotFrozen()
        {
            using (Resolution.Reader()) // throws
            {}
        }

        [Test]
        public void ResolutionCanEnsureIsFrozen()
        {
            Resolution.Freeze();
            using (Resolution.Reader()) // ok
            {}
        }

        [Test]
        public void ResolutionFrozenEventTriggers()
        {
            int count = 0;
            object copySender = null;
            EventArgs copyArgs = null;
            Resolution.Frozen += (sender, args) =&gt;
            {
                copySender = sender;
                copyArgs = args;
                count++;
            };
            Assert.AreEqual(0, count);
            Resolution.Freeze();

            Assert.AreEqual(1, count);
            Assert.IsNull(copySender);
            Assert.IsNull(copyArgs);
        }

        [Test]
        public void ResolutionResetClearsFrozenEvent()
        {
            int count = 0;
            Resolution.Frozen += (sender, args) =&gt;
            {
                count++;
            };
            Resolution.Freeze();
            Assert.AreEqual(1, count);

            Resolution.Reset();

            Resolution.Freeze();
            Assert.AreEqual(1, count);
        }

        #endregion

        #region Test ResolverBase

        // unused

        [Test]
        public void BaseResolverCurrentCanBeNullOnFreeze()
        {
            // does not throw, even though BaseResolver.Current is not initialized
            Resolution.Freeze();
        }

        // set

        [Test]
        public void BaseResolverCurrentCanSetBeforeFreeze()
        {
            BaseResolver.Current = new BaseResolver();
        }

        [Test]
        [ExpectedException(typeof(ArgumentNullException))]
        public void BaseResolverCurrentCannotSetToNull()
        {
            BaseResolver.Current = null; // throws
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void BaseResolverCurrentCannotSetAgain()
        {
            BaseResolver.Current = new BaseResolver();

            // cannot set again
            BaseResolver.Current = new BaseResolver(); // throws
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void BaseResolverCurrentCannotSetOnceFrozen()
        {
            Resolution.Freeze();

            // cannot set once frozen
            BaseResolver.Current = new BaseResolver(); // throws
        }

        // get

        // ignore: see BaseResolverCurrentCanGetBeforeFreeze
        //[Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void BaseResolverCurrentCannotGetBeforeFreeze()
        {
            BaseResolver.Current = new BaseResolver();

            // cannot get before freeze
            var resolver = BaseResolver.Current; // throws
        }

        [Test]
        public void BaseResolverCurrentCanGetBeforeFreeze()
        {
            BaseResolver.Current = new BaseResolver();
            var resolver = BaseResolver.Current;
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void BaseResolverCurrentCannotGetIfNotSet()
        {
            Resolution.Freeze();

            // cannot get before freeze
            var resolver = BaseResolver.Current; // throws
        }

        [Test]
        public void BaseResolverCurrentCanGetOnceFrozen()
        {
            BaseResolver.Current = new BaseResolver();
            Resolution.Freeze();
            var resolver = BaseResolver.Current;
        }

        #endregion

        [Test]
        public void Resolver_Collection_Is_Updated()
        {
            BaseResolver.Current = new BaseResolver();
            BaseResolver2.Current = new BaseResolver2();
            BaseResolver3.Current = new BaseResolver3();
            Assert.AreEqual(3, ResolverCollection.Count);
        }

        [Test]
        public void Resolver_Collection_Is_Reset()
        {
            BaseResolver.Current = new BaseResolver();
            BaseResolver2.Current = new BaseResolver2();
            BaseResolver3.Current = new BaseResolver3();
            
            ResolverCollection.ResetAll();

            Assert.AreEqual(0, ResolverCollection.Count);
            Assert.Throws&lt;InvalidOperationException&gt;(() =&gt;
                {
                    var c = BaseResolver.Current;
                });
            Assert.Throws&lt;InvalidOperationException&gt;(() =&gt;
            {
                var c = BaseResolver2.Current;
            });
            Assert.Throws&lt;InvalidOperationException&gt;(() =&gt;
            {
                var c = BaseResolver3.Current;
            });

            //this should not error!
            BaseResolver.Current = new BaseResolver();
            BaseResolver2.Current = new BaseResolver2();
            BaseResolver3.Current = new BaseResolver3();

            Assert.Pass();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,10,1],[18,9,18,10,1],[22,9,22,10,1],[23,13,23,34,1],[24,13,24,35,1],[25,13,25,35,1],[26,9,26,10,1],[45,9,45,10,1],[46,13,46,33,1],[47,13,47,48,1],[48,9,48,10,1],[53,9,53,10,1],[54,13,54,33,1],[55,13,55,33,1],[56,9,56,10,0],[60,9,60,10,1],[61,13,61,33,1],[62,13,62,32,1],[63,13,63,49,1],[64,9,64,10,1],[68,9,68,10,1],[69,13,69,45,1],[70,13,70,14,1],[70,15,70,16,1],[71,9,71,10,1],[76,9,76,10,1],[77,13,77,33,1],[79,13,79,45,1],[80,13,80,14,0],[80,15,80,16,0],[81,9,81,10,0],[86,9,86,10,1],[87,13,87,40,1],[88,13,88,14,0],[88,14,88,15,0],[89,9,89,10,0],[93,9,93,10,1],[94,13,94,33,1],[95,13,95,40,1],[96,13,96,14,1],[96,14,96,15,1],[97,9,97,10,1],[101,9,101,10,1],[102,13,102,27,1],[103,13,103,38,1],[104,13,104,39,1],[105,13,106,13,1],[106,13,106,14,1],[106,14,107,17,1],[107,17,107,37,1],[107,37,108,17,1],[108,17,108,33,1],[108,33,109,17,1],[109,17,109,25,1],[109,25,110,13,1],[110,13,110,14,1],[110,14,110,15,1],[105,13,110,15,1],[111,13,111,39,1],[112,13,112,33,1],[114,13,114,39,1],[115,13,115,39,1],[116,13,116,37,1],[117,9,117,10,1],[121,9,121,10,1],[122,13,122,27,1],[123,13,124,13,1],[124,13,124,14,1],[124,14,125,17,1],[125,17,125,25,1],[125,25,126,13,1],[126,13,126,14,1],[126,14,126,15,1],[123,13,126,15,1],[127,13,127,33,1],[128,13,128,39,1],[130,13,130,32,1],[132,13,132,33,1],[133,13,133,39,1],[134,9,134,10,1],[144,9,144,10,1],[146,13,146,33,1],[147,9,147,10,1],[153,9,153,10,1],[154,13,154,55,1],[155,9,155,10,1],[160,9,160,10,1],[161,13,161,41,1],[162,9,162,10,0],[167,9,167,10,1],[168,13,168,55,1],[171,13,171,55,1],[172,9,172,10,0],[177,9,177,10,1],[178,13,178,33,1],[181,13,181,55,1],[182,9,182,10,0],[190,9,190,10,0],[191,13,191,55,0],[194,13,194,49,0],[195,9,195,10,0],[199,9,199,10,1],[200,13,200,55,1],[201,13,201,49,1],[202,9,202,10,1],[207,9,207,10,1],[208,13,208,33,1],[211,13,211,49,1],[212,9,212,10,0],[216,9,216,10,1],[217,13,217,55,1],[218,13,218,33,1],[219,13,219,49,1],[220,9,220,10,1],[226,9,226,10,1],[227,13,227,55,1],[228,13,228,57,1],[229,13,229,57,1],[230,13,230,58,1],[231,9,231,10,1],[235,9,235,10,1],[236,13,236,55,1],[237,13,237,57,1],[238,13,238,57,1],[240,13,240,43,1],[242,13,242,58,1],[243,13,244,17,1],[244,17,244,18,1],[244,18,245,21,1],[245,21,245,50,1],[245,50,246,17,1],[246,17,246,18,0],[246,18,246,20,1],[243,13,246,20,1],[247,13,248,13,1],[248,13,248,14,1],[248,14,249,17,1],[249,17,249,47,1],[249,47,250,13,1],[250,13,250,14,0],[250,14,250,16,1],[247,13,250,16,1],[251,13,252,13,1],[252,13,252,14,1],[252,14,253,17,1],[253,17,253,47,1],[253,47,254,13,1],[254,13,254,14,0],[254,14,254,16,1],[251,13,254,16,1],[257,13,257,55,1],[258,13,258,57,1],[259,13,259,57,1],[261,13,261,27,1],[262,9,262,10,0]]);
    </script>
  </body>
</html>