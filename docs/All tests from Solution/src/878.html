<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\DataTypeTreeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Net;
using System.Net.Http.Formatting;
using System.Web.Http;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Web.Models.Trees;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi.Filters;
using umbraco;
using umbraco.BusinessLogic.Actions;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Services;
using Constants = Umbraco.Core.Constants;

namespace Umbraco.Web.Trees
{
    [UmbracoTreeAuthorize(Constants.Trees.DataTypes)]
    [Tree(Constants.Applications.Developer, Constants.Trees.DataTypes, null, sortOrder:1)]
    [PluginController(&quot;UmbracoTrees&quot;)]
    [CoreTree]
    public class DataTypeTreeController : TreeController
    {
        protected override TreeNodeCollection GetTreeNodes(string id, FormDataCollection queryStrings)
        {
            var intId = id.TryConvertTo&lt;int&gt;();
            if (intId == false) throw new InvalidOperationException(&quot;Id must be an integer&quot;);        
            
            var nodes = new TreeNodeCollection();

            //Folders first
            nodes.AddRange(
               Services.EntityService.GetChildren(intId.Result, UmbracoObjectTypes.DataTypeContainer)
                   .OrderBy(entity =&gt; entity.Name)
                   .Select(dt =&gt;
                   {
                       var node = CreateTreeNode(dt.Id.ToString(), id, queryStrings, dt.Name, &quot;icon-folder&quot;, dt.HasChildren(), &quot;&quot;);
                       node.Path = dt.Path;
                       node.NodeType = &quot;container&quot;;
                        //TODO: This isn&#39;t the best way to ensure a noop process for clicking a node but it works for now.
                        node.AdditionalData[&quot;jsClickCallback&quot;] = &quot;javascript:void(0);&quot;;
                       return node;
                   }));

            //if the request is for folders only then just return
            if (queryStrings[&quot;foldersonly&quot;].IsNullOrWhiteSpace() == false &amp;&amp; queryStrings[&quot;foldersonly&quot;] == &quot;1&quot;) return nodes;

            //Normal nodes
            var sysIds = GetSystemIds();

            nodes.AddRange(
                Services.EntityService.GetChildren(intId.Result, UmbracoObjectTypes.DataType)
                    .OrderBy(entity =&gt; entity.Name)
                    .Select(dt =&gt;
                    {
                        var node = CreateTreeNode(dt.Id.ToInvariantString(), id, queryStrings, dt.Name, &quot;icon-autofill&quot;, false);
                        node.Path = dt.Path;
                        if (sysIds.Contains(dt.Id))
                        {
                            node.Icon = &quot;icon-thumbnail-list&quot;;
                        }
                        return node;
                    }));

            return nodes;
        }

        private IEnumerable&lt;int&gt; GetSystemIds()
        {
            var systemIds = new[]
            {
                Constants.System.DefaultContentListViewDataTypeId, 
                Constants.System.DefaultMediaListViewDataTypeId, 
                Constants.System.DefaultMembersListViewDataTypeId
            };
            return systemIds;
        } 
        
        protected override MenuItemCollection GetMenuForNode(string id, FormDataCollection queryStrings)
        {
            var menu = new MenuItemCollection();

            if (id == Constants.System.Root.ToInvariantString())
            {
                //set the default to create
                menu.DefaultMenuAlias = ActionNew.Instance.Alias;

                // root actions              
                menu.Items.Add&lt;ActionNew&gt;(Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionNew.Instance.Alias)));
                menu.Items.Add&lt;RefreshNode, ActionRefresh&gt;(ui.Text(&quot;actions&quot;, ActionRefresh.Instance.Alias), true);
                return menu;
            }

            var container = Services.EntityService.Get(int.Parse(id), UmbracoObjectTypes.DataTypeContainer);
            if (container != null)
            {
                //set the default to create
                menu.DefaultMenuAlias = ActionNew.Instance.Alias;

                menu.Items.Add&lt;ActionNew&gt;(Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionNew.Instance.Alias)));

                if (container.HasChildren() == false)
                {
                    //can delete data type
                    menu.Items.Add&lt;ActionDelete&gt;(Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionDelete.Instance.Alias)));
                }                
                menu.Items.Add&lt;RefreshNode, ActionRefresh&gt;(Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionRefresh.Instance.Alias)), hasSeparator: true);
            }
            else
            {
                var sysIds = GetSystemIds();

                if (sysIds.Contains(int.Parse(id)) == false)
                {
                    menu.Items.Add&lt;ActionDelete&gt;(Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionDelete.Instance.Alias)));
                }

                menu.Items.Add&lt;ActionMove&gt;(Services.TextService.Localize(string.Format(&quot;actions/{0}&quot;, ActionMove.Instance.Alias)), hasSeparator: true);
            }
            
            return menu;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[29,13,29,48,0],[30,13,30,32,0],[30,33,30,94,0],[32,13,32,50,0],[35,13,37,39,0],[37,39,37,50,0],[37,50,39,20,0],[39,20,39,21,0],[39,21,40,24,0],[40,24,40,132,0],[40,132,41,24,0],[41,24,41,44,0],[41,44,42,24,0],[42,24,42,52,0],[42,52,44,25,0],[44,25,44,88,0],[44,88,45,24,0],[45,24,45,36,0],[45,36,46,20,0],[46,20,46,21,0],[46,21,46,24,0],[35,13,46,24,0],[49,13,49,113,0],[49,114,49,127,0],[52,13,52,41,0],[54,13,56,40,0],[56,40,56,51,0],[56,51,58,21,0],[58,21,58,22,0],[58,22,59,25,0],[59,25,59,129,0],[59,129,60,25,0],[60,25,60,45,0],[60,45,61,25,0],[61,25,61,52,0],[61,52,62,25,0],[62,25,62,26,0],[62,26,63,29,0],[63,29,63,63,0],[63,63,64,25,0],[64,25,64,26,0],[64,26,65,25,0],[65,25,65,37,0],[65,37,66,21,0],[66,21,66,22,0],[66,22,66,25,0],[54,13,66,25,0],[68,13,68,26,0],[69,9,69,10,0],[72,9,72,10,0],[73,13,78,15,0],[79,13,79,30,0],[80,9,80,10,0],[83,9,83,10,0],[84,13,84,49,0],[86,13,86,65,0],[87,13,87,14,0],[89,17,89,66,0],[92,17,92,130,0],[93,17,93,116,0],[94,17,94,29,0],[97,13,97,109,0],[98,13,98,35,0],[99,13,99,14,0],[101,17,101,66,0],[103,17,103,130,0],[105,17,105,54,0],[106,17,106,18,0],[108,21,108,140,0],[109,17,109,18,0],[110,17,110,171,0],[111,13,111,14,0],[113,13,113,14,0],[114,17,114,45,0],[116,17,116,61,0],[117,17,117,18,0],[118,21,118,140,0],[119,17,119,18,0],[121,17,121,152,0],[122,13,122,14,0],[124,13,124,25,0],[125,9,125,10,0]]);
    </script>
  </body>
</html>