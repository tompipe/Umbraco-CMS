<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\TestHelpers\FakeHttpContextFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.Security;
using System.Security.Principal;
using System.Web;
using System.Web.Routing;
using Moq;
using Umbraco.Core;
using Umbraco.Core.Configuration;

namespace Umbraco.Tests.TestHelpers
{
	/// &lt;summary&gt;
	/// Creates a mock http context with supporting other contexts to test against
	/// &lt;/summary&gt;
	public class FakeHttpContextFactory
	{

		[SecuritySafeCritical]
		public FakeHttpContextFactory(Uri fullUrl)
		{
			CreateContext(fullUrl);
		}

		[SecuritySafeCritical]
		public FakeHttpContextFactory(string path)
		{
			if (path.StartsWith(&quot;http://&quot;) || path.StartsWith(&quot;https://&quot;))
				CreateContext(new Uri(path));
			else
				CreateContext(new Uri(&quot;http://mysite&quot; + VirtualPathUtility.ToAbsolute(path, &quot;/&quot;)));
		}

		[SecuritySafeCritical]
		public FakeHttpContextFactory(string path, RouteData routeData)
		{
			if (path.StartsWith(&quot;http://&quot;) || path.StartsWith(&quot;https://&quot;))
				CreateContext(new Uri(path), routeData);
			else
				CreateContext(new Uri(&quot;http://mysite&quot; + VirtualPathUtility.ToAbsolute(path, &quot;/&quot;)), routeData);
		}

		public HttpContextBase HttpContext { get; private set; }
		public RequestContext RequestContext { get; private set; }

		/// &lt;summary&gt;
		/// Mocks the http context to test against
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;fullUrl&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;routeData&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		private void CreateContext(Uri fullUrl, RouteData routeData = null)
		{
			//Request context

            var requestContextMock = new Mock&lt;RequestContext&gt;();

            RequestContext = requestContextMock.Object;

            //Cookie collection
		    var cookieCollection = new HttpCookieCollection();
            cookieCollection.Add(new HttpCookie(&quot;UMB_UCONTEXT&quot;, &quot;FBA996E7-D6BE-489B-B199-2B0F3D2DD826&quot;));

		    //Request
            var requestMock = new Mock&lt;HttpRequestBase&gt;();
            requestMock.Setup(x =&gt; x.AppRelativeCurrentExecutionFilePath).Returns(&quot;~&quot; + fullUrl.AbsolutePath);
			requestMock.Setup(x =&gt; x.PathInfo).Returns(string.Empty);
            requestMock.Setup(x =&gt; x.RawUrl).Returns(VirtualPathUtility.ToAbsolute(&quot;~&quot; + fullUrl.AbsolutePath, &quot;/&quot;));
            requestMock.Setup(x =&gt; x.RequestContext).Returns(RequestContext);
            requestMock.Setup(x =&gt; x.Url).Returns(fullUrl);
            requestMock.Setup(x =&gt; x.ApplicationPath).Returns(&quot;/&quot;);
            requestMock.Setup(x =&gt; x.Cookies).Returns(cookieCollection);
            requestMock.Setup(x =&gt; x.ServerVariables).Returns(new NameValueCollection());
			var queryStrings = HttpUtility.ParseQueryString(fullUrl.Query);
            requestMock.Setup(x =&gt; x.QueryString).Returns(queryStrings);
            requestMock.Setup(x =&gt; x.Form).Returns(new NameValueCollection());

			//Cache
            var cacheMock = new Mock&lt;HttpCachePolicyBase&gt;();

			//Response 
			//var response = new FakeHttpResponse();
            var responseMock = new Mock&lt;HttpResponseBase&gt;();
            responseMock.Setup(x =&gt; x.ApplyAppPathModifier(It.IsAny&lt;string&gt;())).Returns((string s) =&gt; s);
            responseMock.Setup(x =&gt; x.Cache).Returns(cacheMock.Object);

			//Server

			var serverMock = new Mock&lt;HttpServerUtilityBase&gt;();
			serverMock.Setup(x =&gt; x.MapPath(It.IsAny&lt;string&gt;())).Returns(Environment.CurrentDirectory);

            //User
		    var user = new Mock&lt;IPrincipal&gt;().Object;

			//HTTP Context

            var httpContextMock = new Mock&lt;HttpContextBase&gt;();
            httpContextMock.Setup(x =&gt; x.Cache).Returns(HttpRuntime.Cache);
            //note: foreach on Items should return DictionaryEntries!
            //httpContextMock.Setup(x =&gt; x.Items).Returns(new Dictionary&lt;object, object&gt;());
		    httpContextMock.Setup(x =&gt; x.Items).Returns(new Hashtable());
            httpContextMock.Setup(x =&gt; x.Request).Returns(requestMock.Object);
            httpContextMock.Setup(x =&gt; x.Server).Returns(serverMock.Object);
            httpContextMock.Setup(x =&gt; x.Response).Returns(responseMock.Object);
            httpContextMock.Setup(x =&gt; x.User).Returns(user);

            HttpContext = httpContextMock.Object;

            requestContextMock.Setup(x =&gt; x.HttpContext).Returns(httpContextMock.Object);

			if (routeData != null)
			{
                requestContextMock.Setup(x =&gt; x.RouteData).Returns(routeData);
			}
		    
            
		}

	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,3,22,45,0],[23,3,23,4,0],[24,4,24,27,0],[25,3,25,4,0],[28,3,28,45,1],[29,3,29,4,1],[30,4,30,66,1],[31,5,31,34,1],[33,5,33,88,1],[34,3,34,4,1],[37,3,37,66,1],[38,3,38,4,1],[39,4,39,66,1],[40,5,40,45,0],[42,5,42,99,1],[43,3,43,4,1],[45,40,45,44,1],[45,45,45,57,1],[46,42,46,46,1],[46,47,46,59,1],[55,3,55,4,1],[58,13,58,65,1],[60,13,60,56,1],[63,7,63,57,1],[64,13,64,106,1],[67,13,67,59,1],[68,13,68,111,1],[69,4,69,61,1],[70,13,70,118,1],[71,13,71,78,1],[72,13,72,60,1],[73,13,73,68,1],[74,13,74,73,1],[75,13,75,90,1],[76,4,76,67,1],[77,13,77,73,1],[78,13,78,79,1],[81,13,81,61,1],[85,13,85,61,1],[86,13,86,103,1],[86,103,86,104,0],[86,104,86,106,1],[86,13,86,106,1],[87,13,87,72,1],[91,4,91,55,1],[92,4,92,95,1],[95,7,95,48,1],[99,13,99,63,1],[100,13,100,76,1],[103,7,103,68,1],[104,13,104,79,1],[105,13,105,77,1],[106,13,106,81,1],[107,13,107,62,1],[109,13,109,50,1],[111,13,111,90,1],[113,4,113,26,1],[114,4,114,5,1],[115,17,115,79,1],[116,4,116,5,1],[119,3,119,4,1]]);
    </script>
  </body>
</html>