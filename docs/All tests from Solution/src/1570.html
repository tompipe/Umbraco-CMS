<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Security\BackOfficeUserManager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Web.Security;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.Owin;
using Microsoft.Owin.Security.DataProtection;
using Umbraco.Core.Models.Identity;
using Umbraco.Core.Services;

namespace Umbraco.Core.Security
{
    /// &lt;summary&gt;
    /// Default back office user manager
    /// &lt;/summary&gt;
    public class BackOfficeUserManager : BackOfficeUserManager&lt;BackOfficeIdentityUser&gt;
    {
        public const string OwinMarkerKey = &quot;Umbraco.Web.Security.Identity.BackOfficeUserManagerMarker&quot;;

        public BackOfficeUserManager(IUserStore&lt;BackOfficeIdentityUser, int&gt; store)
            : base(store)
        {
        }

        public BackOfficeUserManager(
            IUserStore&lt;BackOfficeIdentityUser, int&gt; store,
            IdentityFactoryOptions&lt;BackOfficeUserManager&gt; options,
            MembershipProviderBase membershipProvider)
            : base(store)
        {
            if (options == null) throw new ArgumentNullException(&quot;options&quot;);;
            InitUserManager(this, membershipProvider, options);
        }

        #region Static Create methods
        /// &lt;summary&gt;
        /// Creates a BackOfficeUserManager instance with all default options and the default BackOfficeUserManager 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;options&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;userService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;externalLoginService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;membershipProvider&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static BackOfficeUserManager Create(
            IdentityFactoryOptions&lt;BackOfficeUserManager&gt; options,
            IUserService userService,
            IExternalLoginService externalLoginService,
            MembershipProviderBase membershipProvider)
        {
            if (options == null) throw new ArgumentNullException(&quot;options&quot;);
            if (userService == null) throw new ArgumentNullException(&quot;userService&quot;);
            if (externalLoginService == null) throw new ArgumentNullException(&quot;externalLoginService&quot;);

            var manager = new BackOfficeUserManager(new BackOfficeUserStore(userService, externalLoginService, membershipProvider));
            manager.InitUserManager(manager, membershipProvider, options);
            return manager;
        }

        /// &lt;summary&gt;
        /// Creates a BackOfficeUserManager instance with all default options and a custom BackOfficeUserManager instance
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;options&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;customUserStore&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;membershipProvider&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static BackOfficeUserManager Create(
           IdentityFactoryOptions&lt;BackOfficeUserManager&gt; options,
           BackOfficeUserStore customUserStore,
           MembershipProviderBase membershipProvider)
        {
            var manager = new BackOfficeUserManager(customUserStore, options, membershipProvider);
            return manager;
        }
        #endregion

        /// &lt;summary&gt;
        /// Initializes the user manager with the correct options
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;manager&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;membershipProvider&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;options&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected void InitUserManager(
            BackOfficeUserManager manager,
            MembershipProviderBase membershipProvider,
            IdentityFactoryOptions&lt;BackOfficeUserManager&gt; options)
        {
            //NOTE: This method is mostly here for backwards compat
            base.InitUserManager(manager, membershipProvider, options.DataProtectionProvider);
        }

    }

    /// &lt;summary&gt;
    /// Generic Back office user manager
    /// &lt;/summary&gt;
    public class BackOfficeUserManager&lt;T&gt; : UserManager&lt;T, int&gt;
        where T : BackOfficeIdentityUser
    {
        public BackOfficeUserManager(IUserStore&lt;T, int&gt; store)
            : base(store)
        {
        }

        #region What we support do not currently

        //NOTE: Not sure if we really want/need to ever support this 
        public override bool SupportsUserClaim
        {
            get { return false; }
        }

        //TODO: Support this
        public override bool SupportsQueryableUsers
        {
            get { return false; }
        }

        /// &lt;summary&gt;
        /// Developers will need to override this to support custom 2 factor auth
        /// &lt;/summary&gt;
        public override bool SupportsUserTwoFactor
        {
            get { return false; }
        }

        //TODO: Support this
        public override bool SupportsUserPhoneNumber
        {
            get { return false; }
        }
        #endregion

        /// &lt;summary&gt;
        /// Initializes the user manager with the correct options
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;manager&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;membershipProvider&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataProtectionProvider&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected void InitUserManager(
            BackOfficeUserManager&lt;T&gt; manager, 
            MembershipProviderBase membershipProvider, 
            IDataProtectionProvider dataProtectionProvider)
        {
            // Configure validation logic for usernames
            manager.UserValidator = new UserValidator&lt;T, int&gt;(manager)
            {
                AllowOnlyAlphanumericUserNames = false,
                RequireUniqueEmail = true
            };

            // Configure validation logic for passwords
            manager.PasswordValidator = new PasswordValidator
            {
                RequiredLength = membershipProvider.MinRequiredPasswordLength,
                RequireNonLetterOrDigit = membershipProvider.MinRequiredNonAlphanumericCharacters &gt; 0,
                RequireDigit = false,
                RequireLowercase = false,
                RequireUppercase = false
                //TODO: Do we support the old regex match thing that membership providers used?
            };

            //use a custom hasher based on our membership provider
            manager.PasswordHasher = new MembershipPasswordHasher(membershipProvider);
            
            if (dataProtectionProvider != null)
            {
                manager.UserTokenProvider = new DataProtectorTokenProvider&lt;T, int&gt;(dataProtectionProvider.Create(&quot;ASP.NET Identity&quot;));
            }

            manager.UserLockoutEnabledByDefault = true;
            manager.MaxFailedAccessAttemptsBeforeLockout = membershipProvider.MaxInvalidPasswordAttempts;
            //NOTE: This just needs to be in the future, we currently don&#39;t support a lockout timespan, it&#39;s either they are locked
            // or they are not locked, but this determines what is set on the account lockout date which corresponds to whether they are
            // locked out or not.
            manager.DefaultAccountLockoutTimeSpan = TimeSpan.FromDays(30);

            //custom identity factory for creating the identity object for which we auth against in the back office
            manager.ClaimsIdentityFactory = new BackOfficeClaimsIdentityFactory&lt;T&gt;();

            manager.EmailService = new EmailService();

            //NOTE: Not implementing these, if people need custom 2 factor auth, they&#39;ll need to implement their own UserStore to suport it

            //// Register two factor authentication providers. This application uses Phone and Emails as a step of receiving a code for verifying the user
            //// You can write your own provider and plug in here.
            //manager.RegisterTwoFactorProvider(&quot;PhoneCode&quot;, new PhoneNumberTokenProvider&lt;ApplicationUser&gt;
            //{
            //    MessageFormat = &quot;Your security code is: {0}&quot;
            //});
            //manager.RegisterTwoFactorProvider(&quot;EmailCode&quot;, new EmailTokenProvider&lt;ApplicationUser&gt;
            //{
            //    Subject = &quot;Security Code&quot;,
            //    BodyFormat = &quot;Your security code is: {0}&quot;
            //});

            //manager.SmsService = new SmsService();            
        }

        /// &lt;summary&gt;
        /// Logic used to validate a username and password
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;user&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;password&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// By default this uses the standard ASP.Net Identity approach which is:
        /// * Get password store
        /// * Call VerifyPasswordAsync with the password store + user + password
        /// * Uses the PasswordHasher.VerifyHashedPassword to compare the stored password
        /// 
        /// In some cases people want simple custom control over the username/password check, for simplicity
        /// sake, developers would like the users to simply validate against an LDAP directory but the user
        /// data remains stored inside of Umbraco. 
        /// See: http://issues.umbraco.org/issue/U4-7032 for the use cases.
        /// 
        /// We&#39;ve allowed this check to be overridden with a simple callback so that developers don&#39;t actually
        /// have to implement/override this class.
        /// &lt;/remarks&gt;
        public override async Task&lt;bool&gt; CheckPasswordAsync(T user, string password)
        {
            if (BackOfficeUserPasswordChecker != null)
            {
                var result = await BackOfficeUserPasswordChecker.CheckPasswordAsync(user, password);
                //if the result indicates to not fallback to the default, then return true if the credentials are valid
                if (result != BackOfficeUserPasswordCheckerResult.FallbackToDefaultChecker)
                {
                    return result == BackOfficeUserPasswordCheckerResult.ValidCredentials;
                }
            }
            //use the default behavior
            return await base.CheckPasswordAsync(user, password);
        }

        /// &lt;summary&gt;
        /// Gets/sets the default back office user password checker
        /// &lt;/summary&gt;
        public IBackOfficeUserPasswordChecker BackOfficeUserPasswordChecker { get; set; }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,15,22,26,0],[23,9,23,10,0],[24,9,24,10,0],[30,15,30,26,0],[31,9,31,10,0],[32,13,32,33,0],[32,34,32,77,0],[32,77,32,78,0],[33,13,33,64,0],[34,9,34,10,0],[50,9,50,10,0],[51,13,51,33,0],[51,34,51,77,0],[52,13,52,37,0],[52,38,52,85,0],[53,13,53,46,0],[53,47,53,103,0],[55,13,55,133,0],[56,13,56,75,0],[57,13,57,28,0],[58,9,58,10,0],[71,9,71,10,0],[72,13,72,99,0],[73,13,73,28,0],[74,9,74,10,0],[88,9,88,10,0],[90,13,90,95,0],[91,9,91,10,0],[102,15,102,26,0],[103,9,103,10,0],[104,9,104,10,0],[111,17,111,18,0],[111,19,111,32,0],[111,33,111,34,0],[117,17,117,18,0],[117,19,117,32,0],[117,33,117,34,0],[125,17,125,18,0],[125,19,125,32,0],[125,33,125,34,0],[131,17,131,18,0],[131,19,131,32,0],[131,33,131,34,0],[146,9,146,10,0],[148,13,152,15,0],[155,13,163,15,0],[166,13,166,87,0],[168,13,168,48,0],[169,13,169,14,0],[170,17,170,135,0],[171,13,171,14,0],[173,13,173,56,0],[174,13,174,106,0],[178,13,178,75,0],[181,13,181,86,0],[183,13,183,55,0],[200,9,200,10,0],[223,9,223,10,0],[224,13,224,55,0],[225,13,225,14,0],[226,17,226,101,0],[228,17,228,92,0],[229,17,229,18,0],[230,21,230,91,0],[232,13,232,14,0],[234,13,234,66,0],[235,9,235,10,0],[240,79,240,83,0],[240,84,240,88,0]]);
    </script>
  </body>
</html>