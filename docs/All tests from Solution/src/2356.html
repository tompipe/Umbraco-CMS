<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\UmbracoExamine\LocalStorage\LocalTempStorageDirectory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Linq;
using Lucene.Net.Store;
using Directory = Lucene.Net.Store.Directory;

namespace UmbracoExamine.LocalStorage
{
    /// &lt;summary&gt;
    /// Used to read data from local temp storage and write to both local storage and main storage
    /// &lt;/summary&gt;    
    public class LocalTempStorageDirectory : Directory
    {
        private readonly FSDirectory _tempStorageDir;
        private readonly FSDirectory _realDirectory;
        private LockFactory _lockFactory;

        public LocalTempStorageDirectory(
            DirectoryInfo tempStorageDir,
            FSDirectory realDirectory)
        {
            if (tempStorageDir == null) throw new ArgumentNullException(&quot;tempStorageDir&quot;);
            if (realDirectory == null) throw new ArgumentNullException(&quot;realDirectory&quot;);

            _tempStorageDir = new SimpleFSDirectory(tempStorageDir);
            _realDirectory = realDirectory;
            _lockFactory = new MultiIndexLockFactory(_realDirectory, _tempStorageDir);
            
            Enabled = true;

        }
        
        /// &lt;summary&gt;
        /// If initialization fails, it will be disabled and then this will just wrap the &#39;real directory&#39;
        /// &lt;/summary&gt;
        internal bool Enabled { get; set; }

        [Obsolete(&quot;this is deprecated&quot;)]
        public override string[] List()
        {
            return _realDirectory.List();
        }

        public override string[] ListAll()
        {
            //always from the real dir
            return _realDirectory.ListAll();
        }

        /// &lt;summary&gt;Returns true if a file with the given name exists. &lt;/summary&gt;
        public override bool FileExists(string name)
        {
            //always from the real dir
            return _realDirectory.FileExists(name);
        }

        /// &lt;summary&gt;Returns the time the named file was last modified. &lt;/summary&gt;
        public override long FileModified(string name)
        {
            //always from the real dir
            return _realDirectory.FileModified(name);
        }

        /// &lt;summary&gt;Set the modified time of an existing file to now. &lt;/summary&gt;
        public override void TouchFile(string name)
        {
            //always from the real dir
            _realDirectory.TouchFile(name);

            //perform on both dirs
            if (Enabled)
            {
                _tempStorageDir.TouchFile(name);
            }
        }

        /// &lt;summary&gt;Removes an existing file in the directory. &lt;/summary&gt;
        public override void DeleteFile(string name)
        {   
            _realDirectory.DeleteFile(name);

            //perform on both dirs
            if (Enabled)
            {
                _tempStorageDir.DeleteFile(name);
            }
        }
    
        [Obsolete(&quot;This is deprecated&quot;)]
        public override void RenameFile(string @from, string to)
        {
            _realDirectory.RenameFile(@from, to);

            //perform on both dirs
            if (Enabled)
            {
                _tempStorageDir.RenameFile(@from, to);
            }
        }

        /// &lt;summary&gt;Returns the length of a file in the directory. &lt;/summary&gt;
        public override long FileLength(string name)
        {
            //always from the real dir
            return _realDirectory.FileLength(name);
        }

        /// &lt;summary&gt;
        /// Creates a new, empty file in the directory with the given name.
        /// Returns a stream writing this file. 
        /// &lt;/summary&gt;
        public override IndexOutput CreateOutput(string name)
        {
            //write to both indexes
            if (Enabled)
            {
                return new MultiIndexOutput(
                    _tempStorageDir.CreateOutput(name),
                    _realDirectory.CreateOutput(name));    
            }

            return _realDirectory.CreateOutput(name);
        }

        /// &lt;summary&gt;
        /// Returns a stream reading an existing file.
        /// &lt;/summary&gt;
        public override IndexInput OpenInput(string name)
        {
            if (Enabled)
            {
                //return the reader from the cache, not the real dir
                return _tempStorageDir.OpenInput(name);    
            }

            return _realDirectory.OpenInput(name);
        }

        /// &lt;summary&gt;
        /// Creates an IndexInput for the file with the given name. 
        /// &lt;/summary&gt;
        public override IndexInput OpenInput(string name, int bufferSize)
        {
            if (Enabled)
            {
                //return the reader from the cache, not the real dir
                return _tempStorageDir.OpenInput(name, bufferSize);
            }
            return _realDirectory.OpenInput(name, bufferSize);
        }
        
        /// &lt;summary&gt;
        /// Ensure that any writes to this file are moved to
        ///             stable storage.  Lucene uses this to properly commit
        ///             changes to the index, to prevent a machine/OS crash
        ///             from corrupting the index. 
        /// &lt;/summary&gt;
        public override void Sync(string name)
        {
            _realDirectory.Sync(name);
            _tempStorageDir.Sync(name);
            base.Sync(name);
        }

        public override void Close()
        {
            if (Enabled)
            {
                _tempStorageDir.Close();
            }
            _realDirectory.Close();
        }

        public override Lock MakeLock(string name)
        {
            return _lockFactory.MakeLock(name);
        }

        /// &lt;summary&gt;
        /// Return a string identifier that uniquely differentiates
        ///             this Directory instance from other Directory instances.
        ///             This ID should be the same if two Directory instances
        ///             (even in different JVMs and/or on different machines)
        ///             are considered &quot;the same index&quot;.  This is how locking
        ///             &quot;scopes&quot; to the right index.
        /// 
        /// &lt;/summary&gt;
        public override string GetLockID()
        {
            return string.Concat(_realDirectory.GetLockID(), _tempStorageDir.GetLockID());
        }

        public override LockFactory GetLockFactory()
        {
            return _lockFactory;
            //return _realDirectory.GetLockFactory();
        }

        public override void ClearLock(string name)
        {
            _lockFactory.ClearLock(name);

            //_realDirectory.ClearLock(name);

            //if (Enabled)
            //{
            //    _tempStorageDir.ClearLock(name);
            //}
        }

        public override void SetLockFactory(LockFactory lf)
        {
            _lockFactory = lf;
            //_realDirectory.SetLockFactory(lf);
        }

        public override void Dispose()
        {
            if (Enabled)
            {
                _tempStorageDir.Dispose();    
            }
            _realDirectory.Dispose();
        }


    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,20,39,0],[21,9,21,10,0],[22,13,22,40,0],[22,41,22,91,0],[23,13,23,39,0],[23,40,23,89,0],[25,13,25,69,0],[26,13,26,44,0],[27,13,27,87,0],[29,13,29,28,0],[31,9,31,10,0],[36,33,36,37,0],[36,38,36,42,0],[40,9,40,10,0],[41,13,41,42,0],[42,9,42,10,0],[45,9,45,10,0],[47,13,47,45,0],[48,9,48,10,0],[52,9,52,10,0],[54,13,54,52,0],[55,9,55,10,0],[59,9,59,10,0],[61,13,61,54,0],[62,9,62,10,0],[66,9,66,10,0],[68,13,68,44,0],[71,13,71,25,0],[72,13,72,14,0],[73,17,73,49,0],[74,13,74,14,0],[75,9,75,10,0],[79,9,79,10,0],[80,13,80,45,0],[83,13,83,25,0],[84,13,84,14,0],[85,17,85,50,0],[86,13,86,14,0],[87,9,87,10,0],[91,9,91,10,0],[92,13,92,50,0],[95,13,95,25,0],[96,13,96,14,0],[97,17,97,55,0],[98,13,98,14,0],[99,9,99,10,0],[103,9,103,10,0],[105,13,105,52,0],[106,9,106,10,0],[113,9,113,10,0],[115,13,115,25,0],[116,13,116,14,0],[117,17,119,56,0],[122,13,122,54,0],[123,9,123,10,0],[129,9,129,10,0],[130,13,130,25,0],[131,13,131,14,0],[133,17,133,56,0],[136,13,136,51,0],[137,9,137,10,0],[143,9,143,10,0],[144,13,144,25,0],[145,13,145,14,0],[147,17,147,68,0],[149,13,149,63,0],[150,9,150,10,0],[159,9,159,10,0],[160,13,160,39,0],[161,13,161,40,0],[162,13,162,29,0],[163,9,163,10,0],[166,9,166,10,0],[167,13,167,25,0],[168,13,168,14,0],[169,17,169,41,0],[170,13,170,14,0],[171,13,171,36,0],[172,9,172,10,0],[175,9,175,10,0],[176,13,176,48,0],[177,9,177,10,0],[189,9,189,10,0],[190,13,190,91,0],[191,9,191,10,0],[194,9,194,10,0],[195,13,195,33,0],[197,9,197,10,0],[200,9,200,10,0],[201,13,201,42,0],[209,9,209,10,0],[212,9,212,10,0],[213,13,213,31,0],[215,9,215,10,0],[218,9,218,10,0],[219,13,219,25,0],[220,13,220,14,0],[221,17,221,43,0],[222,13,222,14,0],[223,13,223,38,0],[224,9,224,10,0]]);
    </script>
  </body>
</html>