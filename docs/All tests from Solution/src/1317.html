<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\AuthenticationController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Threading.Tasks;
using System.Web;
using System.Web.Http;
using System.Web.Mvc;
using AutoMapper;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.Owin;
using Microsoft.Owin;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Identity;
using Umbraco.Core.Security;
using Umbraco.Core.Services;
using Umbraco.Web.Models;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Mvc;
using Umbraco.Web.Security;
using Umbraco.Web.Security.Identity;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebApi.Filters;
using IUser = Umbraco.Core.Models.Membership.IUser;

namespace Umbraco.Web.Editors
{
    /// &lt;summary&gt;
    /// The API controller used for editing content
    /// &lt;/summary&gt;
    [PluginController(&quot;UmbracoApi&quot;)]
    [ValidationFilter]
    [AngularJsonOnlyConfiguration]
    [IsBackOffice]
    public class AuthenticationController : UmbracoApiController
    {

        private BackOfficeUserManager&lt;BackOfficeIdentityUser&gt; _userManager;
        private BackOfficeSignInManager _signInManager;
        protected BackOfficeUserManager&lt;BackOfficeIdentityUser&gt; UserManager
        {
            get { return _userManager ?? (_userManager = TryGetOwinContext().Result.GetBackOfficeUserManager()); }
        }
        protected BackOfficeSignInManager SignInManager
        {
            get { return _signInManager ?? (_signInManager = TryGetOwinContext().Result.GetBackOfficeSignInManager()); }
        }

        
        [WebApi.UmbracoAuthorize]
        [ValidateAngularAntiForgeryToken]
        public async Task&lt;HttpResponseMessage&gt; PostUnLinkLogin(UnLinkLoginModel unlinkLoginModel)
        {
            var result = await UserManager.RemoveLoginAsync(
                User.Identity.GetUserId&lt;int&gt;(),
                new UserLoginInfo(unlinkLoginModel.LoginProvider, unlinkLoginModel.ProviderKey));

            if (result.Succeeded)
            {
                var user = await UserManager.FindByIdAsync(User.Identity.GetUserId&lt;int&gt;());
                await SignInManager.SignInAsync(user, isPersistent: true, rememberBrowser: false);
                return Request.CreateResponse(HttpStatusCode.OK);
            }
            else
            {
                AddModelErrors(result);
                return Request.CreateValidationErrorResponse(ModelState);
            }
        }

        /// &lt;summary&gt;
        /// Checks if the current user&#39;s cookie is valid and if so returns OK or a 400 (BadRequest)
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [System.Web.Http.HttpGet]
        public bool IsAuthenticated()
        {
            var attempt = UmbracoContext.Security.AuthorizeRequest();
            if (attempt == ValidateRequestAttempt.Success)
            {
                return true;
            }            
            return false;
        }


        /// &lt;summary&gt;
        /// Returns the currently logged in Umbraco user
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// We have the attribute [SetAngularAntiForgeryTokens] applied because this method is called initially to determine if the user
        /// is valid before the login screen is displayed. The Auth cookie can be persisted for up to a day but the csrf cookies are only session
        /// cookies which means that the auth cookie could be valid but the csrf cookies are no longer there, in that case we need to re-set the csrf cookies.
        /// &lt;/remarks&gt;
        [WebApi.UmbracoAuthorize]
        [SetAngularAntiForgeryTokens]
        public UserDetail GetCurrentUser()
        {
            var user = Services.UserService.GetUserById(UmbracoContext.Security.GetUserId());
            var result = Mapper.Map&lt;UserDetail&gt;(user);
            var httpContextAttempt = TryGetHttpContext();
            if (httpContextAttempt.Success)
            {
                //set their remaining seconds
                result.SecondsUntilTimeout = httpContextAttempt.Result.GetRemainingAuthSeconds();
            }

            return result;
        }

        [WebApi.UmbracoAuthorize]
        [ValidateAngularAntiForgeryToken]
        public async Task&lt;Dictionary&lt;string, string&gt;&gt;  GetCurrentUserLinkedLogins()
        {
            var identityUser = await UserManager.FindByIdAsync(UmbracoContext.Security.GetUserId());
            return identityUser.Logins.ToDictionary(x =&gt; x.LoginProvider, x =&gt; x.ProviderKey);
        }

        /// &lt;summary&gt;
        /// Logs a user in
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [SetAngularAntiForgeryTokens]
        public async Task&lt;HttpResponseMessage&gt; PostLogin(LoginModel loginModel)
        {
            var http = EnsureHttpContext();

            var result = await SignInManager.PasswordSignInAsync(
                loginModel.Username, loginModel.Password, isPersistent: true, shouldLockout: true);

            switch (result)
            {
                case SignInStatus.Success:

                    //get the user
                    var user = Security.GetBackOfficeUser(loginModel.Username);
                    var userDetail = Mapper.Map&lt;UserDetail&gt;(user);
                    //update the userDetail and set their remaining seconds
                    userDetail.SecondsUntilTimeout = TimeSpan.FromMinutes(GlobalSettings.TimeOutInMinutes).TotalSeconds;
                    
                    //create a response with the userDetail object
                    var response = Request.CreateResponse(HttpStatusCode.OK, userDetail);

                    //ensure the user is set for the current request
                    Request.SetPrincipalForRequest(user);

                    return response;

                case SignInStatus.RequiresVerification:

                    var twofactorOptions = UserManager as IUmbracoBackOfficeTwoFactorOptions;
                    if (twofactorOptions == null)
                    {
                        throw new HttpResponseException(
                            Request.CreateErrorResponse(
                                HttpStatusCode.BadRequest, 
                                &quot;UserManager does not implement &quot; + typeof(IUmbracoBackOfficeTwoFactorOptions)));
                    }

                    var twofactorView = twofactorOptions.GetTwoFactorView(
                        TryGetOwinContext().Result,
                        UmbracoContext,
                        loginModel.Username);

                    if (twofactorView.IsNullOrWhiteSpace())
                    {
                        throw new HttpResponseException(
                            Request.CreateErrorResponse(
                                HttpStatusCode.BadRequest,
                                typeof(IUmbracoBackOfficeTwoFactorOptions) + &quot;.GetTwoFactorView returned an empty string&quot;));
                    }

                    //create a with information to display a custom two factor send code view
                    var verifyResponse = Request.CreateResponse(HttpStatusCode.OK, new
                    {
                        twoFactorView = twofactorView
                    });

                    return verifyResponse;

                case SignInStatus.LockedOut:
                case SignInStatus.Failure:
                default:
                    //return BadRequest (400), we don&#39;t want to return a 401 because that get&#39;s intercepted 
                    // by our angular helper because it thinks that we need to re-perform the request once we are
                    // authorized and we don&#39;t want to return a 403 because angular will show a warning msg indicating 
                    // that the user doesn&#39;t have access to perform this function, we just want to return a normal invalid msg.            
                    throw new HttpResponseException(HttpStatusCode.BadRequest);
            }
        }

        /// &lt;summary&gt;
        /// Processes a password reset request.  Looks for a match on the provided email address
        /// and if found sends an email with a link to reset it
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [SetAngularAntiForgeryTokens]
        public async Task&lt;HttpResponseMessage&gt; PostRequestPasswordReset(RequestPasswordResetModel model)
        {
            // If this feature is switched off in configuration the UI will be amended to not make the request to reset password available.
            // So this is just a server-side secondary check.
            if (UmbracoConfig.For.UmbracoSettings().Security.AllowPasswordReset == false)
            {
                throw new HttpResponseException(HttpStatusCode.BadRequest);
            }
            var identityUser = await SignInManager.UserManager.FindByEmailAsync(model.Email);
            if (identityUser != null)
            {
                var user = Services.UserService.GetByEmail(model.Email);
                if (user != null &amp;&amp; user.IsLockedOut == false)
                {
                    var code = await UserManager.GeneratePasswordResetTokenAsync(identityUser.Id);
                    var callbackUrl = ConstructCallbackUrl(identityUser.Id, code);

                    var message = Services.TextService.Localize(&quot;resetPasswordEmailCopyFormat&quot;,
                        //Ensure the culture of the found user is used for the email!
                        UserExtensions.GetUserCulture(identityUser.Culture, Services.TextService),
                        new[] {identityUser.UserName, callbackUrl});

                    await UserManager.SendEmailAsync(identityUser.Id,
                        Services.TextService.Localize(&quot;login/resetPasswordEmailCopySubject&quot;,
                            //Ensure the culture of the found user is used for the email!
                            UserExtensions.GetUserCulture(identityUser.Culture, Services.TextService)),
                        message);
                }
            }

            return Request.CreateResponse(HttpStatusCode.OK);
        }

        private string ConstructCallbackUrl(int userId, string code)
        {
            // Get an mvc helper to get the url
            var http = EnsureHttpContext();
            var urlHelper = new UrlHelper(http.Request.RequestContext);
            var action = urlHelper.Action(&quot;ValidatePasswordResetCode&quot;, &quot;BackOffice&quot;, 
                new
                {
                    area = GlobalSettings.UmbracoMvcArea,
                    u = userId,
                    r = code
                });

            // Construct full URL using configured application URL (which will fall back to request)
            var applicationUri = new Uri(ApplicationContext.UmbracoApplicationUrl);
            var callbackUri = new Uri(applicationUri, action);
            return callbackUri.ToString();
        }      
     
        /// &lt;summary&gt;
        /// Processes a set password request.  Validates the request and sets a new password.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [SetAngularAntiForgeryTokens]
        public async Task&lt;HttpResponseMessage&gt; PostSetPassword(SetPasswordModel model)
        {
            var result = await UserManager.ResetPasswordAsync(model.UserId, model.ResetCode, model.Password);
            if (result.Succeeded)
            {
                return Request.CreateResponse(HttpStatusCode.OK);
            }

            return Request.CreateValidationErrorResponse(
                result.Errors.Any() ? result.Errors.First() : &quot;Set password failed&quot;);
        }

        private HttpContextBase EnsureHttpContext()
        {
            var attempt = this.TryGetHttpContext();
            if (attempt.Success == false)
                throw new InvalidOperationException(&quot;This method requires that an HttpContext be active&quot;);
            return attempt.Result;
        }

        /// &lt;summary&gt;
        /// Logs the current user out
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [ClearAngularAntiForgeryToken]
        [ValidateAngularAntiForgeryToken]
        public HttpResponseMessage PostLogout()
        {
            Request.TryGetOwinContext().Result.Authentication.SignOut(
                Core.Constants.Security.BackOfficeAuthenticationType,
                Core.Constants.Security.BackOfficeExternalAuthenticationType);

            Logger.Info&lt;AuthenticationController&gt;(&quot;User {0} from IP address {1} has logged out&quot;,
                            () =&gt; User.Identity == null ? &quot;UNKNOWN&quot; : User.Identity.Name,
                            () =&gt; TryGetOwinContext().Result.Request.RemoteIpAddress);

            return Request.CreateResponse(HttpStatusCode.OK);
        }

        private void AddModelErrors(IdentityResult result, string prefix = &quot;&quot;)
        {
            foreach (var error in result.Errors)
            {
                ModelState.AddModelError(prefix, error);
            }
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[46,17,46,18,0],[46,19,46,113,0],[46,114,46,115,0],[50,17,50,18,0],[50,19,50,119,0],[50,120,50,121,0],[57,9,57,10,0],[58,13,60,98,0],[62,13,62,34,0],[63,13,63,14,0],[64,17,64,92,0],[65,17,65,99,0],[66,17,66,66,0],[69,13,69,14,0],[70,17,70,40,0],[71,17,71,74,0],[73,9,73,10,0],[81,9,81,10,0],[82,13,82,70,0],[83,13,83,59,0],[84,13,84,14,0],[85,17,85,29,0],[87,13,87,26,0],[88,9,88,10,0],[103,9,103,10,0],[104,13,104,94,0],[105,13,105,55,0],[106,13,106,58,0],[107,13,107,44,0],[108,13,108,14,0],[110,17,110,98,0],[111,13,111,14,0],[113,13,113,27,0],[114,9,114,10,0],[119,9,119,10,0],[120,13,120,101,0],[121,13,121,58,0],[121,58,121,73,0],[121,73,121,80,0],[121,80,121,93,0],[121,93,121,95,0],[121,13,121,95,0],[122,9,122,10,0],[130,9,130,10,0],[131,13,131,44,0],[133,13,134,100,0],[136,13,136,28,0],[141,21,141,80,0],[142,21,142,67,0],[144,21,144,121,0],[147,21,147,90,0],[150,21,150,58,0],[152,21,152,37,0],[156,21,156,94,0],[157,21,157,50,0],[158,21,158,22,0],[159,25,162,114,0],[165,21,168,46,0],[170,21,170,60,0],[171,21,171,22,0],[172,25,175,125,0],[179,21,182,24,0],[184,21,184,43,0],[193,21,193,80,0],[195,9,195,10,0],[204,9,204,10,0],[207,13,207,90,0],[208,13,208,14,0],[209,17,209,76,0],[211,13,211,94,0],[212,13,212,38,0],[213,13,213,14,0],[214,17,214,73,0],[215,17,215,63,0],[216,17,216,18,0],[217,21,217,99,0],[218,21,218,83,0],[220,21,223,69,0],[225,21,229,34,0],[230,17,230,18,0],[231,13,231,14,0],[233,13,233,62,0],[234,9,234,10,0],[237,9,237,10,0],[239,13,239,44,0],[240,13,240,72,0],[241,13,247,20,0],[250,13,250,84,0],[251,13,251,63,0],[252,13,252,43,0],[253,9,253,10,0],[261,9,261,10,0],[262,13,262,110,0],[263,13,263,34,0],[264,13,264,14,0],[265,17,265,66,0],[268,13,269,86,0],[270,9,270,10,0],[273,9,273,10,0],[274,13,274,52,0],[275,13,275,42,0],[276,17,276,107,0],[277,13,277,35,0],[278,9,278,10,0],[287,9,287,10,0],[288,13,290,79,0],[292,13,293,35,0],[293,35,293,89,0],[293,89,294,35,0],[294,35,294,85,0],[294,85,294,87,0],[292,13,294,87,0],[296,13,296,62,0],[297,9,297,10,0],[300,9,300,10,0],[301,13,301,20,0],[301,22,301,31,0],[301,32,301,34,0],[301,35,301,48,0],[302,13,302,14,0],[303,17,303,57,0],[304,13,304,14,0],[305,9,305,10,0]]);
    </script>
  </body>
</html>