<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\DictionaryRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;

using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class DictionaryRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            CreateTestData();
        }

        private DictionaryRepository CreateRepository(IDatabaseUnitOfWork unitOfWork)
        {
            var dictionaryRepository = new DictionaryRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider());
            return dictionaryRepository;
        }


        [Test]
        public void Can_Perform_Get_By_Key_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();

            using (var repository = CreateRepository(unitOfWork))
            {
                var dictionaryItem = (IDictionaryItem)new DictionaryItem(&quot;Testing1235&quot;)
                {
                    Translations = new List&lt;IDictionaryTranslation&gt;
                    {
                        new DictionaryTranslation(ServiceContext.LocalizationService.GetLanguageByCultureCode(&quot;en-US&quot;), &quot;Hello world&quot;)
                    }
                };

                repository.AddOrUpdate(dictionaryItem);
                unitOfWork.Commit();

                //re-get
                dictionaryItem = repository.Get(&quot;Testing1235&quot;);

                // Assert
                Assert.That(dictionaryItem, Is.Not.Null);
                Assert.That(dictionaryItem.ItemKey, Is.EqualTo(&quot;Testing1235&quot;));
                Assert.That(dictionaryItem.Translations.Any(), Is.True);
                Assert.That(dictionaryItem.Translations.Any(x =&gt; x == null), Is.False);
                Assert.That(dictionaryItem.Translations.First().Value, Is.EqualTo(&quot;Hello world&quot;));
            }

        }

        [Test]
        public void Can_Perform_Get_By_UniqueId_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();

            using (var repository = CreateRepository(unitOfWork))
            {
                var dictionaryItem = (IDictionaryItem)new DictionaryItem(&quot;Testing1235&quot;)
                {
                    Translations = new List&lt;IDictionaryTranslation&gt;
                    {
                        new DictionaryTranslation(ServiceContext.LocalizationService.GetLanguageByCultureCode(&quot;en-US&quot;), &quot;Hello world&quot;)
                    }
                };

                repository.AddOrUpdate(dictionaryItem);
                unitOfWork.Commit();

                //re-get
                dictionaryItem = repository.Get(dictionaryItem.Key);

                // Assert
                Assert.That(dictionaryItem, Is.Not.Null);
                Assert.That(dictionaryItem.ItemKey, Is.EqualTo(&quot;Testing1235&quot;));
                Assert.That(dictionaryItem.Translations.Any(), Is.True);
                Assert.That(dictionaryItem.Translations.Any(x =&gt; x == null), Is.False);
                Assert.That(dictionaryItem.Translations.First().Value, Is.EqualTo(&quot;Hello world&quot;));
            }

        }

        [Test]
        public void Can_Perform_Get_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();

            using (var repository = CreateRepository(unitOfWork))
            {
                var dictionaryItem = (IDictionaryItem)new DictionaryItem(&quot;Testing1235&quot;)
                {
                    Translations = new List&lt;IDictionaryTranslation&gt;
                    {
                        new DictionaryTranslation(ServiceContext.LocalizationService.GetLanguageByCultureCode(&quot;en-US&quot;), &quot;Hello world&quot;)
                    }
                };

                repository.AddOrUpdate(dictionaryItem);
                unitOfWork.Commit();

                //re-get
                dictionaryItem = repository.Get(dictionaryItem.Id);
               

                // Assert
                Assert.That(dictionaryItem, Is.Not.Null);
                Assert.That(dictionaryItem.ItemKey, Is.EqualTo(&quot;Testing1235&quot;));
                Assert.That(dictionaryItem.Translations.Any(), Is.True);
                Assert.That(dictionaryItem.Translations.Any(x =&gt; x == null), Is.False);
                Assert.That(dictionaryItem.Translations.First().Value, Is.EqualTo(&quot;Hello world&quot;));
            }

        }

        [Test]
        public void Can_Perform_Get_On_DictionaryRepository_When_No_Language_Assigned()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            
            using (var repository = CreateRepository(unitOfWork))
            {
                var dictionaryItem = (IDictionaryItem) new DictionaryItem(&quot;Testing1235&quot;);                

                repository.AddOrUpdate(dictionaryItem);
                unitOfWork.Commit();

                //re-get
                dictionaryItem = repository.Get(dictionaryItem.Id);


                // Assert
                Assert.That(dictionaryItem, Is.Not.Null);
                Assert.That(dictionaryItem.ItemKey, Is.EqualTo(&quot;Testing1235&quot;));
                Assert.That(dictionaryItem.Translations.Any(), Is.False);
            }

        }


        [Test]
        public void Can_Perform_GetAll_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var dictionaryItem = repository.Get(1);
                var dictionaryItems = repository.GetAll();

                // Assert
                Assert.That(dictionaryItems, Is.Not.Null);
                Assert.That(dictionaryItems.Any(), Is.True);
                Assert.That(dictionaryItems.Any(x =&gt; x == null), Is.False);
                Assert.That(dictionaryItems.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_GetAll_With_Params_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var dictionaryItems = repository.GetAll(1, 2);

                // Assert
                Assert.That(dictionaryItems, Is.Not.Null);
                Assert.That(dictionaryItems.Any(), Is.True);
                Assert.That(dictionaryItems.Any(x =&gt; x == null), Is.False);
                Assert.That(dictionaryItems.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_GetByQuery_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var query = Query&lt;IDictionaryItem&gt;.Builder.Where(x =&gt; x.ItemKey == &quot;Article&quot;);
                var result = repository.GetByQuery(query);

                // Assert
                Assert.That(result, Is.Not.Null);
                Assert.That(result.Any(), Is.True);
                Assert.That(result.FirstOrDefault().ItemKey, Is.EqualTo(&quot;Article&quot;));
            }
        }

        [Test]
        public void Can_Perform_Count_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var query = Query&lt;IDictionaryItem&gt;.Builder.Where(x =&gt; x.ItemKey.StartsWith(&quot;Read&quot;));
                var result = repository.Count(query);

                // Assert
                Assert.That(result, Is.EqualTo(1));
            }
        }

        [Test]
        public void Can_Perform_Add_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var languageRepository = new LanguageRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax))
            using (var repository = CreateRepository(unitOfWork))
            {

                var language = languageRepository.Get(1);

                var read = new DictionaryItem(&quot;Read&quot;);
                var translations = new List&lt;IDictionaryTranslation&gt;
                    {
                        new DictionaryTranslation(language, &quot;Read&quot;)
                    };
                read.Translations = translations;

                // Act
                repository.AddOrUpdate(read);
                unitOfWork.Commit();

                var exists = repository.Exists(read.Id);

                // Assert
                Assert.That(read.HasIdentity, Is.True);
                Assert.That(exists, Is.True);
            }
        }

        [Test]
        public void Can_Perform_Update_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var item = repository.Get(1);
                var translations = item.Translations.ToList();
                translations[0].Value = &quot;Read even more&quot;;
                item.Translations = translations;

                repository.AddOrUpdate(item);
                unitOfWork.Commit();

                var dictionaryItem = repository.Get(1);

                // Assert
                Assert.That(dictionaryItem, Is.Not.Null);
                Assert.That(dictionaryItem.Translations.Count(), Is.EqualTo(2));
                Assert.That(dictionaryItem.Translations.FirstOrDefault().Value, Is.EqualTo(&quot;Read even more&quot;));
            }
        }

        [Test]
        public void Can_Perform_Update_WithNewTranslation_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new DictionaryRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider());

            var languageNo = new Language(&quot;nb-NO&quot;) { CultureName = &quot;nb-NO&quot; };
            ServiceContext.LocalizationService.Save(languageNo);

            // Act
            var item = repository.Get(1);
            var translations = item.Translations.ToList();
            translations.Add(new DictionaryTranslation(languageNo, &quot;Les mer&quot;));
            item.Translations = translations;

            repository.AddOrUpdate(item);
            unitOfWork.Commit();

            var dictionaryItem = (DictionaryItem)repository.Get(1);
            
            // Assert
            Assert.That(dictionaryItem, Is.Not.Null);
            Assert.That(dictionaryItem.Translations.Count(), Is.EqualTo(3));
            Assert.That(dictionaryItem.Translations.Single(t =&gt; t.LanguageId == languageNo.Id).Value, Is.EqualTo(&quot;Les mer&quot;));
        }

        [Test]
        public void Can_Perform_Delete_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var item = repository.Get(1);
                repository.Delete(item);
                unitOfWork.Commit();

                var exists = repository.Exists(1);

                // Assert
                Assert.That(exists, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Exists_On_DictionaryRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var exists = repository.Exists(1);

                // Assert
                Assert.That(exists, Is.True);
            }
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        public void CreateTestData()
        {
            var language = ServiceContext.LocalizationService.GetLanguageByCultureCode(&quot;en-US&quot;);

            var languageDK = new Language(&quot;da-DK&quot;) { CultureName = &quot;da-DK&quot; };
            ServiceContext.LocalizationService.Save(languageDK);//Id 2

            var readMore = new DictionaryItem(&quot;Read More&quot;);
            var translations = new List&lt;IDictionaryTranslation&gt;
                                   {
                                       new DictionaryTranslation(language, &quot;Read More&quot;),
                                       new DictionaryTranslation(languageDK, &quot;L&#230;s mere&quot;)
                                   };
            readMore.Translations = translations;
            ServiceContext.LocalizationService.Save(readMore);//Id 1

            var article = new DictionaryItem(&quot;Article&quot;);
            var translations2 = new List&lt;IDictionaryTranslation&gt;
                                   {
                                       new DictionaryTranslation(language, &quot;Article&quot;),
                                       new DictionaryTranslation(languageDK, &quot;Artikel&quot;)
                                   };
            article.Translations = translations2;
            ServiceContext.LocalizationService.Save(article);//Id 2
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,1],[25,13,25,31,1],[27,13,27,30,1],[28,9,28,10,1],[31,9,31,10,1],[32,13,32,165,1],[33,13,33,41,1],[34,9,34,10,1],[39,9,39,10,1],[41,13,41,67,1],[42,13,42,55,1],[44,20,44,65,1],[45,13,45,14,1],[46,17,52,19,1],[54,17,54,56,1],[55,17,55,37,1],[58,17,58,64,1],[61,17,61,58,1],[62,17,62,80,1],[63,17,63,73,1],[64,17,64,66,1],[64,66,64,75,1],[64,75,64,88,1],[64,17,64,88,1],[65,17,65,99,1],[66,13,66,14,1],[68,9,68,10,1],[72,9,72,10,1],[74,13,74,67,1],[75,13,75,55,1],[77,20,77,65,1],[78,13,78,14,1],[79,17,85,19,1],[87,17,87,56,1],[88,17,88,37,1],[91,17,91,69,1],[94,17,94,58,1],[95,17,95,80,1],[96,17,96,73,1],[97,17,97,66,1],[97,66,97,75,1],[97,75,97,88,1],[97,17,97,88,1],[98,17,98,99,1],[99,13,99,14,1],[101,9,101,10,1],[105,9,105,10,1],[107,13,107,67,1],[108,13,108,55,1],[110,20,110,65,1],[111,13,111,14,1],[112,17,118,19,1],[120,17,120,56,1],[121,17,121,37,1],[124,17,124,68,1],[128,17,128,58,1],[129,17,129,80,1],[130,17,130,73,1],[131,17,131,66,1],[131,66,131,75,1],[131,75,131,88,1],[131,17,131,88,1],[132,17,132,99,1],[133,13,133,14,1],[135,9,135,10,1],[139,9,139,10,1],[141,13,141,67,1],[142,13,142,55,1],[144,20,144,65,1],[145,13,145,14,1],[146,17,146,90,1],[148,17,148,56,1],[149,17,149,37,1],[152,17,152,68,1],[156,17,156,58,1],[157,17,157,80,1],[158,17,158,74,1],[159,13,159,14,1],[161,9,161,10,1],[166,9,166,10,1],[168,13,168,67,1],[169,13,169,55,1],[170,20,170,65,1],[171,13,171,14,1],[174,17,174,56,1],[175,17,175,59,1],[178,17,178,59,1],[179,17,179,61,1],[180,17,180,54,1],[180,54,180,63,1],[180,63,180,76,1],[180,17,180,76,1],[181,17,181,69,1],[182,13,182,14,1],[183,9,183,10,1],[187,9,187,10,1],[189,13,189,67,1],[190,13,190,55,1],[191,20,191,65,1],[192,13,192,14,1],[195,17,195,63,1],[198,17,198,59,1],[199,17,199,61,1],[200,17,200,54,1],[200,54,200,63,1],[200,63,200,76,1],[200,17,200,76,1],[201,17,201,69,1],[202,13,202,14,1],[203,9,203,10,1],[207,9,207,10,1],[209,13,209,67,1],[210,13,210,55,1],[211,20,211,65,1],[212,13,212,14,1],[215,17,215,95,1],[216,17,216,59,1],[219,17,219,50,1],[220,17,220,52,1],[221,17,221,85,1],[222,13,222,14,1],[223,9,223,10,1],[227,9,227,10,1],[229,13,229,67,1],[230,13,230,55,1],[231,20,231,65,1],[232,13,232,14,1],[235,17,235,101,1],[236,17,236,54,1],[239,17,239,52,1],[240,13,240,14,1],[241,9,241,10,1],[245,9,245,10,1],[247,13,247,67,1],[248,13,248,55,1],[249,20,249,151,1],[250,20,250,65,1],[251,13,251,14,1],[253,17,253,58,1],[255,17,255,55,1],[256,17,259,23,1],[260,17,260,50,1],[263,17,263,46,1],[264,17,264,37,1],[266,17,266,57,1],[269,17,269,56,1],[270,17,270,46,1],[271,13,271,14,1],[272,9,272,10,1],[276,9,276,10,1],[278,13,278,67,1],[279,13,279,55,1],[280,20,280,65,1],[281,13,281,14,1],[284,17,284,46,1],[285,17,285,63,1],[286,17,286,58,1],[287,17,287,50,1],[289,17,289,46,1],[290,17,290,37,1],[292,17,292,56,1],[295,17,295,58,1],[296,17,296,81,1],[297,17,297,111,1],[298,13,298,14,1],[299,9,299,10,1],[303,9,303,10,1],[305,13,305,67,1],[306,13,306,55,1],[307,13,307,155,1],[309,13,309,78,1],[310,13,310,65,1],[313,13,313,42,1],[314,13,314,59,1],[315,13,315,80,1],[316,13,316,46,1],[318,13,318,42,1],[319,13,319,33,1],[321,13,321,68,1],[324,13,324,54,1],[325,13,325,77,1],[326,13,326,65,1],[326,65,326,94,1],[326,94,326,126,1],[326,13,326,126,1],[327,9,327,10,1],[331,9,331,10,1],[333,13,333,67,1],[334,13,334,55,1],[335,20,335,65,1],[336,13,336,14,1],[339,17,339,46,1],[340,17,340,41,1],[341,17,341,37,1],[343,17,343,51,1],[346,17,346,47,1],[347,13,347,14,1],[348,9,348,10,1],[352,9,352,10,1],[354,13,354,67,1],[355,13,355,55,1],[356,20,356,65,1],[357,13,357,14,1],[360,17,360,51,1],[363,17,363,46,1],[364,13,364,14,1],[365,9,365,10,1],[369,9,369,10,1],[370,13,370,29,1],[371,9,371,10,1],[374,9,374,10,1],[375,13,375,97,1],[377,13,377,78,1],[378,13,378,65,1],[380,13,380,60,1],[381,13,385,38,1],[386,13,386,50,1],[387,13,387,63,1],[389,13,389,57,1],[390,13,394,38,1],[395,13,395,50,1],[396,13,396,62,1],[397,9,397,10,1]]);
    </script>
  </body>
</html>