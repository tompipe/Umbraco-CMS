<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\TestHelpers\BaseUmbracoApplicationTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Reflection;
using AutoMapper;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Mapping;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Core.Profiling;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Publishing;
using Umbraco.Core.Services;
using Umbraco.Web;
using Umbraco.Web.Models.Mapping;
using umbraco.BusinessLogic;
using Umbraco.Core.Events;

namespace Umbraco.Tests.TestHelpers
{
    /// &lt;summary&gt;
    /// Provides a base class for Umbraco application tests.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;Sets logging, pluging manager, application context, base resolvers...&lt;/remarks&gt;
    [TestFixture]
    public abstract class BaseUmbracoApplicationTest : BaseUmbracoConfigurationTest
    {
        [TestFixtureSetUp]
        public void InitializeFixture()
        {
            var logger = new Logger(new FileInfo(TestHelper.MapPathForTest(&quot;~/unit-test-log4net.config&quot;)));
            ProfilingLogger = new ProfilingLogger(logger, new LogProfiler(logger));
        }

        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            TestHelper.InitializeContentDirectories();

            SetupCacheHelper();

            InitializeLegacyMappingsForCoreEditors();

            SetupPluginManager();

            SetupApplicationContext();

            InitializeMappers();

            FreezeResolution();

        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
            
            // reset settings
            SettingsForTests.Reset();
            UmbracoContext.Current = null;
            TestHelper.CleanContentDirectories();
            TestHelper.CleanUmbracoSettingsConfig();

            // reset the app context, this should reset most things that require resetting like ALL resolvers
            ApplicationContext.Current.DisposeIfDisposable();
            ApplicationContext.Current = null;

            // reset plugin manager
            ResetPluginManager();
        }

        private static readonly object Locker = new object();

        private static void InitializeLegacyMappingsForCoreEditors()
        {
            lock (Locker)
            {
                if (LegacyPropertyEditorIdToAliasConverter.Count() == 0)
                {
                    // create the legacy prop-eds mapping
                    LegacyPropertyEditorIdToAliasConverter.CreateMappingsForCoreEditors();
                }
            }
        }

        /// &lt;summary&gt;
        /// If this class requires auto-mapper mapping initialization then init them
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// This is an opt-in option because initializing the mappers takes about 500ms which equates to quite a lot
        /// of time with every test.
        /// &lt;/remarks&gt;
        private void InitializeMappers()
        {
            if (GetType().GetCustomAttribute&lt;RequiresAutoMapperMappingsAttribute&gt;(false) != null)
            {
                Mapper.Initialize(configuration =&gt;
                {
                    var mappers = PluginManager.Current.FindAndCreateInstances&lt;IMapperConfiguration&gt;(
                        specificAssemblies: new[]
                        {
                            typeof(ContentModelMapper).Assembly,
                            typeof(ApplicationRegistrar).Assembly
                        });
                    foreach (var mapper in mappers)
                    {
                        mapper.ConfigureMappings(configuration, ApplicationContext);
                    }
                });
            }
        }

        /// &lt;summary&gt;
        /// By default this returns false which means the plugin manager will not be reset so it doesn&#39;t need to re-scan 
        /// all of the assemblies. Inheritors can override this if plugin manager resetting is required, generally needs
        /// to be set to true if the SetupPluginManager has been overridden.
        /// &lt;/summary&gt;
        protected virtual bool PluginManagerResetRequired
        {
            get { return false; }
        }

        /// &lt;summary&gt;
        /// Inheritors can resset the plugin manager if they choose to on teardown
        /// &lt;/summary&gt;
        protected virtual void ResetPluginManager()
        {
            if (PluginManagerResetRequired)
            {
                PluginManager.Current = null;
            }
        }

        protected virtual void SetupCacheHelper()
        {
            CacheHelper = CreateCacheHelper();
        }

        protected virtual CacheHelper CreateCacheHelper()
        {
            return CacheHelper.CreateDisabledCacheHelper();
        }

        /// &lt;summary&gt;
        /// Inheritors can override this if they wish to create a custom application context
        /// &lt;/summary&gt;
        protected virtual void SetupApplicationContext()
        {
            var applicationContext = CreateApplicationContext();
            ApplicationContext.Current = applicationContext;
        }

        protected virtual ApplicationContext CreateApplicationContext()
        {
            var sqlSyntax = new SqlCeSyntaxProvider();
            var repoFactory = new RepositoryFactory(CacheHelper, Logger, sqlSyntax, SettingsForTests.GenerateMockSettings());

            var evtMsgs = new TransientMessagesFactory();
            var applicationContext = new ApplicationContext(
                //assign the db context
                new DatabaseContext(new DefaultDatabaseFactory(Core.Configuration.GlobalSettings.UmbracoConnectionName, Logger), Logger, sqlSyntax, Constants.DatabaseProviders.SqlCe),
                //assign the service context
                new ServiceContext(repoFactory, new PetaPocoUnitOfWorkProvider(Logger), new FileUnitOfWorkProvider(), new PublishingStrategy(evtMsgs, Logger), CacheHelper, Logger, evtMsgs),
                CacheHelper,
                ProfilingLogger)
            {
                IsReady = true
            };
            return applicationContext;
        }

        /// &lt;summary&gt;
        /// Inheritors can override this if they wish to setup the plugin manager differenty (i.e. specify certain assemblies to load)
        /// &lt;/summary&gt;
        protected virtual void SetupPluginManager()
        {
            if (PluginManager.Current == null || PluginManagerResetRequired)
            {
                PluginManager.Current = new PluginManager(
                    new ActivatorServiceProvider(),
                    CacheHelper.RuntimeCache, ProfilingLogger, false)
                {
                    AssembliesToScan = new[]
                    {
                        Assembly.Load(&quot;Umbraco.Core&quot;),
                        Assembly.Load(&quot;umbraco&quot;),
                        Assembly.Load(&quot;Umbraco.Tests&quot;),
                        Assembly.Load(&quot;businesslogic&quot;),
                        Assembly.Load(&quot;cms&quot;),
                        Assembly.Load(&quot;controls&quot;),
                        Assembly.Load(&quot;umbraco.editorControls&quot;),
                        Assembly.Load(&quot;umbraco.MacroEngines&quot;),
                        Assembly.Load(&quot;umbraco.providers&quot;),
                    }
                };
            }
        }

        /// &lt;summary&gt;
        /// Inheritors can override this to setup any resolvers before resolution is frozen
        /// &lt;/summary&gt;
        protected virtual void FreezeResolution()
        {
            Resolution.Freeze();
        }

        protected ApplicationContext ApplicationContext
        {
            get { return ApplicationContext.Current; }
        }

        protected ILogger Logger
        {
            get { return ProfilingLogger.Logger; }
        }

        protected ProfilingLogger ProfilingLogger { get; private set; }

        protected CacheHelper CacheHelper { get; private set; }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,10,1],[34,13,34,108,1],[35,13,35,84,1],[36,9,36,10,1],[40,9,40,10,1],[41,13,41,31,1],[43,13,43,55,1],[45,13,45,32,1],[47,13,47,54,1],[49,13,49,34,1],[51,13,51,39,1],[53,13,53,33,1],[55,13,55,32,1],[57,9,57,10,1],[61,9,61,10,1],[62,13,62,29,1],[65,13,65,38,1],[66,13,66,43,1],[67,13,67,50,1],[68,13,68,53,1],[71,13,71,62,1],[72,13,72,47,1],[75,13,75,34,1],[76,9,76,10,1],[78,9,78,62,1],[81,9,81,10,1],[82,13,82,26,1],[83,13,83,14,1],[84,17,84,73,1],[85,17,85,18,1],[87,21,87,91,1],[88,17,88,18,1],[89,13,89,14,1],[90,9,90,10,1],[100,9,100,10,1],[101,13,101,98,1],[102,13,102,14,1],[103,17,104,17,1],[104,17,104,18,1],[104,18,105,21,1],[105,21,110,28,1],[110,28,111,21,1],[111,21,111,28,1],[111,28,111,30,1],[111,30,111,40,1],[111,40,111,41,1],[111,41,111,43,1],[111,43,111,44,1],[111,44,111,51,1],[111,51,112,21,1],[112,21,112,22,1],[112,22,113,25,1],[113,25,113,85,1],[113,85,114,21,1],[114,21,114,22,1],[114,22,115,17,1],[115,17,115,18,1],[115,18,115,20,1],[103,17,115,20,1],[116,13,116,14,1],[117,9,117,10,1],[126,17,126,18,1],[126,19,126,32,1],[126,33,126,34,1],[133,9,133,10,1],[134,13,134,44,1],[135,13,135,14,0],[136,17,136,46,0],[137,13,137,14,0],[138,9,138,10,1],[141,9,141,10,1],[142,13,142,47,1],[143,9,143,10,1],[146,9,146,10,1],[147,13,147,60,1],[148,9,148,10,1],[154,9,154,10,1],[155,13,155,65,1],[156,13,156,61,1],[157,9,157,10,1],[160,9,160,10,1],[161,13,161,55,1],[162,13,162,126,1],[164,13,164,58,1],[165,13,174,15,1],[175,13,175,39,1],[176,9,176,10,1],[182,9,182,10,1],[183,13,183,77,1],[184,13,184,14,1],[185,17,201,19,1],[202,13,202,14,1],[203,9,203,10,1],[209,9,209,10,1],[210,13,210,33,1],[211,9,211,10,1],[215,17,215,18,1],[215,19,215,53,1],[215,54,215,55,1],[220,17,220,18,1],[220,19,220,49,1],[220,50,220,51,1],[223,53,223,57,1],[223,58,223,70,1],[225,45,225,49,1],[225,50,225,62,1]]);
    </script>
  </body>
</html>