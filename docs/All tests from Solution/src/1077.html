<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\PluginControllerArea.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.Mvc;
using System.Web.Routing;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Web.WebApi;

namespace Umbraco.Web.Mvc
{
	/// &lt;summary&gt;
	/// A custom area for controllers that are plugins
	/// &lt;/summary&gt;	
	internal class PluginControllerArea : AreaRegistration
	{
		private readonly IEnumerable&lt;PluginControllerMetadata&gt; _surfaceControllers;
        private readonly IEnumerable&lt;PluginControllerMetadata&gt; _apiControllers;
		private readonly string _areaName;

		/// &lt;summary&gt;
		/// The constructor accepts all types of plugin controllers and will verify that ALL of them have the same areaName assigned to them 
		/// based on their PluginControllerAttribute. If they are not the same an exception will be thrown.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;pluginControllers&quot;&gt;&lt;/param&gt;		
		public PluginControllerArea(IEnumerable&lt;PluginControllerMetadata&gt; pluginControllers)
		{
			var controllers = pluginControllers.ToArray();

			if (controllers.Any(x =&gt; x.AreaName.IsNullOrWhiteSpace()))
			{
				throw new InvalidOperationException(&quot;Cannot create a PluginControllerArea unless all plugin controllers assigned have a PluginControllerAttribute assigned&quot;);
			}
			_areaName = controllers.First().AreaName;
			foreach(var c in controllers)
			{
				if (c.AreaName != _areaName)
				{
					throw new InvalidOperationException(&quot;Cannot create a PluginControllerArea unless all plugin controllers assigned have the same AreaName. The first AreaName found was &quot; + _areaName + &quot; however, the controller of type &quot; + c.GetType().FullName + &quot; has an AreaName of &quot; + c.AreaName);
				}
			}

			//get the controllers
			_surfaceControllers = controllers.Where(x =&gt; TypeHelper.IsTypeAssignableFrom&lt;SurfaceController&gt;(x.ControllerType));
            _apiControllers = controllers.Where(x =&gt; TypeHelper.IsTypeAssignableFrom&lt;UmbracoApiController&gt;(x.ControllerType));
		}

		public override void RegisterArea(AreaRegistrationContext context)
		{
			MapRouteSurfaceControllers(context.Routes, _surfaceControllers);
		    MapRouteApiControllers(context.Routes, _apiControllers);
		}

		public override string AreaName
		{
			get { return _areaName; }
		}

		/// &lt;summary&gt;
		/// Registers all surface controller routes
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;routes&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;surfaceControllers&quot;&gt;&lt;/param&gt;
		/// &lt;remarks&gt;
		/// The routes will be:
		/// 
		/// /Umbraco/[AreaName]/[ControllerName]/[Action]/[Id]
		/// &lt;/remarks&gt;
		private void MapRouteSurfaceControllers(RouteCollection routes, IEnumerable&lt;PluginControllerMetadata&gt; surfaceControllers)
		{
			foreach (var s in surfaceControllers)
			{
				var route = this.RouteControllerPlugin(s.ControllerName, s.ControllerType, routes, &quot;&quot;, &quot;Index&quot;, UrlParameter.Optional, &quot;surface&quot;);
                //set the route handler to our SurfaceRouteHandler
                route.RouteHandler = new SurfaceRouteHandler();
			}
		}

        /// &lt;summary&gt;
        /// Registers all api controller routes
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;routes&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;apiControllers&quot;&gt;&lt;/param&gt;
        private void MapRouteApiControllers(RouteCollection routes, IEnumerable&lt;PluginControllerMetadata&gt; apiControllers)
        {
            foreach (var s in apiControllers)
            {
                this.RouteControllerPlugin(s.ControllerName, s.ControllerType, routes, &quot;&quot;, &quot;&quot;, UrlParameter.Optional, &quot;api&quot;, 
                    isMvc: false, 
                    areaPathPrefix: s.IsBackOffice ? &quot;backoffice&quot; : null);
            }
        }
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,3,26,87,1],[27,3,27,4,1],[28,4,28,50,1],[30,4,30,29,1],[30,29,30,60,1],[30,60,30,62,1],[30,4,30,62,1],[31,4,31,5,1],[32,5,32,162,1],[34,4,34,45,1],[35,4,35,11,1],[35,12,35,17,1],[35,18,35,20,1],[35,21,35,32,1],[36,4,36,5,1],[37,5,37,33,1],[38,5,38,6,1],[39,6,39,286,1],[41,4,41,5,1],[44,4,44,49,1],[44,49,44,117,1],[44,117,44,119,1],[44,4,44,119,1],[45,13,45,54,1],[45,54,45,125,1],[45,125,45,127,1],[45,13,45,127,1],[46,3,46,4,1],[49,3,49,4,1],[50,4,50,68,1],[51,7,51,63,1],[52,3,52,4,1],[56,8,56,9,1],[56,10,56,27,1],[56,28,56,29,1],[70,3,70,4,1],[71,4,71,11,1],[71,13,71,18,0],[71,19,71,21,1],[71,22,71,40,1],[72,4,72,5,0],[73,5,73,135,0],[75,17,75,64,0],[76,4,76,5,0],[77,3,77,4,1],[85,9,85,10,1],[86,13,86,20,1],[86,22,86,27,1],[86,28,86,30,1],[86,31,86,45,1],[87,13,87,14,1],[88,17,90,75,1],[91,13,91,14,1],[92,9,92,10,1]]);
    </script>
  </body>
</html>