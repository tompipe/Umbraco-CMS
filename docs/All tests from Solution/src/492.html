<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\python.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using Umbraco.Core.IO;

namespace umbraco.scripting
{

    /// &lt;summary&gt;
    /// Something like a proxy to IronPython. Does some initial settings and calls.
    /// Maps IronPython&#39;s StandardOutput and StandardError to a simple string.
    /// &lt;/summary&gt;
    public class python
    {
        protected internal static PythonEngine Engine;
        protected static System.IO.MemoryStream ms;
        protected static System.IO.StreamReader sr;
		protected internal static System.Collections.Hashtable scripts;

        static python()
        {
            Engine = new PythonEngine();

            initEnv();
			loadScripts();

            ms = new System.IO.MemoryStream();
            sr = new System.IO.StreamReader(ms);
            Engine.SetStandardOutput(ms);
            Engine.SetStandardError(ms);
        }

     
		/// &lt;summary&gt;
        /// To be able to import umbraco dll&#39;s we have to append the umbraco path to python.
        /// It should also be possible to import other python scripts from umbracos python folder.
        /// And finally to run run some custom init stuff the script site.py in umbraco&#39;s
        /// root folder will be executed.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static void initEnv()
        {
            // Add umbracos bin folder to python&#39;s path
            string path = IOHelper.MapPath(SystemDirectories.Bin);
            Engine.AddToPath(path);

			// Add umbracos python folder to python&#39;s path
            path = IOHelper.MapPath(SystemDirectories.MacroScripts);
			Engine.AddToPath(path);

            // execute the site.py to do all the initial stuff
            string initFile = IOHelper.MapPath(SystemDirectories.Root + &quot;/site.py&quot;);
            Engine.ExecuteFile(initFile);
        }

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		private static void loadScripts()
		{
			scripts = new System.Collections.Hashtable();
            string path = IOHelper.MapPath(SystemDirectories.MacroScripts);
			System.IO.DirectoryInfo dir = new System.IO.DirectoryInfo(path);
			foreach (System.IO.FileInfo f in dir.GetFiles(&quot;*.py&quot;))
			{
				if (!f.Name.EndsWith(&quot;_temp.py&quot;))
				{
					try
					{
						scripts[f.FullName] = Engine.CompileFile(f.FullName );
					}
					catch
					{
						scripts[f.FullName] = Engine.Compile(&quot;print &#39;error in file &quot; + f.Name + &quot;&#39;&quot;);
					}
				}
			}
		}

    
		/// &lt;summary&gt;
        /// Executes a python command like in console 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;expression&quot;&gt;command to execute&lt;/param&gt;
        /// &lt;returns&gt;returns standard out of executed command&lt;/returns&gt;
        public static string execute(string expression)
        {
            if (!(expression == null))
            {
                string ret;
                ms.SetLength(0);
                ms.Flush();
                try
                {
                    Engine.Execute(expression);
                    ms.Position = 0;
                    ret = sr.ReadToEnd();
                }
                catch (Exception ex)
                {
                    ret = ex.Message;
                }
                return ret;
            }
            else
            {
                return string.Empty;
            }
        }

       
		/// &lt;summary&gt;
        /// Executes a python script like in console 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;file&quot;&gt;absolute path to script&lt;/param&gt;
        /// &lt;returns&gt;returns standard out of executed script&lt;/returns&gt;
        public static string executeFile(string file)
        {
            if (System.IO.File.Exists(file))
            {
                string ret;
                ms.SetLength(0);
                ms.Flush();

				scripts[file].GetType().InvokeMember(&quot;Execute&quot;, System.Reflection.BindingFlags.InvokeMethod, null, scripts[file], null);

                ms.Position = 0;
                ret = sr.ReadToEnd();
                return ret;
            }
            else
            {
                return &quot;The File &quot; + file + &quot; could not be found.&quot;;
            }
        }


		/// &lt;summary&gt;
		/// Compiles a python script and add it to umbraco&#39;s script collection.
		/// If compilation fails then an exception will be raised.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;file&quot;&gt;absolute path to script&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static void compileFile(string file)
		{
			loadScripts();
            scripts[file] = Engine.CompileFile(file);
		}

		
		/// &lt;summary&gt;
		/// Compiles a python script.
		/// If compilation fails then an exception will be raised.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;file&quot;&gt;absolute path to script&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static void tryCompile(string file)
		{
			Engine.CompileFile(file);
		}

    }


    /// &lt;summary&gt;
    /// The Class PythonEngine is just a wrapper for the real class IronPython.Hosting.PythonEngine
    /// in IronPython. In this manner we does not need a hard reference to the IronPython assembly.
    /// I&#39;ve implemented only the methods i need for my purpose.
    /// &lt;/summary&gt;
    public class PythonEngine
    {
        protected object Engine;

        public PythonEngine()
        {
            string path = IOHelper.MapPath(SystemDirectories.Bin + &quot;/IronPython.dll&quot;);
            System.Reflection.Assembly asm = System.Reflection.Assembly.LoadFile(path);
            System.Type EngineType = asm.GetType(&quot;IronPython.Hosting.PythonEngine&quot;);
            Engine = System.Activator.CreateInstance(EngineType);
        }

        public void AddToPath(string path)
        {
            Engine.GetType().InvokeMember(&quot;AddToPath&quot;, System.Reflection.BindingFlags.InvokeMethod, null, Engine, new object[] { path });
        }

        public void SetStandardOutput(System.IO.Stream stream)
        {
            Engine.GetType().InvokeMember(&quot;SetStandardOutput&quot;, System.Reflection.BindingFlags.InvokeMethod, null, Engine, new object[] { stream });
        }

        public void SetStandardError(System.IO.Stream stream)
        {
            Engine.GetType().InvokeMember(&quot;SetStandardError&quot;, System.Reflection.BindingFlags.InvokeMethod, null, Engine, new object[] { stream });
        }

        public void ExecuteFile(string FileName) 
        {
            Engine.GetType().InvokeMember(&quot;ExecuteFile&quot;, System.Reflection.BindingFlags.InvokeMethod, null, Engine, new object[] { FileName });
        }

        public void Execute(string ScriptCode) 
        {
            Engine.GetType().InvokeMember(&quot;Execute&quot;, System.Reflection.BindingFlags.InvokeMethod, null, Engine, new object[] { ScriptCode });
        }

		public Object CompileFile(string FileName) 
		{
			return Engine.GetType().InvokeMember(&quot;CompileFile&quot;, System.Reflection.BindingFlags.InvokeMethod, null, Engine, new object[] { FileName });
		}

		public Object Compile(string Expression) 
		{
			return Engine.GetType().InvokeMember(&quot;Compile&quot;, System.Reflection.BindingFlags.InvokeMethod, null, Engine, new object[] { Expression });
		}

		public Object CreateModule(string Modulename, bool publish) 
		{
			return Engine.GetType().InvokeMember(&quot;CreateModule&quot;, System.Reflection.BindingFlags.InvokeMethod, null, Engine, new object[] { Modulename, publish });
		}

        public System.Collections.IDictionary  Globals
        {
            set
            {
                Engine.GetType().InvokeMember(&quot;Globals&quot;, System.Reflection.BindingFlags.SetProperty, null, Engine, new object[] { value });  
            }
            get 
            {
                return (System.Collections.IDictionary)Engine.GetType().InvokeMember(&quot;Globals&quot;, System.Reflection.BindingFlags.GetProperty, null, Engine, null);  
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,10,0],[20,13,20,41,0],[22,13,22,23,0],[23,4,23,18,0],[25,13,25,47,0],[26,13,26,49,0],[27,13,27,42,0],[28,13,28,41,0],[29,9,29,10,0],[40,9,40,10,0],[42,13,42,67,0],[43,13,43,36,0],[46,13,46,69,0],[47,4,47,27,0],[50,13,50,85,0],[51,13,51,42,0],[52,9,52,10,0],[59,3,59,4,0],[60,4,60,49,0],[61,13,61,76,0],[62,4,62,68,0],[63,4,63,11,0],[63,13,63,33,0],[63,34,63,36,0],[63,37,63,57,0],[64,4,64,5,0],[65,5,65,38,0],[66,5,66,6,0],[68,6,68,7,0],[69,7,69,61,0],[70,6,70,7,0],[71,6,71,11,0],[72,6,72,7,0],[73,7,73,84,0],[74,6,74,7,0],[75,5,75,6,0],[76,4,76,5,0],[77,3,77,4,0],[86,9,86,10,0],[87,13,87,39,0],[88,13,88,14,0],[90,17,90,33,0],[91,17,91,28,0],[93,17,93,18,0],[94,21,94,48,0],[95,21,95,37,0],[96,21,96,42,0],[97,17,97,18,0],[98,17,98,37,0],[99,17,99,18,0],[100,21,100,38,0],[101,17,101,18,0],[102,17,102,28,0],[105,13,105,14,0],[106,17,106,37,0],[108,9,108,10,0],[117,9,117,10,0],[118,13,118,45,0],[119,13,119,14,0],[121,17,121,33,0],[122,17,122,28,0],[124,5,124,125,0],[126,17,126,33,0],[127,17,127,38,0],[128,17,128,28,0],[131,13,131,14,0],[132,17,132,68,0],[134,9,134,10,0],[144,3,144,4,0],[145,4,145,18,0],[146,13,146,54,0],[147,3,147,4,0],[157,3,157,4,0],[158,4,158,29,0],[159,3,159,4,0],[173,9,173,30,0],[174,9,174,10,0],[175,13,175,87,0],[176,13,176,88,0],[177,13,177,85,0],[178,13,178,66,0],[179,9,179,10,0],[182,9,182,10,0],[183,13,183,138,0],[184,9,184,10,0],[187,9,187,10,0],[188,13,188,148,0],[189,9,189,10,0],[192,9,192,10,0],[193,13,193,147,0],[194,9,194,10,0],[197,9,197,10,0],[198,13,198,144,0],[199,9,199,10,0],[202,9,202,10,0],[203,13,203,142,0],[204,9,204,10,0],[207,3,207,4,0],[208,4,208,142,0],[209,3,209,4,0],[212,3,212,4,0],[213,4,213,140,0],[214,3,214,4,0],[217,3,217,4,0],[218,4,218,154,0],[219,3,219,4,0],[224,13,224,14,0],[225,17,225,140,0],[226,13,226,14,0],[228,13,228,14,0],[229,17,229,161,0],[230,13,230,14,0]]);
    </script>
  </body>
</html>