<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\plugins\tinymce3\insertMacro.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Data;
using System.Reflection;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core.IO;
using umbraco.BasePages;
using umbraco.BusinessLogic;
using umbraco.businesslogic.Exceptions;
using umbraco.cms.businesslogic.macro;
using umbraco.interfaces;
using umbraco.DataLayer;

namespace umbraco.presentation.tinymce3
{
    /// &lt;summary&gt;
    /// Summary description for insertMacro.
    /// &lt;/summary&gt;
    public partial class insertMacro : UmbracoEnsuredPage
    {
        protected Button Button1;
        private readonly ArrayList _dataFields = new ArrayList();
        public Macro m;
        private string _scriptOnLoad = &quot;&quot;;

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            //this could be used for media or content so we need to at least validate that the user has access to one or the other
            if (!ValidateUserApp(DefaultApps.content.ToString()) &amp;&amp; !ValidateUserApp(DefaultApps.media.ToString()))
                throw new UserAuthorizationException(&quot;The current user doesn&#39;t have access to the section/app&quot;);
        }

        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            if (!string.IsNullOrEmpty(_scriptOnLoad))
            {
                jQueryReady.Text = _scriptOnLoad;
            }
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            ClientLoader.DataBind();

            _scriptOnLoad = &quot;&quot;;

            var reqMacroId = Request[&quot;umb_macroID&quot;];
            var reqMacroAlias = Request[&quot;umb_macroAlias&quot;];
            var ignoreForm = string.IsNullOrEmpty(Request[&quot;class&quot;]);

            pane_insert.Text = ui.Text(&quot;insertMacro&quot;);
            Page.Title = ui.Text(&quot;insertMacro&quot;);

            if (!string.IsNullOrEmpty(reqMacroId) || !string.IsNullOrEmpty(reqMacroAlias))
            {

                pane_edit.Visible = true;
                pane_insert.Visible = false;
                edit_buttons.Visible = true;
                insert_buttons.Visible = false;

                // Put user code to initialize the page here
                if (!string.IsNullOrEmpty(reqMacroId))
                {
                    m = new Macro(int.Parse(reqMacroId));
                }
                else
                {
                    m = new Macro(reqMacroAlias);
                }

                pane_edit.Text = ui.Text(&quot;edit&quot;) + &quot; &quot; + m.Name;
                Page.Title = ui.Text(&quot;edit&quot;) + &quot; &quot; + m.Name;

                if (m.Properties.Length == 0)
                {

                    if (ignoreForm)
                    {
                        renderMacro_Click(null, EventArgs.Empty);
                    }
                    else
                    {
                        var fb = new Literal();
                        fb.Text = &quot;&lt;p&gt;&quot; + ui.Text(&quot;macroDoesNotHaveProperties&quot;) + &quot;&lt;/p&gt;&lt;p&gt;&lt;a href=&#39;#&#39; onClick=&#39;tinyMCEPopup.close();&#39;&gt;&quot; + ui.Text(&quot;closeThisWindow&quot;) + &quot;&lt;/a&gt;&quot;;
                        macroProperties.Controls.Add(fb);
                        edit_buttons.Visible = false;
                    }

                }
                else
                {
                    foreach (var mp in m.Properties)
                    {

                        var macroAssembly = mp.Type.Assembly;
                        var macroType = mp.Type.Type;
                        try
                        {
                            var assembly = Assembly.LoadFrom(IOHelper.MapPath(SystemDirectories.Bin + &quot;/&quot; + macroAssembly + &quot;.dll&quot;));

                            var type = assembly.GetType(macroAssembly + &quot;.&quot; + macroType);
                            var typeInstance = Activator.CreateInstance(type) as IMacroGuiRendering;
                            if (typeInstance != null)
                            {
                                var control = Activator.CreateInstance(type) as Control;
                                control.ID = mp.Alias;

                                if (!IsPostBack)
                                {
                                    string propertyValue = Request[&quot;umb_&quot; + mp.Alias];
                                    if (propertyValue != null)
                                    {
                                        // replace linebreaks and quotes
                                        propertyValue =
                                            propertyValue.Replace(&quot;\\r&quot;, &quot;\r&quot;).Replace(&quot;\\n&quot;, &quot;\n&quot;).Replace(&quot;\\\&quot;&quot;, &quot;\&quot;&quot;);

                                        // check encoding
                                        propertyValue = HttpUtility.UrlDecode(propertyValue);

                                        if (propertyValue != &quot;&quot;)
                                        {
                                            type.GetProperty(&quot;Value&quot;).SetValue(control,
                                                                               Convert.ChangeType(
                                                                                   propertyValue,
                                                                                   type.GetProperty(&quot;Value&quot;).PropertyType),
                                                                               null);
                                        }
                                    }
                                }


                                var pp = new uicontrols.PropertyPanel();
                                pp.Text = mp.Name;
                                pp.Controls.Add(control);
                                _scriptOnLoad += &quot;\t\tregisterAlias(&#39;&quot; + control.ID + &quot;&#39;);\n&quot;;
                                macroProperties.Controls.Add(pp);

                                _dataFields.Add(control);

                                
                            }
                            else
                            {
                                Trace.Warn(&quot;umbEditContent&quot;,
                                           &quot;Type doesn&#39;t exist or is not umbraco.interfaces.DataFieldI (&#39;&quot; + macroAssembly +
                                           &quot;.&quot; + macroType + &quot;&#39;)&quot;);
                            }
                        }
                        catch (Exception fieldException)
                        {
                            Trace.Warn(&quot;umbEditContent&quot;, &quot;Error creating type &#39;&quot; + macroAssembly + &quot;.&quot; + macroType + &quot;&#39;&quot;,
                                       fieldException);
                        }
                    }
                }
            }
            else
            {
                IRecordsReader macroRenderings;
                if (Request[&quot;editor&quot;] != &quot;&quot;)
                {
                    const string query = &quot;select macroAlias, macroName from cmsMacro where macroUseInEditor = 1 order by macroName&quot;;
                    using (var sqlHelper = BusinessLogic.Application.SqlHelper)
                    using (var renderings = sqlHelper.ExecuteReader(query))
                        macroRenderings = renderings;
                }
                else
                {
                    const string query = &quot;select macroAlias, macroName from cmsMacro order by macroName&quot;;
                    using (var sqlHelper = BusinessLogic.Application.SqlHelper)
                    using (var renderings = sqlHelper.ExecuteReader(query))
                        macroRenderings = renderings;
                }
                
                umb_macroAlias.DataSource = macroRenderings;
                umb_macroAlias.DataValueField = &quot;macroAlias&quot;;
                umb_macroAlias.DataTextField = &quot;macroName&quot;;
                umb_macroAlias.DataBind();
                macroRenderings.Close();
            }
        }


        protected void renderMacro_Click(object sender, EventArgs e)
        {
            var pageId = int.Parse(Request[&quot;umbPageId&quot;]);

            var macroAttributes = string.Format(&quot;macroAlias=\&quot;{0}\&quot;&quot;, m.Alias);

            var pageVersion = new Guid(Request[&quot;umbVersionId&quot;]);

            var attributes = new Hashtable { { &quot;macroAlias&quot;, m.Alias } };

            foreach (Control c in _dataFields)
            {
                try
                {
                    var ic = (IMacroGuiRendering)c;
                    attributes.Add(c.ID.ToLower(), ic.Value);
                    macroAttributes += string.Format(&quot; {0}=\&quot;{1}\&quot;&quot;, c.ID, ic.Value.Replace(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;).Replace(&quot;\n&quot;, &quot;\\n&quot;).Replace(&quot;\r&quot;, &quot;\\r&quot;));
                }
                catch
                {
                }
            }

            HttpContext.Current.Items[&quot;macrosAdded&quot;] = 0;
            HttpContext.Current.Items[&quot;pageID&quot;] = pageId.ToString();

            var div = macro.renderMacroStartTag(attributes, pageId, pageVersion).Replace(&quot;\\&quot;, &quot;\\\\&quot;).Replace(&quot;&#39;&quot;, &quot;\\&#39;&quot;);

            var macroContent = macro.MacroContentByHttp(pageId, pageVersion, attributes).Replace(&quot;\\&quot;, &quot;\\\\&quot;).Replace(&quot;&#39;&quot;, &quot;\\&#39;&quot;).Replace(&quot;/&quot;, &quot;\\/&quot;).Replace(&quot;\n&quot;, &quot;\\n&quot;);

            if (macroContent.Length &gt; 0 &amp;&amp; macroContent.ToLower().IndexOf(&quot;&lt;script&quot;) &gt; -1)
                macroContent = &quot;&lt;b&gt;Macro rendering contains script code&lt;/b&gt;&lt;br/&gt;This macro won\\&#39;t be rendered in the editor because it contains script code. It will render correct during runtime.&quot;;

            div += macroContent;
            div += macro.renderMacroEndTag();

            _scriptOnLoad += string.Format(&quot;\t\tumbracoEditMacroDo(&#39;{0}&#39;, &#39;{1}&#39;, &#39;{2}&#39;);\n&quot;, macroAttributes.Replace(&quot;&#39;&quot;, &quot;\\&#39;&quot;), m.Name.Replace(&quot;&#39;&quot;, &quot;\\&#39;&quot;), div);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,66,0],[26,9,26,43,0],[29,9,29,10,0],[30,13,30,28,0],[33,13,33,116,0],[34,17,34,113,0],[35,9,35,10,0],[38,9,38,10,0],[39,13,39,33,0],[41,13,41,54,0],[42,13,42,14,0],[43,17,43,50,0],[44,13,44,14,0],[45,9,45,10,0],[48,9,48,10,0],[49,13,49,37,0],[51,13,51,32,0],[53,13,53,53,0],[54,13,54,59,0],[55,13,55,69,0],[57,13,57,55,0],[58,13,58,49,0],[60,13,60,91,0],[61,13,61,14,0],[63,17,63,42,0],[64,17,64,45,0],[65,17,65,45,0],[66,17,66,48,0],[69,17,69,55,0],[70,17,70,18,0],[71,21,71,58,0],[72,17,72,18,0],[74,17,74,18,0],[75,21,75,50,0],[76,17,76,18,0],[78,17,78,65,0],[79,17,79,61,0],[81,17,81,46,0],[82,17,82,18,0],[84,21,84,36,0],[85,21,85,22,0],[86,25,86,66,0],[87,21,87,22,0],[89,21,89,22,0],[90,25,90,48,0],[91,25,91,175,0],[92,25,92,58,0],[93,25,93,54,0],[94,21,94,22,0],[96,17,96,18,0],[98,17,98,18,0],[99,21,99,28,0],[99,30,99,36,0],[99,37,99,39,0],[99,40,99,52,0],[100,21,100,22,0],[102,25,102,62,0],[103,25,103,54,0],[105,25,105,26,0],[106,29,106,134,0],[108,29,108,90,0],[109,29,109,101,0],[110,29,110,54,0],[111,29,111,30,0],[112,33,112,89,0],[113,33,113,55,0],[115,33,115,49,0],[116,33,116,34,0],[117,37,117,87,0],[118,37,118,63,0],[119,37,119,38,0],[121,41,122,123,0],[125,41,125,94,0],[127,41,127,65,0],[128,41,128,42,0],[129,45,133,86,0],[134,41,134,42,0],[135,37,135,38,0],[136,33,136,34,0],[139,33,139,73,0],[140,33,140,51,0],[141,33,141,58,0],[142,33,142,95,0],[143,33,143,66,0],[145,33,145,58,0],[148,29,148,30,0],[150,29,150,30,0],[151,33,153,68,0],[154,29,154,30,0],[155,25,155,26,0],[156,25,156,57,0],[157,25,157,26,0],[158,29,159,56,0],[160,25,160,26,0],[161,21,161,22,0],[162,17,162,18,0],[163,13,163,14,0],[165,13,165,14,0],[167,17,167,45,0],[168,17,168,18,0],[170,28,170,79,0],[171,28,171,75,0],[172,25,172,54,0],[173,17,173,18,0],[175,17,175,18,0],[177,28,177,79,0],[178,28,178,75,0],[179,25,179,54,0],[180,17,180,18,0],[182,17,182,61,0],[183,17,183,62,0],[184,17,184,60,0],[185,17,185,43,0],[186,17,186,41,0],[187,13,187,14,0],[188,9,188,10,0],[192,9,192,10,0],[193,13,193,58,0],[195,13,195,80,0],[197,13,197,65,0],[199,13,199,74,0],[201,13,201,20,0],[201,22,201,31,0],[201,32,201,34,0],[201,35,201,46,0],[202,13,202,14,0],[204,17,204,18,0],[205,21,205,52,0],[206,21,206,62,0],[207,21,207,150,0],[208,17,208,18,0],[209,17,209,22,0],[210,17,210,18,0],[211,17,211,18,0],[212,13,212,14,0],[214,13,214,58,0],[215,13,215,69,0],[217,13,217,124,0],[219,13,219,173,0],[221,13,221,91,0],[222,17,222,199,0],[224,13,224,33,0],[225,13,225,46,0],[227,13,227,164,0],[228,9,228,10,0]]);
    </script>
  </body>
</html>