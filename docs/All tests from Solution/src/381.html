<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Migrations\MigrationStartupHandlerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Moq;
using NUnit.Framework;
using Semver;
using Umbraco.Core;
using Umbraco.Core.Events;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Profiling;
using Umbraco.Core.Services;
using Umbraco.Web.Strategies.Migrations;

namespace Umbraco.Tests.Persistence.Migrations
{
    [TestFixture]
    public class MigrationStartupHandlerTests
    {
        [Test]
        public void Executes_For_Any_Product_Name_When_Not_Specified()
        {
            var changed1 = new Args { CountExecuted = 0 };
            var testHandler1 = new TestMigrationHandler(changed1);
            testHandler1.OnApplicationStarting(Mock.Of&lt;UmbracoApplicationBase&gt;(), new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(), new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;())));
            
            var conn = new Mock&lt;IDbConnection&gt;();
            conn.Setup(x =&gt; x.BeginTransaction(It.IsAny&lt;IsolationLevel&gt;())).Returns(Mock.Of&lt;IDbTransaction&gt;());
            var db = new Mock&lt;Database&gt;(conn.Object);

            var runner1 = new MigrationRunner(Mock.Of&lt;IMigrationEntryService&gt;(), Mock.Of&lt;ILogger&gt;(), new SemVersion(1), new SemVersion(2), &quot;Test1&quot;,
                new IMigration[] { Mock.Of&lt;IMigration&gt;() });
            var result1 = runner1.Execute(db.Object, DatabaseProviders.SqlServerCE, false);
            Assert.AreEqual(1, changed1.CountExecuted);            
        }

        [Test]
        public void Executes_Only_For_Specified_Product_Name()
        {
            var changed1 = new Args { CountExecuted = 0};
            var testHandler1 = new TestMigrationHandler(&quot;Test1&quot;, changed1);
            testHandler1.OnApplicationStarting(Mock.Of&lt;UmbracoApplicationBase&gt;(), new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(), new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;())));
            var changed2 = new Args { CountExecuted = 0 };
            var testHandler2 = new TestMigrationHandler(&quot;Test2&quot;, changed2);
            testHandler2.OnApplicationStarting(Mock.Of&lt;UmbracoApplicationBase&gt;(), new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(), new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;())));

            var conn = new Mock&lt;IDbConnection&gt;();
            conn.Setup(x =&gt; x.BeginTransaction(It.IsAny&lt;IsolationLevel&gt;())).Returns(Mock.Of&lt;IDbTransaction&gt;());
            var db = new Mock&lt;Database&gt;(conn.Object);

            var runner1 = new MigrationRunner(Mock.Of&lt;IMigrationEntryService&gt;(), Mock.Of&lt;ILogger&gt;(), new SemVersion(1), new SemVersion(2), &quot;Test1&quot;,
                new IMigration[] { Mock.Of&lt;IMigration&gt;()});
            var result1 = runner1.Execute(db.Object, DatabaseProviders.SqlServerCE, false);
            Assert.AreEqual(1, changed1.CountExecuted);
            Assert.AreEqual(0, changed2.CountExecuted);

            var runner2 = new MigrationRunner(Mock.Of&lt;IMigrationEntryService&gt;(), Mock.Of&lt;ILogger&gt;(), new SemVersion(1), new SemVersion(2), &quot;Test2&quot;,
                new IMigration[] { Mock.Of&lt;IMigration&gt;() });            
            var result2 = runner2.Execute(db.Object, DatabaseProviders.SqlServerCE, false);
            Assert.AreEqual(1, changed1.CountExecuted);
            Assert.AreEqual(1, changed2.CountExecuted);
        }

        public class Args
        {
            public int CountExecuted { get; set; }
        }

        public class TestMigrationHandler : MigrationStartupHander
        {
            private readonly string _prodName;
            private readonly Args _changed;

            public TestMigrationHandler(Args changed)
            {
                _changed = changed;
            }

            public TestMigrationHandler(string prodName, Args changed)
            {
                _prodName = prodName;
                _changed = changed;
            }

            protected override void AfterMigration(MigrationRunner sender, MigrationEventArgs e)
            {
                _changed.CountExecuted++;
            }
            
            public override string[] TargetProductNames
            {
                get { return _prodName.IsNullOrWhiteSpace() ? new string[] {} : new[] {_prodName}; }
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,1],[27,13,27,59,1],[28,13,28,67,1],[29,13,29,211,1],[31,13,31,50,1],[32,13,32,112,1],[33,13,33,54,1],[35,13,36,61,1],[37,13,37,92,1],[38,13,38,56,1],[39,9,39,10,1],[43,9,43,10,1],[44,13,44,58,1],[45,13,45,76,1],[46,13,46,211,1],[47,13,47,59,1],[48,13,48,76,1],[49,13,49,211,1],[51,13,51,50,1],[52,13,52,112,1],[53,13,53,54,1],[55,13,56,60,1],[57,13,57,92,1],[58,13,58,56,1],[59,13,59,56,1],[61,13,62,61,1],[63,13,63,92,1],[64,13,64,56,1],[65,13,65,56,1],[66,9,66,10,1],[70,40,70,44,1],[70,45,70,49,1],[78,13,78,54,1],[79,13,79,14,1],[80,17,80,36,1],[81,13,81,14,1],[83,13,83,71,1],[84,13,84,14,1],[85,17,85,38,1],[86,17,86,36,1],[87,13,87,14,1],[90,13,90,14,1],[91,17,91,42,1],[92,13,92,14,1],[96,21,96,22,1],[96,23,96,99,1],[96,100,96,101,1]]);
    </script>
  </body>
</html>