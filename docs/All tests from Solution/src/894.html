<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\ApplicationTreeExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Management.Instrumentation;
using System.Net.Http;
using System.Net.Http.Formatting;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.Routing;
using System.Web.Mvc;
using Umbraco.Core;
using Umbraco.Web.Models.Trees;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi;
using umbraco.BusinessLogic;
using umbraco.cms.presentation.Trees;
using ApplicationTree = Umbraco.Core.Models.ApplicationTree;
using IAuthorizationFilter = System.Web.Http.Filters.IAuthorizationFilter;
using UrlHelper = System.Web.Http.Routing.UrlHelper;

namespace Umbraco.Web.Trees
{
    internal static class ApplicationTreeExtensions
    {

        internal static Attempt&lt;Type&gt; TryGetControllerTree(this ApplicationTree appTree)
        {
            //get reference to all TreeApiControllers
            var controllerTrees = UmbracoApiControllerResolver.Current.RegisteredUmbracoApiControllers
                                                              .Where(TypeHelper.IsTypeAssignableFrom&lt;TreeController&gt;)
                                                              .ToArray();

            //find the one we&#39;re looking for
            var foundControllerTree = controllerTrees.FirstOrDefault(x =&gt; x == appTree.GetRuntimeType());
            if (foundControllerTree == null)
            {
                return Attempt&lt;Type&gt;.Fail(new InstanceNotFoundException(&quot;Could not find tree of type &quot; + appTree.Type + &quot; in any loaded DLLs&quot;));
            }
            return Attempt.Succeed(foundControllerTree);
        }

        /// &lt;summary&gt;
        /// This will go and get the root node from a controller tree by executing the tree&#39;s GetRootNode method
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;appTree&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;formCollection&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerContext&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// This ensures that authorization filters are applied to the sub request 
        /// &lt;/remarks&gt;
        internal static async Task&lt;Attempt&lt;TreeNode&gt;&gt; TryGetRootNodeFromControllerTree(this ApplicationTree appTree, FormDataCollection formCollection, HttpControllerContext controllerContext)
        {
            var foundControllerTreeAttempt = appTree.TryGetControllerTree();
            if (foundControllerTreeAttempt.Success == false)
            {
                return Attempt&lt;TreeNode&gt;.Fail(foundControllerTreeAttempt.Exception);
            }
            
            var foundControllerTree = foundControllerTreeAttempt.Result;
            //instantiate it, since we are proxying, we need to setup the instance with our current context
            var instance = (TreeController)DependencyResolver.Current.GetService(foundControllerTree);

            //NOTE: This is all required in order to execute the auth-filters for the sub request, we 
            // need to &quot;trick&quot; web-api into thinking that it is actually executing the proxied controller.

            var urlHelper = controllerContext.Request.GetUrlHelper();
            //create the proxied URL for the controller action
            var proxiedUrl = controllerContext.Request.RequestUri.GetLeftPart(UriPartial.Authority) + 
                urlHelper.GetUmbracoApiService(&quot;GetRootNode&quot;, instance.GetType());
            //add the query strings to it
            proxiedUrl += &quot;?&quot; + formCollection.ToQueryString();
            //create proxy route data specifying the action / controller to execute
            var proxiedRouteData = new HttpRouteData(
                controllerContext.RouteData.Route,
                new HttpRouteValueDictionary(new {action = &quot;GetRootNode&quot;, controller = ControllerExtensions.GetControllerName(instance.GetType())}));

            //create a proxied controller context
            var proxiedControllerContext = new HttpControllerContext(
                controllerContext.Configuration,
                proxiedRouteData,
                new HttpRequestMessage(HttpMethod.Get, proxiedUrl))
                {
                    ControllerDescriptor = new HttpControllerDescriptor(controllerContext.ControllerDescriptor.Configuration, ControllerExtensions.GetControllerName(instance.GetType()), instance.GetType())
                };

            if (WebApiVersionCheck.WebApiVersion &gt;= Version.Parse(&quot;5.0.0&quot;))
            {
                //In WebApi2, this is required to be set: 
                //      proxiedControllerContext.RequestContext = controllerContext.RequestContext
                // but we need to do this with reflection because of codebase changes between version 4/5
                //NOTE: Use TypeHelper here since the reflection is cached
                var controllerContextRequestContext = TypeHelper.GetProperty(controllerContext.GetType(), &quot;RequestContext&quot;).GetValue(controllerContext);
                TypeHelper.GetProperty(proxiedControllerContext.GetType(), &quot;RequestContext&quot;).SetValue(proxiedControllerContext, controllerContextRequestContext);                
            }

            instance.ControllerContext = proxiedControllerContext;
            instance.Request = controllerContext.Request;

            if (WebApiVersionCheck.WebApiVersion &gt;= Version.Parse(&quot;5.0.0&quot;))
            {
                //now we can change the request context&#39;s route data to be the proxied route data - NOTE: we cannot do this directly above
                // because it will detect that the request context is different throw an exception. This is a change in webapi2 and we need to set
                // this with reflection due to codebase changes between version 4/5
                //      instance.RequestContext.RouteData = proxiedRouteData;
                //NOTE: Use TypeHelper here since the reflection is cached
                var instanceRequestContext = TypeHelper.GetProperty(typeof(ApiController), &quot;RequestContext&quot;).GetValue(instance);
                TypeHelper.GetProperty(instanceRequestContext.GetType(), &quot;RouteData&quot;).SetValue(instanceRequestContext, proxiedRouteData);
            }

            //invoke auth filters for this sub request
            var result = await instance.ControllerContext.InvokeAuthorizationFiltersForRequest();
            //if a result is returned it means they are unauthorized, just throw the response.
            if (result != null)
            {
                throw new HttpResponseException(result);
            }
            
            //return the root
            var node = instance.GetRootNode(formCollection);
            return node == null
                ? Attempt&lt;TreeNode&gt;.Fail(new InvalidOperationException(&quot;Could not return a root node for tree &quot; + appTree.Type)) 
                : Attempt&lt;TreeNode&gt;.Succeed(node);
        }

        internal static  Attempt&lt;TreeNodeCollection&gt; TryLoadFromControllerTree(this ApplicationTree appTree, string id, FormDataCollection formCollection, HttpControllerContext controllerContext)
        {
            var foundControllerTreeAttempt = appTree.TryGetControllerTree();
            if (foundControllerTreeAttempt.Success == false)
            {
                return Attempt&lt;TreeNodeCollection&gt;.Fail(foundControllerTreeAttempt.Exception);
            }
            var foundControllerTree = foundControllerTreeAttempt.Result;

            //instantiate it, since we are proxying, we need to setup the instance with our current context
            var instance = (TreeController)DependencyResolver.Current.GetService(foundControllerTree);
            instance.ControllerContext = controllerContext;
            instance.Request = controllerContext.Request;
            //return it&#39;s data
            return Attempt.Succeed(instance.GetNodes(id, formCollection));
        }

        internal static Attempt&lt;TreeNode&gt; TryGetRootNodeFromLegacyTree(this ApplicationTree appTree, FormDataCollection formCollection, UrlHelper urlHelper, string currentSection)
        {
            var xmlTreeNodeAttempt = TryGetRootXmlNodeFromLegacyTree(appTree, formCollection, urlHelper);
            if (xmlTreeNodeAttempt.Success == false)
            {
                return Attempt&lt;TreeNode&gt;.Fail(xmlTreeNodeAttempt.Exception);
            }

            //the root can potentially be null, in that case we&#39;ll just return a null success which means it won&#39;t be included
            if (xmlTreeNodeAttempt.Result == null)
            {
                return Attempt&lt;TreeNode&gt;.Succeed(null);
            }

            var legacyController = new LegacyTreeController(xmlTreeNodeAttempt.Result, appTree.Alias, currentSection, urlHelper);
            var newRoot = legacyController.GetRootNode(formCollection);

            return Attempt.Succeed(newRoot);
            
        }

        internal static Attempt&lt;XmlTreeNode&gt; TryGetRootXmlNodeFromLegacyTree(this ApplicationTree appTree, FormDataCollection formCollection, UrlHelper urlHelper)
        {
            var treeDefAttempt = appTree.TryGetLegacyTreeDef();
            if (treeDefAttempt.Success == false)
            {
                return Attempt&lt;XmlTreeNode&gt;.Fail(treeDefAttempt.Exception);
            }
            var treeDef = treeDefAttempt.Result;
            var bTree = treeDef.CreateInstance();
            var treeParams = new LegacyTreeParams(formCollection);
            bTree.SetTreeParameters(treeParams);

            var xmlRoot = bTree.RootNode;
            
            return Attempt.Succeed(xmlRoot);
        }

        internal static Attempt&lt;TreeDefinition&gt; TryGetLegacyTreeDef(this ApplicationTree appTree)
        {
            //This is how the legacy trees worked....
            var treeDef = TreeDefinitionCollection.Instance.FindTree(appTree.Alias);
            return treeDef == null 
                ? Attempt&lt;TreeDefinition&gt;.Fail(new InstanceNotFoundException(&quot;Could not find tree of type &quot; + appTree.Alias)) 
                : Attempt&lt;TreeDefinition&gt;.Succeed(treeDef);
        }

        internal static Attempt&lt;TreeNodeCollection&gt; TryLoadFromLegacyTree(this ApplicationTree appTree, string id, FormDataCollection formCollection, UrlHelper urlHelper, string currentSection)
        {
            var xTreeAttempt = appTree.TryGetXmlTree(id, formCollection);
            if (xTreeAttempt.Success == false)
            {
                return Attempt&lt;TreeNodeCollection&gt;.Fail(xTreeAttempt.Exception);
            }
            return Attempt.Succeed(LegacyTreeDataConverter.ConvertFromLegacy(id, xTreeAttempt.Result, urlHelper, currentSection, formCollection));
        }

        internal static Attempt&lt;MenuItemCollection&gt; TryGetMenuFromLegacyTreeRootNode(this ApplicationTree appTree, FormDataCollection formCollection, UrlHelper urlHelper)
        {
            var rootAttempt = appTree.TryGetRootXmlNodeFromLegacyTree(formCollection, urlHelper);
            if (rootAttempt.Success == false)
            {
                return Attempt&lt;MenuItemCollection&gt;.Fail(rootAttempt.Exception);
            }

            var currentSection = formCollection.GetRequiredString(&quot;section&quot;);

            var result = LegacyTreeDataConverter.ConvertFromLegacyMenu(rootAttempt.Result, currentSection);            
            return Attempt.Succeed(result);
        }

        internal static Attempt&lt;MenuItemCollection&gt; TryGetMenuFromLegacyTreeNode(this ApplicationTree appTree, string parentId, string nodeId, FormDataCollection formCollection, UrlHelper urlHelper)
        {
            var xTreeAttempt = appTree.TryGetXmlTree(parentId, formCollection);
            if (xTreeAttempt.Success == false)
            {
                return Attempt&lt;MenuItemCollection&gt;.Fail(xTreeAttempt.Exception);
            }

            var currentSection = formCollection.GetRequiredString(&quot;section&quot;);

            var result = LegacyTreeDataConverter.ConvertFromLegacyMenu(nodeId, xTreeAttempt.Result, currentSection);
            if (result == null)
            {
                return Attempt&lt;MenuItemCollection&gt;.Fail(new ApplicationException(&quot;Could not find the node with id &quot; + nodeId + &quot; in the collection of nodes contained with parent id &quot; + parentId));
            }
            return Attempt.Succeed(result);
        }

        private static Attempt&lt;XmlTree&gt; TryGetXmlTree(this ApplicationTree appTree, string id, FormDataCollection formCollection)
        {
            var treeDefAttempt = appTree.TryGetLegacyTreeDef();
            if (treeDefAttempt.Success == false)
            {
                return Attempt&lt;XmlTree&gt;.Fail(treeDefAttempt.Exception);
            }
            var treeDef = treeDefAttempt.Result;
            //This is how the legacy trees worked....
            var bTree = treeDef.CreateInstance();
            var treeParams = new LegacyTreeParams(formCollection);

            //we currently only support an integer id or a string id, we&#39;ll refactor how this works
            //later but we&#39;ll get this working first
            int startId;
            if (int.TryParse(id, out startId))
            {
                treeParams.StartNodeID = startId;
            }
            else
            {
                treeParams.NodeKey = id;
            }
            var xTree = new XmlTree();
            bTree.SetTreeParameters(treeParams);
            bTree.Render(ref xTree);
            return Attempt.Succeed(xTree);
        }

    }
    
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,10,0],[33,13,35,74,0],[38,13,38,75,0],[38,75,38,104,0],[38,104,38,106,0],[38,13,38,106,0],[39,13,39,45,0],[40,13,40,14,0],[41,17,41,145,0],[43,13,43,57,0],[44,9,44,10,0],[57,9,57,10,0],[58,13,58,77,0],[59,13,59,61,0],[60,13,60,14,0],[61,17,61,85,0],[64,13,64,73,0],[66,13,66,103,0],[71,13,71,70,0],[73,13,74,83,0],[76,13,76,64,0],[78,13,80,150,0],[83,13,89,19,0],[91,13,91,76,0],[92,13,92,14,0],[97,17,97,153,0],[98,17,98,162,0],[99,13,99,14,0],[101,13,101,67,0],[102,13,102,58,0],[104,13,104,76,0],[105,13,105,14,0],[111,17,111,129,0],[112,17,112,138,0],[113,13,113,14,0],[116,13,116,98,0],[118,13,118,32,0],[119,13,119,14,0],[120,17,120,57,0],[124,13,124,61,0],[125,13,127,51,0],[128,9,128,10,0],[131,9,131,10,0],[132,13,132,77,0],[133,13,133,61,0],[134,13,134,14,0],[135,17,135,95,0],[137,13,137,73,0],[140,13,140,103,0],[141,13,141,60,0],[142,13,142,58,0],[144,13,144,75,0],[145,9,145,10,0],[148,9,148,10,0],[149,13,149,106,0],[150,13,150,53,0],[151,13,151,14,0],[152,17,152,77,0],[156,13,156,51,0],[157,13,157,14,0],[158,17,158,56,0],[161,13,161,130,0],[162,13,162,72,0],[164,13,164,45,0],[166,9,166,10,0],[169,9,169,10,0],[170,13,170,64,0],[171,13,171,49,0],[172,13,172,14,0],[173,17,173,76,0],[175,13,175,49,0],[176,13,176,50,0],[177,13,177,67,0],[178,13,178,49,0],[180,13,180,42,0],[182,13,182,45,0],[183,9,183,10,0],[186,9,186,10,0],[188,13,188,85,0],[189,13,191,60,0],[192,9,192,10,0],[195,9,195,10,0],[196,13,196,74,0],[197,13,197,47,0],[198,13,198,14,0],[199,17,199,81,0],[201,13,201,147,0],[202,9,202,10,0],[205,9,205,10,0],[206,13,206,98,0],[207,13,207,46,0],[208,13,208,14,0],[209,17,209,80,0],[212,13,212,78,0],[214,13,214,108,0],[215,13,215,44,0],[216,9,216,10,0],[219,9,219,10,0],[220,13,220,80,0],[221,13,221,47,0],[222,13,222,14,0],[223,17,223,81,0],[226,13,226,78,0],[228,13,228,117,0],[229,13,229,32,0],[230,13,230,14,0],[231,17,231,197,0],[233,13,233,44,0],[234,9,234,10,0],[237,9,237,10,0],[238,13,238,64,0],[239,13,239,49,0],[240,13,240,14,0],[241,17,241,72,0],[243,13,243,49,0],[245,13,245,50,0],[246,13,246,67,0],[251,13,251,47,0],[252,13,252,14,0],[253,17,253,50,0],[254,13,254,14,0],[256,13,256,14,0],[257,17,257,41,0],[258,13,258,14,0],[259,13,259,39,0],[260,13,260,49,0],[261,13,261,37,0],[262,13,262,43,0],[263,9,263,10,0]]);
    </script>
  </body>
</html>