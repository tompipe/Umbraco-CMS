<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Security\BackOfficeSignInManager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.Owin;
using Microsoft.Owin;
using Microsoft.Owin.Logging;
using Microsoft.Owin.Security;
using Umbraco.Core.Configuration;
using Umbraco.Core.Models.Identity;

namespace Umbraco.Core.Security
{
    public class BackOfficeSignInManager : SignInManager&lt;BackOfficeIdentityUser, int&gt;
    {
        private readonly ILogger _logger;
        private readonly IOwinRequest _request;

        public BackOfficeSignInManager(UserManager&lt;BackOfficeIdentityUser, int&gt; userManager, IAuthenticationManager authenticationManager, ILogger logger, IOwinRequest request)
            : base(userManager, authenticationManager)
        {
            if (logger == null) throw new ArgumentNullException(&quot;logger&quot;);
            if (request == null) throw new ArgumentNullException(&quot;request&quot;);
            _logger = logger;
            _request = request;
            AuthenticationType = Constants.Security.BackOfficeAuthenticationType;
        }

        public override Task&lt;ClaimsIdentity&gt; CreateUserIdentityAsync(BackOfficeIdentityUser user)
        {
            return user.GenerateUserIdentityAsync((BackOfficeUserManager&lt;BackOfficeIdentityUser&gt;)UserManager);
        }

        public static BackOfficeSignInManager Create(IdentityFactoryOptions&lt;BackOfficeSignInManager&gt; options, IOwinContext context, ILogger logger)
        {
            return new BackOfficeSignInManager(
                context.GetBackOfficeUserManager(), 
                context.Authentication,
                logger,
                context.Request);
        }

        /// &lt;summary&gt;
        /// Sign in the user in using the user name and password
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userName&quot;/&gt;&lt;param name=&quot;password&quot;/&gt;&lt;param name=&quot;isPersistent&quot;/&gt;&lt;param name=&quot;shouldLockout&quot;/&gt;
        /// &lt;returns/&gt;
        public override async Task&lt;SignInStatus&gt; PasswordSignInAsync(string userName, string password, bool isPersistent, bool shouldLockout)
        {
            var result = await base.PasswordSignInAsync(userName, password, isPersistent, shouldLockout);

            switch (result)
            {
                case SignInStatus.Success:
                    _logger.WriteCore(TraceEventType.Information, 0,
                        string.Format(
                            &quot;User: {0} logged in from IP address {1}&quot;,
                            userName,
                            _request.RemoteIpAddress), null, null);
                    break;
                case SignInStatus.LockedOut:
                    _logger.WriteCore(TraceEventType.Information, 0,
                        string.Format(
                            &quot;Login attempt failed for username {0} from IP address {1}, the user is locked&quot;,
                            userName,
                            _request.RemoteIpAddress), null, null);
                    break;
                case SignInStatus.RequiresVerification:
                    _logger.WriteCore(TraceEventType.Information, 0,
                        string.Format(
                            &quot;Login attempt failed for username {0} from IP address {1}, the user requires verification&quot;,
                            userName,
                            _request.RemoteIpAddress), null, null);
                    break;
                case SignInStatus.Failure:
                    _logger.WriteCore(TraceEventType.Information, 0,
                        string.Format(
                            &quot;Login attempt failed for username {0} from IP address {1}&quot;,
                            userName,
                            _request.RemoteIpAddress), null, null);
                    break;
                default:
                    throw new ArgumentOutOfRangeException();
            }

            return result;
        }

        /// &lt;summary&gt;
        /// Creates a user identity and then signs the identity using the AuthenticationManager
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;user&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;isPersistent&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;rememberBrowser&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override async Task SignInAsync(BackOfficeIdentityUser user, bool isPersistent, bool rememberBrowser)
        {
            var userIdentity = await CreateUserIdentityAsync(user);

            // Clear any partial cookies from external or two factor partial sign ins
            AuthenticationManager.SignOut(
                Constants.Security.BackOfficeExternalAuthenticationType, 
                Constants.Security.BackOfficeTwoFactorAuthenticationType);

            var nowUtc = DateTime.Now.ToUniversalTime();
            
            if (rememberBrowser)
            {
                var rememberBrowserIdentity = AuthenticationManager.CreateTwoFactorRememberBrowserIdentity(ConvertIdToString(user.Id));
                AuthenticationManager.SignIn(new AuthenticationProperties()
                {
                    IsPersistent = isPersistent,
                    AllowRefresh = true,
                    IssuedUtc = nowUtc,
                    ExpiresUtc = nowUtc.AddMinutes(GlobalSettings.TimeOutInMinutes)
                }, userIdentity, rememberBrowserIdentity);                
            }
            else
            {
                AuthenticationManager.SignIn(new AuthenticationProperties()
                {
                    IsPersistent = isPersistent,
                    AllowRefresh = true,
                    IssuedUtc = nowUtc,
                    ExpiresUtc = nowUtc.AddMinutes(GlobalSettings.TimeOutInMinutes)
                }, userIdentity);
            }

            //track the last login date
            user.LastLoginDateUtc = DateTime.UtcNow;
            await UserManager.UpdateAsync(user);

            _logger.WriteCore(TraceEventType.Information, 0,
                string.Format(
                    &quot;Login attempt succeeded for username {0} from IP address {1}&quot;,
                    user.UserName,
                    _request.RemoteIpAddress), null, null);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,15,21,55,0],[22,9,22,10,0],[23,13,23,32,0],[23,33,23,75,0],[24,13,24,33,0],[24,34,24,77,0],[25,13,25,30,0],[26,13,26,32,0],[27,13,27,82,0],[28,9,28,10,0],[31,9,31,10,0],[32,13,32,111,0],[33,9,33,10,0],[36,9,36,10,0],[37,13,41,34,0],[42,9,42,10,0],[50,9,50,10,0],[51,13,51,106,0],[53,13,53,28,0],[56,21,60,68,0],[61,21,61,27,0],[63,21,67,68,0],[68,21,68,27,0],[70,21,74,68,0],[75,21,75,27,0],[77,21,81,68,0],[82,21,82,27,0],[84,21,84,61,0],[87,13,87,27,0],[88,9,88,10,0],[98,9,98,10,0],[99,13,99,68,0],[102,13,104,75,0],[106,13,106,57,0],[108,13,108,33,0],[109,13,109,14,0],[110,17,110,136,0],[111,17,117,59,0],[118,13,118,14,0],[120,13,120,14,0],[121,17,127,34,0],[128,13,128,14,0],[131,13,131,53,0],[132,13,132,49,0],[134,13,138,60,0],[139,9,139,10,0]]);
    </script>
  </body>
</html>