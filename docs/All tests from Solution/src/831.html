<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UI\Controls\InsertMacroSplitButton.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web.Mvc;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using ClientDependency.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using umbraco.DataLayer;

namespace Umbraco.Web.UI.Controls
{
	/// &lt;summary&gt;
	/// Represents the &#39;insert macro&#39; button when editing a template which includes the drop down list selector
	/// &lt;/summary&gt;
	/// &lt;remarks&gt;
	///	Though this would be nicer to do in a UserControl, unfortunatley the way that the ScrollingMenu control is designed it seems that 
	/// we have to insert all items via code and loading a UserControl in dynamically is equally ugly. 
	/// &lt;/remarks&gt;
	[ClientDependency(ClientDependencyType.Css, &quot;splitbutton/splitbutton.css&quot;, &quot;UmbracoClient&quot;)]
	[ClientDependency(ClientDependencyType.Javascript, &quot;splitbutton/jquery.splitbutton.js&quot;, &quot;UmbracoClient&quot;, Priority = 100)]
	[ClientDependency(ClientDependencyType.Javascript, &quot;splitbutton/InsertMacroSplitButton.js&quot;, &quot;UmbracoClient&quot;, Priority = 101)] 
	internal class InsertMacroSplitButton : UmbracoControl
	{
		protected LiteralControl ListContainer;

		protected override void OnInit(EventArgs e)
		{
			base.OnInit(e);
			EnsureChildControls();
		}

		/// &lt;summary&gt;
		/// The JS callback to display the dialog modal screen to customize the macro to be inserted into the editor if the
		/// macro has parameters.
		/// &lt;/summary&gt;
		public string ClientCallbackOpenMacroModel { get; set; }

		/// &lt;summary&gt;
		/// The JS callback method which accepts an &#39;alias&#39; parameter that is invoked when clicking the macro button
		/// to insert a macro that has no parameters.
		/// &lt;/summary&gt;
		public string ClientCallbackInsertMacroMarkup { get; set; }

		protected override void CreateChildControls()
		{
			base.CreateChildControls();

			//var menuItemsId = ClientID + &quot;menuitems&quot;;
			//var placeHolderId = ClientID + &quot;sbPlaceholder&quot;;

			/*create the list, similar to this, but swap the repeater for real html:
			 
			&lt;div id=&quot;macroMenu&quot; style=&quot;width: 285px&quot;&gt;
				&lt;asp:Repeater ID=&quot;rpt_macros&quot; runat=&quot;server&quot;&gt;
					&lt;ItemTemplate&gt;
						&lt;div class=&quot;macro&quot; rel=&quot;&lt;%# DataBinder.Eval(Container, &quot;DataItem.macroAlias&quot;)%&gt;&quot;
							data-has-params=&quot;&lt;%#  DoesMacroHaveSettings(DataBinder.Eval(Container, &quot;DataItem.id&quot;).ToString()) %&gt;&quot;&gt;
							&lt;%# DataBinder.Eval(Container, &quot;DataItem.macroName&quot;)%&gt;
						&lt;/div&gt;
					&lt;/ItemTemplate&gt;
				&lt;/asp:Repeater&gt;
			&lt;/div&gt;
			*/

			//Create the drop down menu list first (it is hidden)
			var divMacroItemContainer = new TagBuilder(&quot;div&quot;);
			divMacroItemContainer.Attributes.Add(&quot;style&quot;, &quot;width: 285px;display:none;&quot;);
			divMacroItemContainer.Attributes.Add(&quot;class&quot;, &quot;sbMenu&quot;);
			var macros = ApplicationContext.DatabaseContext.Database.Fetch&lt;MacroDto&gt;(&quot;select id, macroAlias, macroName from cmsMacro order by macroName&quot;);
			foreach (var macro in macros)
			{
				var divMacro = new TagBuilder(&quot;div&quot;);
				divMacro.AddCssClass(&quot;macro-item&quot;);
				divMacro.Attributes.Add(&quot;rel&quot;, macro.Alias);
				divMacro.Attributes.Add(&quot;data-has-params&quot;, DoesMacroHaveParameters(macro.Id).ToString().ToLower());
				divMacro.SetInnerText(macro.Name);
				divMacroItemContainer.InnerHtml += divMacro.ToString();
			}
			
			/*create the button itself, similar to this:
			
			&lt;div id=&quot;splitButtonMacro&quot; style=&quot;display: inline; height: 23px; vertical-align: top;&quot;&gt;
				&lt;a href=&quot;javascript:openMacroModal();&quot; class=&quot;sbLink&quot;&gt;
					&lt;img alt=&quot;Insert Macro&quot; src=&quot;../images/editor/insMacroSB.png&quot; title=&quot;Insert Macro&quot;
						style=&quot;vertical-align: top;&quot;&gt;
				&lt;/a&gt;
			&lt;/div&gt;
			
			*/

			var divSplitButtonWrapper = new TagBuilder(&quot;div&quot;);
			divSplitButtonWrapper.AddCssClass(&quot;sbPlaceHolder&quot;);
			divSplitButtonWrapper.Attributes.Add(&quot;id&quot;, ClientID + &quot;sbPlaceholder&quot;);
			var divButton = new TagBuilder(&quot;div&quot;);
			divButton.Attributes.Add(&quot;style&quot;, &quot;display: inline; height: 23px; vertical-align: top;&quot;);
			var aButton = new TagBuilder(&quot;a&quot;);
			aButton.Attributes.Add(&quot;href&quot;, &quot;#&quot;); //will be bound with jquery
			aButton.AddCssClass(&quot;sbLink&quot;);
			var imgButton = new TagBuilder(&quot;img&quot;);
			imgButton.Attributes.Add(&quot;alt&quot;, &quot;Insert Macro&quot;);
			imgButton.Attributes.Add(&quot;src&quot;, this.ResolveUrl(SystemDirectories.Umbraco + &quot;/images/editor/insMacroSB.png&quot;));
			imgButton.Attributes.Add(&quot;title&quot;, &quot;Insert Macro&quot;);
			imgButton.Attributes.Add(&quot;style&quot;, &quot;vertical-align: top;&quot;);
			aButton.InnerHtml = imgButton.ToString();
			divButton.InnerHtml = aButton.ToString();
			divSplitButtonWrapper.InnerHtml = divButton.ToString();

			ListContainer = new LiteralControl(divMacroItemContainer.ToString() + divSplitButtonWrapper.ToString());
			Controls.Add(ListContainer);

//			Page.ClientScript.RegisterStartupScript(
//				typeof(InsertMacroSplitButton), 
//				ClientID,
//				@&quot;jQuery(document).ready(function() {
//					jQuery(&#39;#&quot; + placeHolderId + &quot; a.sbLink&#39;).splitbutton({menu:&#39;#&quot; + menuItemsId + &quot;&#39;}); &quot; +
//				&quot;});&quot;,
//				true);

			Page.ClientScript.RegisterStartupScript(
				typeof(InsertMacroSplitButton),
				typeof(InsertMacroSplitButton).Name, //same key for all instancees, we should only render once
				@&quot;jQuery(document).ready(function() {
						var splitButton = new Umbraco.Controls.InsertMacroSplitButton({
							openMacroModel: &quot; + ClientCallbackOpenMacroModel + @&quot;,
							insertMacroMarkup: &quot; + ClientCallbackInsertMacroMarkup + @&quot;
						});
						splitButton.init();
				});&quot;,
				true);
		}


		private bool DoesMacroHaveParameters(int macroId)
		{
            return ApplicationContext.DatabaseContext.Database.ExecuteScalar&lt;int&gt;(string.Format(&quot;SELECT COUNT(*) from cmsMacroProperty where macro = {0}&quot;, macroId)) &gt; 0;
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,3,32,4,0],[33,4,33,19,0],[34,4,34,26,0],[35,3,35,4,0],[41,48,41,52,0],[41,53,41,57,0],[47,51,47,55,0],[47,56,47,60,0],[50,3,50,4,0],[51,4,51,31,0],[71,4,71,54,0],[72,4,72,80,0],[73,4,73,60,0],[74,4,74,146,0],[75,4,75,11,0],[75,13,75,22,0],[75,23,75,25,0],[75,26,75,32,0],[76,4,76,5,0],[77,5,77,42,0],[78,5,78,40,0],[79,5,79,49,0],[80,5,80,104,0],[81,5,81,39,0],[82,5,82,60,0],[83,4,83,5,0],[96,4,96,54,0],[97,4,97,55,0],[98,4,98,75,0],[99,4,99,42,0],[100,4,100,93,0],[101,4,101,38,0],[102,4,102,40,0],[103,4,103,34,0],[104,4,104,42,0],[105,4,105,52,0],[106,4,106,114,0],[107,4,107,54,0],[108,4,108,62,0],[109,4,109,45,0],[110,4,110,45,0],[111,4,111,59,0],[113,4,113,108,0],[114,4,114,32,0],[124,4,134,11,0],[135,3,135,4,0],[139,3,139,4,0],[140,13,140,170,0],[141,3,141,4,0]]);
    </script>
  </body>
</html>