<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\language\Language.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.Xml;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Services;
using umbraco.DataLayer;
using umbraco.BusinessLogic;
using System.Linq;

namespace umbraco.cms.businesslogic.language
{
    /// &lt;summary&gt;
    /// The language class contains methods for creating and modifing installed languages.
    /// 
    /// A language is used internal in the umbraco console for displaying languagespecific text and 
    /// in the public website for language/country specific representation of ex. date/time, currencies.
    /// 
    /// Besides by using the built in Dictionary you are able to store language specific bits and pieces of translated text
    /// for use in templates.
    /// &lt;/summary&gt;
    [Obsolete(&quot;Use the LocalizationService instead&quot;)]
    public class Language
    {
        #region Private members

        internal ILanguage LanguageEntity { get; private set; }

        #endregion

        #region Constants and static members
        
        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        protected static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

 
        #endregion
        
        #region Constructors

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;Language&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The id.&lt;/param&gt;
        public Language(int id)
        {
            LanguageEntity = ApplicationContext.Current.Services.LocalizationService.GetLanguageById(id);
            if (LanguageEntity == null)
            {
                throw new ArgumentException(&quot;No language found with the specified id&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Empty constructor used to create a language object manually
        /// &lt;/summary&gt;
        internal Language() { }

        internal Language(ILanguage langEntity)
        {
            LanguageEntity = langEntity;
        }

        #endregion

        #region Static methods

        /// &lt;summary&gt;
        /// Creates a new language given the culture code - ie. da-dk  (denmark)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cultureCode&quot;&gt;Culturecode of the language&lt;/param&gt;
        public static void MakeNew(string cultureCode)
        {
            var culture = GetCulture(cultureCode);
            if (culture != null)
            {
                //insert it
                var lang = new Umbraco.Core.Models.Language(cultureCode)
                {
                    CultureName = culture.DisplayName
                };
                ApplicationContext.Current.Services.LocalizationService.Save(lang);
                var ct = new Language(lang);
                ct.OnNew(new NewEventArgs());
            }
        }

        /// &lt;summary&gt;
        /// Method for accessing all installed languagess
        /// &lt;/summary&gt;
        [Obsolete(&quot;Use the GetAllAsList() method instead&quot;)]
        public static Language[] getAll
        {
            get
            {
                return GetAllAsList().ToArray();
            }
        }

        /// &lt;summary&gt;
        /// Returns all installed languages
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// This will return a cached set of all languages. if the cache is not found it will create it.
        /// &lt;/remarks&gt;
        public static IEnumerable&lt;Language&gt; GetAllAsList()
        {
            var all = ApplicationContext.Current.Services.LocalizationService.GetAllLanguages().Select(x =&gt; new Language(x)).ToArray();
            return all;
        }
      

        /// &lt;summary&gt;
        /// Gets the language by its culture code, if no language is found, null is returned
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cultureCode&quot;&gt;The culture code.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static Language GetByCultureCode(string cultureCode)
        {
            var found = ApplicationContext.Current.Services.LocalizationService.GetLanguageByIsoCode(cultureCode);
            if (found == null) return null;
            var lang = new Language(found);
            return lang;
        }

        private static CultureInfo GetCulture(string cultureCode)
        {
            try
            {
                var culture = new CultureInfo(cultureCode);
                return culture;
            }
            catch (Exception ex)
            {
                LogHelper.Error&lt;Language&gt;(&quot;Could not find the culture &quot; + cultureCode, ex);
                return null;
            }       
        }

        /// &lt;summary&gt;
        /// Imports a language from XML
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlData&quot;&gt;The XML data.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;This is no longer used and will be removed in future versions&quot;)]
        public static Language Import(XmlNode xmlData)
        {
            var cA = xmlData.Attributes[&quot;CultureAlias&quot;].Value;
            if (GetByCultureCode(cA) == null)
            {
                MakeNew(cA);
                return GetByCultureCode(cA);
            }
            return null;
        }

        #endregion

        #region Public Properties
        /// &lt;summary&gt;
        /// The id used by umbraco to identify the language
        /// &lt;/summary&gt;
        public int id
        {
            get { return LanguageEntity.Id; }
        }

        /// &lt;summary&gt;
        /// The culture code of the language: ie. Danish/Denmark da-dk
        /// &lt;/summary&gt;
        public string CultureAlias
        {
            get { return LanguageEntity.IsoCode; }
            set
            {
                LanguageEntity.IsoCode = value;
            }
        }

        /// &lt;summary&gt;
        /// The user friendly name of the language/country
        /// &lt;/summary&gt;
        public string FriendlyName
        {
            get { return LanguageEntity.CultureInfo.DisplayName; }
        } 
        #endregion

        #region Public methods

        /// &lt;summary&gt;
        /// Ensures uniqueness by id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override bool Equals(object obj)
        {
            var l = obj as Language;
            if (l != null)
            {
                return id.Equals(l.id);
            }
            return false;
        }

        /// &lt;summary&gt;
        /// Ensures uniqueness by id
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override int GetHashCode()
        {
            return id.GetHashCode();
        }

        /// &lt;summary&gt;
        /// Used to persist object changes to the database
        /// &lt;/summary&gt;
        public virtual void Save()
        {
            var e = new SaveEventArgs();
            FireBeforeSave(e);

            //Do the update!
            ApplicationContext.Current.Services.LocalizationService.Save(LanguageEntity);

            if (!e.Cancel)
            {
                FireAfterSave(e);
            }
        }

        /// &lt;summary&gt;
        /// Deletes the current Language.
        /// 
        /// Notice: this can have various sideeffects - use with care.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// You cannot delete the default language: en-US, this is installed by default and is required.
        /// &lt;/remarks&gt;
        public void Delete()
        {
            if (ApplicationContext.Current.DatabaseContext.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT count(id) FROM umbracoDomains where domainDefaultLanguage = @id&quot;, new { id = id }) == 0)
            {
                var e = new DeleteEventArgs();
                FireBeforeDelete(e);

                if (!e.Cancel)
                {
                    ApplicationContext.Current.Services.LocalizationService.Delete(LanguageEntity);

                    FireAfterDelete(e);
                }
            }
            else
            {
                var e = new DataException(&quot;Cannot remove language &quot; + LanguageEntity.CultureInfo.DisplayName + &quot; because it&#39;s attached to a domain on a node&quot;);
                LogHelper.Error&lt;Language&gt;(&quot;Cannot remove language &quot; + LanguageEntity.CultureInfo.DisplayName + &quot; because it&#39;s attached to a domain on a node&quot;, e);
                throw e;
            }           
        }

        /// &lt;summary&gt;
        /// Converts the instance to XML
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xd&quot;&gt;The xml document.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public XmlNode ToXml(XmlDocument xd)
        {
            var serializer = new EntityXmlSerializer();
            var xml = serializer.Serialize(LanguageEntity);
            return xml.GetXmlNode(xd);
        } 
        #endregion

        #region Events

        /// &lt;summary&gt;
        /// The save event handler
        /// &lt;/summary&gt;
        public delegate void SaveEventHandler(Language sender, SaveEventArgs e);
        /// &lt;summary&gt;
        /// The new event handler
        /// &lt;/summary&gt;
        public delegate void NewEventHandler(Language sender, NewEventArgs e);
        /// &lt;summary&gt;
        /// The delete event handler
        /// &lt;/summary&gt;
        public delegate void DeleteEventHandler(Language sender, DeleteEventArgs e);

        /// &lt;summary&gt;
        /// Occurs when a language is saved.
        /// &lt;/summary&gt;
        public static event SaveEventHandler BeforeSave;
        protected virtual void FireBeforeSave(SaveEventArgs e)
        {
            if (BeforeSave != null)
                BeforeSave(this, e);
        }

        public static event SaveEventHandler AfterSave;
        protected virtual void FireAfterSave(SaveEventArgs e)
        {
            if (AfterSave != null)
                AfterSave(this, e);
        }

        public static event NewEventHandler New;
        protected virtual void OnNew(NewEventArgs e)
        {
            if (New != null)
                New(this, e);
        }

        public static event DeleteEventHandler BeforeDelete;
        protected virtual void FireBeforeDelete(DeleteEventArgs e)
        {
            if (BeforeDelete != null)
                BeforeDelete(this, e);
        }

        public static event DeleteEventHandler AfterDelete;
        protected virtual void FireAfterDelete(DeleteEventArgs e)
        {
            if (AfterDelete != null)
                AfterDelete(this, e);
        } 
        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[32,45,32,49,0],[32,50,32,62,0],[44,17,44,18,0],[44,19,44,48,0],[44,49,44,50,0],[56,9,56,32,0],[57,9,57,10,0],[58,13,58,106,0],[59,13,59,40,0],[60,13,60,14,0],[61,17,61,88,0],[63,9,63,10,0],[68,9,68,28,0],[68,29,68,30,0],[68,31,68,32,0],[70,9,70,48,0],[71,9,71,10,0],[72,13,72,41,0],[73,9,73,10,0],[84,9,84,10,0],[85,13,85,51,0],[86,13,86,33,0],[87,13,87,14,0],[89,17,92,19,0],[93,17,93,84,0],[94,17,94,45,0],[95,17,95,46,0],[96,13,96,14,0],[97,9,97,10,0],[106,13,106,14,0],[107,17,107,49,0],[108,13,108,14,0],[119,9,119,10,0],[120,13,120,109,0],[120,109,120,124,0],[120,124,120,136,0],[120,13,120,136,0],[121,13,121,24,0],[122,9,122,10,0],[131,9,131,10,0],[132,13,132,115,0],[133,13,133,31,0],[133,32,133,44,0],[134,13,134,44,0],[135,13,135,25,0],[136,9,136,10,0],[139,9,139,10,0],[141,13,141,14,0],[142,17,142,60,0],[143,17,143,32,0],[145,13,145,33,0],[146,13,146,14,0],[147,17,147,92,0],[148,17,148,29,0],[150,9,150,10,0],[159,9,159,10,0],[160,13,160,63,0],[161,13,161,46,0],[162,13,162,14,0],[163,17,163,29,0],[164,17,164,45,0],[166,13,166,25,0],[167,9,167,10,0],[177,17,177,18,0],[177,19,177,44,0],[177,45,177,46,0],[185,17,185,18,0],[185,19,185,49,0],[185,50,185,51,0],[187,13,187,14,0],[188,17,188,48,0],[189,13,189,14,0],[197,17,197,18,0],[197,19,197,65,0],[197,66,197,67,0],[209,9,209,10,0],[210,13,210,37,0],[211,13,211,27,0],[212,13,212,14,0],[213,17,213,40,0],[215,13,215,26,0],[216,9,216,10,0],[223,9,223,10,0],[224,13,224,37,0],[225,9,225,10,0],[231,9,231,10,0],[232,13,232,41,0],[233,13,233,31,0],[236,13,236,90,0],[238,13,238,27,0],[239,13,239,14,0],[240,17,240,34,0],[241,13,241,14,0],[242,9,242,10,0],[253,9,253,10,0],[254,13,254,184,0],[255,13,255,14,0],[256,17,256,47,0],[257,17,257,37,0],[259,17,259,31,0],[260,17,260,18,0],[261,21,261,100,0],[263,21,263,40,0],[264,17,264,18,0],[265,13,265,14,0],[267,13,267,14,0],[268,17,268,160,0],[269,17,269,163,0],[270,17,270,25,0],[272,9,272,10,0],[280,9,280,10,0],[281,13,281,56,0],[282,13,282,60,0],[283,13,283,39,0],[284,9,284,10,0],[307,9,307,10,0],[308,13,308,36,0],[309,17,309,37,0],[310,9,310,10,0],[314,9,314,10,0],[315,13,315,35,0],[316,17,316,36,0],[317,9,317,10,0],[321,9,321,10,0],[322,13,322,29,0],[323,17,323,30,0],[324,9,324,10,0],[328,9,328,10,0],[329,13,329,38,0],[330,17,330,39,0],[331,9,331,10,0],[335,9,335,10,0],[336,13,336,37,0],[337,17,337,38,0],[338,9,338,10,0]]);
    </script>
  </body>
</html>