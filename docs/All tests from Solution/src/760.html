<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\BaseRest\BaseRestHandler.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web;
using System.Web.SessionState;
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Configuration.BaseRest;

namespace Umbraco.Web.BaseRest
{
    [Obsolete(&quot;Umbraco /base is obsoleted, use WebApi (UmbracoApiController) instead for all REST based logic&quot;)]
	internal class BaseRestHandler : IHttpHandler, IRequiresSessionState
	{
		static readonly string BaseUrl;

		static BaseRestHandler()
		{
			BaseUrl = UriUtility.ToAbsolute(Core.IO.SystemDirectories.Base).ToLower();
			if (!BaseUrl.EndsWith(&quot;/&quot;))
				BaseUrl += &quot;/&quot;;
		}

		public bool IsReusable
		{
			get { return true; }
		}

		/// &lt;summary&gt;
		/// Returns a value indicating whether a specified Uri should be routed to the BaseRestHandler.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;uri&quot;&gt;The specified Uri.&lt;/param&gt;
		/// &lt;returns&gt;A value indicating whether the specified Uri should be routed to the BaseRestHandler.&lt;/returns&gt;
		public static bool IsBaseRestRequest(Uri uri)
		{
		    if (uri == null) return false;
            return UmbracoConfig.For.BaseRestExtensions().Enabled
				&amp;&amp; uri.AbsolutePath.ToLowerInvariant().StartsWith(BaseUrl);
		}

		public void ProcessRequest(HttpContext context)
		{
			string url = context.Request.RawUrl;

			// sanitize and split the url
			url = url.Substring(BaseUrl.Length);
			if (url.ToLower().Contains(&quot;.aspx&quot;))
				url = url.Substring(0, url.IndexOf(&quot;.aspx&quot;, StringComparison.OrdinalIgnoreCase));
			if (url.ToLower().Contains(&quot;?&quot;))
				url = url.Substring(0, url.IndexOf(&quot;?&quot;, StringComparison.OrdinalIgnoreCase));
			var urlParts = url.Split(new[] { &#39;/&#39; }, StringSplitOptions.RemoveEmptyEntries);

			// by default, return xml content
			context.Response.ContentType = &quot;text/xml&quot;;

			// ensure that we have a valid request ie /base/library/method/[parameters].aspx
			if (urlParts.Length &lt; 2)
			{
				context.Response.Write(&quot;&lt;error&gt;Invalid request, missing parts.&lt;/error&gt;&quot;);
				context.Response.StatusCode = 400;
				context.Response.StatusDescription = &quot;Bad Request&quot;;
				context.Response.End();
				return;
			}

			var extensionAlias = urlParts[0];
			var methodName = urlParts[1];
		    var paramsCount = urlParts.Length - 2;

			var method = RestExtensionMethodInfo.GetMethod(extensionAlias, methodName, paramsCount);

			if (!method.Exists)
			{
				context.Response.StatusCode = 500;
				context.Response.StatusDescription = &quot;Internal Server Error&quot;;
				context.Response.Output.Write(&quot;&lt;error&gt;Extension or method not found.&lt;/error&gt;&quot;);
			}
			else if (!method.CanBeInvokedByCurrentMember)
			{
				context.Response.StatusCode = 500;
				context.Response.StatusDescription = &quot;Internal Server Error&quot;;
				context.Response.Output.Write(&quot;&lt;error&gt;Permission denied.&lt;/error&gt;&quot;);
			}
			else
			{
				if (!method.ReturnXml)
					context.Response.ContentType = &quot;text/html&quot;;

				TrySetCulture();

				var result = method.Invoke(urlParts.Skip(2).ToArray());
				if (result.Length &gt;= 7 &amp;&amp; result.Substring(0, 7) == &quot;&lt;error&gt;&quot;)
				{
					context.Response.StatusCode = 500;
					context.Response.StatusDescription = &quot;Internal Server Error&quot;;
				}
				context.Response.Output.Write(result);
			}

			context.Response.End();
		}

		#region from baseHttpModule.cs

		// note - is this ok?

		private static void TrySetCulture()
		{
			var domain = HttpContext.Current.Request.Url.Host; // host only
			if (TrySetCulture(domain)) return;

			domain = HttpContext.Current.Request.Url.Authority; // host with port
		    TrySetCulture(domain);
		}

		private static bool TrySetCulture(string domain)
		{
			var uDomain = global::umbraco.cms.businesslogic.web.Domain.GetDomain(domain);
			if (uDomain == null) return false;
			System.Threading.Thread.CurrentThread.CurrentUICulture = new System.Globalization.CultureInfo(uDomain.Language.CultureAlias);
			return true;
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,3,16,4,0],[17,4,17,78,0],[18,4,18,31,0],[19,5,19,20,0],[20,3,20,4,0],[24,8,24,9,0],[24,10,24,22,0],[24,23,24,24,0],[33,3,33,4,0],[34,7,34,23,0],[34,24,34,37,0],[35,13,36,64,0],[37,3,37,4,0],[40,3,40,4,0],[41,4,41,40,0],[44,4,44,40,0],[45,4,45,40,0],[46,5,46,86,0],[47,4,47,36,0],[48,5,48,82,0],[49,4,49,83,0],[52,4,52,46,0],[55,4,55,28,0],[56,4,56,5,0],[57,5,57,78,0],[58,5,58,39,0],[59,5,59,56,0],[60,5,60,28,0],[61,5,61,12,0],[64,4,64,37,0],[65,4,65,33,0],[66,7,66,45,0],[68,4,68,92,0],[70,4,70,23,0],[71,4,71,5,0],[72,5,72,39,0],[73,5,73,66,0],[74,5,74,84,0],[75,4,75,5,0],[76,9,76,49,0],[77,4,77,5,0],[78,5,78,39,0],[79,5,79,66,0],[80,5,80,72,0],[81,4,81,5,0],[83,4,83,5,0],[84,5,84,27,0],[85,6,85,49,0],[87,5,87,21,0],[89,5,89,60,0],[90,5,90,67,0],[91,5,91,6,0],[92,6,92,40,0],[93,6,93,67,0],[94,5,94,6,0],[95,5,95,43,0],[96,4,96,5,0],[98,4,98,27,0],[99,3,99,4,0],[106,3,106,4,0],[107,4,107,54,0],[108,4,108,30,0],[108,31,108,38,0],[110,4,110,55,0],[111,7,111,29,0],[112,3,112,4,0],[115,3,115,4,0],[116,4,116,81,0],[117,4,117,24,0],[117,25,117,38,0],[118,4,118,129,0],[119,4,119,16,0],[120,3,120,4,0]]);
    </script>
  </body>
</html>