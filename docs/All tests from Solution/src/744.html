<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebServices\SaveFileController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Text;
using System.Web.Mvc;
using Umbraco.Core.Events;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Web.Macros;
using Umbraco.Web.Mvc;
using umbraco;
using umbraco.cms.businesslogic.macro;
using System.Collections.Generic;
using umbraco.cms.helpers;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Template = umbraco.cms.businesslogic.template.Template;

namespace Umbraco.Web.WebServices
{
    /// &lt;summary&gt;
    /// A REST controller used to save files such as templates, partial views, macro files, etc...
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This isn&#39;t fully implemented yet but we should migrate all of the logic in the umbraco.presentation.webservices.codeEditorSave
    /// over to this controller.
    /// &lt;/remarks&gt;
    [ValidateMvcAngularAntiForgeryToken]
    public class SaveFileController : UmbracoAuthorizedController
    {
        /// &lt;summary&gt;
        /// Saves a partial view macro
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;filename&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;oldName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;contents&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        public JsonResult SavePartialViewMacro(string filename, string oldName, string contents)
        {
            var svce = (FileService) Services.FileService;

            return SavePartialView(svce,
                filename, oldName, contents,
                &quot;MacroPartials/&quot;,
                (s, n) =&gt; s.GetPartialViewMacro(n),
                (s, v) =&gt; s.ValidatePartialViewMacro((PartialView) v),
                (s, v) =&gt; s.SavePartialViewMacro(v));
        }

        /// &lt;summary&gt;
        /// Saves a partial view
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;filename&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;oldName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;contents&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        public JsonResult SavePartialView(string filename, string oldName, string contents)
        {
            var svce = (FileService) Services.FileService;

            return SavePartialView(svce,
                filename, oldName, contents,
                &quot;Partials/&quot;,
                (s, n) =&gt; s.GetPartialView(n),
                (s, v) =&gt; s.ValidatePartialView((PartialView) v),
                (s, v) =&gt; s.SavePartialView(v));
        }

        private JsonResult SavePartialView(IFileService svce,
            string filename, string oldname, string contents,
            string pathPrefix,
            Func&lt;IFileService, string, IPartialView&gt; get,
            Func&lt;IFileService, IPartialView, bool&gt; validate,
            Func&lt;IFileService, IPartialView, Attempt&lt;IPartialView&gt;&gt; save)
        {
            // sanitize input - partial view names have an extension
            filename = filename
                .Replace(&#39;\\&#39;, &#39;/&#39;)
                .TrimStart(&#39;/&#39;);

            // sharing the editor with partial views &amp; partial view macros,
            // using path prefix to differenciate,
            // but the file service manages different filesystems,
            // and we need to come back to filesystem-relative paths

            // not sure why we still need this but not going to change it now

            if (filename.InvariantStartsWith(pathPrefix))
                filename = filename.TrimStart(pathPrefix);

            if (oldname != null)
            {
                oldname = oldname.TrimStart(&#39;/&#39;, &#39;\\&#39;);
                if (oldname.InvariantStartsWith(pathPrefix))
                    oldname = oldname.TrimStart(pathPrefix);
            }

            var currentView = oldname.IsNullOrWhiteSpace() 
                ? get(svce, filename)
                : get(svce, oldname);

            if (currentView == null)
                currentView = new PartialView(filename);
            else
                currentView.Path = filename;
            currentView.Content = contents;

            


            Attempt&lt;IPartialView&gt; attempt;
            try
            {
                var partialView = currentView as PartialView;
                if (partialView != null &amp;&amp; validate != null &amp;&amp; validate(svce, partialView) == false)
                    return Failed(ui.Text(&quot;speechBubbles&quot;, &quot;partialViewErrorText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;partialViewErrorHeader&quot;),
                                    new FileSecurityException(&quot;File &#39;&quot; + currentView.Path + &quot;&#39; is not a valid partial view file.&quot;));

                attempt = save(svce, currentView);
            }
            catch (Exception e)
            {
                return Failed(ui.Text(&quot;speechBubbles&quot;, &quot;partialViewErrorText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;partialViewErrorHeader&quot;), e);
            }

            if (attempt.Success == false)
            {
                return Failed(ui.Text(&quot;speechBubbles&quot;, &quot;partialViewErrorText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;partialViewErrorHeader&quot;),
                                attempt.Exception);
            }


            return Success(ui.Text(&quot;speechBubbles&quot;, &quot;partialViewSavedText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;partialViewSavedHeader&quot;), new { name = currentView.Name, path = currentView.Path });
        }

        /// &lt;summary&gt;
        /// Saves a template
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;templateName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;templateAlias&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;templateContents&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;templateId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;masterTemplateId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpPost]
        public JsonResult SaveTemplate(string templateName, string templateAlias, string templateContents, int templateId, int masterTemplateId)
        {
            //TODO: Change this over to use the new API - Also this will be migrated to a TemplateEditor or ViewEditor when it&#39;s all moved to angular

            Template t;
            bool pathChanged = false;
            try
            {
                t = new Template(templateId)
                {
                    Text = templateName.CleanForXss(&#39;[&#39;, &#39;]&#39;, &#39;(&#39;, &#39;)&#39;, &#39;:&#39;),
                    Alias = templateAlias.CleanForXss(&#39;[&#39;, &#39;]&#39;, &#39;(&#39;, &#39;)&#39;, &#39;:&#39;),
                    Design = templateContents
                };

                //check if the master page has changed - we need to normalize both - if it&#39;s 0 or -1, then make it 0... this is easy
                // to do with Math.Max
                if (Math.Max(t.MasterTemplate, 0) != Math.Max(masterTemplateId, 0))
                {
                    t.MasterTemplate = Math.Max(masterTemplateId, 0);
                    pathChanged = true;                  
                }
            }
            catch (ArgumentException ex)
            {
                //the template does not exist
                return Failed(&quot;Template does not exist&quot;, ui.Text(&quot;speechBubbles&quot;, &quot;templateErrorHeader&quot;), ex);
            }

            try
            {
                t.Save();

                //ensure the correct path is synced as the parent might have been changed
                // http://issues.umbraco.org/issue/U4-2300                
                if (pathChanged)
                {
                    //need to re-look it up
                    t = new Template(templateId);
                }
                var syncPath = &quot;-1,init,&quot; + t.Path.Replace(&quot;-1,&quot;, &quot;&quot;);

                return Success(ui.Text(&quot;speechBubbles&quot;, &quot;templateSavedText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;templateSavedHeader&quot;),
                    new
                    {
                        path = syncPath,
                        contents = t.Design,
                        alias = t.Alias // might have been updated!
                    });
            }
            catch (Exception ex)
            {
                return Failed(ui.Text(&quot;speechBubbles&quot;, &quot;templateErrorText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;templateErrorHeader&quot;), ex);
            }
        }

        [HttpPost]
        public JsonResult SaveScript(string filename, string oldName, string contents)
        {
            // sanitize input - script names have an extension
            filename = filename
                .Replace(&#39;\\&#39;, &#39;/&#39;)
                .TrimStart(&#39;/&#39;);

            var svce = (FileService) Services.FileService;
            var script = svce.GetScriptByName(oldName);
            if (script == null)
                script = new Script(filename);
            else
                script.Path = filename;
            script.Content = contents;

            try
            {
                if (svce.ValidateScript(script) == false)
                    return Failed(ui.Text(&quot;speechBubbles&quot;, &quot;scriptErrorText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;scriptErrorHeader&quot;),
                                    new FileSecurityException(&quot;File &#39;&quot; + filename + &quot;&#39; is not a valid script file.&quot;));
                
                svce.SaveScript(script);
            }
            catch (Exception e)
            {
                return Failed(ui.Text(&quot;speechBubbles&quot;, &quot;scriptErrorText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;scriptErrorHeader&quot;), e);
            }

            return Success(ui.Text(&quot;speechBubbles&quot;, &quot;scriptSavedText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;scriptSavedHeader&quot;),
                new
                {
                    path = DeepLink.GetTreePathFromFilePath(script.Path),
                    name = script.Path,
                    url = script.VirtualPath,
                    contents = script.Content
                });
        }

        [HttpPost]
        public JsonResult SaveStylesheet(string filename, string oldName, string contents)
        {
            // sanitize input - stylesheet names have no extension
            filename = filename
                .Replace(&#39;\\&#39;, &#39;/&#39;)
                .TrimStart(&#39;/&#39;)
                .EnsureEndsWith(&quot;.css&quot;);

            var svce = (FileService) Services.FileService;
            var stylesheet = svce.GetStylesheetByName(oldName);
            if (stylesheet == null)
                stylesheet = new Stylesheet(filename);
            else
                stylesheet.Path = filename;
            stylesheet.Content = contents;

            try
            {
                if (svce.ValidateStylesheet(stylesheet) == false)
                    return Failed(ui.Text(&quot;speechBubbles&quot;, &quot;cssErrorText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;cssErrorHeader&quot;),
                                    new FileSecurityException(&quot;File &#39;&quot; + filename + &quot;&#39; is not a valid stylesheet file.&quot;));

                svce.SaveStylesheet(stylesheet);
            }
            catch (Exception e)
            {
                return Failed(ui.Text(&quot;speechBubbles&quot;, &quot;cssErrorText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;cssErrorHeader&quot;), e);
            }

            return Success(ui.Text(&quot;speechBubbles&quot;, &quot;cssSavedText&quot;), ui.Text(&quot;speechBubbles&quot;, &quot;cssSavedHeader&quot;),
                new
                {
                    path = DeepLink.GetTreePathFromFilePath(stylesheet.Path),
                    name = stylesheet.Path,
                    url = stylesheet.VirtualPath,
                    contents = stylesheet.Content
                });
        }

        /// &lt;summary&gt;
        /// Returns a successful message
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;message&quot;&gt;The message to display in the speach bubble&lt;/param&gt;
        /// &lt;param name=&quot;header&quot;&gt;The header to display in the speach bubble&lt;/param&gt;
        /// &lt;param name=&quot;additionalVals&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private JsonResult Success(string message, string header, object additionalVals = null)
        {
            var d = additionalVals == null ? new Dictionary&lt;string, object&gt;() : additionalVals.ToDictionary&lt;object&gt;();
            d[&quot;success&quot;] = true;
            d[&quot;message&quot;] = message;
            d[&quot;header&quot;] = header;

            return Json(d);
        }

        /// &lt;summary&gt;
        /// Returns a failed message
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;message&quot;&gt;The message to display in the speach bubble&lt;/param&gt;
        /// &lt;param name=&quot;header&quot;&gt;The header to display in the speach bubble&lt;/param&gt;
        /// &lt;param name=&quot;exception&quot;&gt;The exception if there was one&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private JsonResult Failed(string message, string header, Exception exception = null)
        {
            if (exception != null)
                LogHelper.Error&lt;SaveFileController&gt;(&quot;An error occurred saving a file. &quot; + message, exception);
            return Json(new
            {
                success = false,
                header = header,
                message = message + (exception == null ? &quot;&quot; : (exception.Message + &quot;. Check log for details.&quot;))
            });
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[41,9,41,10,0],[42,13,42,59,0],[44,13,47,27,0],[47,27,47,51,0],[47,51,48,27,0],[48,27,48,70,0],[48,70,49,27,0],[49,27,49,52,0],[49,52,49,54,0],[44,13,49,54,0],[50,9,50,10,0],[61,9,61,10,0],[62,13,62,59,0],[64,13,67,27,0],[67,27,67,46,0],[67,46,68,27,0],[68,27,68,65,0],[68,65,69,27,0],[69,27,69,47,0],[69,47,69,49,0],[64,13,69,49,0],[70,9,70,10,0],[78,9,78,10,0],[80,13,82,33,0],[91,13,91,58,0],[92,17,92,59,0],[94,13,94,33,0],[95,13,95,14,0],[96,17,96,56,0],[97,17,97,61,0],[98,21,98,61,0],[99,13,99,14,0],[101,13,103,38,0],[105,13,105,37,0],[106,17,106,57,0],[108,17,108,45,0],[109,13,109,44,0],[116,13,116,14,0],[117,17,117,62,0],[118,17,118,101,0],[119,21,120,133,0],[122,17,122,51,0],[123,13,123,14,0],[124,13,124,32,0],[125,13,125,14,0],[126,17,126,136,0],[129,13,129,42,0],[130,13,130,14,0],[131,17,132,52,0],[136,13,136,188,0],[137,9,137,10,0],[150,9,150,10,0],[154,13,154,38,0],[156,13,156,14,0],[157,17,162,19,0],[166,17,166,84,0],[167,17,167,18,0],[168,21,168,70,0],[169,21,169,40,0],[170,17,170,18,0],[171,13,171,14,0],[172,13,172,41,0],[173,13,173,14,0],[175,17,175,111,0],[179,13,179,14,0],[180,17,180,26,0],[184,17,184,33,0],[185,17,185,18,0],[187,21,187,50,0],[188,17,188,18,0],[189,17,189,71,0],[191,17,197,24,0],[199,13,199,33,0],[200,13,200,14,0],[201,17,201,131,0],[203,9,203,10,0],[207,9,207,10,0],[209,13,211,33,0],[213,13,213,59,0],[214,13,214,56,0],[215,13,215,32,0],[216,17,216,47,0],[218,17,218,40,0],[219,13,219,39,0],[222,13,222,14,0],[223,17,223,58,0],[224,21,225,119,0],[227,17,227,41,0],[228,13,228,14,0],[229,13,229,32,0],[230,13,230,14,0],[231,17,231,126,0],[234,13,241,20,0],[242,9,242,10,0],[246,9,246,10,0],[248,13,251,41,0],[253,13,253,59,0],[254,13,254,64,0],[255,13,255,36,0],[256,17,256,55,0],[258,17,258,44,0],[259,13,259,43,0],[262,13,262,14,0],[263,17,263,66,0],[264,21,265,123,0],[267,17,267,49,0],[268,13,268,14,0],[269,13,269,32,0],[270,13,270,14,0],[271,17,271,120,0],[274,13,281,20,0],[282,9,282,10,0],[292,9,292,10,0],[293,13,293,119,0],[294,13,294,33,0],[295,13,295,36,0],[296,13,296,34,0],[298,13,298,28,0],[299,9,299,10,0],[309,9,309,10,0],[310,13,310,35,0],[311,17,311,111,0],[312,13,317,16,0],[318,9,318,10,0]]);
    </script>
  </body>
</html>