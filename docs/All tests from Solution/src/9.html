<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\LibraryTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Configuration;
using Umbraco.Core.Models.PublishedContent;
using Umbraco.Core.PropertyEditors;
using Umbraco.Tests.PublishedContent;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;
using Umbraco.Web.PublishedCache;
using Umbraco.Web.PublishedCache.XmlPublishedCache;
using umbraco;

namespace Umbraco.Tests
{

	/// &lt;summary&gt;
	/// Tests for the legacy library class
	/// &lt;/summary&gt;
	[TestFixture]
	public class LibraryTests : BaseRoutingTest
	{
        public override void Initialize()
		{
            // required so we can access property.Value
            PropertyValueConvertersResolver.Current = new PropertyValueConvertersResolver(new ActivatorServiceProvider(), Logger);
            
            base.Initialize();

            // need to specify a custom callback for unit tests
            // AutoPublishedContentTypes generates properties automatically
            // when they are requested, but we must declare those that we
            // explicitely want to be here...

            var propertyTypes = new[]
                {
                    // AutoPublishedContentType will auto-generate other properties
                    new PublishedPropertyType(&quot;content&quot;, 0, &quot;?&quot;), 
                };
            var type = new AutoPublishedContentType(0, &quot;anything&quot;, propertyTypes);
            PublishedContentType.GetPublishedContentTypeCallback = (alias) =&gt; type;
            Debug.Print(&quot;INIT LIB {0}&quot;,
                PublishedContentType.Get(PublishedItemType.Content, &quot;anything&quot;)
                    .PropertyTypes.Count());
            
            var routingContext = GetRoutingContext(&quot;/test&quot;, 1234);
			UmbracoContext.Current = routingContext.UmbracoContext;
		}

		public override void TearDown()
		{
			base.TearDown();
			UmbracoContext.Current = null;
		}


	    [Test]
	    public void Json_To_Xml_Object()
	    {
	        var json = &quot;{ id: 1, name: &#39;hello&#39;, children: [{id: 2, name: &#39;child1&#39;}, {id:3, name: &#39;child2&#39;}]}&quot;;
	        var result = library.JsonToXml(json);
            Assert.AreEqual(@&quot;&lt;json&gt;
  &lt;id&gt;1&lt;/id&gt;
  &lt;name&gt;hello&lt;/name&gt;
  &lt;children&gt;
    &lt;id&gt;2&lt;/id&gt;
    &lt;name&gt;child1&lt;/name&gt;
  &lt;/children&gt;
  &lt;children&gt;
    &lt;id&gt;3&lt;/id&gt;
    &lt;name&gt;child2&lt;/name&gt;
  &lt;/children&gt;
&lt;/json&gt;&quot;, result.Current.OuterXml);
	    }

        [Test]
        public void Json_To_Xml_Array()
        {
            var json = &quot;[{id: 2, name: &#39;child1&#39;}, {id:3, name: &#39;child2&#39;}]&quot;;
            var result = library.JsonToXml(json);
            Assert.AreEqual(@&quot;&lt;json&gt;
  &lt;arrayitem&gt;
    &lt;id&gt;2&lt;/id&gt;
    &lt;name&gt;child1&lt;/name&gt;
  &lt;/arrayitem&gt;
  &lt;arrayitem&gt;
    &lt;id&gt;3&lt;/id&gt;
    &lt;name&gt;child2&lt;/name&gt;
  &lt;/arrayitem&gt;
&lt;/json&gt;&quot;, result.Current.OuterXml);
        }

        [Test]
        public void Json_To_Xml_Error()
        {
            var json = &quot;{ id: 1, name: &#39;hello&#39;, children: }&quot;;
            var result = library.JsonToXml(json);
            Assert.IsTrue(result.Current.OuterXml.StartsWith(&quot;&lt;error&gt;&quot;));
        }

	    [Test]
		public void Get_Item_User_Property()
		{
			var val = library.GetItem(1173, &quot;content&quot;);
			var legacyVal = LegacyGetItem(1173, &quot;content&quot;);
			Assert.AreEqual(legacyVal, val);
			Assert.AreEqual(&quot;&lt;div&gt;This is some content&lt;/div&gt;&quot;, val);
		}

		[Test]
		public void Get_Item_Document_Property()
		{
			//first test a single static val
			var val = library.GetItem(1173, &quot;template&quot;);
			var legacyVal = LegacyGetItem(1173, &quot;template&quot;);
			Assert.AreEqual(legacyVal, val);
			Assert.AreEqual(&quot;1234&quot;, val);

			//now test them all to see if they all match legacy
			foreach(var s in new[]{&quot;id&quot;,&quot;parentID&quot;,&quot;level&quot;,&quot;writerID&quot;,&quot;template&quot;,&quot;sortOrder&quot;,&quot;createDate&quot;,&quot;updateDate&quot;,&quot;nodeName&quot;,&quot;writerName&quot;,&quot;path&quot;})
			{
				val = library.GetItem(1173, s);
				legacyVal = LegacyGetItem(1173, s);
				Assert.AreEqual(legacyVal, val);				
			}			
		}

		[Test]
		public void Get_Item_Invalid_Property()
		{
			var val = library.GetItem(1173, &quot;dontfindme&quot;);
			var legacyVal = LegacyGetItem(1173, &quot;dontfindme&quot;);
			Assert.AreEqual(legacyVal, val);
			Assert.AreEqual(&quot;&quot;, val);
		}

		/// &lt;summary&gt;
		/// The old method, just using this to make sure we&#39;re returning the correct exact data as before.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;nodeId&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		private string LegacyGetItem(int nodeId, string alias)
		{
            var cache = UmbracoContext.Current.ContentCache.InnerCache as PublishedContentCache;
            if (cache == null) throw new Exception(&quot;Unsupported IPublishedContentCache, only the Xml one is supported.&quot;);
            var umbracoXML = cache.GetXml(UmbracoContext.Current, UmbracoContext.Current.InPreviewMode);

            string xpath = UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema ? &quot;./data [@alias=&#39;{0}&#39;]&quot; : &quot;./{0}&quot;;
			if (umbracoXML.GetElementById(nodeId.ToString()) != null)
				if (
					&quot;,id,parentID,level,writerID,template,sortOrder,createDate,updateDate,nodeName,writerName,path,&quot;
						.
						IndexOf(&quot;,&quot; + alias + &quot;,&quot;) &gt; -1)
					return umbracoXML.GetElementById(nodeId.ToString()).Attributes.GetNamedItem(alias).Value;
				else if (
					umbracoXML.GetElementById(nodeId.ToString()).SelectSingleNode(string.Format(xpath, alias)) !=
					null)
					return
						umbracoXML.GetElementById(nodeId.ToString()).SelectSingleNode(string.Format(xpath, alias)).ChildNodes[0].
							Value; //.Value + &quot;*&quot;;
				else
					return string.Empty;
			else
				return string.Empty;
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,3,30,4,1],[32,13,32,131,1],[34,13,34,31,1],[41,13,45,19,1],[46,13,46,83,1],[47,13,47,79,1],[47,79,47,83,1],[47,83,47,84,1],[47,13,47,84,1],[48,13,50,45,1],[52,13,52,67,1],[53,4,53,59,1],[54,3,54,4,1],[57,3,57,4,1],[58,4,58,20,1],[59,4,59,34,1],[60,3,60,4,1],[65,6,65,7,1],[66,10,66,108,1],[67,10,67,47,1],[68,13,79,36,1],[80,6,80,7,1],[84,9,84,10,1],[85,13,85,76,1],[86,13,86,50,1],[87,13,96,36,1],[97,9,97,10,1],[101,9,101,10,1],[102,13,102,62,1],[103,13,103,50,1],[104,13,104,74,1],[105,9,105,10,1],[109,3,109,4,1],[110,4,110,47,1],[111,4,111,51,1],[112,4,112,36,1],[113,4,113,60,1],[114,3,114,4,1],[118,3,118,4,1],[120,4,120,48,1],[121,4,121,52,1],[122,4,122,36,1],[123,4,123,33,1],[126,4,126,11,1],[126,12,126,17,1],[126,18,126,20,1],[126,21,126,142,1],[127,4,127,5,1],[128,5,128,36,1],[129,5,129,40,1],[130,5,130,37,1],[131,4,131,5,1],[132,3,132,4,1],[136,3,136,4,1],[137,4,137,50,1],[138,4,138,54,1],[139,4,139,36,1],[140,4,140,29,1],[141,3,141,4,1],[150,3,150,4,1],[151,13,151,97,1],[152,13,152,31,1],[152,32,152,122,0],[153,13,153,105,1],[155,13,155,127,1],[156,4,156,61,1],[157,5,160,39,1],[161,6,161,95,1],[162,10,164,11,1],[165,6,167,14,1],[169,6,169,26,1],[171,5,171,25,0],[172,3,172,4,1]]);
    </script>
  </body>
</html>