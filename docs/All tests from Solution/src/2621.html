<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\uploadfield\uploadField.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using umbraco.interfaces;
using Umbraco.Core;
using Content = umbraco.cms.businesslogic.Content;
using Umbraco.Core;

namespace umbraco.editorControls
{
    [ValidationProperty(&quot;IsValid&quot;)]
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class uploadField : HtmlInputFile, IDataEditor
    {
        private const string Thumbnailext = &quot;.jpg&quot;;
        private readonly cms.businesslogic.datatype.FileHandlerData _data;
        private readonly string _thumbnails;
        private string _text;
        private readonly MediaFileSystem _fs;
        private CustomValidator _customValidator;

        public uploadField(IData Data, string ThumbnailSizes)
        {
            _fs = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();
            _data = (cms.businesslogic.datatype.FileHandlerData)Data; //this is always FileHandlerData
            _thumbnails = ThumbnailSizes;
        }


        protected override void CreateChildControls()
        {
            base.CreateChildControls();

            _customValidator = new CustomValidator
                {
                    EnableClientScript = false,
                    Display = ValidatorDisplay.Dynamic,
                    ErrorMessage = ui.Text(&quot;errors&quot;, &quot;dissallowedMediaType&quot;)
                };
            _customValidator.ErrorMessage += &quot;&lt;br/&gt;&quot;;

            //NOTE: it would be better to have this as a normal composite control but we don&#39;t want to 
            // break compatibility so we cannot make this inherit from a different class than it already
            // is, so now we have to hack this together and add this directly to the page validators collection
            // since we cannot add it as a control to this one.
            Page.Validators.Add(_customValidator);
        }

        /// &lt;summary&gt;
        /// Internal logic for validation controls to detect whether or not it&#39;s valid (has to be public though) 
        /// &lt;/summary&gt;
        /// &lt;value&gt;Am I valid?&lt;/value&gt;   
        /// &lt;remarks&gt;
        /// This is used for the required and regex validation of a document type&#39;s property
        /// &lt;/remarks&gt;     
        public string IsValid
        {
            get
            {
                var tempText = Text;
                var isEmpty = PostedFile == null || string.IsNullOrEmpty(PostedFile.FileName);
                // checkbox, if it&#39;s used the file will be deleted and we should throw a validation error
                if (Page.Request[ClientID + &quot;clear&quot;] != null &amp;&amp; Page.Request[ClientID + &quot;clear&quot;] != &quot;&quot;)
                    return &quot;&quot;;
                if (isEmpty == false)
                    return PostedFile.FileName;
                return string.IsNullOrEmpty(tempText) == false
                    ? tempText
                    : &quot;&quot;;
            }
        }

        /// &lt;summary&gt;
        /// Checks if the file is valid based on our dissallowed file types
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;postedFile&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal bool IsValidFile(HttpPostedFile postedFile)
        {
            //return true if there is no file
            if (postedFile == null) return true;
            if (postedFile.FileName.IsNullOrWhiteSpace()) return true;

            //now check the file type
            var extension = Path.GetExtension(postedFile.FileName).TrimStart(&quot;.&quot;);

            return UmbracoConfig.For.UmbracoSettings().Content.DisallowedUploadFiles.Any(x =&gt; x.InvariantEquals(extension)) == false;
        }

        public string Text
        {
            get { return _text; }
            set { _text = value; }
        }

        #region IDataEditor Members

        public Control Editor
        {
            get { return this; }
        }

        public virtual bool TreatAsRichTextEditor
        {
            get { return false; }
        }

        public bool ShowLabel
        {
            get { return true; }
        }

        public void Save()
        {
            // Clear data
            if (helper.Request(ClientID + &quot;clear&quot;) == &quot;1&quot;)
            {
                // delete file
                DeleteFile(_text);

                // set filename in db to nothing
                _text = &quot;&quot;;
                _data.Value = _text;

                var props = new[] { Constants.Conventions.Media.Bytes, Constants.Conventions.Media.Extension, Constants.Conventions.Media.Height, Constants.Conventions.Media.Width };
                foreach (var prop in props)
                {
                    try
                    {
                        var bytesControl = Page.FindControlRecursive&lt;noEdit&gt;(&quot;prop_&quot; + prop);
                        if (bytesControl != null)
                        {
                            bytesControl.RefreshLabel(string.Empty);
                        }
                    }
                    catch
                    {
                        //if first one fails we can assume that props don&#39;t exist
                        break;
                    }
                }
            }

            if (PostedFile == null || PostedFile.FileName == string.Empty) return;

            //don&#39;t save if the file is invalid
            if (IsValidFile(PostedFile) == false)
            {
                //set the validator to not valid
                _customValidator.IsValid = false;
                return;
            }

            _data.Value = PostedFile;

            // we update additional properties post image upload
            if (_data.Value != DBNull.Value &amp;&amp; string.IsNullOrEmpty(_data.Value.ToString()) == false)
            {
                //check the FileHandlerData to see if it already loaded in the content item and set it&#39;s properties.
                //if not, then the properties haven&#39;t changed so skip.
                if (_data.LoadedContentItem != null)
                {
                    var content = _data.LoadedContentItem;

                    // update extension in UI
                    UpdateLabelValue(Constants.Conventions.Media.Extension, &quot;prop_umbracoExtension&quot;, Page, content);
                    // update file size in UI
                    UpdateLabelValue(Constants.Conventions.Media.Bytes, &quot;prop_umbracoBytes&quot;, Page, content);
                    UpdateLabelValue(Constants.Conventions.Media.Width, &quot;prop_umbracoWidth&quot;, Page, content);
                    UpdateLabelValue(Constants.Conventions.Media.Height, &quot;prop_umbracoHeight&quot;, Page, content);
                }

            }
            Text = _data.Value.ToString();
        }


        #endregion

        private static void UpdateLabelValue(string propAlias, string controlId, Page controlPage, Content content)
        {
            var extensionControl = controlPage.FindControlRecursive&lt;noEdit&gt;(controlId);
            if (extensionControl != null)
            {
                if (content.getProperty(propAlias) != null &amp;&amp; content.getProperty(propAlias).Value != null)
                {
                    extensionControl.RefreshLabel(content.getProperty(propAlias).Value.ToString());
                }
            }
        }

        [Obsolete(&quot;This method is now obsolete due to a change in the way that files are handled.  If you need to check if a URL for an uploaded file is safe you should implement your own as this method will be removed in a future version&quot;, false)]
        public string SafeUrl(string url)
        {
            return string.IsNullOrEmpty(url) == false
                ? Regex.Replace(url, @&quot;[^a-zA-Z0-9\-\.\/\:]{1}&quot;, &quot;_&quot;)
                : String.Empty;
        }

        protected override void OnInit(EventArgs e)
        {
            EnsureChildControls();
            base.OnInit(e);
            if (_data != null &amp;&amp; _data.Value != null)
                Text = _data.Value.ToString();
        }

        private void DeleteFile(string fileUrl)
        {
            if (fileUrl.Length &gt; 0)
            {
                var relativeFilePath = _fs.GetRelativePath(fileUrl);

                // delete old file
                if (_fs.FileExists(relativeFilePath))
                    _fs.DeleteFile(relativeFilePath);

                var extension = (relativeFilePath.Substring(relativeFilePath.LastIndexOf(&quot;.&quot;) + 1, relativeFilePath.Length - relativeFilePath.LastIndexOf(&quot;.&quot;) - 1));
                extension = extension.ToLower();

                //check for thumbnails
                if (&quot;,jpeg,jpg,gif,bmp,png,tiff,tif,&quot;.IndexOf(&quot;,&quot; + extension + &quot;,&quot;) &gt; -1)
                {
                    //delete thumbnails
                    string relativeThumbFilePath = relativeFilePath.Replace(&quot;.&quot; + extension, &quot;_thumb&quot;);

                    try
                    {
                        if (_fs.FileExists(relativeThumbFilePath + Thumbnailext))
                            _fs.DeleteFile(relativeThumbFilePath + Thumbnailext);
                    }
                    catch
                    {
                    }

                    if (_thumbnails != &quot;&quot;)
                    {
                        var thumbnailSizes = _thumbnails.Split(&quot;;&quot;.ToCharArray());
                        foreach (var thumb in thumbnailSizes)
                        {
                            if (thumb != &quot;&quot;)
                            {
                                string relativeExtraThumbFilePath = relativeThumbFilePath + &quot;_&quot; + thumb + Thumbnailext;

                                try
                                {
                                    if (_fs.FileExists(relativeExtraThumbFilePath))
                                        _fs.DeleteFile(relativeExtraThumbFilePath);
                                }
                                catch
                                {
                                }
                            }
                        }
                    }
                }
            }
        }

        /// &lt;summary&gt; 
        /// Render this control to the output parameter specified.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;output&quot;&gt; The HTML writer to write out to &lt;/param&gt;
        protected override void Render(HtmlTextWriter output)
        {
            //render the validator if it is not valid
            //NOTE: it would be better to have this as a normal composite control but we don&#39;t want to 
            // break compatibility so we cannot make this inherit from a different class than it already
            // is, so now we have to hack this together.     
            if (_customValidator.IsValid == false)
            {
                _customValidator.RenderControl(output);
            }

            if (string.IsNullOrEmpty(Text) == false)
            {
                var relativeFilePath = _fs.GetRelativePath(_text);
                var ext = relativeFilePath.Substring(relativeFilePath.LastIndexOf(&quot;.&quot;) + 1, relativeFilePath.Length - relativeFilePath.LastIndexOf(&quot;.&quot;) - 1);
                var relativeThumbFilePath = relativeFilePath.Replace(&quot;.&quot; + ext, &quot;_thumb.&quot; + ext);
                var hasThumb = false;
                try
                {
                    hasThumb = _fs.FileExists(relativeThumbFilePath);
                    
                    // 7.4.0 generates thumbs with the correct file extension, but check for old possible extensions as well
                    if (hasThumb == false)
                    {
                        relativeThumbFilePath = relativeFilePath.Replace(&quot;.&quot; + ext, &quot;_thumb.png&quot;);
                        hasThumb = _fs.FileExists(relativeThumbFilePath);
                    }

                    if (hasThumb == false)
                    {
                        relativeThumbFilePath = relativeFilePath.Replace(&quot;.&quot; + ext, &quot;_thumb.jpg&quot;);
                        hasThumb = _fs.FileExists(relativeThumbFilePath);
                    }
                }
                catch
                {
                }
                if (hasThumb)
                {
                    var thumb = new Image
                    {
                        ImageUrl = _fs.GetUrl(relativeThumbFilePath),
                        BorderStyle = BorderStyle.None
                    };

                    output.WriteLine(&quot;&lt;a href=\&quot;&quot; + _fs.GetUrl(relativeFilePath) + &quot;\&quot; target=\&quot;_blank\&quot;&gt;&quot;);
                    thumb.RenderControl(output);
                    output.WriteLine(&quot;&lt;/a&gt;&lt;br/&gt;&quot;);
                }
                else
                    output.WriteLine(&quot;&lt;a href=\&quot;&quot; + _fs.GetUrl(relativeFilePath) + &quot;\&quot; target=\&quot;_blank\&quot;&gt;&quot; +
                                     _fs.GetUrl(relativeFilePath) + &quot;&lt;/a&gt;&lt;br/&gt;&quot;);

                output.WriteLine(&quot;&lt;input type=\&quot;checkbox\&quot; id=\&quot;&quot; + ClientID + &quot;clear\&quot; name=\&quot;&quot; + ClientID +
                                 &quot;clear\&quot; value=\&quot;1\&quot;/&gt; &lt;label for=\&quot;&quot; + ClientID + &quot;clear\&quot;&gt;&quot; + ui.Text(&quot;uploadClear&quot;) +
                                 &quot;&lt;/label&gt;&lt;br/&gt;&quot;);
            }
            base.Render(output);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,29,62,0],[30,9,30,10,0],[31,13,31,94,0],[32,13,32,70,0],[33,13,33,42,0],[34,9,34,10,0],[38,9,38,10,0],[39,13,39,40,0],[41,13,46,19,0],[47,13,47,54,0],[53,13,53,51,0],[54,9,54,10,0],[66,13,66,14,0],[67,17,67,37,0],[68,17,68,95,0],[70,17,70,104,0],[71,21,71,31,0],[72,17,72,38,0],[73,21,73,48,0],[74,17,76,26,0],[77,13,77,14,0],[86,9,86,10,0],[88,13,88,36,0],[88,37,88,49,0],[89,13,89,58,0],[89,59,89,71,0],[92,13,92,83,0],[94,13,94,95,0],[94,95,94,123,0],[94,123,94,134,0],[94,13,94,134,0],[95,9,95,10,0],[99,17,99,18,0],[99,19,99,32,0],[99,33,99,34,0],[100,17,100,18,0],[100,19,100,33,0],[100,34,100,35,0],[107,17,107,18,0],[107,19,107,31,0],[107,32,107,33,0],[112,17,112,18,0],[112,19,112,32,0],[112,33,112,34,0],[117,17,117,18,0],[117,19,117,31,0],[117,32,117,33,0],[121,9,121,10,0],[123,13,123,59,0],[124,13,124,14,0],[126,17,126,35,0],[129,17,129,28,0],[130,17,130,37,0],[132,17,132,183,0],[133,17,133,24,0],[133,26,133,34,0],[133,35,133,37,0],[133,38,133,43,0],[134,17,134,18,0],[136,21,136,22,0],[137,25,137,94,0],[138,25,138,50,0],[139,25,139,26,0],[140,29,140,69,0],[141,25,141,26,0],[142,21,142,22,0],[143,21,143,26,0],[144,21,144,22,0],[146,25,146,31,0],[148,17,148,18,0],[149,13,149,14,0],[151,13,151,75,0],[151,76,151,83,0],[154,13,154,50,0],[155,13,155,14,0],[157,17,157,50,0],[158,17,158,24,0],[161,13,161,38,0],[164,13,164,102,0],[165,13,165,14,0],[168,17,168,53,0],[169,17,169,18,0],[170,21,170,59,0],[173,21,173,117,0],[175,21,175,109,0],[176,21,176,109,0],[177,21,177,111,0],[178,17,178,18,0],[180,13,180,14,0],[181,13,181,43,0],[182,9,182,10,0],[188,9,188,10,0],[189,13,189,88,0],[190,13,190,42,0],[191,13,191,14,0],[192,17,192,108,0],[193,17,193,18,0],[194,21,194,100,0],[195,17,195,18,0],[196,13,196,14,0],[197,9,197,10,0],[201,9,201,10,0],[202,13,204,32,0],[205,9,205,10,0],[208,9,208,10,0],[209,13,209,35,0],[210,13,210,28,0],[211,13,211,54,0],[212,17,212,47,0],[213,9,213,10,0],[216,9,216,10,0],[217,13,217,36,0],[218,13,218,14,0],[219,17,219,69,0],[222,17,222,54,0],[223,21,223,54,0],[225,17,225,166,0],[226,17,226,49,0],[229,17,229,91,0],[230,17,230,18,0],[232,21,232,104,0],[235,21,235,22,0],[236,25,236,82,0],[237,29,237,82,0],[238,21,238,22,0],[239,21,239,26,0],[240,21,240,22,0],[241,21,241,22,0],[243,21,243,43,0],[244,21,244,22,0],[245,25,245,83,0],[246,25,246,32,0],[246,34,246,43,0],[246,44,246,46,0],[246,47,246,61,0],[247,25,247,26,0],[248,29,248,45,0],[249,29,249,30,0],[250,33,250,120,0],[253,33,253,34,0],[254,37,254,84,0],[255,41,255,84,0],[256,33,256,34,0],[257,33,257,38,0],[258,33,258,34,0],[259,33,259,34,0],[260,29,260,30,0],[261,25,261,26,0],[262,21,262,22,0],[263,17,263,18,0],[264,13,264,14,0],[265,9,265,10,0],[272,9,272,10,0],[277,13,277,51,0],[278,13,278,14,0],[279,17,279,56,0],[280,13,280,14,0],[282,13,282,53,0],[283,13,283,14,0],[284,17,284,67,0],[285,17,285,158,0],[286,17,286,98,0],[287,17,287,38,0],[289,17,289,18,0],[290,21,290,70,0],[293,21,293,43,0],[294,21,294,22,0],[295,25,295,99,0],[296,25,296,74,0],[297,21,297,22,0],[299,21,299,43,0],[300,21,300,22,0],[301,25,301,99,0],[302,25,302,74,0],[303,21,303,22,0],[304,17,304,18,0],[305,17,305,22,0],[306,17,306,18,0],[307,17,307,18,0],[308,17,308,30,0],[309,17,309,18,0],[310,21,314,23,0],[316,21,316,109,0],[317,21,317,49,0],[318,21,318,51,0],[319,17,319,18,0],[321,21,322,82,0],[324,17,326,51,0],[327,13,327,14,0],[328,13,328,33,0],[329,9,329,10,0]]);
    </script>
  </body>
</html>