<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Querying\ExpressionTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.Linq;
using System.Linq.Expressions;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Querying
{
    [TestFixture]
    public class ExpressionTests : BaseUsingSqlCeSyntax
    {
        [Test]
        public void Equals_Claus_With_Two_Entity_Values()
        {
            var dataType = new DataTypeDefinition(-1, &quot;Test&quot;)
            {
                Id = 12345
            };
            Expression&lt;Func&lt;PropertyType, bool&gt;&gt; predicate = p =&gt; p.DataTypeDefinitionId == dataType.Id;
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;PropertyType&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Model to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;([cmsPropertyType].[dataTypeId] = @0)&quot;, result);
            Assert.AreEqual(12345, modelToSqlExpressionHelper.GetSqlParameters()[0]);
        }

        [Test]
        public void Can_Query_With_Content_Type_Alias()
        {
            //Arrange
            Expression&lt;Func&lt;IMedia, bool&gt;&gt; predicate = content =&gt; content.ContentType.Alias == &quot;Test&quot;;
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IContent&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Model to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;([cmsContentType].[alias] = @0)&quot;, result);
            Assert.AreEqual(&quot;Test&quot;, modelToSqlExpressionHelper.GetSqlParameters()[0]);
        }

        [Test]
        public void Can_Query_With_Content_Type_Aliases()
        {
            //Arrange
            var aliases = new[] {&quot;Test1&quot;, &quot;Test2&quot;};
            Expression&lt;Func&lt;IMedia, bool&gt;&gt; predicate = content =&gt; aliases.Contains(content.ContentType.Alias);
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IContent&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Model to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;[cmsContentType].[alias] IN (@1,@2)&quot;, result);
            Assert.AreEqual(&quot;Test1&quot;, modelToSqlExpressionHelper.GetSqlParameters()[1]);
            Assert.AreEqual(&quot;Test2&quot;, modelToSqlExpressionHelper.GetSqlParameters()[2]);
        }

        [Test]
        public void CachedExpression_Can_Verify_Path_StartsWith_Predicate_In_Same_Result()
        {
            //Arrange

            //use a single cached expression for multiple expressions and ensure the correct output
            // is done for both of them.
            var cachedExpression = new CachedExpression();


            Expression&lt;Func&lt;IContent, bool&gt;&gt; predicate1 = content =&gt; content.Path.StartsWith(&quot;-1&quot;);
            cachedExpression.Wrap(predicate1);
            var modelToSqlExpressionHelper1 = new ModelToSqlExpressionVisitor&lt;IContent&gt;();
            var result1 = modelToSqlExpressionHelper1.Visit(cachedExpression);
            Assert.AreEqual(&quot;upper([umbracoNode].[path]) LIKE upper(@0)&quot;, result1);
            Assert.AreEqual(&quot;-1%&quot;, modelToSqlExpressionHelper1.GetSqlParameters()[0]);

            Expression&lt;Func&lt;IContent, bool&gt;&gt; predicate2 = content =&gt; content.Path.StartsWith(&quot;-1,123,97&quot;);
            cachedExpression.Wrap(predicate2);
            var modelToSqlExpressionHelper2 = new ModelToSqlExpressionVisitor&lt;IContent&gt;();
            var result2 = modelToSqlExpressionHelper2.Visit(cachedExpression);
            Assert.AreEqual(&quot;upper([umbracoNode].[path]) LIKE upper(@0)&quot;, result2);
            Assert.AreEqual(&quot;-1,123,97%&quot;, modelToSqlExpressionHelper2.GetSqlParameters()[0]);

        }

        [Test]
        public void Can_Verify_Path_StartsWith_Predicate_In_Same_Result()
        {
            //Arrange
            Expression&lt;Func&lt;IContent, bool&gt;&gt; predicate = content =&gt; content.Path.StartsWith(&quot;-1&quot;);
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IContent&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);
            
            Assert.AreEqual(&quot;upper([umbracoNode].[path]) LIKE upper(@0)&quot;, result);
            Assert.AreEqual(&quot;-1%&quot;, modelToSqlExpressionHelper.GetSqlParameters()[0]);
        }

        [Test]
        public void Can_Verify_ParentId_StartsWith_Predicate_In_Same_Result()
        {
            //Arrange
            Expression&lt;Func&lt;IContent, bool&gt;&gt; predicate = content =&gt; content.ParentId == -1;
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IContent&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Model to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;([umbracoNode].[parentID] = @0)&quot;, result);
            Assert.AreEqual(-1, modelToSqlExpressionHelper.GetSqlParameters()[0]);
        }

        [Test]
        public void Equals_Operator_For_Value_Gets_Escaped()
        {
            Expression&lt;Func&lt;IUser, bool&gt;&gt; predicate = user =&gt; user.Username == &quot;hello@world.com&quot;;
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IUser&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Model to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;([umbracoUser].[userLogin] = @0)&quot;, result);
            Assert.AreEqual(&quot;hello@world.com&quot;, modelToSqlExpressionHelper.GetSqlParameters()[0]);
        }

        [Test]
        public void Equals_Method_For_Value_Gets_Escaped()
        {
            Expression&lt;Func&lt;IUser, bool&gt;&gt; predicate = user =&gt; user.Username.Equals(&quot;hello@world.com&quot;);
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IUser&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Model to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;upper([umbracoUser].[userLogin]) = upper(@0)&quot;, result);
            Assert.AreEqual(&quot;hello@world.com&quot;, modelToSqlExpressionHelper.GetSqlParameters()[0]);
        }

        [Test]
        public void Model_Expression_Value_Does_Not_Get_Double_Escaped()
        {
            //mysql escapes backslashes, so we&#39;ll test with that
            SqlSyntaxContext.SqlSyntaxProvider = new MySqlSyntaxProvider(Mock.Of&lt;ILogger&gt;());

            Expression&lt;Func&lt;IUser, bool&gt;&gt; predicate = user =&gt; user.Username.Equals(&quot;mydomain\\myuser&quot;);
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IUser&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Model to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;upper(`umbracoUser`.`userLogin`) = upper(@0)&quot;, result);
            Assert.AreEqual(&quot;mydomain\\myuser&quot;, modelToSqlExpressionHelper.GetSqlParameters()[0]);
            
        }

        [Test]
        public void Poco_Expression_Value_Does_Not_Get_Double_Escaped()
        {
            //mysql escapes backslashes, so we&#39;ll test with that
            SqlSyntaxContext.SqlSyntaxProvider = new MySqlSyntaxProvider(Mock.Of&lt;ILogger&gt;());

            Expression&lt;Func&lt;UserDto, bool&gt;&gt; predicate = user =&gt; user.Login.StartsWith(&quot;mydomain\\myuser&quot;);
            var modelToSqlExpressionHelper = new PocoToSqlExpressionVisitor&lt;UserDto&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Poco to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;upper(`umbracoUser`.`userLogin`) LIKE upper(@0)&quot;, result);
            Assert.AreEqual(&quot;mydomain\\myuser%&quot;, modelToSqlExpressionHelper.GetSqlParameters()[0]);
        }

        [Test]
        public void Sql_Replace_Mapped()
        {
            Expression&lt;Func&lt;IUser, bool&gt;&gt; predicate = user =&gt; user.Username.Replace(&quot;@world&quot;, &quot;@test&quot;) == &quot;hello@test.com&quot;;
            var modelToSqlExpressionHelper = new ModelToSqlExpressionVisitor&lt;IUser&gt;();
            var result = modelToSqlExpressionHelper.Visit(predicate);

            Debug.Print(&quot;Model to Sql ExpressionHelper: \n&quot; + result);

            Assert.AreEqual(&quot;(replace([umbracoUser].[userLogin], @1, @2) = @0)&quot;, result);
            Assert.AreEqual(&quot;hello@test.com&quot;, modelToSqlExpressionHelper.GetSqlParameters()[0]);
            Assert.AreEqual(&quot;@world&quot;, modelToSqlExpressionHelper.GetSqlParameters()[1]);
            Assert.AreEqual(&quot;@test&quot;, modelToSqlExpressionHelper.GetSqlParameters()[2]);
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,26,15,1],[27,13,27,105,1],[28,13,28,94,1],[29,13,29,70,1],[31,13,31,71,1],[33,13,33,78,1],[34,13,34,86,1],[35,9,35,10,1],[39,9,39,10,1],[41,13,41,103,1],[42,13,42,90,1],[43,13,43,70,1],[45,13,45,71,1],[47,13,47,72,1],[48,13,48,87,1],[49,9,49,10,1],[53,9,53,10,1],[55,13,55,52,1],[56,13,56,111,1],[57,13,57,90,1],[58,13,58,70,1],[60,13,60,71,1],[62,13,62,76,1],[63,13,63,88,1],[64,13,64,88,1],[65,9,65,10,1],[69,9,69,10,1],[74,13,74,59,1],[77,13,77,100,1],[78,13,78,47,1],[79,13,79,91,1],[80,13,80,79,1],[81,13,81,84,1],[82,13,82,87,1],[84,13,84,107,1],[85,13,85,47,1],[86,13,86,91,1],[87,13,87,79,1],[88,13,88,84,1],[89,13,89,94,1],[91,9,91,10,1],[95,9,95,10,1],[97,13,97,99,1],[98,13,98,90,1],[99,13,99,70,1],[101,13,101,83,1],[102,13,102,86,1],[103,9,103,10,1],[107,9,107,10,1],[109,13,109,92,1],[110,13,110,90,1],[111,13,111,70,1],[113,13,113,71,1],[115,13,115,72,1],[116,13,116,83,1],[117,9,117,10,1],[121,9,121,10,1],[122,13,122,98,1],[123,13,123,87,1],[124,13,124,70,1],[126,13,126,71,1],[128,13,128,73,1],[129,13,129,98,1],[130,9,130,10,1],[134,9,134,10,1],[135,13,135,103,1],[136,13,136,87,1],[137,13,137,70,1],[139,13,139,71,1],[141,13,141,85,1],[142,13,142,98,1],[143,9,143,10,1],[147,9,147,10,1],[149,13,149,94,1],[151,13,151,104,1],[152,13,152,87,1],[153,13,153,70,1],[155,13,155,71,1],[157,13,157,85,1],[158,13,158,99,1],[160,9,160,10,1],[164,9,164,10,1],[166,13,166,94,1],[168,13,168,107,1],[169,13,169,88,1],[170,13,170,70,1],[172,13,172,70,1],[174,13,174,88,1],[175,13,175,100,1],[176,9,176,10,1],[180,9,180,10,1],[181,13,181,124,1],[182,13,182,87,1],[183,13,183,70,1],[185,13,185,71,1],[187,13,187,90,1],[188,13,188,97,1],[189,13,189,89,1],[190,13,190,88,1],[191,9,191,10,1]]);
    </script>
  </body>
</html>