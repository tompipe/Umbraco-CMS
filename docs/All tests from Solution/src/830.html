<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UI\Pages\UmbracoEnsuredPage.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Web.Security;
using umbraco;
using umbraco.BusinessLogic;
using umbraco.businesslogic.Exceptions;
using Umbraco.Core;
using Umbraco.Core.Security;

namespace Umbraco.Web.UI.Pages
{
    /// &lt;summary&gt;
    /// UmbracoEnsuredPage is the standard protected page in the umbraco backend, and forces authentication.
    /// &lt;/summary&gt;
    public class UmbracoEnsuredPage : BasePage
    {
        public UmbracoEnsuredPage()
        {
            //Assign security automatically if the attribute is found
            var treeAuth = this.GetType().GetCustomAttribute&lt;WebformsPageTreeAuthorizeAttribute&gt;(true);
            if (treeAuth != null)
            {
                var treeByAlias = ApplicationContext.Current.Services.ApplicationTreeService
                    .GetByAlias(treeAuth.TreeAlias);
                if (treeByAlias != null)
                {
                    CurrentApp = treeByAlias.ApplicationAlias;
                }
            }
        }

        private bool _hasValidated = false;

        /// &lt;summary&gt;
        /// Authorizes the user
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// Checks if the page exists outside of the /umbraco route, in which case the request will not have been authenticated for the back office 
        /// so we&#39;ll force authentication.
        /// &lt;/remarks&gt;
        protected override void OnPreInit(EventArgs e)
        {
            base.OnPreInit(e);

            //If this is not a back office request, then the module won&#39;t have authenticated it, in this case we
            // need to do the auth manually and since this is an UmbracoEnsuredPage, this is the anticipated behavior
            // TODO: When we implement Identity, this process might not work anymore, will be an interesting challenge
            if (Context.Request.Url.IsBackOfficeRequest(HttpRuntime.AppDomainAppVirtualPath) == false)
            {
                var http = new HttpContextWrapper(Context);
                var ticket = http.GetUmbracoAuthTicket();
                http.AuthenticateCurrentRequest(ticket, true);
            }

            try
            {
                Security.ValidateCurrentUser(true);
                _hasValidated = true;

                if (!Security.ValidateUserApp(CurrentApp))
                {
                    var ex = new UserAuthorizationException(String.Format(&quot;The current user doesn&#39;t have access to the section/app &#39;{0}&#39;&quot;, CurrentApp));
                    LogHelper.Error&lt;UmbracoEnsuredPage&gt;(String.Format(&quot;Tried to access &#39;{0}&#39;&quot;, CurrentApp), ex);
                    throw ex;
                }

            }
            catch
            {
                // Clear content as .NET transfers rendered content.
                Response.Clear();

                // Some umbraco pages should not be loaded on timeout, but instead reload the main application in the top window. Like the treeview for instance
                if (RedirectToUmbraco)
                    Response.Redirect(SystemDirectories.Umbraco + &quot;/logout.aspx?t=&quot; + Security.GetSessionId(), true);
                else
                    Response.Redirect(SystemDirectories.Umbraco + &quot;/logout.aspx?redir=&quot; + Server.UrlEncode(Request.RawUrl) + &quot;&amp;t=&quot; + Security.GetSessionId(), true);
            }
        }

        /// &lt;summary&gt;
        /// Gets/sets the app that this page is assigned to
        /// &lt;/summary&gt;
        protected string CurrentApp { get; set; }

        /// &lt;summary&gt;
        /// If true then umbraco will force any window/frame to reload umbraco in the main window
        /// &lt;/summary&gt;
        protected bool RedirectToUmbraco { get; set; }
        
        /// &lt;summary&gt;
        /// Returns the current user
        /// &lt;/summary&gt;
        [Obsolete(&quot;This should no longer be used since it returns the legacy user object, use The Security.CurrentUser instead to return the proper user object&quot;)]
        protected User UmbracoUser
        {
            get
            {
                //throw exceptions if not valid (true)
                if (!_hasValidated)
                {
                    Security.ValidateCurrentUser(true);
                    _hasValidated = true;
                }
                
                return new User(Security.CurrentUser);
            }
        }
        
        /// &lt;summary&gt;
        /// Used to assign a webforms page&#39;s security to a specific tree which will in turn check to see
        /// if the current user has access to the specified tree&#39;s registered section
        /// &lt;/summary&gt;
        [AttributeUsage(AttributeTargets.Class)]
        public sealed class WebformsPageTreeAuthorizeAttribute : Attribute
        {
            public string TreeAlias { get; private set; }

            public WebformsPageTreeAuthorizeAttribute(string treeAlias)
            {
                TreeAlias = treeAlias;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,36,0],[21,9,21,10,0],[23,13,23,104,0],[24,13,24,34,0],[25,13,25,14,0],[26,17,27,53,0],[28,17,28,41,0],[29,17,29,18,0],[30,21,30,63,0],[31,17,31,18,0],[32,13,32,14,0],[33,9,33,10,0],[35,9,35,44,0],[46,9,46,10,0],[47,13,47,31,0],[52,13,52,103,0],[53,13,53,14,0],[54,17,54,60,0],[55,17,55,58,0],[56,17,56,63,0],[57,13,57,14,0],[60,13,60,14,0],[61,17,61,52,0],[62,17,62,38,0],[64,17,64,59,0],[65,17,65,18,0],[66,21,66,153,0],[67,21,67,113,0],[68,21,68,30,0],[71,13,71,14,0],[72,13,72,18,0],[73,13,73,14,0],[75,17,75,34,0],[78,17,78,39,0],[79,21,79,118,0],[81,21,81,165,0],[82,13,82,14,0],[83,9,83,10,0],[88,39,88,43,0],[88,44,88,48,0],[93,44,93,48,0],[93,49,93,53,0],[102,13,102,14,0],[104,17,104,36,0],[105,17,105,18,0],[106,21,106,56,0],[107,21,107,42,0],[108,17,108,18,0],[110,17,110,55,0],[111,13,111,14,0],[121,39,121,43,0],[121,44,121,56,0],[123,13,123,72,0],[124,13,124,14,0],[125,17,125,39,0],[126,13,126,14,0]]);
    </script>
  </body>
</html>