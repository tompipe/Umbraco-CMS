<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\ultimatepicker\ultimatePickerDataEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using System.Web.UI;
using System.Web.UI.WebControls;
using umbraco.cms.businesslogic;
using umbraco.interfaces;
using ClientDependency.Core.Controls;
using ClientDependency.Core;

namespace umbraco.editorControls.ultimatepicker
{
    [ValidationProperty(&quot;IsValid&quot;)]
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class ultimatePickerDataEditor : UpdatePanel, IDataEditor
    {
        private IData _data;
        string _configuration;

        private string[] config;
        private string controlType;

        private string[] dataValues;

        private TextBox childtxt;
        private DropDownList dropdownlistNodes;
        private CheckBoxList checkboxlistNodes;
        private RadioButtonList radiobuttonlistNodes;
        private ListBox listboxNodes;
        private Button clearRadiobuttonlist;
        private CheckBox clearRadiobuttons;

        public ultimatePickerDataEditor(umbraco.interfaces.IData Data, string Configuration)
        {
            _data = Data;
            _configuration = Configuration;

            config = _configuration.Split(&quot;|&quot;.ToCharArray());
            controlType = config[0];

            RenderMode = UpdatePanelRenderMode.Inline;
        }

        public virtual bool TreatAsRichTextEditor
        {
            get { return false; }
        }

        public bool ShowLabel
        {
            get { return true; }
        }

        /// &lt;summary&gt;
        /// Internal logic for validation controls to detect whether or not it&#39;s valid (has to be public though) 
        /// &lt;/summary&gt;
        /// &lt;value&gt;Am I valid?&lt;/value&gt;
        public string IsValid
        {
            get
            {
                switch (controlType.ToLower())
                {
                    case &quot;autocomplete&quot;:
                        if (childtxt.Text.Contains(&quot;|&quot;))
                        {
                            return childtxt.Text;
                        }

                        break;
                    case &quot;checkboxlist&quot;:
                        foreach (ListItem item in checkboxlistNodes.Items)
                        {
                            if (item.Selected)
                            {
                                return &quot;valid&quot;;
                            }
                        }
                        break;
                    case &quot;dropdownlist&quot;:
                        return dropdownlistNodes.SelectedValue;
                    case &quot;listbox&quot;:
                        foreach (ListItem item in listboxNodes.Items)
                        {
                            if (item.Selected)
                            {
                                return &quot;valid&quot;;
                            }
                        }
                        break;
                    case &quot;radiobuttonlist&quot;:
                        foreach (ListItem item in radiobuttonlistNodes.Items)
                        {
                            if (item.Selected)
                            {
                                return &quot;valid&quot;;
                            }
                        }

                        break;

                }
                return &quot;&quot;;
            }
        }

        public Control Editor { get { return this; } }

        public void Save()
        {
            string dataToSave = string.Empty;

            switch (controlType)
            {
                case &quot;AutoComplete&quot;:
                    if (childtxt.Text.Contains(&quot;[&quot;) &amp;&amp; childtxt.Text.Contains(&quot;]&quot;))
                    {
                        dataToSave = childtxt.Text.Replace(&quot;]&quot;,&quot;&quot;).Split(&quot;[&quot;.ToCharArray())[1];
                    }

                    
                    break;
                case &quot;auto-suggest&quot;:
                    goto case &quot;AutoComplete&quot;;
                case &quot;CheckBoxList&quot;:

                    foreach (ListItem item in checkboxlistNodes.Items)
                    {
                        if (item.Selected)
                        {
                            dataToSave += item.Value + &quot;,&quot;;
                        }
                    }

                    if (dataToSave.Length &gt; 0)
                    {
                        dataToSave = dataToSave.Substring(0, dataToSave.Length - 1);
                    }


                    break;
                case &quot;checkbox&quot;:
                    goto case &quot;CheckBoxList&quot;;
                case &quot;DropDownList&quot;:
                    dataToSave = dropdownlistNodes.SelectedValue;
                    break;
                case &quot;dropdown&quot;:
                    goto case &quot;DropDownList&quot;;
                case &quot;ListBox&quot;:
                    dataToSave = string.Empty;
                    foreach (ListItem item in listboxNodes.Items)
                    {
                        if (item.Selected)
                        {
                            dataToSave += item.Value + &quot;,&quot;;
                        }
                    }

                    if (dataToSave.Length &gt; 0)
                    {
                        dataToSave = dataToSave.Substring(0, dataToSave.Length - 1);
                    }
                    break;
                case &quot;listbox&quot;:
                    goto case &quot;ListBox&quot;;
                case &quot;RadioButtonList&quot;:
                    dataToSave = string.Empty;

                    if (!clearRadiobuttons.Checked)
                    {
                        foreach (ListItem item in radiobuttonlistNodes.Items)
                        {
                            if (item.Selected)
                            {
                                dataToSave += item.Value + &quot;,&quot;;
                            }
                        }

                        if (dataToSave.Length &gt; 0)
                        {
                            dataToSave = dataToSave.Substring(0, dataToSave.Length - 1);
                        }
                    }
                    else
                    {
                        foreach (ListItem radiobutton in radiobuttonlistNodes.Items)
                        {
                            radiobutton.Selected = false;
                        }

                        clearRadiobuttons.Checked = false;
                    }

                    break;
                case &quot;radiobox&quot;:
                    goto case &quot;RadioButtonList&quot;;

            }
            if (controlType != &quot;auto-suggest&quot; &amp;&amp; controlType != &quot;AutoComplete&quot;)
            {
                this._data.Value = dataToSave;

            }
            else
            {
                if (dataToSave.Length &gt; 0)
                {
                    this._data.Value = dataToSave;
                }else
                {
                    if (childtxt.Text.Trim().Length == 0)
                    {
                        this._data.Value = &quot;&quot;;
                    }
                }
            }
        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            try
            {
                int parentNodeId = Convert.ToInt32(config[1]);
                umbraco.cms.businesslogic.Content parentNode = new umbraco.cms.businesslogic.Content(parentNodeId);
                string documentAliasFilter = config[2];
                string[] documentAliasFilters = documentAliasFilter.Split(&quot;,&quot;.ToCharArray());

                bool showChildren = Convert.ToBoolean(config[3]);

                string[] datavalues = _data.Value.ToString().Split(&quot;,&quot;.ToCharArray());

                switch (controlType)
                {
                    case &quot;AutoComplete&quot;:
                        setupAutoComplete(parentNodeId);
                        break;
                    case &quot;auto-suggest&quot;:
                        goto case &quot;AutoComplete&quot;;
                    case &quot;CheckBoxList&quot;:
                        checkboxlistNodes = new CheckBoxList();
                        //checkboxlistNodes.ID = &quot;nodes&quot;;
                        addListControlNode(parentNode, 1, showChildren, checkboxlistNodes, documentAliasFilters);
                        base.ContentTemplateContainer.Controls.Add(checkboxlistNodes);

                        break;
                    case &quot;checkbox&quot;:
                        goto case &quot;CheckBoxList&quot;;
                    case &quot;DropDownList&quot;:
                        dropdownlistNodes = new DropDownList();
                        //dropdownlistNodes.ID = &quot;nodes&quot;;
                        ListItem empty = new ListItem(&quot;&quot;);
                        dropdownlistNodes.Items.Add(empty);
                        addListControlNode(parentNode, 1, showChildren, dropdownlistNodes, documentAliasFilters);
                        foreach (string datavalue in datavalues)
                        {
                            dropdownlistNodes.SelectedValue = datavalue;
                        }
                        base.ContentTemplateContainer.Controls.Add(dropdownlistNodes);
                        break;
                    case &quot;dropdown&quot;:
                        goto case &quot;DropDownList&quot;;
                    case &quot;ListBox&quot;:
                        listboxNodes = new ListBox();
                        //listboxNodes.ID = &quot;nodes&quot;;
                        listboxNodes.SelectionMode = ListSelectionMode.Multiple;
                        listboxNodes.Width = 300;
                        listboxNodes.Height = 200;

                        addListControlNode(parentNode, 1, showChildren, listboxNodes, documentAliasFilters);
                        base.ContentTemplateContainer.Controls.Add(listboxNodes);
                        break;
                    case &quot;listbox&quot;:
                        goto case &quot;ListBox&quot;;
                    case &quot;RadioButtonList&quot;:
                        radiobuttonlistNodes = new RadioButtonList();
                        radiobuttonlistNodes.AutoPostBack = true;
                        radiobuttonlistNodes.SelectedIndexChanged += new EventHandler(radiobuttonlistNodes_SelectedIndexChanged);
                        //radiobuttonlistNodes.ID = &quot;nodes&quot;;
                        addListControlNode(parentNode, 1, showChildren, radiobuttonlistNodes, documentAliasFilters);

                        clearRadiobuttonlist = new Button();
                        clearRadiobuttonlist.Click += new EventHandler(clearRadiobuttonlist_Click);
                        clearRadiobuttonlist.Text = &quot;Clear&quot;;

                        clearRadiobuttons = new CheckBox();
                        clearRadiobuttons.Visible = false;

                        base.ContentTemplateContainer.Controls.Add(radiobuttonlistNodes);
                        base.ContentTemplateContainer.Controls.Add(clearRadiobuttonlist);
                        base.ContentTemplateContainer.Controls.Add(clearRadiobuttons);
                        break;
                    case &quot;radiobox&quot;:
                        goto case &quot;RadioButtonList&quot;;
                }
            }
            catch { }
        }

        void radiobuttonlistNodes_SelectedIndexChanged(object sender, EventArgs e)
        {
            clearRadiobuttons.Checked = false;
        }

        void clearRadiobuttonlist_Click(object sender, EventArgs e)
        {
           

            foreach (ListItem radiobutton in radiobuttonlistNodes.Items)
            {
                radiobutton.Selected = false;
            }

            clearRadiobuttons.Checked = true;
        }

        

        /// &lt;summary&gt;
        /// Adds sub nodes to the ListControl object passed into the method, based on the Content node passed in
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;node&quot;&gt;The node whos sub nodes are to be added to the ListControl&lt;/param&gt;
        /// &lt;param name=&quot;level&quot;&gt;The level of the current node&lt;/param&gt;
        /// &lt;param name=&quot;showGrandChildren&quot;&gt;Boolean determining if grand children should be displayed as well&lt;/param&gt;
        /// &lt;param name=&quot;control&quot;&gt;The ListControl the nodes must be added to&lt;/param&gt;
        /// &lt;param name=&quot;documentAliasFilter&quot;&gt;String representing the documentTypeAlias that should be filtered for. If empty no filter is applied&lt;/param&gt;
        private void addListControlNode(umbraco.cms.businesslogic.Content node, int level, bool showGrandChildren, ListControl control, string[] documentAliasFilters)
        {
            if (node.HasChildren)
            {
                //store children array here because iterating over an Array property object is very inneficient.
                var c = node.Children;
                foreach (CMSNode child in c)
                {
                    umbraco.cms.businesslogic.Content doc = new umbraco.cms.businesslogic.Content(child.Id);
                    string preText = string.Empty;

                    for (int i = 1; i &lt; level; i++)
                    {
                        preText += &quot;- &quot;;
                    }

                    //Run through the filters passed in
                    if (documentAliasFilters.Length &gt; 0)
                    {
                        foreach (string filter in documentAliasFilters)
                        {
                            string trimmedFilter = filter.TrimStart(&quot; &quot;.ToCharArray());
                            trimmedFilter = trimmedFilter.TrimEnd(&quot; &quot;.ToCharArray());

                            if (doc.ContentType.Alias == trimmedFilter || trimmedFilter == string.Empty)
                            {
                                ListItem item = new ListItem(preText + doc.Text, doc.Id.ToString());
                                if (_data.Value.ToString().Contains(doc.Id.ToString()))
                                {
                                    item.Selected = true;
                                }
                                control.Items.Add(item);
                            }
                        }
                    }
                    else
                    {
                        ListItem item = new ListItem(preText + doc.Text, doc.Id.ToString());
                        if (_data.Value.ToString().Contains(doc.Id.ToString()))
                        {
                            item.Selected = true;
                        }
                        control.Items.Add(item);
                    }

                    if (showGrandChildren)
                    {
                        addListControlNode(doc, level + 1, showGrandChildren, control, documentAliasFilters);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// Sets up the autocomplete functionality
        /// &lt;/summary&gt;
        private void setupAutoComplete(int parentNodeId)
        {
            ClientDependencyLoader.Instance.RegisterDependency(&quot;Application/JQuery/jquery.autocomplete.js&quot;, &quot;UmbracoClient&quot;, ClientDependencyType.Javascript);
            ClientDependencyLoader.Instance.RegisterDependency(&quot;css/umbracoGui.css&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Css);

            
            childtxt = new TextBox();
            childtxt.ID = &quot;ultimatePickerBox&quot; + base.ID;
            childtxt.AutoCompleteType = AutoCompleteType.Disabled;
            childtxt.CssClass = &quot;umbEditorTextField&quot;;

            if (_data.Value.ToString().Length &gt; 3)
            {
                try
                {
                    CMSNode firstSaved = new CMSNode(Convert.ToInt32(_data.Value.ToString()));
                    childtxt.Text = firstSaved.Text;
                }
                catch
                {

                }
            }

            base.ContentTemplateContainer.Controls.Add(childtxt);


            string autoCompleteScript =
                 &quot;jQuery(\&quot;#&quot;
                 + childtxt.ClientID + &quot;\&quot;).autocomplete(\&quot;&quot;
                 + Umbraco.Core.IO.IOHelper.ResolveUrl(Umbraco.Core.IO.SystemDirectories.Umbraco)
                 + &quot;/webservices/UltimatePickerAutoCompleteHandler.ashx\&quot;,{minChars: 2,max: 100, extraParams:{id:\&quot;&quot; + parentNodeId.ToString() + &quot;\&quot;,showchildren:\&quot;&quot; + config[3] + &quot;\&quot;,filter:\&quot;&quot; + config[2] + &quot;\&quot;,rnd:\&quot;&quot; + DateTime.Now.Ticks + &quot;\&quot;}});&quot;;


            string autoCompleteInitScript =
                &quot;jQuery(document).ready(function(){&quot;
                + autoCompleteScript
                + &quot;});&quot;;

            Page.ClientScript.RegisterStartupScript(GetType(), ClientID + &quot;_ultimatepickerinit&quot;, autoCompleteInitScript, true);

            if (Page.IsPostBack)
            {
                ScriptManager.RegisterClientScriptBlock(this, GetType(), ClientID + &quot;_ultimatepicker&quot;, autoCompleteScript, true);

            }

        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,9,32,93,0],[33,9,33,10,0],[34,13,34,26,0],[35,13,35,44,0],[37,13,37,62,0],[38,13,38,37,0],[40,13,40,55,0],[41,9,41,10,0],[45,17,45,18,0],[45,19,45,32,0],[45,33,45,34,0],[50,17,50,18,0],[50,19,50,31,0],[50,32,50,33,0],[60,13,60,14,0],[61,17,61,47,0],[64,25,64,57,0],[65,25,65,26,0],[66,29,66,50,0],[69,25,69,31,0],[71,25,71,32,0],[71,34,71,47,0],[71,48,71,50,0],[71,51,71,74,0],[72,25,72,26,0],[73,29,73,47,0],[74,29,74,30,0],[75,33,75,48,0],[77,25,77,26,0],[78,25,78,31,0],[80,25,80,64,0],[82,25,82,32,0],[82,34,82,47,0],[82,48,82,50,0],[82,51,82,69,0],[83,25,83,26,0],[84,29,84,47,0],[85,29,85,30,0],[86,33,86,48,0],[88,25,88,26,0],[89,25,89,31,0],[91,25,91,32,0],[91,34,91,47,0],[91,48,91,50,0],[91,51,91,77,0],[92,25,92,26,0],[93,29,93,47,0],[94,29,94,30,0],[95,33,95,48,0],[97,25,97,26,0],[99,25,99,31,0],[102,17,102,27,0],[103,13,103,14,0],[106,37,106,38,0],[106,39,106,51,0],[106,52,106,53,0],[109,9,109,10,0],[110,13,110,46,0],[112,13,112,33,0],[115,21,115,84,0],[116,21,116,22,0],[117,25,117,96,0],[118,21,118,22,0],[121,21,121,27,0],[123,21,123,46,0],[126,21,126,28,0],[126,30,126,43,0],[126,44,126,46,0],[126,47,126,70,0],[127,21,127,22,0],[128,25,128,43,0],[129,25,129,26,0],[130,29,130,60,0],[131,25,131,26,0],[132,21,132,22,0],[134,21,134,47,0],[135,21,135,22,0],[136,25,136,85,0],[137,21,137,22,0],[140,21,140,27,0],[142,21,142,46,0],[144,21,144,66,0],[145,21,145,27,0],[147,21,147,46,0],[149,21,149,47,0],[150,21,150,28,0],[150,30,150,43,0],[150,44,150,46,0],[150,47,150,65,0],[151,21,151,22,0],[152,25,152,43,0],[153,25,153,26,0],[154,29,154,60,0],[155,25,155,26,0],[156,21,156,22,0],[158,21,158,47,0],[159,21,159,22,0],[160,25,160,85,0],[161,21,161,22,0],[162,21,162,27,0],[164,21,164,41,0],[166,21,166,47,0],[168,21,168,52,0],[169,21,169,22,0],[170,25,170,32,0],[170,34,170,47,0],[170,48,170,50,0],[170,51,170,77,0],[171,25,171,26,0],[172,29,172,47,0],[173,29,173,30,0],[174,33,174,64,0],[175,29,175,30,0],[176,25,176,26,0],[178,25,178,51,0],[179,25,179,26,0],[180,29,180,89,0],[181,25,181,26,0],[182,21,182,22,0],[184,21,184,22,0],[185,25,185,32,0],[185,34,185,54,0],[185,55,185,57,0],[185,58,185,84,0],[186,25,186,26,0],[187,29,187,58,0],[188,25,188,26,0],[190,25,190,59,0],[191,21,191,22,0],[193,21,193,27,0],[195,21,195,49,0],[198,13,198,80,0],[199,13,199,14,0],[200,17,200,47,0],[202,13,202,14,0],[204,13,204,14,0],[205,17,205,43,0],[206,17,206,18,0],[207,21,207,51,0],[208,17,208,18,0],[209,17,209,18,0],[210,21,210,58,0],[211,21,211,22,0],[212,25,212,47,0],[213,21,213,22,0],[214,17,214,18,0],[215,13,215,14,0],[216,9,216,10,0],[219,9,219,10,0],[220,13,220,28,0],[223,13,223,14,0],[224,17,224,63,0],[225,17,225,116,0],[226,17,226,56,0],[227,17,227,94,0],[229,17,229,66,0],[231,17,231,87,0],[233,17,233,37,0],[236,25,236,57,0],[237,25,237,31,0],[239,25,239,50,0],[241,25,241,64,0],[243,25,243,114,0],[244,25,244,87,0],[246,25,246,31,0],[248,25,248,50,0],[250,25,250,64,0],[252,25,252,59,0],[253,25,253,60,0],[254,25,254,114,0],[255,25,255,32,0],[255,34,255,50,0],[255,51,255,53,0],[255,54,255,64,0],[256,25,256,26,0],[257,29,257,73,0],[258,25,258,26,0],[259,25,259,87,0],[260,25,260,31,0],[262,25,262,50,0],[264,25,264,54,0],[266,25,266,81,0],[267,25,267,50,0],[268,25,268,51,0],[270,25,270,109,0],[271,25,271,82,0],[272,25,272,31,0],[274,25,274,45,0],[276,25,276,70,0],[277,25,277,66,0],[278,25,278,130,0],[280,25,280,117,0],[282,25,282,61,0],[283,25,283,100,0],[284,25,284,61,0],[286,25,286,60,0],[287,25,287,59,0],[289,25,289,90,0],[290,25,290,90,0],[291,25,291,87,0],[292,25,292,31,0],[294,25,294,53,0],[296,13,296,14,0],[297,13,297,18,0],[297,19,297,20,0],[297,21,297,22,0],[298,9,298,10,0],[301,9,301,10,0],[302,13,302,47,0],[303,9,303,10,0],[306,9,306,10,0],[309,13,309,20,0],[309,22,309,42,0],[309,43,309,45,0],[309,46,309,72,0],[310,13,310,14,0],[311,17,311,46,0],[312,13,312,14,0],[314,13,314,46,0],[315,9,315,10,0],[328,9,328,10,0],[329,13,329,34,0],[330,13,330,14,0],[332,17,332,39,0],[333,17,333,24,0],[333,26,333,39,0],[333,40,333,42,0],[333,43,333,44,0],[334,17,334,18,0],[335,21,335,109,0],[336,21,336,51,0],[338,26,338,35,0],[338,37,338,46,0],[338,48,338,51,0],[339,21,339,22,0],[340,25,340,41,0],[341,21,341,22,0],[344,21,344,57,0],[345,21,345,22,0],[346,25,346,32,0],[346,34,346,47,0],[346,48,346,50,0],[346,51,346,71,0],[347,25,347,26,0],[348,29,348,88,0],[349,29,349,86,0],[351,29,351,105,0],[352,29,352,30,0],[353,33,353,101,0],[354,33,354,88,0],[355,33,355,34,0],[356,37,356,58,0],[357,33,357,34,0],[358,33,358,57,0],[359,29,359,30,0],[360,25,360,26,0],[361,21,361,22,0],[363,21,363,22,0],[364,25,364,93,0],[365,25,365,80,0],[366,25,366,26,0],[367,29,367,50,0],[368,25,368,26,0],[369,25,369,49,0],[370,21,370,22,0],[372,21,372,43,0],[373,21,373,22,0],[374,25,374,110,0],[375,21,375,22,0],[376,17,376,18,0],[377,13,377,14,0],[378,9,378,10,0],[384,9,384,10,0],[385,13,385,159,0],[386,13,386,127,0],[389,13,389,38,0],[390,13,390,57,0],[391,13,391,67,0],[392,13,392,54,0],[394,13,394,51,0],[395,13,395,14,0],[397,17,397,18,0],[398,21,398,95,0],[399,21,399,53,0],[400,17,400,18,0],[401,17,401,22,0],[402,17,402,18,0],[404,17,404,18,0],[405,13,405,14,0],[407,13,407,66,0],[410,13,414,254,0],[417,13,420,25,0],[422,13,422,128,0],[424,13,424,33,0],[425,13,425,14,0],[426,17,426,130,0],[428,13,428,14,0],[430,9,430,10,0]]);
    </script>
  </body>
</html>