<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\TemplatesTreeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net.Http.Formatting;
using System.Web.Services.Description;
using umbraco;
using umbraco.BusinessLogic.Actions;
using umbraco.cms.businesslogic.template;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Models;
using Umbraco.Web.Models.Trees;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi.Filters;
using Constants = Umbraco.Core.Constants;

namespace Umbraco.Web.Trees
{
    [UmbracoTreeAuthorize(Constants.Trees.Templates)]
    [LegacyBaseTree(typeof (loadTemplates))]
    [Tree(Constants.Applications.Settings, Constants.Trees.Templates, &quot;Templates&quot;, sortOrder:1)]
    [PluginController(&quot;UmbracoTrees&quot;)]
    [CoreTree]
    public class TemplatesTreeController : TreeController
    {
        /// &lt;summary&gt;
        /// The method called to render the contents of the tree structure
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;
        /// All of the query string parameters passed from jsTree
        /// &lt;/param&gt;
        /// &lt;remarks&gt;
        /// We are allowing an arbitrary number of query strings to be pased in so that developers are able to persist custom data from the front-end
        /// to the back end to be used in the query for model data.
        /// &lt;/remarks&gt;
        protected override TreeNodeCollection GetTreeNodes(string id, FormDataCollection queryStrings)
        {
            var nodes = new TreeNodeCollection();

            var found = id == Constants.System.Root.ToInvariantString() 
                ? Services.FileService.GetTemplates(-1) 
                : Services.FileService.GetTemplates(int.Parse(id));

            nodes.AddRange(found.Select(template =&gt; CreateTreeNode(
                template.Id.ToString(CultureInfo.InvariantCulture),
                //TODO: Fix parent ID stuff for templates
                &quot;-1&quot;,
                queryStrings,
                template.Name,
                template.IsMasterTemplate ? &quot;icon-newspaper&quot; : &quot;icon-newspaper-alt&quot;,
                template.IsMasterTemplate,
                GetEditorPath(template, queryStrings))));

            return nodes;
        }

        /// &lt;summary&gt;
        /// Returns the menu structure for the node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected override MenuItemCollection GetMenuForNode(string id, FormDataCollection queryStrings)
        {
            var menu = new MenuItemCollection();

            if (id == Constants.System.Root.ToInvariantString())
            {
                //Create the normal create action
                menu.Items.Add&lt;ActionNew&gt;(ui.Text(&quot;actions&quot;, ActionNew.Instance.Alias))
                    //Since we haven&#39;t implemented anything for templates in angular, this needs to be converted to 
                    //use the legacy format
                    .ConvertLegacyMenuItem(null, &quot;inittemplates&quot;, queryStrings.GetValue&lt;string&gt;(&quot;application&quot;));

                //refresh action
                menu.Items.Add&lt;RefreshNode, ActionRefresh&gt;(ui.Text(&quot;actions&quot;, ActionRefresh.Instance.Alias), true);

                return menu;
            }

            var template = Services.FileService.GetTemplate(int.Parse(id));
            if (template == null) return new MenuItemCollection();
            var entity = FromTemplate(template);

            //Create the create action for creating sub layouts
            menu.Items.Add&lt;ActionNew&gt;(ui.Text(&quot;actions&quot;, ActionNew.Instance.Alias))
                //Since we haven&#39;t implemented anything for templates in angular, this needs to be converted to 
                //use the legacy format
                .ConvertLegacyMenuItem(entity, &quot;templates&quot;, queryStrings.GetValue&lt;string&gt;(&quot;application&quot;));

            //don&#39;t allow delete if it has child layouts
            if (template.IsMasterTemplate == false)
            {
                //add delete option if it doesn&#39;t have children
                menu.Items.Add&lt;ActionDelete&gt;(ui.Text(&quot;actions&quot;, ActionDelete.Instance.Alias), true)
                    //Since we haven&#39;t implemented anything for languages in angular, this needs to be converted to 
                    //use the legacy format
                    .ConvertLegacyMenuItem(entity, &quot;templates&quot;, queryStrings.GetValue&lt;string&gt;(&quot;application&quot;));
            }

            //add refresh
            menu.Items.Add&lt;RefreshNode, ActionRefresh&gt;(ui.Text(&quot;actions&quot;, ActionRefresh.Instance.Alias), true);
            

            return menu;
        }

        private UmbracoEntity FromTemplate(ITemplate template)
        {
            return new UmbracoEntity
            {
                CreateDate = template.CreateDate,
                Id = template.Id,
                Key = template.Key,
                Name = template.Name,
                NodeObjectTypeId = new Guid(Constants.ObjectTypes.Template),
                //TODO: Fix parent/paths on templates
                ParentId = -1,
                Path = template.Path,
                UpdateDate = template.UpdateDate
            };
        }

        private string GetEditorPath(ITemplate template, FormDataCollection queryStrings)
        {
            //TODO: Rebuild the language editor in angular, then we dont need to have this at all (which is just a path to the legacy editor)

            return Services.FileService.DetermineTemplateRenderingEngine(template) == RenderingEngine.WebForms
                ? &quot;/&quot; + queryStrings.GetValue&lt;string&gt;(&quot;application&quot;) + &quot;/framed/&quot; +
                  Uri.EscapeDataString(&quot;settings/editTemplate.aspx?templateID=&quot; + template.Id)
                : &quot;/&quot; + queryStrings.GetValue&lt;string&gt;(&quot;application&quot;) + &quot;/framed/&quot; +
                  Uri.EscapeDataString(&quot;settings/Views/EditView.aspx?treeType=&quot; + Constants.Trees.Templates + &quot;&amp;templateID=&quot; + template.Id);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[41,9,41,10,0],[42,13,42,50,0],[44,13,46,68,0],[48,13,48,53,0],[48,53,56,55,0],[56,55,56,58,0],[48,13,56,58,0],[58,13,58,26,0],[59,9,59,10,0],[68,9,68,10,0],[69,13,69,49,0],[71,13,71,65,0],[72,13,72,14,0],[74,17,77,113,0],[80,17,80,116,0],[82,17,82,29,0],[85,13,85,76,0],[86,13,86,34,0],[86,35,86,67,0],[87,13,87,49,0],[90,13,93,107,0],[96,13,96,52,0],[97,13,97,14,0],[99,17,102,111,0],[103,13,103,14,0],[106,13,106,112,0],[109,13,109,25,0],[110,9,110,10,0],[113,9,113,10,0],[114,13,125,15,0],[126,9,126,10,0],[129,9,129,10,0],[132,13,136,141,0],[137,9,137,10,0]]);
    </script>
  </body>
</html>