<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UrlHelperExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Linq;
using System.Linq.Expressions;
using System.Management.Instrumentation;
using System.Web.Mvc;
using System.Web.Routing;
using ClientDependency.Core.Config;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebServices;

namespace Umbraco.Web
{
    /// &lt;summary&gt;
    /// Extension methods for UrlHelper
    /// &lt;/summary&gt;
    public static class UrlHelperExtensions
    {
        /// &lt;summary&gt;
        /// Returns the base path (not including the &#39;action&#39;) of the MVC controller &quot;ExamineManagementController&quot;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetExamineManagementServicePath(this UrlHelper url)
        {
            var result = url.GetUmbracoApiService&lt;ExamineManagementApiController&gt;(&quot;GetIndexerDetails&quot;);
            return result.TrimEnd(&quot;GetIndexerDetails&quot;).EnsureEndsWith(&#39;/&#39;);
        }

        /// &lt;summary&gt;
        /// Return the Url for a Web Api service
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;actionName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;routeVals&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetUmbracoApiService&lt;T&gt;(this UrlHelper url, string actionName, RouteValueDictionary routeVals = null)
            where T : UmbracoApiController
        {
            return url.GetUmbracoApiService(actionName, typeof(T), routeVals);
        }

        /// &lt;summary&gt;
        /// Return the Base Url (not including the action) for a Web Api service
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;actionName&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetUmbracoApiServiceBaseUrl&lt;T&gt;(this UrlHelper url, string actionName)
            where T : UmbracoApiController
        {
            return url.GetUmbracoApiService&lt;T&gt;(actionName).TrimEnd(actionName);
        }

        public static string GetUmbracoApiServiceBaseUrl&lt;T&gt;(this UrlHelper url, Expression&lt;Func&lt;T, object&gt;&gt; methodSelector)
            where T : UmbracoApiController
        {
            var method = Core.ExpressionHelper.GetMethodInfo(methodSelector);
            if (method == null)
            {
                throw new MissingMethodException(&quot;Could not find the method &quot; + methodSelector + &quot; on type &quot; + typeof(T) + &quot; or the result &quot;);
            }
            return url.GetUmbracoApiService&lt;T&gt;(method.Name).TrimEnd(method.Name);
        }

        public static string GetUmbracoApiService&lt;T&gt;(this UrlHelper url, Expression&lt;Func&lt;T, object&gt;&gt; methodSelector)
            where T : UmbracoApiController
        {
            var method = Core.ExpressionHelper.GetMethodInfo(methodSelector);
            if (method == null)
            {
                throw new MissingMethodException(&quot;Could not find the method &quot; + methodSelector + &quot; on type &quot; + typeof(T) + &quot; or the result &quot;);
            }
            var parameters = Core.ExpressionHelper.GetMethodParams(methodSelector);
            var routeVals = new RouteValueDictionary(parameters);
            return url.GetUmbracoApiService&lt;T&gt;(method.Name, routeVals);
        }

        /// &lt;summary&gt;
        /// Return the Url for a Web Api service
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;actionName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;apiControllerType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;routeVals&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetUmbracoApiService(this UrlHelper url, string actionName, Type apiControllerType, RouteValueDictionary routeVals = null)
        {
            Mandate.ParameterNotNullOrEmpty(actionName, &quot;actionName&quot;);
            Mandate.ParameterNotNull(apiControllerType, &quot;apiControllerType&quot;);

            var area = &quot;&quot;;

            var apiController = UmbracoApiControllerResolver.Current.RegisteredUmbracoApiControllers
                .SingleOrDefault(x =&gt; x == apiControllerType);
            if (apiController == null)
                throw new InvalidOperationException(&quot;Could not find the umbraco api controller of type &quot; + apiControllerType.FullName);
            var metaData = PluginController.GetMetadata(apiController);
            if (!metaData.AreaName.IsNullOrWhiteSpace())
            {
                //set the area to the plugin area
                area = metaData.AreaName;
            }
            return url.GetUmbracoApiService(actionName, ControllerExtensions.GetControllerName(apiControllerType), area, routeVals);
        }

        /// &lt;summary&gt;
        /// Return the Url for a Web Api service
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;actionName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;routeVals&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetUmbracoApiService(this UrlHelper url, string actionName, string controllerName, RouteValueDictionary routeVals = null)
        {
            return url.GetUmbracoApiService(actionName, controllerName, &quot;&quot;, routeVals);
        }

        /// &lt;summary&gt;
        /// Return the Url for a Web Api service
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;actionName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;routeVals&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetUmbracoApiService(this UrlHelper url, string actionName, string controllerName, string area, RouteValueDictionary routeVals = null)
        {
            Mandate.ParameterNotNullOrEmpty(controllerName, &quot;controllerName&quot;);
            Mandate.ParameterNotNullOrEmpty(actionName, &quot;actionName&quot;);

            if (routeVals == null)
            {
                routeVals = new RouteValueDictionary(new {httproute = &quot;&quot;, area = area});
            }
            else
            {
                var requiredRouteVals = new RouteValueDictionary(new { httproute = &quot;&quot;, area = area });
                requiredRouteVals.MergeLeft(routeVals);
                //copy it back now
                routeVals = requiredRouteVals;
            }

            return url.Action(actionName, controllerName, routeVals);
        }


        /// &lt;summary&gt;
        /// Return the Url for an action with a cache-busting hash appended
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;actionName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;routeVals&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetUrlWithCacheBust(this UrlHelper url, string actionName, string controllerName, RouteValueDictionary routeVals = null)
        {
            var applicationJs = url.Action(actionName, controllerName, routeVals);          
            applicationJs = applicationJs + &quot;?umb__rnd=&quot; + GetCacheBustHash();
            return applicationJs;
        }

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetCacheBustHash()
        {
            //make a hash of umbraco and client dependency version
            //in case the user bypasses the installer and just bumps the web.config or clientdep config
            
            var versionHash = new HashCodeCombiner();

            //if in debug mode, always burst the cache
            if (GlobalSettings.DebugMode)
            {
                versionHash.AddCaseInsensitiveString(DateTime.Now.Ticks.ToString(CultureInfo.InvariantCulture));
            }
            else
            {
                //create a unique hash code of the current umb version and the current cdf version
                
                versionHash.AddCaseInsensitiveString(UmbracoVersion.Current.ToString());
                versionHash.AddCaseInsensitiveString(ClientDependencySettings.Instance.Version.ToString(CultureInfo.InvariantCulture));                
            }

            return versionHash.GetCombinedHashCode();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[29,13,29,104,0],[30,13,30,76,0],[31,9,31,10,0],[43,9,43,10,0],[44,13,44,79,0],[45,9,45,10,0],[56,9,56,10,0],[57,13,57,80,0],[58,9,58,10,0],[62,9,62,10,0],[63,13,63,78,0],[64,13,64,32,0],[65,13,65,14,0],[66,17,66,143,0],[68,13,68,82,0],[69,9,69,10,0],[73,9,73,10,0],[74,13,74,78,0],[75,13,75,32,0],[76,13,76,14,0],[77,17,77,143,0],[79,13,79,84,0],[80,13,80,66,0],[81,13,81,72,0],[82,9,82,10,0],[93,9,93,10,0],[94,13,94,71,0],[95,13,95,78,0],[97,13,97,27,0],[99,13,100,39,0],[100,39,100,61,0],[100,61,100,63,0],[99,13,100,63,0],[101,13,101,39,0],[102,17,102,136,0],[103,13,103,72,0],[104,13,104,57,0],[105,13,105,14,0],[107,17,107,42,0],[108,13,108,14,0],[109,13,109,133,0],[110,9,110,10,0],[121,9,121,10,0],[122,13,122,88,0],[123,9,123,10,0],[135,9,135,10,0],[136,13,136,79,0],[137,13,137,71,0],[139,13,139,35,0],[140,13,140,14,0],[141,17,141,89,0],[142,13,142,14,0],[144,13,144,14,0],[145,17,145,103,0],[146,17,146,56,0],[148,17,148,47,0],[149,13,149,14,0],[151,13,151,70,0],[152,9,152,10,0],[164,9,164,10,0],[165,13,165,83,0],[166,13,166,79,0],[167,13,167,34,0],[168,9,168,10,0],[175,9,175,10,0],[179,13,179,54,0],[182,13,182,42,0],[183,13,183,14,0],[184,17,184,113,0],[185,13,185,14,0],[187,13,187,14,0],[190,17,190,89,0],[191,17,191,136,0],[192,13,192,14,0],[194,13,194,54,0],[195,9,195,10,0]]);
    </script>
  </body>
</html>