<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\EnsurePublishedContentRequestAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Linq;
using System.Web.Mvc;
using Umbraco.Core.Models;
using Umbraco.Web.Routing;
using Umbraco.Core;
using Language = umbraco.cms.businesslogic.language.Language;

namespace Umbraco.Web.Mvc
{
    /// &lt;summary&gt;
    /// Used for custom routed pages that are being integrated with the Umbraco data but are not
    /// part of the umbraco request pipeline. This allows umbraco macros to be able to execute in this scenario.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This is inspired from this discussion:
    /// http://our.umbraco.org/forum/developers/extending-umbraco/41367-Umbraco-6-MVC-Custom-MVC-Route?p=3
    /// 
    /// which is based on custom routing found here:
    /// http://shazwazza.com/post/Custom-MVC-routing-in-Umbraco
    /// &lt;/remarks&gt;
    public class EnsurePublishedContentRequestAttribute : ActionFilterAttribute
    {
        private readonly string _dataTokenName;
        private readonly string _culture;
        private UmbracoContext _umbracoContext;
        private readonly int? _contentId;
        private UmbracoHelper _helper;

        /// &lt;summary&gt;
        /// Constructor - can be used for testing
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;contentId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;culture&quot;&gt;&lt;/param&gt;
        public EnsurePublishedContentRequestAttribute(UmbracoContext umbracoContext, int contentId, string culture = null)
        {
            if (umbracoContext == null) throw new ArgumentNullException(&quot;umbracoContext&quot;);
            _umbracoContext = umbracoContext;
            _contentId = contentId;
            _culture = culture;
        }

        /// &lt;summary&gt;
        /// A constructor used to set an explicit content Id to the PublishedContentRequest that will be created
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentId&quot;&gt;&lt;/param&gt;
        public EnsurePublishedContentRequestAttribute(int contentId)
        {
            _contentId = contentId;
        }

        /// &lt;summary&gt;
        /// A constructor used to set the data token key name that contains a reference to a PublishedContent instance
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataTokenName&quot;&gt;&lt;/param&gt;
        public EnsurePublishedContentRequestAttribute(string dataTokenName)
        {
            _dataTokenName = dataTokenName;
        }

        /// &lt;summary&gt;
        /// Constructor - can be used for testing
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTokenName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;culture&quot;&gt;&lt;/param&gt;
        public EnsurePublishedContentRequestAttribute(UmbracoContext umbracoContext, string dataTokenName, string culture = null)
        {
            if (umbracoContext == null) throw new ArgumentNullException(&quot;umbracoContext&quot;);
            _umbracoContext = umbracoContext;
            _dataTokenName = dataTokenName;
            _culture = culture;
        }

        /// &lt;summary&gt;
        /// Exposes the UmbracoContext
        /// &lt;/summary&gt;
        protected UmbracoContext UmbracoContext
        {
            get { return _umbracoContext ?? (_umbracoContext = UmbracoContext.Current); }
        }

        /// &lt;summary&gt;
        /// Exposes an UmbracoHelper
        /// &lt;/summary&gt;
        protected UmbracoHelper Umbraco
        {
            get { return _helper ?? (_helper = new UmbracoHelper(UmbracoContext.Current)); }
        }

        public override void OnActionExecuted(ActionExecutedContext filterContext)
        {
            base.OnActionExecuted(filterContext);

            //First we need to check if the pcr has been set, if it has we&#39;re going to ignore this and not actually do anything
            if (UmbracoContext.Current.PublishedContentRequest != null)
            {
                return;
            }

            UmbracoContext.Current.PublishedContentRequest =
                new PublishedContentRequest(
                    UmbracoContext.Current.CleanedUmbracoUrl, UmbracoContext.Current.RoutingContext);

            ConfigurePublishedContentRequest(UmbracoContext.Current.PublishedContentRequest, filterContext);
        }

        /// &lt;summary&gt;
        /// This assigns the published content to the request, developers can override this to specify 
        /// any other custom attributes required.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pcr&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;filterContext&quot;&gt;&lt;/param&gt;
        protected virtual void ConfigurePublishedContentRequest(PublishedContentRequest pcr, ActionExecutedContext filterContext)
        {
            if (_contentId.HasValue)
            {
                var content = Umbraco.TypedContent(_contentId);
                if (content == null)
                {
                    throw new InvalidOperationException(&quot;Could not resolve content with id &quot; + _contentId);
                }
                pcr.PublishedContent = content;
            }
            else if (_dataTokenName.IsNullOrWhiteSpace() == false)
            {
                var result = filterContext.RouteData.DataTokens[_dataTokenName];
                if (result == null)
                {
                    throw new InvalidOperationException(&quot;No data token could be found with the name &quot; + _dataTokenName);
                }
                if ((result is IPublishedContent) == false)
                {
                    throw new InvalidOperationException(&quot;The data token resolved with name &quot; + _dataTokenName + &quot; was not an instance of &quot; + typeof(IPublishedContent));
                }
                pcr.PublishedContent = (IPublishedContent) result;
            }

            pcr.Prepare();
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[37,9,37,123,0],[38,9,38,10,0],[39,13,39,40,0],[39,41,39,91,0],[40,13,40,46,0],[41,13,41,36,0],[42,13,42,32,0],[43,9,43,10,0],[49,9,49,69,0],[50,9,50,10,0],[51,13,51,36,0],[52,9,52,10,0],[58,9,58,76,0],[59,9,59,10,0],[60,13,60,44,0],[61,9,61,10,0],[69,9,69,130,0],[70,9,70,10,0],[71,13,71,40,0],[71,41,71,91,0],[72,13,72,46,0],[73,13,73,44,0],[74,13,74,32,0],[75,9,75,10,0],[82,17,82,18,0],[82,19,82,88,0],[82,89,82,90,0],[90,17,90,18,0],[90,19,90,91,0],[90,92,90,93,0],[94,9,94,10,0],[95,13,95,50,0],[98,13,98,72,0],[99,13,99,14,0],[100,17,100,24,0],[103,13,105,102,0],[107,13,107,109,0],[108,9,108,10,0],[117,9,117,10,0],[118,13,118,37,0],[119,13,119,14,0],[120,17,120,64,0],[121,17,121,37,0],[122,17,122,18,0],[123,21,123,108,0],[125,17,125,48,0],[126,13,126,14,0],[127,18,127,67,0],[128,13,128,14,0],[129,17,129,81,0],[130,17,130,36,0],[131,17,131,18,0],[132,21,132,121,0],[134,17,134,60,0],[135,17,135,18,0],[136,21,136,169,0],[138,17,138,67,0],[139,13,139,14,0],[141,13,141,27,0],[142,9,142,10,0]]);
    </script>
  </body>
</html>