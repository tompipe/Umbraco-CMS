<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\media\UmbracoMediaFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text.RegularExpressions;
using System.Threading;
using System.Xml;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using umbraco.BusinessLogic;
using Umbraco.Core;

namespace umbraco.cms.businesslogic.media
{
    [Obsolete(&quot;This is no longer used and will be removed from the codebase in future versions&quot;)]
    public abstract class UmbracoMediaFactory : IMediaFactory
    {
        public abstract List&lt;string&gt; Extensions { get; }
        public virtual int Priority { get { return 1000; } }
        public abstract string MediaTypeAlias { get; }

        internal readonly MediaFileSystem FileSystem;

        protected UmbracoMediaFactory()
        {
            FileSystem = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();
        }

        public virtual bool CanHandleMedia(int parentNodeId, PostedMediaFile postedFile, User user)
        {
            try
            {
                var parentNode = new Media(parentNodeId);

                return parentNodeId &lt;= -1 || user.Applications.Any(app =&gt; app.alias.ToLower() == Constants.Applications.Media) &amp;&amp; (user.StartMediaId &lt;= 0 || (&quot;,&quot; + parentNode.Path + &quot;,&quot;).Contains(&quot;,&quot; + user.StartMediaId + &quot;,&quot;)) &amp;&amp; parentNode.ContentType.AllowedChildContentTypeIDs.Contains(MediaType.GetByAlias(MediaTypeAlias).Id);
            }
            catch
            {
                return false;
            }
        }

        public Media HandleMedia(int parentNodeId, PostedMediaFile postedFile, User user)
        {
            // Check to see if a file exists
            Media media;
            string mediaName = !string.IsNullOrEmpty(postedFile.DisplayName)
                ? postedFile.DisplayName
                : ExtractTitleFromFileName(postedFile.FileName);

            if (postedFile.ReplaceExisting &amp;&amp; TryFindExistingMedia(parentNodeId, postedFile.FileName, out media))
            {
                // Do nothing as existing media is returned
            }
            else
            {
                media = Media.MakeNew(mediaName,
                    MediaType.GetByAlias(MediaTypeAlias),
                    user,
                    parentNodeId);
            }

            if (postedFile.ContentLength &gt; 0)
                DoHandleMedia(media, postedFile, user);

            media.XmlGenerate(new XmlDocument());

            return media;
        }

        [Obsolete(&quot;Use HandleMedia(int, PostedMediaFile, User) and set the ReplaceExisting property on PostedMediaFile instead&quot;)]
        public Media HandleMedia(int parentNodeId, PostedMediaFile postedFile, User user, bool replaceExisting)
        {
            postedFile.ReplaceExisting = replaceExisting;

            return HandleMedia(parentNodeId, postedFile, user);
        }

        public abstract void DoHandleMedia(Media media, PostedMediaFile uploadedFile, User user);

        #region Helper Methods

        public bool TryFindExistingMedia(int parentNodeId, string fileName, out Media existingMedia)
        {
            var children = parentNodeId == -1 ? Media.GetRootMedias() : new Media(parentNodeId).Children;
            foreach (var childMedia in children)
            {
                if (childMedia.ContentType.Alias == MediaTypeAlias)
                {
                    var prop = childMedia.getProperty(Constants.Conventions.Media.File);
                    if (prop != null &amp;&amp; prop.Value != null)
                    {
                        int subfolderId;
                        var currentValue = prop.Value.ToString();

                        var subfolder = UmbracoConfig.For.UmbracoSettings().Content.UploadAllowDirectories
                            ? currentValue.Replace(FileSystem.GetUrl(&quot;/&quot;), &quot;&quot;).Split(&#39;/&#39;)[0]
                            : currentValue.Substring(currentValue.LastIndexOf(&quot;/&quot;, StringComparison.Ordinal) + 1).Split(&#39;-&#39;)[0];
                        
                        if (int.TryParse(subfolder, out subfolderId))
                        {
                            var destFilePath = FileSystem.GetRelativePath(subfolderId, fileName);
                            var destFileUrl = FileSystem.GetUrl(destFilePath);

                            if (prop.Value.ToString() == destFileUrl)
                            {
                                existingMedia = childMedia;
                                return true;
                            }
                        }
                    }
                }
            }

            existingMedia = null;
            return false;
        }

        private string ExtractTitleFromFileName(string fileName)
        {
            // change the name
            var curName = fileName.Substring(0, fileName.LastIndexOf(&quot;.&quot;, StringComparison.Ordinal)).ToCharArray();
            var curNameLength = curName.Length;
            var friendlyName = String.Empty;

            for (var i = 0; i &lt; curNameLength; i++)
            {
                var currentChar = curName[i];
                var currentString = String.Empty;
                
                if (Char.IsSeparator(currentChar) || Char.IsWhiteSpace(currentChar) || (Char.IsPunctuation(currentChar) 
                    &amp;&amp; (currentChar == &#39;_&#39; || currentChar == &#39;-&#39; || currentChar == &#39;.&#39; || currentChar == &#39;%&#39;)))
                {
                    currentString = &quot; &quot;;
                } 
                else if (Char.IsPunctuation(currentChar) || Char.IsLetterOrDigit(currentChar))
                {
                    currentString = currentChar.ToString(CultureInfo.InvariantCulture);
                }
                
                friendlyName += currentString;
            }
            
            //Capitalize each first letter of a word
            var cultureInfo = Thread.CurrentThread.CurrentCulture;
            var textInfo = cultureInfo.TextInfo;

            friendlyName = textInfo.ToTitleCase(friendlyName);

            //Remove multiple consecutive spaces
            var regex = new Regex(@&quot;[ ]{2,}&quot;, RegexOptions.None);
            friendlyName = regex.Replace(friendlyName, @&quot; &quot;);

            return friendlyName;
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[19,43,19,44,0],[19,45,19,57,0],[19,58,19,59,0],[24,9,24,40,0],[25,9,25,10,0],[26,13,26,101,0],[27,9,27,10,0],[30,9,30,10,0],[32,13,32,14,0],[33,17,33,58,0],[35,17,35,75,0],[35,75,35,126,0],[35,126,35,332,0],[35,17,35,332,0],[37,13,37,18,0],[38,13,38,14,0],[39,17,39,30,0],[41,9,41,10,0],[44,9,44,10,0],[47,13,49,65,0],[51,13,51,114,0],[52,13,52,14,0],[54,13,54,14,0],[56,13,56,14,0],[57,17,60,35,0],[61,13,61,14,0],[63,13,63,46,0],[64,17,64,56,0],[66,13,66,50,0],[68,13,68,26,0],[69,9,69,10,0],[73,9,73,10,0],[74,13,74,58,0],[76,13,76,64,0],[77,9,77,10,0],[84,9,84,10,0],[85,13,85,106,0],[86,13,86,20,0],[86,22,86,36,0],[86,37,86,39,0],[86,40,86,48,0],[87,13,87,14,0],[88,17,88,68,0],[89,17,89,18,0],[90,21,90,89,0],[91,21,91,60,0],[92,21,92,22,0],[94,25,94,66,0],[96,25,98,129,0],[100,25,100,70,0],[101,25,101,26,0],[102,29,102,98,0],[103,29,103,79,0],[105,29,105,70,0],[106,29,106,30,0],[107,33,107,60,0],[108,33,108,45,0],[110,25,110,26,0],[111,21,111,22,0],[112,17,112,18,0],[113,13,113,14,0],[115,13,115,34,0],[116,13,116,26,0],[117,9,117,10,0],[120,9,120,10,0],[122,13,122,116,0],[123,13,123,48,0],[124,13,124,45,0],[126,18,126,27,0],[126,29,126,46,0],[126,48,126,51,0],[127,13,127,14,0],[128,17,128,46,0],[129,17,129,50,0],[131,17,132,112,0],[133,17,133,18,0],[134,21,134,41,0],[135,17,135,18,0],[136,22,136,95,0],[137,17,137,18,0],[138,21,138,88,0],[139,17,139,18,0],[141,17,141,47,0],[142,13,142,14,0],[145,13,145,67,0],[146,13,146,49,0],[148,13,148,63,0],[151,13,151,66,0],[152,13,152,62,0],[154,13,154,33,0],[155,9,155,10,0]]);
    </script>
  </body>
</html>