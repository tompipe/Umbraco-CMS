<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Strategies\Migrations\EnsureListViewDataTypeIsCreated.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core;
using Umbraco.Core.Events;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;
using umbraco.interfaces;
using Umbraco.Core.Configuration;

namespace Umbraco.Web.Strategies.Migrations
{
    /// &lt;summary&gt;
    /// Creates the built in list view data types
    /// &lt;/summary&gt;
    public class EnsureDefaultListViewDataTypesCreated : MigrationStartupHander
    {
        protected override void AfterMigration(MigrationRunner sender, MigrationEventArgs e)
        {
            if (e.ProductName != GlobalSettings.UmbracoMigrationName) return;

            var target720 = new Version(7, 2, 0);

            if (e.ConfiguredVersion &lt;= target720)
            {
                EnsureListViewDataTypeCreated(e);

            }
        }

        private void EnsureListViewDataTypeCreated(MigrationEventArgs e)
        {
            using (var transaction = e.MigrationContext.Database.GetTransaction())
            {
                try
                {
                    //Turn on identity insert if db provider is not mysql
                    if (SqlSyntaxContext.SqlSyntaxProvider.SupportsIdentityInsert())
                        e.MigrationContext.Database.Execute(new Sql(string.Format(&quot;SET IDENTITY_INSERT {0} ON &quot;, SqlSyntaxContext.SqlSyntaxProvider.GetQuotedTableName(&quot;umbracoNode&quot;))));

                    if (e.MigrationContext.Database.Exists&lt;NodeDto&gt;(Constants.System.DefaultContentListViewDataTypeId))
                    {
                        //If this already exists then just exit
                        return;
                    }

                    e.MigrationContext.Database.Insert(&quot;umbracoNode&quot;, &quot;id&quot;, false, new NodeDto { NodeId = Constants.System.DefaultContentListViewDataTypeId, Trashed = false, ParentId = -1, UserId = 0, Level = 1, Path = &quot;-1,-95&quot;, SortOrder = 2, UniqueId = new Guid(&quot;C0808DD3-8133-4E4B-8CE8-E2BEA84A96A4&quot;), Text = Constants.Conventions.DataTypes.ListViewPrefix + &quot;Content&quot;, NodeObjectType = new Guid(Constants.ObjectTypes.DataType), CreateDate = DateTime.Now });
                    e.MigrationContext.Database.Insert(&quot;umbracoNode&quot;, &quot;id&quot;, false, new NodeDto { NodeId = Constants.System.DefaultMediaListViewDataTypeId, Trashed = false, ParentId = -1, UserId = 0, Level = 1, Path = &quot;-1,-96&quot;, SortOrder = 2, UniqueId = new Guid(&quot;3A0156C4-3B8C-4803-BDC1-6871FAA83FFF&quot;), Text = Constants.Conventions.DataTypes.ListViewPrefix + &quot;Media&quot;, NodeObjectType = new Guid(Constants.ObjectTypes.DataType), CreateDate = DateTime.Now });
                    e.MigrationContext.Database.Insert(&quot;umbracoNode&quot;, &quot;id&quot;, false, new NodeDto { NodeId = Constants.System.DefaultMembersListViewDataTypeId, Trashed = false, ParentId = -1, UserId = 0, Level = 1, Path = &quot;-1,-97&quot;, SortOrder = 2, UniqueId = new Guid(&quot;AA2C52A0-CE87-4E65-A47C-7DF09358585D&quot;), Text = Constants.Conventions.DataTypes.ListViewPrefix + &quot;Members&quot;, NodeObjectType = new Guid(Constants.ObjectTypes.DataType), CreateDate = DateTime.Now });
                }
                finally
                {
                    //Turn off identity insert if db provider is not mysql
                    if (SqlSyntaxContext.SqlSyntaxProvider.SupportsIdentityInsert())
                        e.MigrationContext.Database.Execute(new Sql(string.Format(&quot;SET IDENTITY_INSERT {0} OFF;&quot;, SqlSyntaxContext.SqlSyntaxProvider.GetQuotedTableName(&quot;umbracoNode&quot;))));
                }


                try
                {
                    //Turn on identity insert if db provider is not mysql
                    if (SqlSyntaxContext.SqlSyntaxProvider.SupportsIdentityInsert())
                        e.MigrationContext.Database.Execute(new Sql(string.Format(&quot;SET IDENTITY_INSERT {0} ON &quot;, SqlSyntaxContext.SqlSyntaxProvider.GetQuotedTableName(&quot;cmsDataType&quot;))));

                    e.MigrationContext.Database.Insert(&quot;cmsDataType&quot;, &quot;pk&quot;, false, new DataTypeDto { PrimaryKey = -26, DataTypeId = Constants.System.DefaultContentListViewDataTypeId, PropertyEditorAlias = Constants.PropertyEditors.ListViewAlias, DbType = &quot;Nvarchar&quot; });
                    e.MigrationContext.Database.Insert(&quot;cmsDataType&quot;, &quot;pk&quot;, false, new DataTypeDto { PrimaryKey = -27, DataTypeId = Constants.System.DefaultMediaListViewDataTypeId, PropertyEditorAlias = Constants.PropertyEditors.ListViewAlias, DbType = &quot;Nvarchar&quot; });
                    e.MigrationContext.Database.Insert(&quot;cmsDataType&quot;, &quot;pk&quot;, false, new DataTypeDto { PrimaryKey = -28, DataTypeId = Constants.System.DefaultMembersListViewDataTypeId, PropertyEditorAlias = Constants.PropertyEditors.ListViewAlias, DbType = &quot;Nvarchar&quot; });
                }
                finally
                {
                    //Turn off identity insert if db provider is not mysql
                    if (SqlSyntaxContext.SqlSyntaxProvider.SupportsIdentityInsert())
                        e.MigrationContext.Database.Execute(new Sql(string.Format(&quot;SET IDENTITY_INSERT {0} OFF;&quot;, SqlSyntaxContext.SqlSyntaxProvider.GetQuotedTableName(&quot;cmsDataType&quot;))));
                }



                try
                {
                    //Turn on identity insert if db provider is not mysql
                    if (SqlSyntaxContext.SqlSyntaxProvider.SupportsIdentityInsert())
                        e.MigrationContext.Database.Execute(new Sql(string.Format(&quot;SET IDENTITY_INSERT {0} ON &quot;, SqlSyntaxContext.SqlSyntaxProvider.GetQuotedTableName(&quot;cmsDataTypePreValues&quot;))));

                    //defaults for the member list
                    e.MigrationContext.Database.Insert(&quot;cmsDataTypePreValues&quot;, &quot;id&quot;, false, new DataTypePreValueDto { Id = -1, Alias = &quot;pageSize&quot;, SortOrder = 1, DataTypeNodeId = Constants.System.DefaultMembersListViewDataTypeId, Value = &quot;10&quot; });
                    e.MigrationContext.Database.Insert(&quot;cmsDataTypePreValues&quot;, &quot;id&quot;, false, new DataTypePreValueDto { Id = -2, Alias = &quot;orderBy&quot;, SortOrder = 2, DataTypeNodeId = Constants.System.DefaultMembersListViewDataTypeId, Value = &quot;Name&quot; });
                    e.MigrationContext.Database.Insert(&quot;cmsDataTypePreValues&quot;, &quot;id&quot;, false, new DataTypePreValueDto { Id = -3, Alias = &quot;orderDirection&quot;, SortOrder = 3, DataTypeNodeId = Constants.System.DefaultMembersListViewDataTypeId, Value = &quot;asc&quot; });
                    e.MigrationContext.Database.Insert(&quot;cmsDataTypePreValues&quot;, &quot;id&quot;, false, new DataTypePreValueDto { Id = -4, Alias = &quot;includeProperties&quot;, SortOrder = 4, DataTypeNodeId = Constants.System.DefaultMembersListViewDataTypeId, Value = &quot;[{\&quot;alias\&quot;:\&quot;email\&quot;,\&quot;isSystem\&quot;:1},{\&quot;alias\&quot;:\&quot;username\&quot;,\&quot;isSystem\&quot;:1},{\&quot;alias\&quot;:\&quot;updateDate\&quot;,\&quot;header\&quot;:\&quot;Last edited\&quot;,\&quot;isSystem\&quot;:1}]&quot; });
                }
                finally
                {
                    //Turn off identity insert if db provider is not mysql
                    if (SqlSyntaxContext.SqlSyntaxProvider.SupportsIdentityInsert())
                        e.MigrationContext.Database.Execute(new Sql(string.Format(&quot;SET IDENTITY_INSERT {0} OFF;&quot;, SqlSyntaxContext.SqlSyntaxProvider.GetQuotedTableName(&quot;cmsDataTypePreValues&quot;))));
                }



                transaction.Complete();
            }
        }

    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,0],[24,13,24,70,0],[24,71,24,78,0],[26,13,26,50,0],[28,13,28,50,0],[29,13,29,14,0],[30,17,30,50,0],[32,13,32,14,0],[33,9,33,10,0],[36,9,36,10,0],[37,20,37,82,0],[38,13,38,14,0],[40,17,40,18,0],[42,21,42,85,0],[43,25,43,186,0],[45,21,45,120,0],[46,21,46,22,0],[48,25,48,32,0],[51,21,51,461,0],[52,21,52,457,0],[53,21,53,461,0],[54,17,54,18,0],[56,17,56,18,0],[58,21,58,85,0],[59,25,59,187,0],[60,17,60,18,0],[64,17,64,18,0],[66,21,66,85,0],[67,25,67,186,0],[69,21,69,270,0],[70,21,70,268,0],[71,21,71,270,0],[72,17,72,18,0],[74,17,74,18,0],[76,21,76,85,0],[77,25,77,187,0],[78,17,78,18,0],[83,17,83,18,0],[85,21,85,85,0],[86,25,86,195,0],[89,21,89,247,0],[90,21,90,248,0],[91,21,91,254,0],[92,21,92,401,0],[93,17,93,18,0],[95,17,95,18,0],[97,21,97,85,0],[98,25,98,196,0],[99,17,99,18,0],[103,17,103,40,0],[104,13,104,14,0],[105,9,105,10,0]]);
    </script>
  </body>
</html>