<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Models\Mapping\DataTypeModelMapper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using AutoMapper;
using System.Linq;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Mapping;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;

namespace Umbraco.Web.Models.Mapping
{
    /// &lt;summary&gt;
    /// Configure&#39;s model mappings for Data types
    /// &lt;/summary&gt;
    internal class DataTypeModelMapper : MapperConfiguration
    {
        public override void ConfigureMappings(IConfiguration config, ApplicationContext applicationContext)
        {
            var lazyDataTypeService = new Lazy&lt;IDataTypeService&gt;(() =&gt; applicationContext.Services.DataTypeService);

            config.CreateMap&lt;PropertyEditor, PropertyEditorBasic&gt;();                

            //just maps the standard properties, does not map the value!
            config.CreateMap&lt;PreValueField, PreValueFieldDisplay&gt;()
                .ForMember(x =&gt; x.Value, expression =&gt; expression.Ignore());

            var systemIds = new[]
            {
                Constants.System.DefaultContentListViewDataTypeId, 
                Constants.System.DefaultMediaListViewDataTypeId, 
                Constants.System.DefaultMembersListViewDataTypeId
            };

            config.CreateMap&lt;PropertyEditor, DataTypeBasic&gt;()
                .ForMember(x =&gt; x.HasPrevalues, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.IsSystemDataType, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Id, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Trashed, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Key, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.ParentId, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Path, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.AdditionalData, expression =&gt; expression.Ignore());

            config.CreateMap&lt;IDataTypeDefinition, DataTypeBasic&gt;()
                .ForMember(x =&gt; x.HasPrevalues, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Icon, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Alias, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Group, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.IsSystemDataType, expression =&gt; expression.MapFrom(definition =&gt; systemIds.Contains(definition.Id)))
                .AfterMap((def, basic) =&gt;
                {
                    var editor = PropertyEditorResolver.Current.GetByAlias(def.PropertyEditorAlias);
                    if (editor != null)
                    {
                        basic.Alias = editor.Alias;
                        basic.Group = editor.Group;
                        basic.Icon = editor.Icon;
                    }
                });

            config.CreateMap&lt;IDataTypeDefinition, DataTypeDisplay&gt;()
                .ForMember(display =&gt; display.AvailableEditors, expression =&gt; expression.ResolveUsing(new AvailablePropertyEditorsResolver()))
                .ForMember(display =&gt; display.PreValues, expression =&gt; expression.ResolveUsing(
                    new PreValueDisplayResolver(lazyDataTypeService)))
                .ForMember(display =&gt; display.SelectedEditor, expression =&gt; expression.MapFrom(
                    definition =&gt; definition.PropertyEditorAlias.IsNullOrWhiteSpace() ? null : definition.PropertyEditorAlias))
                .ForMember(x =&gt; x.HasPrevalues, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Notifications, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Icon, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Alias, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Group, expression =&gt; expression.Ignore())                
                .ForMember(x =&gt; x.IsSystemDataType, expression =&gt; expression.MapFrom(definition =&gt; systemIds.Contains(definition.Id)))
                .AfterMap((def, basic) =&gt;
                {
                    var editor = PropertyEditorResolver.Current.GetByAlias(def.PropertyEditorAlias);
                    if (editor != null)
                    {
                        basic.Group = editor.Group;
                        basic.Icon = editor.Icon;
                    }
                });

            //gets a list of PreValueFieldDisplay objects from the data type definition
            config.CreateMap&lt;IDataTypeDefinition, IEnumerable&lt;PreValueFieldDisplay&gt;&gt;()
                  .ConvertUsing(definition =&gt;
                      {
                          var resolver = new PreValueDisplayResolver(lazyDataTypeService);
                          return resolver.Convert(definition);
                      });

            config.CreateMap&lt;DataTypeSave, IDataTypeDefinition&gt;()
                .ConstructUsing(save =&gt; new DataTypeDefinition(save.SelectedEditor) {CreateDate = DateTime.Now})
                .ForMember(definition =&gt; definition.Id, expression =&gt; expression.MapFrom(save =&gt; Convert.ToInt32(save.Id)))
                //we have to ignore the Key otherwise this will reset the UniqueId field which should never change!
                // http://issues.umbraco.org/issue/U4-3911                
                .ForMember(definition =&gt; definition.Key, expression =&gt; expression.Ignore())
                .ForMember(definition =&gt; definition.Path, expression =&gt; expression.Ignore())
                .ForMember(definition =&gt; definition.PropertyEditorAlias, expression =&gt; expression.MapFrom(save =&gt; save.SelectedEditor))
                .ForMember(definition =&gt; definition.DatabaseType, expression =&gt; expression.ResolveUsing(new DatabaseTypeResolver()))
                .ForMember(x =&gt; x.ControlId, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.CreatorId, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.Level, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.SortOrder, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.CreateDate, expression =&gt; expression.Ignore())
                .ForMember(x =&gt; x.UpdateDate, expression =&gt; expression.Ignore());

            //Converts a property editor to a new list of pre-value fields - used when creating a new data type or changing a data type with new pre-vals
            config.CreateMap&lt;PropertyEditor, IEnumerable&lt;PreValueFieldDisplay&gt;&gt;()
                .ConvertUsing(editor =&gt;
                    {
                        //this is a new data type, so just return the field editors, there are no values yet
                        var defaultVals = editor.DefaultPreValues;
                        var fields = editor.PreValueEditor.Fields.Select(Mapper.Map&lt;PreValueFieldDisplay&gt;).ToArray();
                        if (defaultVals != null)
                        {                           
                            PreValueDisplayResolver.MapPreValueValuesToPreValueFields(fields, defaultVals);
                        }
                        return fields;
                    });
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,72,1],[21,72,21,115,0],[21,115,21,117,1],[21,13,21,117,1],[23,13,23,69,1],[26,13,27,56,1],[27,56,27,75,1],[27,75,27,77,1],[26,13,27,77,1],[29,13,34,15,1],[36,13,37,63,1],[37,63,37,82,1],[37,82,38,67,1],[38,67,38,86,1],[38,86,39,53,1],[39,53,39,72,1],[39,72,40,58,1],[40,58,40,77,1],[40,77,41,54,1],[41,54,41,73,1],[41,73,42,59,1],[42,59,42,78,1],[42,78,43,55,1],[43,55,43,74,1],[43,74,44,65,1],[44,65,44,84,1],[44,84,44,86,1],[36,13,44,86,1],[46,13,47,63,1],[47,63,47,82,1],[47,82,48,55,1],[48,55,48,74,1],[48,74,49,56,1],[49,56,49,75,1],[49,75,50,56,1],[50,56,50,75,1],[50,75,51,67,1],[51,67,51,134,1],[51,134,53,17,1],[53,17,53,18,0],[53,18,54,21,1],[54,21,54,101,0],[54,101,55,21,1],[55,21,55,40,0],[55,40,56,21,1],[56,21,56,22,0],[56,22,57,25,1],[57,25,57,52,0],[57,52,58,25,1],[58,25,58,52,0],[58,52,59,25,1],[59,25,59,50,0],[59,50,60,21,1],[60,21,60,22,0],[60,22,61,17,1],[61,17,61,18,0],[61,18,61,20,1],[46,13,61,20,1],[63,13,64,79,1],[64,79,64,142,1],[64,142,65,72,1],[65,72,66,70,1],[66,70,67,77,1],[67,77,68,127,1],[68,127,69,63,1],[69,63,69,82,1],[69,82,70,64,1],[70,64,70,83,1],[70,83,71,55,1],[71,55,71,74,1],[71,74,72,56,1],[72,56,72,75,1],[72,75,73,56,1],[73,56,73,75,1],[73,75,74,67,1],[74,67,74,134,1],[74,134,76,17,1],[76,17,76,18,0],[76,18,77,21,1],[77,21,77,101,0],[77,101,78,21,1],[78,21,78,40,0],[78,40,79,21,1],[79,21,79,22,0],[79,22,80,25,1],[80,25,80,52,0],[80,52,81,25,1],[81,25,81,50,0],[81,50,82,21,1],[82,21,82,22,0],[82,22,83,17,1],[83,17,83,18,0],[83,18,83,20,1],[63,13,83,20,1],[86,13,88,23,1],[88,23,88,24,0],[88,24,89,27,1],[89,27,89,91,0],[89,91,90,27,1],[90,27,90,63,0],[90,63,91,23,1],[91,23,91,24,0],[91,24,91,26,1],[86,13,91,26,1],[93,13,94,41,1],[94,41,94,112,0],[94,112,95,71,1],[95,71,95,123,1],[95,123,98,72,1],[98,72,98,91,1],[98,91,99,73,1],[99,73,99,92,1],[99,92,100,88,1],[100,88,100,135,1],[100,135,101,81,1],[101,81,101,132,1],[101,132,102,60,1],[102,60,102,79,1],[102,79,103,60,1],[103,60,103,79,1],[103,79,104,56,1],[104,56,104,75,1],[104,75,105,60,1],[105,60,105,79,1],[105,79,106,61,1],[106,61,106,80,1],[106,80,107,61,1],[107,61,107,80,1],[107,80,107,82,1],[93,13,107,82,1],[110,13,112,21,1],[112,21,112,22,0],[112,22,114,25,1],[114,25,114,67,0],[114,67,115,25,1],[115,25,115,118,0],[115,118,116,25,1],[116,25,116,49,0],[116,49,117,25,1],[117,25,117,26,0],[117,26,118,29,1],[118,29,118,108,0],[118,108,119,25,1],[119,25,119,26,0],[119,26,120,25,1],[120,25,120,39,0],[120,39,121,21,1],[121,21,121,22,0],[121,22,121,24,1],[110,13,121,24,1],[122,9,122,10,1]]);
    </script>
  </body>
</html>