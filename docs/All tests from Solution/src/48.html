<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\PublishedContent\PublishedContentTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.PublishedContent;
using Umbraco.Core.PropertyEditors;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;
using Umbraco.Web.Models;

namespace Umbraco.Tests.PublishedContent
{
	/// &lt;summary&gt;
	/// Tests the methods on IPublishedContent using the DefaultPublishedContentStore
	/// &lt;/summary&gt;
	[TestFixture]
    public class PublishedContentTests : PublishedContentTestBase
	{
        private PluginManager _pluginManager;

        public override void Initialize()
        {
            // required so we can access property.Value
            //PropertyValueConvertersResolver.Current = new PropertyValueConvertersResolver();

            base.Initialize();

            // this is so the model factory looks into the test assembly
            _pluginManager = PluginManager.Current;
            PluginManager.Current = new PluginManager(new ActivatorServiceProvider(), CacheHelper.RuntimeCache, ProfilingLogger, false)
            {
                AssembliesToScan = _pluginManager.AssembliesToScan
                    .Union(new[] { typeof(PublishedContentTests).Assembly })
            };

            // need to specify a custom callback for unit tests
            // AutoPublishedContentTypes generates properties automatically
            // when they are requested, but we must declare those that we
            // explicitely want to be here...

            var propertyTypes = new[]
                {
                    // AutoPublishedContentType will auto-generate other properties
                    new PublishedPropertyType(&quot;umbracoNaviHide&quot;, 0, Constants.PropertyEditors.TrueFalseAlias), 
                    new PublishedPropertyType(&quot;selectedNodes&quot;, 0, &quot;?&quot;), 
                    new PublishedPropertyType(&quot;umbracoUrlAlias&quot;, 0, &quot;?&quot;), 
                    new PublishedPropertyType(&quot;content&quot;, 0, Constants.PropertyEditors.TinyMCEAlias), 
                    new PublishedPropertyType(&quot;testRecursive&quot;, 0, &quot;?&quot;), 
                };
            var compositionAliases = new[] {&quot;MyCompositionAlias&quot;};
            var type = new AutoPublishedContentType(0, &quot;anything&quot;, compositionAliases, propertyTypes);
            PublishedContentType.GetPublishedContentTypeCallback = (alias) =&gt; type;
        }

        public override void TearDown()
        {
            PluginManager.Current = _pluginManager;
            ApplicationContext.Current.DisposeIfDisposable();
            ApplicationContext.Current = null;
        }

	    protected override void FreezeResolution()
	    {
            var types = PluginManager.Current.ResolveTypes&lt;PublishedContentModel&gt;();
            PublishedContentModelFactoryResolver.Current = new PublishedContentModelFactoryResolver(
                new PublishedContentModelFactory(types));
	        base.FreezeResolution();
	    }

	    protected override string GetXmlContent(int templateId)
		{
			return @&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;
&lt;!DOCTYPE root[ 
&lt;!ELEMENT Home ANY&gt;
&lt;!ATTLIST Home id ID #REQUIRED&gt;
&lt;!ELEMENT CustomDocument ANY&gt;
&lt;!ATTLIST CustomDocument id ID #REQUIRED&gt;
]&gt;
&lt;root id=&quot;&quot;-1&quot;&quot;&gt;
	&lt;Home id=&quot;&quot;1046&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; nodeName=&quot;&quot;Home&quot;&quot; urlName=&quot;&quot;home&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
		&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;umbracoUrlAlias&gt;&lt;![CDATA[this/is/my/alias, anotheralias]]&gt;&lt;/umbracoUrlAlias&gt;
		&lt;umbracoNaviHide&gt;1&lt;/umbracoNaviHide&gt;
		&lt;testRecursive&gt;&lt;![CDATA[This is the recursive val]]&gt;&lt;/testRecursive&gt;
		&lt;Home id=&quot;&quot;1173&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; nodeName=&quot;&quot;Sub1&quot;&quot; urlName=&quot;&quot;sub1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;content&gt;&lt;![CDATA[&lt;div&gt;This is some content&lt;/div&gt;]]&gt;&lt;/content&gt;
			&lt;umbracoUrlAlias&gt;&lt;![CDATA[page2/alias, 2ndpagealias]]&gt;&lt;/umbracoUrlAlias&gt;			
			&lt;testRecursive&gt;&lt;![CDATA[]]&gt;&lt;/testRecursive&gt;
			&lt;Home id=&quot;&quot;1174&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:07:54&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:27&quot;&quot; nodeName=&quot;&quot;Sub2&quot;&quot; urlName=&quot;&quot;sub2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1174&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;umbracoUrlAlias&gt;&lt;![CDATA[only/one/alias]]&gt;&lt;/umbracoUrlAlias&gt;
				&lt;creatorName&gt;&lt;![CDATA[Custom data with same property name as the member name]]&gt;&lt;/creatorName&gt;
				&lt;testRecursive&gt;&lt;![CDATA[]]&gt;&lt;/testRecursive&gt;
			&lt;/Home&gt;			
			&lt;CustomDocument id=&quot;&quot;1177&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;custom sub 1&quot;&quot; urlName=&quot;&quot;custom-sub-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1177&quot;&quot; isDoc=&quot;&quot;&quot;&quot; /&gt;
			&lt;CustomDocument id=&quot;&quot;1178&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;3&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-16T14:23:35&quot;&quot; nodeName=&quot;&quot;custom sub 2&quot;&quot; urlName=&quot;&quot;custom-sub-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1178&quot;&quot; isDoc=&quot;&quot;&quot;&quot; /&gt;
            &lt;Home id=&quot;&quot;1176&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;4&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;sub-3&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1176&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
                &lt;umbracoNaviHide&gt;1&lt;/umbracoNaviHide&gt;
			&lt;/Home&gt;
		&lt;/Home&gt;
		&lt;Home id=&quot;&quot;1175&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub 2&quot;&quot; urlName=&quot;&quot;sub-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1175&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;/Home&gt;
		&lt;CustomDocument id=&quot;&quot;4444&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;3&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;Test&quot;&quot; urlName=&quot;&quot;test-page&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,4444&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;selectedNodes&gt;&lt;![CDATA[1172,1176,1173]]&gt;&lt;/selectedNodes&gt;
		&lt;/CustomDocument&gt;
	&lt;/Home&gt;
	&lt;CustomDocument id=&quot;&quot;1172&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;Test&quot;&quot; urlName=&quot;&quot;test-page&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1172&quot;&quot; isDoc=&quot;&quot;&quot;&quot; /&gt;
&lt;/root&gt;&quot;;
		}

		internal IPublishedContent GetNode(int id)
		{
			var ctx = GetUmbracoContext(&quot;/test&quot;, 1234);
			var doc = ctx.ContentCache.GetById(id);
			Assert.IsNotNull(doc);
			return doc;
		}

        [Test]
        [Ignore(&quot;IPublishedContent currently (6.1 as of april 25, 2013) has bugs&quot;)]
        public void Fails()
        {
            var content = GetNode(1173);

            var c1 = content.Children.First(x =&gt; x.Id == 1177);
            Assert.IsFalse(c1.IsFirst());

            var c2 = content.Children.Where(x =&gt; x.DocumentTypeAlias == &quot;CustomDocument&quot;).First(x =&gt; x.Id == 1177);
            Assert.IsTrue(c2.IsFirst());

            // First is not implemented
            var c2a = content.Children.First(x =&gt; x.DocumentTypeAlias == &quot;CustomDocument&quot; &amp;&amp; x.Id == 1177);
            Assert.IsTrue(c2a.IsFirst()); // so here it&#39;s luck

            c1 = content.Children.First(x =&gt; x.Id == 1177);
            Assert.IsFalse(c1.IsFirst()); // and here it fails

            // but even using supported (where) method...
            // do not replace by First(x =&gt; ...) here since it&#39;s not supported at the moment
            c1 = content.Children.Where(x =&gt; x.Id == 1177).First();
            c2 = content.Children.Where(x =&gt; x.DocumentTypeAlias == &quot;CustomDocument&quot; &amp;&amp; x.Id == 1177).First();

            Assert.IsFalse(c1.IsFirst()); // here it fails because c2 has corrupted it

            // so there&#39;s only 1 IPublishedContent instance
            // which keeps changing collection, ie being modified
            // which is *bad* from a cache point of vue
            // and from a consistency point of vue...
            // =&gt; we want clones!
        }

        [Test]
        public void Is_Last_From_Where_Filter_Dynamic_Linq()
        {
            var doc = GetNode(1173);

            var items = doc.Children.Where(&quot;Visible&quot;).ToContentSet();

            foreach (var item in items)
            {
                if (item.Id != 1178)
                {
                    Assert.IsFalse(item.IsLast());
                }
                else
                {
                    Assert.IsTrue(item.IsLast());
                }
            }
        }

        [Test]
        public void Is_Last_From_Where_Filter()
        {
            var doc = GetNode(1173);

            var items = doc
                .Children
                .Where(x =&gt; x.IsVisible())
                .ToContentSet();

            Assert.AreEqual(3, items.Count());

            foreach (var d in items)
            {
                switch (d.Id)
                {
                    case 1174:
                        Assert.IsTrue(d.IsFirst());
                        Assert.IsFalse(d.IsLast());
                        break;
                    case 1177:
                        Assert.IsFalse(d.IsFirst());
                        Assert.IsFalse(d.IsLast());
                        break;
                    case 1178:
                        Assert.IsFalse(d.IsFirst());
                        Assert.IsTrue(d.IsLast());
                        break;
                    default:
                        Assert.Fail(&quot;Invalid id.&quot;);
                        break;
                }
            }
        }

        [PublishedContentModel(&quot;Home&quot;)]
        internal class Home : PublishedContentModel
        {
            public Home(IPublishedContent content) 
                : base(content) 
            {}
        }

        [Test]
        [Ignore(&quot;Fails as long as PublishedContentModel is internal.&quot;)] // fixme
        public void Is_Last_From_Where_Filter2()
        {
            var doc = GetNode(1173);

            var items = doc.Children
                .Select(x =&gt; x.CreateModel()) // linq, returns IEnumerable&lt;IPublishedContent&gt;

                // only way around this is to make sure every IEnumerable&lt;T&gt; extension
                // explicitely returns a PublishedContentSet, not an IEnumerable&lt;T&gt;

                .OfType&lt;Home&gt;() // ours, return IEnumerable&lt;Home&gt; (actually a PublishedContentSet&lt;Home&gt;)
                .Where(x =&gt; x.IsVisible()) // so, here it&#39;s linq again :-(
                .ToContentSet() // so, we need that one for the test to pass
                .ToArray();

            Assert.AreEqual(1, items.Count());

            foreach (var d in items)
            {
                switch (d.Id)
                {
                    case 1174:
                        Assert.IsTrue(d.IsFirst());
                        Assert.IsTrue(d.IsLast());
                        break;
                    default:
                        Assert.Fail(&quot;Invalid id.&quot;);
                        break;
                }
            }
        }

        [Test]
        public void Is_Last_From_Take()
        {
            var doc = GetNode(1173);

            var items = doc.Children.Take(3).ToContentSet();

            foreach (var item in items)
            {
                if (item.Id != 1178)
                {
                    Assert.IsFalse(item.IsLast());
                }
                else
                {
                    Assert.IsTrue(item.IsLast());
                }
            }
        }

        [Test]
        public void Is_Last_From_Skip()
        {
            var doc = GetNode(1173);

            foreach (var d in doc.Children.Skip(1))
            {
                if (d.Id != 1176)
                {
                    Assert.IsFalse(d.IsLast());
                }
                else
                {
                    Assert.IsTrue(d.IsLast());
                }
            }
        }

        [Test]
        public void Is_Last_From_Concat()
        {
            var doc = GetNode(1173);

            var items = doc.Children
                .Concat(new[] { GetNode(1175), GetNode(4444) })
                .ToContentSet();

            foreach (var item in items)
            {
                if (item.Id != 4444)
                {
                    Assert.IsFalse(item.IsLast());
                }
                else
                {
                    Assert.IsTrue(item.IsLast());
                }
            }
        }

	    [Test]
	    public void Descendants_Ordered_Properly()
	    {
            var doc = GetNode(1046);

	        var expected = new[] {1046, 1173, 1174, 1177, 1178, 1176, 1175, 4444, 1172};
	        var exindex = 0;

            // must respect the XPath descendants-or-self axis!
            foreach (var d in doc.DescendantsOrSelf())
                Assert.AreEqual(expected[exindex++], d.Id);
	    }

	    [Test]
		public void Test_Get_Recursive_Val()
		{
			var doc = GetNode(1174);
			var rVal = doc.GetRecursiveValue(&quot;testRecursive&quot;);
			var nullVal = doc.GetRecursiveValue(&quot;DoNotFindThis&quot;);
			Assert.AreEqual(&quot;This is the recursive val&quot;, rVal);
			Assert.AreEqual(&quot;&quot;, nullVal);
		}

		[Test]
		public void Get_Property_Value_Uses_Converter()
		{
			var doc = GetNode(1173);

			var propVal = doc.GetPropertyValue(&quot;content&quot;);
            Assert.IsInstanceOf(typeof(IHtmlString), propVal);
			Assert.AreEqual(&quot;&lt;div&gt;This is some content&lt;/div&gt;&quot;, propVal.ToString());

			var propVal2 = doc.GetPropertyValue&lt;IHtmlString&gt;(&quot;content&quot;);
            Assert.IsInstanceOf(typeof(IHtmlString), propVal2);
            Assert.AreEqual(&quot;&lt;div&gt;This is some content&lt;/div&gt;&quot;, propVal2.ToString());

            var propVal3 = doc.GetPropertyValue(&quot;Content&quot;);
            Assert.IsInstanceOf(typeof(IHtmlString), propVal3);
            Assert.AreEqual(&quot;&lt;div&gt;This is some content&lt;/div&gt;&quot;, propVal3.ToString());
		}

		[Test]
		public void Complex_Linq()
		{
			var doc = GetNode(1173);

			var result = doc.Ancestors().OrderBy(x =&gt; x.Level)
				.Single()
				.Descendants()
				.FirstOrDefault(x =&gt; x.GetPropertyValue&lt;string&gt;(&quot;selectedNodes&quot;, &quot;&quot;).Split(&#39;,&#39;).Contains(&quot;1173&quot;));

			Assert.IsNotNull(result);
		}

		[Test]
		public void Index()
		{
			var doc = GetNode(1173);
			Assert.AreEqual(0, doc.Index());
			doc = GetNode(1176);
			Assert.AreEqual(3, doc.Index());
			doc = GetNode(1177);
			Assert.AreEqual(1, doc.Index());
			doc = GetNode(1178);
			Assert.AreEqual(2, doc.Index());
		}

		[Test]
		public void Is_First()
		{
			var doc = GetNode(1046); //test root nodes
			Assert.IsTrue(doc.IsFirst());
			doc = GetNode(1172);
			Assert.IsFalse(doc.IsFirst());
			doc = GetNode(1173); //test normal nodes
			Assert.IsTrue(doc.IsFirst());
			doc = GetNode(1175);
			Assert.IsFalse(doc.IsFirst());
		}

		[Test]
		public void Is_Not_First()
		{
			var doc = GetNode(1046); //test root nodes
			Assert.IsFalse(doc.IsNotFirst());
			doc = GetNode(1172);
			Assert.IsTrue(doc.IsNotFirst());
			doc = GetNode(1173); //test normal nodes
			Assert.IsFalse(doc.IsNotFirst());
			doc = GetNode(1175);
			Assert.IsTrue(doc.IsNotFirst());
		}

		[Test]
		public void Is_Position()
		{
			var doc = GetNode(1046); //test root nodes
			Assert.IsTrue(doc.IsPosition(0));
			doc = GetNode(1172);
			Assert.IsTrue(doc.IsPosition(1));
			doc = GetNode(1173); //test normal nodes
			Assert.IsTrue(doc.IsPosition(0));
			doc = GetNode(1175);
			Assert.IsTrue(doc.IsPosition(1));
		}

		[Test]
		public void Children_GroupBy_DocumentTypeAlias()
		{
			var doc = GetNode(1046);

			var found1 = doc.Children.GroupBy(&quot;DocumentTypeAlias&quot;);

			Assert.AreEqual(2, found1.Count());
			Assert.AreEqual(2, found1.Single(x =&gt; x.Key.ToString() == &quot;Home&quot;).Count());
			Assert.AreEqual(1, found1.Single(x =&gt; x.Key.ToString() == &quot;CustomDocument&quot;).Count());
		}

		[Test]
		public void Children_Where_DocumentTypeAlias()
		{
			var doc = GetNode(1046);

			var found1 = doc.Children.Where(&quot;DocumentTypeAlias == \&quot;CustomDocument\&quot;&quot;);
			var found2 = doc.Children.Where(&quot;DocumentTypeAlias == \&quot;Home\&quot;&quot;);

			Assert.AreEqual(1, found1.Count());
			Assert.AreEqual(2, found2.Count());
		}

		[Test]
		public void Children_Order_By_Update_Date()
		{
			var doc = GetNode(1173);

			var ordered = doc.Children.OrderBy(&quot;UpdateDate&quot;);

			var correctOrder = new[] { 1178, 1177, 1174, 1176 };
			for (var i = 0; i &lt; correctOrder.Length; i++)
			{
				Assert.AreEqual(correctOrder[i], ordered.ElementAt(i).Id);
			}

		}

		[Test]
		public void FirstChild()
		{
			var doc = GetNode(1173); // has child nodes
			Assert.IsNotNull(doc.FirstChild());
			Assert.IsNotNull(doc.FirstChild(x =&gt; true));
			Assert.IsNotNull(doc.FirstChild&lt;IPublishedContent&gt;());

			doc = GetNode(1175); // does not have child nodes
			Assert.IsNull(doc.FirstChild());
			Assert.IsNull(doc.FirstChild(x =&gt; true));
			Assert.IsNull(doc.FirstChild&lt;IPublishedContent&gt;());
		}

        [Test]
        public void IsComposedOf()
        {
            var doc = GetNode(1173);

            var isComposedOf = doc.IsComposedOf(&quot;MyCompositionAlias&quot;);

            Assert.IsTrue(isComposedOf);
        }

		[Test]
		public void HasProperty()
		{
			var doc = GetNode(1173);

			var hasProp = doc.HasProperty(Constants.Conventions.Content.UrlAlias);

            Assert.IsTrue(hasProp);
		}

		[Test]
		public void HasValue()
		{
			var doc = GetNode(1173);

			var hasValue = doc.HasValue(Constants.Conventions.Content.UrlAlias);
			var noValue = doc.HasValue(&quot;blahblahblah&quot;);

			Assert.IsTrue(hasValue);
			Assert.IsFalse(noValue);
		}

		[Test]
		public void Ancestors_Where_Visible()
		{
			var doc = GetNode(1174);

			var whereVisible = doc.Ancestors().Where(&quot;Visible&quot;);
			Assert.AreEqual(1, whereVisible.Count());

		}

		[Test]
		public void Visible()
		{
			var hidden = GetNode(1046);
			var visible = GetNode(1173);

			Assert.IsFalse(hidden.IsVisible());
			Assert.IsTrue(visible.IsVisible());
		}

		[Test]
		public void Ancestor_Or_Self()
		{
			var doc = GetNode(1173);

			var result = doc.AncestorOrSelf();

			Assert.IsNotNull(result);

            // ancestor-or-self has to be self!
            Assert.AreEqual(1173, result.Id);
		}

	    [Test]
	    public void U4_4559()
	    {
	        var doc = GetNode(1174);
	        var result = doc.AncestorOrSelf(1);
            Assert.IsNotNull(result);
            Assert.AreEqual(1046, result.Id);
	    }

		[Test]
		public void Ancestors_Or_Self()
		{
			var doc = GetNode(1174);

			var result = doc.AncestorsOrSelf();

			Assert.IsNotNull(result);

			Assert.AreEqual(3, result.Count());
			Assert.IsTrue(result.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1174, 1173, 1046 }));
		}

		[Test]
		public void Ancestors()
		{
			var doc = GetNode(1174);

			var result = doc.Ancestors();

			Assert.IsNotNull(result);

			Assert.AreEqual(2, result.Count());
			Assert.IsTrue(result.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1173, 1046 }));
		}

		[Test]
		public void Descendants_Or_Self()
		{
			var doc = GetNode(1046);

			var result = doc.DescendantsOrSelf();

			Assert.IsNotNull(result);

			Assert.AreEqual(8, result.Count());
			Assert.IsTrue(result.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1046, 1173, 1174, 1176, 1175 }));
		}

		[Test]
		public void Descendants()
		{
			var doc = GetNode(1046);

			var result = doc.Descendants();

			Assert.IsNotNull(result);

			Assert.AreEqual(7, result.Count());
			Assert.IsTrue(result.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1173, 1174, 1176, 1175, 4444 }));
		}

		[Test]
		public void Up()
		{
			var doc = GetNode(1173);

			var result = doc.Up();

			Assert.IsNotNull(result);

			Assert.AreEqual((int)1046, (int)result.Id);
		}

		[Test]
		public void Down()
		{
			var doc = GetNode(1173);

			var result = doc.Down();

			Assert.IsNotNull(result);

			Assert.AreEqual((int)1174, (int)result.Id);
		}

		[Test]
		public void Next()
		{
			var doc = GetNode(1173);

			var result = doc.Next();

			Assert.IsNotNull(result);

			Assert.AreEqual((int)1175, (int)result.Id);
		}

		[Test]
		public void Next_Without_Sibling()
		{
            var doc = GetNode(1176);

			Assert.IsNull(doc.Next());
		}

		[Test]
		public void Previous_Without_Sibling()
		{
			var doc = GetNode(1173);

			Assert.IsNull(doc.Previous());
		}

		[Test]
		public void Previous()
		{
			var doc = GetNode(1176);

			var result = doc.Previous();

			Assert.IsNotNull(result);

			Assert.AreEqual((int)1178, (int)result.Id);
		}

        [Test]
        public void DetachedProperty1()
        {
            var type = new PublishedPropertyType(&quot;detached&quot;, Constants.PropertyEditors.IntegerAlias);
            var prop = PublishedProperty.GetDetached(type.Detached(), &quot;5548&quot;);
            Assert.IsInstanceOf&lt;int&gt;(prop.Value);
            Assert.AreEqual(5548, prop.Value);
        }

	    public void CreateDetachedContentSample()
	    {
            bool previewing = false;
            var t = PublishedContentType.Get(PublishedItemType.Content, &quot;detachedSomething&quot;);
            var values = new Dictionary&lt;string, object&gt;();
            var properties = t.PropertyTypes.Select(x =&gt;
            {
                object value;
                if (values.TryGetValue(x.PropertyTypeAlias, out value) == false) value = null;
                return PublishedProperty.GetDetached(x.Detached(), value, previewing);
            });
            // and if you want some sort of &quot;model&quot; it&#39;s up to you really...
            var c = new DetachedContent(properties);
        }

	    public void CreatedDetachedContentInConverterSample()
	    {
            // the converter args
	        PublishedPropertyType argPropertyType = null;
	        object argSource = null;
	        bool argPreview = false;

	        var pt1 = new PublishedPropertyType(&quot;legend&quot;, 0, Constants.PropertyEditors.TextboxAlias);
	        var pt2 = new PublishedPropertyType(&quot;image&quot;, 0, Constants.PropertyEditors.MediaPickerAlias);
	        string val1 = &quot;&quot;;
	        int val2 = 0;

            var c = new ImageWithLegendModel(
                PublishedProperty.GetDetached(pt1.Nested(argPropertyType), val1, argPreview),
                PublishedProperty.GetDetached(pt2.Nested(argPropertyType), val2, argPreview));
        }

	    class ImageWithLegendModel
	    {
	        private IPublishedProperty _legendProperty;
	        private IPublishedProperty _imageProperty;

	        public ImageWithLegendModel(IPublishedProperty legendProperty, IPublishedProperty imageProperty)
	        {
	            _legendProperty = legendProperty;
	            _imageProperty = imageProperty;
	        }

            public string Legend { get { return _legendProperty.GetValue&lt;string&gt;(); } }
            public IPublishedContent Image { get { return _imageProperty.GetValue&lt;IPublishedContent&gt;(); } }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,1],[29,13,29,31,1],[32,13,32,52,1],[33,13,37,15,1],[44,13,52,19,1],[53,13,53,67,1],[54,13,54,103,1],[55,13,55,79,1],[55,79,55,83,1],[55,83,55,84,1],[55,13,55,84,1],[56,9,56,10,1],[59,9,59,10,1],[60,13,60,52,1],[61,13,61,62,1],[62,13,62,47,1],[63,9,63,10,1],[66,6,66,7,1],[67,13,67,85,1],[68,13,69,58,1],[70,10,70,34,1],[71,6,71,7,1],[74,3,74,4,1],[75,4,112,10,1],[113,3,113,4,1],[116,3,116,4,1],[117,4,117,47,1],[118,4,118,43,1],[119,4,119,26,1],[120,4,120,15,1],[121,3,121,4,1],[126,9,126,10,0],[127,13,127,41,0],[129,13,129,50,0],[129,50,129,62,0],[129,62,129,64,0],[129,13,129,64,0],[130,13,130,42,0],[132,13,132,50,0],[132,50,132,89,0],[132,89,132,102,0],[132,102,132,114,0],[132,114,132,116,0],[132,13,132,116,0],[133,13,133,41,0],[136,13,136,51,0],[136,51,136,106,0],[136,106,136,108,0],[136,13,136,108,0],[137,13,137,42,0],[139,13,139,46,0],[139,46,139,58,0],[139,58,139,60,0],[139,13,139,60,0],[140,13,140,42,0],[144,13,144,46,0],[144,46,144,58,0],[144,58,144,68,0],[144,13,144,68,0],[145,13,145,46,0],[145,46,145,101,0],[145,101,145,111,0],[145,13,145,111,0],[147,13,147,42,0],[154,9,154,10,0],[158,9,158,10,1],[159,13,159,37,1],[161,13,161,70,1],[163,13,163,20,1],[163,22,163,30,1],[163,31,163,33,1],[163,34,163,39,1],[164,13,164,14,1],[165,17,165,37,1],[166,17,166,18,1],[167,21,167,51,1],[168,17,168,18,1],[170,17,170,18,1],[171,21,171,50,1],[172,17,172,18,1],[173,13,173,14,1],[174,9,174,10,1],[178,9,178,10,1],[179,13,179,37,1],[181,13,183,29,1],[183,29,183,42,1],[183,42,184,33,1],[181,13,184,33,1],[186,13,186,47,1],[188,13,188,20,1],[188,22,188,27,1],[188,28,188,30,1],[188,31,188,36,1],[189,13,189,14,1],[190,17,190,30,1],[193,25,193,52,1],[194,25,194,52,1],[195,25,195,31,1],[197,25,197,53,1],[198,25,198,52,1],[199,25,199,31,1],[201,25,201,53,1],[202,25,202,51,1],[203,25,203,31,1],[205,25,205,52,0],[206,25,206,31,0],[208,13,208,14,1],[209,9,209,10,1],[215,19,215,32,1],[216,13,216,14,1],[216,14,216,15,1],[222,9,222,10,0],[223,13,223,37,0],[225,13,226,30,0],[226,30,226,45,0],[226,45,232,29,0],[232,29,232,42,0],[232,42,234,28,0],[225,13,234,28,0],[236,13,236,47,0],[238,13,238,20,0],[238,22,238,27,0],[238,28,238,30,0],[238,31,238,36,0],[239,13,239,14,0],[240,17,240,30,0],[243,25,243,52,0],[244,25,244,51,0],[245,25,245,31,0],[247,25,247,52,0],[248,25,248,31,0],[250,13,250,14,0],[251,9,251,10,0],[255,9,255,10,1],[256,13,256,37,1],[258,13,258,61,1],[260,13,260,20,1],[260,22,260,30,1],[260,31,260,33,1],[260,34,260,39,1],[261,13,261,14,1],[262,17,262,37,1],[263,17,263,18,1],[264,21,264,51,1],[265,17,265,18,1],[267,17,267,18,1],[268,21,268,50,1],[269,17,269,18,1],[270,13,270,14,1],[271,9,271,10,1],[275,9,275,10,1],[276,13,276,37,1],[278,13,278,20,1],[278,22,278,27,1],[278,28,278,30,1],[278,31,278,51,1],[279,13,279,14,1],[280,17,280,34,1],[281,17,281,18,1],[282,21,282,48,1],[283,17,283,18,1],[285,17,285,18,1],[286,21,286,47,1],[287,17,287,18,1],[288,13,288,14,1],[289,9,289,10,1],[293,9,293,10,1],[294,13,294,37,1],[296,13,298,33,1],[300,13,300,20,1],[300,22,300,30,1],[300,31,300,33,1],[300,34,300,39,1],[301,13,301,14,1],[302,17,302,37,1],[303,17,303,18,1],[304,21,304,51,1],[305,17,305,18,1],[307,17,307,18,1],[308,21,308,50,1],[309,17,309,18,1],[310,13,310,14,1],[311,9,311,10,1],[315,6,315,7,1],[316,13,316,37,1],[318,10,318,86,1],[319,10,319,26,1],[322,13,322,20,1],[322,22,322,27,1],[322,28,322,30,1],[322,31,322,54,1],[323,17,323,60,1],[324,6,324,7,1],[328,3,328,4,1],[329,4,329,28,1],[330,4,330,54,1],[331,4,331,57,1],[332,4,332,55,1],[333,4,333,33,1],[334,3,334,4,1],[338,3,338,4,1],[339,4,339,28,1],[341,4,341,50,1],[342,13,342,63,1],[343,4,343,75,1],[345,4,345,64,1],[346,13,346,64,1],[347,13,347,85,1],[349,13,349,60,1],[350,13,350,64,1],[351,13,351,85,1],[352,3,352,4,1],[356,3,356,4,1],[357,4,357,28,1],[359,4,359,46,1],[359,46,359,53,1],[359,53,362,26,1],[362,26,362,101,1],[362,101,362,103,1],[359,4,362,103,1],[364,4,364,29,1],[365,3,365,4,1],[369,3,369,4,1],[370,4,370,28,1],[371,4,371,36,1],[372,4,372,24,1],[373,4,373,36,1],[374,4,374,24,1],[375,4,375,36,1],[376,4,376,24,1],[377,4,377,36,1],[378,3,378,4,1],[382,3,382,4,1],[383,4,383,28,1],[384,4,384,33,1],[385,4,385,24,1],[386,4,386,34,1],[387,4,387,24,1],[388,4,388,33,1],[389,4,389,24,1],[390,4,390,34,1],[391,3,391,4,1],[395,3,395,4,1],[396,4,396,28,1],[397,4,397,37,1],[398,4,398,24,1],[399,4,399,36,1],[400,4,400,24,1],[401,4,401,37,1],[402,4,402,24,1],[403,4,403,36,1],[404,3,404,4,1],[408,3,408,4,1],[409,4,409,28,1],[410,4,410,37,1],[411,4,411,24,1],[412,4,412,37,1],[413,4,413,24,1],[414,4,414,37,1],[415,4,415,24,1],[416,4,416,37,1],[417,3,417,4,1],[421,3,421,4,1],[422,4,422,28,1],[424,4,424,59,1],[426,4,426,39,1],[427,4,427,42,1],[427,42,427,68,1],[427,68,427,79,1],[427,4,427,79,1],[428,4,428,42,1],[428,42,428,78,1],[428,78,428,89,1],[428,4,428,89,1],[429,3,429,4,1],[433,3,433,4,1],[434,4,434,28,1],[436,4,436,79,1],[437,4,437,69,1],[439,4,439,39,1],[440,4,440,39,1],[441,3,441,4,1],[445,3,445,4,1],[446,4,446,28,1],[448,4,448,53,1],[450,4,450,56,1],[451,9,451,18,1],[451,20,451,43,1],[451,45,451,48,1],[452,4,452,5,1],[453,5,453,63,1],[454,4,454,5,1],[456,3,456,4,1],[460,3,460,4,1],[461,4,461,28,1],[462,4,462,39,1],[463,4,463,41,1],[463,41,463,45,1],[463,45,463,48,1],[463,4,463,48,1],[464,4,464,58,1],[466,4,466,24,1],[467,4,467,36,1],[468,4,468,38,1],[468,38,468,42,0],[468,42,468,45,1],[468,4,468,45,1],[469,4,469,55,1],[470,3,470,4,1],[474,9,474,10,1],[475,13,475,37,1],[477,13,477,71,1],[479,13,479,41,1],[480,9,480,10,1],[484,3,484,4,1],[485,4,485,28,1],[487,4,487,74,1],[489,13,489,36,1],[490,3,490,4,1],[494,3,494,4,1],[495,4,495,28,1],[497,4,497,72,1],[498,4,498,47,1],[500,4,500,28,1],[501,4,501,28,1],[502,3,502,4,1],[506,3,506,4,1],[507,4,507,28,1],[509,4,509,56,1],[510,4,510,45,1],[512,3,512,4,1],[516,3,516,4,1],[517,4,517,31,1],[518,4,518,32,1],[520,4,520,39,1],[521,4,521,39,1],[522,3,522,4,1],[526,3,526,4,1],[527,4,527,28,1],[529,4,529,38,1],[531,4,531,29,1],[534,13,534,46,1],[535,3,535,4,1],[539,6,539,7,1],[540,10,540,34,1],[541,10,541,45,1],[542,13,542,38,1],[543,13,543,46,1],[544,6,544,7,1],[548,3,548,4,1],[549,4,549,28,1],[551,4,551,39,1],[553,4,553,29,1],[555,4,555,39,1],[556,4,556,37,1],[556,37,556,52,1],[556,52,556,103,1],[556,4,556,103,1],[557,3,557,4,1],[561,3,561,4,1],[562,4,562,28,1],[564,4,564,33,1],[566,4,566,29,1],[568,4,568,39,1],[569,4,569,37,1],[569,37,569,52,1],[569,52,569,97,1],[569,4,569,97,1],[570,3,570,4,1],[574,3,574,4,1],[575,4,575,28,1],[577,4,577,41,1],[579,4,579,29,1],[581,4,581,39,1],[582,4,582,37,1],[582,37,582,52,1],[582,52,582,115,1],[582,4,582,115,1],[583,3,583,4,1],[587,3,587,4,1],[588,4,588,28,1],[590,4,590,35,1],[592,4,592,29,1],[594,4,594,39,1],[595,4,595,37,1],[595,37,595,52,1],[595,52,595,115,1],[595,4,595,115,1],[596,3,596,4,1],[600,3,600,4,1],[601,4,601,28,1],[603,4,603,26,1],[605,4,605,29,1],[607,4,607,47,1],[608,3,608,4,1],[612,3,612,4,1],[613,4,613,28,1],[615,4,615,28,1],[617,4,617,29,1],[619,4,619,47,1],[620,3,620,4,1],[624,3,624,4,1],[625,4,625,28,1],[627,4,627,28,1],[629,4,629,29,1],[631,4,631,47,1],[632,3,632,4,1],[636,3,636,4,1],[637,13,637,37,1],[639,4,639,30,1],[640,3,640,4,1],[644,3,644,4,1],[645,4,645,28,1],[647,4,647,34,1],[648,3,648,4,1],[652,3,652,4,1],[653,4,653,28,1],[655,4,655,32,1],[657,4,657,29,1],[659,4,659,47,1],[660,3,660,4,1],[664,9,664,10,1],[665,13,665,102,1],[666,13,666,79,1],[667,13,667,50,1],[668,13,668,47,1],[669,9,669,10,1],[672,6,672,7,0],[673,13,673,37,0],[674,13,674,94,0],[675,13,675,59,0],[676,13,677,13,0],[677,13,677,14,0],[677,14,679,17,0],[679,17,679,81,0],[679,81,679,82,0],[679,82,679,95,0],[679,95,680,17,0],[680,17,680,87,0],[680,87,681,13,0],[681,13,681,14,0],[681,14,681,16,0],[676,13,681,16,0],[683,13,683,53,0],[684,9,684,10,0],[687,6,687,7,0],[689,10,689,55,0],[690,10,690,34,0],[691,10,691,34,0],[693,10,693,99,0],[694,10,694,102,0],[695,10,695,27,0],[696,10,696,23,0],[698,13,700,95,0],[701,9,701,10,0],[708,10,708,106,0],[709,10,709,11,0],[710,14,710,47,0],[711,14,711,45,0],[712,10,712,11,0],[714,40,714,41,0],[714,42,714,84,0],[714,85,714,86,0],[715,50,715,51,0],[715,52,715,104,0],[715,105,715,106,0]]);
    </script>
  </body>
</html>