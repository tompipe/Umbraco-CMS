<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\DisposableTimer.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.Web;
using Umbraco.Core.Logging;
using Umbraco.Core.Profiling;

namespace Umbraco.Core
{
	/// &lt;summary&gt;
	/// Starts the timer and invokes a  callback upon disposal. Provides a simple way of timing an operation by wrapping it in a &lt;code&gt;using&lt;/code&gt; (C#) statement.
	/// &lt;/summary&gt;
	public class DisposableTimer : DisposableObject
	{
	    private readonly ILogger _logger;
	    private readonly LogType? _logType;
	    private readonly IProfiler _profiler;
	    private readonly Type _loggerType;
	    private readonly string _endMessage;
	    private readonly IDisposable _profilerStep;
	    private readonly Stopwatch _stopwatch = Stopwatch.StartNew();
		private readonly Action&lt;long&gt; _callback;

	    internal enum LogType
	    {
	        Debug, Info
	    }

        internal DisposableTimer(ILogger logger, LogType logType, IProfiler profiler, Type loggerType, string startMessage, string endMessage)
        {
            if (logger == null) throw new ArgumentNullException(&quot;logger&quot;);
            if (loggerType == null) throw new ArgumentNullException(&quot;loggerType&quot;);

            _logger = logger;
            _logType = logType;
            _profiler = profiler;
            _loggerType = loggerType;
            _endMessage = endMessage;
            
            switch (logType)
            {
                case LogType.Debug:
                    logger.Debug(loggerType, startMessage);
                    break;
                case LogType.Info:
                    logger.Info(loggerType, startMessage);
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;logType&quot;);
            }
            
            if (profiler != null)
            {
                _profilerStep = profiler.Step(loggerType, startMessage);
            }
        }

	    protected internal DisposableTimer(Action&lt;long&gt; callback)
	    {
	        if (callback == null) throw new ArgumentNullException(&quot;callback&quot;);
	        _callback = callback;
	    }

	    public Stopwatch Stopwatch
		{
			get { return _stopwatch; }
		}

		/// &lt;summary&gt;
		/// Starts the timer and invokes the specified callback upon disposal.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;callback&quot;&gt;The callback.&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		[Obsolete(&quot;Use either TraceDuration or DebugDuration instead of using Start&quot;)]
		public static DisposableTimer Start(Action&lt;long&gt; callback)
		{
			return new DisposableTimer(callback);
		}

        #region TraceDuration

        [EditorBrowsable(EditorBrowsableState.Never)]
        [Obsolete(&quot;Use the other methods that specify strings instead of Func&quot;)]
        public static DisposableTimer TraceDuration&lt;T&gt;(Func&lt;string&gt; startMessage, Func&lt;string&gt; completeMessage)
        {
            return TraceDuration(typeof(T), startMessage, completeMessage);
        }

        [EditorBrowsable(EditorBrowsableState.Never)]
        [Obsolete(&quot;Use the other methods that specify strings instead of Func&quot;)]
        public static DisposableTimer TraceDuration(Type loggerType, Func&lt;string&gt; startMessage, Func&lt;string&gt; completeMessage)
        {
            return new DisposableTimer(
                LoggerResolver.Current.Logger, 
                LogType.Info, 
                ProfilerResolver.HasCurrent ? ProfilerResolver.Current.Profiler : null,
                loggerType, 
                startMessage(), 
                completeMessage());
        }

        /// &lt;summary&gt;
        /// Adds a start and end log entry as Info and tracks how long it takes until disposed.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;startMessage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;completeMessage&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use the Umbraco.Core.Logging.ProfilingLogger to create instances of DisposableTimer&quot;)]
        public static DisposableTimer TraceDuration&lt;T&gt;(string startMessage, string completeMessage)
        {
            return TraceDuration(typeof(T), startMessage, completeMessage);
        }

        /// &lt;summary&gt;
        /// Adds a start and end log entry as Info and tracks how long it takes until disposed.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;startMessage&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use the Umbraco.Core.Logging.ProfilingLogger to create instances of DisposableTimer&quot;)]
        public static DisposableTimer TraceDuration&lt;T&gt;(string startMessage)
        {
            return TraceDuration(typeof(T), startMessage, &quot;Complete&quot;);
        }

        /// &lt;summary&gt;
        /// Adds a start and end log entry as Info and tracks how long it takes until disposed.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;loggerType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;startMessage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;completeMessage&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use the Umbraco.Core.Logging.ProfilingLogger to create instances of DisposableTimer&quot;)]
        public static DisposableTimer TraceDuration(Type loggerType, string startMessage, string completeMessage)
        {
            return new DisposableTimer(
                LoggerResolver.Current.Logger,
                LogType.Info, 
                ProfilerResolver.HasCurrent ? ProfilerResolver.Current.Profiler : null,
                loggerType,
                startMessage,
                completeMessage);
        }

        #endregion

        #region DebugDuration
        /// &lt;summary&gt;
        /// Adds a start and end log entry as Debug and tracks how long it takes until disposed.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;startMessage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;completeMessage&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use the Umbraco.Core.Logging.ProfilingLogger to create instances of DisposableTimer&quot;)]
        public static DisposableTimer DebugDuration&lt;T&gt;(string startMessage, string completeMessage)
        {
            return DebugDuration(typeof(T), startMessage, completeMessage);
        }

        /// &lt;summary&gt;
        /// Adds a start and end log entry as Debug and tracks how long it takes until disposed.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;startMessage&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use the Umbraco.Core.Logging.ProfilingLogger to create instances of DisposableTimer&quot;)]
        public static DisposableTimer DebugDuration&lt;T&gt;(string startMessage)
        {
            return DebugDuration(typeof(T), startMessage, &quot;Complete&quot;);
        }

        [EditorBrowsable(EditorBrowsableState.Never)]
        [Obsolete(&quot;Use the other methods that specify strings instead of Func&quot;)]
        public static DisposableTimer DebugDuration&lt;T&gt;(Func&lt;string&gt; startMessage, Func&lt;string&gt; completeMessage)
        {
            return DebugDuration(typeof(T), startMessage, completeMessage);
        }

        /// &lt;summary&gt;
        /// Adds a start and end log entry as Debug and tracks how long it takes until disposed.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;loggerType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;startMessage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;completeMessage&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use the Umbraco.Core.Logging.ProfilingLogger to create instances of DisposableTimer&quot;)]
        public static DisposableTimer DebugDuration(Type loggerType, string startMessage, string completeMessage)
        {
            return new DisposableTimer(
                LoggerResolver.Current.Logger,
                LogType.Debug,
                ProfilerResolver.HasCurrent ? ProfilerResolver.Current.Profiler : null,
                loggerType,
                startMessage,
                completeMessage);
        }

        [EditorBrowsable(EditorBrowsableState.Never)]
        [Obsolete(&quot;Use the other methods that specify strings instead of Func&quot;)]
        public static DisposableTimer DebugDuration(Type loggerType, Func&lt;string&gt; startMessage, Func&lt;string&gt; completeMessage)
        {
            return new DisposableTimer(
                LoggerResolver.Current.Logger,
                LogType.Debug,
                ProfilerResolver.HasCurrent ? ProfilerResolver.Current.Profiler : null,
                loggerType,
                startMessage(),
                completeMessage());
        } 
        #endregion

		/// &lt;summary&gt;
		/// Handles the disposal of resources. Derived from abstract class &lt;see cref=&quot;DisposableObject&quot;/&gt; which handles common required locking logic.
		/// &lt;/summary&gt;
		protected override void DisposeResources()
		{
            if (_profiler != null)
            {
                _profiler.DisposeIfDisposable();
            }

		    if (_profilerStep != null)
		    {
                _profilerStep.Dispose();
            }

		    if (_logType.HasValue &amp;&amp; _endMessage.IsNullOrWhiteSpace() == false &amp;&amp; _loggerType != null &amp;&amp; _logger != null)
		    {
                switch (_logType)
                {
                    case LogType.Debug:
                        _logger.Debug(_loggerType, () =&gt; _endMessage + &quot; (took &quot; + Stopwatch.ElapsedMilliseconds + &quot;ms)&quot;);
                        break;
                    case LogType.Info:
                        _logger.Info(_loggerType, () =&gt; _endMessage + &quot; (took &quot; + Stopwatch.ElapsedMilliseconds + &quot;ms)&quot;);
                        break;
                    default:
                        throw new ArgumentOutOfRangeException(&quot;logType&quot;);
                }
            }

		    if (_callback != null)
		    {
                _callback.Invoke(Stopwatch.ElapsedMilliseconds);
            }
            
		}

	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,6,22,67,1],[22,6,22,67,1],[30,9,30,143,1],[31,9,31,10,1],[32,13,32,32,1],[32,33,32,75,0],[33,13,33,36,1],[33,37,33,83,0],[35,13,35,30,1],[36,13,36,32,1],[37,13,37,34,1],[38,13,38,38,1],[39,13,39,38,1],[41,13,41,29,1],[44,21,44,60,1],[45,21,45,27,1],[47,21,47,59,1],[48,21,48,27,1],[50,21,50,70,0],[53,13,53,34,1],[54,13,54,14,1],[55,17,55,73,1],[56,13,56,14,1],[57,9,57,10,1],[59,6,59,63,1],[60,6,60,7,1],[61,10,61,31,1],[61,32,61,76,0],[62,10,62,31,1],[63,6,63,7,1],[67,8,67,9,1],[67,10,67,28,1],[67,29,67,30,1],[77,3,77,4,0],[78,4,78,41,0],[79,3,79,4,0],[86,9,86,10,0],[87,13,87,76,0],[88,9,88,10,0],[93,9,93,10,0],[94,13,100,36,0],[101,9,101,10,0],[112,9,112,10,0],[113,13,113,76,0],[114,9,114,10,0],[124,9,124,10,0],[125,13,125,71,0],[126,9,126,10,0],[137,9,137,10,0],[138,13,144,34,0],[145,9,145,10,0],[159,9,159,10,0],[160,13,160,76,0],[161,9,161,10,0],[171,9,171,10,0],[172,13,172,71,0],[173,9,173,10,0],[178,9,178,10,0],[179,13,179,76,0],[180,9,180,10,0],[191,9,191,10,0],[192,13,198,34,0],[199,9,199,10,0],[204,9,204,10,0],[205,13,211,36,0],[212,9,212,10,0],[219,3,219,4,1],[220,13,220,35,1],[221,13,221,14,1],[222,17,222,49,1],[223,13,223,14,1],[225,7,225,33,1],[226,7,226,8,1],[227,17,227,41,1],[228,13,228,14,1],[230,7,230,116,1],[231,7,231,8,1],[232,17,232,34,1],[235,25,235,58,1],[235,58,235,121,0],[235,121,235,123,1],[235,25,235,123,1],[236,25,236,31,1],[238,25,238,57,1],[238,57,238,120,0],[238,120,238,122,1],[238,25,238,122,1],[239,25,239,31,1],[241,25,241,74,0],[243,13,243,14,1],[245,7,245,29,1],[246,7,246,8,1],[247,17,247,65,1],[248,13,248,14,1],[250,3,250,4,1]]);
    </script>
  </body>
</html>