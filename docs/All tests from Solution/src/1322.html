<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\DashboardSecurity.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Linq;
using Umbraco.Core;
using Umbraco.Core.Configuration.Dashboard;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Services;

namespace Umbraco.Web.Editors
{
    /// &lt;summary&gt;
    /// A utility class for determine dashboard security
    /// &lt;/summary&gt;
    internal class DashboardSecurity
    {
        //TODO: Unit test all this!!! :/

        public static bool AuthorizeAccess(ISection dashboardSection, IUser user, ISectionService sectionService)
        {
            if (user.Id.ToString(CultureInfo.InvariantCulture) == 0.ToInvariantString())
            {
                return true;
            }

            var denyTypes = dashboardSection.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.Deny).ToArray();
            var grantedTypes = dashboardSection.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.Grant).ToArray();
            var grantedBySectionTypes = dashboardSection.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.GrantBySection).ToArray();

            return CheckUserAccessByRules(user, sectionService, denyTypes, grantedTypes, grantedBySectionTypes);
        }

        public static bool AuthorizeAccess(IDashboardTab dashboardTab, IUser user, ISectionService sectionService)
        {
            if (user.Id.ToString(CultureInfo.InvariantCulture) == Constants.System.Root.ToInvariantString())
            {
                return true;
            }

            var denyTypes = dashboardTab.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.Deny).ToArray();
            var grantedTypes = dashboardTab.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.Grant).ToArray();
            var grantedBySectionTypes = dashboardTab.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.GrantBySection).ToArray();

            return CheckUserAccessByRules(user, sectionService, denyTypes, grantedTypes, grantedBySectionTypes);
        }

        public static bool AuthorizeAccess(IDashboardControl dashboardTab, IUser user, ISectionService sectionService)
        {
            if (user.Id.ToString(CultureInfo.InvariantCulture) == Constants.System.Root.ToInvariantString())
            {
                return true;
            }

            var denyTypes = dashboardTab.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.Deny).ToArray();
            var grantedTypes = dashboardTab.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.Grant).ToArray();
            var grantedBySectionTypes = dashboardTab.AccessRights.Rules.Where(x =&gt; x.Action == AccessType.GrantBySection).ToArray();

            return CheckUserAccessByRules(user, sectionService, denyTypes, grantedTypes, grantedBySectionTypes);
        }

        public static bool CheckUserAccessByRules(IUser user, ISectionService sectionService, IAccessItem[] denyTypes, IAccessItem[] grantedTypes, IAccessItem[] grantedBySectionTypes)
        {
            var allowedSoFar = false;

            //Check if this item as any grant-by-section arguments, if so check if the user has access to any of the sections approved, if so they will
            // be allowed to see it (so far)
            if (grantedBySectionTypes.Any())
            {
                var allowedApps = sectionService.GetAllowedSections(Convert.ToInt32(user.Id))
                                                .Select(x =&gt; x.Alias)
                                                .ToArray();

                var allApprovedSections = grantedBySectionTypes.SelectMany(g =&gt; g.Value.Split(new[] { &#39;,&#39; }, StringSplitOptions.RemoveEmptyEntries)).ToArray();
                if (allApprovedSections.Any(allowedApps.Contains))
                {
                    allowedSoFar = true;
                }
            }

            //Check if this item as any grant arguments, if so check if the user is one of the user types approved, if so they will
            // be allowed to see it (so far)
            if (grantedTypes.Any())
            {
                var allApprovedUserTypes = grantedTypes.SelectMany(g =&gt; g.Value.Split(new[] {&#39;,&#39;}, StringSplitOptions.RemoveEmptyEntries)).ToArray();
                if (allApprovedUserTypes.InvariantContains(user.UserType.Alias))
                {
                    allowedSoFar = true;
                }
            }
            else
            {
                //if there are not explicit grant types then everyone is allowed so far and we&#39;ll only disallow on a deny basis
                allowedSoFar = true;
            }

            //Check if this item as any deny arguments, if so check if the user is one of the user types approved, if so they will
            // be denied to see it no matter what
            if (denyTypes.Any())
            {
                var allDeniedUserTypes = denyTypes.SelectMany(g =&gt; g.Value.Split(new[] { &#39;,&#39; }, StringSplitOptions.RemoveEmptyEntries)).ToArray();
                if (allDeniedUserTypes.InvariantContains(user.UserType.Alias))
                {
                    allowedSoFar = false;
                }
            }

            return allowedSoFar;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,10,0],[20,13,20,89,0],[21,13,21,14,0],[22,17,22,29,0],[25,13,25,76,0],[25,76,25,103,0],[25,103,25,115,0],[25,13,25,115,0],[26,13,26,79,0],[26,79,26,107,0],[26,107,26,119,0],[26,13,26,119,0],[27,13,27,88,0],[27,88,27,125,0],[27,125,27,137,0],[27,13,27,137,0],[29,13,29,113,0],[30,9,30,10,0],[33,9,33,10,0],[34,13,34,109,0],[35,13,35,14,0],[36,17,36,29,0],[39,13,39,72,0],[39,72,39,99,0],[39,99,39,111,0],[39,13,39,111,0],[40,13,40,75,0],[40,75,40,103,0],[40,103,40,115,0],[40,13,40,115,0],[41,13,41,84,0],[41,84,41,121,0],[41,121,41,133,0],[41,13,41,133,0],[43,13,43,113,0],[44,9,44,10,0],[47,9,47,10,0],[48,13,48,109,0],[49,13,49,14,0],[50,17,50,29,0],[53,13,53,72,0],[53,72,53,99,0],[53,99,53,111,0],[53,13,53,111,0],[54,13,54,75,0],[54,75,54,103,0],[54,103,54,115,0],[54,13,54,115,0],[55,13,55,84,0],[55,84,55,121,0],[55,121,55,133,0],[55,13,55,133,0],[57,13,57,113,0],[58,9,58,10,0],[61,9,61,10,0],[62,13,62,38,0],[66,13,66,45,0],[67,13,67,14,0],[68,17,69,62,0],[69,62,69,69,0],[69,69,70,60,0],[68,17,70,60,0],[72,17,72,81,0],[72,81,72,148,0],[72,148,72,160,0],[72,17,72,160,0],[73,17,73,67,0],[74,17,74,18,0],[75,21,75,41,0],[76,17,76,18,0],[77,13,77,14,0],[81,13,81,36,0],[82,13,82,14,0],[83,17,83,73,0],[83,73,83,138,0],[83,138,83,150,0],[83,17,83,150,0],[84,17,84,81,0],[85,17,85,18,0],[86,21,86,41,0],[87,17,87,18,0],[88,13,88,14,0],[90,13,90,14,0],[92,17,92,37,0],[93,13,93,14,0],[97,13,97,33,0],[98,13,98,14,0],[99,17,99,68,0],[99,68,99,135,0],[99,135,99,147,0],[99,17,99,147,0],[100,17,100,79,0],[101,17,101,18,0],[102,21,102,42,0],[103,17,103,18,0],[104,13,104,14,0],[106,13,106,33,0],[107,9,107,10,0]]);
    </script>
  </body>
</html>