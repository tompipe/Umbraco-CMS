<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PublishedCache\XmlPublishedCache\RoutesCache.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Umbraco.Core.ObjectResolution;

namespace Umbraco.Web.PublishedCache.XmlPublishedCache
{
    class RoutesCache
    {
        private ConcurrentDictionary&lt;int, string&gt; _routes;
        private ConcurrentDictionary&lt;string, int&gt; _nodeIds;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;RoutesCache&quot;/&gt; class.
        /// &lt;/summary&gt;
        public RoutesCache()
            : this(true)
        { }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;RoutesCache&quot;/&gt; class.
        /// &lt;/summary&gt;
        internal RoutesCache(bool bindToEvents)
		{
			Clear();

			if (bindToEvents)
			{
                Resolution.Frozen += ResolutionFrozen;
			}			
		}

        /// &lt;summary&gt;
        /// Once resolution is frozen, then we can bind to the events that we require
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;s&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;
        private void ResolutionFrozen(object s, EventArgs args)
        {
            // content - whenever the entire XML cache is rebuilt (from disk cache or from database)
            //  we must clear the cache entirely
            global::umbraco.content.AfterRefreshContent += (sender, e) =&gt; Clear();

            // document - whenever a document is updated in, or removed from, the XML cache
            //  we must clear the cache - at the moment, we clear the entire cache
            global::umbraco.content.AfterUpdateDocumentCache += (sender, e) =&gt; Clear();
            global::umbraco.content.AfterClearDocumentCache += (sender, e) =&gt; Clear();

            // fixme - should refactor once content events are refactored
            // the content class needs to be refactored - at the moment 
            // content.XmlContentInternal setter does not trigger any event
            // content.UpdateDocumentCache(List&lt;Document&gt; Documents) does not trigger any event
            // content.RefreshContentFromDatabaseAsync triggers AfterRefresh _while_ refreshing
            // etc...
            // in addition some events do not make sense... we trigger Publish when moving
            // a node, which we should not (the node is moved, not published...) etc.
        }

        /// &lt;summary&gt;
        /// Used ONLY for unit tests
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal IDictionary&lt;int, string&gt; GetCachedRoutes()
        {
            return _routes;
        }

        /// &lt;summary&gt;
        /// Used ONLY for unit tests
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal IDictionary&lt;string, int&gt; GetCachedIds()
        {
            return _nodeIds;
        }

        #region Public

        /// &lt;summary&gt;
        /// Stores a route for a node.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeId&quot;&gt;The node identified.&lt;/param&gt;
        /// &lt;param name=&quot;route&quot;&gt;The route.&lt;/param&gt;
        /// &lt;param name=&quot;trust&quot;&gt;A value indicating whether the value can be trusted for inbound routing.&lt;/param&gt;
        public void Store(int nodeId, string route, bool trust)
        {
            _routes.AddOrUpdate(nodeId, i =&gt; route, (i, s) =&gt; route);
            if (trust)
                _nodeIds.AddOrUpdate(route, i =&gt; nodeId, (i, s) =&gt; nodeId);
        }

        /// &lt;summary&gt;
        /// Gets a route for a node.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeId&quot;&gt;The node identifier.&lt;/param&gt;
        /// &lt;returns&gt;The route for the node, else null.&lt;/returns&gt;
        public string GetRoute(int nodeId)
        {
            string val;
            _routes.TryGetValue(nodeId, out val);
            return val;
        }

        /// &lt;summary&gt;
        /// Gets a node for a route.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;route&quot;&gt;The route.&lt;/param&gt;
        /// &lt;returns&gt;The node identified for the route, else zero.&lt;/returns&gt;
        public int GetNodeId(string route)
        {
            int val;
            _nodeIds.TryGetValue(route, out val);
            return val;
        }

        /// &lt;summary&gt;
        /// Clears the route for a node.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;nodeId&quot;&gt;The node identifier.&lt;/param&gt;
        public void ClearNode(int nodeId)
        {
            string route;
            if (_routes.TryRemove(nodeId, out route))
            {
                int id;
                _nodeIds.TryRemove(route, out id);
            }
        }

        /// &lt;summary&gt;
        /// Clears all routes.
        /// &lt;/summary&gt;
        public void Clear()
        {
            _routes = new ConcurrentDictionary&lt;int, string&gt;();
            _nodeIds = new ConcurrentDictionary&lt;string, int&gt;();
        }
        
        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[19,15,19,25,0],[20,9,20,10,0],[20,11,20,12,0],[25,9,25,48,1],[26,3,26,4,1],[27,4,27,12,1],[29,4,29,21,1],[30,4,30,5,1],[31,17,31,55,1],[32,4,32,5,1],[33,3,33,4,1],[41,9,41,10,0],[44,13,44,75,0],[44,75,44,82,0],[44,82,44,83,0],[44,13,44,83,0],[48,13,48,80,0],[48,80,48,87,0],[48,87,48,88,0],[48,13,48,88,0],[49,13,49,79,0],[49,79,49,86,0],[49,86,49,87,0],[49,13,49,87,0],[59,9,59,10,0],[66,9,66,10,1],[67,13,67,28,1],[68,9,68,10,1],[75,9,75,10,1],[76,13,76,29,1],[77,9,77,10,1],[88,9,88,10,1],[89,13,89,46,1],[89,46,89,51,1],[89,51,89,63,1],[89,63,89,68,0],[89,68,89,70,1],[89,13,89,70,1],[90,13,90,23,1],[91,17,91,50,1],[91,50,91,56,1],[91,56,91,68,1],[91,68,91,74,0],[91,74,91,76,1],[91,17,91,76,1],[92,9,92,10,1],[100,9,100,10,1],[102,13,102,50,1],[103,13,103,24,1],[104,9,104,10,1],[112,9,112,10,1],[114,13,114,50,1],[115,13,115,24,1],[116,9,116,10,1],[123,9,123,10,0],[125,13,125,54,0],[126,13,126,14,0],[128,17,128,51,0],[129,13,129,14,0],[130,9,130,10,0],[136,9,136,10,1],[137,13,137,63,1],[138,13,138,64,1],[139,9,139,10,1]]);
    </script>
  </body>
</html>