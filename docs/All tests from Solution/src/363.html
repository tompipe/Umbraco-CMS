<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\MemberTypeRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;

using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class MemberTypeRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        private MemberTypeRepository CreateRepository(IDatabaseUnitOfWork unitOfWork)
        {
            return new MemberTypeRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax);            
        }

        [Test]
        public void Can_Persist_Member_Type()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var memberType = (IMemberType)MockedContentTypes.CreateSimpleMemberType();
                repository.AddOrUpdate(memberType);
                unitOfWork.Commit();

                var sut = repository.Get(memberType.Id);

                var standardProps = Constants.Conventions.Member.GetStandardPropertyTypeStubs();

                Assert.That(sut, Is.Not.Null);
                Assert.That(sut.PropertyGroups.Count(), Is.EqualTo(2));
                Assert.That(sut.PropertyTypes.Count(), Is.EqualTo(3 + standardProps.Count));

                Assert.That(sut.PropertyGroups.Any(x =&gt; x.HasIdentity == false || x.Id == 0), Is.False);
                Assert.That(sut.PropertyTypes.Any(x =&gt; x.HasIdentity == false || x.Id == 0), Is.False);

                TestHelper.AssertAllPropertyValuesAreEquals(sut, memberType, &quot;yyyy-MM-dd HH:mm:ss&quot;);
            }
        }

        [Test]
        public void Can_Persist_Member_Type_Same_Property_Keys()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var memberType = (IMemberType)MockedContentTypes.CreateSimpleMemberType();
                
                repository.AddOrUpdate(memberType);
                unitOfWork.Commit();

                var propertyKeys = memberType.PropertyTypes.Select(x =&gt; x.Key).OrderBy(x =&gt; x).ToArray();
                var groupKeys = memberType.PropertyGroups.Select(x =&gt; x.Key).OrderBy(x =&gt; x).ToArray();

                memberType = repository.Get(memberType.Id);
                var propertyKeys2 = memberType.PropertyTypes.Select(x =&gt; x.Key).OrderBy(x =&gt; x).ToArray();
                var groupKeys2 = memberType.PropertyGroups.Select(x =&gt; x.Key).OrderBy(x =&gt; x).ToArray();

                Assert.IsTrue(propertyKeys.SequenceEqual(propertyKeys2));
                Assert.IsTrue(groupKeys.SequenceEqual(groupKeys2));

            }
        }

        [Test]
        public void Cannot_Persist_Member_Type_Without_Alias()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var memberType = MockedContentTypes.CreateSimpleMemberType();
                memberType.Alias = null;
                repository.AddOrUpdate(memberType);

                Assert.Throws&lt;InvalidOperationException&gt;(unitOfWork.Commit);
            }
        }

        [Test]
        public void Can_Get_All_Member_Types()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var memberType1 = MockedContentTypes.CreateSimpleMemberType();
                repository.AddOrUpdate(memberType1);
                unitOfWork.Commit();

                var memberType2 = MockedContentTypes.CreateSimpleMemberType();
                memberType2.Name = &quot;AnotherType&quot;;
                memberType2.Alias = &quot;anotherType&quot;;
                repository.AddOrUpdate(memberType2);
                unitOfWork.Commit();

                var result = repository.GetAll();

                //there are 3 because of the Member type created for init data
                Assert.AreEqual(3, result.Count());
            }
        }

        [Test]
        public void Can_Get_All_Member_Types_By_Guid_Ids()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var memberType1 = MockedContentTypes.CreateSimpleMemberType();
                repository.AddOrUpdate(memberType1);
                unitOfWork.Commit();

                var memberType2 = MockedContentTypes.CreateSimpleMemberType();
                memberType2.Name = &quot;AnotherType&quot;;
                memberType2.Alias = &quot;anotherType&quot;;
                repository.AddOrUpdate(memberType2);
                unitOfWork.Commit();

                var result = ((IReadRepository&lt;Guid, IMemberType&gt;)repository).GetAll(memberType1.Key, memberType2.Key);

                //there are 3 because of the Member type created for init data
                Assert.AreEqual(2, result.Count());
            }
        }

        [Test]
        public void Can_Get_Member_Types_By_Guid_Id()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var memberType1 = MockedContentTypes.CreateSimpleMemberType();
                repository.AddOrUpdate(memberType1);
                unitOfWork.Commit();

                var memberType2 = MockedContentTypes.CreateSimpleMemberType();
                memberType2.Name = &quot;AnotherType&quot;;
                memberType2.Alias = &quot;anotherType&quot;;
                repository.AddOrUpdate(memberType2);
                unitOfWork.Commit();

                var result = repository.Get(memberType1.Key);

                //there are 3 because of the Member type created for init data
                Assert.IsNotNull(result);
                Assert.AreEqual(memberType1.Key, result.Key);
            }
        }


        //NOTE: This tests for left join logic (rev 7b14e8eacc65f82d4f184ef46c23340c09569052)
        [Test]
        public void Can_Get_All_Members_When_No_Properties_Assigned()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var memberType1 = MockedContentTypes.CreateSimpleMemberType();
                memberType1.PropertyTypeCollection.Clear();
                repository.AddOrUpdate(memberType1);
                unitOfWork.Commit();

                var memberType2 = MockedContentTypes.CreateSimpleMemberType();
                memberType2.PropertyTypeCollection.Clear();
                memberType2.Name = &quot;AnotherType&quot;;
                memberType2.Alias = &quot;anotherType&quot;;
                repository.AddOrUpdate(memberType2);
                unitOfWork.Commit();

                var result = repository.GetAll();

                //there are 3 because of the Member type created for init data
                Assert.AreEqual(3, result.Count());
            }
        }


        [Test]
        public void Can_Get_Member_Type_By_Id()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                IMemberType memberType = MockedContentTypes.CreateSimpleMemberType();
                repository.AddOrUpdate(memberType);
                unitOfWork.Commit();
                memberType = repository.Get(memberType.Id);
                Assert.That(memberType, Is.Not.Null);
            }
        }

        [Test]
        public void Can_Get_Member_Type_By_Guid_Id()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                IMemberType memberType = MockedContentTypes.CreateSimpleMemberType();
                repository.AddOrUpdate(memberType);
                unitOfWork.Commit();
                memberType = repository.Get(memberType.Key);
                Assert.That(memberType, Is.Not.Null);
            }
        }

        [Test]
        public void Built_In_Member_Type_Properties_Are_Automatically_Added_When_Creating()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                IMemberType memberType = MockedContentTypes.CreateSimpleMemberType();
                repository.AddOrUpdate(memberType);
                unitOfWork.Commit();

                memberType = repository.Get(memberType.Id);

                Assert.That(memberType.PropertyTypes.Count(), Is.EqualTo(3 + Constants.Conventions.Member.GetStandardPropertyTypeStubs().Count));
                Assert.That(memberType.PropertyGroups.Count(), Is.EqualTo(2));
            }
        }

        //This is to show that new properties are created for each member type - there was a bug before
        // that was reusing the same properties with the same Ids between member types
        [Test]
        public void Built_In_Member_Type_Properties_Are_Not_Reused_For_Different_Member_Types()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                IMemberType memberType1 = MockedContentTypes.CreateSimpleMemberType();
                IMemberType memberType2 = MockedContentTypes.CreateSimpleMemberType(&quot;test2&quot;);
                repository.AddOrUpdate(memberType1);
                repository.AddOrUpdate(memberType2);
                unitOfWork.Commit();

                var m1Ids = memberType1.PropertyTypes.Select(x =&gt; x.Id).ToArray();
                var m2Ids = memberType2.PropertyTypes.Select(x =&gt; x.Id).ToArray();

                Assert.IsFalse(m1Ids.Any(m2Ids.Contains));
            }
        }

        [Test]
        public void Can_Delete_MemberType()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                IMemberType memberType = MockedContentTypes.CreateSimpleMemberType();
                repository.AddOrUpdate(memberType);
                unitOfWork.Commit();

                var contentType2 = repository.Get(memberType.Id);
                repository.Delete(contentType2);
                unitOfWork.Commit();

                var exists = repository.Exists(memberType.Id);

                // Assert
                Assert.That(exists, Is.False);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[24,13,24,31,1],[25,9,25,10,1],[29,9,29,10,1],[30,13,30,29,1],[31,9,31,10,1],[34,9,34,10,1],[35,13,35,129,1],[36,9,36,10,1],[40,9,40,10,1],[41,13,41,67,1],[42,13,42,55,1],[43,20,43,65,1],[44,13,44,14,1],[45,17,45,91,1],[46,17,46,52,1],[47,17,47,37,1],[49,17,49,57,1],[51,17,51,97,1],[53,17,53,47,1],[54,17,54,72,1],[55,17,55,93,1],[57,17,57,57,1],[57,57,57,92,1],[57,92,57,105,1],[57,17,57,105,1],[58,17,58,56,1],[58,56,58,91,1],[58,91,58,104,1],[58,17,58,104,1],[60,17,60,101,1],[61,13,61,14,1],[62,9,62,10,1],[66,9,66,10,1],[67,13,67,67,1],[68,13,68,55,1],[69,20,69,65,1],[70,13,70,14,1],[71,17,71,91,1],[73,17,73,52,1],[74,17,74,37,1],[76,17,76,73,1],[76,73,76,78,1],[76,78,76,93,1],[76,93,76,94,1],[76,94,76,106,1],[76,17,76,106,1],[77,17,77,71,1],[77,71,77,76,1],[77,76,77,91,1],[77,91,77,92,1],[77,92,77,104,1],[77,17,77,104,1],[79,17,79,60,1],[80,17,80,74,1],[80,74,80,79,1],[80,79,80,94,1],[80,94,80,95,1],[80,95,80,107,1],[80,17,80,107,1],[81,17,81,72,1],[81,72,81,77,1],[81,77,81,92,1],[81,92,81,93,1],[81,93,81,105,1],[81,17,81,105,1],[83,17,83,74,1],[84,17,84,68,1],[86,13,86,14,1],[87,9,87,10,1],[91,9,91,10,1],[92,13,92,67,1],[93,13,93,55,1],[94,20,94,65,1],[95,13,95,14,1],[96,17,96,78,1],[97,17,97,41,1],[98,17,98,52,1],[100,17,100,77,1],[101,13,101,14,1],[102,9,102,10,1],[106,9,106,10,1],[107,13,107,67,1],[108,13,108,55,1],[109,20,109,65,1],[110,13,110,14,1],[111,17,111,79,1],[112,17,112,53,1],[113,17,113,37,1],[115,17,115,79,1],[116,17,116,50,1],[117,17,117,51,1],[118,17,118,53,1],[119,17,119,37,1],[121,17,121,50,1],[124,17,124,52,1],[125,13,125,14,1],[126,9,126,10,1],[130,9,130,10,1],[131,13,131,67,1],[132,13,132,55,1],[133,20,133,65,1],[134,13,134,14,1],[135,17,135,79,1],[136,17,136,53,1],[137,17,137,37,1],[139,17,139,79,1],[140,17,140,50,1],[141,17,141,51,1],[142,17,142,53,1],[143,17,143,37,1],[145,17,145,120,1],[148,17,148,52,1],[149,13,149,14,1],[150,9,150,10,1],[154,9,154,10,1],[155,13,155,67,1],[156,13,156,55,1],[157,20,157,65,1],[158,13,158,14,1],[159,17,159,79,1],[160,17,160,53,1],[161,17,161,37,1],[163,17,163,79,1],[164,17,164,50,1],[165,17,165,51,1],[166,17,166,53,1],[167,17,167,37,1],[169,17,169,62,1],[172,17,172,42,1],[173,17,173,62,1],[174,13,174,14,1],[175,9,175,10,1],[181,9,181,10,1],[182,13,182,67,1],[183,13,183,55,1],[184,20,184,65,1],[185,13,185,14,1],[186,17,186,79,1],[187,17,187,60,1],[188,17,188,53,1],[189,17,189,37,1],[191,17,191,79,1],[192,17,192,60,1],[193,17,193,50,1],[194,17,194,51,1],[195,17,195,53,1],[196,17,196,37,1],[198,17,198,50,1],[201,17,201,52,1],[202,13,202,14,1],[203,9,203,10,1],[208,9,208,10,1],[209,13,209,67,1],[210,13,210,55,1],[211,20,211,65,1],[212,13,212,14,1],[213,17,213,86,1],[214,17,214,52,1],[215,17,215,37,1],[216,17,216,60,1],[217,17,217,54,1],[218,13,218,14,1],[219,9,219,10,1],[223,9,223,10,1],[224,13,224,67,1],[225,13,225,55,1],[226,20,226,65,1],[227,13,227,14,1],[228,17,228,86,1],[229,17,229,52,1],[230,17,230,37,1],[231,17,231,61,1],[232,17,232,54,1],[233,13,233,14,1],[234,9,234,10,1],[238,9,238,10,1],[239,13,239,67,1],[240,13,240,55,1],[241,20,241,65,1],[242,13,242,14,1],[243,17,243,86,1],[244,17,244,52,1],[245,17,245,37,1],[247,17,247,60,1],[249,17,249,146,1],[250,17,250,79,1],[251,13,251,14,1],[252,9,252,10,1],[258,9,258,10,1],[259,13,259,67,1],[260,13,260,55,1],[261,20,261,65,1],[262,13,262,14,1],[263,17,263,87,1],[264,17,264,94,1],[265,17,265,53,1],[266,17,266,53,1],[267,17,267,37,1],[269,17,269,67,1],[269,67,269,71,1],[269,71,269,83,1],[269,17,269,83,1],[270,17,270,67,1],[270,67,270,71,1],[270,71,270,83,1],[270,17,270,83,1],[272,17,272,59,1],[273,13,273,14,1],[274,9,274,10,1],[278,9,278,10,1],[280,13,280,67,1],[281,13,281,55,1],[282,20,282,65,1],[283,13,283,14,1],[285,17,285,86,1],[286,17,286,52,1],[287,17,287,37,1],[289,17,289,66,1],[290,17,290,49,1],[291,17,291,37,1],[293,17,293,63,1],[296,17,296,47,1],[297,13,297,14,1],[298,9,298,10,1]]);
    </script>
  </body>
</html>