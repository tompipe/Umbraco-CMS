<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\publish.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.Generic;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core.Logging;
using umbraco.cms.businesslogic.web;
using umbraco.BusinessLogic;
using Umbraco.Core.Logging;
using umbraco.BasePages;

namespace umbraco.dialogs
{
	/// &lt;summary&gt;
	/// Summary description for publish.
	/// &lt;/summary&gt;
	[Obsolete(&quot;This is no longer used whatsoever and will be removed from the codebase&quot;)]
	public partial class publish : UmbracoEnsuredPage
	{
		protected Literal total;

		private int _nodeId;
		private int _nodesPublished = 0;
        private readonly List&lt;cms.businesslogic.web.Document&gt; _documents = new List&lt;cms.businesslogic.web.Document&gt;();
        public static string pageName = &quot;&quot;;

	    public publish()
	    {
	        CurrentApp = DefaultApps.content.ToString();
	    }

		protected void Page_Load(object sender, EventArgs e)
		{
			_nodeId = int.Parse(helper.Request(&quot;id&quot;));
            var d = new cms.businesslogic.web.Document(_nodeId);
            pageName = d.Text;

			if (d.Level &gt; 1 &amp;&amp; d.PathPublished == false)
			{
				TheForm.Visible = false;
				theEnd.Visible = true;
				feedbackMsg.type = uicontrols.Feedback.feedbacktype.notice;
				feedbackMsg.Text = ui.Text(&quot;publish&quot;, &quot;contentPublishedFailedByParent&quot;, d.Text, getUser()) + &quot;&lt;/p&gt;&lt;p&gt;&lt;a href=&#39;#&#39; onClick=&#39;&quot; + ClientTools.Scripts.CloseModalWindow() + &quot;&#39;&gt;&quot; + ui.Text(&quot;closeThisWindow&quot;) + &quot;&lt;/a&gt;&quot;;
	               
				return;
			}

            // add control prefix to variable for support with masterpages
            var prefix = PublishUnpublishedItems.ClientID.Replace(PublishUnpublishedItems.ID, &quot;&quot;);
            masterPagePrefix.Text = prefix;

            // by default we only count the published ones
			var totalNodesToPublish = cms.businesslogic.web.Document.CountSubs(_nodeId, true);
            try
            {
                Application.Lock();
                // We add both all nodes and only published nodes to the application variables so we can ajax query depending on checkboxes
                Application[&quot;publishTotalAll&quot; + _nodeId.ToString()] = cms.businesslogic.CMSNode.CountSubs(_nodeId).ToString();
                Application[&quot;publishTotal&quot; + _nodeId.ToString()] = totalNodesToPublish.ToString();
                Application[&quot;publishDone&quot; + _nodeId.ToString()] = &quot;0&quot;;
            }
            finally
            {
                Application.UnLock();
            }
			total.Text = totalNodesToPublish.ToString();

			// Put user code to initialize the page here
			if (!IsPostBack) 
			{
				// Add caption to checkbox
				PublishAll.Text = ui.Text(&quot;publish&quot;, &quot;publishAll&quot;, d.Text, getUser());
				ok.Text = ui.Text(&quot;content&quot;, &quot;publish&quot;, getUser());
				ok.Attributes.Add(&quot;style&quot;, &quot;width: 60px&quot;);
				ok.Attributes.Add(&quot;onClick&quot;, &quot;startPublication();&quot;);

                // Add checkbox event, so the publish unpublished childs gets enabled
                PublishUnpublishedItems.LabelAttributes.Add(&quot;disabled&quot;, &quot;true&quot;);
                PublishUnpublishedItems.LabelAttributes.Add(&quot;id&quot;, &quot;publishUnpublishedItemsLabel&quot;);
                PublishUnpublishedItems.InputAttributes.Add(&quot;disabled&quot;, &quot;true&quot;);
                PublishAll.InputAttributes.Add(&quot;onclick&quot;, &quot;togglePublishingModes(this)&quot;);
			} 
			else 
			{

                if (PublishAll.Checked)
                {
                    _nodesPublished = 0;

                    DoPublishSubs(d);

                    Application.Lock();
                    Application[&quot;publishTotal&quot; + _nodeId.ToString()] = 0;
                    Application.UnLock();

                    feedbackMsg.type = uicontrols.Feedback.feedbacktype.success;

                    feedbackMsg.Text = ui.Text(&quot;publish&quot;, &quot;nodePublishAll&quot;, d.Text, getUser()) + &quot;&lt;/p&gt;&lt;p&gt;&lt;a href=&#39;#&#39; onclick=&#39;&quot; + ClientTools.Scripts.CloseModalWindow() + &quot;&#39;&gt;&quot; + ui.Text(&quot;closeThisWindow&quot;) + &quot;&lt;/a&gt;&quot;;

					ClientTools.ReloadActionNode(true, true);

                    Application.Lock();

                    Application[&quot;publishTotal&quot; + _nodeId.ToString()] = null;
                    Application[&quot;publishDone&quot; + _nodeId.ToString()] = null;
                    Application.UnLock();
                }
                else
                {
                    if (d.PublishWithResult(getUser()))
                    {                        
                        feedbackMsg.type = uicontrols.Feedback.feedbacktype.success;
						feedbackMsg.Text = ui.Text(&quot;publish&quot;, &quot;nodePublish&quot;, d.Text, getUser()) + &quot;&lt;/p&gt;&lt;p&gt;&lt;a href=&#39;#&#39; onclick=&#39;&quot; + ClientTools.Scripts.CloseModalWindow() + &quot;&#39;&gt;&quot; + ui.Text(&quot;closeThisWindow&quot;) + &quot;&lt;/a&gt;&quot;;						
                    }
                    else {
                        feedbackMsg.type = uicontrols.Feedback.feedbacktype.notice;
						feedbackMsg.Text = ui.Text(&quot;publish&quot;, &quot;contentPublishedFailedByEvent&quot;, d.Text, getUser()) + &quot;&lt;/p&gt;&lt;p&gt;&lt;a href=&#39;#&#39; onClick=&#39;&quot; + ClientTools.Scripts.CloseModalWindow() + &quot;&#39;&gt;&quot; + ui.Text(&quot;closeThisWindow&quot;) + &quot;&lt;/a&gt;&quot;;
                    }
					ClientTools.ReloadActionNode(true, false);
                }

				TheForm.Visible = false;
                theEnd.Visible = true;
			}
		}        

		private void DoPublishSubs(cms.businesslogic.web.Document d) 
		{
            if (d.Published || PublishUnpublishedItems.Checked)
            {
                if (d.PublishWithResult(UmbracoUser))
                {
                    

                    _nodesPublished++;
                    Application.Lock();
                    Application[&quot;publishDone&quot; + _nodeId.ToString()] = _nodesPublished.ToString();
                    Application.UnLock();
                    foreach (var dc in d.Children)
                    {
                        DoPublishSubs(dc);
                    }
                }
                else
                {
                    LogHelper.Warn&lt;publish&gt;(&quot;Publishing failed due to event cancelling the publishing for document &quot; + d.Id);
                }
            }
		}

	    protected override void OnPreRender(EventArgs e)
	    {
	        base.OnPreRender(e);

	        ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/publication.asmx&quot;));
	        ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/legacyAjaxCalls.asmx&quot;));
	    }

        /// &lt;summary&gt;
        /// masterPagePrefix control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Literal masterPagePrefix;

        /// &lt;summary&gt;
        /// JsInclude1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::ClientDependency.Core.Controls.JsInclude JsInclude1;

        /// &lt;summary&gt;
        /// TheForm control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Panel TheForm;

        /// &lt;summary&gt;
        /// PublishAll control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.CheckBox PublishAll;

        /// &lt;summary&gt;
        /// PublishUnpublishedItems control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.CheckBox PublishUnpublishedItems;

        /// &lt;summary&gt;
        /// ok control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Button ok;

        /// &lt;summary&gt;
        /// ProgBar1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.ProgressBar ProgBar1;

        /// &lt;summary&gt;
        /// theEnd control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Panel theEnd;

        /// &lt;summary&gt;
        /// feedbackMsg control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.Feedback feedbackMsg;
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,3,23,35,0],[24,9,24,119,0],[25,9,25,44,0],[27,6,27,22,0],[28,6,28,7,0],[29,10,29,54,0],[30,6,30,7,0],[33,3,33,4,0],[34,4,34,46,0],[35,13,35,65,0],[36,13,36,31,0],[38,4,38,48,0],[39,4,39,5,0],[40,5,40,29,0],[41,5,41,27,0],[42,5,42,64,0],[43,5,43,215,0],[45,5,45,12,0],[49,13,49,99,0],[50,13,50,44,0],[53,4,53,86,0],[55,13,55,14,0],[56,17,56,36,0],[58,17,58,127,0],[59,17,59,99,0],[60,17,60,71,0],[61,13,61,14,0],[63,13,63,14,0],[64,17,64,38,0],[65,13,65,14,0],[66,4,66,48,0],[69,4,69,20,0],[70,4,70,5,0],[72,5,72,75,0],[73,5,73,56,0],[74,5,74,47,0],[75,5,75,57,0],[78,17,78,81,0],[79,17,79,99,0],[80,17,80,81,0],[81,17,81,90,0],[82,4,82,5,0],[84,4,84,5,0],[86,17,86,40,0],[87,17,87,18,0],[88,21,88,41,0],[90,21,90,38,0],[92,21,92,40,0],[93,21,93,74,0],[94,21,94,42,0],[96,21,96,81,0],[98,21,98,215,0],[100,6,100,47,0],[102,21,102,40,0],[104,21,104,77,0],[105,21,105,76,0],[106,21,106,42,0],[107,17,107,18,0],[109,17,109,18,0],[110,21,110,56,0],[111,21,111,22,0],[112,25,112,85,0],[113,7,113,198,0],[114,21,114,22,0],[115,26,115,27,0],[116,25,116,84,0],[117,7,117,216,0],[118,21,118,22,0],[119,6,119,48,0],[120,17,120,18,0],[122,5,122,29,0],[123,17,123,39,0],[124,4,124,5,0],[125,3,125,4,0],[128,3,128,4,0],[129,13,129,64,0],[130,13,130,14,0],[131,17,131,54,0],[132,17,132,18,0],[135,21,135,39,0],[136,21,136,40,0],[137,21,137,98,0],[138,21,138,42,0],[139,21,139,28,0],[139,30,139,36,0],[139,37,139,39,0],[139,40,139,50,0],[140,21,140,22,0],[141,25,141,43,0],[142,21,142,22,0],[143,17,143,18,0],[145,17,145,18,0],[146,21,146,126,0],[147,17,147,18,0],[148,13,148,14,0],[149,3,149,4,0],[152,6,152,7,0],[153,10,153,30,0],[155,10,155,111,0],[156,10,156,115,0],[157,6,157,7,0]]);
    </script>
  </body>
</html>