<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\mediapicker\mediaChooser.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.UI;
using Umbraco.Core.IO;
using umbraco.cms.presentation.Trees;
using umbraco.interfaces;
using umbraco.controls.Images;
using System.Web.UI.HtmlControls;
using umbraco.editorControls.mediapicker;
using umbraco.cms.businesslogic;

namespace umbraco.editorControls
{
	/// &lt;summary&gt;
	/// Summary description for mediaChooser.
	/// &lt;/summary&gt;    
	[ValidationProperty(&quot;Value&quot;)]
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class mediaChooser : BaseTreePickerEditor
	{
	    readonly bool _showpreview;
	    readonly bool _showadvanced;
		protected ImageViewer ImgViewer;		
		protected HtmlGenericControl PreviewContainer;

        public mediaChooser(IData data)
            : base(data) { }
        

        public mediaChooser(IData data, bool showPreview, bool showAdvanced)
            : base(data)
        {
            _showpreview = showPreview;
            _showadvanced = showAdvanced;
        }

        public override string ModalWindowTitle
        {
            get
            {
                return ui.GetText(&quot;general&quot;, &quot;choose&quot;) + &quot; &quot; + ui.GetText(&quot;sections&quot;, &quot;media&quot;);
            }
        }

        public override string TreePickerUrl
        {
            get
            {
                return _showadvanced ? IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/mediaPicker.aspx&quot; : TreeService.GetPickerUrl(Umbraco.Core.Constants.Applications.Media, &quot;media&quot;);
            }
        }

        protected override string GetJSScript()
        {
            if (!_showpreview)
            {
                return base.GetJSScript();
            }
            else
            {
                /* 0 = this control&#39;s client id
            * 1 = label 
            * 2 = mediaIdValueClientID
            * 3 = previewContainerClientID
            * 4 = imgViewerClientID
            * 5 = mediaTitleClientID
            * 6 = mediaPickerUrl
            * 7 = popup width
            * 8 = popup height
            * 9 = umbraco path
           */
                return string.Format(@&quot;
                var mc_{0} = new Umbraco.Controls.MediaChooser(&#39;{1}&#39;,&#39;{2}&#39;,&#39;{3}&#39;,&#39;{4}&#39;,&#39;{5}&#39;,&#39;{6}&#39;,{7},{8},&#39;{9}&#39;);&quot;,
                    new string[]
                 {
                    this.ClientID,
                    ModalWindowTitle,
                    ItemIdValue.ClientID,
                    _showpreview ? PreviewContainer.ClientID : &quot;__NOTSET&quot;,
                    _showpreview ? ImgViewer.ClientID : &quot;_NOTSET&quot;,
                    ItemTitle.ClientID,
                    TreePickerUrl,
                    ModalWidth.ToString(),
                    ModalHeight.ToString(),
                    IOHelper.ResolveUrl(SystemDirectories.Umbraco).TrimEnd(&#39;/&#39;)
                 });
            }           
        }

        /// &lt;summary&gt;
        /// Renders the required media picker javascript
        /// &lt;/summary&gt;
        protected override void RenderJSComponents()
        {
            base.RenderJSComponents();

            if (ScriptManager.GetCurrent(Page).IsInAsyncPostBack)
            {
                ScriptManager.RegisterStartupScript(this, this.GetType(), &quot;MediaChooser&quot;, MediaChooserScripts.MediaPicker, true);
            }
            else
            {
                Page.ClientScript.RegisterClientScriptBlock(typeof(mediaChooser), &quot;MediaChooser&quot;, MediaChooserScripts.MediaPicker, true);
            }
        }

		protected override void CreateChildControls()
		{
			base.CreateChildControls();

			//if preview is enabled, add it to the wrapper
			if (_showpreview)
			{
                //create the preview wrapper
                PreviewContainer = new HtmlGenericControl(&quot;div&quot;);
                PreviewContainer.ID = &quot;preview&quot;;
                Controls.Add(PreviewContainer);

                ImgViewer = (ImageViewer)Page.LoadControl(IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/controls/Images/ImageViewer.ascx&quot;);
				ImgViewer.ID = &quot;ImgViewer&quot;;
				ImgViewer.ViewerStyle = ImageViewer.Style.ImageLink;	
				
				PreviewContainer.Style.Add(HtmlTextWriterStyle.MarginTop, &quot;5px&quot;);
				PreviewContainer.Controls.Add(ImgViewer);
			}			
		}

        /// &lt;summary&gt;
        /// sets the modal width/height based on properties
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            ModalWidth = _showadvanced ? 530 : 320;
            ModalHeight = _showadvanced ? 565 : 400;
        }

        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);


            if (_showpreview)
            {
                if (string.IsNullOrEmpty(ItemIdValue.Value) || !CMSNode.IsNode(int.Parse(ItemIdValue.Value)))
                {
                    PreviewContainer.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
                    ImgViewer.MediaId = -1;
                }
                else
                {
                    ImgViewer.MediaId = int.Parse(ItemIdValue.Value);
                }
            }
        }
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,15,26,25,0],[26,26,26,27,0],[26,28,26,29,0],[30,15,30,25,0],[31,9,31,10,0],[32,13,32,40,0],[33,13,33,42,0],[34,9,34,10,0],[39,13,39,14,0],[40,17,40,96,0],[41,13,41,14,0],[47,13,47,14,0],[48,17,48,196,0],[49,13,49,14,0],[53,9,53,10,0],[54,13,54,31,0],[55,13,55,14,0],[56,17,56,43,0],[59,13,59,14,0],[71,17,85,21,0],[87,9,87,10,0],[93,9,93,10,0],[94,13,94,39,0],[96,13,96,66,0],[97,13,97,14,0],[98,17,98,130,0],[99,13,99,14,0],[101,13,101,14,0],[102,17,102,138,0],[103,13,103,14,0],[104,9,104,10,0],[107,3,107,4,0],[108,4,108,31,0],[111,4,111,21,0],[112,4,112,5,0],[114,17,114,66,0],[115,17,115,49,0],[116,17,116,48,0],[118,17,118,145,0],[119,5,119,32,0],[120,5,120,57,0],[122,5,122,70,0],[123,5,123,46,0],[124,4,124,5,0],[125,3,125,4,0],[132,9,132,10,0],[133,13,133,28,0],[135,13,135,52,0],[136,13,136,53,0],[137,9,137,10,0],[140,9,140,10,0],[141,13,141,33,0],[144,13,144,30,0],[145,13,145,14,0],[146,17,146,110,0],[147,17,147,18,0],[148,21,148,85,0],[149,21,149,44,0],[150,17,150,18,0],[152,17,152,18,0],[153,21,153,70,0],[154,17,154,18,0],[155,13,155,14,0],[156,9,156,10,0]]);
    </script>
  </body>
</html>