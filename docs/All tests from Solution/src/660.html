<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\Trees\XmlTree.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Xml.Serialization;
using System.Collections;
using System;
using umbraco.BusinessLogic.Utils;
using System.Xml.Schema;
using umbraco.interfaces;
using System.Collections.Generic;
using System.Web.Script.Serialization;
using System.Text;
using umbraco.businesslogic.Utils;
using umbraco.BasePages;
using Umbraco.Core.IO;

namespace umbraco.cms.presentation.Trees
{

	public enum SerializedTreeType
	{
		XmlTree,
		JSONTree,
		JsTree
	}

	/// &lt;summary&gt;
	/// Used for serializing data to XML as the data structure for the JavaScript tree
	/// &lt;/summary&gt;
	[XmlRoot(ElementName = &quot;tree&quot;, IsNullable = false), Serializable]
	public class XmlTree
	{

		public XmlTree()
		{
			//set to the XTree provider by default.
			//m_TreeType = SerializedTreeType.XmlTree;
			//m_TreeType = SerializedTreeType.JSONTree;			
			m_TreeType = SerializedTreeType.JsTree;

			Init();
		}

		/// &lt;summary&gt;
		/// Use this constructor to force a tree provider to be used
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;treeType&quot;&gt;&lt;/param&gt;
		public XmlTree(SerializedTreeType treeType)
		{
			m_TreeType = treeType;
			Init();
		}

		private void Init()
		{
            m_JSSerializer = new JSONSerializer { MaxJsonLength = int.MaxValue };

			switch (m_TreeType)
			{
				case SerializedTreeType.XmlTree:
					break;
				case SerializedTreeType.JSONTree:
					m_JSSerializer.RegisterConverters(new List&lt;JavaScriptConverter&gt;() 
					{ 
						new JSONTreeConverter(),
						new JSONTreeNodeConverter()
					});
					break;
				case SerializedTreeType.JsTree:
					m_JSSerializer.RegisterConverters(new List&lt;JavaScriptConverter&gt;() 
					{ 	
						new JsTreeNodeConverter()
					});
					break;
			}


		}

		private JSONSerializer m_JSSerializer;
		private SerializedTreeType m_TreeType;

		/// &lt;summary&gt;
		/// Returns the string representation of the tree structure depending on the SerializedTreeType
		/// specified. 
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override string ToString()
		{
			return ToString(m_TreeType);
		}

		public string ToString(SerializedTreeType type)
		{
			switch (type)
			{
				case SerializedTreeType.XmlTree:
					return SerializableData.Serialize(this, typeof(XmlTree));
				case SerializedTreeType.JsTree:
					return m_JSSerializer.Serialize(this.treeCollection);
				case SerializedTreeType.JSONTree:
					return m_JSSerializer.Serialize(this);
			}
			return &quot;&quot;;
		}

		public void Add(XmlTreeNode obj)
		{
			treeCollection.Add(obj);
		}

		[XmlIgnore]
		public XmlTreeNode this[int index]
		{
			get { return (XmlTreeNode)treeCollection[index]; }
		}

		[XmlIgnore]
		public int Count
		{
			get { return treeCollection.Count; }
		}

		public void Clear()
		{
			treeCollection.Clear();
		}

		public XmlTreeNode Remove(int index)
		{
			XmlTreeNode obj = treeCollection[index];
			treeCollection.Remove(obj);
			return obj;
		}

		public void Remove(XmlTreeNode obj)
		{
			treeCollection.Remove(obj);
		}


		private List&lt;XmlTreeNode&gt; __treeCollection;

		[XmlElement(Type = typeof(XmlTreeNode), ElementName = &quot;tree&quot;, IsNullable = false, Form = XmlSchemaForm.Qualified)]
		public List&lt;XmlTreeNode&gt; treeCollection
		{
			get
			{
				if (__treeCollection == null) __treeCollection = new List&lt;XmlTreeNode&gt;();
				return __treeCollection;
			}
			set { __treeCollection = value; }
		}

        [System.Runtime.InteropServices.DispIdAttribute(-4)]
        public IEnumerator GetEnumerator()
        {
            return (treeCollection as IEnumerable).GetEnumerator();
        }

    }

	/// &lt;summary&gt;
	/// Used for serializing data to XML as the data structure for the JavaScript tree
	/// &lt;/summary&gt;
	[Serializable]
	public class XmlTreeNode : IXmlSerializable
	{

		private XmlTreeNode()
		{
			m_nodeStyle = new NodeStyle();
		}

		/// &lt;summary&gt;
		/// creates a new XmlTreeNode with the default parameters from the BaseTree
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;bTree&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static XmlTreeNode Create(BaseTree bTree)
		{
			XmlTreeNode xNode = new XmlTreeNode();
			xNode.Menu = bTree.AllowedActions.FindAll(delegate(IAction a) { return true; }); //return a duplicate copy of the list
			xNode.NodeType = bTree.TreeAlias;
			xNode.Source = string.Empty;
			xNode.IsRoot = false;
			//generally the tree type and node type are the same but in some cased they are not.
			xNode.m_treeType = bTree.TreeAlias;
			return xNode;
		}

		/// &lt;summary&gt;
		/// creates a new XmlTreeNode with the default parameters for the BaseTree root node
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;bTree&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static XmlTreeNode CreateRoot(BaseTree bTree)
		{
			XmlTreeNode xNode = new XmlTreeNode();
			xNode.NodeID = bTree.StartNodeID.ToString();
			xNode.Source = bTree.GetTreeServiceUrl();
			xNode.Menu = bTree.RootNodeActions.FindAll(delegate(IAction a) { return true; }); //return a duplicate copy of the list
			xNode.NodeType = bTree.TreeAlias;
			xNode.Text = BaseTree.GetTreeHeader(bTree.TreeAlias);
			
            // By default the action from the trees.config will be used, if none is specified then the apps dashboard will be used.
            var appTreeItem = umbraco.BusinessLogic.ApplicationTree.getByAlias(bTree.TreeAlias);
            xNode.Action = appTreeItem == null || String.IsNullOrEmpty(appTreeItem.Action) ? &quot;javascript:&quot; + ClientTools.Scripts.OpenDashboard(bTree.app) : &quot;javascript:&quot; + appTreeItem.Action;
			
            xNode.IsRoot = true;
			//generally the tree type and node type are the same but in some cased they are not.
			xNode.m_treeType = bTree.TreeAlias;
			return xNode;
		}

		private NodeStyle m_nodeStyle;

		private bool? m_notPublished;
		private bool? m_isProtected;
		private List&lt;IAction&gt; m_menu;
		private string m_text;
		private string m_action;
		[Obsolete(&quot;This is never used. From version 3 and below probably&quot;)]
		private string m_rootSrc;
		private string m_src;
		private string m_iconClass = &quot;&quot;;
		private string m_icon;
		private string m_openIcon;
		private string m_nodeType;
		private string m_nodeID;
		private string m_treeType;

		/// &lt;summary&gt;
		/// Set to true when a node is created with CreateRootNode
		/// &lt;/summary&gt;
		internal bool IsRoot { get; private set; }

		/// &lt;summary&gt;
		/// Generally the tree type and node type are the same but in some cased they are not so
		/// we need to store the tree type too which is read only.
		/// &lt;/summary&gt;
		public string TreeType
		{
			get { return m_treeType; }
			internal set { m_treeType = value; }
		}

        public bool HasChildren
        {
            get
            {
                return m_HasChildren ?? !string.IsNullOrEmpty(this.Source); //defaults to true if source is specified
            }
            set
            {
                m_HasChildren = value;
            }
        }
        private bool? m_HasChildren = null;

		public string NodeID
		{
			get { return m_nodeID; }
			set { m_nodeID = value; }
		}

		/// &lt;summary&gt;
		/// The tree node text
		/// &lt;/summary&gt;
		public string Text
		{
			get { return m_text; }
			set { m_text = value; }
		}

		/// &lt;summary&gt;
		/// The CSS class of the icon to use for the node
		/// &lt;/summary&gt;
		public string IconClass
		{
			get { return m_iconClass; }
			set { m_iconClass = value; }
		}

		/// &lt;summary&gt;
		/// The JavaScript action for the node
		/// &lt;/summary&gt;
		public string Action
		{
			get { return m_action; }
			set { m_action = value; }
		}

		/// &lt;summary&gt;
		/// A string of letters representing actions for the context menu
		/// &lt;/summary&gt;
		public List&lt;IAction&gt; Menu
		{
			get { return m_menu; }
			set { m_menu = value; }
		}

		/// &lt;summary&gt;
		/// The xml source for the child nodes (a URL)
		/// &lt;/summary&gt;      
		public string Source
		{
			get { return m_src; }
			set { m_src = value; }
		}

		/// &lt;summary&gt;
		/// The path to the icon to display for the node
		/// &lt;/summary&gt;
		public string Icon
		{
			get { return m_icon; }
			set { m_icon = value; }
		}

		/// &lt;summary&gt;
		/// The path to the icon to display for the node if the node is showing it&#39;s children
		/// &lt;/summary&gt;
		public string OpenIcon
		{
			get { return m_openIcon; }
			set { m_openIcon = value; }
		}

		/// &lt;summary&gt;
		/// Normally just the type of tree being rendered.
		/// This should really only be set with this property in very special cases
		/// where the create task for a node in the same tree as another node is different.		
		/// &lt;/summary&gt;		
		public string NodeType
		{
			get { return m_nodeType; }
			set { m_nodeType = value; }
		}

		/// &lt;summary&gt;
		/// Used by the content tree and flagged as true if the node is not published
		/// &lt;/summary&gt;
		[Obsolete(&quot;Use the XmlTreeNode.NodeStyle object to set node styles&quot;)]
		public bool? NotPublished
		{
			get { return m_notPublished; }
			set { m_notPublished = value; }
		}

		/// &lt;summary&gt;
		/// Used by the content tree and flagged as true if the node is protected
		/// &lt;/summary&gt;
		[Obsolete(&quot;Use the XmlTreeNode.NodeStyle object to set node styles&quot;)]
		public bool? IsProtected
		{
			get { return m_isProtected; }
			set
			{
				m_isProtected = value;
				if (m_isProtected.HasValue &amp;&amp; m_isProtected.Value)
					this.Style.SecureNode();
			}
		}

		/// &lt;summary&gt;
		/// Returns the styling object used to add common styles to a node
		/// &lt;/summary&gt;
		public NodeStyle Style
		{
			get { return m_nodeStyle; }
		}

		/// &lt;summary&gt;
		/// Used to add common styles to an XmlTreeNode.
		/// This also adds the ability to add a custom class which will add the class to the li node
		/// that is rendered in the tree whereas the IconClass property of the XmlTreeNode object
		/// adds a class to the anchor of the li node.
		/// &lt;/summary&gt;
		public sealed class NodeStyle
		{
			internal NodeStyle()
			{
				AppliedClasses = new List&lt;string&gt;();
			}

            private const string DimNodeCssClass = &quot;not-published&quot;;
            private const string HighlightNodeCssClass = &quot;has-unpublished-version&quot;;
            private const string SecureNodeCssClass = &quot;protected&quot;;

			internal List&lt;string&gt; AppliedClasses { get; private set; }

			/// &lt;summary&gt;
			/// Dims the color of the node
			/// &lt;/summary&gt;
			public void DimNode()
			{
				if (!AppliedClasses.Contains(DimNodeCssClass))
					AppliedClasses.Add(DimNodeCssClass);
			}

			/// &lt;summary&gt;
			/// Adds the star icon highlight overlay to a node
			/// &lt;/summary&gt;
			public void HighlightNode()
			{
				if (!AppliedClasses.Contains(HighlightNodeCssClass))
					AppliedClasses.Add(HighlightNodeCssClass);
			}

			/// &lt;summary&gt;
			/// Adds the padlock icon overlay to a node
			/// &lt;/summary&gt;
			public void SecureNode()
			{
                if (!AppliedClasses.Contains(SecureNodeCssClass))
                    AppliedClasses.Add(SecureNodeCssClass);
			}

			/// &lt;summary&gt;
			/// Adds a custom class to the li node of the tree
			/// &lt;/summary&gt;
			/// &lt;param name=&quot;cssClass&quot;&gt;&lt;/param&gt;
			public void AddCustom(string cssClass)
			{
				if (!AppliedClasses.Contains(cssClass))
					AppliedClasses.Add(cssClass);
			}
		}

		/// &lt;summary&gt;
		/// Dims the color of the node
		/// &lt;/summary&gt;
		///&lt;remarks&gt;
		///This adds the class to the existing icon class as to not override anything.
		///&lt;/remarks&gt;
		[Obsolete(&quot;Use XmlTreeNode.Style to style nodes. Example: myNode.Style.DimNode();&quot;)]
		public void DimNode()
		{
			this.Style.DimNode();
		}

		#region IXmlSerializable Members

		public XmlSchema GetSchema()
		{
			return null;
		}

		public void ReadXml(System.Xml.XmlReader reader)
		{
			if (reader.HasAttributes)
			{
				while (reader.MoveToNextAttribute())
				{
					//try to parse the name into enum
					TreeAttributes current;
					try
					{
						current = (TreeAttributes)Enum.Parse(typeof(TreeAttributes), reader.Name, true);
					}
					catch
					{
						break;
					}
					switch (current)
					{
						case TreeAttributes.nodeID:
							this.m_nodeID = reader.Value;
							break;
						case TreeAttributes.text:
							this.m_text = reader.Value;
							break;
						case TreeAttributes.iconClass:
							this.m_iconClass = reader.Value;
							break;
						case TreeAttributes.action:
							this.m_action = reader.Value;
							break;
						case TreeAttributes.menu:
							this.m_menu = (!string.IsNullOrEmpty(reader.Value) ? umbraco.BusinessLogic.Actions.Action.FromString(reader.Value) : null);
							break;
						case TreeAttributes.rootSrc:
							this.m_rootSrc = reader.Value;
							break;
						case TreeAttributes.src:
							this.m_src = reader.Value;
							break;
						case TreeAttributes.icon:
							this.m_icon = reader.Value;
							break;
						case TreeAttributes.openIcon:
							this.m_openIcon = reader.Value;
							break;
						case TreeAttributes.nodeType:
							this.m_nodeType = reader.Value;
							break;
						case TreeAttributes.notPublished:
							if (!string.IsNullOrEmpty(reader.Value)) this.m_notPublished = bool.Parse(reader.Value);
							break;
						case TreeAttributes.isProtected:
							if (!string.IsNullOrEmpty(reader.Value)) this.m_isProtected = bool.Parse(reader.Value);
							break;
						case TreeAttributes.hasChildren:
							if (!string.IsNullOrEmpty(reader.Value)) this.HasChildren = bool.Parse(reader.Value);
							break;
					}
				}
                //need to set the hasChildren property if it is null but there is a source
                //this happens when the hasChildren attribute is not set because the developer didn&#39;t know it was there
                //only occurs for ITree obviously
                if (!this.HasChildren &amp;&amp; !string.IsNullOrEmpty(this.m_src))
                    this.HasChildren = true;

			}

			reader.Read();
		}

		public void WriteXml(System.Xml.XmlWriter writer)
		{
			writer.WriteAttributeString(TreeAttributes.nodeID.ToString(), this.m_nodeID);
			writer.WriteAttributeString(TreeAttributes.text.ToString(), this.m_text);
			writer.WriteAttributeString(TreeAttributes.iconClass.ToString(), this.m_iconClass);
			writer.WriteAttributeString(TreeAttributes.action.ToString(), this.m_action);
			writer.WriteAttributeString(TreeAttributes.menu.ToString(), (this.m_menu != null &amp;&amp; this.m_menu.Count &gt; 0 ? umbraco.BusinessLogic.Actions.Action.ToString(this.m_menu) : &quot;&quot;));
			writer.WriteAttributeString(TreeAttributes.rootSrc.ToString(), this.m_rootSrc);
			writer.WriteAttributeString(TreeAttributes.src.ToString(), this.m_src);
			writer.WriteAttributeString(TreeAttributes.icon.ToString(), this.m_icon);
			writer.WriteAttributeString(TreeAttributes.openIcon.ToString(), this.m_openIcon);
			writer.WriteAttributeString(TreeAttributes.nodeType.ToString(), this.m_nodeType);
			writer.WriteAttributeString(TreeAttributes.hasChildren.ToString(), HasChildren.ToString().ToLower());
			if (m_notPublished.HasValue) writer.WriteAttributeString(TreeAttributes.notPublished.ToString(), this.m_notPublished.Value.ToString().ToLower());
			if (m_isProtected.HasValue) writer.WriteAttributeString(TreeAttributes.isProtected.ToString(), this.m_isProtected.Value.ToString().ToLower());
		}

		internal enum TreeAttributes
		{
			nodeID, text, iconClass, action, menu, rootSrc, src, icon, openIcon, nodeType, notPublished, isProtected, hasChildren
		}

		#endregion

	}

	/// &lt;summary&gt;
	/// Used to serialize an XmlTree object to JSON for supporting a JSON Tree View control.
	/// &lt;/summary&gt;
	internal class JSONTreeConverter : JavaScriptConverter
	{
		/// &lt;summary&gt;
		/// Not implemented as we never need to Deserialize
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;dictionary&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;serializer&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override object Deserialize(IDictionary&lt;string, object&gt; dictionary, Type type, JavaScriptSerializer serializer)
		{
			throw new NotImplementedException();
		}

		/// &lt;summary&gt;
		/// Serializes an XmlTree object with the relevant values.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;serializer&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override IDictionary&lt;string, object&gt; Serialize(object obj, JavaScriptSerializer serializer)
		{
			XmlTree tree = obj as XmlTree;

			Dictionary&lt;string, object&gt; resultSet = new Dictionary&lt;string, object&gt;();
			Dictionary&lt;string, object&gt; resultTree = new Dictionary&lt;string, object&gt;();

			if (tree != null)
			{
				//add a count property for the count of total nodes
				resultTree.Add(&quot;Count&quot;, tree.Count);

				List&lt;object&gt; nodes = new List&lt;object&gt;();
				foreach (XmlTreeNode node in tree.treeCollection)
					nodes.Add(node);

				resultTree.Add(&quot;Nodes&quot;, nodes);
			}

			resultSet.Add(&quot;Tree&quot;, resultTree);

			return resultSet;
		}

		public override IEnumerable&lt;Type&gt; SupportedTypes
		{
			get { return new Type[] { typeof(XmlTree) }; }
		}
	}

	/// &lt;summary&gt;
	/// Used to serialize an XmlTreeNode object to JSON for supporting a JS Tree View control.
	/// &lt;/summary&gt;
	internal class JSONTreeNodeConverter : JavaScriptConverter
	{

		/// &lt;summary&gt;
		/// Not implemented as we never need to Deserialize
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;dictionary&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;serializer&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override object Deserialize(IDictionary&lt;string, object&gt; dictionary, Type type, JavaScriptSerializer serializer)
		{
			throw new NotImplementedException();
		}

		/// &lt;summary&gt;
		/// Serializes an XmlTreeNode object with the relevant values.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;serializer&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override IDictionary&lt;string, object&gt; Serialize(object obj, JavaScriptSerializer serializer)
		{
			XmlTreeNode node = obj as XmlTreeNode;

			Dictionary&lt;string, object&gt; result = new Dictionary&lt;string, object&gt;();

			if (node != null)
			{
				//add the properties
				result.Add(XmlTreeNode.TreeAttributes.notPublished.ToString(), node.NotPublished);
				result.Add(XmlTreeNode.TreeAttributes.isProtected.ToString(), node.IsProtected);
				result.Add(XmlTreeNode.TreeAttributes.text.ToString(), node.Text);
				result.Add(XmlTreeNode.TreeAttributes.action.ToString(), node.Action);
				result.Add(XmlTreeNode.TreeAttributes.src.ToString(), node.Source);
				result.Add(XmlTreeNode.TreeAttributes.iconClass.ToString(), node.IconClass);
				result.Add(XmlTreeNode.TreeAttributes.icon.ToString(), node.Icon);
				result.Add(XmlTreeNode.TreeAttributes.openIcon.ToString(), node.OpenIcon);
				result.Add(XmlTreeNode.TreeAttributes.nodeType.ToString(), node.NodeType);
				result.Add(XmlTreeNode.TreeAttributes.nodeID.ToString(), node.NodeID);

				//Add the menu as letters.
				result.Add(XmlTreeNode.TreeAttributes.menu.ToString(), node.Menu != null &amp;&amp; node.Menu.Count &gt; 0 ? umbraco.BusinessLogic.Actions.Action.ToString(node.Menu) : &quot;&quot;);

				return result;
			}

			return new Dictionary&lt;string, object&gt;();

		}

		public override IEnumerable&lt;Type&gt; SupportedTypes
		{
			get { return new Type[] { typeof(XmlTreeNode) }; }
		}
	}

	/// &lt;summary&gt;
	/// Used to serialize an XmlTreeNode object to JSON for supporting a JS Tree View control.
	/// &lt;/summary&gt;
	internal class JsTreeNodeConverter : JavaScriptConverter
	{

		/// &lt;summary&gt;
		/// A reference path to where the icons are actually stored as compared to where the tree themes folder is
		/// &lt;/summary&gt;
		private static string IconPath = IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/images/umbraco/&quot;;

		/// &lt;summary&gt;
		/// Not implemented as we never need to Deserialize
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;dictionary&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;serializer&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override object Deserialize(IDictionary&lt;string, object&gt; dictionary, Type type, JavaScriptSerializer serializer)
		{
			throw new NotImplementedException();
		}

		/// &lt;summary&gt;
		/// Serializes an XmlTreeNode object with the relevant values.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;serializer&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override IDictionary&lt;string, object&gt; Serialize(object obj, JavaScriptSerializer serializer)
		{
			XmlTreeNode node = obj as XmlTreeNode;

			Dictionary&lt;string, object&gt; result = new Dictionary&lt;string, object&gt;();

			if (node != null)
			{
				//the data object to build the node
				Dictionary&lt;string, object&gt; data = new Dictionary&lt;string, object&gt;();

				data.Add(&quot;title&quot;, node.Text);

				

				//the attributes object fot the tree node link (a) object created
				Dictionary&lt;string, object&gt; dataAttributes = new Dictionary&lt;string, object&gt;();
				string cssClass = &quot;&quot;;
				if (node.Icon.StartsWith(&quot;.spr&quot;))
					cssClass = &quot;sprTree &quot; + node.Icon.TrimStart(&#39;.&#39;);
				else
				{
					//there is no sprite so add the noSpr class
					cssClass = &quot;sprTree noSpr&quot;;
					data.Add(&quot;icon&quot;, IconPath + node.Icon);
				}
				dataAttributes.Add(&quot;class&quot;, cssClass + (string.IsNullOrEmpty(node.IconClass) ? &quot;&quot; : &quot; &quot; + node.IconClass));
				dataAttributes.Add(&quot;href&quot;, node.Action);

				//add a metadata dictionary object, we can store whatever we want in this!
				//in this case we&#39;re going to store permissions &amp; the tree type &amp; the child node source url
				//For whatever reason jsTree requires this JSON output to be quoted!?!
				//This also needs to be stored in the attributes object with the class above.
				Dictionary&lt;string, object&gt; metadata = new Dictionary&lt;string, object&gt;();
				//the menu:
				metadata.Add(&quot;menu&quot;, node.Menu == null ? &quot;&quot; : umbraco.BusinessLogic.Actions.Action.ToString(node.Menu));
				//the tree type:
				metadata.Add(&quot;nodeType&quot;, node.NodeType);
				//the data url for child nodes:
				metadata.Add(&quot;source&quot;, node.Source);

				//the metadata/jsTree requires this property to be in a quoted JSON syntax
				JSONSerializer jsSerializer = new JSONSerializer();
				string strMetaData = jsSerializer.Serialize(metadata).Replace(&quot;\&quot;&quot;, &quot;&#39;&quot;);
                dataAttributes.Add(&quot;umb:nodedata&quot;, strMetaData);

				data.Add(&quot;attributes&quot;, dataAttributes);

				//add the data structure
				result.Add(&quot;data&quot;, data);

				//state is nothing if no children
				if ((node.HasChildren || node.IsRoot) &amp;&amp; !string.IsNullOrEmpty(node.Source))
					result.Add(&quot;state&quot;, &quot;closed&quot;);

				//the attributes object for the tree node (li) object created
				Dictionary&lt;string, object&gt; attributes = new Dictionary&lt;string, object&gt;();
				attributes.Add(&quot;id&quot;, node.NodeID);
				attributes.Add(&quot;class&quot;, string.Join(&quot; &quot;, node.Style.AppliedClasses.ToArray()));
				
				if (node.IsRoot)
					attributes.Add(&quot;rel&quot;, &quot;rootNode&quot;);
				else
					attributes.Add(&quot;rel&quot;, &quot;dataNode&quot;);

				//the tree type should always be set, however if some developers have serialized their tree into an XmlTree
				//then there is no gaurantees that this will be set if they didn&#39;t use the create methods of XmlTreeNode.
				//So, we&#39;ll set the treetype to the nodetype if it is null, this means that the tree on the front end may
				//not function as expected when reloding a node.
				attributes.Add(&quot;umb:type&quot;, string.IsNullOrEmpty(node.TreeType) ? node.NodeType : node.TreeType);

				result.Add(&quot;attributes&quot;, attributes);

				return result;
			}

			return null;

		}

		public override IEnumerable&lt;Type&gt; SupportedTypes
		{
			get { return new Type[] { typeof(XmlTreeNode) }; }
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,3,31,19,1],[32,3,32,4,1],[36,4,36,43,1],[38,4,38,11,1],[39,3,39,4,1],[45,3,45,46,0],[46,3,46,4,0],[47,4,47,26,0],[48,4,48,11,0],[49,3,49,4,0],[52,3,52,4,1],[53,13,53,82,1],[55,4,55,23,1],[58,6,58,12,0],[60,6,64,9,0],[65,6,65,12,0],[67,6,70,9,1],[71,6,71,12,1],[75,3,75,4,1],[86,3,86,4,0],[87,4,87,32,0],[88,3,88,4,0],[91,3,91,4,0],[92,4,92,17,0],[95,6,95,63,0],[97,6,97,59,0],[99,6,99,44,0],[101,4,101,14,0],[102,3,102,4,0],[105,3,105,4,0],[106,4,106,28,0],[107,3,107,4,0],[112,8,112,9,0],[112,10,112,52,0],[112,53,112,54,0],[118,8,118,9,0],[118,10,118,38,0],[118,39,118,40,0],[122,3,122,4,0],[123,4,123,27,0],[124,3,124,4,0],[127,3,127,4,0],[128,4,128,44,0],[129,4,129,31,0],[130,4,130,15,0],[131,3,131,4,0],[134,3,134,4,0],[135,4,135,31,0],[136,3,136,4,0],[145,4,145,5,0],[146,5,146,34,0],[146,35,146,78,0],[147,5,147,29,0],[148,4,148,5,0],[149,8,149,9,0],[149,10,149,35,0],[149,36,149,37,0],[154,9,154,10,0],[155,13,155,68,0],[156,9,156,10,0],[167,3,167,24,0],[168,3,168,4,0],[169,4,169,34,0],[170,3,170,4,0],[178,3,178,4,0],[179,4,179,42,0],[180,4,180,66,0],[180,66,180,67,0],[180,67,180,68,0],[180,68,180,80,0],[180,80,180,81,0],[180,81,180,82,0],[180,82,180,84,0],[180,4,180,84,0],[181,4,181,37,0],[182,4,182,32,0],[183,4,183,25,0],[185,4,185,39,0],[186,4,186,17,0],[187,3,187,4,0],[195,3,195,4,0],[196,4,196,42,0],[197,4,197,48,0],[198,4,198,45,0],[199,4,199,67,0],[199,67,199,68,0],[199,68,199,69,0],[199,69,199,81,0],[199,81,199,82,0],[199,82,199,83,0],[199,83,199,85,0],[199,4,199,85,0],[200,4,200,37,0],[201,4,201,57,0],[204,13,204,97,0],[205,13,205,192,0],[207,13,207,33,0],[209,4,209,39,0],[210,4,210,17,0],[211,3,211,4,0],[223,3,223,35,0],[233,26,233,30,0],[233,31,233,43,0],[241,8,241,9,0],[241,10,241,28,0],[241,29,241,30,0],[242,17,242,18,0],[242,19,242,38,0],[242,39,242,40,0],[248,13,248,14,0],[249,17,249,76,0],[250,13,250,14,0],[252,13,252,14,0],[253,17,253,39,0],[254,13,254,14,0],[256,9,256,44,0],[260,8,260,9,0],[260,10,260,26,0],[260,27,260,28,0],[261,8,261,9,0],[261,10,261,27,0],[261,28,261,29,0],[269,8,269,9,0],[269,10,269,24,0],[269,25,269,26,0],[270,8,270,9,0],[270,10,270,25,0],[270,26,270,27,0],[278,8,278,9,0],[278,10,278,29,0],[278,30,278,31,0],[279,8,279,9,0],[279,10,279,30,0],[279,31,279,32,0],[287,8,287,9,0],[287,10,287,26,0],[287,27,287,28,0],[288,8,288,9,0],[288,10,288,27,0],[288,28,288,29,0],[296,8,296,9,0],[296,10,296,24,0],[296,25,296,26,0],[297,8,297,9,0],[297,10,297,25,0],[297,26,297,27,0],[305,8,305,9,0],[305,10,305,23,0],[305,24,305,25,0],[306,8,306,9,0],[306,10,306,24,0],[306,25,306,26,0],[314,8,314,9,0],[314,10,314,24,0],[314,25,314,26,0],[315,8,315,9,0],[315,10,315,25,0],[315,26,315,27,0],[323,8,323,9,0],[323,10,323,28,0],[323,29,323,30,0],[324,8,324,9,0],[324,10,324,29,0],[324,30,324,31,0],[334,8,334,9,0],[334,10,334,28,0],[334,29,334,30,0],[335,8,335,9,0],[335,10,335,29,0],[335,30,335,31,0],[344,8,344,9,0],[344,10,344,32,0],[344,33,344,34,0],[345,8,345,9,0],[345,10,345,33,0],[345,34,345,35,0],[354,8,354,9,0],[354,10,354,31,0],[354,32,354,33,0],[356,4,356,5,0],[357,5,357,27,0],[358,5,358,55,0],[359,6,359,30,0],[360,4,360,5,0],[368,8,368,9,0],[368,10,368,29,0],[368,30,368,31,0],[379,4,379,24,0],[380,4,380,5,0],[381,5,381,41,0],[382,4,382,5,0],[388,43,388,47,0],[388,48,388,60,0],[394,4,394,5,0],[395,5,395,51,0],[396,6,396,42,0],[397,4,397,5,0],[403,4,403,5,0],[404,5,404,57,0],[405,6,405,48,0],[406,4,406,5,0],[412,4,412,5,0],[413,17,413,66,0],[414,21,414,60,0],[415,4,415,5,0],[422,4,422,5,0],[423,5,423,44,0],[424,6,424,35,0],[425,4,425,5,0],[436,3,436,4,0],[437,4,437,25,0],[438,3,438,4,0],[443,3,443,4,0],[444,4,444,16,0],[445,3,445,4,0],[448,3,448,4,0],[449,4,449,29,0],[450,4,450,5,0],[451,5,451,41,0],[452,5,452,6,0],[456,6,456,7,0],[457,7,457,87,0],[458,6,458,7,0],[459,6,459,11,0],[460,6,460,7,0],[461,7,461,13,0],[463,6,463,22,0],[466,8,466,37,0],[467,8,467,14,0],[469,8,469,35,0],[470,8,470,14,0],[472,8,472,40,0],[473,8,473,14,0],[475,8,475,37,0],[476,8,476,14,0],[478,8,478,131,0],[479,8,479,14,0],[481,8,481,38,0],[482,8,482,14,0],[484,8,484,34,0],[485,8,485,14,0],[487,8,487,35,0],[488,8,488,14,0],[490,8,490,39,0],[491,8,491,14,0],[493,8,493,39,0],[494,8,494,14,0],[496,8,496,48,0],[496,49,496,96,0],[497,8,497,14,0],[499,8,499,48,0],[499,49,499,95,0],[500,8,500,14,0],[502,8,502,48,0],[502,49,502,93,0],[503,8,503,14,0],[505,5,505,6,0],[509,17,509,76,0],[510,21,510,45,0],[512,4,512,5,0],[514,4,514,18,0],[515,3,515,4,0],[518,3,518,4,0],[519,4,519,81,0],[520,4,520,77,0],[521,4,521,87,0],[522,4,522,81,0],[523,4,523,178,0],[524,4,524,83,0],[525,4,525,75,0],[526,4,526,77,0],[527,4,527,85,0],[528,4,528,85,0],[529,4,529,105,0],[530,4,530,32,0],[530,33,530,149,0],[531,4,531,31,0],[531,32,531,146,0],[532,3,532,4,0],[556,3,556,4,0],[557,4,557,40,0],[567,3,567,4,0],[568,4,568,34,0],[570,4,570,76,0],[571,4,571,77,0],[573,4,573,21,0],[574,4,574,5,0],[576,5,576,41,0],[578,5,578,45,0],[579,5,579,12,0],[579,14,579,30,0],[579,31,579,33,0],[579,34,579,53,0],[580,6,580,22,0],[582,5,582,36,0],[583,4,583,5,0],[585,4,585,38,0],[587,4,587,21,0],[588,3,588,4,0],[592,8,592,9,0],[592,10,592,48,0],[592,49,592,50,0],[610,3,610,4,0],[611,4,611,40,0],[621,3,621,4,0],[622,4,622,42,0],[624,4,624,73,0],[626,4,626,21,0],[627,4,627,5,0],[629,5,629,87,0],[630,5,630,85,0],[631,5,631,71,0],[632,5,632,75,0],[633,5,633,72,0],[634,5,634,81,0],[635,5,635,71,0],[636,5,636,79,0],[637,5,637,79,0],[638,5,638,75,0],[641,5,641,166,0],[643,5,643,19,0],[646,4,646,44,0],[648,3,648,4,0],[652,8,652,9,0],[652,10,652,52,0],[652,53,652,54,0],[665,3,665,104,1],[675,3,675,4,0],[676,4,676,40,0],[686,3,686,4,0],[687,4,687,42,0],[689,4,689,73,0],[691,4,691,21,0],[692,4,692,5,0],[694,5,694,72,0],[696,5,696,34,0],[701,5,701,82,0],[702,5,702,26,0],[703,5,703,38,0],[704,6,704,55,0],[706,5,706,6,0],[708,6,708,33,0],[709,6,709,45,0],[710,5,710,6,0],[711,5,711,112,0],[712,5,712,45,0],[718,5,718,76,0],[720,5,720,109,0],[722,5,722,45,0],[724,5,724,41,0],[727,5,727,56,0],[728,5,728,78,0],[729,17,729,65,0],[731,5,731,44,0],[734,5,734,30,0],[737,5,737,81,0],[738,6,738,36,0],[741,5,741,78,0],[742,5,742,39,0],[743,5,743,84,0],[745,5,745,21,0],[746,6,746,40,0],[748,6,748,40,0],[754,5,754,101,0],[756,5,756,42,0],[758,5,758,19,0],[761,4,761,16,0],[763,3,763,4,0],[767,8,767,9,1],[767,10,767,52,1],[767,53,767,54,1]]);
    </script>
  </body>
</html>