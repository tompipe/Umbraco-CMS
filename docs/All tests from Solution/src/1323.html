<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\DataTypeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Net;
using System.Web.Http;
using System.Web.Http.ModelBinding;
using AutoMapper;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Models.Mapping;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebApi.Binders;
using Umbraco.Web.WebApi.Filters;
using umbraco;
using Constants = Umbraco.Core.Constants;
using System.Net.Http;
using System.Text;

namespace Umbraco.Web.Editors
{
    /// &lt;summary&gt;
    /// The API controller used for editing data types
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// The security for this controller is defined to allow full CRUD access to data types if the user has access to either:
    /// Content Types, Member Types or Media Types ... and of course to Data Types
    /// &lt;/remarks&gt;
    [PluginController(&quot;UmbracoApi&quot;)]
    [UmbracoTreeAuthorize(Constants.Trees.DataTypes, Constants.Trees.DocumentTypes, Constants.Trees.MediaTypes, Constants.Trees.MemberTypes)]
    [EnableOverrideAuthorization]
    public class DataTypeController : UmbracoAuthorizedJsonController
    {
        /// &lt;summary&gt;
        /// Gets data type by name
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public DataTypeDisplay GetByName(string name)
        {
            var dataType = Services.DataTypeService.GetDataTypeDefinitionByName(name);
            return dataType == null ? null : Mapper.Map&lt;IDataTypeDefinition, DataTypeDisplay&gt;(dataType);
        }

        /// &lt;summary&gt;
        /// Gets the datatype json for the datatype id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public DataTypeDisplay GetById(int id)
        {
            var dataType = Services.DataTypeService.GetDataTypeDefinitionById(id);
            if (dataType == null)
            {
                throw new HttpResponseException(HttpStatusCode.NotFound);
            }
            return Mapper.Map&lt;IDataTypeDefinition, DataTypeDisplay&gt;(dataType);
        }

        /// &lt;summary&gt;
        /// Deletes a data type wth a given ID
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpDelete]
        [HttpPost]
        public HttpResponseMessage DeleteById(int id)
        {
            var foundType = Services.DataTypeService.GetDataTypeDefinitionById(id);
            if (foundType == null)
            {
                throw new HttpResponseException(HttpStatusCode.NotFound);
            }
            
            Services.DataTypeService.Delete(foundType, Security.CurrentUser.Id);

            return Request.CreateResponse(HttpStatusCode.OK);
        }

        public DataTypeDisplay GetEmpty(int parentId)
        {
            var dt = new DataTypeDefinition(parentId, &quot;&quot;);
            return Mapper.Map&lt;IDataTypeDefinition, DataTypeDisplay&gt;(dt);
        }

        /// &lt;summary&gt;
        /// Returns a custom listview, based on a content type alias, if found
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentTypeAlias&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;a DataTypeDisplay&lt;/returns&gt;
        public DataTypeDisplay GetCustomListView(string contentTypeAlias)
        {
            var dt = Services.DataTypeService.GetDataTypeDefinitionByName(Constants.Conventions.DataTypes.ListViewPrefix + contentTypeAlias);
            if (dt == null)
            {
                throw new HttpResponseException(HttpStatusCode.NotFound);
            }

            return Mapper.Map&lt;IDataTypeDefinition, DataTypeDisplay&gt;(dt);
        }

        /// &lt;summary&gt;
        /// Creates a custom list view - give a document type alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentTypeAlias&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public DataTypeDisplay PostCreateCustomListView(string contentTypeAlias)
        {
            var dt = Services.DataTypeService.GetDataTypeDefinitionByName(Constants.Conventions.DataTypes.ListViewPrefix + contentTypeAlias);
            
            //if it doesnt exist yet, we will create it.
            if (dt == null)
            {
                dt = new DataTypeDefinition( Constants.PropertyEditors.ListViewAlias );
                dt.Name = Constants.Conventions.DataTypes.ListViewPrefix + contentTypeAlias;
                Services.DataTypeService.Save(dt);
            }

            return Mapper.Map&lt;IDataTypeDefinition, DataTypeDisplay&gt;(dt);    
        }

        /// &lt;summary&gt;
        /// Returns the pre-values for the specified property editor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;editorAlias&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeId&quot;&gt;The data type id for the pre-values, -1 if it is a new data type&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;PreValueFieldDisplay&gt; GetPreValues(string editorAlias, int dataTypeId = -1)
        {
            var propEd = PropertyEditorResolver.Current.GetByAlias(editorAlias);
            if (propEd == null)
            {
                throw new InvalidOperationException(&quot;Could not find property editor with alias &quot; + editorAlias);
            }

            if (dataTypeId == -1)
            {
                //this is a new data type, so just return the field editors with default values
                return Mapper.Map&lt;PropertyEditor, IEnumerable&lt;PreValueFieldDisplay&gt;&gt;(propEd);
            }

            //we have a data type associated
            var dataType = Services.DataTypeService.GetDataTypeDefinitionById(dataTypeId);
            if (dataType == null)
            {
                throw new HttpResponseException(HttpStatusCode.NotFound);
            }

            //now, lets check if the data type has the current editor selected, if that is true
            //we will need to wire up it&#39;s saved values. Otherwise it&#39;s an existing data type
            //that is changing it&#39;s underlying property editor, in which case there&#39;s no values.
            if (dataType.PropertyEditorAlias == editorAlias)
            {
                //this is the currently assigned pre-value editor, return with values.
                return Mapper.Map&lt;IDataTypeDefinition, IEnumerable&lt;PreValueFieldDisplay&gt;&gt;(dataType);
            }

            //these are new pre-values, so just return the field editors with default values
            return Mapper.Map&lt;PropertyEditor, IEnumerable&lt;PreValueFieldDisplay&gt;&gt;(propEd);            
        }

        /// &lt;summary&gt;
        /// Deletes a data type container wth a given ID
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpDelete]
        [HttpPost]
        public HttpResponseMessage DeleteContainer(int id)
        {
            Services.DataTypeService.DeleteContainer(id, Security.CurrentUser.Id);

            return Request.CreateResponse(HttpStatusCode.OK);
        }

        public HttpResponseMessage PostCreateContainer(int parentId, string name)
        {
            var result = Services.DataTypeService.CreateContainer(parentId, name, Security.CurrentUser.Id);

            return result
                ? Request.CreateResponse(HttpStatusCode.OK, result.Result) //return the id 
                : Request.CreateNotificationValidationErrorResponse(result.Exception.Message);
        }

        /// &lt;summary&gt;
        /// Saves the data type
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataType&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [DataTypeValidate]
        public DataTypeDisplay PostSave(DataTypeSave dataType)
        {
            //If we&#39;ve made it here, then everything has been wired up and validated by the attribute

            //finally we need to save the data type and it&#39;s pre-vals
            var dtService = ApplicationContext.Services.DataTypeService;

            //TODO: Check if the property editor has changed, if it has ensure we don&#39;t pass the 
            // existing values to the new property editor!

            //get the prevalues, current and new
            var preValDictionary = dataType.PreValues.ToDictionary(x =&gt; x.Key, x =&gt; x.Value);
            var currVal = Services.DataTypeService.GetPreValuesCollectionByDataTypeId(dataType.PersistedDataType.Id);

            //we need to allow for the property editor to deserialize the prevalues
            var formattedVal = dataType.PropertyEditor.PreValueEditor.ConvertEditorToDb(
                preValDictionary,
                currVal);

            try
            {
                //save the data type
                dtService.SaveDataTypeAndPreValues(dataType.PersistedDataType, formattedVal, (int)Security.CurrentUser.Id);
            }
            catch (DuplicateNameException ex)
            {
                ModelState.AddModelError(&quot;Name&quot;, ex.Message);
                throw new HttpResponseException(Request.CreateValidationErrorResponse(ModelState));
            }

            var display = Mapper.Map&lt;IDataTypeDefinition, DataTypeDisplay&gt;(dataType.PersistedDataType);
            display.AddSuccessNotification(ui.Text(&quot;speechBubbles&quot;, &quot;dataTypeSaved&quot;), &quot;&quot;);

            //now return the updated model
            return display;
        }

        /// &lt;summary&gt;
        /// Move the media type
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;move&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public HttpResponseMessage PostMove(MoveOrCopy move)
        {
            var toMove = Services.DataTypeService.GetDataTypeDefinitionById(move.Id);
            if (toMove == null)
            {
                return Request.CreateResponse(HttpStatusCode.NotFound);
            }

            var result = Services.DataTypeService.Move(toMove, move.ParentId);
            if (result.Success)
            {
                var response = Request.CreateResponse(HttpStatusCode.OK);
                response.Content = new StringContent(toMove.Path, Encoding.UTF8, &quot;application/json&quot;);
                return response;
            }

            switch (result.Result.StatusType)
            {
                case MoveOperationStatusType.FailedParentNotFound:
                    return Request.CreateResponse(HttpStatusCode.NotFound);
                case MoveOperationStatusType.FailedCancelledByEvent:
                    //returning an object of INotificationModel will ensure that any pending 
                    // notification messages are added to the response.
                    return Request.CreateValidationErrorResponse(new SimpleNotificationModel());
                case MoveOperationStatusType.FailedNotAllowedByPath:
                    var notificationModel = new SimpleNotificationModel();
                    notificationModel.AddErrorNotification(Services.TextService.Localize(&quot;moveOrCopy/notAllowedByPath&quot;), &quot;&quot;);
                    return Request.CreateValidationErrorResponse(notificationModel);
                default:
                    throw new ArgumentOutOfRangeException();
            }
        }

        #region ReadOnly actions to return basic data - allow access for: content ,media, members, settings, developer
        /// &lt;summary&gt;
        /// Gets the content json for all data types
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// Permission is granted to this method if the user has access to any of these sections: Content, media, settings, developer, members
        /// &lt;/remarks&gt;    
        [UmbracoApplicationAuthorize(
            Constants.Applications.Content, Constants.Applications.Media, Constants.Applications.Members,
            Constants.Applications.Settings, Constants.Applications.Developer)]
        public IEnumerable&lt;DataTypeBasic&gt; GetAll()
        {
            return Services.DataTypeService
                     .GetAllDataTypeDefinitions()
                     .Select(Mapper.Map&lt;IDataTypeDefinition, DataTypeBasic&gt;).Where(x =&gt; x.IsSystemDataType == false);
        }

        /// &lt;summary&gt;
        /// Returns all data types grouped by their property editor group
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// Permission is granted to this method if the user has access to any of these sections: Content, media, settings, developer, members
        /// &lt;/remarks&gt;    
        [UmbracoTreeAuthorize(
            Constants.Applications.Content, Constants.Applications.Media, Constants.Applications.Members,
            Constants.Applications.Settings, Constants.Applications.Developer)]
        public IDictionary&lt;string, IEnumerable&lt;DataTypeBasic&gt;&gt; GetGroupedDataTypes()
        {
            var dataTypes = Services.DataTypeService
                     .GetAllDataTypeDefinitions()
                     .Select(Mapper.Map&lt;IDataTypeDefinition, DataTypeBasic&gt;)
                     .ToArray();

            var propertyEditors = PropertyEditorResolver.Current.PropertyEditors.ToArray();

            foreach (var dataType in dataTypes)
            {
                var propertyEditor = propertyEditors.SingleOrDefault(x =&gt; x.Alias == dataType.Alias);
                if(propertyEditor != null)
                    dataType.HasPrevalues = propertyEditor.PreValueEditor.Fields.Any(); ;
            }

            var grouped = dataTypes
                .GroupBy(x =&gt; x.Group.IsNullOrWhiteSpace() ? &quot;&quot; : x.Group.ToLower())
                .ToDictionary(group =&gt; group.Key, group =&gt; group.OrderBy(d =&gt; d.Name).AsEnumerable());

            return grouped;
        }

        /// &lt;summary&gt;
        /// Returns all property editors grouped
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// Permission is granted to this method if the user has access to any of these sections: Content, media, settings, developer, members
        /// &lt;/remarks&gt;    
        [UmbracoTreeAuthorize(
            Constants.Applications.Content, Constants.Applications.Media, Constants.Applications.Members,
            Constants.Applications.Settings, Constants.Applications.Developer)]
        public IDictionary&lt;string, IEnumerable&lt;DataTypeBasic&gt;&gt; GetGroupedPropertyEditors()
        {
            var datatypes = new List&lt;DataTypeBasic&gt;();
            
            var propertyEditors = PropertyEditorResolver.Current.PropertyEditors;
            foreach (var propertyEditor in propertyEditors)
            {
                var hasPrevalues = propertyEditor.PreValueEditor.Fields.Any();
                var basic = Mapper.Map&lt;DataTypeBasic&gt;(propertyEditor);
                basic.HasPrevalues = hasPrevalues;
                datatypes.Add(basic);
            }

            var grouped = datatypes
                .GroupBy(x =&gt; x.Group.IsNullOrWhiteSpace() ? &quot;&quot; : x.Group.ToLower())
                .ToDictionary(group =&gt; group.Key, group =&gt; group.OrderBy(d =&gt; d.Name).AsEnumerable());

            return grouped;
        }


        /// &lt;summary&gt;
        /// Gets all property editors defined
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// Permission is granted to this method if the user has access to any of these sections: Content, media, settings, developer, members
        /// &lt;/remarks&gt;    
        [UmbracoTreeAuthorize(
            Constants.Applications.Content, Constants.Applications.Media, Constants.Applications.Members,
            Constants.Applications.Settings, Constants.Applications.Developer)]
        public IEnumerable&lt;PropertyEditorBasic&gt; GetAllPropertyEditors()
        {
            return PropertyEditorResolver.Current.PropertyEditors
                .OrderBy(x =&gt; x.Name)
                .Select(Mapper.Map&lt;PropertyEditorBasic&gt;);
        }
        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[44,9,44,10,0],[45,13,45,87,0],[46,13,46,105,0],[47,9,47,10,0],[55,9,55,10,0],[56,13,56,83,0],[57,13,57,34,0],[58,13,58,14,0],[59,17,59,74,0],[61,13,61,79,0],[62,9,62,10,0],[72,9,72,10,0],[73,13,73,84,0],[74,13,74,35,0],[75,13,75,14,0],[76,17,76,74,0],[79,13,79,81,0],[81,13,81,62,0],[82,9,82,10,0],[85,9,85,10,0],[86,13,86,59,0],[87,13,87,73,0],[88,9,88,10,0],[96,9,96,10,0],[97,13,97,142,0],[98,13,98,28,0],[99,13,99,14,0],[100,17,100,74,0],[103,13,103,73,0],[104,9,104,10,0],[112,9,112,10,0],[113,13,113,142,0],[116,13,116,28,0],[117,13,117,14,0],[118,17,118,88,0],[119,17,119,93,0],[120,17,120,51,0],[121,13,121,14,0],[123,13,123,73,0],[124,9,124,10,0],[133,9,133,10,0],[134,13,134,81,0],[135,13,135,32,0],[136,13,136,14,0],[137,17,137,113,0],[140,13,140,34,0],[141,13,141,14,0],[143,17,143,94,0],[147,13,147,91,0],[148,13,148,34,0],[149,13,149,14,0],[150,17,150,74,0],[156,13,156,61,0],[157,13,157,14,0],[159,17,159,101,0],[163,13,163,90,0],[164,9,164,10,0],[174,9,174,10,0],[175,13,175,83,0],[177,13,177,62,0],[178,9,178,10,0],[181,9,181,10,0],[182,13,182,108,0],[184,13,186,95,0],[187,9,187,10,0],[196,9,196,10,0],[200,13,200,73,0],[206,13,206,73,0],[206,73,206,78,0],[206,78,206,85,0],[206,85,206,92,0],[206,92,206,94,0],[206,13,206,94,0],[207,13,207,118,0],[210,13,212,26,0],[215,13,215,14,0],[217,17,217,124,0],[218,13,218,14,0],[219,13,219,46,0],[220,13,220,14,0],[221,17,221,62,0],[222,17,222,100,0],[225,13,225,104,0],[226,13,226,91,0],[229,13,229,28,0],[230,9,230,10,0],[238,9,238,10,0],[239,13,239,86,0],[240,13,240,32,0],[241,13,241,14,0],[242,17,242,72,0],[245,13,245,79,0],[246,13,246,32,0],[247,13,247,14,0],[248,17,248,74,0],[249,17,249,102,0],[250,17,250,33,0],[253,13,253,46,0],[256,21,256,76,0],[260,21,260,97,0],[262,21,262,75,0],[263,21,263,126,0],[264,21,264,85,0],[266,21,266,61,0],[268,9,268,10,0],[282,9,282,10,0],[283,13,285,89,0],[285,89,285,116,0],[285,116,285,118,0],[283,13,285,118,0],[286,9,286,10,0],[299,9,299,10,0],[300,13,303,33,0],[305,13,305,92,0],[307,13,307,20,0],[307,22,307,34,0],[307,35,307,37,0],[307,38,307,47,0],[308,13,308,14,0],[309,17,309,75,0],[309,75,309,100,0],[309,100,309,102,0],[309,17,309,102,0],[310,17,310,43,0],[311,21,311,88,0],[311,89,311,90,0],[312,13,312,14,0],[314,13,315,31,0],[315,31,315,84,0],[315,84,316,40,0],[316,40,316,49,0],[316,49,316,60,0],[316,60,316,79,0],[316,79,316,85,0],[316,85,316,101,0],[316,60,316,101,0],[316,101,316,103,0],[314,13,316,103,0],[318,13,318,28,0],[319,9,319,10,0],[332,9,332,10,0],[333,13,333,55,0],[335,13,335,82,0],[336,13,336,20,0],[336,22,336,40,0],[336,41,336,43,0],[336,44,336,59,0],[337,13,337,14,0],[338,17,338,79,0],[339,17,339,71,0],[340,17,340,51,0],[341,17,341,38,0],[342,13,342,14,0],[344,13,345,31,0],[345,31,345,84,0],[345,84,346,40,0],[346,40,346,49,0],[346,49,346,60,0],[346,60,346,79,0],[346,79,346,85,0],[346,85,346,101,0],[346,60,346,101,0],[346,101,346,103,0],[344,13,346,103,0],[348,13,348,28,0],[349,9,349,10,0],[363,9,363,10,0],[364,13,365,31,0],[365,31,365,37,0],[365,37,366,58,0],[364,13,366,58,0],[367,9,367,10,0]]);
    </script>
  </body>
</html>