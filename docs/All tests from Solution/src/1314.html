<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\ParameterSwapControllerActionSelector.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web;
using System.Web.Http.Controllers;
using Umbraco.Core;

namespace Umbraco.Web.Editors
{
    /// &lt;summary&gt;
    /// This is used to auto-select specific actions on controllers that would otherwise be ambiguous based on a single parameter type
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// As an example, lets say we have 2 methods: GetChildren(int id) and GetChildren(Guid id), by default Web Api won&#39;t allow this since
    /// it won&#39;t know what to select, but if this Tuple is passed in new Tuple{string, string}(&quot;GetChildren&quot;, &quot;id&quot;)
    /// &lt;/remarks&gt;
    internal class ParameterSwapControllerActionSelector : ApiControllerActionSelector
    {
        private readonly ParameterSwapInfo[] _actions;

        /// &lt;summary&gt;
        /// Constructor accepting a list of action name + parameter name
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;actions&quot;&gt;&lt;/param&gt;
        public ParameterSwapControllerActionSelector(params ParameterSwapInfo[] actions)
        {
            _actions = actions;
        }
        public override HttpActionDescriptor SelectAction(HttpControllerContext controllerContext)
        {
            var found = _actions.FirstOrDefault(x =&gt; controllerContext.Request.RequestUri.GetLeftPart(UriPartial.Path).InvariantEndsWith(x.ActionName));

            if (found != null)
            {
                var id = HttpUtility.ParseQueryString(controllerContext.Request.RequestUri.Query).Get(found.ParamName);

                if (id != null)
                {
                    var idTypes = found.SupportedTypes;

                    foreach (var idType in idTypes)
                    {
                        var converted = id.TryConvertTo(idType);
                        if (converted)
                        {
                            var method = MatchByType(idType, controllerContext, found);
                            if (method != null)
                                return method;
                        }
                    }                   
                }
            }
            return base.SelectAction(controllerContext);
        }

        private static ReflectedHttpActionDescriptor MatchByType(Type idType, HttpControllerContext controllerContext, ParameterSwapInfo found)
        {
            var controllerType = controllerContext.Controller.GetType();
            var methods = controllerType.GetMethods().Where(info =&gt; info.Name == found.ActionName).ToArray();
            if (methods.Length &gt; 1)
            {
                //choose the one that has the parameter with the T type
                var method = methods.FirstOrDefault(x =&gt; x.GetParameters().FirstOrDefault(p =&gt; p.Name == found.ParamName &amp;&amp; p.ParameterType == idType) != null);

                return new ReflectedHttpActionDescriptor(controllerContext.ControllerDescriptor, method);
            }
            return null;
        }

        internal class ParameterSwapInfo
        {
            public string ActionName { get; private set; }
            public string ParamName { get; private set; }
            public Type[] SupportedTypes { get; private set; }

            public ParameterSwapInfo(string actionName, string paramName, params Type[] supportedTypes)
            {
                ActionName = actionName;
                ParamName = paramName;
                SupportedTypes = supportedTypes;
            }
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,89,0],[25,9,25,10,0],[26,13,26,32,0],[27,9,27,10,0],[29,9,29,10,0],[30,13,30,54,0],[30,54,30,151,0],[30,151,30,153,0],[30,13,30,153,0],[32,13,32,31,0],[33,13,33,14,0],[34,17,34,120,0],[36,17,36,32,0],[37,17,37,18,0],[38,21,38,56,0],[40,21,40,28,0],[40,30,40,40,0],[40,41,40,43,0],[40,44,40,51,0],[41,21,41,22,0],[42,25,42,65,0],[43,25,43,39,0],[44,25,44,26,0],[45,29,45,88,0],[46,29,46,48,0],[47,33,47,47,0],[48,25,48,26,0],[49,21,49,22,0],[50,17,50,18,0],[51,13,51,14,0],[52,13,52,57,0],[53,9,53,10,0],[56,9,56,10,0],[57,13,57,73,0],[58,13,58,69,0],[58,69,58,98,0],[58,98,58,110,0],[58,13,58,110,0],[59,13,59,36,0],[60,13,60,14,0],[62,17,62,58,0],[62,58,62,96,0],[62,96,62,150,0],[62,150,62,159,0],[62,58,62,159,0],[62,159,62,161,0],[62,17,62,161,0],[64,17,64,106,0],[66,13,66,25,0],[67,9,67,10,0],[71,40,71,44,0],[71,45,71,57,0],[72,39,72,43,0],[72,44,72,56,0],[73,44,73,48,0],[73,49,73,61,0],[75,13,75,104,0],[76,13,76,14,0],[77,17,77,41,0],[78,17,78,39,0],[79,17,79,49,0],[80,13,80,14,0]]);
    </script>
  </body>
</html>