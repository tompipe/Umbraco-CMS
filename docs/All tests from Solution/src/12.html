<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\UriUtilityTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using Moq;
using NUnit.Framework;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;

namespace Umbraco.Tests
{
	// fixme - not testing virtual directory!

	[TestFixture]
	public class UriUtilityTests
	{

		[TearDown]
		public void TearDown()
		{
            SettingsForTests.Reset();
		}

		// test normal urls
		[TestCase(&quot;http://LocalHost/&quot;, &quot;http://localhost/&quot;)]
		[TestCase(&quot;http://LocalHost/?x=y&quot;, &quot;http://localhost/?x=y&quot;)]
		[TestCase(&quot;http://LocalHost/Home&quot;, &quot;http://localhost/home&quot;)]
		[TestCase(&quot;http://LocalHost/Home?x=y&quot;, &quot;http://localhost/home?x=y&quot;)]
		[TestCase(&quot;http://LocalHost/Home/Sub1&quot;, &quot;http://localhost/home/sub1&quot;)]
		[TestCase(&quot;http://LocalHost/Home/Sub1?x=y&quot;, &quot;http://localhost/home/sub1?x=y&quot;)]

		// same with .aspx
		[TestCase(&quot;http://LocalHost/Home.aspx&quot;, &quot;http://localhost/home&quot;)]
		[TestCase(&quot;http://LocalHost/Home.aspx?x=y&quot;, &quot;http://localhost/home?x=y&quot;)]
		[TestCase(&quot;http://LocalHost/Home/Sub1.aspx&quot;, &quot;http://localhost/home/sub1&quot;)]
		[TestCase(&quot;http://LocalHost/Home/Sub1.aspx?x=y&quot;, &quot;http://localhost/home/sub1?x=y&quot;)]

		// test that the trailing slash goes but not on hostname
		[TestCase(&quot;http://LocalHost/&quot;, &quot;http://localhost/&quot;)]
		[TestCase(&quot;http://LocalHost/Home/&quot;, &quot;http://localhost/home&quot;)]
		[TestCase(&quot;http://LocalHost/Home/?x=y&quot;, &quot;http://localhost/home?x=y&quot;)]
		[TestCase(&quot;http://LocalHost/Home/Sub1/&quot;, &quot;http://localhost/home/sub1&quot;)]
		[TestCase(&quot;http://LocalHost/Home/Sub1/?x=y&quot;, &quot;http://localhost/home/sub1?x=y&quot;)]

		// test that default.aspx goes, even with parameters
		[TestCase(&quot;http://LocalHost/deFault.aspx&quot;, &quot;http://localhost/&quot;)]
		[TestCase(&quot;http://LocalHost/deFault.aspx?x=y&quot;, &quot;http://localhost/?x=y&quot;)]

		// test with inner .aspx
		[TestCase(&quot;http://Localhost/Home/Sub1.aspx/Sub2&quot;, &quot;http://localhost/home/sub1/sub2&quot;)]
		[TestCase(&quot;http://Localhost/Home/Sub1.aspx/Sub2?x=y&quot;, &quot;http://localhost/home/sub1/sub2?x=y&quot;)]
		[TestCase(&quot;http://Localhost/Home.aspx/Sub1.aspx/Sub2?x=y&quot;, &quot;http://localhost/home/sub1/sub2?x=y&quot;)]
		[TestCase(&quot;http://Localhost/deFault.aspx/Home.aspx/deFault.aspx/Sub1.aspx&quot;, &quot;http://localhost/home/default/sub1&quot;)]

		public void Uri_To_Umbraco(string sourceUrl, string expectedUrl)
		{
			UriUtility.SetAppDomainAppVirtualPath(&quot;/&quot;);

			var expectedUri = new Uri(expectedUrl);
			var sourceUri = new Uri(sourceUrl);
			var resultUri = UriUtility.UriToUmbraco(sourceUri);			

			Assert.AreEqual(expectedUri.ToString(), resultUri.ToString());
		}

		// test directoryUrl false, trailingSlash false
		[TestCase(&quot;/&quot;, &quot;/&quot;, false, false)]
		[TestCase(&quot;/home&quot;, &quot;/home.aspx&quot;, false, false)]
		[TestCase(&quot;/home/sub1&quot;, &quot;/home/sub1.aspx&quot;, false, false)]

		// test directoryUrl false, trailingSlash true
		[TestCase(&quot;/&quot;, &quot;/&quot;, false, true)]
		[TestCase(&quot;/home&quot;, &quot;/home.aspx&quot;, false, true)]
		[TestCase(&quot;/home/sub1&quot;, &quot;/home/sub1.aspx&quot;, false, true)]

		// test directoryUrl true, trailingSlash false
		[TestCase(&quot;/&quot;, &quot;/&quot;, true, false)]
		[TestCase(&quot;/home&quot;, &quot;/home&quot;, true, false)]
		[TestCase(&quot;/home/sub1&quot;, &quot;/home/sub1&quot;, true, false)]

		// test directoryUrl true, trailingSlash true
		[TestCase(&quot;/&quot;, &quot;/&quot;, true, true)]
		[TestCase(&quot;/home&quot;, &quot;/home/&quot;, true, true)]
		[TestCase(&quot;/home/sub1&quot;, &quot;/home/sub1/&quot;, true, true)]

		public void Uri_From_Umbraco(string sourceUrl, string expectedUrl, bool directoryUrls, bool trailingSlash)
		{
			ConfigurationManager.AppSettings.Set(&quot;umbracoUseDirectoryUrls&quot;, directoryUrls ? &quot;true&quot; : &quot;false&quot;);

            var settings = SettingsForTests.GenerateMockSettings();
            var requestMock = Mock.Get(settings.RequestHandler);
            requestMock.Setup(x =&gt; x.AddTrailingSlash).Returns(trailingSlash);
            SettingsForTests.ConfigureSettings(settings);
			
            UriUtility.SetAppDomainAppVirtualPath(&quot;/&quot;);

			var expectedUri = NewUri(expectedUrl);
			var sourceUri = NewUri(sourceUrl);
			var resultUri = UriUtility.UriFromUmbraco(sourceUri);

			Assert.AreEqual(expectedUri.ToString(), resultUri.ToString());
		}

		Uri NewUri(string url)
		{
			return new Uri(url, url.StartsWith(&quot;http:&quot;) ? UriKind.Absolute : UriKind.Relative);
		}

		//
		[TestCase(&quot;/&quot;, &quot;/&quot;, &quot;/&quot;)]
		[TestCase(&quot;/&quot;, &quot;/foo&quot;, &quot;/foo&quot;)]
		[TestCase(&quot;/&quot;, &quot;~/foo&quot;, &quot;/foo&quot;)]
		[TestCase(&quot;/vdir&quot;, &quot;/&quot;, &quot;/vdir/&quot;)]
		[TestCase(&quot;/vdir&quot;, &quot;/foo&quot;, &quot;/vdir/foo&quot;)]
		[TestCase(&quot;/vdir&quot;, &quot;/foo/&quot;, &quot;/vdir/foo/&quot;)]
		[TestCase(&quot;/vdir&quot;, &quot;~/foo&quot;, &quot;/vdir/foo&quot;)]

		public void Uri_To_Absolute(string virtualPath, string sourceUrl, string expectedUrl)
		{
			UriUtility.SetAppDomainAppVirtualPath(virtualPath);
			var resultUrl = UriUtility.ToAbsolute(sourceUrl);
			Assert.AreEqual(expectedUrl, resultUrl);
		}

		//
		[TestCase(&quot;/&quot;, &quot;/&quot;, &quot;/&quot;)]
		[TestCase(&quot;/&quot;, &quot;/foo&quot;, &quot;/foo&quot;)]
		[TestCase(&quot;/&quot;, &quot;/foo/&quot;, &quot;/foo/&quot;)]
		[TestCase(&quot;/vdir&quot;, &quot;/vdir&quot;, &quot;/&quot;)]
		[TestCase(&quot;/vdir&quot;, &quot;/vdir/&quot;, &quot;/&quot;)]
		[TestCase(&quot;/vdir&quot;, &quot;/vdir/foo&quot;, &quot;/foo&quot;)]
		[TestCase(&quot;/vdir&quot;, &quot;/vdir/foo/&quot;, &quot;/foo/&quot;)]

		public void Url_To_App_Relative(string virtualPath, string sourceUrl, string expectedUrl)
		{
			UriUtility.SetAppDomainAppVirtualPath(virtualPath);
			var resultUrl = UriUtility.ToAppRelative(sourceUrl);
			Assert.AreEqual(expectedUrl, resultUrl);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,3,18,4,1],[19,13,19,38,1],[20,3,20,4,1],[54,3,54,4,1],[55,4,55,47,1],[57,4,57,43,1],[58,4,58,39,1],[59,4,59,55,1],[61,4,61,66,1],[62,3,62,4,1],[85,3,85,4,1],[86,4,86,102,1],[88,13,88,68,1],[89,13,89,65,1],[90,13,90,79,1],[91,13,91,58,1],[93,13,93,56,1],[95,4,95,42,1],[96,4,96,38,1],[97,4,97,57,1],[99,4,99,66,1],[100,3,100,4,1],[103,3,103,4,1],[104,4,104,87,1],[105,3,105,4,1],[117,3,117,4,1],[118,4,118,55,1],[119,4,119,53,1],[120,4,120,44,1],[121,3,121,4,1],[133,3,133,4,1],[134,4,134,55,1],[135,4,135,56,1],[136,4,136,44,1],[137,3,137,4,1]]);
    </script>
  </body>
</html>