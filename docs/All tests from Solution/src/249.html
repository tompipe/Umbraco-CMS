<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Web\Mvc\SurfaceControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using System.Web.Security;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Dictionary;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Profiling;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;
using Umbraco.Web.Mvc;
using Umbraco.Web.Routing;
using Umbraco.Web.Security;

namespace Umbraco.Tests.Web.Mvc
{
    [TestFixture]
    public class SurfaceControllerTests
    {
        [Test]
        public void Can_Construct_And_Get_Result()
        {
            var appCtx = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            var umbCtx = UmbracoContext.EnsureContext(
                new Mock&lt;HttpContextBase&gt;().Object,
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);

            var ctrl = new TestSurfaceController(umbCtx);

            var result = ctrl.Index();

            Assert.IsNotNull(result);
        }

        [Test]
        public void Umbraco_Context_Not_Null()
        {
            var appCtx = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ApplicationContext.EnsureContext(appCtx, true);

            var umbCtx = UmbracoContext.EnsureContext(
                new Mock&lt;HttpContextBase&gt;().Object,
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);

            var ctrl = new TestSurfaceController(umbCtx);

            Assert.IsNotNull(ctrl.UmbracoContext);
        }

        [Test]
        public void Umbraco_Helper_Not_Null()
        {
            var appCtx = new ApplicationContext(
                new DatabaseContext(new Mock&lt;IDatabaseFactory&gt;().Object, Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;ISqlSyntaxProvider&gt;(), &quot;test&quot;),
                MockHelper.GetMockedServiceContext(),
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            var umbCtx = UmbracoContext.EnsureContext(
                new Mock&lt;HttpContextBase&gt;().Object,
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);

            var ctrl = new TestSurfaceController(umbCtx);

            Assert.IsNotNull(ctrl.Umbraco);
        }

        [Test]
        public void Can_Lookup_Content()
        {
            var appCtx = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            var umbCtx = UmbracoContext.EnsureContext(
                new Mock&lt;HttpContextBase&gt;().Object,
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(routingSection =&gt; routingSection.UrlProviderMode == &quot;AutoLegacy&quot;)),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);

            var helper = new UmbracoHelper(
                umbCtx,
                Mock.Of&lt;IPublishedContent&gt;(),
                Mock.Of&lt;ITypedPublishedContentQuery&gt;(query =&gt; query.TypedContent(It.IsAny&lt;int&gt;()) ==
                    //return mock of IPublishedContent for any call to GetById
                    Mock.Of&lt;IPublishedContent&gt;(content =&gt; content.Id == 2)),
                Mock.Of&lt;IDynamicPublishedContentQuery&gt;(),
                Mock.Of&lt;ITagQuery&gt;(),
                Mock.Of&lt;IDataTypeService&gt;(),
                new UrlProvider(umbCtx, Enumerable.Empty&lt;IUrlProvider&gt;()),
                Mock.Of&lt;ICultureDictionary&gt;(),
                Mock.Of&lt;IUmbracoComponentRenderer&gt;(),
                new MembershipHelper(umbCtx, Mock.Of&lt;MembershipProvider&gt;(), Mock.Of&lt;RoleProvider&gt;()));

            var ctrl = new TestSurfaceController(umbCtx, helper);
            var result = ctrl.GetContent(2) as PublishedContentResult;

            Assert.IsNotNull(result);
            Assert.AreEqual(2, result.Content.Id);
        }

        [Test]
        public void Mock_Current_Page()
        {
            var appCtx = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            var webRoutingSettings = Mock.Of&lt;IWebRoutingSection&gt;(section =&gt; section.UrlProviderMode == &quot;AutoLegacy&quot;);

            var umbCtx = UmbracoContext.EnsureContext(
                new Mock&lt;HttpContextBase&gt;().Object,
                appCtx,
                new Mock&lt;WebSecurity&gt;(null, null).Object,
                Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt; section.WebRouting == webRoutingSettings),
                Enumerable.Empty&lt;IUrlProvider&gt;(),
                true);

            var content = Mock.Of&lt;IPublishedContent&gt;(publishedContent =&gt; publishedContent.Id == 12345);

            var contextBase = umbCtx.HttpContext;
            var pcr = new PublishedContentRequest(new Uri(&quot;http://localhost/test&quot;),
                umbCtx.RoutingContext,
                webRoutingSettings,
                s =&gt; Enumerable.Empty&lt;string&gt;())
            {
                PublishedContent = content
            };

            var routeDefinition = new RouteDefinition
            {
                PublishedContentRequest = pcr
            };

            var routeData = new RouteData();
            routeData.DataTokens.Add(Umbraco.Core.Constants.Web.UmbracoRouteDefinitionDataToken, routeDefinition);

            var ctrl = new TestSurfaceController(umbCtx, new UmbracoHelper());
            ctrl.ControllerContext = new ControllerContext(contextBase, routeData, ctrl);

            var result = ctrl.GetContentFromCurrentPage() as PublishedContentResult;

            Assert.AreEqual(12345, result.Content.Id);
        }

        public class TestSurfaceController : SurfaceController
        {
            private readonly UmbracoHelper _umbracoHelper;

            public TestSurfaceController(UmbracoContext umbracoContext)
                : base(umbracoContext)
            {
            }

            public TestSurfaceController(UmbracoContext umbracoContext, UmbracoHelper umbracoHelper)
                : base(umbracoContext)
            {
                _umbracoHelper = umbracoHelper;
            }

            /// &lt;summary&gt;
            /// Returns an UmbracoHelper object
            /// &lt;/summary&gt;
            public override UmbracoHelper Umbraco
            {
                get { return _umbracoHelper ?? base.Umbraco; }
            }

            public ActionResult Index()
            {
                return View();
            }

            public ActionResult GetContent(int id)
            {
                var content = Umbraco.TypedContent(id);

                return new PublishedContentResult(content);
            }

            public ActionResult GetContentFromCurrentPage()
            {
                var content = CurrentPage;

                return new PublishedContentResult(content);
            }
        }

        public class PublishedContentResult : ActionResult
        {
            public IPublishedContent Content { get; set; }

            public PublishedContentResult(IPublishedContent content)
            {
                Content = content;
            }

            public override void ExecuteResult(ControllerContext context)
            {
            }

        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,10,1],[32,13,34,80,1],[36,13,42,23,1],[44,13,44,58,1],[46,13,46,39,1],[48,13,48,38,1],[49,9,49,10,1],[53,9,53,10,1],[54,13,56,80,1],[58,13,58,60,1],[60,13,66,23,1],[68,13,68,58,1],[70,13,70,51,1],[71,9,71,10,1],[75,9,75,10,1],[76,13,80,80,1],[82,13,88,23,1],[90,13,90,58,1],[92,13,92,44,1],[93,9,93,10,1],[97,9,97,10,1],[98,13,100,80,1],[102,13,108,23,1],[110,13,122,103,1],[124,13,124,66,1],[125,13,125,71,1],[127,13,127,38,1],[128,13,128,51,1],[129,9,129,10,1],[133,9,133,10,1],[134,13,136,80,1],[138,13,138,118,1],[140,13,146,23,1],[148,13,148,104,1],[150,13,150,50,1],[151,13,154,22,1],[154,22,154,48,0],[154,48,157,15,1],[151,13,157,15,1],[159,13,162,15,1],[164,13,164,45,1],[165,13,165,115,1],[167,13,167,79,1],[168,13,168,90,1],[170,13,170,85,1],[172,13,172,55,1],[173,9,173,10,1],[180,19,180,39,1],[181,13,181,14,1],[182,13,182,14,1],[185,19,185,39,1],[186,13,186,14,1],[187,17,187,48,1],[188,13,188,14,1],[195,21,195,22,1],[195,23,195,61,1],[195,62,195,63,1],[199,13,199,14,1],[200,17,200,31,1],[201,13,201,14,1],[204,13,204,14,1],[205,17,205,56,1],[207,17,207,60,1],[208,13,208,14,1],[211,13,211,14,1],[212,17,212,43,1],[214,17,214,60,1],[215,13,215,14,1],[220,48,220,52,1],[220,53,220,57,1],[222,13,222,69,1],[223,13,223,14,1],[224,17,224,35,1],[225,13,225,14,1],[228,13,228,14,0],[229,13,229,14,0]]);
    </script>
  </body>
</html>