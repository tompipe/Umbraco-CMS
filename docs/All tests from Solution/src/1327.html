<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\ImagesController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Drawing;
using System.IO;
using System.Net;
using System.Net.Http;
using System.Net.Http.Headers;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Media;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebApi.Filters;
using Constants = Umbraco.Core.Constants;

namespace Umbraco.Web.Editors
{
    /// &lt;summary&gt;
    /// A controller used to return images for media
    /// &lt;/summary&gt;
    [PluginController(&quot;UmbracoApi&quot;)]
    public class ImagesController : UmbracoAuthorizedApiController
    {
        /// &lt;summary&gt;
        /// Gets the big thumbnail image for the media id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// If there is no media, image property or image file is found then this will return not found.
        /// &lt;/remarks&gt;
        public HttpResponseMessage GetBigThumbnail(int mediaId)
        {
            var media = Services.MediaService.GetById(mediaId);
            if (media == null)
            {
                return Request.CreateResponse(HttpStatusCode.NotFound);
            }
            var imageProp = media.Properties[Constants.Conventions.Media.File];
            if (imageProp == null)
            {
                return Request.CreateResponse(HttpStatusCode.NotFound);
            }

            var imagePath = imageProp.Value.ToString();

            return GetBigThumbnail(imagePath);
        }

        /// &lt;summary&gt;
        /// Gets the big thumbnail image for the original image path
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;originalImagePath&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// If there is no original image is found then this will return not found.
        /// &lt;/remarks&gt;
        public HttpResponseMessage GetBigThumbnail(string originalImagePath)
        {
            if (string.IsNullOrWhiteSpace(originalImagePath))
                return Request.CreateResponse(HttpStatusCode.OK);

            return GetResized(originalImagePath, 500, &quot;big-thumb&quot;);
        }

        /// &lt;summary&gt;
        /// Gets a resized image for the media id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;width&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// If there is no media, image property or image file is found then this will return not found.
        /// &lt;/remarks&gt;
        public HttpResponseMessage GetResized(int mediaId, int width)
        {
            var media = Services.MediaService.GetById(mediaId);
            if (media == null)
            {
                return new HttpResponseMessage(HttpStatusCode.NotFound);
            }
            var imageProp = media.Properties[Constants.Conventions.Media.File];
            if (imageProp == null)
            {
                return new HttpResponseMessage(HttpStatusCode.NotFound);
            }

            var imagePath = imageProp.Value.ToString();

            return GetResized(imagePath, width);
        }

        /// &lt;summary&gt;
        /// Gets a resized image for the image at the given path
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;imagePath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;width&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// If there is no media, image property or image file is found then this will return not found.
        /// &lt;/remarks&gt;
        public HttpResponseMessage GetResized(string imagePath, int width)
        {
            return GetResized(imagePath, width, Convert.ToString(width));
        }

        /// &lt;summary&gt;
        /// Gets a resized image - if the requested max width is greater than the original image, only the original image will be returned.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;imagePath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;width&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;suffix&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private HttpResponseMessage GetResized(string imagePath, int width, string suffix)
        {
            var mediaFileSystem = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();
            var ext = Path.GetExtension(imagePath);

            //we need to check if it is an image by extension
            if (UmbracoConfig.For.UmbracoSettings().Content.ImageFileTypes.InvariantContains(ext.TrimStart(&#39;.&#39;)) == false)
            {
                return Request.CreateResponse(HttpStatusCode.NotFound);
            }

            //redirect to ImageProcessor thumbnail with rnd generated from last modified time of original media file
            var response = Request.CreateResponse( HttpStatusCode.Found );
            var imageLastModified = mediaFileSystem.GetLastModified( imagePath );
            response.Headers.Location = new Uri( string.Format( &quot;{0}?rnd={1}&amp;width={2}&quot;, imagePath, string.Format( &quot;{0:yyyyMMddHHmmss}&quot;, imageLastModified ), width ), UriKind.Relative );
            return response;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,10,0],[34,13,34,64,0],[35,13,35,31,0],[36,13,36,14,0],[37,17,37,72,0],[39,13,39,80,0],[40,13,40,35,0],[41,13,41,14,0],[42,17,42,72,0],[45,13,45,56,0],[47,13,47,47,0],[48,9,48,10,0],[59,9,59,10,0],[60,13,60,62,0],[61,17,61,66,0],[63,13,63,68,0],[64,9,64,10,0],[76,9,76,10,0],[77,13,77,64,0],[78,13,78,31,0],[79,13,79,14,0],[80,17,80,73,0],[82,13,82,80,0],[83,13,83,35,0],[84,13,84,14,0],[85,17,85,73,0],[88,13,88,56,0],[90,13,90,49,0],[91,9,91,10,0],[103,9,103,10,0],[104,13,104,74,0],[105,9,105,10,0],[115,9,115,10,0],[116,13,116,110,0],[117,13,117,52,0],[120,13,120,123,0],[121,13,121,14,0],[122,17,122,72,0],[126,13,126,75,0],[127,13,127,82,0],[128,13,128,187,0],[129,13,129,29,0],[130,9,130,10,0]]);
    </script>
  </body>
</html>