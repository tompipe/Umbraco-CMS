<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\InstallSteps\StarterKitCleanupStep.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using umbraco;
using umbraco.cms.businesslogic.packager;
using Umbraco.Core;
using Umbraco.Web.Install.Models;

namespace Umbraco.Web.Install.InstallSteps
{
    [InstallSetupStep(InstallationType.NewInstall, 
        &quot;StarterKitCleanup&quot;, 32, &quot;Almost done&quot;)]
    internal class StarterKitCleanupStep : InstallSetupStep&lt;object&gt;
    {
        private readonly ApplicationContext _applicationContext;

        public StarterKitCleanupStep(ApplicationContext applicationContext)
        {
            _applicationContext = applicationContext;
        }

        public override InstallSetupResult Execute(object model)
        {
            var installSteps = InstallStatusTracker.GetStatus().ToArray();
            var previousStep = installSteps.Single(x =&gt; x.Name == &quot;StarterKitDownload&quot;);
            var manifestId = Convert.ToInt32(previousStep.AdditionalData[&quot;manifestId&quot;]);
            var packageFile = (string)previousStep.AdditionalData[&quot;packageFile&quot;];

            CleanupInstallation(manifestId, packageFile);
            
            return null;
        }

        private void CleanupInstallation(int manifestId, string packageFile)
        {
            packageFile = HttpUtility.UrlDecode(packageFile);
            var installer = new Installer();
            installer.LoadConfig(packageFile);
            installer.InstallCleanUp(manifestId, packageFile);

            library.RefreshContent();
        }

        public override bool RequiresExecution(object model)
        {
            var installSteps = InstallStatusTracker.GetStatus().ToArray();
            //this step relies on the preious one completed - because it has stored some information we need
            if (installSteps.Any(x =&gt; x.Name == &quot;StarterKitDownload&quot; &amp;&amp; x.AdditionalData.ContainsKey(&quot;manifestId&quot;)) == false)
            {
                return false;
            }

            return true;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,76,0],[19,9,19,10,0],[20,13,20,54,0],[21,9,21,10,0],[24,9,24,10,0],[25,13,25,75,0],[26,13,26,57,0],[26,57,26,87,0],[26,87,26,89,0],[26,13,26,89,0],[27,13,27,89,0],[28,13,28,82,0],[30,13,30,58,0],[32,13,32,25,0],[33,9,33,10,0],[36,9,36,10,0],[37,13,37,62,0],[38,13,38,45,0],[39,13,39,47,0],[40,13,40,63,0],[42,13,42,38,0],[43,9,43,10,0],[46,9,46,10,0],[47,13,47,75,0],[49,13,49,39,0],[49,39,49,115,0],[49,115,49,126,0],[49,13,49,126,0],[50,13,50,14,0],[51,17,51,30,0],[54,13,54,25,0],[55,9,55,10,0]]);
    </script>
  </body>
</html>