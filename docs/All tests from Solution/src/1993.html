<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\Macro.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Collections.Specialized;
using System.ComponentModel;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization;
using System.Text.RegularExpressions;
using Umbraco.Core.IO;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Strings;

namespace Umbraco.Core.Models
{
    /// &lt;summary&gt;
    /// Represents a Macro
    /// &lt;/summary&gt;
    [Serializable]
    [DataContract(IsReference = true)]
    public class Macro : Entity, IMacro
    {
        public Macro()
        {
            _properties = new MacroPropertyCollection();
            _properties.CollectionChanged += PropertiesChanged;
            _addedProperties = new List&lt;string&gt;();
            _removedProperties = new List&lt;string&gt;();
        }
        
        /// &lt;summary&gt;
        /// Creates an item with pre-filled properties
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;useInEditor&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cacheDuration&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controlType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controlAssembly&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;xsltPath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cacheByPage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cacheByMember&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dontRender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;scriptPath&quot;&gt;&lt;/param&gt;
        public Macro(int id, bool useInEditor, int cacheDuration, string @alias, string name, string controlType, string controlAssembly, string xsltPath, bool cacheByPage, bool cacheByMember, bool dontRender, string scriptPath)
            : this()
        {
            Id = id;
            UseInEditor = useInEditor;
            CacheDuration = cacheDuration;
            Alias = alias.ToCleanString(CleanStringType.Alias);
            Name = name;
            ControlType = controlType;
            ControlAssembly = controlAssembly;
            XsltPath = xsltPath;
            CacheByPage = cacheByPage;
            CacheByMember = cacheByMember;
            DontRender = dontRender;
            ScriptPath = scriptPath;
        }

        /// &lt;summary&gt;
        /// Creates an instance for persisting a new item
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;useInEditor&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cacheDuration&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controlType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controlAssembly&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;xsltPath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cacheByPage&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cacheByMember&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dontRender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;scriptPath&quot;&gt;&lt;/param&gt;
        public Macro(string @alias, string name,
            string controlType = &quot;&quot;,
            string controlAssembly = &quot;&quot;,
            string xsltPath = &quot;&quot;,
            string scriptPath = &quot;&quot;,
            bool cacheByPage = false,
            bool cacheByMember = false,
            bool dontRender = true,
            bool useInEditor = false,
            int cacheDuration = 0)
            : this()
        {
            UseInEditor = useInEditor;
            CacheDuration = cacheDuration;
            Alias = alias.ToCleanString(CleanStringType.Alias);
            Name = name;
            ControlType = controlType;
            ControlAssembly = controlAssembly;
            XsltPath = xsltPath;
            CacheByPage = cacheByPage;
            CacheByMember = cacheByMember;
            DontRender = dontRender;
            ScriptPath = scriptPath;
        }

        private string _alias;
        private string _name;
        private bool _useInEditor;
        private int _cacheDuration;
        private bool _cacheByPage;
        private bool _cacheByMember;
        private bool _dontRender;
        private string _scriptFile;
        private string _scriptAssembly;
        private string _scriptPath;
        private string _xslt;
        private MacroPropertyCollection _properties;
        private List&lt;string&gt; _addedProperties;
        private List&lt;string&gt; _removedProperties;

        private static readonly Lazy&lt;PropertySelectors&gt; Ps = new Lazy&lt;PropertySelectors&gt;();

        private class PropertySelectors
        {
            public readonly PropertyInfo AliasSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, string&gt;(x =&gt; x.Alias);
            public readonly PropertyInfo NameSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, string&gt;(x =&gt; x.Name);
            public readonly PropertyInfo UseInEditorSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, bool&gt;(x =&gt; x.UseInEditor);
            public readonly PropertyInfo CacheDurationSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, int&gt;(x =&gt; x.CacheDuration);
            public readonly PropertyInfo CacheByPageSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, bool&gt;(x =&gt; x.CacheByPage);
            public readonly PropertyInfo CacheByMemberSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, bool&gt;(x =&gt; x.CacheByMember);
            public readonly PropertyInfo DontRenderSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, bool&gt;(x =&gt; x.DontRender);
            public readonly PropertyInfo ControlPathSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, string&gt;(x =&gt; x.ControlType);
            public readonly PropertyInfo ControlAssemblySelector = ExpressionHelper.GetPropertyInfo&lt;Macro, string&gt;(x =&gt; x.ControlAssembly);
            public readonly PropertyInfo ScriptPathSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, string&gt;(x =&gt; x.ScriptPath);
            public readonly PropertyInfo XsltPathSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, string&gt;(x =&gt; x.XsltPath);
            public readonly PropertyInfo PropertiesSelector = ExpressionHelper.GetPropertyInfo&lt;Macro, MacroPropertyCollection&gt;(x =&gt; x.Properties);
        }

        void PropertiesChanged(object sender, NotifyCollectionChangedEventArgs e)
        {
            OnPropertyChanged(Ps.Value.PropertiesSelector);

            if (e.Action == NotifyCollectionChangedAction.Add)
            {
                //listen for changes
                var prop = e.NewItems.Cast&lt;MacroProperty&gt;().First();
                prop.PropertyChanged += PropertyDataChanged;

                var alias = prop.Alias;

                if (_addedProperties.Contains(alias) == false)
                {
                    //add to the added props
                    _addedProperties.Add(alias);
                }
            }
            else if (e.Action == NotifyCollectionChangedAction.Remove)
            {
                //remove listening for changes
                var prop = e.OldItems.Cast&lt;MacroProperty&gt;().First();
                prop.PropertyChanged -= PropertyDataChanged;

                var alias = prop.Alias;

                if (_removedProperties.Contains(alias) == false)
                {
                    _removedProperties.Add(alias);
                }
            }
        }

        /// &lt;summary&gt;
        /// When some data of a property has changed ensure our Properties flag is dirty
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        void PropertyDataChanged(object sender, PropertyChangedEventArgs e)
        {
            OnPropertyChanged(Ps.Value.PropertiesSelector);
        }
        
        public override void ResetDirtyProperties(bool rememberPreviouslyChangedProperties)
        {
            _addedProperties.Clear();
            _removedProperties.Clear();
            base.ResetDirtyProperties(rememberPreviouslyChangedProperties);
            foreach (var prop in Properties)
            {
                ((TracksChangesEntityBase)prop).ResetDirtyProperties(rememberPreviouslyChangedProperties);
            }
        }

        /// &lt;summary&gt;
        /// Used internally to check if we need to add a section in the repository to the db
        /// &lt;/summary&gt;
        internal IEnumerable&lt;string&gt; AddedProperties
        {
            get { return _addedProperties; }
        }

        /// &lt;summary&gt;
        /// Used internally to check if we need to remove  a section in the repository to the db
        /// &lt;/summary&gt;
        internal IEnumerable&lt;string&gt; RemovedProperties
        {
            get { return _removedProperties; }
        }

        /// &lt;summary&gt;
        /// Gets or sets the alias of the Macro
        /// &lt;/summary&gt;
        [DataMember]
        public string Alias
        {
            get { return _alias; }
            set { SetPropertyValueAndDetectChanges(value.ToCleanString(CleanStringType.Alias), ref _alias, Ps.Value.AliasSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the name of the Macro
        /// &lt;/summary&gt;
        [DataMember]
        public string Name
        {
            get { return _name; }
            set { SetPropertyValueAndDetectChanges(value, ref _name, Ps.Value.NameSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets a boolean indicating whether the Macro can be used in an Editor
        /// &lt;/summary&gt;
        [DataMember]
        public bool UseInEditor
        {
            get { return _useInEditor; }
            set { SetPropertyValueAndDetectChanges(value, ref _useInEditor, Ps.Value.UseInEditorSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the Cache Duration for the Macro
        /// &lt;/summary&gt;
        [DataMember]
        public int CacheDuration
        {
            get { return _cacheDuration; }
            set { SetPropertyValueAndDetectChanges(value, ref _cacheDuration, Ps.Value.CacheDurationSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets a boolean indicating whether the Macro should be Cached by Page
        /// &lt;/summary&gt;
        [DataMember]
        public bool CacheByPage
        {
            get { return _cacheByPage; }
            set { SetPropertyValueAndDetectChanges(value, ref _cacheByPage, Ps.Value.CacheByPageSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets a boolean indicating whether the Macro should be Cached Personally
        /// &lt;/summary&gt;
        [DataMember]
        public bool CacheByMember
        {
            get { return _cacheByMember; }
            set { SetPropertyValueAndDetectChanges(value, ref _cacheByMember, Ps.Value.CacheByMemberSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets a boolean indicating whether the Macro should be rendered in an Editor
        /// &lt;/summary&gt;
        [DataMember]
        public bool DontRender
        {
            get { return _dontRender; }
            set { SetPropertyValueAndDetectChanges(value, ref _dontRender, Ps.Value.DontRenderSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the path to user control or the Control Type to render
        /// &lt;/summary&gt;
        [DataMember]
        public string ControlType
        {
            get { return _scriptFile; }
            set { SetPropertyValueAndDetectChanges(value, ref _scriptFile, Ps.Value.ControlPathSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the name of the assembly, which should be used by the Macro
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Will usually only be filled if the ControlType is a Usercontrol&lt;/remarks&gt;
        [DataMember]
        public string ControlAssembly
        {
            get { return _scriptAssembly; }
            set { SetPropertyValueAndDetectChanges(value, ref _scriptAssembly, Ps.Value.ControlAssemblySelector); }
        }

        /// &lt;summary&gt;
        /// Gets or set the path to the Python file in use
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Optional: Can only be one of three Script, Python or Xslt&lt;/remarks&gt;
        [DataMember]
        public string ScriptPath
        {
            get { return _scriptPath; }
            set { SetPropertyValueAndDetectChanges(value, ref _scriptPath, Ps.Value.ScriptPathSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the path to the Xslt file in use
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Optional: Can only be one of three Script, Python or Xslt&lt;/remarks&gt;
        [DataMember]
        public string XsltPath
        {
            get { return _xslt; }
            set { SetPropertyValueAndDetectChanges(value, ref _xslt, Ps.Value.XsltPathSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets a list of Macro Properties
        /// &lt;/summary&gt;
        [DataMember]
        public MacroPropertyCollection Properties
        {
            get { return _properties; }            
        }

        public override object DeepClone()
        {
            var clone = (Macro)base.DeepClone();
            //turn off change tracking
            clone.DisableChangeTracking();
            clone._addedProperties = new List&lt;string&gt;();
            clone._removedProperties = new List&lt;string&gt;();
            clone._properties = (MacroPropertyCollection)Properties.DeepClone();
            //re-assign the event handler
            clone._properties.CollectionChanged += clone.PropertiesChanged;
            //this shouldn&#39;t really be needed since we&#39;re not tracking
            clone.ResetDirtyProperties(false);
            //re-enable tracking
            clone.EnableChangeTracking();

            return clone;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,23,1],[24,9,24,10,1],[25,13,25,57,1],[26,13,26,64,1],[27,13,27,51,1],[28,13,28,53,1],[29,9,29,10,1],[47,15,47,21,1],[48,9,48,10,1],[49,13,49,21,1],[50,13,50,39,1],[51,13,51,43,1],[52,13,52,64,1],[53,13,53,25,1],[54,13,54,39,1],[55,13,55,47,1],[56,13,56,33,1],[57,13,57,39,1],[58,13,58,43,1],[59,13,59,37,1],[60,13,60,37,1],[61,9,61,10,1],[87,15,87,21,1],[88,9,88,10,1],[89,13,89,39,1],[90,13,90,43,1],[91,13,91,64,1],[92,13,92,25,1],[93,13,93,39,1],[94,13,94,47,1],[95,13,95,33,1],[96,13,96,39,1],[97,13,97,43,1],[98,13,98,37,1],[99,13,99,37,1],[100,9,100,10,1],[117,9,117,92,1],[121,13,121,120,1],[122,13,122,118,1],[123,13,123,130,1],[124,13,124,133,1],[125,13,125,130,1],[126,13,126,134,1],[127,13,127,128,1],[128,13,128,132,1],[129,13,129,140,1],[130,13,130,130,1],[131,13,131,126,1],[132,13,132,147,1],[136,9,136,10,1],[137,13,137,60,1],[139,13,139,63,1],[140,13,140,14,1],[142,17,142,69,1],[143,17,143,61,1],[145,17,145,40,1],[147,17,147,63,1],[148,17,148,18,1],[150,21,150,49,1],[151,17,151,18,1],[152,13,152,14,1],[153,18,153,71,1],[154,13,154,14,1],[156,17,156,69,1],[157,17,157,61,1],[159,17,159,40,1],[161,17,161,65,1],[162,17,162,18,1],[163,21,163,51,1],[164,17,164,18,1],[165,13,165,14,1],[166,9,166,10,1],[174,9,174,10,1],[175,13,175,60,1],[176,9,176,10,1],[179,9,179,10,1],[180,13,180,38,1],[181,13,181,40,1],[182,13,182,76,1],[183,13,183,20,1],[183,22,183,30,1],[183,31,183,33,1],[183,34,183,44,1],[184,13,184,14,1],[185,17,185,107,1],[186,13,186,14,1],[187,9,187,10,1],[194,17,194,18,1],[194,19,194,43,1],[194,44,194,45,1],[202,17,202,18,1],[202,19,202,45,1],[202,46,202,47,1],[211,17,211,18,1],[211,19,211,33,1],[211,34,211,35,1],[212,17,212,18,1],[212,19,212,132,1],[212,133,212,134,1],[221,17,221,18,1],[221,19,221,32,1],[221,33,221,34,1],[222,17,222,18,1],[222,19,222,93,1],[222,94,222,95,1],[231,17,231,18,1],[231,19,231,39,1],[231,40,231,41,1],[232,17,232,18,1],[232,19,232,107,1],[232,108,232,109,1],[241,17,241,18,1],[241,19,241,41,1],[241,42,241,43,1],[242,17,242,18,1],[242,19,242,111,1],[242,112,242,113,1],[251,17,251,18,1],[251,19,251,39,1],[251,40,251,41,1],[252,17,252,18,1],[252,19,252,107,1],[252,108,252,109,1],[261,17,261,18,1],[261,19,261,41,1],[261,42,261,43,1],[262,17,262,18,1],[262,19,262,111,1],[262,112,262,113,1],[271,17,271,18,1],[271,19,271,38,1],[271,39,271,40,1],[272,17,272,18,1],[272,19,272,105,1],[272,106,272,107,1],[281,17,281,18,1],[281,19,281,38,1],[281,39,281,40,1],[282,17,282,18,1],[282,19,282,106,1],[282,107,282,108,1],[292,17,292,18,1],[292,19,292,42,1],[292,43,292,44,1],[293,17,293,18,1],[293,19,293,114,1],[293,115,293,116,1],[303,17,303,18,1],[303,19,303,38,1],[303,39,303,40,1],[304,17,304,18,1],[304,19,304,105,1],[304,106,304,107,1],[314,17,314,18,1],[314,19,314,32,1],[314,33,314,34,1],[315,17,315,18,1],[315,19,315,97,1],[315,98,315,99,1],[324,17,324,18,1],[324,19,324,38,1],[324,39,324,40,1],[328,9,328,10,1],[329,13,329,49,1],[331,13,331,43,1],[332,13,332,57,1],[333,13,333,59,1],[334,13,334,81,1],[336,13,336,76,1],[338,13,338,47,1],[340,13,340,42,1],[342,13,342,26,1],[343,9,343,10,1]]);
    </script>
  </body>
</html>