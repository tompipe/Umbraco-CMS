<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UI\Pages\ClientTools.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Text;
using System.Web;
using Umbraco.Core.IO;
using umbraco.BasePages;
using System.Web.UI;
using umbraco.BusinessLogic;
using Umbraco.Core;

namespace Umbraco.Web.UI.Pages
{

	/// &lt;summary&gt;
	/// Renders the client side code necessary to interact with the Umbraco client side API.
	/// Each method returns an instance of this class so you can chain calls together.
	/// &lt;/summary&gt;
	public sealed class ClientTools
	{

		public ClientTools(Page page)
		{
			_page = page;
		}

		/// &lt;summary&gt;
		/// Returns the string markup for the JavaScript that is rendered.
		/// If referencing JavaScript scripts in the backend, this class should be used
		/// in case future changes to the client code is change, this will remain intact.
		/// &lt;/summary&gt;
		public static class Scripts
		{
			internal const string ClientMgrScript = &quot;UmbClientMgr&quot;;
			public static string GetAppActions { get { return string.Format(&quot;{0}.appActions()&quot;, ClientMgrScript); } }
			public static string GetMainWindow { get { return string.Format(&quot;{0}.mainWindow()&quot;, ClientMgrScript); } }
			public static string GetMainTree { get { return string.Format(&quot;{0}.mainTree()&quot;, ClientMgrScript); } }
			public static string GetContentFrame() { return string.Format(&quot;{0}.contentFrame()&quot;, ClientMgrScript); }
			public static string ShiftApp(string appAlias)
			{
                return string.Format(ClientMgrScript + &quot;.historyManager().addHistory(&#39;{0}&#39;)&quot;, appAlias);
			}
			public static string OpenDashboard(string app)
			{
				return string.Format(GetAppActions + &quot;.openDashboard(&#39;{0}&#39;);&quot;, app);
			}
			public static string RefreshAdmin { get { return &quot;setTimeout(&#39;&quot; + GetMainWindow + &quot;.location.reload()&#39;, {0});&quot;; } }
			public static string ShowSpeechBubble { get { return GetMainWindow + &quot;.UmbSpeechBubble.ShowMessage(&#39;{0}&#39;,&#39;{1}&#39;, &#39;{2}&#39;);&quot;; } }
			public static string ChangeContentFrameUrl(string url) {
				return string.Format(ClientMgrScript + &quot;.contentFrame(&#39;{0}&#39;);&quot;, url);
			}
            public static string ReloadContentFrameUrlIfPathLoaded(string url)
            {
                return string.Format(ClientMgrScript + &quot;.reloadContentFrameUrlIfPathLoaded(&#39;{0}&#39;);&quot;, url);
            }
            public static string ReloadLocation { get { return string.Format(ClientMgrScript + &quot;.reloadLocation();&quot;); } }
            public static string ChildNodeCreated = GetMainTree + &quot;.childNodeCreated();&quot;;
			public static string SyncTree { get { return GetMainTree + &quot;.syncTree(&#39;{0}&#39;, {1});&quot;; } }
			public static string ClearTreeCache { get { return GetMainTree + &quot;.clearTreeCache();&quot;; } }
			public static string CopyNode { get { return GetMainTree + &quot;.copyNode(&#39;{0}&#39;, &#39;{1}&#39;);&quot;; } }
			public static string MoveNode { get { return GetMainTree + &quot;.moveNode(&#39;{0}&#39;, &#39;{1}&#39;);&quot;; } }
			public static string ReloadActionNode { get { return GetMainTree + &quot;.reloadActionNode({0}, {1}, null);&quot;; } }
			public static string SetActiveTreeType { get { return GetMainTree + &quot;.setActiveTreeType(&#39;{0}&#39;);&quot;; } }
            public static string RefreshTree { get { return GetMainTree + &quot;.refreshTree();&quot;; } }
            public static string RefreshTreeType { get { return GetMainTree + &quot;.refreshTree(&#39;{0}&#39;);&quot;; } }
            public static string CloseModalWindow()
            {
                return string.Format(&quot;{0}.closeModalWindow();&quot;, ClientMgrScript);
            }
            public static string CloseModalWindow(string rVal)
            {
                return string.Format(&quot;{0}.closeModalWindow(&#39;{1}&#39;);&quot;, ClientMgrScript, rVal);
            }
            public static string OpenModalWindow(string url, string name, int width, int height)
            {
                return OpenModalWindow(url, name, true, width, height, 0, 0, &quot;&quot;, &quot;&quot;);
            }
            public static string OpenModalWindow(string url, string name, bool showHeader, int width, int height, int top, int leftOffset, string closeTriggers, string onCloseCallback)
            {
                return string.Format(&quot;{0}.openModalWindow(&#39;{1}&#39;, &#39;{2}&#39;, {3}, {4}, {5}, {6}, {7}, &#39;{8}&#39;, &#39;{9}&#39;);&quot;,
                    new object[] { ClientMgrScript, url, name, showHeader.ToString().ToLower(), width, height, top, leftOffset, closeTriggers, onCloseCallback });
            }
		}

		private readonly Page _page;

		/// &lt;summary&gt;
		/// This removes all tree JSON data cached in the client browser.
		/// Useful when you want to ensure that the tree is reloaded from live data.
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ClientTools ClearClientTreeCache()
		{
			RegisterClientScript(Scripts.ClearTreeCache);
			return this;
		}

		/// &lt;summary&gt;
		/// Change applications
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ClientTools ShiftApp(string appAlias)
		{
			RegisterClientScript(Scripts.ShiftApp(appAlias));
			return this;
		}
		
		/// &lt;summary&gt;
		/// Refresh the entire administration console after a specified amount of time.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;seconds&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ClientTools RefreshAdmin(int seconds)
		{
			RegisterClientScript(string.Format(Scripts.RefreshAdmin, seconds * 1000));
			return this;
		}

        /// &lt;summary&gt;
        /// Refreshes the entire current tree
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public ClientTools RefreshTree()
        {
            RegisterClientScript(Scripts.RefreshTree);
            return this;
        }

        public ClientTools RefreshTree(string treeType)
        {
            RegisterClientScript(string.Format(Scripts.RefreshTreeType, treeType));
            return this;
        }
		
		/// &lt;summary&gt;
		/// A reference to the umbraco UI component &quot;speechbubble&quot;. The speechbubble appears in the lower right corner of the screen, notifying users of events
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;i&quot;&gt;The speechbubble icon.&lt;/param&gt;
		/// &lt;param name=&quot;header&quot;&gt;The speechbubble header.&lt;/param&gt;
		/// &lt;param name=&quot;body&quot;&gt;The body text&lt;/param&gt;
		public ClientTools ShowSpeechBubble(SpeechBubbleIcon i, string header, string body)
		{
			RegisterClientScript(string.Format(Scripts.ShowSpeechBubble, i.ToString(), header.Replace(&quot;&#39;&quot;, &quot;\\&#39;&quot;), body.Replace(&quot;&#39;&quot;, &quot;\\&#39;&quot;)));
			return this;
		}
		
		/// &lt;summary&gt;
		/// Changes the content in the content frame to the specified URL
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
		public ClientTools ChangeContentFrameUrl(string url)
		{
            //don&#39;t load if there is no url
			if (string.IsNullOrEmpty(url)) return this;

            url = EnsureUmbracoUrl(url);

            RegisterClientScript(Scripts.ChangeContentFrameUrl(url));
			
            return this;
		}

        /// &lt;summary&gt;
        /// Reloads the content in the content frame if the specified URL is currently loaded
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
        public ClientTools ReloadContentFrameUrlIfPathLoaded(string url)
        {
            if (string.IsNullOrEmpty(url)) return this;

            url = EnsureUmbracoUrl(url);

            RegisterClientScript(Scripts.ReloadContentFrameUrlIfPathLoaded(url));

            return this;
        }

        /// &lt;summary&gt;
        /// Reloads location, refreshing what is in the content frame
        /// &lt;/summary&gt;
        public ClientTools ReloadLocation()
        {
            RegisterClientScript(Scripts.ReloadLocation);

            return this;
        }

        private string EnsureUmbracoUrl(string url)
        {
            if (url.StartsWith(&quot;/&quot;) &amp;&amp; url.StartsWith(IOHelper.ResolveUrl(SystemDirectories.Umbraco)) == false)
            {
                url = IOHelper.ResolveUrl(SystemDirectories.Umbraco).EnsureEndsWith(&#39;/&#39;) + url;
            }

            if (url.Trim().StartsWith(&quot;~&quot;))
                url = IOHelper.ResolveUrl(url);

            return url;
        }

        /// &lt;summary&gt;
        /// Shows the dashboard for the given application
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;app&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public ClientTools ShowDashboard(string app)
		{
            return ChangeContentFrameUrl(SystemDirectories.Umbraco + string.Format(&quot;/dashboard.aspx?app={0}&quot;, app));
		}
		
		/// &lt;summary&gt;
		/// Reloads the children of the current action node and selects the node that didn&#39;t exist there before.
		/// If the client side system cannot determine which node is new, then no node is selected.		
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// This is used by many create dialogs, however the sync method should be used based on the full path of the
		/// node but because the current Umbraco implementation of ITask only returns a url to load, there&#39;s no way
		/// to determine what the full path of the new child is.
		/// &lt;/remarks&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ClientTools ChildNodeCreated()
		{
			RegisterClientScript(Scripts.ChildNodeCreated);
			return this;
		}		

		/// &lt;summary&gt;
		/// Synchronizes the tree to the path specified.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;forceReload&quot;&gt;
		/// If set to true, will ensure that the node to be synced has it&#39;s data 
		/// reloaded from the server. Otherwise, if the node already exists, the tree will simply sync to the node
		/// that is already there.
		/// &lt;/param&gt;
		/// &lt;remarks&gt;
		/// This will work for any tree, however you would need to know the path of the node. Currently, media and content
		/// are the only trees that store a path, however, if you were working in the template tree for example, a path to a
		/// node could be &quot;init,1090&quot; and this method would still work.
		/// 
		/// Sync tree will works by syncing the active tree type. This can be specified explicitly by calling SetActiveTreeType. 
		/// This will allow developers to sync many trees in one application at one time if needed.
		/// &lt;/remarks&gt;
		/// &lt;example&gt;
		/// &lt;![CDATA[
		/// //if you had both the media and content trees in the same app, you could sync both at the same
		/// //time by doing:
		/// BasePage.Current.ClientTools
		///		.SetActiveTreeType(&quot;content&quot;)
		///			.SyncTree(&quot;-1,100,200&quot;)
		///		.SetActiveTreeType(&quot;media&quot;)
		///			.SyncTree(&quot;-1,323,355&quot;);
		/// ]]&gt;
		/// &lt;/example&gt;
		public ClientTools SyncTree(string path, bool forceReload)
		{
			RegisterClientScript(string.Format(Scripts.SyncTree, path, forceReload.ToString().ToLower()));
			return this;
		}

		public ClientTools CopyNode(string currNodeId, string newParentPath)
		{
			RegisterClientScript(string.Format(Scripts.CopyNode, currNodeId, newParentPath));
			return this;
		}

		public ClientTools MoveNode(string currNodeId, string newParentPath)
		{
			RegisterClientScript(string.Format(Scripts.MoveNode, currNodeId, newParentPath));
			return this;
		}

		/// &lt;summary&gt;
		/// Reloads only the last node that the user interacted with via the context menu. To reload a specify node, use SyncTree.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;reselect&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;reloadChildren&quot;&gt;&lt;/param&gt;
		/// &lt;remarks&gt;
		/// If for whatever reason the client side system cannot just refresh the one node, the system will use jsTree&#39;s built in 
		/// refresh tool, this however won&#39;t allow for reselect or reloadChildren. Most trees will work with the single node
		/// refresh but 3rd party tools may have poorly built tree data models.
		/// &lt;/remarks&gt;
		public ClientTools ReloadActionNode(bool reselect, bool reloadChildren)
		{
			RegisterClientScript(string.Format(Scripts.ReloadActionNode, (!reselect).ToString().ToLower(), (!reloadChildren).ToString().ToLower()));
			return this;
		}
		
		/// &lt;summary&gt;
		/// When the application searches for a node, it searches for nodes in specific tree types.
		/// If SyncTree is used, it will sync the tree nodes with the active tree type, therefore if
		/// a developer wants to sync a specific tree, they can call this method to set the type to sync.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Each branch of a particular tree should theoretically be the same type, however, developers can
		/// override the type of each branch in their BaseTree&#39;s but this is not standard practice. If there
		/// are multiple types of branches in one tree, then only those branches that have the Active tree type
		/// will be searched for syncing.
		/// &lt;/remarks&gt;
		/// &lt;param name=&quot;treeType&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ClientTools SetActiveTreeType(string treeType)
		{
			RegisterClientScript(string.Format(Scripts.SetActiveTreeType, treeType));
			return this;
		}

		/// &lt;summary&gt;
        /// Closes the Umbraco dialog window if it is open
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;returnVal&quot;&gt;specify a value to return to add to the onCloseCallback method if one was specified in the OpenModalWindow method&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ClientTools CloseModalWindow(string returnVal)
		{
			RegisterClientScript(Scripts.CloseModalWindow(returnVal));
			return this;
		}
        /// &lt;summary&gt;
        /// Closes the umbraco dialog window if it is open
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public ClientTools CloseModalWindow()
        {
            return CloseModalWindow(&quot;&quot;);
        }


	    /// &lt;summary&gt;
	    /// Opens a modal window
	    /// &lt;/summary&gt;
	    /// &lt;param name=&quot;url&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;height&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;showHeader&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;width&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;top&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;leftOffset&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;closeTriggers&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;onCloseCallback&quot;&gt;&lt;/param&gt;
	    /// &lt;returns&gt;&lt;/returns&gt;
	    public ClientTools OpenModalWindow(string url, string name, bool showHeader, int width, int height, int top, int leftOffset, string closeTriggers, string onCloseCallback)
		{
			RegisterClientScript(Scripts.OpenModalWindow(url, name, showHeader, width, height, top, leftOffset, closeTriggers, onCloseCallback));
			return this;
		}

        /// &lt;summary&gt;
        /// This will use the ScriptManager to register the script if one is available, otherwise will default to the ClientScript
        /// class of the page.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;script&quot;&gt;&lt;/param&gt;
        private void RegisterClientScript(string script)
		{
			//use the hash code of the script to generate the key, this way, the exact same script won&#39;t be
			//inserted more than once.
            if (ScriptManager.GetCurrent(_page) != null)
            {
                ScriptManager.RegisterStartupScript(_page, _page.GetType(), script.GetHashCode().ToString(), script, true);
            }
            else
            {
                _page.ClientScript.RegisterStartupScript(_page.GetType(), script.GetHashCode().ToString(), script, true);
            }
		}




	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,3,21,32,0],[22,3,22,4,0],[23,4,23,17,0],[24,3,24,4,0],[34,45,34,46,0],[34,47,34,105,0],[34,106,34,107,0],[35,45,35,46,0],[35,47,35,105,0],[35,106,35,107,0],[36,43,36,44,0],[36,45,36,101,0],[36,102,36,103,0],[37,43,37,44,0],[37,45,37,105,0],[37,106,37,107,0],[39,4,39,5,0],[40,17,40,105,0],[41,4,41,5,0],[43,4,43,5,0],[44,5,44,73,0],[45,4,45,5,0],[46,44,46,45,0],[46,46,46,115,0],[46,116,46,117,0],[47,48,47,49,0],[47,50,47,125,0],[47,126,47,127,0],[48,59,48,60,0],[49,5,49,74,0],[50,4,50,5,0],[52,13,52,14,0],[53,17,53,107,0],[54,13,54,14,0],[55,55,55,56,0],[55,57,55,118,0],[55,119,55,120,0],[56,13,56,90,0],[57,40,57,41,0],[57,42,57,88,0],[57,89,57,90,0],[58,46,58,47,0],[58,48,58,90,0],[58,91,58,92,0],[59,40,59,41,0],[59,42,59,90,0],[59,91,59,92,0],[60,40,60,41,0],[60,42,60,90,0],[60,91,60,92,0],[61,48,61,49,0],[61,50,61,108,0],[61,109,61,110,0],[62,49,62,50,0],[62,51,62,101,0],[62,102,62,103,0],[63,52,63,53,0],[63,54,63,93,0],[63,94,63,95,0],[64,56,64,57,0],[64,58,64,102,0],[64,103,64,104,0],[66,13,66,14,0],[67,17,67,82,0],[68,13,68,14,0],[70,13,70,14,0],[71,17,71,93,0],[72,13,72,14,0],[74,13,74,14,0],[75,17,75,86,0],[76,13,76,14,0],[78,13,78,14,0],[79,17,80,163,0],[81,13,81,14,0],[92,3,92,4,0],[93,4,93,49,0],[94,4,94,16,0],[95,3,95,4,0],[102,3,102,4,0],[103,4,103,53,0],[104,4,104,16,0],[105,3,105,4,0],[113,3,113,4,0],[114,4,114,78,0],[115,4,115,16,0],[116,3,116,4,0],[123,9,123,10,0],[124,13,124,55,0],[125,13,125,25,0],[126,9,126,10,0],[129,9,129,10,0],[130,13,130,84,0],[131,13,131,25,0],[132,9,132,10,0],[141,3,141,4,0],[142,4,142,134,0],[143,4,143,16,0],[144,3,144,4,0],[151,3,151,4,0],[153,4,153,34,0],[153,35,153,47,0],[155,13,155,41,0],[157,13,157,70,0],[159,13,159,25,0],[160,3,160,4,0],[167,9,167,10,0],[168,13,168,43,0],[168,44,168,56,0],[170,13,170,41,0],[172,13,172,82,0],[174,13,174,25,0],[175,9,175,10,0],[181,9,181,10,0],[182,13,182,58,0],[184,13,184,25,0],[185,9,185,10,0],[188,9,188,10,0],[189,13,189,112,0],[190,13,190,14,0],[191,17,191,96,0],[192,13,192,14,0],[194,13,194,44,0],[195,17,195,48,0],[197,13,197,24,0],[198,9,198,10,0],[206,3,206,4,0],[207,13,207,117,0],[208,3,208,4,0],[221,3,221,4,0],[222,4,222,51,0],[223,4,223,16,0],[224,3,224,4,0],[255,3,255,4,0],[256,4,256,98,0],[257,4,257,16,0],[258,3,258,4,0],[261,3,261,4,0],[262,4,262,85,0],[263,4,263,16,0],[264,3,264,4,0],[267,3,267,4,0],[268,4,268,85,0],[269,4,269,16,0],[270,3,270,4,0],[283,3,283,4,0],[284,4,284,140,0],[285,4,285,16,0],[286,3,286,4,0],[302,3,302,4,0],[303,4,303,77,0],[304,4,304,16,0],[305,3,305,4,0],[313,3,313,4,0],[314,4,314,62,0],[315,4,315,16,0],[316,3,316,4,0],[322,9,322,10,0],[323,13,323,41,0],[324,9,324,10,0],[341,3,341,4,0],[342,4,342,137,0],[343,4,343,16,0],[344,3,344,4,0],[352,3,352,4,0],[355,13,355,57,0],[356,13,356,14,0],[357,17,357,124,0],[358,13,358,14,0],[360,13,360,14,0],[361,17,361,122,0],[362,13,362,14,0],[363,3,363,4,0]]);
    </script>
  </body>
</html>