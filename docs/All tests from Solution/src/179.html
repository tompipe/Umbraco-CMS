<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\DataTypeServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Services
{
    /// &lt;summary&gt;
    /// Tests covering the DataTypeService
    /// &lt;/summary&gt;
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, RequiresSTA]
    public class DataTypeServiceTests : BaseServiceTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        

        [Test]
        public void DataTypeService_Can_Persist_New_DataTypeDefinition()
        {
            // Arrange
            var dataTypeService = ServiceContext.DataTypeService;

            // Act
            var dataTypeDefinition = new DataTypeDefinition(-1, &quot;Test.TestEditor&quot;) { Name = &quot;Testing Textfield&quot;, DatabaseType = DataTypeDatabaseType.Ntext };
            dataTypeService.Save(dataTypeDefinition);

            // Assert
            Assert.That(dataTypeDefinition, Is.Not.Null);
            Assert.That(dataTypeDefinition.HasIdentity, Is.True);
        }

        [Test]
        public void DataTypeService_Can_Delete_Textfield_DataType_And_Clear_Usages()
        {
            // Arrange
            var dataTypeService = ServiceContext.DataTypeService;
            var textfieldId = &quot;Umbraco.Textbox&quot;;
            var dataTypeDefinitions = dataTypeService.GetDataTypeDefinitionByPropertyEditorAlias(textfieldId);
            
            // Act
            var definition = dataTypeDefinitions.First();
            var definitionId = definition.Id;
            dataTypeService.Delete(definition);

            var deletedDefinition = dataTypeService.GetDataTypeDefinitionById(definitionId);

            // Assert
            Assert.That(deletedDefinition, Is.Null);

            //Further assertions against the ContentType that contains PropertyTypes based on the TextField
            var contentType = ServiceContext.ContentTypeService.GetContentType(NodeDto.NodeIdSeed);
            Assert.That(contentType.Alias, Is.EqualTo(&quot;umbTextpage&quot;));
            Assert.That(contentType.PropertyTypes.Count(), Is.EqualTo(1));
        }

        [Test]
        public void DataTypeService_Can_Persist_Dictionary_Based_Pre_Values()
        {
            // Arrange
            var dataTypeService = ServiceContext.DataTypeService;
            var textfieldId = new Guid(&quot;ec15c1e5-9d90-422a-aa52-4f7622c63bea&quot;);

            // Act
            IDataTypeDefinition dataTypeDefinition = new DataTypeDefinition(-1, textfieldId) { Name = &quot;Testing prevals&quot;, DatabaseType = DataTypeDatabaseType.Ntext };
            dataTypeService.Save(dataTypeDefinition);
            dataTypeService.SavePreValues(dataTypeDefinition, new Dictionary&lt;string, PreValue&gt;
                {
                    {&quot;preVal1&quot;, new PreValue(&quot;Hello&quot;)},
                    {&quot;preVal2&quot;, new PreValue(&quot;World&quot;)}
                });
            //re-get
            dataTypeDefinition = dataTypeService.GetDataTypeDefinitionById(dataTypeDefinition.Id);
            var preVals = dataTypeService.GetPreValuesCollectionByDataTypeId(dataTypeDefinition.Id);

            // Assert
            Assert.That(dataTypeDefinition, Is.Not.Null);
            Assert.That(dataTypeDefinition.HasIdentity, Is.True);
            Assert.AreEqual(true, preVals.IsDictionaryBased);
            Assert.AreEqual(2, preVals.PreValuesAsDictionary.Keys.Count);
            Assert.AreEqual(&quot;preVal1&quot;, preVals.PreValuesAsDictionary.Keys.First());
            Assert.AreEqual(&quot;preVal2&quot;, preVals.PreValuesAsDictionary.Keys.Last());
            Assert.AreEqual(&quot;Hello&quot;, preVals.PreValuesAsDictionary[&quot;preVal1&quot;].Value);
            Assert.AreEqual(&quot;World&quot;, preVals.PreValuesAsDictionary[&quot;preVal2&quot;].Value);
        }

        [Test]
        public void DataTypeService_Can_Persist_Dtd_And_Dictionary_Based_Pre_Values()
        {
            // Arrange
            var dataTypeService = ServiceContext.DataTypeService;
            var textfieldId = new Guid(&quot;ec15c1e5-9d90-422a-aa52-4f7622c63bea&quot;);

            // Act
            IDataTypeDefinition dataTypeDefinition = new DataTypeDefinition(-1, textfieldId) { Name = &quot;Testing prevals&quot;, DatabaseType = DataTypeDatabaseType.Ntext };
            dataTypeService.SaveDataTypeAndPreValues(dataTypeDefinition, new Dictionary&lt;string, PreValue&gt;
                {
                    {&quot;preVal1&quot;, new PreValue(&quot;Hello&quot;)},
                    {&quot;preVal2&quot;, new PreValue(&quot;World&quot;)}
                });
            //re-get
            dataTypeDefinition = dataTypeService.GetDataTypeDefinitionById(dataTypeDefinition.Id);
            var preVals = dataTypeService.GetPreValuesCollectionByDataTypeId(dataTypeDefinition.Id);

            // Assert
            Assert.That(dataTypeDefinition, Is.Not.Null);
            Assert.That(dataTypeDefinition.HasIdentity, Is.True);
            Assert.AreEqual(true, preVals.IsDictionaryBased);
            Assert.AreEqual(2, preVals.PreValuesAsDictionary.Keys.Count);
            Assert.AreEqual(&quot;preVal1&quot;, preVals.PreValuesAsDictionary.Keys.First());
            Assert.AreEqual(&quot;preVal2&quot;, preVals.PreValuesAsDictionary.Keys.Last());
            Assert.AreEqual(&quot;Hello&quot;, preVals.PreValuesAsDictionary[&quot;preVal1&quot;].Value);
            Assert.AreEqual(&quot;World&quot;, preVals.PreValuesAsDictionary[&quot;preVal2&quot;].Value);
        }

        [Test]
        public void DataTypeService_Can_Update_Pre_Values()
        {
            // Arrange
            var dataTypeService = ServiceContext.DataTypeService;
            var textfieldId = new Guid(&quot;ec15c1e5-9d90-422a-aa52-4f7622c63bea&quot;);

            // Act
            IDataTypeDefinition dataTypeDefinition = new DataTypeDefinition(-1, textfieldId) { Name = &quot;Testing prevals&quot;, DatabaseType = DataTypeDatabaseType.Ntext };
            dataTypeService.SaveDataTypeAndPreValues(dataTypeDefinition, new Dictionary&lt;string, PreValue&gt;
                {
                    {&quot;preVal1&quot;, new PreValue(&quot;Hello&quot;)},
                    {&quot;preVal2&quot;, new PreValue(&quot;World&quot;)}
                });
            //re-get
            dataTypeDefinition = dataTypeService.GetDataTypeDefinitionById(dataTypeDefinition.Id);
            var preVals = dataTypeService.GetPreValuesCollectionByDataTypeId(dataTypeDefinition.Id);

            //update them (ensure Ids are there!)
            var asDictionary = preVals.FormatAsDictionary();
            asDictionary[&quot;preVal1&quot;].Value = &quot;Hello2&quot;;
            asDictionary[&quot;preVal2&quot;].Value = &quot;World2&quot;;

            dataTypeService.SavePreValues(dataTypeDefinition, asDictionary);

            var preValsAgain = dataTypeService.GetPreValuesCollectionByDataTypeId(dataTypeDefinition.Id);

            // Assert

            Assert.AreEqual(preVals.PreValuesAsDictionary.Values.First().Id, preValsAgain.PreValuesAsDictionary.Values.First().Id);
            Assert.AreEqual(preVals.PreValuesAsDictionary.Values.Last().Id, preValsAgain.PreValuesAsDictionary.Values.Last().Id);
            Assert.AreEqual(&quot;preVal1&quot;, preValsAgain.PreValuesAsDictionary.Keys.First());
            Assert.AreEqual(&quot;preVal2&quot;, preValsAgain.PreValuesAsDictionary.Keys.Last());
            Assert.AreEqual(&quot;Hello2&quot;, preValsAgain.PreValuesAsDictionary[&quot;preVal1&quot;].Value);
            Assert.AreEqual(&quot;World2&quot;, preValsAgain.PreValuesAsDictionary[&quot;preVal2&quot;].Value);
        }

        [Test]
        public void DataTypeService_Can_Remove_Pre_Value()
        {
            // Arrange
            var dataTypeService = ServiceContext.DataTypeService;
            var textfieldId = new Guid(&quot;ec15c1e5-9d90-422a-aa52-4f7622c63bea&quot;);

            // Act
            IDataTypeDefinition dataTypeDefinition = new DataTypeDefinition(-1, textfieldId) { Name = &quot;Testing prevals&quot;, DatabaseType = DataTypeDatabaseType.Ntext };
            dataTypeService.SaveDataTypeAndPreValues(dataTypeDefinition, new Dictionary&lt;string, PreValue&gt;
                {
                    {&quot;preVal1&quot;, new PreValue(&quot;Hello&quot;)},
                    {&quot;preVal2&quot;, new PreValue(&quot;World&quot;)}
                });
            //re-get
            dataTypeDefinition = dataTypeService.GetDataTypeDefinitionById(dataTypeDefinition.Id);
            var preVals = dataTypeService.GetPreValuesCollectionByDataTypeId(dataTypeDefinition.Id);

            //update them (ensure Ids are there!)
            var asDictionary = preVals.FormatAsDictionary();
            asDictionary.Remove(&quot;preVal2&quot;);

            dataTypeService.SavePreValues(dataTypeDefinition, asDictionary);

            var preValsAgain = dataTypeService.GetPreValuesCollectionByDataTypeId(dataTypeDefinition.Id);

            // Assert

            Assert.AreEqual(1, preValsAgain.FormatAsDictionary().Count);
            Assert.AreEqual(preVals.PreValuesAsDictionary.Values.First().Id, preValsAgain.PreValuesAsDictionary.Values.First().Id);            
            Assert.AreEqual(&quot;preVal1&quot;, preValsAgain.PreValuesAsDictionary.Keys.First());

        }

        [Test]
        public void DataTypeService_Can_Persist_Array_Based_Pre_Values()
        {
            // Arrange
            var dataTypeService = ServiceContext.DataTypeService;
            var textfieldId = new Guid(&quot;ec15c1e5-9d90-422a-aa52-4f7622c63bea&quot;);

            // Act
            IDataTypeDefinition dataTypeDefinition = new DataTypeDefinition(-1, textfieldId) { Name = &quot;Testing prevals&quot;, DatabaseType = DataTypeDatabaseType.Ntext };
            dataTypeService.Save(dataTypeDefinition);
            dataTypeService.SavePreValues(dataTypeDefinition.Id, new[] {&quot;preVal1&quot;, &quot;preVal2&quot;});
            
            //re-get            
            var preVals = dataTypeService.GetPreValuesCollectionByDataTypeId(dataTypeDefinition.Id);

            // Assert
            Assert.That(dataTypeDefinition, Is.Not.Null);
            Assert.That(dataTypeDefinition.HasIdentity, Is.True);
            Assert.AreEqual(false, preVals.IsDictionaryBased);
            Assert.AreEqual(2, preVals.PreValuesAsArray.Count());
            Assert.AreEqual(&quot;preVal1&quot;, preVals.PreValuesAsArray.First().Value);
            Assert.AreEqual(&quot;preVal2&quot;, preVals.PreValuesAsArray.Last().Value);            
        }

        [Test]
        public void Cannot_Save_DataType_With_Empty_Name()
        {
            // Arrange
            var dataTypeService = ServiceContext.DataTypeService;

            // Act
            var dataTypeDefinition = new DataTypeDefinition(-1, &quot;Test.TestEditor&quot;) { Name = string.Empty, DatabaseType = DataTypeDatabaseType.Ntext };

            // Act &amp; Assert
            Assert.Throws&lt;ArgumentException&gt;(() =&gt; dataTypeService.Save(dataTypeDefinition));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,31,1],[22,9,22,10,1],[26,9,26,10,1],[27,13,27,29,1],[28,9,28,10,1],[34,9,34,10,1],[36,13,36,66,1],[39,13,39,158,1],[40,13,40,54,1],[43,13,43,58,1],[44,13,44,66,1],[45,9,45,10,1],[49,9,49,10,1],[51,13,51,66,1],[52,13,52,49,1],[53,13,53,111,1],[56,13,56,58,1],[57,13,57,46,1],[58,13,58,48,1],[60,13,60,93,1],[63,13,63,53,1],[66,13,66,100,1],[67,13,67,71,1],[68,13,68,75,1],[69,9,69,10,1],[73,9,73,10,1],[75,13,75,66,1],[76,13,76,80,1],[79,13,79,166,1],[80,13,80,54,1],[81,13,85,20,1],[87,13,87,99,1],[88,13,88,101,1],[91,13,91,58,1],[92,13,92,66,1],[93,13,93,62,1],[94,13,94,74,1],[95,13,95,84,1],[96,13,96,83,1],[97,13,97,86,1],[98,13,98,86,1],[99,9,99,10,1],[103,9,103,10,1],[105,13,105,66,1],[106,13,106,80,1],[109,13,109,166,1],[110,13,114,20,1],[116,13,116,99,1],[117,13,117,101,1],[120,13,120,58,1],[121,13,121,66,1],[122,13,122,62,1],[123,13,123,74,1],[124,13,124,84,1],[125,13,125,83,1],[126,13,126,86,1],[127,13,127,86,1],[128,9,128,10,1],[132,9,132,10,1],[134,13,134,66,1],[135,13,135,80,1],[138,13,138,166,1],[139,13,143,20,1],[145,13,145,99,1],[146,13,146,101,1],[149,13,149,61,1],[150,13,150,54,1],[151,13,151,54,1],[153,13,153,77,1],[155,13,155,106,1],[159,13,159,132,1],[160,13,160,130,1],[161,13,161,89,1],[162,13,162,88,1],[163,13,163,92,1],[164,13,164,92,1],[165,9,165,10,1],[169,9,169,10,1],[171,13,171,66,1],[172,13,172,80,1],[175,13,175,166,1],[176,13,180,20,1],[182,13,182,99,1],[183,13,183,101,1],[186,13,186,61,1],[187,13,187,44,1],[189,13,189,77,1],[191,13,191,106,1],[195,13,195,73,1],[196,13,196,132,1],[197,13,197,89,1],[199,9,199,10,1],[203,9,203,10,1],[205,13,205,66,1],[206,13,206,80,1],[209,13,209,166,1],[210,13,210,54,1],[211,13,211,96,1],[214,13,214,101,1],[217,13,217,58,1],[218,13,218,66,1],[219,13,219,63,1],[220,13,220,66,1],[221,13,221,80,1],[222,13,222,79,1],[223,9,223,10,1],[227,9,227,10,1],[229,13,229,66,1],[232,13,232,151,1],[235,13,235,52,1],[235,52,235,92,1],[235,92,235,94,1],[235,13,235,94,1],[236,9,236,10,1]]);
    </script>
  </body>
</html>