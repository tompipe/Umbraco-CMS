<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Models\UmbracoEntityTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Serialization;

namespace Umbraco.Tests.Models
{
    [TestFixture]
    public class UmbracoEntityTests
    {
        [Test]
        public void Validate_Path()
        {
            var entity = new UmbracoEntity();

            //it&#39;s empty with no id so we need to allow it
            Assert.IsTrue(entity.ValidatePath());

            entity.Id = 1234;

            //it has an id but no path, so we can&#39;t allow it
            Assert.IsFalse(entity.ValidatePath());

            entity.Path = &quot;-1&quot;;

            //invalid path
            Assert.IsFalse(entity.ValidatePath());
            
            entity.Path = string.Concat(&quot;-1,&quot;, entity.Id);

            //valid path
            Assert.IsTrue(entity.ValidatePath());
        }

        [Test]
        public void Ensure_Path_Throws_Without_Id()
        {
            var entity = new UmbracoEntity();

            //no id assigned
            Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; entity.EnsureValidPath(Mock.Of&lt;ILogger&gt;(), umbracoEntity =&gt; new UmbracoEntity(), umbracoEntity =&gt; { }));
        }

        [Test]
        public void Ensure_Path_Throws_Without_Parent()
        {
            var entity = new UmbracoEntity {Id = 1234};

            //no parent found
            Assert.Throws&lt;NullReferenceException&gt;(() =&gt; entity.EnsureValidPath(Mock.Of&lt;ILogger&gt;(), umbracoEntity =&gt; null, umbracoEntity =&gt; { }));            
        }

        [Test]
        public void Ensure_Path_Entity_At_Root()
        {
            var entity = new UmbracoEntity
            {
                Id = 1234,
                ParentId = -1
            };


            entity.EnsureValidPath(Mock.Of&lt;ILogger&gt;(), umbracoEntity =&gt; null, umbracoEntity =&gt; { });

            //works because it&#39;s under the root
            Assert.AreEqual(&quot;-1,1234&quot;, entity.Path);
        }

        [Test]
        public void Ensure_Path_Entity_Valid_Parent()
        {
            var entity = new UmbracoEntity
            {
                Id = 1234,
                ParentId = 888
            };

            entity.EnsureValidPath(Mock.Of&lt;ILogger&gt;(), umbracoEntity =&gt; umbracoEntity.ParentId == 888 ? new UmbracoEntity{Id = 888, Path = &quot;-1,888&quot;} : null, umbracoEntity =&gt; { });

            //works because the parent was found
            Assert.AreEqual(&quot;-1,888,1234&quot;, entity.Path);
        }

        [Test]
        public void Ensure_Path_Entity_Valid_Recursive_Parent()
        {
            var parentA = new UmbracoEntity
            {
                Id = 999,
                ParentId = -1
            };

            var parentB = new UmbracoEntity
            {
                Id = 888,
                ParentId = 999
            };

            var parentC = new UmbracoEntity
            {
                Id = 777,
                ParentId = 888
            };

            var entity = new UmbracoEntity
            {
                Id = 1234,
                ParentId = 777
            };

            Func&lt;IUmbracoEntity, IUmbracoEntity&gt; getParent = umbracoEntity =&gt;
            {
                switch (umbracoEntity.ParentId)
                {
                    case 999:
                        return parentA;
                    case 888:
                        return parentB;
                    case 777:
                        return parentC;
                    case 1234:
                        return entity;
                    default:
                        return null;
                }
            };
            
            //this will recursively fix all paths
            entity.EnsureValidPath(Mock.Of&lt;ILogger&gt;(), getParent, umbracoEntity =&gt; { });
            
            Assert.AreEqual(&quot;-1,999&quot;, parentA.Path);
            Assert.AreEqual(&quot;-1,999,888&quot;, parentB.Path);
            Assert.AreEqual(&quot;-1,999,888,777&quot;, parentC.Path);
            Assert.AreEqual(&quot;-1,999,888,777,1234&quot;, entity.Path);            
        }

        [Test]
        public void UmbracoEntity_Can_Be_Initialized_From_Dynamic()
        {
            var boolIsTrue = true;
            ulong ulongIsTrue = 1; // because MySql might return ulong

            var trashedWithBool = new UmbracoEntity((dynamic)boolIsTrue);
            var trashedWithInt = new UmbracoEntity((dynamic)ulongIsTrue);

            Assert.IsTrue(trashedWithBool.Trashed);
            Assert.IsTrue(trashedWithInt.Trashed);
        }

        [Test]
        public void Can_Deep_Clone()
        {
            var item = new UmbracoEntity()
            {
                Id = 3,
                ContentTypeAlias = &quot;test1&quot;,
                CreatorId = 4,
                Key = Guid.NewGuid(),
                UpdateDate = DateTime.Now,
                CreateDate = DateTime.Now,
                Name = &quot;Test&quot;,
                ParentId = 5,
                SortOrder = 6,
                Path = &quot;-1,23&quot;,
                Level = 7,
                ContentTypeIcon = &quot;icon&quot;,
                ContentTypeThumbnail = &quot;thumb&quot;,
                HasChildren = true,
                HasPendingChanges = true,
                IsDraft = true,
                IsPublished = true,
                NodeObjectTypeId = Guid.NewGuid()            
            };
            item.AdditionalData.Add(&quot;test1&quot;, 3);
            item.AdditionalData.Add(&quot;test2&quot;, &quot;valuie&quot;);

            item.AdditionalData.Add(&quot;test3&quot;, new UmbracoEntity.EntityProperty()
            {
                Value = &quot;test&quot;,
                PropertyEditorAlias = &quot;TestPropertyEditor&quot;
            });
            item.AdditionalData.Add(&quot;test4&quot;, new UmbracoEntity.EntityProperty()
            {
                Value = &quot;test2&quot;,
                PropertyEditorAlias = &quot;TestPropertyEditor2&quot;
            });

            var clone = (UmbracoEntity)item.DeepClone();

            Assert.AreNotSame(clone, item);
            Assert.AreEqual(clone, item);
            Assert.AreEqual(clone.CreateDate, item.CreateDate);
            Assert.AreEqual(clone.ContentTypeAlias, item.ContentTypeAlias);
            Assert.AreEqual(clone.CreatorId, item.CreatorId);
            Assert.AreEqual(clone.Id, item.Id);
            Assert.AreEqual(clone.Key, item.Key);
            Assert.AreEqual(clone.Level, item.Level);            
            Assert.AreEqual(clone.Name, item.Name);
            Assert.AreEqual(clone.ParentId, item.ParentId);
            Assert.AreEqual(clone.SortOrder, item.SortOrder);
            Assert.AreEqual(clone.Path, item.Path);
            Assert.AreEqual(clone.ContentTypeIcon, item.ContentTypeIcon);
            Assert.AreEqual(clone.ContentTypeThumbnail, item.ContentTypeThumbnail);
            Assert.AreEqual(clone.HasChildren, item.HasChildren);
            Assert.AreEqual(clone.HasPendingChanges, item.HasPendingChanges);
            Assert.AreEqual(clone.IsDraft, item.IsDraft);
            Assert.AreEqual(clone.IsPublished, item.IsPublished);
            Assert.AreEqual(clone.NodeObjectTypeId, item.NodeObjectTypeId);
            Assert.AreEqual(clone.UpdateDate, item.UpdateDate);
            Assert.AreEqual(clone.AdditionalData.Count, item.AdditionalData.Count);
            Assert.AreEqual(clone.AdditionalData, item.AdditionalData);
            
            //This double verifies by reflection
            var allProps = clone.GetType().GetProperties();
            foreach (var propertyInfo in allProps)
            {
                Assert.AreEqual(propertyInfo.GetValue(clone, null), propertyInfo.GetValue(item, null));
            }
        }

        [Test]
        public void Can_Serialize_Without_Error()
        {
            var ss = new SerializationService(new JsonNetSerializer());

            var item = new UmbracoEntity()
            {
                Id = 3,
                ContentTypeAlias = &quot;test1&quot;,
                CreatorId = 4,
                Key = Guid.NewGuid(),
                UpdateDate = DateTime.Now,
                CreateDate = DateTime.Now,
                Name = &quot;Test&quot;,
                ParentId = 5,
                SortOrder = 6,
                Path = &quot;-1,23&quot;,
                Level = 7,
                ContentTypeIcon = &quot;icon&quot;,
                ContentTypeThumbnail = &quot;thumb&quot;,
                HasChildren = true,
                HasPendingChanges = true,
                IsDraft = true,
                IsPublished = true,
                NodeObjectTypeId = Guid.NewGuid()
            };
            item.AdditionalData.Add(&quot;test1&quot;, 3);
            item.AdditionalData.Add(&quot;test2&quot;, &quot;valuie&quot;);
            item.AdditionalData.Add(&quot;test3&quot;, new UmbracoEntity.EntityProperty()
            {
                Value = &quot;test&quot;,
                PropertyEditorAlias = &quot;TestPropertyEditor&quot;
            });
            item.AdditionalData.Add(&quot;test4&quot;, new UmbracoEntity.EntityProperty()
            {
                Value = &quot;test2&quot;,
                PropertyEditorAlias = &quot;TestPropertyEditor2&quot;
            });

            var result = ss.ToStream(item);
            var json = result.ResultStream.ToJsonString();
            Debug.Print(json);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,10,1],[18,13,18,46,1],[21,13,21,50,1],[23,13,23,30,1],[26,13,26,51,1],[28,13,28,32,1],[31,13,31,51,1],[33,13,33,59,1],[36,13,36,50,1],[37,9,37,10,1],[41,9,41,10,1],[42,13,42,46,1],[45,13,45,60,1],[45,60,45,120,1],[45,120,45,139,0],[45,139,45,158,1],[45,158,45,159,0],[45,159,45,160,1],[45,160,45,161,0],[45,161,45,162,1],[45,60,45,162,1],[45,162,45,164,1],[45,13,45,164,1],[46,9,46,10,1],[50,9,50,10,1],[51,13,51,56,1],[54,13,54,57,1],[54,57,54,117,1],[54,117,54,121,1],[54,121,54,140,1],[54,140,54,141,0],[54,141,54,142,1],[54,142,54,143,0],[54,143,54,144,1],[54,57,54,144,1],[54,144,54,146,1],[54,13,54,146,1],[55,9,55,10,1],[59,9,59,10,1],[60,13,64,15,1],[67,13,67,73,1],[67,73,67,77,0],[67,77,67,96,1],[67,96,67,97,1],[67,97,67,98,1],[67,98,67,99,1],[67,99,67,101,1],[67,13,67,101,1],[70,13,70,53,1],[71,9,71,10,1],[75,9,75,10,1],[76,13,80,15,1],[82,13,82,73,1],[82,73,82,156,1],[82,156,82,175,1],[82,175,82,176,1],[82,176,82,177,1],[82,177,82,178,1],[82,178,82,180,1],[82,13,82,180,1],[85,13,85,57,1],[86,9,86,10,1],[90,9,90,10,1],[91,13,95,15,1],[97,13,101,15,1],[103,13,107,15,1],[109,13,113,15,1],[115,13,116,13,1],[116,13,116,14,1],[116,14,117,17,1],[117,17,117,48,1],[117,48,120,25,1],[120,25,120,40,1],[120,40,122,25,1],[122,25,122,40,1],[122,40,124,25,1],[124,25,124,40,1],[124,40,126,25,1],[126,25,126,39,0],[126,39,128,25,1],[128,25,128,37,0],[128,37,130,13,1],[130,13,130,14,1],[130,14,130,15,1],[115,13,130,15,1],[133,13,133,84,1],[133,84,133,85,1],[133,85,133,86,1],[133,86,133,87,1],[133,87,133,89,1],[133,13,133,89,1],[135,13,135,53,1],[136,13,136,57,1],[137,13,137,61,1],[138,13,138,65,1],[139,9,139,10,1],[143,9,143,10,1],[144,13,144,35,1],[145,13,145,35,1],[147,13,147,74,1],[148,13,148,74,1],[150,13,150,52,1],[151,13,151,51,1],[152,9,152,10,1],[156,9,156,10,1],[157,13,177,15,1],[178,13,178,49,1],[179,13,179,56,1],[181,13,185,16,1],[186,13,190,16,1],[192,13,192,57,1],[194,13,194,44,1],[195,13,195,42,1],[196,13,196,64,1],[197,13,197,76,1],[198,13,198,62,1],[199,13,199,48,1],[200,13,200,50,1],[201,13,201,54,1],[202,13,202,52,1],[203,13,203,60,1],[204,13,204,62,1],[205,13,205,52,1],[206,13,206,74,1],[207,13,207,84,1],[208,13,208,66,1],[209,13,209,78,1],[210,13,210,58,1],[211,13,211,66,1],[212,13,212,76,1],[213,13,213,64,1],[214,13,214,84,1],[215,13,215,72,1],[218,13,218,60,1],[219,13,219,20,1],[219,22,219,38,1],[219,39,219,41,1],[219,42,219,50,1],[220,13,220,14,1],[221,17,221,104,1],[222,13,222,14,1],[223,9,223,10,1],[227,9,227,10,1],[228,13,228,72,1],[230,13,250,15,1],[251,13,251,49,1],[252,13,252,56,1],[253,13,257,16,1],[258,13,262,16,1],[264,13,264,44,1],[265,13,265,59,1],[266,13,266,31,1],[267,9,267,10,1]]);
    </script>
  </body>
</html>