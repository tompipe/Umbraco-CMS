<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Media\ImageUrlProviders\ImageUrlProvider.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Xml.XPath;
using Umbraco.Core.Configuration;
using Umbraco.Core.Media;
using umbraco;
using Umbraco.Core;

namespace Umbraco.Web.Media.ImageUrlProviders
{
    public class ImageUrlProvider : IImageUrlProvider
    {
        public const string DefaultName = &quot;umbracoUpload&quot;;

        public string Name
        {
            get { return DefaultName; }
        }

        public string GetImageUrlFromMedia(int mediaId, IDictionary&lt;string, string&gt; parameters)
        {
            var url = string.Empty;

            var nodeIterator = library.GetMedia(mediaId, false);

            if (nodeIterator.Current != null)
            {
                var filename = GetProperty(nodeIterator, Constants.Conventions.Media.File);
                var withThumb = AddThumbInfo(filename, parameters);
                url = AddCropInfo(withThumb, parameters);
            }

            return url;
        }

        public string GetImageUrlFromFileName(string specifiedSrc, IDictionary&lt;string, string&gt; parameters)
        {
            var withThumb = AddThumbInfo(specifiedSrc, parameters);
            return AddCropInfo(withThumb, parameters);
        }

        private static string AddThumbInfo(string filename, IDictionary&lt;string, string&gt; parameters)
        {
            var thumb = string.Empty;
            if (parameters.ContainsKey(&quot;thumb&quot;))
                thumb = parameters[&quot;thumb&quot;];

            if (!string.IsNullOrEmpty(thumb) &amp;&amp; filename.Contains(&quot;.&quot;))
            {
                var lastIndexOf = filename.LastIndexOf(&#39;.&#39;);
                var name = filename.Substring(0, lastIndexOf);
                var extension = filename.Substring(lastIndexOf, filename.Length - lastIndexOf);
                return string.Format(&quot;{0}_thumb_{1}{2}&quot;, name, thumb, extension);
            }
            return filename;
        }

        private static string AddCropInfo(string filename, IDictionary&lt;string, string&gt; parameters)
        {
            var crop = string.Empty;
            if (parameters.ContainsKey(&quot;crop&quot;))
                crop = parameters[&quot;crop&quot;];

            if (!string.IsNullOrEmpty(crop) &amp;&amp; filename.Contains(&quot;.&quot;))
            {
                var lastIndexOf = filename.LastIndexOf(&#39;.&#39;);
                var name = filename.Substring(0, lastIndexOf);
                
                //var extension = filename.Substring(lastIndexOf, filename.Length - lastIndexOf);
                //Built in cropper currently always uses jpg as an extension

                const string extension = &quot;.jpg&quot;;
                return string.Format(&quot;{0}_{1}{2}&quot;, name, crop, extension);
            }

            return filename;
        }


        private static string GetProperty(XPathNodeIterator nodeIterator, string fileProp)
        {
            var xpath = UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema
                               ? string.Format(&quot;.//data[@alias = &#39;{0}&#39;]&quot;, fileProp)
                               : string.Format(&quot;.//{0}&quot;, fileProp);

            var file = string.Empty;
            var selectSingleNode = nodeIterator.Current.SelectSingleNode(xpath);
            if (selectSingleNode != null)
                file = selectSingleNode.InnerXml;

            return file;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,17,16,18,0],[16,19,16,38,0],[16,39,16,40,0],[20,9,20,10,0],[21,13,21,36,0],[23,13,23,65,0],[25,13,25,46,0],[26,13,26,14,0],[27,17,27,92,0],[28,17,28,68,0],[29,17,29,58,0],[30,13,30,14,0],[32,13,32,24,0],[33,9,33,10,0],[36,9,36,10,0],[37,13,37,68,0],[38,13,38,55,0],[39,9,39,10,0],[42,9,42,10,0],[43,13,43,38,0],[44,13,44,49,0],[45,17,45,45,0],[47,13,47,72,0],[48,13,48,14,0],[49,17,49,61,0],[50,17,50,63,0],[51,17,51,96,0],[52,17,52,82,0],[54,13,54,29,0],[55,9,55,10,0],[58,9,58,10,0],[59,13,59,37,0],[60,13,60,48,0],[61,17,61,43,0],[63,13,63,71,0],[64,13,64,14,0],[65,17,65,61,0],[66,17,66,63,0],[72,17,72,75,0],[75,13,75,29,0],[76,9,76,10,0],[80,9,80,10,0],[81,13,83,68,0],[85,13,85,37,0],[86,13,86,81,0],[87,13,87,42,0],[88,17,88,50,0],[90,13,90,25,0],[91,9,91,10,0]]);
    </script>
  </body>
</html>