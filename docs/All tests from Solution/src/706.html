<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\ImageCropperTemplateExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using Newtonsoft.Json.Linq;
using System.Globalization;
using System.Text;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Web.Models;

namespace Umbraco.Web
{
    /// &lt;summary&gt;
    /// Provides extension methods for getting ImageProcessor Url from the core Image Cropper property editor
    /// &lt;/summary&gt;
    public static class ImageCropperTemplateExtensions
    {
        /// &lt;summary&gt;
        /// Gets the ImageProcessor Url by the crop alias (from the &quot;umbracoFile&quot; property alias) on the IPublishedContent item
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaItem&quot;&gt;
        /// The IPublishedContent item.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;cropAlias&quot;&gt;
        /// The crop alias e.g. thumbnail
        /// &lt;/param&gt;
        /// &lt;returns&gt;
        /// The ImageProcessor.Web Url.
        /// &lt;/returns&gt;
        public static string GetCropUrl(this IPublishedContent mediaItem, string cropAlias)
        {
            return mediaItem.GetCropUrl(cropAlias: cropAlias, useCropDimensions: true);
        }

        /// &lt;summary&gt;
        /// Gets the ImageProcessor Url by the crop alias using the specified property containing the image cropper Json data on the IPublishedContent item.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaItem&quot;&gt;
        /// The IPublishedContent item.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;propertyAlias&quot;&gt;
        /// The property alias of the property containing the Json data e.g. umbracoFile
        /// &lt;/param&gt;
        /// &lt;param name=&quot;cropAlias&quot;&gt;
        /// The crop alias e.g. thumbnail
        /// &lt;/param&gt;
        /// &lt;returns&gt;
        /// The ImageProcessor.Web Url.
        /// &lt;/returns&gt;
        public static string GetCropUrl(this IPublishedContent mediaItem, string propertyAlias, string cropAlias)
        {
            return mediaItem.GetCropUrl(propertyAlias: propertyAlias, cropAlias: cropAlias, useCropDimensions: true);
        }

        /// &lt;summary&gt;
        /// Gets the ImageProcessor Url from the IPublishedContent item.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mediaItem&quot;&gt;
        /// The IPublishedContent item.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;width&quot;&gt;
        /// The width of the output image.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;height&quot;&gt;
        /// The height of the output image.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;propertyAlias&quot;&gt;
        /// Property alias of the property containing the Json data.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;cropAlias&quot;&gt;
        /// The crop alias.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;quality&quot;&gt;
        /// Quality percentage of the output image.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;imageCropMode&quot;&gt;
        /// The image crop mode.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;imageCropAnchor&quot;&gt;
        /// The image crop anchor.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;preferFocalPoint&quot;&gt;
        /// Use focal point, to generate an output image using the focal point instead of the predefined crop
        /// &lt;/param&gt;
        /// &lt;param name=&quot;useCropDimensions&quot;&gt;
        /// Use crop dimensions to have the output image sized according to the predefined crop sizes, this will override the width and height parameters.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;cacheBuster&quot;&gt;
        /// Add a serialised date of the last edit of the item to ensure client cache refresh when updated
        /// &lt;/param&gt;
        /// &lt;param name=&quot;furtherOptions&quot;&gt;
        /// The further options.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;ratioMode&quot;&gt;
        /// Use a dimension as a ratio
        /// &lt;/param&gt;  
        /// &lt;param name=&quot;upScale&quot;&gt;
        /// If the image should be upscaled to requested dimensions
        /// &lt;/param&gt;         
        /// &lt;returns&gt;
        /// The &lt;see cref=&quot;string&quot;/&gt;.
        /// &lt;/returns&gt;
        public static string GetCropUrl(
             this IPublishedContent mediaItem,
             int? width = null,
             int? height = null,
             string propertyAlias = Constants.Conventions.Media.File,
             string cropAlias = null,
             int? quality = null,
             ImageCropMode? imageCropMode = null,
             ImageCropAnchor? imageCropAnchor = null,
             bool preferFocalPoint = false,
             bool useCropDimensions = false,
             bool cacheBuster = true, 
             string furtherOptions = null,
             ImageCropRatioMode? ratioMode = null,
             bool upScale = true)
        {
            if (mediaItem == null) throw new ArgumentNullException(&quot;mediaItem&quot;);

            var cacheBusterValue = cacheBuster ? mediaItem.UpdateDate.ToFileTimeUtc().ToString(CultureInfo.InvariantCulture) : null;

            if (mediaItem.HasProperty(propertyAlias) == false || mediaItem.HasValue(propertyAlias) == false)
                return string.Empty;
            
            //get the default obj from the value converter
            var cropperValue = mediaItem.GetPropertyValue(propertyAlias);

            //is it strongly typed?
            var stronglyTyped = cropperValue as ImageCropDataSet;
            string mediaItemUrl;
            if (stronglyTyped != null)
            {
                mediaItemUrl = stronglyTyped.Src;
                return GetCropUrl(
                    mediaItemUrl, stronglyTyped, width, height, cropAlias, quality, imageCropMode, imageCropAnchor, preferFocalPoint, useCropDimensions,
                    cacheBusterValue, furtherOptions, ratioMode, upScale);
            }

            //this shouldn&#39;t be the case but we&#39;ll check
            var jobj = cropperValue as JObject;
            if (jobj != null)
            {
                stronglyTyped = jobj.ToObject&lt;ImageCropDataSet&gt;();
                mediaItemUrl = stronglyTyped.Src;
                return GetCropUrl(
                    mediaItemUrl, stronglyTyped, width, height, cropAlias, quality, imageCropMode, imageCropAnchor, preferFocalPoint, useCropDimensions,
                    cacheBusterValue, furtherOptions, ratioMode, upScale);
            }

            //it&#39;s a single string
            mediaItemUrl = cropperValue.ToString();
            return GetCropUrl(
                mediaItemUrl, width, height, mediaItemUrl, cropAlias, quality, imageCropMode, imageCropAnchor, preferFocalPoint, useCropDimensions,
                cacheBusterValue, furtherOptions, ratioMode, upScale);
        }

        /// &lt;summary&gt;
        /// Gets the ImageProcessor Url from the image path.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;imageUrl&quot;&gt;
        /// The image url.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;width&quot;&gt;
        /// The width of the output image.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;height&quot;&gt;
        /// The height of the output image.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;imageCropperValue&quot;&gt;
        /// The Json data from the Umbraco Core Image Cropper property editor
        /// &lt;/param&gt;
        /// &lt;param name=&quot;cropAlias&quot;&gt;
        /// The crop alias.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;quality&quot;&gt;
        /// Quality percentage of the output image.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;imageCropMode&quot;&gt;
        /// The image crop mode.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;imageCropAnchor&quot;&gt;
        /// The image crop anchor.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;preferFocalPoint&quot;&gt;
        /// Use focal point to generate an output image using the focal point instead of the predefined crop if there is one
        /// &lt;/param&gt;
        /// &lt;param name=&quot;useCropDimensions&quot;&gt;
        /// Use crop dimensions to have the output image sized according to the predefined crop sizes, this will override the width and height parameters
        /// &lt;/param&gt;
        /// &lt;param name=&quot;cacheBusterValue&quot;&gt;
        /// Add a serialised date of the last edit of the item to ensure client cache refresh when updated
        /// &lt;/param&gt;
        /// &lt;param name=&quot;furtherOptions&quot;&gt;
        /// The further options.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;ratioMode&quot;&gt;
        /// Use a dimension as a ratio
        /// &lt;/param&gt;
        /// &lt;param name=&quot;upScale&quot;&gt;
        /// If the image should be upscaled to requested dimensions
        /// &lt;/param&gt;
        /// &lt;returns&gt;
        /// The &lt;see cref=&quot;string&quot;/&gt;.
        /// &lt;/returns&gt;
        public static string GetCropUrl(
            this string imageUrl,
            int? width = null,
            int? height = null,
            string imageCropperValue = null,
            string cropAlias = null,
            int? quality = null,
            ImageCropMode? imageCropMode = null,
            ImageCropAnchor? imageCropAnchor = null,
            bool preferFocalPoint = false,
            bool useCropDimensions = false,
            string cacheBusterValue = null, 
            string furtherOptions = null,
            ImageCropRatioMode? ratioMode = null,
            bool upScale = true)
        {
            if (string.IsNullOrEmpty(imageUrl)) return string.Empty;

            ImageCropDataSet cropDataSet = null;
            if (string.IsNullOrEmpty(imageCropperValue) == false &amp;&amp; imageCropperValue.DetectIsJson() &amp;&amp; (imageCropMode == ImageCropMode.Crop || imageCropMode == null))
            {
                cropDataSet = imageCropperValue.SerializeToCropDataSet();                    
            }
            return GetCropUrl(
                imageUrl, cropDataSet, width, height, cropAlias, quality, imageCropMode,
                imageCropAnchor, preferFocalPoint, useCropDimensions, cacheBusterValue, furtherOptions, ratioMode, upScale);
        }

        public static string GetCropUrl(
            this string imageUrl,
            ImageCropDataSet cropDataSet,
            int? width = null,
            int? height = null,
            string cropAlias = null,
            int? quality = null,
            ImageCropMode? imageCropMode = null,
            ImageCropAnchor? imageCropAnchor = null,
            bool preferFocalPoint = false,
            bool useCropDimensions = false,
            string cacheBusterValue = null,
            string furtherOptions = null,
            ImageCropRatioMode? ratioMode = null,
            bool upScale = true)
        {
            if (string.IsNullOrEmpty(imageUrl) == false)
            {
                var imageProcessorUrl = new StringBuilder();

                if (cropDataSet != null  &amp;&amp; (imageCropMode == ImageCropMode.Crop || imageCropMode == null))
                {
                    var crop = cropDataSet.GetCrop(cropAlias);

                    imageProcessorUrl.Append(cropDataSet.Src);

                    var cropBaseUrl = cropDataSet.GetCropBaseUrl(cropAlias, preferFocalPoint);
                    if (cropBaseUrl != null)
                    {
                        imageProcessorUrl.Append(cropBaseUrl);
                    }
                    else
                    {
                        return null;
                    }

                    if (crop != null &amp; useCropDimensions)
                    {
                        width = crop.Width;
                        height = crop.Height;
                    }

                    // If a predefined crop has been specified &amp; there are no coordinates &amp; no ratio mode, but a width parameter has been passed we can get the crop ratio for the height
                    if (crop != null &amp;&amp; string.IsNullOrEmpty(cropAlias) == false &amp;&amp; crop.Coordinates == null &amp;&amp; ratioMode == null &amp;&amp; width != null &amp;&amp; height == null)
                    {
                        var heightRatio = (decimal)crop.Height / (decimal)crop.Width;
                        imageProcessorUrl.Append(&quot;&amp;heightratio=&quot; + heightRatio.ToString(CultureInfo.InvariantCulture));
                    }

                    // If a predefined crop has been specified &amp; there are no coordinates &amp; no ratio mode, but a height parameter has been passed we can get the crop ratio for the width
                    if (crop != null &amp;&amp; string.IsNullOrEmpty(cropAlias) == false &amp;&amp; crop.Coordinates == null &amp;&amp; ratioMode == null &amp;&amp; width == null &amp;&amp; height != null)
                    {
                        var widthRatio = (decimal)crop.Width / (decimal)crop.Height;
                        imageProcessorUrl.Append(&quot;&amp;widthratio=&quot; + widthRatio.ToString(CultureInfo.InvariantCulture));
                    }
                }
                else
                {
                    imageProcessorUrl.Append(imageUrl);

                    if (imageCropMode == null)
                    {
                        imageCropMode = ImageCropMode.Pad;
                    }

                    imageProcessorUrl.Append(&quot;?mode=&quot; + imageCropMode.ToString().ToLower());

                    if (imageCropAnchor != null)
                    {
                        imageProcessorUrl.Append(&quot;&amp;anchor=&quot; + imageCropAnchor.ToString().ToLower());
                    }
                }

                var hasFormat = furtherOptions != null &amp;&amp; furtherOptions.InvariantContains(&quot;&amp;format=&quot;);

                //Only put quality here, if we don&#39;t have a format specified. 
                //Otherwise we need to put quality at the end to avoid it being overridden by the format.
                if (quality != null &amp;&amp; hasFormat == false)
                {
                    imageProcessorUrl.Append(&quot;&amp;quality=&quot; + quality);
                }

                if (width != null &amp;&amp; ratioMode != ImageCropRatioMode.Width)
                {
                    imageProcessorUrl.Append(&quot;&amp;width=&quot; + width);
                }

                if (height != null &amp;&amp; ratioMode != ImageCropRatioMode.Height)
                {
                    imageProcessorUrl.Append(&quot;&amp;height=&quot; + height);
                }

                if (ratioMode == ImageCropRatioMode.Width &amp;&amp; height != null)
                {
                    // if only height specified then assume a sqaure
                    if (width == null)
                    {
                        width = height;
                    }

                    var widthRatio = (decimal)width / (decimal)height;
                    imageProcessorUrl.Append(&quot;&amp;widthratio=&quot; + widthRatio.ToString(CultureInfo.InvariantCulture));
                }

                if (ratioMode == ImageCropRatioMode.Height &amp;&amp; width != null)
                {
                    // if only width specified then assume a sqaure
                    if (height == null)
                    {
                        height = width;
                    }

                    var heightRatio = (decimal)height / (decimal)width;
                    imageProcessorUrl.Append(&quot;&amp;heightratio=&quot; + heightRatio.ToString(CultureInfo.InvariantCulture));
                }

                if (upScale == false)
                {
                    imageProcessorUrl.Append(&quot;&amp;upscale=false&quot;);
                }

                if (furtherOptions != null)
                {
                    imageProcessorUrl.Append(furtherOptions);
                }

                //If furtherOptions contains a format, we need to put the quality after the format.
                if (quality != null &amp;&amp; hasFormat)
                {
                    imageProcessorUrl.Append(&quot;&amp;quality=&quot; + quality);
                }

                if (cacheBusterValue != null)
                {
                    imageProcessorUrl.Append(&quot;&amp;rnd=&quot;).Append(cacheBusterValue);
                }

                return imageProcessorUrl.ToString();
            }

            return string.Empty;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,29,10,0],[30,13,30,88,0],[31,9,31,10,0],[49,9,49,10,0],[50,13,50,118,0],[51,9,51,10,0],[116,9,116,10,0],[117,13,117,35,0],[117,36,117,81,0],[119,13,119,133,0],[121,13,121,109,0],[122,17,122,37,0],[125,13,125,74,0],[128,13,128,66,0],[130,13,130,39,0],[131,13,131,14,0],[132,17,132,50,0],[133,17,135,75,0],[139,13,139,48,0],[140,13,140,30,0],[141,13,141,14,0],[142,17,142,67,0],[143,17,143,50,0],[144,17,146,75,0],[150,13,150,52,0],[151,13,153,71,0],[154,9,154,10,0],[219,9,219,10,1],[220,13,220,48,1],[220,49,220,69,0],[222,13,222,49,1],[223,13,223,168,1],[224,13,224,14,1],[225,17,225,74,1],[226,13,226,14,1],[227,13,229,125,1],[230,9,230,10,1],[247,9,247,10,1],[248,13,248,57,1],[249,13,249,14,1],[250,17,250,61,1],[252,17,252,108,1],[253,17,253,18,1],[254,21,254,63,1],[256,21,256,63,1],[258,21,258,95,1],[259,21,259,45,1],[260,21,260,22,1],[261,25,261,63,1],[262,21,262,22,1],[264,21,264,22,1],[265,25,265,37,1],[268,21,268,58,1],[269,21,269,22,1],[270,25,270,44,1],[271,25,271,46,1],[272,21,272,22,1],[275,21,275,166,1],[276,21,276,22,1],[277,25,277,86,1],[278,25,278,120,1],[279,21,279,22,1],[282,21,282,166,1],[283,21,283,22,1],[284,25,284,85,1],[285,25,285,118,1],[286,21,286,22,1],[287,17,287,18,1],[289,17,289,18,1],[290,21,290,56,1],[292,21,292,47,1],[293,21,293,22,0],[294,25,294,59,0],[295,21,295,22,0],[297,21,297,93,1],[299,21,299,49,1],[300,21,300,22,1],[301,25,301,101,1],[302,21,302,22,1],[303,17,303,18,1],[305,17,305,104,1],[309,17,309,59,1],[310,17,310,18,0],[311,21,311,69,0],[312,17,312,18,0],[314,17,314,76,1],[315,17,315,18,1],[316,21,316,65,1],[317,17,317,18,1],[319,17,319,78,1],[320,17,320,18,1],[321,21,321,67,1],[322,17,322,18,1],[324,17,324,77,1],[325,17,325,18,1],[327,21,327,39,1],[328,21,328,22,0],[329,25,329,40,0],[330,21,330,22,0],[332,21,332,71,1],[333,21,333,114,1],[334,17,334,18,1],[336,17,336,77,1],[337,17,337,18,1],[339,21,339,40,1],[340,21,340,22,0],[341,25,341,40,0],[342,21,342,22,0],[344,21,344,72,1],[345,21,345,116,1],[346,17,346,18,1],[348,17,348,38,1],[349,17,349,18,0],[350,21,350,64,0],[351,17,351,18,0],[353,17,353,44,1],[354,17,354,18,1],[355,21,355,62,1],[356,17,356,18,1],[359,17,359,50,1],[360,17,360,18,0],[361,21,361,69,0],[362,17,362,18,0],[364,17,364,46,1],[365,17,365,18,0],[366,21,366,80,0],[367,17,367,18,0],[369,17,369,53,1],[372,13,372,33,0],[373,9,373,10,1]]);
    </script>
  </body>
</html>