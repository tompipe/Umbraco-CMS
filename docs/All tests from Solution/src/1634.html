<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\LockingRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence
{
    internal class LockingRepository&lt;TRepository&gt;
        where TRepository : IDisposable, IRepository
    {
        private readonly IDatabaseUnitOfWorkProvider _uowProvider;
        private readonly Func&lt;IDatabaseUnitOfWork, TRepository&gt; _repositoryFactory;
        private readonly int[] _readLockIds, _writeLockIds;

        public LockingRepository(IDatabaseUnitOfWorkProvider uowProvider, Func&lt;IDatabaseUnitOfWork, TRepository&gt; repositoryFactory,
            IEnumerable&lt;int&gt; readLockIds, IEnumerable&lt;int&gt; writeLockIds)
        {
            Mandate.ParameterNotNull(uowProvider, &quot;uowProvider&quot;);
            Mandate.ParameterNotNull(repositoryFactory, &quot;repositoryFactory&quot;);

            _uowProvider = uowProvider;
            _repositoryFactory = repositoryFactory;
            _readLockIds = readLockIds == null ? new int[0] : readLockIds.ToArray();
            _writeLockIds = writeLockIds == null ? new int[0] : writeLockIds.ToArray();
        }

        public void WithReadLocked(Action&lt;LockedRepository&lt;TRepository&gt;&gt; action, bool autoCommit = true)
        {
            var uow = _uowProvider.GetUnitOfWork();
            using (var transaction = uow.Database.GetTransaction(IsolationLevel.RepeatableRead))
            {
                foreach (var lockId in _readLockIds)
                    uow.Database.AcquireLockNodeReadLock(lockId);

                using (var repository = _repositoryFactory(uow))
                {
                    action(new LockedRepository&lt;TRepository&gt;(transaction, uow, repository));
                    if (autoCommit == false) return;
                    uow.Commit();
                    transaction.Complete();
                }
            }
        }

        public TResult WithReadLocked&lt;TResult&gt;(Func&lt;LockedRepository&lt;TRepository&gt;, TResult&gt; func, bool autoCommit = true)
        {
            var uow = _uowProvider.GetUnitOfWork();
            using (var transaction = uow.Database.GetTransaction(IsolationLevel.RepeatableRead))
            {
                foreach (var lockId in _readLockIds)
                    uow.Database.AcquireLockNodeReadLock(lockId);

                using (var repository = _repositoryFactory(uow))
                {
                    var ret = func(new LockedRepository&lt;TRepository&gt;(transaction, uow, repository));
                    if (autoCommit == false) return ret;
                    uow.Commit();
                    transaction.Complete();
                    return ret;
                }
            }
        }

        public void WithWriteLocked(Action&lt;LockedRepository&lt;TRepository&gt;&gt; action, bool autoCommit = true)
        {
            var uow = _uowProvider.GetUnitOfWork();
            using (var transaction = uow.Database.GetTransaction(IsolationLevel.RepeatableRead))
            {
                foreach (var lockId in _writeLockIds)
                    uow.Database.AcquireLockNodeWriteLock(lockId);

                using (var repository = _repositoryFactory(uow))
                {
                    action(new LockedRepository&lt;TRepository&gt;(transaction, uow, repository));
                    if (autoCommit == false) return;
                    uow.Commit();
                    transaction.Complete();
                }
            }
        }

        public TResult WithWriteLocked&lt;TResult&gt;(Func&lt;LockedRepository&lt;TRepository&gt;, TResult&gt; func, bool autoCommit = true)
        {
            var uow = _uowProvider.GetUnitOfWork();
            using (var transaction = uow.Database.GetTransaction(IsolationLevel.RepeatableRead))
            {
                foreach (var lockId in _writeLockIds)
                    uow.Database.AcquireLockNodeReadLock(lockId);

                using (var repository = _repositoryFactory(uow))
                {
                    var ret = func(new LockedRepository&lt;TRepository&gt;(transaction, uow, repository));
                    if (autoCommit == false) return ret;
                    uow.Commit();
                    transaction.Complete();
                    return ret;
                }
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,18,73,0],[19,9,19,10,0],[20,13,20,66,0],[21,13,21,78,0],[23,13,23,40,0],[24,13,24,52,0],[25,13,25,85,0],[26,13,26,88,0],[27,9,27,10,0],[30,9,30,10,0],[31,13,31,52,0],[32,20,32,96,0],[33,13,33,14,0],[34,17,34,24,0],[34,26,34,36,0],[34,37,34,39,0],[34,40,34,52,0],[35,21,35,66,0],[37,24,37,64,0],[38,17,38,18,0],[39,21,39,93,0],[40,21,40,45,0],[40,46,40,53,0],[41,21,41,34,0],[42,21,42,44,0],[43,17,43,18,0],[44,13,44,14,0],[45,9,45,10,0],[48,9,48,10,0],[49,13,49,52,0],[50,20,50,96,0],[51,13,51,14,0],[52,17,52,24,0],[52,26,52,36,0],[52,37,52,39,0],[52,40,52,52,0],[53,21,53,66,0],[55,24,55,64,0],[56,17,56,18,0],[57,21,57,101,0],[58,21,58,45,0],[58,46,58,57,0],[59,21,59,34,0],[60,21,60,44,0],[61,21,61,32,0],[64,9,64,10,0],[67,9,67,10,0],[68,13,68,52,0],[69,20,69,96,0],[70,13,70,14,0],[71,17,71,24,0],[71,26,71,36,0],[71,37,71,39,0],[71,40,71,53,0],[72,21,72,67,0],[74,24,74,64,0],[75,17,75,18,0],[76,21,76,93,0],[77,21,77,45,0],[77,46,77,53,0],[78,21,78,34,0],[79,21,79,44,0],[80,17,80,18,0],[81,13,81,14,0],[82,9,82,10,0],[85,9,85,10,0],[86,13,86,52,0],[87,20,87,96,0],[88,13,88,14,0],[89,17,89,24,0],[89,26,89,36,0],[89,37,89,39,0],[89,40,89,53,0],[90,21,90,66,0],[92,24,92,64,0],[93,17,93,18,0],[94,21,94,101,0],[95,21,95,45,0],[95,46,95,57,0],[96,21,96,34,0],[97,21,97,44,0],[98,21,98,32,0],[101,9,101,10,0]]);
    </script>
  </body>
</html>