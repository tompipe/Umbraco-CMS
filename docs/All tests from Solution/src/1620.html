<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\PropertyEditors\ValueConverters\ImageCropperValueConverter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Linq;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.PublishedContent;
using Umbraco.Core.Services;

namespace Umbraco.Core.PropertyEditors.ValueConverters
{
    /// &lt;summary&gt;
    /// This ensures that the cropper config (pre-values/crops) are merged in with the front-end value.
    /// &lt;/summary&gt;
    [DefaultPropertyValueConverter(typeof (JsonValueConverter))] //this shadows the JsonValueConverter
    [PropertyValueType(typeof (JToken))]
    [PropertyValueCache(PropertyCacheValue.All, PropertyCacheLevel.Content)]
    public class ImageCropperValueConverter : JsonValueConverter
    {
        private readonly IDataTypeService _dataTypeService;

        public ImageCropperValueConverter()
        {
            _dataTypeService = ApplicationContext.Current.Services.DataTypeService;
        }

        public ImageCropperValueConverter(IDataTypeService dataTypeService)
        {
            if (dataTypeService == null) throw new ArgumentNullException(&quot;dataTypeService&quot;);
            _dataTypeService = dataTypeService;
        }

        public override bool IsConverter(PublishedPropertyType propertyType)
        {
            return propertyType.PropertyEditorAlias.InvariantEquals(Constants.PropertyEditors.ImageCropperAlias);
        }

        internal static void MergePreValues(JObject currentValue, IDataTypeService dataTypeService, int dataTypeId)
        {
            //need to lookup the pre-values for this data type
            //TODO: Change all singleton access to use ctor injection in v8!!!
            var dt = dataTypeService.GetPreValuesCollectionByDataTypeId(dataTypeId);

            if (dt != null &amp;&amp; dt.IsDictionaryBased &amp;&amp; dt.PreValuesAsDictionary.ContainsKey(&quot;crops&quot;))
            {
                var cropsString = dt.PreValuesAsDictionary[&quot;crops&quot;].Value;
                JArray preValueCrops;
                try
                {
                    preValueCrops = JsonConvert.DeserializeObject&lt;JArray&gt;(cropsString);
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;ImageCropperValueConverter&gt;(&quot;Could not parse the string &quot; + cropsString + &quot; to a json object&quot;, ex);
                    return;
                }

                //now we need to merge the crop values - the alias + width + height comes from pre-configured pre-values,
                // however, each crop can store it&#39;s own coordinates

                JArray existingCropsArray;
                if (currentValue[&quot;crops&quot;] != null)
                {
                    existingCropsArray = (JArray)currentValue[&quot;crops&quot;];
                }
                else
                {
                    currentValue[&quot;crops&quot;] = existingCropsArray = new JArray();
                }

                foreach (var preValueCrop in preValueCrops.Where(x =&gt; x.HasValues))
                {
                    var found = existingCropsArray.FirstOrDefault(x =&gt;
                    {
                        if (x.HasValues &amp;&amp; x[&quot;alias&quot;] != null)
                        {
                            return x[&quot;alias&quot;].Value&lt;string&gt;() == preValueCrop[&quot;alias&quot;].Value&lt;string&gt;();
                        }
                        return false;
                    });
                    if (found != null)
                    {
                        found[&quot;width&quot;] = preValueCrop[&quot;width&quot;];
                        found[&quot;height&quot;] = preValueCrop[&quot;height&quot;];
                    }
                    else
                    {
                        existingCropsArray.Add(preValueCrop);
                    }
                }
            }
        }

        public override object ConvertDataToSource(PublishedPropertyType propertyType, object source, bool preview)
        {
            if (source == null) return null;
            var sourceString = source.ToString();

            if (sourceString.DetectIsJson())
            {
                JObject obj;
                try
                {
                    obj = JsonConvert.DeserializeObject&lt;JObject&gt;(sourceString, new JsonSerializerSettings
                    {
                        Culture = CultureInfo.InvariantCulture,
                        FloatParseHandling = FloatParseHandling.Decimal
                    });
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;ImageCropperValueConverter&gt;(&quot;Could not parse the string &quot; + sourceString + &quot; to a json object&quot;, ex);
                    return sourceString;
                }

                MergePreValues(obj, _dataTypeService, propertyType.DataTypeId);

                return obj;
            }

            //it&#39;s not json, just return the string
            return sourceString;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,44,0],[23,9,23,10,0],[24,13,24,84,0],[25,9,25,10,0],[27,9,27,76,1],[28,9,28,10,1],[29,13,29,41,1],[29,42,29,93,0],[30,13,30,48,1],[31,9,31,10,1],[34,9,34,10,0],[35,13,35,114,0],[36,9,36,10,0],[39,9,39,10,1],[42,13,42,85,1],[44,13,44,101,1],[45,13,45,14,0],[46,17,46,75,0],[49,17,49,18,0],[50,21,50,88,0],[51,17,51,18,0],[52,17,52,37,0],[53,17,53,18,0],[54,21,54,136,0],[55,21,55,28,0],[62,17,62,51,0],[63,17,63,18,0],[64,21,64,72,0],[65,17,65,18,0],[67,17,67,18,0],[68,21,68,79,0],[69,17,69,18,0],[71,17,71,24,0],[71,26,71,42,0],[71,43,71,45,0],[71,46,71,71,0],[71,71,71,82,0],[71,82,71,83,0],[71,46,71,83,0],[72,17,72,18,0],[73,21,74,21,0],[74,21,74,22,0],[74,22,75,25,0],[75,25,75,63,0],[75,63,76,25,0],[76,25,76,26,0],[76,26,77,29,0],[77,29,77,104,0],[77,104,79,25,0],[79,25,79,38,0],[79,38,80,21,0],[80,21,80,22,0],[80,22,80,24,0],[73,21,80,24,0],[81,21,81,39,0],[82,21,82,22,0],[83,25,83,64,0],[84,25,84,66,0],[85,21,85,22,0],[87,21,87,22,0],[88,25,88,62,0],[89,21,89,22,0],[90,17,90,18,0],[91,13,91,14,0],[92,9,92,10,1],[95,9,95,10,1],[96,13,96,32,1],[96,33,96,45,0],[97,13,97,50,1],[99,13,99,45,1],[100,13,100,14,1],[103,17,103,18,1],[104,21,108,24,1],[109,17,109,18,1],[110,17,110,37,0],[111,17,111,18,0],[112,21,112,137,0],[113,21,113,41,0],[116,17,116,80,1],[118,17,118,28,1],[122,13,122,33,0],[123,9,123,10,1]]);
    </script>
  </body>
</html>