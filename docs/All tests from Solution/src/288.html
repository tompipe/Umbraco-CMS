<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\TestHelpers\TestHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Configuration;
using System.IO;
using System.Linq;
using System.Reflection;
using NUnit.Framework;
using SqlCE4Umbraco;
using Umbraco.Core;
using Umbraco.Core.IO;
using umbraco.DataLayer;
using Umbraco.Core.Models.EntityBase;
using GlobalSettings = umbraco.GlobalSettings;

namespace Umbraco.Tests.TestHelpers
{
    /// &lt;summary&gt;
	/// Common helper properties and methods useful to testing
	/// &lt;/summary&gt;
	public static class TestHelper
	{

		/// &lt;summary&gt;
		/// Clears an initialized database
		/// &lt;/summary&gt;
		public static void ClearDatabase()
		{
            var databaseSettings = ConfigurationManager.ConnectionStrings[Core.Configuration.GlobalSettings.UmbracoConnectionName];
            var dataHelper = DataLayerHelper.CreateSqlHelper(databaseSettings.ConnectionString, false) as SqlCEHelper;
			
			if (dataHelper == null)
				throw new InvalidOperationException(&quot;The sql helper for unit tests must be of type SqlCEHelper, check the ensure the connection string used for this test is set to use SQLCE&quot;);

			dataHelper.ClearDatabase();
		}

        public static void DropForeignKeys(string table)
        {
            var databaseSettings = ConfigurationManager.ConnectionStrings[Core.Configuration.GlobalSettings.UmbracoConnectionName];
            var dataHelper = DataLayerHelper.CreateSqlHelper(databaseSettings.ConnectionString, false) as SqlCEHelper;

            if (dataHelper == null)
                throw new InvalidOperationException(&quot;The sql helper for unit tests must be of type SqlCEHelper, check the ensure the connection string used for this test is set to use SQLCE&quot;);

            dataHelper.DropForeignKeys(table);
        }

		/// &lt;summary&gt;
		/// Gets the current assembly directory.
		/// &lt;/summary&gt;
		/// &lt;value&gt;The assembly directory.&lt;/value&gt;
		static public string CurrentAssemblyDirectory
		{
			get
			{
				var codeBase = typeof(TestHelper).Assembly.CodeBase;
				var uri = new Uri(codeBase);
				var path = uri.LocalPath;
				return Path.GetDirectoryName(path);
			}
		}

		/// &lt;summary&gt;
		/// Maps the given &lt;paramref name=&quot;relativePath&quot;/&gt; making it rooted on &lt;see cref=&quot;CurrentAssemblyDirectory&quot;/&gt;. &lt;paramref name=&quot;relativePath&quot;/&gt; must start with &lt;code&gt;~/&lt;/code&gt;
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;relativePath&quot;&gt;The relative path.&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static string MapPathForTest(string relativePath)
		{
			if (!relativePath.StartsWith(&quot;~/&quot;))
				throw new ArgumentException(&quot;relativePath must start with &#39;~/&#39;&quot;, &quot;relativePath&quot;);

			return relativePath.Replace(&quot;~/&quot;, CurrentAssemblyDirectory + &quot;/&quot;);
		}

	    public static void InitializeContentDirectories()
        {
            CreateDirectories(new[] { SystemDirectories.Masterpages, SystemDirectories.MvcViews, SystemDirectories.Media, SystemDirectories.AppPlugins });
        }

	    public static void CleanContentDirectories()
	    {
	        CleanDirectories(new[] { SystemDirectories.Masterpages, SystemDirectories.MvcViews, SystemDirectories.Media });
	    }

	    public static void CreateDirectories(string[] directories)
        {
            foreach (var directory in directories)
            {
                var directoryInfo = new DirectoryInfo(IOHelper.MapPath(directory));
                if (directoryInfo.Exists == false)
                    Directory.CreateDirectory(IOHelper.MapPath(directory));
            }
        }

	    public static void CleanDirectories(string[] directories)
	    {
	        var preserves = new Dictionary&lt;string, string[]&gt;
	        {
	            { SystemDirectories.Masterpages, new[] {&quot;dummy.txt&quot;} },
	            { SystemDirectories.MvcViews, new[] {&quot;dummy.txt&quot;} }
	        };
            foreach (var directory in directories)
            {
                var directoryInfo = new DirectoryInfo(IOHelper.MapPath(directory));
                var preserve = preserves.ContainsKey(directory) ? preserves[directory] : null;
                if (directoryInfo.Exists)
                    directoryInfo.GetFiles().Where(x =&gt; preserve == null || preserve.Contains(x.Name) == false).ForEach(x =&gt; x.Delete());
            }
        }

	    public static void CleanUmbracoSettingsConfig()
        {
            var currDir = new DirectoryInfo(CurrentAssemblyDirectory);

            var umbracoSettingsFile = Path.Combine(currDir.Parent.Parent.FullName, &quot;config&quot;, &quot;umbracoSettings.config&quot;);
            if (File.Exists(umbracoSettingsFile))
                File.Delete(umbracoSettingsFile);
        }

        public static void AssertAllPropertyValuesAreEquals(object actual, object expected, string dateTimeFormat = null, Func&lt;IEnumerable, IEnumerable&gt; sorter = null, string[] ignoreProperties = null)
        {
            var properties = expected.GetType().GetProperties();
            foreach (var property in properties)
            {
                //ignore properties that are attributed with this
                var att = property.GetCustomAttribute&lt;EditorBrowsableAttribute&gt;(false);
                if (att != null &amp;&amp; att.State == EditorBrowsableState.Never)
                    continue;

                if (ignoreProperties != null &amp;&amp; ignoreProperties.Contains(property.Name))
                    continue;

                var expectedValue = property.GetValue(expected, null);
                var actualValue = property.GetValue(actual, null);

                if (((actualValue is string) == false) &amp;&amp; actualValue is IEnumerable)
                {
                    AssertListsAreEquals(property, (IEnumerable)actualValue, (IEnumerable)expectedValue, dateTimeFormat, sorter);
                }
                else if (dateTimeFormat.IsNullOrWhiteSpace() == false &amp;&amp; actualValue is DateTime)
                {
                    // round to second else in some cases tests can fail ;-(
                    var expectedDateTime = (DateTime) expectedValue;
                    expectedDateTime = expectedDateTime.AddTicks(-(expectedDateTime.Ticks%TimeSpan.TicksPerSecond));
                    var actualDateTime = (DateTime) actualValue;
                    actualDateTime = actualDateTime.AddTicks(-(actualDateTime.Ticks % TimeSpan.TicksPerSecond));

                    Assert.AreEqual(expectedDateTime.ToString(dateTimeFormat), actualDateTime.ToString(dateTimeFormat), &quot;Property {0}.{1} does not match. Expected: {2} but was: {3}&quot;, property.DeclaringType.Name, property.Name, expectedValue, actualValue);
                }
                else
                {
                    Assert.AreEqual(expectedValue, actualValue, &quot;Property {0}.{1} does not match. Expected: {2} but was: {3}&quot;, property.DeclaringType.Name, property.Name, expectedValue, actualValue);
                }
            }
        }

        private static void AssertListsAreEquals(PropertyInfo property, IEnumerable actualList, IEnumerable expectedList, string dateTimeFormat, Func&lt;IEnumerable, IEnumerable&gt; sorter)
        {
            if (sorter == null)
            {
                //this is pretty hackerific but saves us some code to write
                sorter = enumerable =&gt;
                {
                    //semi-generic way of ensuring any collection of IEntity are sorted by Ids for comparison
                    var entities = enumerable.OfType&lt;IEntity&gt;().ToList();
                    if (entities.Count &gt; 0)
                    {
                        return entities.OrderBy(x =&gt; x.Id);
                    }
                    else
                    {
                        return enumerable;
                    }
                };
            }          

            var actualListEx = sorter(actualList).Cast&lt;object&gt;().ToList();
            var expectedListEx = sorter(expectedList).Cast&lt;object&gt;().ToList();

            if (actualListEx.Count != expectedListEx.Count)
                Assert.Fail(&quot;Collection {0}.{1} does not match. Expected IEnumerable containing {2} elements but was IEnumerable containing {3} elements&quot;, property.PropertyType.Name, property.Name, expectedListEx.Count, actualListEx.Count);

            for (int i = 0; i &lt; actualListEx.Count; i++)
            {
                var actualValue = actualListEx[i];
                var expectedValue = expectedListEx[i];

                if (((actualValue is string) == false) &amp;&amp; actualValue is IEnumerable)
                {
                    AssertListsAreEquals(property, (IEnumerable)actualValue, (IEnumerable)expectedValue, dateTimeFormat, sorter);
                }
                else if (dateTimeFormat.IsNullOrWhiteSpace() == false &amp;&amp; actualValue is DateTime)
                {
                    Assert.AreEqual(((DateTime)expectedValue).ToString(dateTimeFormat), ((DateTime)actualValue).ToString(dateTimeFormat), &quot;Property {0}.{1} does not match. Expected: {2} but was: {3}&quot;, property.DeclaringType.Name, property.Name, expectedValue, actualValue);
                }
                else
                {
                    Assert.AreEqual(expectedValue, actualValue, &quot;Property {0}.{1} does not match. Expected: {2} but was: {3}&quot;, property.DeclaringType.Name, property.Name, expectedValue, actualValue);
                }
            }
        }


    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[29,3,29,4,1],[30,13,30,132,1],[31,13,31,119,1],[33,4,33,27,1],[34,5,34,181,0],[36,4,36,31,1],[37,3,37,4,1],[40,9,40,10,0],[41,13,41,132,0],[42,13,42,119,0],[44,13,44,36,0],[45,17,45,193,0],[47,13,47,47,0],[48,9,48,10,0],[57,4,57,5,1],[58,5,58,57,1],[59,5,59,33,1],[60,5,60,30,1],[61,5,61,40,1],[62,4,62,5,1],[71,3,71,4,1],[72,4,72,39,1],[73,5,73,86,0],[75,4,75,70,1],[76,3,76,4,1],[79,9,79,10,1],[80,13,80,155,1],[81,9,81,10,1],[84,6,84,7,1],[85,10,85,121,1],[86,6,86,7,1],[89,9,89,10,1],[90,13,90,20,1],[90,22,90,35,1],[90,36,90,38,1],[90,39,90,50,1],[91,13,91,14,1],[92,17,92,84,1],[93,17,93,51,1],[94,21,94,76,1],[95,13,95,14,1],[96,9,96,10,1],[99,6,99,7,1],[100,10,104,12,1],[105,13,105,20,1],[105,22,105,35,1],[105,36,105,38,1],[105,39,105,50,1],[106,13,106,14,1],[107,17,107,84,1],[108,17,108,95,1],[109,17,109,42,1],[110,21,110,57,1],[110,57,110,111,1],[110,111,110,126,1],[110,126,110,136,1],[110,136,110,138,1],[110,21,110,138,1],[111,13,111,14,1],[112,9,112,10,1],[115,9,115,10,1],[116,13,116,71,1],[118,13,118,120,1],[119,13,119,50,1],[120,17,120,50,0],[121,9,121,10,1],[124,9,124,10,1],[125,13,125,65,1],[126,13,126,20,1],[126,22,126,34,1],[126,35,126,37,1],[126,38,126,48,1],[127,13,127,14,1],[129,17,129,88,1],[130,17,130,76,1],[131,21,131,30,1],[133,17,133,90,1],[134,21,134,30,1],[136,17,136,71,1],[137,17,137,67,1],[139,17,139,86,1],[140,17,140,18,1],[141,21,141,130,1],[142,17,142,18,1],[143,22,143,98,1],[144,17,144,18,1],[146,21,146,69,1],[147,21,147,117,1],[148,21,148,65,1],[149,21,149,113,1],[151,21,151,256,1],[152,17,152,18,1],[154,17,154,18,1],[155,21,155,200,1],[156,17,156,18,1],[157,13,157,14,1],[158,9,158,10,1],[161,9,161,10,1],[162,13,162,32,1],[163,13,163,14,1],[165,17,166,17,1],[166,17,166,18,1],[166,18,168,21,1],[168,21,168,74,1],[168,74,169,21,1],[169,21,169,44,1],[169,44,170,21,1],[170,21,170,22,1],[170,22,171,25,1],[171,25,171,54,1],[171,54,171,58,1],[171,58,171,60,1],[171,25,171,60,1],[171,60,174,21,1],[174,21,174,22,1],[174,22,175,25,1],[175,25,175,43,1],[175,43,177,17,1],[177,17,177,18,1],[177,18,177,19,1],[165,17,177,19,1],[178,13,178,14,1],[180,13,180,75,1],[181,13,181,79,1],[183,13,183,60,1],[184,17,184,241,0],[186,18,186,27,1],[186,29,186,51,1],[186,53,186,56,1],[187,13,187,14,1],[188,17,188,51,1],[189,17,189,55,1],[191,17,191,86,1],[192,17,192,18,0],[193,21,193,130,0],[194,17,194,18,0],[195,22,195,98,1],[196,17,196,18,0],[197,21,197,274,0],[198,17,198,18,0],[200,17,200,18,1],[201,21,201,200,1],[202,17,202,18,1],[203,13,203,14,1],[204,9,204,10,1]]);
    </script>
  </body>
</html>