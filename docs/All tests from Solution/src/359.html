<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\TaskRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class TaskRepositoryTest : BaseDatabaseFactoryTest
    {
        [Test]
        public void Can_Delete()
        {
             var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var created = DateTime.Now;
                var task = new Task(new TaskType(&quot;asdfasdf&quot;))
                {
                    AssigneeUserId = 0,
                    Closed = false,
                    Comment = &quot;hello world&quot;,
                    EntityId = -1,
                    OwnerUserId = 0
                };
                repo.AddOrUpdate(task);
                unitOfWork.Commit();

                repo.Delete(task);
                unitOfWork.Commit();

                task = repo.Get(task.Id);
                Assert.IsNull(task);
            }
        }

        [Test]
        public void Can_Add()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var created = DateTime.Now;
                repo.AddOrUpdate(new Task(new TaskType(&quot;asdfasdf&quot;))
                {
                    AssigneeUserId = 0,
                    Closed = false,
                    Comment = &quot;hello world&quot;,
                    EntityId = -1,
                    OwnerUserId = 0
                });
                unitOfWork.Commit();

                var found = repo.GetAll().ToArray();

                Assert.AreEqual(1, found.Count());
                Assert.AreEqual(0, found.First().AssigneeUserId);
                Assert.AreEqual(false, found.First().Closed);
                Assert.AreEqual(&quot;hello world&quot;, found.First().Comment);
                Assert.GreaterOrEqual(found.First().CreateDate.TruncateTo(DateTimeExtensions.DateTruncate.Second), created.TruncateTo(DateTimeExtensions.DateTruncate.Second));
                Assert.AreEqual(-1, found.First().EntityId);
                Assert.AreEqual(0, found.First().OwnerUserId);
                Assert.AreEqual(true, found.First().HasIdentity);
                Assert.AreEqual(true, found.First().TaskType.HasIdentity);
            }            
        }

        [Test]
        public void Can_Update()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var task = new Task(new TaskType(&quot;asdfasdf&quot;))
                {
                    AssigneeUserId = 0,
                    Closed = false,
                    Comment = &quot;hello world&quot;,
                    EntityId = -1,
                    OwnerUserId = 0
                };

                repo.AddOrUpdate(task);
                unitOfWork.Commit();

                //re-get 
                task = repo.Get(task.Id);

                task.Comment = &quot;blah&quot;;
                task.Closed = true;

                repo.AddOrUpdate(task);
                unitOfWork.Commit();

                //re-get 
                task = repo.Get(task.Id);

                Assert.AreEqual(true, task.Closed);
                Assert.AreEqual(&quot;blah&quot;, task.Comment);
            }            
        }

        [Test]
        public void Get_By_Id()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var task = new Task(new TaskType(&quot;asdfasdf&quot;))
                {
                    AssigneeUserId = 0,
                    Closed = false,
                    Comment = &quot;hello world&quot;,
                    EntityId = -1,
                    OwnerUserId = 0
                };

                repo.AddOrUpdate(task);
                unitOfWork.Commit();

                //re-get 
                task = repo.Get(task.Id);

                Assert.IsNotNull(task);
            }
        }

        [Test]
        public void Get_All()
        {
            CreateTestData(false, 20);

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var found = repo.GetAll().ToArray();
                Assert.AreEqual(20, found.Count());
            }
        }

        [Test]
        public void Get_All_With_Closed()
        {
            CreateTestData(false, 10);
            CreateTestData(true, 5);

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var found = repo.GetTasks(includeClosed: true).ToArray();
                Assert.AreEqual(15, found.Count());
            }
        }

        [Test]
        public void Get_All_With_Node_Id()
        {
            CreateTestData(false, 10, -20);
            CreateTestData(false, 5, -21);

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var found = repo.GetTasks(itemId:-20).ToArray();
                Assert.AreEqual(10, found.Count());
            }
        }

        [Test]
        public void Get_All_Without_Closed()
        {
            CreateTestData(false, 10);
            CreateTestData(true, 5);

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var found = repo.GetTasks(includeClosed: false);
                Assert.AreEqual(10, found.Count());
            }
        }

        private void CreateTestData(bool closed, int count, int entityId = -1)
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new TaskRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                for (int i = 0; i &lt; count; i++)
                {
                    repo.AddOrUpdate(new Task(new TaskType(&quot;asdfasdf&quot;))
                    {
                        AssigneeUserId = 0,
                        Closed = closed,
                        Comment = &quot;hello world &quot; + i,
                        EntityId = entityId,
                        OwnerUserId = 0
                    });
                    unitOfWork.Commit();
                }
                
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,10,1],[19,14,19,68,1],[20,13,20,55,1],[21,20,21,93,1],[22,13,22,14,1],[23,17,23,44,1],[24,17,31,19,1],[32,17,32,40,1],[33,17,33,37,1],[35,17,35,35,1],[36,17,36,37,1],[38,17,38,42,1],[39,17,39,37,1],[40,13,40,14,1],[41,9,41,10,1],[45,9,45,10,1],[46,13,46,67,1],[47,13,47,55,1],[48,20,48,93,1],[49,13,49,14,1],[50,17,50,44,1],[51,17,58,20,1],[59,17,59,37,1],[61,17,61,53,1],[63,17,63,51,1],[64,17,64,66,1],[65,17,65,62,1],[66,17,66,71,1],[67,17,67,176,1],[68,17,68,61,1],[69,17,69,63,1],[70,17,70,66,1],[71,17,71,75,1],[72,13,72,14,1],[73,9,73,10,1],[77,9,77,10,1],[78,13,78,67,1],[79,13,79,55,1],[80,20,80,93,1],[81,13,81,14,1],[82,17,89,19,1],[91,17,91,40,1],[92,17,92,37,1],[95,17,95,42,1],[97,17,97,39,1],[98,17,98,36,1],[100,17,100,40,1],[101,17,101,37,1],[104,17,104,42,1],[106,17,106,52,1],[107,17,107,55,1],[108,13,108,14,1],[109,9,109,10,1],[113,9,113,10,1],[114,13,114,67,1],[115,13,115,55,1],[116,20,116,93,1],[117,13,117,14,1],[118,17,125,19,1],[127,17,127,40,1],[128,17,128,37,1],[131,17,131,42,1],[133,17,133,40,1],[134,13,134,14,1],[135,9,135,10,1],[139,9,139,10,1],[140,13,140,39,1],[142,13,142,67,1],[143,13,143,55,1],[144,20,144,93,1],[145,13,145,14,1],[146,17,146,53,1],[147,17,147,52,1],[148,13,148,14,1],[149,9,149,10,1],[153,9,153,10,1],[154,13,154,39,1],[155,13,155,37,1],[157,13,157,67,1],[158,13,158,55,1],[159,20,159,93,1],[160,13,160,14,1],[161,17,161,74,1],[162,17,162,52,1],[163,13,163,14,1],[164,9,164,10,1],[168,9,168,10,1],[169,13,169,44,1],[170,13,170,43,1],[172,13,172,67,1],[173,13,173,55,1],[174,20,174,93,1],[175,13,175,14,1],[176,17,176,65,1],[177,17,177,52,1],[178,13,178,14,1],[179,9,179,10,1],[183,9,183,10,1],[184,13,184,39,1],[185,13,185,37,1],[187,13,187,67,1],[188,13,188,55,1],[189,20,189,93,1],[190,13,190,14,1],[191,17,191,65,1],[192,17,192,52,1],[193,13,193,14,1],[194,9,194,10,1],[197,9,197,10,1],[198,13,198,67,1],[199,13,199,55,1],[200,20,200,93,1],[201,13,201,14,1],[202,22,202,31,1],[202,33,202,42,1],[202,44,202,47,1],[203,17,203,18,1],[204,21,211,24,1],[212,21,212,41,1],[213,17,213,18,1],[215,13,215,14,1],[216,9,216,10,1]]);
    </script>
  </body>
</html>