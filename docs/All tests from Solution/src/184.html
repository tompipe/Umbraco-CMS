<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Security\BackOfficeCookieManagerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Web;
using Microsoft.Owin;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Profiling;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;
using Umbraco.Web.Routing;
using Umbraco.Web.Security;
using Umbraco.Web.Security.Identity;

namespace Umbraco.Tests.Security
{
    [TestFixture]
    public class BackOfficeCookieManagerTests
    {
        [Test]
        public void ShouldAuthenticateRequest_When_Not_Configured()
        {
            //should force app ctx to show not-configured
            ConfigurationManager.AppSettings.Set(&quot;umbracoConfigurationStatus&quot;, &quot;&quot;);

            var dbCtx = new Mock&lt;DatabaseContext&gt;(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;ISqlSyntaxProvider&gt;(), &quot;test&quot;);
            dbCtx.Setup(x =&gt; x.IsDatabaseConfigured).Returns(false);

            var appCtx = new ApplicationContext(
                dbCtx.Object,
                MockHelper.GetMockedServiceContext(),
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            
            var umbCtx = UmbracoContext.CreateContext(
                Mock.Of&lt;HttpContextBase&gt;(), 
                appCtx, 
                new WebSecurity(Mock.Of&lt;HttpContextBase&gt;(), appCtx), 
                Mock.Of&lt;IUmbracoSettingsSection&gt;(), new List&lt;IUrlProvider&gt;(), false);

            var mgr = new BackOfficeCookieManager(Mock.Of&lt;IUmbracoContextAccessor&gt;(accessor =&gt; accessor.Value == umbCtx));

            var result = mgr.ShouldAuthenticateRequest(Mock.Of&lt;IOwinContext&gt;(), new Uri(&quot;http://localhost/umbraco&quot;));

            Assert.IsFalse(result);
        }

        [Test]
        public void ShouldAuthenticateRequest_When_Configured()
        {
            var dbCtx = new Mock&lt;DatabaseContext&gt;(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;ISqlSyntaxProvider&gt;(), &quot;test&quot;);
            dbCtx.Setup(x =&gt; x.IsDatabaseConfigured).Returns(true);

            var appCtx = new ApplicationContext(
                dbCtx.Object,
                MockHelper.GetMockedServiceContext(),
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            var umbCtx = UmbracoContext.CreateContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new WebSecurity(Mock.Of&lt;HttpContextBase&gt;(), appCtx),
                Mock.Of&lt;IUmbracoSettingsSection&gt;(), new List&lt;IUrlProvider&gt;(), false);

            var mgr = new BackOfficeCookieManager(Mock.Of&lt;IUmbracoContextAccessor&gt;(accessor =&gt; accessor.Value == umbCtx));

            var request = new Mock&lt;OwinRequest&gt;();
            request.Setup(owinRequest =&gt; owinRequest.Uri).Returns(new Uri(&quot;http://localhost/umbraco&quot;));

            var result = mgr.ShouldAuthenticateRequest(
                Mock.Of&lt;IOwinContext&gt;(context =&gt; context.Request == request.Object), 
                new Uri(&quot;http://localhost/umbraco&quot;));

            Assert.IsTrue(result);
        }

        //TODO : Write remaining tests for `ShouldAuthenticateRequest`
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,1],[29,13,29,84,1],[31,13,31,139,1],[32,13,32,69,1],[34,13,38,80,1],[40,13,44,86,1],[46,13,46,123,1],[48,13,48,118,1],[50,13,50,36,1],[51,9,51,10,1],[55,9,55,10,1],[56,13,56,139,1],[57,13,57,68,1],[59,13,63,80,1],[65,13,69,86,1],[71,13,71,123,1],[73,13,73,51,1],[74,13,74,104,1],[76,13,78,54,1],[80,13,80,35,1],[81,9,81,10,1]]);
    </script>
  </body>
</html>