<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Models\ContentExtensionsTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Models
{
    [TestFixture]
    public class ContentExtensionsTests : BaseUmbracoConfigurationTest
    {

        [Test]
        public void Should_Persist_Values_When_Saving_After_Publishing_But_No_Data_Changed()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);
            content.ChangePublishedState(PublishedState.Published);
            content.ResetDirtyProperties(false);

            //no version will be created if no data is changed
            content.Properties.First().Value = &quot;hello world&quot;;

            content.ChangePublishedState(PublishedState.Saved);
            Assert.IsTrue(content.RequiresSaving());
        }

        [Test]
        public void Should_Not_Persist_Values_When_Saving_After_Publishing_But_No_Data_Changed()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);
            content.ChangePublishedState(PublishedState.Published);
            content.ResetDirtyProperties(false);

            content.ChangePublishedState(PublishedState.Saved);
            Assert.IsFalse(content.RequiresSaving());
        }

        [Test]
        public void Should_Create_New_Version_When_Publishing()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);
            
            content.ChangePublishedState(PublishedState.Published);
            Assert.IsTrue(content.ShouldCreateNewVersion());
        }

        [Test]
        public void Should_Create_New_Version_When_Saving_After_Publishing()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);
            content.ChangePublishedState(PublishedState.Published);
            content.ResetDirtyProperties(false);

            //no version will be created if no data is changed
            content.Properties.First().Value = &quot;hello world&quot;;

            content.ChangePublishedState(PublishedState.Saved);
            Assert.IsTrue(content.ShouldCreateNewVersion());
        }

        [Test]
        public void Should_Create_New_Version_When_Language_Changed()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);

            content.Language = &quot;en-AU&quot;;
            Assert.IsTrue(content.ShouldCreateNewVersion(PublishedState.Unpublished));
        }

        [Test]
        public void Should_Create_New_Version_When_Any_Property_Value_Changed_And_Its_Already_Published()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);

            content.Properties.First().Value = &quot;hello world&quot;;
            Assert.IsTrue(content.ShouldCreateNewVersion(PublishedState.Published));
        }
        
        [Test]
        public void Should_Not_Create_New_Version_When_Published_Status_Not_Changed()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);

            Assert.IsFalse(content.ShouldCreateNewVersion(PublishedState.Unpublished));
        }

        [Test]
        public void Should_Not_Create_New_Version_When_Not_Published_And_Property_Changed()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);

            content.Properties.First().Value = &quot;hello world&quot;;
            Assert.IsFalse(content.ShouldCreateNewVersion(PublishedState.Unpublished));
        }

        [Test]
        public void Should_Clear_Published_Flag_When_Newly_Published_Version()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);

            content.ChangePublishedState(PublishedState.Published);
            Assert.IsTrue(content.ShouldClearPublishedFlagForPreviousVersions());
        }

        [Test]
        public void Should_Not_Clear_Published_Flag_When_Saving_Version()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);
            content.ChangePublishedState(PublishedState.Published);
            content.ResetDirtyProperties(false);

            content.ChangePublishedState(PublishedState.Saved);
            Assert.IsFalse(content.ShouldClearPublishedFlagForPreviousVersions());
        }

        [Test]
        public void Should_Clear_Published_Flag_When_Unpublishing_From_Published()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);
            content.ChangePublishedState(PublishedState.Published);
            content.ResetDirtyProperties(false);

            content.ChangePublishedState(PublishedState.Unpublished);
            Assert.IsTrue(content.ShouldClearPublishedFlagForPreviousVersions());
        }

        [Test]
        public void Should_Not_Clear_Published_Flag_When_Unpublishing_From_Saved()
        {
            var contentType = MockedContentTypes.CreateTextpageContentType();
            var content = MockedContent.CreateTextpageContent(contentType, &quot;Textpage&quot;, -1);

            content.ResetDirtyProperties(false);
            content.ChangePublishedState(PublishedState.Saved);
            content.ResetDirtyProperties(false);

            content.ChangePublishedState(PublishedState.Unpublished);
            Assert.IsFalse(content.ShouldClearPublishedFlagForPreviousVersions());
        }



    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,9,15,10,1],[16,13,16,78,1],[17,13,17,92,1],[19,13,19,49,1],[20,13,20,68,1],[21,13,21,49,1],[24,13,24,62,1],[26,13,26,64,1],[27,13,27,53,1],[28,9,28,10,1],[32,9,32,10,1],[33,13,33,78,1],[34,13,34,92,1],[36,13,36,49,1],[37,13,37,68,1],[38,13,38,49,1],[40,13,40,64,1],[41,13,41,54,1],[42,9,42,10,1],[46,9,46,10,1],[47,13,47,78,1],[48,13,48,92,1],[50,13,50,49,1],[52,13,52,68,1],[53,13,53,61,1],[54,9,54,10,1],[58,9,58,10,1],[59,13,59,78,1],[60,13,60,92,1],[62,13,62,49,1],[63,13,63,68,1],[64,13,64,49,1],[67,13,67,62,1],[69,13,69,64,1],[70,13,70,61,1],[71,9,71,10,1],[75,9,75,10,1],[76,13,76,78,1],[77,13,77,92,1],[79,13,79,49,1],[81,13,81,40,1],[82,13,82,87,1],[83,9,83,10,1],[87,9,87,10,1],[88,13,88,78,1],[89,13,89,92,1],[91,13,91,49,1],[93,13,93,62,1],[94,13,94,85,1],[95,9,95,10,1],[99,9,99,10,1],[100,13,100,78,1],[101,13,101,92,1],[103,13,103,49,1],[105,13,105,88,1],[106,9,106,10,1],[110,9,110,10,1],[111,13,111,78,1],[112,13,112,92,1],[114,13,114,49,1],[116,13,116,62,1],[117,13,117,88,1],[118,9,118,10,1],[122,9,122,10,1],[123,13,123,78,1],[124,13,124,92,1],[126,13,126,49,1],[128,13,128,68,1],[129,13,129,82,1],[130,9,130,10,1],[134,9,134,10,1],[135,13,135,78,1],[136,13,136,92,1],[138,13,138,49,1],[139,13,139,68,1],[140,13,140,49,1],[142,13,142,64,1],[143,13,143,83,1],[144,9,144,10,1],[148,9,148,10,1],[149,13,149,78,1],[150,13,150,92,1],[152,13,152,49,1],[153,13,153,68,1],[154,13,154,49,1],[156,13,156,70,1],[157,13,157,82,1],[158,9,158,10,1],[162,9,162,10,1],[163,13,163,78,1],[164,13,164,92,1],[166,13,166,49,1],[167,13,167,64,1],[168,13,168,49,1],[170,13,170,70,1],[171,13,171,83,1],[172,9,172,10,1]]);
    </script>
  </body>
</html>