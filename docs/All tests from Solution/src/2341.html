<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.MacroEngines\RazorDataTypeModels\HtmlStringDataTypeModel.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web;
using Umbraco.Core;
using Umbraco.Core.Macros;
using Umbraco.Web;

namespace umbraco.MacroEngines.RazorDataTypeModels
{
	/// &lt;summary&gt;
	/// This ensures that the RTE renders with HtmlString encoding and also ensures that the macro contents in it
	/// render properly too.
	/// &lt;/summary&gt;
    [RazorDataTypeModel(Constants.PropertyEditors.TinyMCEv3, 90)]
    public class HtmlStringDataTypeModel : IRazorDataTypeModel
    {
        public bool Init(int CurrentNodeId, string PropertyData, out object instance)
        {
			//we&#39;re going to send the string through the macro parser and create the output string.
			if (UmbracoContext.Current != null)
			{
				var sb = new StringBuilder();
				var umbracoHelper = new UmbracoHelper(UmbracoContext.Current);
				MacroTagParser.ParseMacros(
					PropertyData,
					//callback for when text block is found
					textBlock =&gt; sb.Append(textBlock),
					//callback for when macro syntax is found
					(macroAlias, macroAttributes) =&gt; sb.Append(umbracoHelper.RenderMacro(
						macroAlias,
						//needs to be explicitly casted to Dictionary&lt;string, object&gt;
						macroAttributes.ConvertTo(x =&gt; (string)x, x =&gt; (object)x)).ToString()));
				instance = new HtmlString(sb.ToString());
			}			
			else
			{
				//we have no umbraco context, so best we can do is convert to html string
				instance = new HtmlString(PropertyData);
			}			
            return true;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[22,4,22,39,1],[23,4,23,5,1],[24,5,24,34,1],[25,5,25,67,1],[26,5,29,19,1],[29,19,29,39,1],[29,39,31,39,1],[31,39,34,38,0],[34,38,34,47,0],[34,47,34,54,0],[34,54,34,63,0],[34,63,34,77,0],[31,39,34,77,0],[34,77,34,79,1],[26,5,34,79,1],[35,5,35,46,1],[36,4,36,5,1],[38,4,38,5,0],[40,5,40,45,0],[41,4,41,5,0],[42,13,42,25,1],[43,9,43,10,1]]);
    </script>
  </body>
</html>