<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\ApplicationUrlHelperTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Configuration;
using System.IO;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.Profiling;
using Umbraco.Core.Sync;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests
{
    [TestFixture]
    public class ApplicationUrlHelperTests
    {
        private ILogger _logger;

        // note: in tests, read appContext._umbracoApplicationUrl and not the property,
        // because reading the property does run some code, as long as the field is null.

        [TestFixtureSetUp]
        public void InitializeFixture()
        {
            _logger = new Logger(new FileInfo(TestHelper.MapPathForTest(&quot;~/unit-test-log4net.config&quot;)));
        }

        private static void Initialize(IUmbracoSettingsSection settings)
        {
            ServerRegistrarResolver.Current = new ServerRegistrarResolver(new ConfigServerRegistrar(settings.DistributedCall));
            Resolution.Freeze();
        }

        [TearDown]
        public void Reset()
        {
            ServerRegistrarResolver.Reset();
        }

        [Test]
        public void NoApplicationUrlByDefault()
        {
            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            Assert.IsNull(appCtx._umbracoApplicationUrl);
        }

        [Test]
        public void SetApplicationUrlViaProvider()
        {
            // no applicable settings, but a provider

            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Servers == Enumerable.Empty&lt;IServer&gt;())
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string)null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;());

            ApplicationUrlHelper.ApplicationUrlProvider = request =&gt; &quot;http://server1.com/umbraco&quot;;

            Initialize(settings);

            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ConfigurationManager.AppSettings.Set(&quot;umbracoUseSSL&quot;, &quot;true&quot;); // does not make a diff here

            ApplicationUrlHelper.EnsureApplicationUrl(appCtx, settings: settings);

            Assert.AreEqual(&quot;http://server1.com/umbraco&quot;, appCtx._umbracoApplicationUrl);
        }

        [Test]
        public void SetApplicationUrlWhenNoSettings()
        {
            // no applicable settings, cannot set url

            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Servers == Enumerable.Empty&lt;IServer&gt;())
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string) null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;());

            Initialize(settings);

            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ConfigurationManager.AppSettings.Set(&quot;umbracoUseSSL&quot;, &quot;true&quot;); // does not make a diff here

            ApplicationUrlHelper.TrySetApplicationUrl(appCtx, settings);

            // still NOT set
            Assert.IsNull(appCtx._umbracoApplicationUrl);
        }

        [Test]
        public void SetApplicationUrlFromDcSettingsSsl1()
        {
            // set from distributed call settings
            // first server is master server

            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Enabled == true &amp;&amp; callSection.Servers == new IServer[]
                {
                    Mock.Of&lt;IServer&gt;(server =&gt; server.ServerName == NetworkHelper.MachineName &amp;&amp; server.ServerAddress == &quot;server1.com&quot;),
                    Mock.Of&lt;IServer&gt;(server =&gt; server.ServerName == &quot;ANOTHERNAME&quot; &amp;&amp; server.ServerAddress == &quot;server2.com&quot;),
                })
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string)null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == (string)null));

            Initialize(settings);

            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ConfigurationManager.AppSettings.Set(&quot;umbracoUseSSL&quot;, &quot;true&quot;);

            ApplicationUrlHelper.TrySetApplicationUrl(appCtx, settings);

            Assert.AreEqual(&quot;http://server1.com:80/umbraco&quot;, appCtx._umbracoApplicationUrl);

            var registrar = ServerRegistrarResolver.Current.Registrar as IServerRegistrar2;
            var role = registrar.GetCurrentServerRole();
            Assert.AreEqual(ServerRole.Master, role);
        }

        [Test]
        public void SetApplicationUrlFromDcSettingsSsl2()
        {
            // set from distributed call settings
            // other servers are slave servers

            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Enabled == true &amp;&amp; callSection.Servers == new IServer[]
                {
                    Mock.Of&lt;IServer&gt;(server =&gt; server.ServerName == &quot;ANOTHERNAME&quot; &amp;&amp; server.ServerAddress == &quot;server2.com&quot;),
                    Mock.Of&lt;IServer&gt;(server =&gt; server.ServerName == NetworkHelper.MachineName &amp;&amp; server.ServerAddress == &quot;server1.com&quot;),
                })
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string)null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == (string)null));

            Initialize(settings);

            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ConfigurationManager.AppSettings.Set(&quot;umbracoUseSSL&quot;, &quot;true&quot;);

            ApplicationUrlHelper.TrySetApplicationUrl(appCtx, settings);

            Assert.AreEqual(&quot;http://server1.com:80/umbraco&quot;, appCtx._umbracoApplicationUrl);

            var registrar = ServerRegistrarResolver.Current.Registrar as IServerRegistrar2;
            var role = registrar.GetCurrentServerRole();
            Assert.AreEqual(ServerRole.Slave, role);
        }

        [Test]
        public void SetApplicationUrlFromDcSettingsSsl3()
        {
            // set from distributed call settings
            // cannot set if not enabled

            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Enabled == false &amp;&amp; callSection.Servers == new IServer[]
                {
                    Mock.Of&lt;IServer&gt;(server =&gt; server.ServerName == &quot;ANOTHERNAME&quot; &amp;&amp; server.ServerAddress == &quot;server2.com&quot;),
                    Mock.Of&lt;IServer&gt;(server =&gt; server.ServerName == NetworkHelper.MachineName &amp;&amp; server.ServerAddress == &quot;server1.com&quot;),
                })
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string)null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == (string)null));

            Initialize(settings);

            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ConfigurationManager.AppSettings.Set(&quot;umbracoUseSSL&quot;, &quot;true&quot;);

            ApplicationUrlHelper.TrySetApplicationUrl(appCtx, settings);

            Assert.IsNull(appCtx._umbracoApplicationUrl);

            var registrar = ServerRegistrarResolver.Current.Registrar as IServerRegistrar2;
            var role = registrar.GetCurrentServerRole();
            Assert.AreEqual(ServerRole.Single, role);
        }

        [Test]
        public void ServerRoleSingle()
        {
            // distributed call settings disabled, single server

            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Enabled == false &amp;&amp; callSection.Servers == Enumerable.Empty&lt;IServer&gt;())
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string)null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == (string)null));

            Initialize(settings);

            var registrar = ServerRegistrarResolver.Current.Registrar as IServerRegistrar2;
            var role = registrar.GetCurrentServerRole();
            Assert.AreEqual(ServerRole.Single, role);
        }

        [Test]
        public void ServerRoleUnknown1()
        {
            // distributed call enabled but missing servers, unknown server

            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Enabled == true &amp;&amp; callSection.Servers == Enumerable.Empty&lt;IServer&gt;())
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string)null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == (string)null));

            Initialize(settings);

            var registrar = ServerRegistrarResolver.Current.Registrar as IServerRegistrar2;
            var role = registrar.GetCurrentServerRole();
            Assert.AreEqual(ServerRole.Unknown, role);
        }

        [Test]
        public void ServerRoleUnknown2()
        {
            // distributed call enabled, cannot find server, assume it&#39;s an undeclared slave

            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Enabled == true &amp;&amp; callSection.Servers == new IServer[]
                {
                    Mock.Of&lt;IServer&gt;(server =&gt; server.ServerName == &quot;ANOTHERNAME&quot; &amp;&amp; server.ServerAddress == &quot;server2.com&quot;),
                })
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string)null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == (string)null));

            Initialize(settings);

            var registrar = ServerRegistrarResolver.Current.Registrar as IServerRegistrar2;
            var role = registrar.GetCurrentServerRole();
            Assert.AreEqual(ServerRole.Slave, role);
        }

        [Test]
        public void SetApplicationUrlFromStSettingsNoSsl()
        {
            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Servers == Enumerable.Empty&lt;IServer&gt;())
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string) null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == &quot;mycoolhost.com/umbraco&quot;));

            Initialize(settings);

            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ConfigurationManager.AppSettings.Set(&quot;umbracoUseSSL&quot;, &quot;false&quot;);

            ApplicationUrlHelper.TrySetApplicationUrl(appCtx, settings);

            Assert.AreEqual(&quot;http://mycoolhost.com/umbraco&quot;, appCtx._umbracoApplicationUrl);
        }

        [Test]
        public void SetApplicationUrlFromStSettingsSsl()
        {
            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Servers == Enumerable.Empty&lt;IServer&gt;())
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == (string) null)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == &quot;mycoolhost.com/umbraco/&quot;));

            Initialize(settings);

            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ConfigurationManager.AppSettings.Set(&quot;umbracoUseSSL&quot;, &quot;true&quot;);

            ApplicationUrlHelper.TrySetApplicationUrl(appCtx, settings);

            Assert.AreEqual(&quot;https://mycoolhost.com/umbraco&quot;, appCtx._umbracoApplicationUrl);
        }

        [Test]
        public void SetApplicationUrlFromWrSettingsSsl()
        {
            var settings = Mock.Of&lt;IUmbracoSettingsSection&gt;(section =&gt;
                section.DistributedCall == Mock.Of&lt;IDistributedCallSection&gt;(callSection =&gt; callSection.Servers == Enumerable.Empty&lt;IServer&gt;())
                &amp;&amp; section.WebRouting == Mock.Of&lt;IWebRoutingSection&gt;(wrSection =&gt; wrSection.UmbracoApplicationUrl == &quot;httpx://whatever.com/umbraco/&quot;)
                &amp;&amp; section.ScheduledTasks == Mock.Of&lt;IScheduledTasksSection&gt;(tasksSection =&gt; tasksSection.BaseUrl == &quot;mycoolhost.com/umbraco&quot;));

            Initialize(settings);

            var appCtx = new ApplicationContext(CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            ConfigurationManager.AppSettings.Set(&quot;umbracoUseSSL&quot;, &quot;true&quot;); // does not make a diff here

            ApplicationUrlHelper.TrySetApplicationUrl(appCtx, settings);

            Assert.AreEqual(&quot;httpx://whatever.com/umbraco&quot;, appCtx._umbracoApplicationUrl);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,1],[27,13,27,105,1],[28,9,28,10,1],[31,9,31,10,1],[32,13,32,128,1],[33,13,33,33,1],[34,9,34,10,1],[38,9,38,10,1],[39,13,39,45,1],[40,9,40,10,1],[44,9,44,10,1],[45,13,46,80,1],[47,13,47,58,1],[48,9,48,10,1],[52,9,52,10,1],[55,13,58,81,1],[60,13,60,70,1],[60,70,60,98,1],[60,98,60,99,1],[60,13,60,99,1],[62,13,62,34,1],[64,13,65,80,1],[67,13,67,75,1],[69,13,69,83,1],[71,13,71,90,1],[72,9,72,10,1],[76,9,76,10,1],[79,13,82,81,1],[84,13,84,34,1],[86,13,87,80,1],[89,13,89,75,1],[91,13,91,73,1],[94,13,94,58,1],[95,9,95,10,1],[99,9,99,10,1],[103,13,110,133,1],[112,13,112,34,1],[114,13,115,79,1],[117,13,117,75,1],[119,13,119,73,1],[121,13,121,93,1],[123,13,123,92,1],[124,13,124,57,1],[125,13,125,54,1],[126,9,126,10,1],[130,9,130,10,1],[134,13,141,133,1],[143,13,143,34,1],[145,13,146,79,1],[148,13,148,75,1],[150,13,150,73,1],[152,13,152,93,1],[154,13,154,92,1],[155,13,155,57,1],[156,13,156,53,1],[157,9,157,10,1],[161,9,161,10,1],[165,13,172,133,1],[174,13,174,34,1],[176,13,177,79,1],[179,13,179,75,1],[181,13,181,73,1],[183,13,183,58,1],[185,13,185,92,1],[186,13,186,57,1],[187,13,187,54,1],[188,9,188,10,1],[192,9,192,10,1],[195,13,198,133,1],[200,13,200,34,1],[202,13,202,92,1],[203,13,203,57,1],[204,13,204,54,1],[205,9,205,10,1],[209,9,209,10,1],[212,13,215,133,1],[217,13,217,34,1],[219,13,219,92,1],[220,13,220,57,1],[221,13,221,55,1],[222,9,222,10,1],[226,9,226,10,1],[229,13,235,133,1],[237,13,237,34,1],[239,13,239,92,1],[240,13,240,57,1],[241,13,241,53,1],[242,9,242,10,1],[246,9,246,10,1],[247,13,250,145,1],[252,13,252,34,1],[254,13,255,79,1],[257,13,257,76,1],[259,13,259,73,1],[261,13,261,93,1],[262,9,262,10,1],[266,9,266,10,1],[267,13,270,146,1],[272,13,272,34,1],[274,13,275,79,1],[277,13,277,75,1],[279,13,279,73,1],[281,13,281,94,1],[282,9,282,10,1],[286,9,286,10,1],[287,13,290,145,1],[292,13,292,34,1],[294,13,295,79,1],[297,13,297,75,1],[299,13,299,73,1],[301,13,301,92,1],[302,9,302,10,1]]);
    </script>
  </body>
</html>