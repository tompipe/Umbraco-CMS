<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\Permission.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Specialized;
using System.Data;
using System.Linq;
using System.Runtime.CompilerServices;
using Umbraco.Core;
using Umbraco.Core.Events;
using umbraco.DataLayer;
using umbraco.cms.businesslogic;
using System.Collections.Generic;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Services;
using DeleteEventArgs = umbraco.cms.businesslogic.DeleteEventArgs;

namespace umbraco.BusinessLogic
{
    /// &lt;summary&gt;
    /// Summary description for Permission.
    /// &lt;/summary&gt;
    public class Permission
    {

        public int NodeId { get; private set; }
        public int UserId { get; private set; }
        public char PermissionId { get; private set; }

        /// &lt;summary&gt;
        /// Private constructor, this class cannot be directly instantiated
        /// &lt;/summary&gt;
        private Permission() { }
        
        public static void MakeNew(User User, CMSNode Node, char PermissionKey)
        {
            MakeNew(User, Node, PermissionKey, true);
        }

        private static void MakeNew(User user, IEnumerable&lt;CMSNode&gt; nodes, char permissionKey, bool raiseEvents)
        {
            var asArray = nodes.ToArray();

            ApplicationContext.Current.Services.UserService.AssignUserPermission(user.Id, permissionKey, asArray.Select(x =&gt; x.Id).ToArray());

            if (raiseEvents)
            {
                OnNew(new UserPermission(user, asArray, new[] { permissionKey }), new NewEventArgs());
            }
        }

        private static void MakeNew(User User, CMSNode Node, char PermissionKey, bool raiseEvents)
        {
            MakeNew(User, new[] {Node}, PermissionKey, raiseEvents);
        }

        /// &lt;summary&gt;
        /// Returns the permissions for a user
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;user&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IEnumerable&lt;Permission&gt; GetUserPermissions(User user)
        {
            var permissions = ApplicationContext.Current.Services.UserService.GetPermissions(user.UserEntity);

            return permissions.SelectMany(
                entityPermission =&gt; entityPermission.AssignedPermissions,
                (entityPermission, assignedPermission) =&gt; new Permission
                {
                    NodeId = entityPermission.EntityId,
                    PermissionId = assignedPermission[0],
                    UserId = entityPermission.UserId
                });

        }

        /// &lt;summary&gt;
        /// Returns the permissions for a node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;node&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IEnumerable&lt;Permission&gt; GetNodePermissions(CMSNode node)
        {
            var content = ApplicationContext.Current.Services.ContentService.GetById(node.Id);
            if (content == null) return Enumerable.Empty&lt;Permission&gt;();

            var permissions = ApplicationContext.Current.Services.ContentService.GetPermissionsForEntity(content);

            return permissions.SelectMany(
                entityPermission =&gt; entityPermission.AssignedPermissions,
                (entityPermission, assignedPermission) =&gt; new Permission
                {
                    NodeId = entityPermission.EntityId,
                    PermissionId = assignedPermission[0],
                    UserId = entityPermission.UserId
                });
        }

        /// &lt;summary&gt;
        /// Delets all permissions for the node/user combination
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;user&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;node&quot;&gt;&lt;/param&gt;
        public static void DeletePermissions(User user, CMSNode node)
        {
            DeletePermissions(user, node, true);
        }

        internal static void DeletePermissions(User user, CMSNode node, bool raiseEvents)
        {
            ApplicationContext.Current.Services.UserService.RemoveUserPermissions(user.Id, node.Id);
            if (raiseEvents)
            {
                OnDeleted(new UserPermission(user, node, null), new DeleteEventArgs());
            }
        }

        /// &lt;summary&gt;
        /// deletes all permissions for the user
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;user&quot;&gt;&lt;/param&gt;
        public static void DeletePermissions(User user)
        {
            ApplicationContext.Current.Services.UserService.RemoveUserPermissions(user.Id);

            OnDeleted(new UserPermission(user, Enumerable.Empty&lt;CMSNode&gt;(), null), new DeleteEventArgs());
        }

        public static void DeletePermissions(int iUserID, int[] iNodeIDs)
        {
            ApplicationContext.Current.Services.UserService.RemoveUserPermissions(iUserID, iNodeIDs);

            OnDeleted(new UserPermission(iUserID, iNodeIDs), new DeleteEventArgs());
        }
        public static void DeletePermissions(int iUserID, int iNodeID)
        {
            DeletePermissions(iUserID, new[] { iNodeID });
        }

        /// &lt;summary&gt;
        /// delete all permissions for this node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;node&quot;&gt;&lt;/param&gt;
        public static void DeletePermissions(CMSNode node)
        {
            ApplicationContext.Current.Services.ContentService.RemoveContentPermissions(node.Id);
            
            OnDeleted(new UserPermission(null, node, null), new DeleteEventArgs());
        }

        public static void UpdateCruds(User user, CMSNode node, string permissions)
        {
            ApplicationContext.Current.Services.UserService.ReplaceUserPermissions(
                user.Id, 
                permissions.ToCharArray(), 
                node.Id);

            OnUpdated(new UserPermission(user, node, permissions.ToCharArray()), new SaveEventArgs());
        }

        internal static event TypedEventHandler&lt;UserPermission, DeleteEventArgs&gt; Deleted;
        private static void OnDeleted(UserPermission permission, DeleteEventArgs args)
        {
            if (Deleted != null)
            {
                Deleted(permission, args);
            }
        }

        internal static event TypedEventHandler&lt;UserPermission, SaveEventArgs&gt; Updated;
        private static void OnUpdated(UserPermission permission, SaveEventArgs args)
        {
            if (Updated != null)
            {
                Updated(permission, args);
            }
        }

        internal static event TypedEventHandler&lt;UserPermission, NewEventArgs&gt; New;
        private static void OnNew(UserPermission permission, NewEventArgs args)
        {
            if (New != null)
            {
                New(permission, args);
            }
        }

    }

    internal class UserPermission
    {
        private int? _userId;
        private readonly int[] _nodeIds;

        internal UserPermission(int userId)
        {
            _userId = userId;
        }

        internal UserPermission(int userId, IEnumerable&lt;int&gt; nodeIds)
        {
            _userId = userId;
            _nodeIds = nodeIds.ToArray();
        }

        internal UserPermission(User user, CMSNode node, char[] permissionKeys)
        {
            User = user;
            Nodes = new[] { node };
            PermissionKeys = permissionKeys;
        }

        internal UserPermission(User user, IEnumerable&lt;CMSNode&gt; nodes, char[] permissionKeys)
        {
            User = user;
            Nodes = nodes;
            PermissionKeys = permissionKeys;
        }

        internal int UserId
        {
            get
            {
                if (_userId.HasValue)
                {
                    return _userId.Value;
                }
                if (User != null)
                {
                    return User.Id;
                }
                return -1;
            }
        }

        internal IEnumerable&lt;int&gt; NodeIds
        {
            get
            {
                if (_nodeIds != null)
                {
                    return _nodeIds;
                }
                if (Nodes != null)
                {
                    return Nodes.Select(x =&gt; x.Id);
                }
                return Enumerable.Empty&lt;int&gt;();
            }
        }

        internal User User { get; private set; }
        internal IEnumerable&lt;CMSNode&gt; Nodes { get; private set; }
        internal char[] PermissionKeys { get; private set; }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,29,24,33,0],[24,34,24,46,0],[25,29,25,33,0],[25,34,25,46,0],[26,36,26,40,0],[26,41,26,53,0],[31,9,31,29,0],[31,30,31,31,0],[31,32,31,33,0],[34,9,34,10,0],[35,13,35,54,0],[36,9,36,10,0],[39,9,39,10,0],[40,13,40,43,0],[42,13,42,126,0],[42,126,42,130,0],[42,130,42,143,0],[42,13,42,143,0],[44,13,44,29,0],[45,13,45,14,0],[46,17,46,103,0],[47,13,47,14,0],[48,9,48,10,0],[51,9,51,10,0],[52,13,52,69,0],[53,9,53,10,0],[61,9,61,10,0],[62,13,62,111,0],[64,13,65,37,0],[65,37,65,73,0],[65,73,66,59,0],[66,59,71,18,0],[71,18,71,20,0],[64,13,71,20,0],[73,9,73,10,0],[81,9,81,10,0],[82,13,82,95,0],[83,13,83,33,0],[83,34,83,72,0],[85,13,85,115,0],[87,13,88,37,0],[88,37,88,73,0],[88,73,89,59,0],[89,59,94,18,0],[94,18,94,20,0],[87,13,94,20,0],[95,9,95,10,0],[103,9,103,10,0],[104,13,104,49,0],[105,9,105,10,0],[108,9,108,10,0],[109,13,109,101,0],[110,13,110,29,0],[111,13,111,14,0],[112,17,112,88,0],[113,13,113,14,0],[114,9,114,10,0],[121,9,121,10,0],[122,13,122,92,0],[124,13,124,107,0],[125,9,125,10,0],[128,9,128,10,0],[129,13,129,102,0],[131,13,131,85,0],[132,9,132,10,0],[134,9,134,10,0],[135,13,135,59,0],[136,9,136,10,0],[143,9,143,10,0],[144,13,144,98,0],[146,13,146,84,0],[147,9,147,10,0],[150,9,150,10,0],[151,13,154,26,0],[156,13,156,103,0],[157,9,157,10,0],[161,9,161,10,0],[162,13,162,33,0],[163,13,163,14,0],[164,17,164,43,0],[165,13,165,14,0],[166,9,166,10,0],[170,9,170,10,0],[171,13,171,33,0],[172,13,172,14,0],[173,17,173,43,0],[174,13,174,14,0],[175,9,175,10,0],[179,9,179,10,0],[180,13,180,29,0],[181,13,181,14,0],[182,17,182,39,0],[183,13,183,14,0],[184,9,184,10,0],[193,9,193,44,0],[194,9,194,10,0],[195,13,195,30,0],[196,9,196,10,0],[198,9,198,70,0],[199,9,199,10,0],[200,13,200,30,0],[201,13,201,42,0],[202,9,202,10,0],[204,9,204,80,0],[205,9,205,10,0],[206,13,206,25,0],[207,13,207,36,0],[208,13,208,45,0],[209,9,209,10,0],[211,9,211,94,0],[212,9,212,10,0],[213,13,213,25,0],[214,13,214,27,0],[215,13,215,45,0],[216,9,216,10,0],[221,13,221,14,0],[222,17,222,38,0],[223,17,223,18,0],[224,21,224,42,0],[226,17,226,34,0],[227,17,227,18,0],[228,21,228,36,0],[230,17,230,27,0],[231,13,231,14,0],[237,13,237,14,0],[238,17,238,38,0],[239,17,239,18,0],[240,21,240,37,0],[242,17,242,35,0],[243,17,243,18,0],[244,21,244,46,0],[244,46,244,50,0],[244,50,244,52,0],[244,21,244,52,0],[246,17,246,48,0],[247,13,247,14,0],[250,30,250,34,0],[250,35,250,47,0],[251,47,251,51,0],[251,52,251,64,0],[252,42,252,46,0],[252,47,252,59,0]]);
    </script>
  </body>
</html>