<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\rollBack.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using umbraco.BasePages;
using umbraco.cms.businesslogic.web;
using umbraco.cms.businesslogic.property;

namespace umbraco.presentation.dialogs
{
	/// &lt;summary&gt;
	/// Summary description for rollBack.
	/// &lt;/summary&gt;
	public partial class rollBack : UmbracoEnsuredPage
	{
	    public rollBack()
	    {
            CurrentApp = BusinessLogic.DefaultApps.content.ToString();

	    }
        private Document currentDoc = new Document(int.Parse(helper.Request(&quot;nodeId&quot;)));
        
        protected void version_load(object sender, EventArgs e) {

            if (allVersions.SelectedValue != &quot;&quot;)
            {
                diffPanel.Visible = true;
                Document rollback = new Document(currentDoc.Id, new Guid(allVersions.SelectedValue));

                propertiesCompare.Text = &quot;&lt;tr&gt;&lt;th style=&#39;width: 25%;&#39; valign=&#39;top&#39;&gt;&quot; + ui.Text(&quot;general&quot;, &quot;name&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot; + rollback.Text + &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
                propertiesCompare.Text += &quot;&lt;tr&gt;&lt;th style=&#39;width: 25%;&#39; valign=&#39;top&#39;&gt;&quot; + ui.Text(&quot;content&quot;, &quot;createDate&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot; + rollback.VersionDate.ToLongDateString() + &quot; &quot; + rollback.VersionDate.ToLongTimeString() + &quot; &quot; + ui.Text(&quot;general&quot;, &quot;by&quot;) + &quot;: &quot; + rollback.Writer.Name + &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;

                if (rbl_mode.SelectedValue == &quot;diff&quot;)
                    lt_notice.Text = ui.Text(&quot;rollback&quot;, &quot;diffHelp&quot;);
                else
                    lt_notice.Text = ui.Text(&quot;rollback&quot;, &quot;htmlHelp&quot;);


                var props = rollback.GenericProperties;
                foreach (Property p in props)
                {
                    try
                    {

                        if (p.Value != null)
                        {

                            //new property value... 
                            string thevalue = p.Value.ToString();

                            if (rbl_mode.SelectedValue == &quot;diff&quot;)
                            {

                                //if display mode is set to diff...
                                thevalue = library.StripHtml(p.Value.ToString());
                                Property cP = currentDoc.getProperty(p.PropertyType);
                                if (cP != null &amp;&amp; cP.Value != null)
                                {

                                    string cThevalue = library.StripHtml(cP.Value.ToString());

                                    propertiesCompare.Text += &quot;&lt;tr&gt;&lt;th style=&#39;width: 25%;&#39; valign=&#39;top&#39;&gt;&quot; + p.PropertyType.Name + &quot;:&lt;/th&gt;&lt;td&gt;&quot; + library.ReplaceLineBreaks(cms.businesslogic.utilities.Diff.Diff2Html(cThevalue, thevalue)) + &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;


                                }
                                else
                                {
                                    //If no current version of the value... display with no diff.
                                    propertiesCompare.Text += &quot;&lt;tr&gt;&lt;th style=&#39;width: 25%;&#39; valign=&#39;top&#39;&gt;&quot; + p.PropertyType.Name + &quot;:&lt;/th&gt;&lt;td&gt;&quot; + thevalue + &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
                                }


                            }
                            else
                            {
                                //If display mode is html
                                propertiesCompare.Text += &quot;&lt;tr&gt;&lt;th style=&#39;width: 25%;&#39; valign=&#39;top&#39;&gt;&quot; + p.PropertyType.Name + &quot;:&lt;/th&gt;&lt;td&gt;&quot; + thevalue + &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;
                            }

                            //previewVersionContent.Controls.Add(new LiteralControl(&quot;&lt;div style=\&quot;margin-top: 4px; border: 1px solid #DEDEDE; padding: 4px;\&quot;&gt;&lt;p style=\&quot;padding: 0px; margin: 0px;\&quot; class=\&quot;guiDialogNormal\&quot;&gt;&lt;b&gt;&quot; + p.PropertyType.Name + &quot;&lt;/b&gt;&lt;br/&gt;&quot;));
                            //previewVersionContent.Controls.Add(new LiteralControl(thevalue));

                        }
                        //previewVersionContent.Controls.Add(new LiteralControl(&quot;&lt;/p&gt;&lt;/div&gt;&quot;));
                    }
                    catch { }
                }

                Button1.Visible = true;
                

            }
            else
            {
                diffPanel.Visible = false;
                Button1.Visible = false;
            }

        }

		protected void Page_Load(object sender, System.EventArgs e)
		{

            if (String.IsNullOrEmpty(allVersions.SelectedValue))
                rbl_mode.AutoPostBack = false;
            else
                rbl_mode.AutoPostBack = true;

            currentVersionTitle.Text = currentDoc.Text;
            currentVersionMeta.Text = ui.Text(&quot;content&quot;, &quot;createDate&quot;) + &quot;: &quot; + currentDoc.VersionDate.ToShortDateString() + &quot; &quot; + currentDoc.VersionDate.ToShortTimeString();

            if (!IsPostBack) {
                allVersions.Items.Add(new ListItem(ui.Text(&quot;rollback&quot;, &quot;selectVersion&quot;)+ &quot;...&quot;, &quot;&quot;));
                foreach (DocumentVersionList dl in currentDoc.GetVersions()) {
                    allVersions.Items.Add(new ListItem(dl.Text + &quot; (&quot; + ui.Text(&quot;content&quot;, &quot;createDate&quot;) + &quot;: &quot; + dl.Date.ToShortDateString() + &quot; &quot; + dl.Date.ToShortTimeString() + &quot;)&quot;, dl.Version.ToString()));
                }
                Button1.Text = ui.Text(&quot;actions&quot;, &quot;rollback&quot;);
            }
		}

		#region Web Form Designer generated code
		override protected void OnInit(EventArgs e)
		{
			//
			// CODEGEN: This call is required by the ASP.NET Web Form Designer.
			//
			InitializeComponent();
			base.OnInit(e);
		}
		
		/// &lt;summary&gt;
		/// Required method for Designer support - do not modify
		/// the contents of this method with the code editor.
		/// &lt;/summary&gt;
		private void InitializeComponent()
		{    

		}
		#endregion

		protected void doRollback_Click(object sender, System.EventArgs e)
		{
            if (allVersions.SelectedValue.Trim() != &quot;&quot;) {
                Document d = new Document(int.Parse(helper.Request(&quot;nodeId&quot;)));
                d.RollBack(new Guid(allVersions.SelectedValue), base.getUser());
                
                BusinessLogic.Log.Add(BusinessLogic.LogTypes.RollBack, base.getUser(), d.Id, &quot;Version rolled back to revision &#39;&quot; + allVersions.SelectedValue + &quot;&#39;&quot;);
                
                Document rollback = new Document(d.Id, new Guid(allVersions.SelectedValue));
                feedBackMsg.type = global::umbraco.uicontrols.Feedback.feedbacktype.success;
                string[] vars = {rollback.Text, rollback.VersionDate.ToLongDateString()};
                
                feedBackMsg.Text = ui.Text(&quot;rollback&quot;, &quot;documentRolledBack&quot;, vars, new global::umbraco.BusinessLogic.User(0)) + &quot;&lt;/p&gt;&lt;p&gt;&lt;a href=&#39;#&#39; onclick=&#39;&quot; + ClientTools.Scripts.CloseModalWindow() + &quot;&#39;&gt;&quot; + ui.Text(&quot;closeThisWindow&quot;) + &quot;&lt;/a&gt;&quot;;
                diffPanel.Visible = false;
                pl_buttons.Visible = false;
            }
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,6,22,23,0],[23,6,23,7,0],[24,13,24,71,0],[26,6,26,7,0],[27,9,27,89,0],[29,65,29,66,0],[31,13,31,49,0],[32,13,32,14,0],[33,17,33,42,0],[34,17,34,102,0],[36,17,36,161,0],[37,17,37,305,0],[39,17,39,54,0],[40,21,40,70,0],[42,21,42,70,0],[45,17,45,56,0],[46,17,46,24,0],[46,26,46,36,0],[46,37,46,39,0],[46,40,46,45,0],[47,17,47,18,0],[49,21,49,22,0],[51,25,51,45,0],[52,25,52,26,0],[55,29,55,66,0],[57,29,57,66,0],[58,29,58,30,0],[61,33,61,82,0],[62,33,62,86,0],[63,33,63,68,0],[64,33,64,34,0],[66,37,66,95,0],[68,37,68,252,0],[71,33,71,34,0],[73,33,73,34,0],[75,37,75,170,0],[76,33,76,34,0],[79,29,79,30,0],[81,29,81,30,0],[83,33,83,166,0],[84,29,84,30,0],[89,25,89,26,0],[91,21,91,22,0],[92,21,92,26,0],[92,27,92,28,0],[92,29,92,30,0],[93,17,93,18,0],[95,17,95,40,0],[98,13,98,14,0],[100,13,100,14,0],[101,17,101,43,0],[102,17,102,41,0],[103,13,103,14,0],[105,9,105,10,0],[108,3,108,4,0],[110,13,110,65,0],[111,17,111,47,0],[113,17,113,46,0],[115,13,115,56,0],[116,13,116,175,0],[118,13,118,29,0],[118,30,118,31,0],[119,17,119,102,0],[120,17,120,24,0],[120,26,120,48,0],[120,49,120,51,0],[120,52,120,76,0],[120,78,120,79,0],[121,21,121,210,0],[122,17,122,18,0],[123,17,123,63,0],[124,13,124,14,0],[125,3,125,4,0],[129,3,129,4,0],[133,4,133,26,0],[134,4,134,19,0],[135,3,135,4,0],[142,3,142,4,0],[144,3,144,4,0],[148,3,148,4,0],[149,13,149,56,0],[149,57,149,58,0],[150,17,150,80,0],[151,17,151,81,0],[153,17,153,165,0],[155,17,155,93,0],[156,17,156,93,0],[157,17,157,90,0],[159,17,159,246,0],[160,17,160,43,0],[161,17,161,44,0],[162,13,162,14,0],[163,3,163,4,0]]);
    </script>
  </body>
</html>