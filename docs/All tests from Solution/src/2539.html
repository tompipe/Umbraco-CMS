<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.controls\CodeArea.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using ClientDependency.Core;
using System.Linq;
using ClientDependency.Core.Controls;
using Umbraco.Core.Configuration;

namespace umbraco.uicontrols
{

    [ClientDependency(ClientDependencyType.Javascript, &quot;CodeArea/javascript.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;CodeArea/UmbracoEditor.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Css, &quot;CodeArea/styles.css&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;Application/jQuery/jquery-fieldselection.js&quot;, &quot;UmbracoClient&quot;)]
    public class CodeArea : WebControl
    {

        public CodeArea()
        {
            //set the default to Css
            CodeBase = EditorType.Css;
        }

        protected TextBox CodeTextBox;

        public bool AutoResize { get; set; }
        public bool AutoSuggest { get; set; }
        public string EditorMimeType { get; set; }

        public ScrollingMenu Menu = new ScrollingMenu();

        public int OffSetX { get; set; }
        public int OffSetY { get; set; }
        public string Text
        {
            get
            {
                EnsureChildControls();
                return CodeTextBox.Text;
            }
            set
            {
                EnsureChildControls();
                CodeTextBox.Text = value;
            }
        }

        public bool CodeMirrorEnabled
        {
            get
            {
                return UmbracoConfig.For.UmbracoSettings().Content.ScriptEditorDisable == false;
            }
        }

        public EditorType CodeBase { get; set; }
        public string ClientSaveMethod { get; set; }

        public enum EditorType { JavaScript, Css, Python, XML, HTML, Razor, HtmlMixed }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);
            EnsureChildControls();

            if (CodeMirrorEnabled)
            {
                ClientDependencyLoader.Instance.RegisterDependency(0, &quot;lib/CodeMirror/lib/codemirror.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);


                ClientDependencyLoader.Instance.RegisterDependency(2, &quot;lib/CodeMirror/mode/&quot; + CodeBase.ToString().ToLower() + &quot;/&quot; + CodeBase.ToString().ToLower() + &quot;.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);
                if (CodeBase == EditorType.HtmlMixed)
                {
                    ClientDependencyLoader.Instance.RegisterDependency(1, &quot;lib/CodeMirror/mode/xml/xml.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);
                    ClientDependencyLoader.Instance.RegisterDependency(1, &quot;lib/CodeMirror/mode/javascript/javascript.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);
                    ClientDependencyLoader.Instance.RegisterDependency(1, &quot;lib/CodeMirror/mode/css/css.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);
                    ClientDependencyLoader.Instance.RegisterDependency(1, &quot;lib/CodeMirror/mode/htmlmixed/htmlmixed.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);
                    
                }

                ClientDependencyLoader.Instance.RegisterDependency(1, &quot;lib/CodeMirror/addon/edit/matchbrackets.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);

                ClientDependencyLoader.Instance.RegisterDependency(2, &quot;lib/CodeMirror/addon/search/search.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);
                ClientDependencyLoader.Instance.RegisterDependency(2, &quot;lib/CodeMirror/addon/search/searchcursor.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);
                ClientDependencyLoader.Instance.RegisterDependency(2, &quot;lib/CodeMirror/addon/dialog/dialog.js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);
                ClientDependencyLoader.Instance.RegisterDependency(2, &quot;lib/CodeMirror/addon/dialog/dialog.css&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Css);

                ClientDependencyLoader.Instance.RegisterDependency(2, &quot;lib/CodeMirror/lib/codemirror.css&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Css);
                //ClientDependencyLoader.Instance.RegisterDependency(3, &quot;CodeMirror/css/umbracoCustom.css&quot;, &quot;UmbracoClient&quot;, ClientDependencyType.Css);
                ClientDependencyLoader.Instance.RegisterDependency(4, &quot;CodeArea/styles.css&quot;, &quot;UmbracoClient&quot;, ClientDependencyType.Css);
            }
        }

        protected override void CreateChildControls()
        {
            base.CreateChildControls();
            CodeTextBox = new TextBox();
            CodeTextBox.ID = &quot;CodeTextBox&quot;;

            if (CodeMirrorEnabled == false)
            {
                CodeTextBox.Attributes.Add(&quot;class&quot;, &quot;codepress&quot;);
                CodeTextBox.Attributes.Add(&quot;wrap&quot;, &quot;off&quot;);
            }

            CodeTextBox.TextMode = TextBoxMode.MultiLine;

            this.Controls.Add(Menu);
            this.Controls.Add(CodeTextBox);

        }

        /// &lt;summary&gt;
        /// Client ID is different if the code editor is turned on/off
        /// &lt;/summary&gt;
        public override string ClientID
        {
            get
            {
                if (CodeMirrorEnabled == false)
                    return CodeTextBox.ClientID;
                else
                    return base.ClientID;
            }
        }

        protected override void Render(HtmlTextWriter writer)
        {
            EnsureChildControls();

            var jsEventCode = new StringBuilder();


            if (CodeMirrorEnabled == false)
            {
                CodeTextBox.RenderControl(writer);
                jsEventCode.Append(RenderBasicEditor());
            }
            else
            {
                writer.WriteBeginTag(&quot;div&quot;);
                writer.WriteAttribute(&quot;id&quot;, this.ClientID);
                writer.WriteAttribute(&quot;class&quot;, &quot;umb-editor umb-codeeditor &quot; + this.CssClass);
                this.ControlStyle.AddAttributesToRender(writer);
                writer.Write(HtmlTextWriter.TagRightChar);
                Menu.RenderControl(writer);

                writer.WriteBeginTag(&quot;div&quot;);
                writer.WriteAttribute(&quot;class&quot;, &quot;code-container&quot;);
                this.ControlStyle.AddAttributesToRender(writer);
                writer.Write(HtmlTextWriter.TagRightChar);
                CodeTextBox.RenderControl(writer);
                writer.WriteEndTag(&quot;div&quot;);
                writer.WriteEndTag(&quot;div&quot;);

                jsEventCode.Append(RenderCodeEditor());
            }

            jsEventCode.Append(@&quot;   
					//TODO: for now this is a global var, need to refactor all this so that is using proper js standards
					//with correct objects, and proper accessors to these objects.
					var UmbEditor;                 
                    $(document).ready(function () {
                        //create the editor
                       UmbEditor = new Umbraco.Controls.CodeEditor.UmbracoEditor(&quot; + (CodeMirrorEnabled == false).ToString().ToLower() + @&quot;, &#39;&quot; + ClientID + @&quot;&#39;);&quot;);

            if (this.AutoResize)
            {
                if (CodeMirrorEnabled)
                {
                    //reduce the width if using code mirror because of the line numbers
                    OffSetX += 20;
                    OffSetY += 50;
                }

                //add the resize code
                jsEventCode.Append(@&quot;
                        var m_textEditor = jQuery(&#39;#&quot; + ClientID + @&quot;&#39;);
                   
                       //with codemirror adding divs for line numbers, we need to target a different element
                       m_textEditor = m_textEditor.find(&#39;iframe&#39;).length &gt; 0 ? m_textEditor.children(&#39;div&#39;).get(0) : m_textEditor.get(0);
                   
                       jQuery(window).resize(function(){  resizeTextArea(m_textEditor, &quot; + OffSetX + &quot;,&quot; + OffSetY + @&quot;); });
            	       jQuery(document).ready(function(){  resizeTextArea(m_textEditor, &quot; + OffSetX + &quot;,&quot; + OffSetY + @&quot;); });&quot;);

            }

            jsEventCode.Append(@&quot;                       
                    });&quot;);

            writer.WriteLine(@&quot;&lt;script type=&quot;&quot;text/javascript&quot;&quot;&gt;{0}&lt;/script&gt;&quot;, jsEventCode);

        }

        protected string RenderBasicEditor()
        {
            string jsEventCode = @&quot;                                   
                                    var m_textEditor = document.getElementById(&#39;&quot; + this.ClientID + @&quot;&#39;);                                   
                                    tab.watch(&#39;&quot; + this.ClientID + @&quot;&#39;);
                                    &quot;;
            return jsEventCode;
        }

        protected string RenderCodeEditor()
        {
            var extraKeys = &quot;&quot;;
            var editorMimetype = &quot;&quot;;

            if (string.IsNullOrEmpty(EditorMimeType) == false)
                editorMimetype = @&quot;, 
                                     mode: &quot;&quot;&quot; + EditorMimeType + &quot;\&quot;&quot;;



            var jsEventCode = @&quot;
                                var textarea = document.getElementById(&#39;&quot; + CodeTextBox.ClientID + @&quot;&#39;);
                                var codeEditor = CodeMirror.fromTextArea(textarea, {
                                                tabMode: &quot;&quot;shift&quot;&quot;,
                                                matchBrackets: true,
                                                indentUnit: 4,
                                                indentWithTabs: true,
                                                enterMode: &quot;&quot;keep&quot;&quot;,
                                                lineWrapping: false&quot; +
                                                editorMimetype + @&quot;,
                                                lineNumbers: true&quot; +
                                                extraKeys + @&quot;
                                                });                                    
                                &quot;;

            return jsEventCode;
        }
    }

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,26,0],[28,9,28,10,0],[30,13,30,39,0],[31,9,31,10,0],[35,34,35,38,0],[35,39,35,43,0],[36,35,36,39,0],[36,40,36,44,0],[37,40,37,44,0],[37,45,37,49,0],[39,9,39,57,0],[41,30,41,34,0],[41,35,41,39,0],[42,30,42,34,0],[42,35,42,39,0],[46,13,46,14,0],[47,17,47,39,0],[48,17,48,41,0],[49,13,49,14,0],[51,13,51,14,0],[52,17,52,39,0],[53,17,53,42,0],[54,13,54,14,0],[60,13,60,14,0],[61,17,61,97,0],[62,13,62,14,0],[65,38,65,42,0],[65,43,65,47,0],[66,42,66,46,0],[66,47,66,51,0],[71,9,71,10,0],[72,13,72,28,0],[73,13,73,35,0],[75,13,75,35,0],[76,13,76,14,0],[77,17,77,155,0],[80,17,80,221,0],[81,17,81,54,0],[82,17,82,18,0],[83,21,83,157,0],[84,21,84,171,0],[85,21,85,157,0],[86,21,86,169,0],[88,17,88,18,0],[90,17,90,165,0],[92,17,92,160,0],[93,17,93,166,0],[94,17,94,160,0],[95,17,95,154,0],[97,17,97,149,0],[99,17,99,137,0],[100,13,100,14,0],[101,9,101,10,0],[104,9,104,10,0],[105,13,105,40,0],[106,13,106,41,0],[107,13,107,44,0],[109,13,109,44,0],[110,13,110,14,0],[111,17,111,66,0],[112,17,112,59,0],[113,13,113,14,0],[115,13,115,58,0],[117,13,117,37,0],[118,13,118,44,0],[120,9,120,10,0],[128,13,128,14,0],[129,17,129,48,0],[130,21,130,49,0],[132,21,132,42,0],[133,13,133,14,0],[137,9,137,10,0],[138,13,138,35,0],[140,13,140,51,0],[143,13,143,44,0],[144,13,144,14,0],[145,17,145,51,0],[146,17,146,57,0],[147,13,147,14,0],[149,13,149,14,0],[150,17,150,45,0],[151,17,151,60,0],[152,17,152,94,0],[153,17,153,65,0],[154,17,154,59,0],[155,17,155,44,0],[157,17,157,45,0],[158,17,158,66,0],[159,17,159,65,0],[160,17,160,59,0],[161,17,161,51,0],[162,17,162,43,0],[163,17,163,43,0],[165,17,165,56,0],[166,13,166,14,0],[168,13,174,166,0],[176,13,176,33,0],[177,13,177,14,0],[178,17,178,39,0],[179,17,179,18,0],[181,21,181,35,0],[182,21,182,35,0],[183,17,183,18,0],[186,17,193,127,0],[195,13,195,14,0],[197,13,198,27,0],[200,13,200,93,0],[202,9,202,10,0],[205,9,205,10,0],[206,13,209,39,0],[210,13,210,32,0],[211,9,211,10,0],[214,9,214,10,0],[215,13,215,32,0],[216,13,216,37,0],[218,13,218,63,0],[219,17,220,72,0],[224,13,237,35,0],[239,13,239,32,0],[240,9,240,10,0]]);
    </script>
  </body>
</html>