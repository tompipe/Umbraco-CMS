<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PublishedContentQuery.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Xml.XPath;
using umbraco;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Dynamics;
using Umbraco.Core.Models;
using Umbraco.Core.Xml;
using Umbraco.Web.Models;
using Umbraco.Web.PublishedCache;

namespace Umbraco.Web
{
    /// &lt;summary&gt;
    /// A class used to query for published content, media items
    /// &lt;/summary&gt;
    public class PublishedContentQuery : ITypedPublishedContentQuery, IDynamicPublishedContentQuery
    {
        private readonly ITypedPublishedContentQuery _typedContentQuery;
        private readonly IDynamicPublishedContentQuery _dynamicContentQuery;
        private readonly ContextualPublishedContentCache _contentCache;
        private readonly ContextualPublishedMediaCache _mediaCache;

        /// &lt;summary&gt;
        /// Constructor used to return results from the caches
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentCache&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;mediaCache&quot;&gt;&lt;/param&gt;
        public PublishedContentQuery(ContextualPublishedContentCache contentCache, ContextualPublishedMediaCache mediaCache)
        {
            if (contentCache == null) throw new ArgumentNullException(&quot;contentCache&quot;);
            if (mediaCache == null) throw new ArgumentNullException(&quot;mediaCache&quot;);
            _contentCache = contentCache;
            _mediaCache = mediaCache;
        }

        /// &lt;summary&gt;
        /// Constructor used to wrap the ITypedPublishedContentQuery and IDynamicPublishedContentQuery objects passed in
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;typedContentQuery&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dynamicContentQuery&quot;&gt;&lt;/param&gt;
        public PublishedContentQuery(ITypedPublishedContentQuery typedContentQuery, IDynamicPublishedContentQuery dynamicContentQuery)
        {
            if (typedContentQuery == null) throw new ArgumentNullException(&quot;typedContentQuery&quot;);
            if (dynamicContentQuery == null) throw new ArgumentNullException(&quot;dynamicContentQuery&quot;);
            _typedContentQuery = typedContentQuery;
            _dynamicContentQuery = dynamicContentQuery;
        }

        #region Content

        public IPublishedContent TypedContent(int id)
        {
            return _typedContentQuery == null
                ? TypedDocumentById(id, _contentCache)
                : _typedContentQuery.TypedContent(id);
        }

        public IPublishedContent TypedContent(Guid id)
        {
            return _typedContentQuery == null
                ? TypedDocumentById(id, _contentCache)
                : _typedContentQuery.TypedContent(id);
        }

        public IPublishedContent TypedContentSingleAtXPath(string xpath, params XPathVariable[] vars)
        {
            return _typedContentQuery == null
                ? TypedDocumentByXPath(xpath, vars, _contentCache)
                : _typedContentQuery.TypedContentSingleAtXPath(xpath, vars);
        }
        
        public IEnumerable&lt;IPublishedContent&gt; TypedContent(IEnumerable&lt;int&gt; ids)
        {
            return _typedContentQuery == null
                ? TypedDocumentsByIds(_contentCache, ids)
                : _typedContentQuery.TypedContent(ids);
        }

        public IEnumerable&lt;IPublishedContent&gt; TypedContent(IEnumerable&lt;Guid&gt; ids)
        {
            return _typedContentQuery == null
                ? TypedDocumentsByIds(_contentCache, ids)
                : _typedContentQuery.TypedContent(ids);
        }

        public IEnumerable&lt;IPublishedContent&gt; TypedContentAtXPath(string xpath, params XPathVariable[] vars)
        {
            return _typedContentQuery == null
                ? TypedDocumentsByXPath(xpath, vars, _contentCache)
                : _typedContentQuery.TypedContentAtXPath(xpath, vars);
        }

        public IEnumerable&lt;IPublishedContent&gt; TypedContentAtXPath(XPathExpression xpath, params XPathVariable[] vars)
        {
            return _typedContentQuery == null
                ? TypedDocumentsByXPath(xpath, vars, _contentCache)
                : _typedContentQuery.TypedContentAtXPath(xpath, vars);
        }

        public IEnumerable&lt;IPublishedContent&gt; TypedContentAtRoot()
        {
            return _typedContentQuery == null
                ? TypedDocumentsAtRoot(_contentCache)
                : _typedContentQuery.TypedContentAtRoot();
        }

        public dynamic Content(int id)
        {
            return _dynamicContentQuery == null
                ? DocumentById(id, _contentCache, DynamicNull.Null)
                : _dynamicContentQuery.Content(id);
        }

        public dynamic Content(Guid id)
        {
            return _dynamicContentQuery == null
                ? DocumentById(id, _contentCache, DynamicNull.Null)
                : _dynamicContentQuery.Content(id);
        }

        public dynamic ContentSingleAtXPath(string xpath, params XPathVariable[] vars)
        {
            return _dynamicContentQuery == null
                ? DocumentByXPath(xpath, vars, _contentCache, DynamicNull.Null)
                : _dynamicContentQuery.ContentSingleAtXPath(xpath, vars);
        }

        public dynamic ContentSingleAtXPath(XPathExpression xpath, params XPathVariable[] vars)
        {
            return _dynamicContentQuery == null
                ? DocumentByXPath(xpath, vars, _contentCache, DynamicNull.Null)
                : _dynamicContentQuery.ContentSingleAtXPath(xpath, vars);
        }
        
        public dynamic Content(IEnumerable&lt;int&gt; ids)
        {
            return _dynamicContentQuery == null
                ? DocumentByIds(_contentCache, ids.ToArray())
                : _dynamicContentQuery.Content(ids);
        }

        public dynamic Content(IEnumerable&lt;Guid&gt; ids)
        {
            return _dynamicContentQuery == null
                ? DocumentByIds(_contentCache, ids.ToArray())
                : _dynamicContentQuery.Content(ids);
        }

        public dynamic ContentAtXPath(string xpath, params XPathVariable[] vars)
        {
            return _dynamicContentQuery == null
                ? DocumentsByXPath(xpath, vars, _contentCache)
                : _dynamicContentQuery.ContentAtXPath(xpath, vars);
        }

        public dynamic ContentAtXPath(XPathExpression xpath, params XPathVariable[] vars)
        {
            return _dynamicContentQuery == null
                ? DocumentsByXPath(xpath, vars, _contentCache)
                : _dynamicContentQuery.ContentAtXPath(xpath, vars);
        }

        public dynamic ContentAtRoot()
        {
            return _dynamicContentQuery == null
                ? DocumentsAtRoot(_contentCache)
                : _dynamicContentQuery.ContentAtRoot();
        }

        #endregion

        #region Media
        
        public IPublishedContent TypedMedia(int id)
        {
            return _typedContentQuery == null
                ? TypedDocumentById(id, _mediaCache)
                : _typedContentQuery.TypedMedia(id);
        }

        public IEnumerable&lt;IPublishedContent&gt; TypedMedia(IEnumerable&lt;int&gt; ids)
        {
            return _typedContentQuery == null
                ? TypedDocumentsByIds(_mediaCache, ids)
                : _typedContentQuery.TypedMedia(ids);
        }

        public IEnumerable&lt;IPublishedContent&gt; TypedMediaAtRoot()
        {
            return _typedContentQuery == null
                ? TypedDocumentsAtRoot(_mediaCache)
                : _typedContentQuery.TypedMediaAtRoot();
        }

        public dynamic Media(int id)
        {
            return _dynamicContentQuery == null
                ? DocumentById(id, _mediaCache, DynamicNull.Null)
                : _dynamicContentQuery.Media(id);
        }
        
        public dynamic Media(IEnumerable&lt;int&gt; ids)
        {
            return _dynamicContentQuery == null
                ? DocumentByIds(_mediaCache, ids)
                : _dynamicContentQuery.Media(ids);
        }

        public dynamic MediaAtRoot()
        {
            return _dynamicContentQuery == null
                ? DocumentsAtRoot(_mediaCache)
                : _dynamicContentQuery.MediaAtRoot();
        }

        #endregion

        #region Used by Content/Media

        private IPublishedContent TypedDocumentById(int id, ContextualPublishedCache cache)
        {
            var doc = cache.GetById(id);
            return doc;
        }

        private IPublishedContent TypedDocumentById(Guid id, ContextualPublishedCache cache)
        {
            // todo: in v8, implement in a more efficient way
            var legacyXml = UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema;
            var xpath = legacyXml ? &quot;//node [@key=$guid]&quot; : &quot;//* [@isDoc and @key=$guid]&quot;;
            var doc = cache.GetSingleByXPath(xpath, new XPathVariable(&quot;guid&quot;, id.ToString()));
            return doc;
        }

        private IPublishedContent TypedDocumentByXPath(string xpath, XPathVariable[] vars, ContextualPublishedContentCache cache)
        {
            var doc = cache.GetSingleByXPath(xpath, vars);
            return doc;
        }

        //NOTE: Not used?
        //private IPublishedContent TypedDocumentByXPath(XPathExpression xpath, XPathVariable[] vars, ContextualPublishedContentCache cache)
        //{
        //    var doc = cache.GetSingleByXPath(xpath, vars);
        //    return doc;
        //}        

        private IEnumerable&lt;IPublishedContent&gt; TypedDocumentsByIds(ContextualPublishedCache cache, IEnumerable&lt;int&gt; ids)
        {
            return ids.Select(eachId =&gt; TypedDocumentById(eachId, cache)).WhereNotNull();
        }

        private IEnumerable&lt;IPublishedContent&gt; TypedDocumentsByIds(ContextualPublishedCache cache, IEnumerable&lt;Guid&gt; ids)
        {
            // todo: in v8, implement in a more efficient way
            return ids.Select(eachId =&gt; TypedDocumentById(eachId, cache)).WhereNotNull();
        }

        private IEnumerable&lt;IPublishedContent&gt; TypedDocumentsByXPath(string xpath, XPathVariable[] vars, ContextualPublishedContentCache cache)
        {
            var doc = cache.GetByXPath(xpath, vars);
            return doc;
        }

        private IEnumerable&lt;IPublishedContent&gt; TypedDocumentsByXPath(XPathExpression xpath, XPathVariable[] vars, ContextualPublishedContentCache cache)
        {
            var doc = cache.GetByXPath(xpath, vars);
            return doc;
        }

        private IEnumerable&lt;IPublishedContent&gt; TypedDocumentsAtRoot(ContextualPublishedCache cache)
        {
            return cache.GetAtRoot();
        }

        private dynamic DocumentById(int id, ContextualPublishedCache cache, object ifNotFound)
        {
            var doc = cache.GetById(id);
            return doc == null
                       ? ifNotFound
                       : new DynamicPublishedContent(doc).AsDynamic();
        }

        private dynamic DocumentById(Guid id, ContextualPublishedCache cache, object ifNotFound)
        {
            var doc = TypedDocumentById(id, cache);
            return doc == null
                       ? ifNotFound
                       : new DynamicPublishedContent(doc).AsDynamic();
        }

        private dynamic DocumentByXPath(string xpath, XPathVariable[] vars, ContextualPublishedCache cache, object ifNotFound)
        {
            var doc = cache.GetSingleByXPath(xpath, vars);
            return doc == null
                       ? ifNotFound
                       : new DynamicPublishedContent(doc).AsDynamic();
        }

        private dynamic DocumentByXPath(XPathExpression xpath, XPathVariable[] vars, ContextualPublishedCache cache, object ifNotFound)
        {
            var doc = cache.GetSingleByXPath(xpath, vars);
            return doc == null
                       ? ifNotFound
                       : new DynamicPublishedContent(doc).AsDynamic();
        }

        private dynamic DocumentByIds(ContextualPublishedCache cache, IEnumerable&lt;int&gt; ids)
        {
            var dNull = DynamicNull.Null;
            var nodes = ids.Select(eachId =&gt; DocumentById(eachId, cache, dNull))
                           .Where(x =&gt; TypeHelper.IsTypeAssignableFrom&lt;DynamicNull&gt;(x) == false)
                           .Cast&lt;DynamicPublishedContent&gt;();
            return new DynamicPublishedContentList(nodes);
        }

        private dynamic DocumentByIds(ContextualPublishedCache cache, IEnumerable&lt;Guid&gt; ids)
        {
            var dNull = DynamicNull.Null;
            var nodes = ids.Select(eachId =&gt; DocumentById(eachId, cache, dNull))
                           .Where(x =&gt; TypeHelper.IsTypeAssignableFrom&lt;DynamicNull&gt;(x) == false)
                           .Cast&lt;DynamicPublishedContent&gt;();
            return new DynamicPublishedContentList(nodes);
        }

        private dynamic DocumentsByXPath(string xpath, XPathVariable[] vars, ContextualPublishedCache cache)
        {
            return new DynamicPublishedContentList(
                cache.GetByXPath(xpath, vars)
                     .Select(publishedContent =&gt; new DynamicPublishedContent(publishedContent))
                );
        }

        private dynamic DocumentsByXPath(XPathExpression xpath, XPathVariable[] vars, ContextualPublishedCache cache)
        {
            return new DynamicPublishedContentList(
                cache.GetByXPath(xpath, vars)
                     .Select(publishedContent =&gt; new DynamicPublishedContent(publishedContent))
                );
        }

        private dynamic DocumentsAtRoot(ContextualPublishedCache cache)
        {
            return new DynamicPublishedContentList(
                cache.GetAtRoot()
                     .Select(publishedContent =&gt; new DynamicPublishedContent(publishedContent))
                );
        }

        #endregion

        #region Search

        /// &lt;summary&gt;
        /// Searches content
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;term&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;useWildCards&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;searchProvider&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public dynamic Search(string term, bool useWildCards = true, string searchProvider = null)
        {
            return _dynamicContentQuery == null
                ? new DynamicPublishedContentList(
                    TypedSearch(term, useWildCards, searchProvider))
                : _dynamicContentQuery.Search(term, useWildCards, searchProvider);
        }

        /// &lt;summary&gt;
        /// Searhes content
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;criteria&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;searchProvider&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public dynamic Search(Examine.SearchCriteria.ISearchCriteria criteria, Examine.Providers.BaseSearchProvider searchProvider = null)
        {
            return _dynamicContentQuery == null
                ? new DynamicPublishedContentList(
                    TypedSearch(criteria, searchProvider))
                : _dynamicContentQuery.Search(criteria, searchProvider);
        }

        /// &lt;summary&gt;
        /// Searches content
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;term&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;useWildCards&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;searchProvider&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;IPublishedContent&gt; TypedSearch(string term, bool useWildCards = true, string searchProvider = null)
        {
            if (_typedContentQuery != null) return _typedContentQuery.TypedSearch(term, useWildCards, searchProvider);

            var searcher = Examine.ExamineManager.Instance.DefaultSearchProvider;
            if (string.IsNullOrEmpty(searchProvider) == false)
                searcher = Examine.ExamineManager.Instance.SearchProviderCollection[searchProvider];

            var results = searcher.Search(term, useWildCards);
            return results.ConvertSearchResultToPublishedContent(_contentCache);
        }

        /// &lt;summary&gt;
        /// Searhes content
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;criteria&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;searchProvider&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;IPublishedContent&gt; TypedSearch(Examine.SearchCriteria.ISearchCriteria criteria, Examine.Providers.BaseSearchProvider searchProvider = null)
        {
            if (_typedContentQuery != null) return _typedContentQuery.TypedSearch(criteria, searchProvider);

            var s = Examine.ExamineManager.Instance.DefaultSearchProvider;
            if (searchProvider != null)
                s = searchProvider;

            var results = s.Search(criteria);
            return results.ConvertSearchResultToPublishedContent(_contentCache);
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,125,1],[32,9,32,10,1],[33,13,33,38,1],[33,39,33,87,0],[34,13,34,36,1],[34,37,34,83,0],[35,13,35,42,1],[36,13,36,38,1],[37,9,37,10,1],[44,9,44,135,1],[45,9,45,10,1],[46,13,46,43,1],[46,44,46,97,0],[47,13,47,45,1],[47,46,47,101,0],[48,13,48,52,1],[49,13,49,56,1],[50,9,50,10,1],[55,9,55,10,1],[56,13,58,55,1],[59,9,59,10,1],[62,9,62,10,0],[63,13,65,55,0],[66,9,66,10,0],[69,9,69,10,0],[70,13,72,77,0],[73,9,73,10,0],[76,9,76,10,1],[77,13,79,56,1],[80,9,80,10,1],[83,9,83,10,0],[84,13,86,56,0],[87,9,87,10,0],[90,9,90,10,0],[91,13,93,71,0],[94,9,94,10,0],[97,9,97,10,0],[98,13,100,71,0],[101,9,101,10,0],[104,9,104,10,0],[105,13,107,59,0],[108,9,108,10,0],[111,9,111,10,0],[112,13,114,52,0],[115,9,115,10,0],[118,9,118,10,0],[119,13,121,52,0],[122,9,122,10,0],[125,9,125,10,0],[126,13,128,74,0],[129,9,129,10,0],[132,9,132,10,0],[133,13,135,74,0],[136,9,136,10,0],[139,9,139,10,0],[140,13,142,53,0],[143,9,143,10,0],[146,9,146,10,0],[147,13,149,53,0],[150,9,150,10,0],[153,9,153,10,0],[154,13,156,68,0],[157,9,157,10,0],[160,9,160,10,0],[161,13,163,68,0],[164,9,164,10,0],[167,9,167,10,0],[168,13,170,56,0],[171,9,171,10,0],[178,9,178,10,0],[179,13,181,53,0],[182,9,182,10,0],[185,9,185,10,0],[186,13,188,54,0],[189,9,189,10,0],[192,9,192,10,0],[193,13,195,57,0],[196,9,196,10,0],[199,9,199,10,0],[200,13,202,50,0],[203,9,203,10,0],[206,9,206,10,0],[207,13,209,51,0],[210,9,210,10,0],[213,9,213,10,0],[214,13,216,54,0],[217,9,217,10,0],[224,9,224,10,1],[225,13,225,41,1],[226,13,226,24,1],[227,9,227,10,1],[230,9,230,10,0],[232,13,232,92,0],[233,13,233,91,0],[234,13,234,95,0],[235,13,235,24,0],[236,9,236,10,0],[239,9,239,10,0],[240,13,240,59,0],[241,13,241,24,0],[242,9,242,10,0],[252,9,252,10,1],[253,13,253,41,1],[253,41,253,73,1],[253,73,253,90,1],[253,13,253,90,1],[254,9,254,10,1],[257,9,257,10,0],[259,13,259,41,0],[259,41,259,73,0],[259,73,259,90,0],[259,13,259,90,0],[260,9,260,10,0],[263,9,263,10,0],[264,13,264,53,0],[265,13,265,24,0],[266,9,266,10,0],[269,9,269,10,0],[270,13,270,53,0],[271,13,271,24,0],[272,9,272,10,0],[275,9,275,10,0],[276,13,276,38,0],[277,9,277,10,0],[280,9,280,10,0],[281,13,281,41,0],[282,13,284,71,0],[285,9,285,10,0],[288,9,288,10,0],[289,13,289,52,0],[290,13,292,71,0],[293,9,293,10,0],[296,9,296,10,0],[297,13,297,59,0],[298,13,300,71,0],[301,9,301,10,0],[304,9,304,10,0],[305,13,305,59,0],[306,13,308,71,0],[309,9,309,10,0],[312,9,312,10,0],[313,13,313,42,0],[314,13,314,46,0],[314,46,314,80,0],[314,80,315,40,0],[315,40,315,96,0],[315,96,316,61,0],[314,13,316,61,0],[317,13,317,59,0],[318,9,318,10,0],[321,9,321,10,0],[322,13,322,42,0],[323,13,323,46,0],[323,46,323,80,0],[323,80,324,40,0],[324,40,324,96,0],[324,96,325,61,0],[323,13,325,61,0],[326,13,326,59,0],[327,9,327,10,0],[330,9,330,10,0],[331,13,333,50,0],[333,50,333,95,0],[333,95,334,19,0],[331,13,334,19,0],[335,9,335,10,0],[338,9,338,10,0],[339,13,341,50,0],[341,50,341,95,0],[341,95,342,19,0],[339,13,342,19,0],[343,9,343,10,0],[346,9,346,10,0],[347,13,349,50,0],[349,50,349,95,0],[349,95,350,19,0],[347,13,350,19,0],[351,9,351,10,0],[365,9,365,10,0],[366,13,369,83,0],[370,9,370,10,0],[379,9,379,10,0],[380,13,383,73,0],[384,9,384,10,0],[394,9,394,10,0],[395,13,395,44,0],[395,45,395,119,0],[397,13,397,82,0],[398,13,398,63,0],[399,17,399,101,0],[401,13,401,63,0],[402,13,402,81,0],[403,9,403,10,0],[412,9,412,10,0],[413,13,413,44,0],[413,45,413,109,0],[415,13,415,75,0],[416,13,416,40,0],[417,17,417,36,0],[419,13,419,46,0],[420,13,420,81,0],[421,9,421,10,0]]);
    </script>
  </body>
</html>