<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebServices\FolderBrowserService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Web.Script.Serialization;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Web.Media.ThumbnailProviders;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.Tags;
using Umbraco.Web.BaseRest;
using Tag = umbraco.cms.businesslogic.Tags.Tag;

namespace Umbraco.Web.WebServices
{
    //TODO: Can we convert this to MVC please instead of /base?

    [RestExtension(&quot;FolderBrowserService&quot;)]
    public class FolderBrowserService
    {
        [RestExtensionMethod(ReturnXml = false)]
        public static string GetChildren(int parentId)
        {
            var currentUser = GetCurrentUser();
            AuthorizeAccess(parentId, currentUser);

            // Get children and filter
            var data = new List&lt;object&gt;();
            var service = ApplicationContext.Current.Services.EntityService;

            var entities = service.GetChildren(parentId, UmbracoObjectTypes.Media);
            foreach (UmbracoEntity entity in entities)
            {
                var uploadFieldProperty = entity.AdditionalData
                    .Select(x =&gt; x.Value as UmbracoEntity.EntityProperty)
                    .Where(x =&gt; x != null)
                    .FirstOrDefault(x =&gt; x.PropertyEditorAlias == Constants.PropertyEditors.UploadFieldAlias);
                    
                //var uploadFieldProperty = entity.UmbracoProperties.FirstOrDefault(x =&gt; x.PropertyEditorAlias == Constants.PropertyEditors.UploadFieldAlias);
                
                var thumbnailUrl = uploadFieldProperty == null ? &quot;&quot; : ThumbnailProvidersResolver.Current.GetThumbnailUrl((string)uploadFieldProperty.Value);

                var item = new
                {
                    Id = entity.Id,
                    Path = entity.Path,
                    Name = entity.Name,
                    Tags = string.Join(&quot;,&quot;, Tag.GetTags(entity.Id).Select(x =&gt; x.TagCaption)),
                    MediaTypeAlias = entity.ContentTypeAlias,
                    EditUrl = string.Format(&quot;editMedia.aspx?id={0}&quot;, entity.Id),
                    FileUrl = uploadFieldProperty == null 
                        ? &quot;&quot; 
                        : uploadFieldProperty.Value,
                    ThumbnailUrl = string.IsNullOrEmpty(thumbnailUrl)
                        ? IOHelper.ResolveUrl(string.Format(&quot;{0}/images/thumbnails/{1}&quot;, SystemDirectories.Umbraco, entity.ContentTypeThumbnail))
                        : thumbnailUrl
                };

                data.Add(item);

            }

            return new JavaScriptSerializer().Serialize(data);
        }

        [RestExtensionMethod(ReturnXml = false)]
        public static string Delete(string nodeIds)
        {
            var currentUser = GetCurrentUser();

            var nodeIdParts = nodeIds.Split(&#39;,&#39;);

            foreach (var nodeIdPart in nodeIdParts.Where(x =&gt; string.IsNullOrEmpty(x) == false))
            {
                int nodeId;
                if (Int32.TryParse(nodeIdPart, out nodeId) == false)
                    continue;

                var node = new global::umbraco.cms.businesslogic.media.Media(nodeId);
                AuthorizeAccess(node, currentUser);

                node.delete((&quot;,&quot; + node.Path + &quot;,&quot;).Contains(&quot;,-21,&quot;));
            }

            return new JavaScriptSerializer().Serialize(new { success = true });
        }

        private static User GetCurrentUser()
        {
            var currentUser = User.GetCurrent();
            if (currentUser == null)
                throw new UnauthorizedAccessException(&quot;You must be logged in to use this service&quot;);

            return currentUser;
        }

        private static void AuthorizeAccess(global::umbraco.cms.businesslogic.media.Media mediaItem, User currentUser)
        {
            if ((&quot;,&quot; + mediaItem.Path + &quot;,&quot;).Contains(&quot;,&quot; + currentUser.StartMediaId + &quot;,&quot;) == false)
                throw new UnauthorizedAccessException(&quot;You do not have access to this Media node&quot;);
        }

        private static void AuthorizeAccess(int parentId, User currentUser)
        {
            var service = ApplicationContext.Current.Services.EntityService;
            var parentMedia = service.Get(parentId, UmbracoObjectTypes.Media);
            var mediaPath = parentMedia == null ? parentId.ToString(CultureInfo.InvariantCulture) : parentMedia.Path;

            if ((&quot;,&quot; + mediaPath + &quot;,&quot;).Contains(&quot;,&quot; + currentUser.StartMediaId + &quot;,&quot;) == false)
                throw new UnauthorizedAccessException(&quot;You do not have access to this Media node&quot;);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,0],[25,13,25,48,0],[26,13,26,52,0],[29,13,29,43,0],[30,13,30,77,0],[32,13,32,84,0],[33,13,33,20,0],[33,22,33,42,0],[33,43,33,45,0],[33,46,33,54,0],[34,13,34,14,0],[35,17,36,34,0],[36,34,36,73,0],[36,73,37,33,0],[37,33,37,42,0],[37,42,38,42,0],[38,42,38,109,0],[38,109,38,111,0],[35,17,38,111,0],[42,17,42,157,0],[44,17,49,80,0],[49,80,49,92,0],[49,92,58,19,0],[44,17,58,19,0],[60,17,60,32,0],[62,13,62,14,0],[64,13,64,63,0],[65,9,65,10,0],[69,9,69,10,0],[70,13,70,48,0],[72,13,72,50,0],[74,13,74,20,0],[74,22,74,36,0],[74,37,74,39,0],[74,40,74,63,0],[74,63,74,95,0],[74,95,74,96,0],[74,40,74,96,0],[75,13,75,14,0],[77,17,77,69,0],[78,21,78,30,0],[80,17,80,86,0],[81,17,81,52,0],[83,17,83,72,0],[84,13,84,14,0],[86,13,86,81,0],[87,9,87,10,0],[90,9,90,10,0],[91,13,91,49,0],[92,13,92,37,0],[93,17,93,100,0],[95,13,95,32,0],[96,9,96,10,0],[99,9,99,10,0],[100,13,100,102,0],[101,17,101,100,0],[102,9,102,10,0],[105,9,105,10,0],[106,13,106,77,0],[107,13,107,79,0],[108,13,108,118,0],[110,13,110,97,0],[111,17,111,100,0],[112,9,112,10,0]]);
    </script>
  </body>
</html>