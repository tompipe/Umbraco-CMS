<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\DefaultDatabaseFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;

namespace Umbraco.Core.Persistence
{
	/// &lt;summary&gt;
	/// The default implementation for the IDatabaseFactory
	/// &lt;/summary&gt;
	/// &lt;remarks&gt;
	/// If we are running in an http context
	/// it will create one per context, otherwise it will be a global singleton object which is NOT thread safe
	/// since we need (at least) a new instance of the database object per thread.
	/// &lt;/remarks&gt;
	internal class DefaultDatabaseFactory : DisposableObject, IDatabaseFactory
	{
	    private readonly string _connectionStringName;
	    private readonly ILogger _logger;
	    public string ConnectionString { get; private set; }
        public string ProviderName { get; private set; }
        
        //very important to have ThreadStatic:
        // see: http://issues.umbraco.org/issue/U4-2172
        [ThreadStatic]
        private static volatile UmbracoDatabase _nonHttpInstance;

		private static readonly object Locker = new object();

	    /// &lt;summary&gt;
	    /// Constructor accepting custom connection string
	    /// &lt;/summary&gt;
	    /// &lt;param name=&quot;connectionStringName&quot;&gt;Name of the connection string in web.config&lt;/param&gt;
	    /// &lt;param name=&quot;logger&quot;&gt;&lt;/param&gt;
	    public DefaultDatabaseFactory(string connectionStringName, ILogger logger)
		{
	        if (logger == null) throw new ArgumentNullException(&quot;logger&quot;);
	        Mandate.ParameterNotNullOrEmpty(connectionStringName, &quot;connectionStringName&quot;);
			_connectionStringName = connectionStringName;
	        _logger = logger;
		}

	    /// &lt;summary&gt;
	    /// Constructor accepting custom connectino string and provider name
	    /// &lt;/summary&gt;
	    /// &lt;param name=&quot;connectionString&quot;&gt;Connection String to use with Database&lt;/param&gt;
	    /// &lt;param name=&quot;providerName&quot;&gt;Database Provider for the Connection String&lt;/param&gt;
	    /// &lt;param name=&quot;logger&quot;&gt;&lt;/param&gt;
	    public DefaultDatabaseFactory(string connectionString, string providerName, ILogger logger)
		{
	        if (logger == null) throw new ArgumentNullException(&quot;logger&quot;);
	        Mandate.ParameterNotNullOrEmpty(connectionString, &quot;connectionString&quot;);
			Mandate.ParameterNotNullOrEmpty(providerName, &quot;providerName&quot;);
			ConnectionString = connectionString;
			ProviderName = providerName;
            _logger = logger;
		}

		public UmbracoDatabase CreateDatabase()
		{
			//no http context, create the singleton global object
			if (HttpContext.Current == null)
			{
                if (_nonHttpInstance == null)
				{
					lock (Locker)
					{
						//double check
                        if (_nonHttpInstance == null)
						{
                            _nonHttpInstance = string.IsNullOrEmpty(ConnectionString) == false &amp;&amp; string.IsNullOrEmpty(ProviderName) == false
                                                  ? new UmbracoDatabase(ConnectionString, ProviderName, _logger)
                                                  : new UmbracoDatabase(_connectionStringName, _logger);
						}
					}
				}
                return _nonHttpInstance;
			}

			//we have an http context, so only create one per request
			if (HttpContext.Current.Items.Contains(typeof(DefaultDatabaseFactory)) == false)
			{
			    HttpContext.Current.Items.Add(typeof (DefaultDatabaseFactory),
			                                  string.IsNullOrEmpty(ConnectionString) == false &amp;&amp; string.IsNullOrEmpty(ProviderName) == false
                                                  ? new UmbracoDatabase(ConnectionString, ProviderName, _logger)
                                                  : new UmbracoDatabase(_connectionStringName, _logger));
			}
			return (UmbracoDatabase)HttpContext.Current.Items[typeof(DefaultDatabaseFactory)];
		}

		protected override void DisposeResources()
		{
			if (HttpContext.Current == null)
			{
                _nonHttpInstance.Dispose();
			}
			else
			{
				if (HttpContext.Current.Items.Contains(typeof(DefaultDatabaseFactory)))
				{
					((UmbracoDatabase)HttpContext.Current.Items[typeof(DefaultDatabaseFactory)]).Dispose();
				}
			}
		}

        // during tests, the thread static var can leak between tests
        // this method provides a way to force-reset the variable
	    internal void ResetForTests()
	    {
	        if (_nonHttpInstance == null) return;
	        _nonHttpInstance.Dispose();
	        _nonHttpInstance = null;
	    }
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,39,20,43,1],[20,44,20,56,1],[21,38,21,42,1],[21,43,21,55,1],[28,3,28,56,1],[35,6,35,80,1],[36,3,36,4,1],[37,10,37,29,1],[37,30,37,72,0],[38,10,38,88,1],[39,4,39,49,1],[40,10,40,27,1],[41,3,41,4,1],[49,6,49,97,1],[50,3,50,4,1],[51,10,51,29,1],[51,30,51,72,0],[52,10,52,80,1],[53,4,53,66,1],[54,4,54,40,1],[55,4,55,32,1],[56,13,56,30,1],[57,3,57,4,1],[60,3,60,4,1],[62,4,62,36,1],[63,4,63,5,1],[64,17,64,46,1],[65,5,65,6,1],[66,6,66,19,1],[67,6,67,7,1],[69,25,69,54,1],[70,7,70,8,1],[71,29,73,105,1],[74,7,74,8,1],[75,6,75,7,1],[76,5,76,6,1],[77,17,77,41,1],[81,4,81,84,0],[82,4,82,5,0],[83,8,86,106,0],[87,4,87,5,0],[88,4,88,86,0],[89,3,89,4,1],[92,3,92,4,0],[93,4,93,36,0],[94,4,94,5,0],[95,17,95,44,0],[96,4,96,5,0],[98,4,98,5,0],[99,5,99,76,0],[100,5,100,6,0],[101,6,101,93,0],[102,5,102,6,0],[103,4,103,5,0],[104,3,104,4,0],[109,6,109,7,1],[110,10,110,39,1],[110,40,110,47,1],[111,10,111,37,1],[112,10,112,34,1],[113,6,113,7,1]]);
    </script>
  </body>
</html>