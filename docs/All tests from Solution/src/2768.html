<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\tom pipe\documents\hexadigital\code\umbraco\umbraco-cms\src\umbraco.web.ui\umbraco\dialogs\changedoctype.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Web.UI.Pages;

namespace Umbraco.Web.UI.Umbraco.Dialogs
{
    public partial class ChangeDocType : UmbracoEnsuredPage
    {
        class PropertyMapping
        {
            public string FromName { get; set; }
            public string ToName { get; set; }
            public string ToAlias { get; set; }
            public object Value { get; set; }
        }

        private IContent _content;

        protected void Page_Load(object sender, EventArgs e)
        {
            var contentNodeId = int.Parse(Request.QueryString[&quot;id&quot;]);
            _content = Services.ContentService.GetById(contentNodeId);

            LocalizeTexts();

            if (!Page.IsPostBack)
            {
                DisplayContentDetails();
                if (PopulateListOfValidAlternateDocumentTypes())
                {
                    PopulateListOfTemplates();
                    PopulatePropertyMappingWithSources();
                    PopulatePropertyMappingWithDestinations();
                }
                else
                {
                    DisplayNotAvailable();
                }
            }
        }

        private void LocalizeTexts()
        {
            ChangeDocTypePane.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;selectNewDocType&quot;);
            ContentNamePropertyPanel.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;selectedContent&quot;);
            CurrentTypePropertyPanel.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;currentType&quot;);
            NewTypePropertyPanel.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;newType&quot;);
            NewTemplatePropertyPanel.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;newTemplate&quot;);
            ChangeDocTypePropertyMappingPane.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;mapProperties&quot;);
            ValidateAndSave.Text = global::umbraco.ui.Text(&quot;buttons&quot;, &quot;save&quot;);
        }

        private void DisplayContentDetails()
        {
            ContentNameLabel.Text = _content.Name;
            CurrentTypeLabel.Text = _content.ContentType.Name;
        }

        private bool PopulateListOfValidAlternateDocumentTypes()
        {
            // Start with all content types
            var documentTypes = Services.ContentTypeService.GetAllContentTypes().ToArray();

            // Remove invalid ones from list of potential alternatives
            documentTypes = RemoveCurrentDocumentTypeFromAlternatives(documentTypes).ToArray();
            documentTypes = RemoveInvalidByParentDocumentTypesFromAlternatives(documentTypes).ToArray();
            documentTypes = RemoveInvalidByChildrenDocumentTypesFromAlternatives(documentTypes).ToArray();

            // If we have at least one, bind to list and return true
            if (documentTypes.Any())
            {
                NewDocumentTypeList.DataSource = documentTypes.OrderBy(x =&gt; x.Name);
                NewDocumentTypeList.DataValueField = &quot;Id&quot;;
                NewDocumentTypeList.DataTextField = &quot;Name&quot;;
                NewDocumentTypeList.DataBind();
                return true;
            }

            return false;
        }

        private IEnumerable&lt;IContentType&gt; RemoveCurrentDocumentTypeFromAlternatives(IEnumerable&lt;IContentType&gt; documentTypes)
        {
            return documentTypes
                .Where(x =&gt; x.Id != _content.ContentType.Id);
        }

        private IEnumerable&lt;IContentType&gt; RemoveInvalidByParentDocumentTypesFromAlternatives(IEnumerable&lt;IContentType&gt; documentTypes)
        {
            if (_content.ParentId == -1)
            {
                // Root content, only include those that have been selected as allowed at root
                return documentTypes
                    .Where(x =&gt; x.AllowedAsRoot);
            }
            else
            {
                // Below root, so only include those allowed as sub-nodes for the parent
                var parentNode = Services.ContentService.GetById(_content.ParentId);
                return documentTypes
                    .Where(x =&gt; parentNode.ContentType.AllowedContentTypes
                        .Select(y =&gt; y.Id.Value)
                        .Contains(x.Id));
            }
        }

        private IEnumerable&lt;IContentType&gt; RemoveInvalidByChildrenDocumentTypesFromAlternatives(IEnumerable&lt;IContentType&gt; documentTypes)
        {
            var docTypeIdsOfChildren = _content.Children()
                .Select(x =&gt; x.ContentType.Id)
                .Distinct()
                .ToList();
            return documentTypes
                .Where(x =&gt; x.AllowedContentTypes
                    .Select(y =&gt; y.Id.Value)
                    .ContainsAll(docTypeIdsOfChildren));
        }

        private void PopulateListOfTemplates()
        {
            // Get selected new document type
            var contentType = GetSelectedDocumentType();

            // Populate template list
            NewTemplateList.DataSource = contentType.AllowedTemplates;
            NewTemplateList.DataValueField = &quot;Id&quot;;
            NewTemplateList.DataTextField = &quot;Name&quot;;
            NewTemplateList.DataBind();
            NewTemplateList.Items.Add(new ListItem(&quot;&lt;&quot; + global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;none&quot;) + &quot;&gt;&quot;, &quot;0&quot;));

            // Set default template
            if (contentType.DefaultTemplate != null)
            {
                var itemToSelect = NewTemplateList.Items.FindByValue(contentType.DefaultTemplate.Id.ToString());
                if (itemToSelect != null)
                {
                    itemToSelect.Selected = true;
                }
            }
        }

        private void PopulatePropertyMappingWithSources()
        {
            PropertyMappingRepeater.DataSource = GetPropertiesOfContentType(_content.ContentType);
            PropertyMappingRepeater.DataBind();
        }

        private void PopulatePropertyMappingWithDestinations()
        {
            // Get selected new document type
            var contentType = GetSelectedDocumentType();

            // Get properties of new document type (including any from parent types)
            var properties = GetPropertiesOfContentType(contentType);

            // Loop through list of source properties and populate destination options with all those of same property type
            foreach (RepeaterItem ri in PropertyMappingRepeater.Items)
            {
                if (ri.ItemType == ListItemType.Item || ri.ItemType == ListItemType.AlternatingItem)
                {
                    // Get data type from hidden field
                    var propEdAlias = ((HiddenField)ri.FindControl(&quot;PropertyEditorAlias&quot;)).Value;

                    // Bind destination list with properties that match data type
                    var ddl = (DropDownList)ri.FindControl(&quot;DestinationProperty&quot;);
                    ddl.DataSource = properties.Where(x =&gt; x.PropertyEditorAlias == propEdAlias);
                    ddl.DataValueField = &quot;Alias&quot;;
                    ddl.DataTextField = &quot;Name&quot;;
                    ddl.DataBind();
                    ddl.Items.Insert(0, new ListItem(&quot;&lt;&quot; + global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;none&quot;) + &quot;&gt;&quot;, string.Empty));

                    // Set default selection to be one with matching alias
                    var alias = ((HiddenField)ri.FindControl(&quot;Alias&quot;)).Value;
                    var item = ddl.Items.FindByValue(alias);
                    if (item != null)
                    {
                        item.Selected = true;
                    }
                }
            }
        }

        private IContentType GetSelectedDocumentType()
        {
            return Services.ContentTypeService.GetContentType(int.Parse(NewDocumentTypeList.SelectedItem.Value));
        }

        private IEnumerable&lt;PropertyType&gt; GetPropertiesOfContentType(IContentType contentType)
        {
            return contentType.CompositionPropertyTypes;
        }

        private void DisplayNotAvailable()
        {
            NewTypePropertyPanel.Visible = false;
            NewTemplatePropertyPanel.Visible = false;
            SavePlaceholder.Visible = false;
            NotAvailablePlaceholder.Visible = true;
            ChangeDocTypePropertyMappingPane.Visible = false;
        }

        protected void NewDocumentTypeList_SelectedIndexChanged(object sender, EventArgs e)
        {
            PopulateListOfTemplates();
            PopulatePropertyMappingWithDestinations();
        }

        protected void ValidateAndSave_Click(object sender, EventArgs e)
        {
            if (IsPropertyMappingValid())
            {
                // For all properties to be mapped, save the values to a temporary list
                var propertyMappings = SavePropertyMappings();

                // Get flag for if content already published
                var wasPublished = _content.Published;

                // Change the document type passing flag to clear the properties
                var newContentType = GetSelectedDocumentType();
                _content.ChangeContentType(newContentType, true);

                // Set the template if one has been selected
                if (NewTemplateList.SelectedItem != null)
                {
                    var templateId = int.Parse(NewTemplateList.SelectedItem.Value);
                    _content.Template = templateId &gt; 0 ? Services.FileService.GetTemplate(templateId) : null;
                }

                // Set the property values
                var propertiesMappedMessageBuilder = new StringBuilder(&quot;&lt;ul&gt;&quot;);
                foreach (var propertyMapping in propertyMappings)
                {
                    propertiesMappedMessageBuilder.AppendFormat(&quot;&lt;li&gt;{0} {1} {2}&lt;/li&gt;&quot;,
                        propertyMapping.FromName, global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;to&quot;), propertyMapping.ToName);
                    _content.SetValue(propertyMapping.ToAlias, propertyMapping.Value);
                }
                propertiesMappedMessageBuilder.Append(&quot;&lt;/ul&gt;&quot;);

                // Save
                var user = global::umbraco.BusinessLogic.User.GetCurrent();
                Services.ContentService.Save(_content, user.Id);

                // Publish if the content was already published
                if (wasPublished)
                {
                    Services.ContentService.Publish(_content, user.Id);
                }

                // Sync the tree
                ClientTools.SyncTree(_content.Path, true);
                
                // Reload the page if the content was already being viewed
                ClientTools.ReloadLocation();

                // Display success message
                SuccessMessage.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;successMessage&quot;).Replace(&quot;[new type]&quot;, &quot;&lt;strong&gt;&quot; + newContentType.Name + &quot;&lt;/strong&gt;&quot;);
                PropertiesMappedMessage.Text = propertiesMappedMessageBuilder.ToString();
                if (wasPublished)
                {
                    ContentPublishedMessage.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;contentRepublished&quot;);
                    ContentPublishedMessage.Visible = true;
                }
                else
                {
                    ContentPublishedMessage.Visible = false;
                }
                SuccessPlaceholder.Visible = true;
                SaveAndCancelPlaceholder.Visible = false;
                ValidationPlaceholder.Visible = false;
                ChangeDocTypePane.Visible = false;
                ChangeDocTypePropertyMappingPane.Visible = false;
            }
            else
            {
                ValidationPlaceholder.Visible = true;
            }
        }

        private bool IsPropertyMappingValid()
        {
            // Check whether any properties have been mapped to more than once
            var mappedPropertyAliases = new List&lt;string&gt;();
            foreach (RepeaterItem ri in PropertyMappingRepeater.Items)
            {
                if (ri.ItemType == ListItemType.Item || ri.ItemType == ListItemType.AlternatingItem)
                {
                    var ddl = (DropDownList)ri.FindControl(&quot;DestinationProperty&quot;);
                    var mappedPropertyAlias = ddl.SelectedItem.Value;
                    if (!string.IsNullOrEmpty(mappedPropertyAlias))
                    {
                        if (mappedPropertyAliases.Contains(mappedPropertyAlias))
                        {
                            ValidationError.Text = global::umbraco.ui.Text(&quot;changeDocType&quot;, &quot;validationErrorPropertyWithMoreThanOneMapping&quot;);
                            return false;
                        }

                        mappedPropertyAliases.Add(mappedPropertyAlias);
                    }
                }
            }

            return true;
        }

        private IList&lt;PropertyMapping&gt; SavePropertyMappings()
        {
            // Create list of mapped property values for assignment after the document type is changed
            var mappedPropertyValues = new List&lt;PropertyMapping&gt;();
            foreach (RepeaterItem ri in PropertyMappingRepeater.Items)
            {
                if (ri.ItemType == ListItemType.Item || ri.ItemType == ListItemType.AlternatingItem)
                {
                    // Get property alias to map to
                    var ddl = (DropDownList)ri.FindControl(&quot;DestinationProperty&quot;);
                    var mappedAlias = ddl.SelectedItem.Value;
                    if (!string.IsNullOrEmpty(mappedAlias))
                    {
                        // If mapping property, get current property value from alias
                        var sourceAlias = ((HiddenField)ri.FindControl(&quot;Alias&quot;)).Value;
                        var sourcePropertyValue = _content.GetValue(sourceAlias);

                        // Add to list
                        mappedPropertyValues.Add(new PropertyMapping
                            {
                                FromName = ((HiddenField)ri.FindControl(&quot;Name&quot;)).Value,
                                ToName = ddl.SelectedItem.Text,
                                ToAlias = mappedAlias,
                                Value = sourcePropertyValue
                            });
                    }
                }
            }

            return mappedPropertyValues;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,38,17,42,0],[17,43,17,47,0],[18,36,18,40,0],[18,41,18,45,0],[19,37,19,41,0],[19,42,19,46,0],[20,35,20,39,0],[20,40,20,44,0],[26,9,26,10,0],[27,13,27,70,0],[28,13,28,71,0],[30,13,30,29,0],[32,13,32,34,0],[33,13,33,14,0],[34,17,34,41,0],[35,17,35,65,0],[36,17,36,18,0],[37,21,37,47,0],[38,21,38,58,0],[39,21,39,63,0],[40,17,40,18,0],[42,17,42,18,0],[43,21,43,43,0],[44,17,44,18,0],[45,13,45,14,0],[46,9,46,10,0],[49,9,49,10,0],[50,13,50,99,0],[51,13,51,105,0],[52,13,52,101,0],[53,13,53,93,0],[54,13,54,101,0],[55,13,55,111,0],[56,13,56,79,0],[57,9,57,10,0],[60,9,60,10,0],[61,13,61,51,0],[62,13,62,63,0],[63,9,63,10,0],[66,9,66,10,0],[68,13,68,92,0],[71,13,71,96,0],[72,13,72,105,0],[73,13,73,107,0],[76,13,76,37,0],[77,13,77,14,0],[78,17,78,77,0],[78,77,78,83,0],[78,83,78,85,0],[78,17,78,85,0],[79,17,79,59,0],[80,17,80,60,0],[81,17,81,48,0],[82,17,82,29,0],[85,13,85,26,0],[86,9,86,10,0],[89,9,89,10,0],[90,13,91,29,0],[91,29,91,60,0],[91,60,91,62,0],[90,13,91,62,0],[92,9,92,10,0],[95,9,95,10,0],[96,13,96,41,0],[97,13,97,14,0],[99,17,100,33,0],[100,33,100,48,0],[100,48,100,50,0],[99,17,100,50,0],[103,13,103,14,0],[105,17,105,85,0],[106,17,107,33,0],[107,33,108,38,0],[108,38,108,48,0],[108,48,109,40,0],[107,33,109,40,0],[109,40,109,42,0],[106,17,109,42,0],[111,9,111,10,0],[114,9,114,10,0],[115,13,116,30,0],[116,30,116,46,0],[116,46,118,27,0],[115,13,118,27,0],[119,13,120,29,0],[120,29,121,34,0],[121,34,121,44,0],[121,44,122,55,0],[120,29,122,55,0],[122,55,122,57,0],[119,13,122,57,0],[123,9,123,10,0],[126,9,126,10,0],[128,13,128,57,0],[131,13,131,71,0],[132,13,132,51,0],[133,13,133,52,0],[134,13,134,40,0],[135,13,135,120,0],[138,13,138,53,0],[139,13,139,14,0],[140,17,140,113,0],[141,17,141,42,0],[142,17,142,18,0],[143,21,143,50,0],[144,17,144,18,0],[145,13,145,14,0],[146,9,146,10,0],[149,9,149,10,0],[150,13,150,99,0],[151,13,151,48,0],[152,9,152,10,0],[155,9,155,10,0],[157,13,157,57,0],[160,13,160,70,0],[163,13,163,20,0],[163,22,163,37,0],[163,38,163,40,0],[163,41,163,70,0],[164,13,164,14,0],[165,17,165,101,0],[166,17,166,18,0],[168,21,168,98,0],[171,21,171,83,0],[172,21,172,60,0],[172,60,172,96,0],[172,96,172,98,0],[172,21,172,98,0],[173,21,173,50,0],[174,21,174,48,0],[175,21,175,36,0],[176,21,176,131,0],[179,21,179,78,0],[180,21,180,61,0],[181,21,181,38,0],[182,21,182,22,0],[183,25,183,46,0],[184,21,184,22,0],[185,17,185,18,0],[186,13,186,14,0],[187,9,187,10,0],[190,9,190,10,0],[191,13,191,114,0],[192,9,192,10,0],[195,9,195,10,0],[196,13,196,57,0],[197,9,197,10,0],[200,9,200,10,0],[201,13,201,50,0],[202,13,202,54,0],[203,13,203,45,0],[204,13,204,52,0],[205,13,205,62,0],[206,9,206,10,0],[209,9,209,10,0],[210,13,210,39,0],[211,13,211,55,0],[212,9,212,10,0],[215,9,215,10,0],[216,13,216,42,0],[217,13,217,14,0],[219,17,219,63,0],[222,17,222,55,0],[225,17,225,64,0],[226,17,226,66,0],[229,17,229,58,0],[230,17,230,18,0],[231,21,231,84,0],[232,21,232,110,0],[233,17,233,18,0],[236,17,236,80,0],[237,17,237,24,0],[237,26,237,45,0],[237,46,237,48,0],[237,49,237,65,0],[238,17,238,18,0],[239,21,240,123,0],[241,21,241,87,0],[242,17,242,18,0],[243,17,243,64,0],[246,17,246,76,0],[247,17,247,65,0],[250,17,250,34,0],[251,17,251,18,0],[252,21,252,72,0],[253,17,253,18,0],[256,17,256,59,0],[259,17,259,46,0],[262,17,262,168,0],[263,17,263,90,0],[264,17,264,34,0],[265,17,265,18,0],[266,21,266,115,0],[267,21,267,60,0],[268,17,268,18,0],[270,17,270,18,0],[271,21,271,61,0],[272,17,272,18,0],[273,17,273,51,0],[274,17,274,58,0],[275,17,275,55,0],[276,17,276,51,0],[277,17,277,66,0],[278,13,278,14,0],[280,13,280,14,0],[281,17,281,54,0],[282,13,282,14,0],[283,9,283,10,0],[286,9,286,10,0],[288,13,288,60,0],[289,13,289,20,0],[289,22,289,37,0],[289,38,289,40,0],[289,41,289,70,0],[290,13,290,14,0],[291,17,291,101,0],[292,17,292,18,0],[293,21,293,83,0],[294,21,294,70,0],[295,21,295,68,0],[296,21,296,22,0],[297,25,297,81,0],[298,25,298,26,0],[299,29,299,142,0],[300,29,300,42,0],[303,25,303,72,0],[304,21,304,22,0],[305,17,305,18,0],[306,13,306,14,0],[308,13,308,25,0],[309,9,309,10,0],[312,9,312,10,0],[314,13,314,68,0],[315,13,315,20,0],[315,22,315,37,0],[315,38,315,40,0],[315,41,315,70,0],[316,13,316,14,0],[317,17,317,101,0],[318,17,318,18,0],[320,21,320,83,0],[321,21,321,62,0],[322,21,322,60,0],[323,21,323,22,0],[325,25,325,88,0],[326,25,326,82,0],[329,25,335,32,0],[336,21,336,22,0],[337,17,337,18,0],[338,13,338,14,0],[340,13,340,41,0],[341,9,341,10,0]]);
    </script>
  </body>
</html>