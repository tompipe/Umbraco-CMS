<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\PublishedContent\PublishedContentMoreTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using System.Collections.ObjectModel;
using System.Web.Routing;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Models;
using Umbraco.Core.Models.PublishedContent;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.PropertyEditors;
using Umbraco.Web;
using Umbraco.Tests.TestHelpers;
using umbraco.BusinessLogic;
using Umbraco.Web.PublishedCache.XmlPublishedCache;
using Umbraco.Web.Security;

namespace Umbraco.Tests.PublishedContent
{
    [TestFixture]
    public class PublishedContentMoreTests : PublishedContentTestBase
    {

        // read http://stackoverflow.com/questions/7713326/extension-method-that-works-on-ienumerablet-and-iqueryablet
        // and http://msmvps.com/blogs/jon_skeet/archive/2010/10/28/overloading-and-generic-constraints.aspx
        // and http://blogs.msdn.com/b/ericlippert/archive/2009/12/10/constraints-are-not-part-of-the-signature.aspx

        private PluginManager _pluginManager;

        public override void Initialize()
        {
            base.Initialize();

            // this is so the model factory looks into the test assembly
            _pluginManager = PluginManager.Current;
            PluginManager.Current = new PluginManager(new ActivatorServiceProvider(), new NullCacheProvider(), ProfilingLogger, false)
                {
                    AssembliesToScan = _pluginManager.AssembliesToScan
                        .Union(new[] { typeof (PublishedContentMoreTests).Assembly})
                };

            InitializeUmbracoContext();
        }

        protected override void FreezeResolution()
        {
            PropertyValueConvertersResolver.Current =
                new PropertyValueConvertersResolver(new ActivatorServiceProvider(), Logger);
            var types = PluginManager.Current.ResolveTypes&lt;PublishedContentModel&gt;();
            PublishedContentModelFactoryResolver.Current =
                new PublishedContentModelFactoryResolver(new PublishedContentModelFactory(types));

            base.FreezeResolution();
        }

        private void InitializeUmbracoContext()
        {
            RouteData routeData = null;

            var caches = CreatePublishedContent();

            var httpContext = GetHttpContextFactory(&quot;http://umbraco.local/&quot;, routeData).HttpContext;
            var ctx = new UmbracoContext(
                httpContext,
                ApplicationContext,
                caches,
                new WebSecurity(httpContext, ApplicationContext));

            UmbracoContext.Current = ctx;
        }
        
        public override void TearDown()
        {
            PluginManager.Current = _pluginManager;
            ApplicationContext.Current.DisposeIfDisposable();
            ApplicationContext.Current = null;
        }

        [Test]
        public void First()
        {
            var content = UmbracoContext.Current.ContentCache.GetAtRoot().First();
            Assert.AreEqual(&quot;Content 1&quot;, content.Name);
        }

        [Test]
        public void DefaultContentSetIsSiblings()
        {
            var content = UmbracoContext.Current.ContentCache.GetAtRoot().First();
            Assert.AreEqual(0, content.Index());
            Assert.IsTrue(content.IsFirst());
        }

        [Test]
        public void RunOnLatestContentSet()
        {
            // get first content
            var content = UmbracoContext.Current.ContentCache.GetAtRoot().First();
            var id = content.Id;
            Assert.IsTrue(content.IsFirst());

            // reverse =&gt; should be last, but set has not changed =&gt; still first
            content = UmbracoContext.Current.ContentCache.GetAtRoot().Reverse().First(x =&gt; x.Id == id);
            Assert.IsTrue(content.IsFirst());
            Assert.IsFalse(content.IsLast());

            // reverse + new set =&gt; now it&#39;s last
            content = UmbracoContext.Current.ContentCache.GetAtRoot().Reverse().ToContentSet().First(x =&gt; x.Id == id);
            Assert.IsFalse(content.IsFirst());
            Assert.IsTrue(content.IsLast());

            // reverse that set =&gt; should be first, but no new set =&gt; still last
            content = UmbracoContext.Current.ContentCache.GetAtRoot().Reverse().ToContentSet().Reverse().First(x =&gt; x.Id == id);
            Assert.IsFalse(content.IsFirst());
            Assert.IsTrue(content.IsLast());
        }

        [Test]
        public void Distinct()
        {
            var content = UmbracoContext.Current.ContentCache.GetAtRoot()
                .Distinct()
                .Distinct()
                .ToContentSet()
                .First();

            Assert.AreEqual(&quot;Content 1&quot;, content.Name);
            Assert.IsTrue(content.IsFirst());
            Assert.IsFalse(content.IsLast());

            content = content.Next();
            Assert.AreEqual(&quot;Content 2&quot;, content.Name);
            Assert.IsFalse(content.IsFirst());
            Assert.IsFalse(content.IsLast());

            content = content.Next();
            Assert.AreEqual(&quot;Content 2Sub&quot;, content.Name);
            Assert.IsFalse(content.IsFirst());
            Assert.IsTrue(content.IsLast());
        }

        [Test]
        public void OfType1()
        {
            var content = UmbracoContext.Current.ContentCache.GetAtRoot()
                .OfType&lt;ContentType2&gt;()
                .Distinct()
                .ToArray();
            Assert.AreEqual(2, content.Count());
            Assert.IsInstanceOf&lt;ContentType2&gt;(content.First());
            var set = content.ToContentSet();
            Assert.IsInstanceOf&lt;ContentType2&gt;(set.First());
            Assert.AreSame(set, set.First().ContentSet);
            Assert.IsInstanceOf&lt;ContentType2Sub&gt;(set.First().Next());
        }

        [Test]
        public void OfType2()
        {
            var content = UmbracoContext.Current.ContentCache.GetAtRoot()
                .OfType&lt;ContentType2Sub&gt;()
                .Distinct()
                .ToArray();
            Assert.AreEqual(1, content.Count());
            Assert.IsInstanceOf&lt;ContentType2Sub&gt;(content.First());
            var set = content.ToContentSet();
            Assert.IsInstanceOf&lt;ContentType2Sub&gt;(set.First());
        }

        [Test]
        public void OfType()
        {
            var content = UmbracoContext.Current.ContentCache.GetAtRoot()
                .OfType&lt;ContentType2&gt;()
                .First(x =&gt; x.Prop1 == 1234);
            Assert.AreEqual(&quot;Content 2&quot;, content.Name);
            Assert.AreEqual(1234, content.Prop1);
        }

        [Test]
        public void Position()
        {
            var content = UmbracoContext.Current.ContentCache.GetAtRoot()
                .Where(x =&gt; x.GetPropertyValue&lt;int&gt;(&quot;prop1&quot;) == 1234)
                .ToContentSet()
                .ToArray();

            Assert.IsTrue(content.First().IsFirst());
            Assert.IsFalse(content.First().IsLast());
            Assert.IsFalse(content.First().Next().IsFirst());
            Assert.IsFalse(content.First().Next().IsLast());
            Assert.IsFalse(content.First().Next().Next().IsFirst());
            Assert.IsTrue(content.First().Next().Next().IsLast());
        }

        [Test]
        public void Issue()
        {
            var content = UmbracoContext.Current.ContentCache.GetAtRoot()
                .Distinct()
                .OfType&lt;ContentType2&gt;();

            var where = content.Where(x =&gt; x.Prop1 == 1234);
            var first = where.First();
            Assert.AreEqual(1234, first.Prop1);

            var content2 = UmbracoContext.Current.ContentCache.GetAtRoot()
                .OfType&lt;ContentType2&gt;()
                .First(x =&gt; x.Prop1 == 1234);
            Assert.AreEqual(1234, content2.Prop1);

            var content3 = UmbracoContext.Current.ContentCache.GetAtRoot()
                .OfType&lt;ContentType2&gt;()
                .First();
            Assert.AreEqual(1234, content3.Prop1);
        }

        [Test]
        public void PublishedContentQueryTypedContentList()
        {
            var query = new PublishedContentQuery(UmbracoContext.Current.ContentCache, UmbracoContext.Current.MediaCache);
            var result = query.TypedContent(new[] { 1, 2, 4 }).ToArray();
            Assert.AreEqual(2, result.Length);
            Assert.AreEqual(1, result[0].Id);
            Assert.AreEqual(2, result[1].Id);
        }

        static SolidPublishedCaches CreatePublishedContent()
        {
            var caches = new SolidPublishedCaches();
            var cache = caches.ContentCache;

            var props = new[]
                    {
                        new PublishedPropertyType(&quot;prop1&quot;, 1, &quot;?&quot;), 
                    };

            var contentType1 = new PublishedContentType(1, &quot;ContentType1&quot;, Enumerable.Empty&lt;string&gt;(), props);
            var contentType2 = new PublishedContentType(2, &quot;ContentType2&quot;, Enumerable.Empty&lt;string&gt;(), props);
            var contentType2s = new PublishedContentType(3, &quot;ContentType2Sub&quot;, Enumerable.Empty&lt;string&gt;(), props);

            cache.Add(new SolidPublishedContent(contentType1)
                {
                    Id = 1,
                    SortOrder = 0,
                    Name = &quot;Content 1&quot;,
                    UrlName = &quot;content-1&quot;,
                    Path = &quot;/1&quot;,
                    Level = 1,
                    Url = &quot;/content-1&quot;,
                    ParentId = -1,
                    ChildIds = new int[] {},
                    Properties = new Collection&lt;IPublishedProperty&gt;
                        {
                            new SolidPublishedProperty
                                {
                                    PropertyTypeAlias = &quot;prop1&quot;,
                                    HasValue = true,
                                    Value = 1234,
                                    DataValue = &quot;1234&quot;
                                }
                        }
                });

            cache.Add(new SolidPublishedContent(contentType2)
                {
                    Id = 2,
                    SortOrder = 1,
                    Name = &quot;Content 2&quot;,
                    UrlName = &quot;content-2&quot;,
                    Path = &quot;/2&quot;,
                    Level = 1,
                    Url = &quot;/content-2&quot;,
                    ParentId = -1,
                    ChildIds = new int[] { },
                    Properties = new Collection&lt;IPublishedProperty&gt;
                            {
                                new SolidPublishedProperty
                                    {
                                        PropertyTypeAlias = &quot;prop1&quot;,
                                        HasValue = true,
                                        Value = 1234,
                                        DataValue = &quot;1234&quot;
                                    }
                            }
                });

            cache.Add(new SolidPublishedContent(contentType2s)
            {
                Id = 3,
                SortOrder = 2,
                Name = &quot;Content 2Sub&quot;,
                UrlName = &quot;content-2sub&quot;,
                Path = &quot;/3&quot;,
                Level = 1,
                Url = &quot;/content-2sub&quot;,
                ParentId = -1,
                ChildIds = new int[] { },
                Properties = new Collection&lt;IPublishedProperty&gt;
                            {
                                new SolidPublishedProperty
                                    {
                                        PropertyTypeAlias = &quot;prop1&quot;,
                                        HasValue = true,
                                        Value = 1234,
                                        DataValue = &quot;1234&quot;
                                    }
                            }
            });

            return caches;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,10,1],[31,13,31,31,1],[34,13,34,52,1],[35,13,39,19,1],[41,13,41,40,1],[42,9,42,10,1],[45,9,45,10,1],[46,13,47,93,1],[48,13,48,85,1],[49,13,50,99,1],[52,13,52,37,1],[53,9,53,10,1],[56,9,56,10,1],[57,13,57,40,1],[59,13,59,51,1],[61,13,61,101,1],[62,13,66,67,1],[68,13,68,42,1],[69,9,69,10,1],[72,9,72,10,1],[73,13,73,52,1],[74,13,74,62,1],[75,13,75,47,1],[76,9,76,10,1],[80,9,80,10,1],[81,13,81,83,1],[82,13,82,56,1],[83,9,83,10,1],[87,9,87,10,1],[88,13,88,83,1],[89,13,89,49,1],[90,13,90,46,1],[91,9,91,10,1],[95,9,95,10,1],[97,13,97,83,1],[98,13,98,33,1],[99,13,99,46,1],[102,13,102,92,1],[102,92,102,102,1],[102,102,102,104,1],[102,13,102,104,1],[103,13,103,46,1],[104,13,104,46,1],[107,13,107,107,1],[107,107,107,117,1],[107,117,107,119,1],[107,13,107,119,1],[108,13,108,47,1],[109,13,109,45,1],[112,13,112,117,1],[112,117,112,127,1],[112,127,112,129,1],[112,13,112,129,1],[113,13,113,47,1],[114,13,114,45,1],[115,9,115,10,1],[119,9,119,10,1],[120,13,124,26,1],[126,13,126,56,1],[127,13,127,46,1],[128,13,128,46,1],[130,13,130,38,1],[131,13,131,56,1],[132,13,132,47,1],[133,13,133,46,1],[135,13,135,38,1],[136,13,136,59,1],[137,13,137,47,1],[138,13,138,45,1],[139,9,139,10,1],[143,9,143,10,1],[144,13,147,28,1],[148,13,148,49,1],[149,13,149,64,1],[150,13,150,46,1],[151,13,151,60,1],[152,13,152,57,1],[153,13,153,70,1],[154,9,154,10,1],[158,9,158,10,1],[159,13,162,28,1],[163,13,163,49,1],[164,13,164,67,1],[165,13,165,46,1],[166,13,166,63,1],[167,9,167,10,1],[171,9,171,10,1],[172,13,174,29,1],[174,29,174,44,1],[174,44,174,46,1],[172,13,174,46,1],[175,13,175,56,1],[176,13,176,50,1],[177,9,177,10,1],[181,9,181,10,1],[182,13,183,29,1],[183,29,183,69,1],[183,69,185,28,1],[182,13,185,28,1],[187,13,187,54,1],[188,13,188,54,1],[189,13,189,62,1],[190,13,190,61,1],[191,13,191,69,1],[192,13,192,67,1],[193,9,193,10,1],[197,9,197,10,1],[198,13,200,41,1],[202,13,202,44,1],[202,44,202,59,1],[202,59,202,61,1],[202,13,202,61,1],[203,13,203,39,1],[204,13,204,48,1],[206,13,208,29,1],[208,29,208,44,1],[208,44,208,46,1],[206,13,208,46,1],[209,13,209,51,1],[211,13,213,26,1],[214,13,214,51,1],[215,9,215,10,1],[219,9,219,10,1],[220,13,220,123,1],[221,13,221,74,1],[222,13,222,47,1],[223,13,223,46,1],[224,13,224,46,1],[225,9,225,10,1],[228,9,228,10,1],[229,13,229,53,1],[230,13,230,45,1],[232,13,235,23,1],[237,13,237,111,1],[238,13,238,111,1],[239,13,239,115,1],[241,13,262,20,1],[264,13,285,20,1],[287,13,308,16,1],[310,13,310,27,1],[311,9,311,10,1]]);
    </script>
  </body>
</html>