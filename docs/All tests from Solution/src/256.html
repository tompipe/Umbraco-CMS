<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Web\Controllers\WebApiEditors\ContentControllerUnitTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Web.Http;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Services;
using Umbraco.Web.Editors;

namespace Umbraco.Tests.Web.Controllers.WebApiEditors
{
    [TestFixture]
    public class ContentControllerUnitTests
    {
        [Test]
        public void Access_Allowed_By_Path()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(9);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;
            var contentMock = new Mock&lt;IContent&gt;();
            contentMock.Setup(c =&gt; c.Path).Returns(&quot;-1,1234,5678&quot;);
            var content = contentMock.Object;
            var contentServiceMock = new Mock&lt;IContentService&gt;();
            contentServiceMock.Setup(x =&gt; x.GetById(1234)).Returns(content);
            var contentService = contentServiceMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, null, contentService, 1234);

            //assert
            Assert.IsTrue(result);
        }

        [Test]
        public void Throws_Exception_When_No_Content_Found()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(9);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;
            var contentMock = new Mock&lt;IContent&gt;();
            contentMock.Setup(c =&gt; c.Path).Returns(&quot;-1,1234,5678&quot;);
            var content = contentMock.Object;
            var contentServiceMock = new Mock&lt;IContentService&gt;();
            contentServiceMock.Setup(x =&gt; x.GetById(0)).Returns(content);
            var contentService = contentServiceMock.Object;
            var userServiceMock = new Mock&lt;IUserService&gt;();    
            var permissions = new List&lt;EntityPermission&gt;();
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, 1234)).Returns(permissions);
            var userService = userServiceMock.Object;
            
            //act/assert
            Assert.Throws&lt;HttpResponseException&gt;(() =&gt; ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, userService, contentService, 1234, new[] { &#39;F&#39; }));
        }

        [Test]
        public void No_Access_By_Path()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(9);
            userMock.Setup(u =&gt; u.StartContentId).Returns(9876);
            var user = userMock.Object;
            var contentMock = new Mock&lt;IContent&gt;();
            contentMock.Setup(c =&gt; c.Path).Returns(&quot;-1,1234,5678&quot;);
            var content = contentMock.Object;
            var contentServiceMock = new Mock&lt;IContentService&gt;();
            contentServiceMock.Setup(x =&gt; x.GetById(1234)).Returns(content);
            var contentService = contentServiceMock.Object;
            var userServiceMock = new Mock&lt;IUserService&gt;();    
            var permissions = new List&lt;EntityPermission&gt;();
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, 1234)).Returns(permissions);
            var userService = userServiceMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, userService, contentService, 1234, new[] { &#39;F&#39;});

            //assert
            Assert.IsFalse(result);
        }

        [Test]
        public void No_Access_By_Permission()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(9);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;
            var contentMock = new Mock&lt;IContent&gt;();
            contentMock.Setup(c =&gt; c.Path).Returns(&quot;-1,1234,5678&quot;);
            var content = contentMock.Object;
            var contentServiceMock = new Mock&lt;IContentService&gt;();
            contentServiceMock.Setup(x =&gt; x.GetById(1234)).Returns(content);
            var contentService = contentServiceMock.Object;
            var userServiceMock = new Mock&lt;IUserService&gt;();    
            var permissions = new List&lt;EntityPermission&gt;
                {
                    new EntityPermission(9, 1234, new string[]{ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; })
                };
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, 1234)).Returns(permissions);
            var userService = userServiceMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, userService, contentService, 1234, new[] { &#39;F&#39;});

            //assert
            Assert.IsFalse(result);
        }

        [Test]
        public void Access_Allowed_By_Permission()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(9);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;
            var contentMock = new Mock&lt;IContent&gt;();
            contentMock.Setup(c =&gt; c.Path).Returns(&quot;-1,1234,5678&quot;);
            var content = contentMock.Object;
            var contentServiceMock = new Mock&lt;IContentService&gt;();
            contentServiceMock.Setup(x =&gt; x.GetById(1234)).Returns(content);
            var contentService = contentServiceMock.Object;
            var userServiceMock = new Mock&lt;IUserService&gt;();    
            var permissions = new List&lt;EntityPermission&gt;
                {
                    new EntityPermission(9, 1234, new string[]{ &quot;A&quot;, &quot;F&quot;, &quot;C&quot; })
                };
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, 1234)).Returns(permissions);
            var userService = userServiceMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, userService, contentService, 1234, new[] { &#39;F&#39;});

            //assert
            Assert.IsTrue(result);
        }

        [Test]
        public void Access_To_Root_By_Path()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(0);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;
            
            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, null, null, -1);

            //assert
            Assert.IsTrue(result);
        }

        [Test]
        public void Access_To_Recycle_Bin_By_Path()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(0);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;
            
            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, null, null, -20);

            //assert
            Assert.IsTrue(result);
        }

        [Test]
        public void No_Access_To_Recycle_Bin_By_Path()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(0);
            userMock.Setup(u =&gt; u.StartContentId).Returns(1234);
            var user = userMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, null, null, -20);

            //assert
            Assert.IsFalse(result);
        }

        [Test]
        public void No_Access_To_Root_By_Path()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(0);
            userMock.Setup(u =&gt; u.StartContentId).Returns(1234);
            var user = userMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, null, null, -1);

            //assert
            Assert.IsFalse(result);
        }

        [Test]
        public void Access_To_Root_By_Permission()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(0);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;

            var userServiceMock = new Mock&lt;IUserService&gt;();
            var permissions = new List&lt;EntityPermission&gt;
                {
                    new EntityPermission(9, 1234, new string[]{ &quot;A&quot; })
                };
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, -1)).Returns(permissions);
            var userService = userServiceMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, userService, null, -1, new[] { &#39;A&#39;});

            //assert
            Assert.IsTrue(result);
        }

        [Test]
        public void No_Access_To_Root_By_Permission()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(0);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;

            var userServiceMock = new Mock&lt;IUserService&gt;();
            var permissions = new List&lt;EntityPermission&gt;
                {
                    new EntityPermission(9, 1234, new string[]{ &quot;A&quot; })
                };
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, -1)).Returns(permissions);
            var userService = userServiceMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, userService, null, -1, new[] { &#39;B&#39;});

            //assert
            Assert.IsFalse(result);
        }

        [Test]
        public void Access_To_Recycle_Bin_By_Permission()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(0);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;

            var userServiceMock = new Mock&lt;IUserService&gt;();
            var permissions = new List&lt;EntityPermission&gt;
                {
                    new EntityPermission(9, 1234, new string[]{ &quot;A&quot; })
                };
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, -20)).Returns(permissions);
            var userService = userServiceMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, userService, null, -20, new[] { &#39;A&#39;});

            //assert
            Assert.IsTrue(result);
        }

        [Test]
        public void No_Access_To_Recycle_Bin_By_Permission()
        {
            //arrange
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(0);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;

            var userServiceMock = new Mock&lt;IUserService&gt;();
            var permissions = new List&lt;EntityPermission&gt;
                {
                    new EntityPermission(9, 1234, new string[]{ &quot;A&quot; })
                };
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, -20)).Returns(permissions);
            var userService = userServiceMock.Object;

            //act
            var result = ContentController.CheckPermissions(new Dictionary&lt;string, object&gt;(), user, userService, null, -20, new[] { &#39;B&#39;});

            //assert
            Assert.IsFalse(result);
        }

    }

    //NOTE: The below self hosted stuff does work so need to get some tests written. Some are not possible atm because
    // of the legacy SQL calls like checking permissions.

    //[TestFixture]
    //public class ContentControllerHostedTests : BaseRoutingTest
    //{

    //    protected override DatabaseBehavior DatabaseTestBehavior
    //    {
    //        get { return DatabaseBehavior.NoDatabasePerFixture; }
    //    }

    //    public override void TearDown()
    //    {
    //        base.TearDown();
    //        UmbracoAuthorizeAttribute.Enable = true;
    //        UmbracoApplicationAuthorizeAttribute.Enable = true;
    //    }

    //    /// &lt;summary&gt;
    //    /// Tests to ensure that the response filter works so that any items the user
    //    /// doesn&#39;t have access to are removed
    //    /// &lt;/summary&gt;
    //    [Test]
    //    public async void Get_By_Ids_Response_Filtered()
    //    {
    //        UmbracoAuthorizeAttribute.Enable = false;
    //        UmbracoApplicationAuthorizeAttribute.Enable = false;

    //        var baseUrl = string.Format(&quot;http://{0}:9876&quot;, Environment.MachineName);
    //        var url = baseUrl + &quot;/api/Content/GetByIds?ids=1&amp;ids=2&quot;;

    //        var routingCtx = GetRoutingContext(url, 1234, null, true);

    //        var config = new HttpSelfHostConfiguration(baseUrl);
    //        using (var server = new HttpSelfHostServer(config))
    //        {
    //            var route = config.Routes.MapHttpRoute(&quot;test&quot;, &quot;api/Content/GetByIds&quot;,
    //            new
    //            {
    //                controller = &quot;Content&quot;,
    //                action = &quot;GetByIds&quot;,
    //                id = RouteParameter.Optional
    //            });
    //            route.DataTokens[&quot;Namespaces&quot;] = new string[] { &quot;Umbraco.Web.Editors&quot; };

    //            var client = new HttpClient(server);

    //            var request = new HttpRequestMessage
    //            {
    //                RequestUri = new Uri(url),
    //                Method = HttpMethod.Get
    //            };

    //            var result = await client.SendAsync(request);
    //        }
             
    //    }

    //}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,10,1],[19,13,19,46,1],[20,13,20,50,1],[21,13,21,63,1],[22,13,22,40,1],[23,13,23,52,1],[24,13,24,68,1],[25,13,25,46,1],[26,13,26,66,1],[27,13,27,77,1],[28,13,28,60,1],[31,13,31,129,1],[34,13,34,35,1],[35,9,35,10,1],[39,9,39,10,1],[41,13,41,46,1],[42,13,42,50,1],[43,13,43,63,1],[44,13,44,40,1],[45,13,45,52,1],[46,13,46,68,1],[47,13,47,46,1],[48,13,48,66,1],[49,13,49,74,1],[50,13,50,60,1],[51,13,51,60,1],[52,13,52,60,1],[53,13,53,91,1],[54,13,54,54,1],[57,13,57,56,1],[57,56,57,180,1],[57,180,57,182,1],[57,13,57,182,1],[58,9,58,10,1],[62,9,62,10,1],[64,13,64,46,1],[65,13,65,50,1],[66,13,66,65,1],[67,13,67,40,1],[68,13,68,52,1],[69,13,69,68,1],[70,13,70,46,1],[71,13,71,66,1],[72,13,72,77,1],[73,13,73,60,1],[74,13,74,60,1],[75,13,75,60,1],[76,13,76,91,1],[77,13,77,54,1],[80,13,80,150,1],[83,13,83,36,1],[84,9,84,10,1],[88,9,88,10,1],[90,13,90,46,1],[91,13,91,50,1],[92,13,92,63,1],[93,13,93,40,1],[94,13,94,52,1],[95,13,95,68,1],[96,13,96,46,1],[97,13,97,66,1],[98,13,98,77,1],[99,13,99,60,1],[100,13,100,60,1],[101,13,104,19,1],[105,13,105,91,1],[106,13,106,54,1],[109,13,109,150,1],[112,13,112,36,1],[113,9,113,10,1],[117,9,117,10,1],[119,13,119,46,1],[120,13,120,50,1],[121,13,121,63,1],[122,13,122,40,1],[123,13,123,52,1],[124,13,124,68,1],[125,13,125,46,1],[126,13,126,66,1],[127,13,127,77,1],[128,13,128,60,1],[129,13,129,60,1],[130,13,133,19,1],[134,13,134,91,1],[135,13,135,54,1],[138,13,138,150,1],[141,13,141,35,1],[142,9,142,10,1],[146,9,146,10,1],[148,13,148,46,1],[149,13,149,50,1],[150,13,150,63,1],[151,13,151,40,1],[154,13,154,117,1],[157,13,157,35,1],[158,9,158,10,1],[162,9,162,10,1],[164,13,164,46,1],[165,13,165,50,1],[166,13,166,63,1],[167,13,167,40,1],[170,13,170,118,1],[173,13,173,35,1],[174,9,174,10,1],[178,9,178,10,1],[180,13,180,46,1],[181,13,181,50,1],[182,13,182,65,1],[183,13,183,40,1],[186,13,186,118,1],[189,13,189,36,1],[190,9,190,10,1],[194,9,194,10,1],[196,13,196,46,1],[197,13,197,50,1],[198,13,198,65,1],[199,13,199,40,1],[202,13,202,117,1],[205,13,205,36,1],[206,9,206,10,1],[210,9,210,10,1],[212,13,212,46,1],[213,13,213,50,1],[214,13,214,63,1],[215,13,215,40,1],[217,13,217,60,1],[218,13,221,19,1],[222,13,222,89,1],[223,13,223,54,1],[226,13,226,138,1],[229,13,229,35,1],[230,9,230,10,1],[234,9,234,10,1],[236,13,236,46,1],[237,13,237,50,1],[238,13,238,63,1],[239,13,239,40,1],[241,13,241,60,1],[242,13,245,19,1],[246,13,246,89,1],[247,13,247,54,1],[250,13,250,138,1],[253,13,253,36,1],[254,9,254,10,1],[258,9,258,10,1],[260,13,260,46,1],[261,13,261,50,1],[262,13,262,63,1],[263,13,263,40,1],[265,13,265,60,1],[266,13,269,19,1],[270,13,270,90,1],[271,13,271,54,1],[274,13,274,139,1],[277,13,277,35,1],[278,9,278,10,1],[282,9,282,10,1],[284,13,284,46,1],[285,13,285,50,1],[286,13,286,63,1],[287,13,287,40,1],[289,13,289,60,1],[290,13,293,19,1],[294,13,294,90,1],[295,13,295,54,1],[298,13,298,139,1],[301,13,301,36,1],[302,9,302,10,1]]);
    </script>
  </body>
</html>