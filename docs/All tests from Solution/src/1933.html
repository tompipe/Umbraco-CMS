<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\UserFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Models.Rdbms;

namespace Umbraco.Core.Persistence.Factories
{
    internal class UserFactory 
    {
        private readonly IUserType _userType;

        public UserFactory(IUserType userType)
        {
            _userType = userType;
        }

        #region Implementation of IEntityFactory&lt;IUser,UserDto&gt;

        public IUser BuildEntity(UserDto dto)
        {
            var guidId = dto.Id.ToGuid();
            var user = new User(_userType);

            try
            {
                user.DisableChangeTracking();

                user.Id = dto.Id;
                user.Key = guidId;
                user.StartContentId = dto.ContentStartId;
                user.StartMediaId = dto.MediaStartId.HasValue ? dto.MediaStartId.Value : -1;
                user.RawPasswordValue = dto.Password;
                user.Username = dto.Login;
                user.Name = dto.UserName;
                user.IsLockedOut = dto.NoConsole;
                user.IsApproved = dto.Disabled == false;
                user.Email = dto.Email;
                user.Language = dto.UserLanguage;
                user.SecurityStamp = dto.SecurityStampToken;
                user.FailedPasswordAttempts = dto.FailedLoginAttempts ?? 0;
                user.LastLockoutDate = dto.LastLockoutDate ?? DateTime.MinValue;
                user.LastLoginDate = dto.LastLoginDate ?? DateTime.MinValue;
                user.LastPasswordChangeDate = dto.LastPasswordChangeDate ?? DateTime.MinValue;

                foreach (var app in dto.User2AppDtos)
                {
                    user.AddAllowedSection(app.AppAlias);
                }

                //on initial construction we don&#39;t want to have dirty properties tracked
                // http://issues.umbraco.org/issue/U4-1946
                user.ResetDirtyProperties(false);

                return user;
            }
            finally
            {
                user.EnableChangeTracking();
            }
        }

        public UserDto BuildDto(IUser entity)
        {
            var dto = new UserDto
                          {
                              ContentStartId = entity.StartContentId,
                              MediaStartId = entity.StartMediaId,
                              Disabled = entity.IsApproved == false,
                              Email = entity.Email,
                              Login = entity.Username,
                              NoConsole = entity.IsLockedOut,
                              Password = entity.RawPasswordValue,
                              UserLanguage = entity.Language,
                              UserName = entity.Name,
                              Type = short.Parse(entity.UserType.Id.ToString(CultureInfo.InvariantCulture)),
                              User2AppDtos = new List&lt;User2AppDto&gt;(),
                              SecurityStampToken = entity.SecurityStamp,
                              FailedLoginAttempts = entity.FailedPasswordAttempts,
                              LastLockoutDate = entity.LastLockoutDate == DateTime.MinValue ? (DateTime?)null : entity.LastLockoutDate,
                              LastLoginDate = entity.LastLoginDate == DateTime.MinValue ? (DateTime?)null : entity.LastLoginDate,
                              LastPasswordChangeDate = entity.LastPasswordChangeDate == DateTime.MinValue ? (DateTime?)null : entity.LastPasswordChangeDate,
                          };

            foreach (var app in entity.AllowedSections)
            {
                var appDto = new User2AppDto
                    {
                        AppAlias = app
                    };
                if (entity.HasIdentity)
                {
                    appDto.UserId = (int) entity.Id;
                }

                dto.User2AppDtos.Add(appDto);
            }

            if (entity.HasIdentity)
                dto.Id = entity.Id.SafeCast&lt;int&gt;();

            return dto;
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,9,14,47,1],[15,9,15,10,1],[16,13,16,34,1],[17,9,17,10,1],[22,9,22,10,1],[23,13,23,42,1],[24,13,24,44,1],[27,13,27,14,1],[28,17,28,46,1],[30,17,30,34,1],[31,17,31,35,1],[32,17,32,58,1],[33,17,33,93,1],[34,17,34,54,1],[35,17,35,43,1],[36,17,36,42,1],[37,17,37,50,1],[38,17,38,57,1],[39,17,39,40,1],[40,17,40,50,1],[41,17,41,61,1],[42,17,42,76,1],[43,17,43,81,1],[44,17,44,77,1],[45,17,45,95,1],[47,17,47,24,1],[47,26,47,33,1],[47,34,47,36,1],[47,37,47,53,1],[48,17,48,18,1],[49,21,49,58,1],[50,17,50,18,1],[54,17,54,50,1],[56,17,56,29,1],[59,13,59,14,1],[60,17,60,45,1],[61,13,61,14,1],[62,9,62,10,1],[65,9,65,10,1],[66,13,84,29,1],[86,13,86,20,1],[86,22,86,29,1],[86,30,86,32,1],[86,33,86,55,1],[87,13,87,14,1],[88,17,91,23,1],[92,17,92,40,1],[93,17,93,18,1],[94,21,94,53,1],[95,17,95,18,1],[97,17,97,46,1],[98,13,98,14,1],[100,13,100,36,1],[101,17,101,52,1],[103,13,103,24,1],[104,9,104,10,1]]);
    </script>
  </body>
</html>