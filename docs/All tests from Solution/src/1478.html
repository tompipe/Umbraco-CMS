<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Packaging\PackageExtraction.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using ICSharpCode.SharpZipLib.Zip;

namespace Umbraco.Core.Packaging
{
    internal class PackageExtraction : IPackageExtraction
    {
        public string ReadTextFileFromArchive(string packageFilePath, string fileToRead, out string directoryInPackage)
        {
            string retVal = null;
            bool fileFound = false;
            string foundDir = null;

            ReadZipfileEntries(packageFilePath, (entry, stream) =&gt;
            {
                string fileName = Path.GetFileName(entry.Name);

                if (string.IsNullOrEmpty(fileName) == false &amp;&amp;
                    fileName.Equals(fileToRead, StringComparison.CurrentCultureIgnoreCase))
                {

                    foundDir = entry.Name.Substring(0, entry.Name.Length - fileName.Length);
                    fileFound = true;
                    using (var reader = new StreamReader(stream))
                    {
                        retVal = reader.ReadToEnd();
                        return false;
                    }
                }
                return true;
            });

            if (fileFound == false)
            {
                directoryInPackage = null;
                throw new FileNotFoundException(string.Format(&quot;Could not find file in package {0}&quot;, packageFilePath), fileToRead);
            }
            directoryInPackage = foundDir;
            return retVal;
        }

        private static void CheckPackageExists(string packageFilePath)
        {
            if (string.IsNullOrEmpty(packageFilePath))
            {
                throw new ArgumentNullException(&quot;packageFilePath&quot;);
            }

            if (File.Exists(packageFilePath) == false)
            {
                if (File.Exists(packageFilePath) == false)
                    throw new ArgumentException(string.Format(&quot;Package file: {0} could not be found&quot;, packageFilePath));
            }

            string extension = Path.GetExtension(packageFilePath).ToLower();

            var alowedExtension = new[] { &quot;.umb&quot;, &quot;.zip&quot; };

            // Check if the file is a valid package
            if (alowedExtension.All(ae =&gt; ae.Equals(extension) == false))
            {
                throw new ArgumentException(
                    string.Format(&quot;Error - file isn&#39;t a package. only extentions: \&quot;{0}\&quot; is allowed&quot;, string.Join(&quot;, &quot;, alowedExtension)));
            }
        }
        
        public void CopyFileFromArchive(string packageFilePath, string fileInPackageName, string destinationfilePath)
        {
            CopyFilesFromArchive(packageFilePath, new[]{new KeyValuePair&lt;string, string&gt;(fileInPackageName, destinationfilePath) } );
        }

        public void CopyFilesFromArchive(string packageFilePath, IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt; sourceDestination)
        {
            var d = sourceDestination.ToDictionary(k =&gt; k.Key.ToLower(), v =&gt; v.Value);


            ReadZipfileEntries(packageFilePath, (entry, stream) =&gt;
            {
                string fileName = (Path.GetFileName(entry.Name) ?? string.Empty).ToLower();
                if (fileName == string.Empty) { return true; }

                string destination;
                if (string.IsNullOrEmpty(fileName) == false &amp;&amp; d.TryGetValue(fileName, out destination))
                {
                    using (var streamWriter = File.Open(destination, FileMode.Create))
                    {
                        stream.CopyTo(streamWriter);
                    }

                    d.Remove(fileName);
                    return d.Any();
                }
                return true;
            });

            if (d.Any())
            {
                throw new ArgumentException(string.Format(&quot;The following source file(s): \&quot;{0}\&quot; could not be found in archive: \&quot;{1}\&quot;&quot;, string.Join(&quot;\&quot;, \&quot;&quot;,d.Keys), packageFilePath));
            }
        }

        public IEnumerable&lt;string&gt; FindMissingFiles(string packageFilePath, IEnumerable&lt;string&gt; expectedFiles)
        {
            var retVal = expectedFiles.ToList();

            ReadZipfileEntries(packageFilePath, (zipEntry, stream) =&gt;
            {
                string fileName = Path.GetFileName(zipEntry.Name);

                int index = retVal.FindIndex(f =&gt; f.Equals(fileName, StringComparison.InvariantCultureIgnoreCase));

                if (index != -1) { retVal.RemoveAt(index); }

                return retVal.Any();
            });
            return retVal;

        }

        public IEnumerable&lt;string&gt; FindDubletFileNames(string packageFilePath)
        {
            var dictionary = new Dictionary&lt;string, List&lt;string&gt;&gt;();


            ReadZipfileEntries(packageFilePath, (entry, stream) =&gt;
            {
                string fileName = (Path.GetFileName(entry.Name) ?? string.Empty).ToLower();

                List&lt;string&gt; list;
                if (dictionary.TryGetValue(fileName, out list) == false)
                {
                    list = new List&lt;string&gt;();
                    dictionary.Add(fileName, list);
                }

                list.Add(entry.Name);

                return true;
            });

            return dictionary.Values.Where(v =&gt; v.Count &gt; 1).SelectMany(v =&gt; v);
        }

        public IEnumerable&lt;byte[]&gt; ReadFilesFromArchive(string packageFilePath, IEnumerable&lt;string&gt; filesToGet)
        {
            CheckPackageExists(packageFilePath);

            var files = new HashSet&lt;string&gt;(filesToGet.Select(f =&gt; f.ToLower()));

            using (var fs = File.OpenRead(packageFilePath))
            {
                using (var zipInputStream = new ZipInputStream(fs))
                {
                    ZipEntry zipEntry;
                    while ((zipEntry = zipInputStream.GetNextEntry()) != null)
                    {
                        
                        if (zipEntry.IsDirectory) continue;

                        if (files.Contains(zipEntry.Name))
                        {
                            using (var memStream = new MemoryStream())
                            {
                                zipInputStream.CopyTo(memStream);
                                yield return memStream.ToArray();
                                memStream.Close();
                            }
                        }
                    }

                    zipInputStream.Close();
                }
                fs.Close();
            }
        }

        private void ReadZipfileEntries(string packageFilePath, Func&lt;ZipEntry, ZipInputStream, bool&gt; entryFunc, bool skipsDirectories = true)
        {
            CheckPackageExists(packageFilePath);

            using (var fs = File.OpenRead(packageFilePath))
            {
                using (var zipInputStream = new ZipInputStream(fs))
                {
                    ZipEntry zipEntry;
                    while ((zipEntry = zipInputStream.GetNextEntry()) != null)
                    {
                        if (zipEntry.IsDirectory &amp;&amp; skipsDirectories) continue;
                        if (entryFunc(zipEntry, zipInputStream) == false) break;
                    }

                    zipInputStream.Close();
                }
                fs.Close();
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,9,12,10,1],[13,13,13,34,1],[14,13,14,36,1],[15,13,15,36,1],[17,13,18,13,1],[18,13,18,14,1],[18,14,19,17,1],[19,17,19,64,1],[19,64,21,17,1],[21,17,22,92,1],[22,92,23,17,1],[23,17,23,18,1],[23,18,25,21,1],[25,21,25,93,1],[25,93,26,21,1],[26,21,26,38,1],[26,38,27,28,1],[27,28,27,65,1],[27,65,28,21,1],[28,21,28,22,1],[28,22,29,25,1],[29,25,29,53,1],[29,53,30,25,1],[30,25,30,38,1],[30,38,33,17,1],[33,17,33,29,1],[33,29,34,13,1],[34,13,34,14,1],[34,14,34,16,1],[17,13,34,16,1],[36,13,36,36,1],[37,13,37,14,0],[38,17,38,43,0],[39,17,39,131,0],[41,13,41,43,1],[42,13,42,27,1],[43,9,43,10,1],[46,9,46,10,1],[47,13,47,55,1],[48,13,48,14,0],[49,17,49,68,0],[52,13,52,55,1],[53,13,53,14,0],[54,17,54,59,0],[55,21,55,121,0],[56,13,56,14,0],[58,13,58,77,1],[60,13,60,60,1],[63,13,63,43,1],[63,43,63,72,1],[63,72,63,74,1],[63,13,63,74,1],[64,13,64,14,0],[65,17,66,141,0],[68,9,68,10,1],[71,9,71,10,0],[72,13,72,134,0],[73,9,73,10,0],[76,9,76,10,1],[77,13,77,57,1],[77,57,77,72,1],[77,72,77,79,1],[77,79,77,86,1],[77,86,77,88,1],[77,13,77,88,1],[80,13,81,13,1],[81,13,81,14,1],[81,14,82,17,1],[82,17,82,92,1],[82,92,83,17,1],[83,17,83,46,1],[83,46,83,47,1],[83,47,83,48,0],[83,48,83,49,1],[83,49,83,61,0],[83,61,86,17,1],[86,17,86,105,1],[86,105,87,17,1],[87,17,87,18,1],[87,18,88,28,1],[88,28,88,86,1],[88,86,89,21,1],[89,21,89,22,1],[89,22,90,25,1],[90,25,90,53,1],[90,53,91,21,1],[91,21,91,22,1],[91,22,93,21,1],[93,21,93,40,1],[93,40,94,21,1],[94,21,94,36,1],[94,36,96,17,1],[96,17,96,29,0],[96,29,97,13,1],[97,13,97,14,1],[97,14,97,16,1],[80,13,97,16,1],[99,13,99,25,1],[100,13,100,14,0],[101,17,101,187,0],[103,9,103,10,1],[106,9,106,10,1],[107,13,107,49,1],[109,13,110,13,1],[110,13,110,14,1],[110,14,111,17,1],[111,17,111,67,1],[111,67,113,17,1],[113,17,113,51,1],[113,51,113,114,1],[113,114,113,116,1],[113,17,113,116,1],[113,116,115,17,1],[115,17,115,33,1],[115,33,115,34,1],[115,34,115,35,1],[115,35,115,36,1],[115,36,115,59,1],[115,59,115,60,1],[115,60,115,61,1],[115,61,117,17,1],[117,17,117,37,1],[117,37,118,13,1],[118,13,118,14,1],[118,14,118,16,1],[109,13,118,16,1],[119,13,119,27,1],[121,9,121,10,1],[124,9,124,10,1],[125,13,125,69,1],[128,13,129,13,1],[129,13,129,14,1],[129,14,130,17,1],[130,17,130,92,1],[130,92,133,17,1],[133,17,133,73,1],[133,73,134,17,1],[134,17,134,18,1],[134,18,135,21,1],[135,21,135,47,1],[135,47,136,21,1],[136,21,136,52,1],[136,52,137,17,1],[137,17,137,18,1],[137,18,139,17,1],[139,17,139,38,1],[139,38,141,17,1],[141,17,141,29,1],[141,29,142,13,1],[142,13,142,14,1],[142,14,142,16,1],[128,13,142,16,1],[144,13,144,49,1],[144,49,144,60,1],[144,60,144,78,1],[144,78,144,79,0],[144,79,144,81,1],[144,13,144,81,1],[145,9,145,10,1],[181,9,181,10,1],[182,13,182,49,1],[184,20,184,59,1],[185,13,185,14,1],[186,24,186,67,1],[187,17,187,18,1],[189,21,189,79,1],[190,21,190,22,1],[191,25,191,70,1],[191,71,191,80,0],[192,25,192,74,1],[192,75,192,81,1],[193,21,193,22,1],[195,21,195,44,1],[196,17,196,18,1],[197,17,197,28,1],[198,13,198,14,1],[199,9,199,10,1]]);
    </script>
  </body>
</html>