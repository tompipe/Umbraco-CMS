<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Web\WebExtensionMethodTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Logging;
using Umbraco.Core.Profiling;
using Umbraco.Web;
using Umbraco.Web.Mvc;
using Umbraco.Web.Routing;
using Umbraco.Web.Security;

namespace Umbraco.Tests.Web
{
    [TestFixture]
    public class WebExtensionMethodTests
    {

        [Test]
        public void UmbracoContextExtensions_GetUmbracoContext()
        {
            var appCtx = new ApplicationContext(
               CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            var umbCtx = UmbracoContext.CreateContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new WebSecurity(Mock.Of&lt;HttpContextBase&gt;(), appCtx),
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                new List&lt;IUrlProvider&gt;(),
                false);
            var items = new Dictionary&lt;object, object&gt;()
            {
                {UmbracoContext.HttpContextItemName, umbCtx}
            };
            var http = new Mock&lt;HttpContextBase&gt;();
            http.Setup(x =&gt; x.Items).Returns(items);

            var result = http.Object.GetUmbracoContext();

            Assert.IsNotNull(result);
            Assert.AreSame(umbCtx, result);
        }

        [Test]
        public void RouteDataExtensions_GetUmbracoContext()
        {
            var appCtx = new ApplicationContext(
               CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            var umbCtx = UmbracoContext.CreateContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new WebSecurity(Mock.Of&lt;HttpContextBase&gt;(), appCtx),
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                new List&lt;IUrlProvider&gt;(),
                false);
            var r1 = new RouteData();
            r1.DataTokens.Add(Core.Constants.Web.UmbracoContextDataToken, umbCtx);

            var result = r1.GetUmbracoContext();

            Assert.IsNotNull(result);
            Assert.AreSame(umbCtx, result);
        }

        [Test]
        public void ControllerContextExtensions_GetUmbracoContext_From_RouteValues()
        {
            var appCtx = new ApplicationContext(
               CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            var umbCtx = UmbracoContext.CreateContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new WebSecurity(Mock.Of&lt;HttpContextBase&gt;(), appCtx),
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                new List&lt;IUrlProvider&gt;(),
                false);

            var r1 = new RouteData();
            r1.DataTokens.Add(Core.Constants.Web.UmbracoContextDataToken, umbCtx);
            var ctx1 = CreateViewContext(new ControllerContext(Mock.Of&lt;HttpContextBase&gt;(), r1, new MyController()));
            var r2 = new RouteData();
            r2.DataTokens.Add(&quot;ParentActionViewContext&quot;, ctx1);
            var ctx2 = CreateViewContext(new ControllerContext(Mock.Of&lt;HttpContextBase&gt;(), r2, new MyController()));
            var r3 = new RouteData();
            r3.DataTokens.Add(&quot;ParentActionViewContext&quot;, ctx2);
            var ctx3 = CreateViewContext(new ControllerContext(Mock.Of&lt;HttpContextBase&gt;(), r3, new MyController()));

            var result = ctx3.GetUmbracoContext();

            Assert.IsNotNull(result);
            Assert.AreSame(umbCtx, result);
        }

        [Test]
        public void ControllerContextExtensions_GetUmbracoContext_From_HttpContext()
        {
            var appCtx = new ApplicationContext(
               CacheHelper.CreateDisabledCacheHelper(),
               new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            var umbCtx = UmbracoContext.CreateContext(
                Mock.Of&lt;HttpContextBase&gt;(),
                appCtx,
                new WebSecurity(Mock.Of&lt;HttpContextBase&gt;(), appCtx),
                Mock.Of&lt;IUmbracoSettingsSection&gt;(),
                new List&lt;IUrlProvider&gt;(),
                false);
            var items = new Dictionary&lt;object, object&gt;()
            {
                {UmbracoContext.HttpContextItemName, umbCtx}
            };
            var http = new Mock&lt;HttpContextBase&gt;();
            http.Setup(x =&gt; x.Items).Returns(items);

            var r1 = new RouteData();
            var ctx1 = CreateViewContext(new ControllerContext(http.Object, r1, new MyController()));
            var r2 = new RouteData();
            r2.DataTokens.Add(&quot;ParentActionViewContext&quot;, ctx1);
            var ctx2 = CreateViewContext(new ControllerContext(http.Object, r2, new MyController()));
            var r3 = new RouteData();
            r3.DataTokens.Add(&quot;ParentActionViewContext&quot;, ctx2);
            var ctx3 = CreateViewContext(new ControllerContext(http.Object, r3, new MyController()));

            var result = ctx3.GetUmbracoContext();

            Assert.IsNotNull(result);
            Assert.AreSame(umbCtx, result);
        }

        [Test]
        public void ControllerContextExtensions_GetDataTokenInViewContextHierarchy()
        {
            var r1 = new RouteData();
            r1.DataTokens.Add(&quot;hello&quot;, &quot;world&quot;);
            var ctx1 = CreateViewContext(new ControllerContext(Mock.Of&lt;HttpContextBase&gt;(), r1, new MyController()));
            var r2 = new RouteData();
            r2.DataTokens.Add(&quot;ParentActionViewContext&quot;, ctx1);
            var ctx2 = CreateViewContext(new ControllerContext(Mock.Of&lt;HttpContextBase&gt;(), r2, new MyController()));
            var r3 = new RouteData();
            r3.DataTokens.Add(&quot;ParentActionViewContext&quot;, ctx2);
            var ctx3 = CreateViewContext(new ControllerContext(Mock.Of&lt;HttpContextBase&gt;(), r3, new MyController()));

            var result = ctx3.GetDataTokenInViewContextHierarchy(&quot;hello&quot;);

            Assert.IsNotNull(result as string);
            Assert.AreEqual((string)result, &quot;world&quot;);
        }

        private ViewContext CreateViewContext(ControllerContext ctx)
        {
            return new ViewContext(ctx, Mock.Of&lt;IView&gt;(),
                new ViewDataDictionary(), new TempDataDictionary(), new StringWriter());
        }

        private class MyController : Controller
        {
            
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,29,10,1],[30,13,32,79,1],[33,13,39,24,1],[40,13,43,15,1],[44,13,44,52,1],[45,13,45,53,1],[47,13,47,58,1],[49,13,49,38,1],[50,13,50,44,1],[51,9,51,10,1],[55,9,55,10,1],[56,13,58,79,1],[59,13,65,24,1],[66,13,66,38,1],[67,13,67,83,1],[69,13,69,49,1],[71,13,71,38,1],[72,13,72,44,1],[73,9,73,10,1],[77,9,77,10,1],[78,13,80,79,1],[81,13,87,24,1],[89,13,89,38,1],[90,13,90,83,1],[91,13,91,117,1],[92,13,92,38,1],[93,13,93,64,1],[94,13,94,117,1],[95,13,95,38,1],[96,13,96,64,1],[97,13,97,117,1],[99,13,99,51,1],[101,13,101,38,1],[102,13,102,44,1],[103,9,103,10,1],[107,9,107,10,1],[108,13,110,79,1],[111,13,117,24,1],[118,13,121,15,1],[122,13,122,52,1],[123,13,123,53,1],[125,13,125,38,1],[126,13,126,102,1],[127,13,127,38,1],[128,13,128,64,1],[129,13,129,102,1],[130,13,130,38,1],[131,13,131,64,1],[132,13,132,102,1],[134,13,134,51,1],[136,13,136,38,1],[137,13,137,44,1],[138,9,138,10,1],[142,9,142,10,1],[143,13,143,38,1],[144,13,144,49,1],[145,13,145,117,1],[146,13,146,38,1],[147,13,147,64,1],[148,13,148,117,1],[149,13,149,38,1],[150,13,150,64,1],[151,13,151,117,1],[153,13,153,75,1],[155,13,155,48,1],[156,13,156,54,1],[157,9,157,10,1],[160,9,160,10,1],[161,13,162,89,1],[163,9,163,10,1]]);
    </script>
  </body>
</html>