<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\channels\config.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Web;
using System.Xml;
using umbraco.BusinessLogic;
using Umbraco.Core.IO;

namespace umbraco.presentation.channels.businesslogic
{
    public class config
    {
        private static XmlDocument _metablogConfigFile;

        public static XmlDocument MetaBlogConfigFile
        {
            get
            {
                if (_metablogConfigFile == null)
                {
                    _metablogConfigFile = new XmlDocument();
                    _metablogConfigFile.Load(IOHelper.MapPath(SystemFiles.MetablogConfig));
                }

                return _metablogConfigFile;
            }
        }
    }

    public class Channel
    {
        public Channel(string username)
        {
            User u = new User(username);
            initialize(u.Id);
        }

        public Channel(int UserId)
        {
            initialize(UserId);
        }

        private void initialize(int UserId)
        {
            XmlDocument configFile = config.MetaBlogConfigFile;
            XmlNode channelXml = configFile.SelectSingleNode(string.Format(&quot;//channel [user = &#39;{0}&#39;]&quot;, UserId));
            if (channelXml != null)
            {
                Id = UserId;
                User = new User(UserId);
                Name = channelXml.SelectSingleNode(&quot;./name&quot;).FirstChild.Value;
                StartNode = int.Parse(channelXml.SelectSingleNode(&quot;./startNode&quot;).FirstChild.Value);
                FullTree = bool.Parse(channelXml.SelectSingleNode(&quot;./fullTree&quot;).FirstChild.Value);
                DocumentTypeAlias = channelXml.SelectSingleNode(&quot;./documentTypeAlias&quot;).FirstChild.Value;
                if (channelXml.SelectSingleNode(&quot;./fields/categories&quot;).FirstChild != null)
                    FieldCategoriesAlias = channelXml.SelectSingleNode(&quot;./fields/categories&quot;).FirstChild.Value;
                if (channelXml.SelectSingleNode(&quot;./fields/description&quot;).FirstChild != null)
                    FieldDescriptionAlias = channelXml.SelectSingleNode(&quot;./fields/description&quot;).FirstChild.Value;
                if (channelXml.SelectSingleNode(&quot;./fields/excerpt&quot;) != null &amp;&amp; channelXml.SelectSingleNode(&quot;./fields/excerpt&quot;).FirstChild != null)
                    FieldExcerptAlias = channelXml.SelectSingleNode(&quot;./fields/excerpt&quot;).FirstChild.Value;

                XmlNode mediaSupport = channelXml.SelectSingleNode(&quot;./mediaObjectSupport&quot;);
                ImageSupport = bool.Parse(mediaSupport.Attributes.GetNamedItem(&quot;enabled&quot;).Value);
                MediaFolder = int.Parse(mediaSupport.Attributes.GetNamedItem(&quot;folderId&quot;).Value);
                MediaTypeAlias = mediaSupport.Attributes.GetNamedItem(&quot;mediaTypeAlias&quot;).Value;
                MediaTypeFileProperty = mediaSupport.Attributes.GetNamedItem(&quot;mediaTypeFileProperty&quot;).Value;
            }
            else
                throw new ArgumentException(string.Format(&quot;No channel found for user with id: &#39;{0}&#39;&quot;, UserId));
        }

        public Channel()
        {
        }

        public void Save()
        {
            // update node
            XmlDocument configFile = config.MetaBlogConfigFile;
            XmlNode channelXml = null;
            if (User != null &amp;&amp; User.Id &gt; -1)
                channelXml = configFile.SelectSingleNode(string.Format(&quot;//channel [user = &#39;{0}&#39;]&quot;, this.User.Id));
            if (channelXml != null)
                configFile.DocumentElement.RemoveChild(channelXml);

            // add new node
            XmlElement newChannelxml = configFile.CreateElement(&quot;channel&quot;);
            newChannelxml.AppendChild(
                xmlHelper.addTextNode(configFile, &quot;name&quot;, Name));
            newChannelxml.AppendChild(
                xmlHelper.addTextNode(configFile, &quot;user&quot;, User.Id.ToString()));
            newChannelxml.AppendChild(
                xmlHelper.addTextNode(configFile, &quot;startNode&quot;, StartNode.ToString()));
            newChannelxml.AppendChild(
                xmlHelper.addTextNode(configFile, &quot;fullTree&quot;, FullTree.ToString()));
            newChannelxml.AppendChild(
                xmlHelper.addTextNode(configFile, &quot;documentTypeAlias&quot;, DocumentTypeAlias));
            
            // fields
            XmlElement fieldsxml = configFile.CreateElement(&quot;fields&quot;);
            fieldsxml.AppendChild(
                xmlHelper.addTextNode(configFile, &quot;categories&quot;, FieldCategoriesAlias));
            fieldsxml.AppendChild(
                xmlHelper.addTextNode(configFile, &quot;description&quot;, FieldDescriptionAlias));
            fieldsxml.AppendChild(
                xmlHelper.addTextNode(configFile, &quot;excerpt&quot;, FieldExcerptAlias));
            newChannelxml.AppendChild(fieldsxml);


            // media
            XmlElement media = configFile.CreateElement(&quot;mediaObjectSupport&quot;);
            media.Attributes.Append(xmlHelper.addAttribute(configFile, &quot;enabled&quot;, ImageSupport.ToString()));
            media.Attributes.Append(xmlHelper.addAttribute(configFile, &quot;folderId&quot;, MediaFolder.ToString()));
            media.Attributes.Append(xmlHelper.addAttribute(configFile, &quot;mediaTypeAlias&quot;, MediaTypeAlias));
            media.Attributes.Append(xmlHelper.addAttribute(configFile, &quot;mediaTypeFileProperty&quot;, MediaTypeFileProperty));
            newChannelxml.AppendChild(media);
            configFile.DocumentElement.AppendChild(newChannelxml);

            configFile.Save( IOHelper.MapPath( SystemFiles.MetablogConfig ));


        }

        private string  _fieldExcerptAlias;

        public string FieldExcerptAlias
        {
            get { return _fieldExcerptAlias; }
            set { _fieldExcerptAlias = value; }
        }
	

        private string _mediaTypeFileProperty;

        public string MediaTypeFileProperty
        {
            get { return _mediaTypeFileProperty; }
            set { _mediaTypeFileProperty = value; }
        }


        private string _mediaTypeAlias;

        public string MediaTypeAlias
        {
            get { return _mediaTypeAlias; }
            set { _mediaTypeAlias = value; }
        }


        private int _mediaFolder;

        public int MediaFolder
        {
            get { return _mediaFolder; }
            set { _mediaFolder = value; }
        }


        private bool _imageSupport;

        public bool ImageSupport
        {
            get { return _imageSupport; }
            set { _imageSupport = value; }
        }


        private int _startNode;

        public int StartNode
        {
            get { return _startNode; }
            set { _startNode = value; }
        }


        private int _id;

        public int Id
        {
            get { return _id; }
            set { _id = value; }
        }


        private string _fieldCategoriesAlias;

        public string FieldCategoriesAlias
        {
            get { return _fieldCategoriesAlias; }
            set { _fieldCategoriesAlias = value; }
        }


        private string _fieldDescriptionAlias;

        public string FieldDescriptionAlias
        {
            get { return _fieldDescriptionAlias; }
            set { _fieldDescriptionAlias = value; }
        }


        private string _documentTypeAlias;

        public string DocumentTypeAlias
        {
            get { return _documentTypeAlias; }
            set { _documentTypeAlias = value; }
        }


        private bool _fulltree;

        public bool FullTree
        {
            get { return _fulltree; }
            set { _fulltree = value; }
        }


        private User _user;

        public User User
        {
            get { return _user; }
            set { _user = value; }
        }


        private string _name;

        public string Name
        {
            get { return _name; }
            set { _name = value; }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,13,17,14,0],[18,17,18,49,0],[19,17,19,18,0],[20,21,20,61,0],[21,21,21,92,0],[22,17,22,18,0],[24,17,24,44,0],[25,13,25,14,0],[31,9,31,40,0],[32,9,32,10,0],[33,13,33,41,0],[34,13,34,30,0],[35,9,35,10,0],[37,9,37,35,0],[38,9,38,10,0],[39,13,39,32,0],[40,9,40,10,0],[43,9,43,10,0],[44,13,44,64,0],[45,13,45,113,0],[46,13,46,36,0],[47,13,47,14,0],[48,17,48,29,0],[49,17,49,41,0],[50,17,50,79,0],[51,17,51,100,0],[52,17,52,99,0],[53,17,53,105,0],[54,17,54,91,0],[55,21,55,112,0],[56,17,56,92,0],[57,21,57,114,0],[58,17,58,147,0],[59,21,59,106,0],[61,17,61,92,0],[62,17,62,98,0],[63,17,63,97,0],[64,17,64,95,0],[65,17,65,109,0],[66,13,66,14,0],[68,17,68,112,0],[69,9,69,10,0],[71,9,71,25,0],[72,9,72,10,0],[73,9,73,10,0],[76,9,76,10,0],[78,13,78,64,0],[79,13,79,39,0],[80,13,80,46,0],[81,17,81,115,0],[82,13,82,36,0],[83,17,83,68,0],[86,13,86,76,0],[87,13,88,66,0],[89,13,90,80,0],[91,13,92,87,0],[93,13,94,85,0],[95,13,96,92,0],[99,13,99,71,0],[100,13,101,88,0],[102,13,103,90,0],[104,13,105,82,0],[106,13,106,50,0],[110,13,110,79,0],[111,13,111,109,0],[112,13,112,109,0],[113,13,113,107,0],[114,13,114,121,0],[115,13,115,46,0],[116,13,116,67,0],[118,13,118,78,0],[121,9,121,10,0],[127,17,127,18,0],[127,19,127,45,0],[127,46,127,47,0],[128,17,128,18,0],[128,19,128,46,0],[128,47,128,48,0],[136,17,136,18,0],[136,19,136,49,0],[136,50,136,51,0],[137,17,137,18,0],[137,19,137,50,0],[137,51,137,52,0],[145,17,145,18,0],[145,19,145,42,0],[145,43,145,44,0],[146,17,146,18,0],[146,19,146,43,0],[146,44,146,45,0],[154,17,154,18,0],[154,19,154,39,0],[154,40,154,41,0],[155,17,155,18,0],[155,19,155,40,0],[155,41,155,42,0],[163,17,163,18,0],[163,19,163,40,0],[163,41,163,42,0],[164,17,164,18,0],[164,19,164,41,0],[164,42,164,43,0],[172,17,172,18,0],[172,19,172,37,0],[172,38,172,39,0],[173,17,173,18,0],[173,19,173,38,0],[173,39,173,40,0],[181,17,181,18,0],[181,19,181,30,0],[181,31,181,32,0],[182,17,182,18,0],[182,19,182,31,0],[182,32,182,33,0],[190,17,190,18,0],[190,19,190,48,0],[190,49,190,50,0],[191,17,191,18,0],[191,19,191,49,0],[191,50,191,51,0],[199,17,199,18,0],[199,19,199,49,0],[199,50,199,51,0],[200,17,200,18,0],[200,19,200,50,0],[200,51,200,52,0],[208,17,208,18,0],[208,19,208,45,0],[208,46,208,47,0],[209,17,209,18,0],[209,19,209,46,0],[209,47,209,48,0],[217,17,217,18,0],[217,19,217,36,0],[217,37,217,38,0],[218,17,218,18,0],[218,19,218,37,0],[218,38,218,39,0],[226,17,226,18,0],[226,19,226,32,0],[226,33,226,34,0],[227,17,227,18,0],[227,19,227,33,0],[227,34,227,35,0],[235,17,235,18,0],[235,19,235,32,0],[235,33,235,34,0],[236,17,236,18,0],[236,19,236,33,0],[236,34,236,35,0]]);
    </script>
  </body>
</html>