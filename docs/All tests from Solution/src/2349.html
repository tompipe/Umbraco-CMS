<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\UmbracoExamine\UmbracoMemberIndexer.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Linq;
using System.Xml.Linq;
using Examine.LuceneEngine.Config;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Services;
using UmbracoExamine.Config;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using Examine;
using System.IO;
using UmbracoExamine.DataServices;
using Lucene.Net.Analysis;

namespace UmbracoExamine
{

    /// &lt;summary&gt;
    /// Custom indexer for members
    /// &lt;/summary&gt;
    public class UmbracoMemberIndexer : UmbracoContentIndexer
    {

        private readonly IMemberService _memberService;
        private readonly IMemberTypeService _memberTypeService;
        private readonly IDataTypeService _dataTypeService;

        /// &lt;summary&gt;
        /// Default constructor
        /// &lt;/summary&gt;
        public UmbracoMemberIndexer() : base()
        {
            _dataTypeService = ApplicationContext.Current.Services.DataTypeService;
            _memberService = ApplicationContext.Current.Services.MemberService;
            _memberTypeService = ApplicationContext.Current.Services.MemberTypeService;
        }

        /// &lt;summary&gt;
        /// Constructor to allow for creating an indexer at runtime
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexerData&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;indexPath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;analyzer&quot;&gt;&lt;/param&gt;
        [Obsolete(&quot;Use the overload that specifies the Umbraco services&quot;)]
        public UmbracoMemberIndexer(IIndexCriteria indexerData, DirectoryInfo indexPath, IDataService dataService, Analyzer analyzer, bool async)
            : base(indexerData, indexPath, dataService, analyzer, async)
        {
            _dataTypeService = ApplicationContext.Current.Services.DataTypeService;
            _memberService = ApplicationContext.Current.Services.MemberService;
            _memberTypeService = ApplicationContext.Current.Services.MemberTypeService;
        }

        /// &lt;summary&gt;
        /// Constructor to allow for creating an indexer at runtime
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexerData&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;indexPath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;memberService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;analyzer&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;async&quot;&gt;&lt;/param&gt;
        [Obsolete(&quot;Use the ctor specifying all dependencies instead&quot;)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public UmbracoMemberIndexer(IIndexCriteria indexerData, DirectoryInfo indexPath, IDataService dataService,
              IDataTypeService dataTypeService,
              IMemberService memberService,
              Analyzer analyzer, bool async)
            : base(indexerData, indexPath, dataService, analyzer, async)
        {
            _dataTypeService = dataTypeService;
            _memberService = memberService;
            _memberTypeService = ApplicationContext.Current.Services.MemberTypeService;
        }

        /// &lt;summary&gt;
        /// Constructor to allow for creating an indexer at runtime
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexerData&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;indexPath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;memberService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;memberTypeService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;analyzer&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;async&quot;&gt;&lt;/param&gt;
        public UmbracoMemberIndexer(IIndexCriteria indexerData, DirectoryInfo indexPath, IDataService dataService,
              IDataTypeService dataTypeService,
              IMemberService memberService,
              IMemberTypeService memberTypeService,
              Analyzer analyzer, bool async)
            : base(indexerData, indexPath, dataService, analyzer, async)
        {
            _dataTypeService = dataTypeService;
            _memberService = memberService;
            _memberTypeService = memberTypeService;
        }

        /// &lt;summary&gt;
        /// Ensures that the&#39;_searchEmail&#39; is added to the user fields so that it is indexed - without having to modify the config
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexSet&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected override IIndexCriteria GetIndexerData(IndexSet indexSet)
        {
            var indexerData = base.GetIndexerData(indexSet);

            if (CanInitialize())
            {
                //If the fields are missing a custom _searchEmail, then add it

                if (indexerData.UserFields.Any(x =&gt; x.Name == &quot;_searchEmail&quot;) == false)
                {
                    var field = new IndexField { Name = &quot;_searchEmail&quot; };

                    StaticField policy;
                    if (IndexFieldPolicies.TryGetValue(&quot;_searchEmail&quot;, out policy))
                    {
                        field.Type = policy.Type;
                        field.EnableSorting = policy.EnableSorting;
                    }

                    return new IndexCriteria(
                        indexerData.StandardFields,
                        indexerData.UserFields.Concat(new[] { field }),
                        indexerData.IncludeNodeTypes,
                        indexerData.ExcludeNodeTypes,
                        indexerData.ParentNodeId
                        );
                }
            }

            return indexerData;
        }

        /// &lt;summary&gt;
        /// The supported types for this indexer
        /// &lt;/summary&gt;
        protected override IEnumerable&lt;string&gt; SupportedTypes
        {
            get
            {
                return new string[] { IndexTypes.Member };
            }
        }

        /// &lt;summary&gt;
        /// Reindex all members
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt;
        protected override void PerformIndexAll(string type)
        {
            //This only supports members
            if (SupportedTypes.Contains(type) == false)
                return;

            DataService.LogService.AddInfoLog(-1, string.Format(&quot;PerformIndexAll - Start data queries - {0}&quot;, type));
            var stopwatch = new Stopwatch();
            stopwatch.Start();

            try
            {
                if (DisableXmlDocumentLookup == false)
                {
                    ReindexWithXmlEntries(type, -1,
                        () =&gt; _memberTypeService.GetAll().ToArray(),
                        (path, pIndex, pSize) =&gt;
                        {
                            long totalContent;
                            var result = _memberService.GetPagedXmlEntries(pIndex, pSize, out totalContent).ToArray();
                            var more = result.Length == pSize;
                            return Tuple.Create(result, more);
                        },
                        i =&gt; _memberService.GetById(i));
                }
                else
                {
                    const int pageSize = 1000;
                    var pageIndex = 0;

                    IMember[] members;

                    if (IndexerData.IncludeNodeTypes.Any())
                    {
                        //if there are specific node types then just index those
                        foreach (var nodeType in IndexerData.IncludeNodeTypes)
                        {
                            do
                            {
                                long total;
                                members = _memberService.GetAll(pageIndex, pageSize, out total, &quot;LoginName&quot;, Direction.Ascending, true, null, nodeType).ToArray();

                                AddNodesToIndex(GetSerializedMembers(members), type);

                                pageIndex++;
                            } while (members.Length == pageSize);
                        }
                    }
                    else
                    {
                        //no node types specified, do all members
                        do
                        {
                            int total;
                            members = _memberService.GetAll(pageIndex, pageSize, out total).ToArray();

                            AddNodesToIndex(GetSerializedMembers(members), type);

                            pageIndex++;
                        } while (members.Length == pageSize);
                    }
                }
            }
            finally
            {
                stopwatch.Stop();
            }

            DataService.LogService.AddInfoLog(-1, string.Format(&quot;PerformIndexAll - End data queries - {0}, took {1}ms&quot;, type, stopwatch.ElapsedMilliseconds));
        }

        private IEnumerable&lt;XElement&gt; GetSerializedMembers(IEnumerable&lt;IMember&gt; members)
        {
            var serializer = new EntityXmlSerializer();
            return members.Select(member =&gt; serializer.Serialize(_dataTypeService, member));
        }

        protected override XDocument GetXDocument(string xPath, string type)
        {
            throw new NotSupportedException();
        }

        protected override Dictionary&lt;string, string&gt; GetSpecialFieldsToIndex(Dictionary&lt;string, string&gt; allValuesForIndexing)
        {
            var fields = base.GetSpecialFieldsToIndex(allValuesForIndexing);

            //adds the special key property to the index
            string valuesForIndexing;
            if (allValuesForIndexing.TryGetValue(&quot;__key&quot;, out valuesForIndexing))
            {
                if (fields.ContainsKey(&quot;__key&quot;) == false)
                {
                    fields.Add(&quot;__key&quot;, valuesForIndexing);
                }
            }


            return fields;

        }

        /// &lt;summary&gt;
        /// Add the special __key and _searchEmail fields
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnGatheringNodeData(IndexingNodeDataEventArgs e)
        {
            base.OnGatheringNodeData(e);

            if (e.Node.Attribute(&quot;key&quot;) != null)
            {
                if (e.Fields.ContainsKey(&quot;__key&quot;) == false)
                    e.Fields.Add(&quot;__key&quot;, e.Node.Attribute(&quot;key&quot;).Value);
            }

            if (e.Node.Attribute(&quot;email&quot;) != null)
            {
                //NOTE: the single underscore = it&#39;s not a &#39;special&#39; field which means it will be indexed normally
                if (e.Fields.ContainsKey(&quot;_searchEmail&quot;) == false)
                    e.Fields.Add(&quot;_searchEmail&quot;, e.Node.Attribute(&quot;email&quot;).Value.Replace(&quot;.&quot;, &quot; &quot;).Replace(&quot;@&quot;, &quot; &quot;));
            }

            if (e.Fields.ContainsKey(IconFieldName) == false)
                e.Fields.Add(IconFieldName, (string)e.Node.Attribute(&quot;icon&quot;));
        }

        private static XElement GetMemberItem(int nodeId)
        {
            //TODO: Change this so that it is not using the LegacyLibrary, just serialize manually!
            var nodes = LegacyLibrary.GetMember(nodeId);
            return XElement.Parse(nodes.Current.OuterXml);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[35,41,35,47,0],[36,9,36,10,0],[37,13,37,84,0],[38,13,38,80,0],[39,13,39,88,0],[40,9,40,10,0],[51,15,51,73,0],[52,9,52,10,0],[53,13,53,84,0],[54,13,54,80,0],[55,13,55,88,0],[56,9,56,10,0],[74,15,74,73,0],[75,9,75,10,0],[76,13,76,48,0],[77,13,77,44,0],[78,13,78,88,0],[79,9,79,10,0],[97,15,97,73,0],[98,9,98,10,0],[99,13,99,48,0],[100,13,100,44,0],[101,13,101,52,0],[102,9,102,10,0],[110,9,110,10,0],[111,13,111,61,0],[113,13,113,33,0],[114,13,114,14,0],[117,17,117,53,0],[117,53,117,77,0],[117,77,117,88,0],[117,17,117,88,0],[118,17,118,18,0],[119,21,119,74,0],[122,21,122,84,0],[123,21,123,22,0],[124,25,124,50,0],[125,25,125,68,0],[126,21,126,22,0],[128,21,134,27,0],[136,13,136,14,0],[138,13,138,32,0],[139,9,139,10,0],[147,13,147,14,0],[148,17,148,59,0],[149,13,149,14,0],[157,9,157,10,0],[159,13,159,56,0],[160,17,160,24,0],[162,13,162,118,0],[163,13,163,45,0],[164,13,164,31,0],[167,13,167,14,0],[168,17,168,55,0],[169,17,169,18,0],[170,21,171,31,0],[171,31,171,68,0],[171,68,173,25,0],[173,25,173,26,0],[173,26,175,29,0],[175,29,175,119,0],[175,119,176,29,0],[176,29,176,63,0],[176,63,177,29,0],[177,29,177,63,0],[177,63,178,25,0],[178,25,178,26,0],[178,26,179,30,0],[179,30,179,55,0],[179,55,179,57,0],[170,21,179,57,0],[180,17,180,18,0],[182,17,182,18,0],[184,21,184,39,0],[188,21,188,60,0],[189,21,189,22,0],[191,25,191,32,0],[191,34,191,46,0],[191,47,191,49,0],[191,50,191,78,0],[192,25,192,26,0],[194,29,194,30,0],[196,33,196,163,0],[198,33,198,86,0],[200,33,200,45,0],[201,29,201,30,0],[201,31,201,66,0],[202,25,202,26,0],[203,21,203,22,0],[205,21,205,22,0],[208,25,208,26,0],[210,29,210,103,0],[212,29,212,82,0],[214,29,214,41,0],[215,25,215,26,0],[215,27,215,62,0],[216,21,216,22,0],[217,17,217,18,0],[218,13,218,14,0],[220,13,220,14,0],[221,17,221,34,0],[222,13,222,14,0],[224,13,224,159,0],[225,9,225,10,0],[228,9,228,10,0],[229,13,229,56,0],[230,13,230,45,0],[230,45,230,91,0],[230,91,230,93,0],[230,13,230,93,0],[231,9,231,10,0],[234,9,234,10,0],[235,13,235,47,0],[239,9,239,10,0],[240,13,240,77,0],[244,13,244,82,0],[245,13,245,14,0],[246,17,246,58,0],[247,17,247,18,0],[248,21,248,60,0],[249,17,249,18,0],[250,13,250,14,0],[253,13,253,27,0],[255,9,255,10,0],[262,9,262,10,0],[263,13,263,41,0],[265,13,265,49,0],[266,13,266,14,0],[267,17,267,60,0],[268,21,268,74,0],[269,13,269,14,0],[271,13,271,51,0],[272,13,272,14,0],[274,17,274,67,0],[275,21,275,119,0],[276,13,276,14,0],[278,13,278,62,0],[279,17,279,79,0],[280,9,280,10,0],[283,9,283,10,0],[285,13,285,57,0],[286,13,286,59,0],[287,9,287,10,0]]);
    </script>
  </body>
</html>