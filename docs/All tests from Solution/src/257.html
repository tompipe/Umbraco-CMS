<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Web\Controllers\WebApiEditors\FilterAllowedOutgoingContentAttributeTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Net.Http.Formatting;
using System.Net.Http.Headers;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.WebApi.Filters;

namespace Umbraco.Tests.Web.Controllers.WebApiEditors
{
    [TestFixture]
    public class FilterAllowedOutgoingContentAttributeTests
    {
        [Test]
        public void GetValueFromResponse_Already_EnumerableContent()
        {
            var att = new FilterAllowedOutgoingContentAttribute(typeof(IEnumerable&lt;ContentItemBasic&gt;));
            var val = new List&lt;ContentItemBasic&gt;() {new ContentItemBasic()};
            var result = att.GetValueFromResponse(
                new ObjectContent(typeof (IEnumerable&lt;ContentItemBasic&gt;),
                                  val, 
                                  new JsonMediaTypeFormatter(), 
                                  new MediaTypeHeaderValue(&quot;html/text&quot;)));

            Assert.AreEqual(val, result);
            Assert.AreEqual(1, ((IEnumerable&lt;ContentItemBasic&gt;)result).Count());
        }

        [Test]
        public void GetValueFromResponse_From_Property()
        {
            var att = new FilterAllowedOutgoingContentAttribute(typeof(IEnumerable&lt;ContentItemBasic&gt;), &quot;MyList&quot;);
            var val = new List&lt;ContentItemBasic&gt;() { new ContentItemBasic() };
            var container = new MyTestClass() {MyList = val};

            var result = att.GetValueFromResponse(
                new ObjectContent(typeof(MyTestClass),
                                  container,
                                  new JsonMediaTypeFormatter(),
                                  new MediaTypeHeaderValue(&quot;html/text&quot;)));

            Assert.AreEqual(val, result);
            Assert.AreEqual(1, ((IEnumerable&lt;ContentItemBasic&gt;)result).Count());
        }

        [Test]
        public void GetValueFromResponse_Returns_Null_Not_Found_Property()
        {
            var att = new FilterAllowedOutgoingContentAttribute(typeof(IEnumerable&lt;ContentItemBasic&gt;), &quot;DontFind&quot;);
            var val = new List&lt;ContentItemBasic&gt;() { new ContentItemBasic() };
            var container = new MyTestClass() { MyList = val };

            var result = att.GetValueFromResponse(
                new ObjectContent(typeof(MyTestClass),
                                  container,
                                  new JsonMediaTypeFormatter(),
                                  new MediaTypeHeaderValue(&quot;html/text&quot;)));

            Assert.AreEqual(null, result);

        }

        [Test]
        public void Filter_On_Start_Node()
        {
            var att = new FilterAllowedOutgoingContentAttribute(typeof(IEnumerable&lt;ContentItemBasic&gt;));
            var list = new List&lt;dynamic&gt;();
            var path = &quot;&quot;;
            for (var i = 0; i &lt; 10; i++)
            {
                if (i &gt; 0 &amp;&amp; path.EndsWith(&quot;,&quot;) == false)
                {
                    path += &quot;,&quot;;
                }
                path += i.ToInvariantString();
                list.Add(new ContentItemBasic { Id = i, Name = &quot;Test&quot; + i, ParentId = i, Path = path });
            }

            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(9);
            userMock.Setup(u =&gt; u.StartContentId).Returns(5);
            var user = userMock.Object;
            
            att.FilterBasedOnStartNode(list, user);

            Assert.AreEqual(5, list.Count);
            
        }

        [Test]
        public void Filter_On_Permissions()
        {
            var att = new FilterAllowedOutgoingContentAttribute(typeof(IEnumerable&lt;ContentItemBasic&gt;));
            var list = new List&lt;dynamic&gt;();
            for (var i = 0; i &lt; 10; i++)
            {
                list.Add(new ContentItemBasic{Id = i, Name = &quot;Test&quot; + i, ParentId = -1});
            }
            var ids = list.Select(x =&gt; (int)x.Id).ToArray();
            
            var userMock = new Mock&lt;IUser&gt;();
            userMock.Setup(u =&gt; u.Id).Returns(9);
            userMock.Setup(u =&gt; u.StartContentId).Returns(-1);
            var user = userMock.Object;

            var userServiceMock = new Mock&lt;IUserService&gt;();
            //we&#39;re only assigning 3 nodes browse permissions so that is what we expect as a result
            var permissions = new List&lt;EntityPermission&gt;
                {
                    new EntityPermission(9, 1, new string[]{ &quot;F&quot; }),
                    new EntityPermission(9, 2, new string[]{ &quot;F&quot; }),
                    new EntityPermission(9, 3, new string[]{ &quot;F&quot; }),
                    new EntityPermission(9, 4, new string[]{ &quot;A&quot; })
                };
            userServiceMock.Setup(x =&gt; x.GetPermissions(user, ids)).Returns(permissions);
            var userService = userServiceMock.Object;

            att.FilterBasedOnPermissions(list, user, userService);

            Assert.AreEqual(3, list.Count);
            Assert.AreEqual(1, list.ElementAt(0).Id);
            Assert.AreEqual(2, list.ElementAt(1).Id);
            Assert.AreEqual(3, list.ElementAt(2).Id);
        }
        
        private class MyTestClass
        {
            public IEnumerable&lt;ContentItemBasic&gt; MyList { get; set; } 
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,1],[22,13,22,104,1],[23,13,23,77,1],[24,13,28,75,1],[30,13,30,42,1],[31,13,31,81,1],[32,9,32,10,1],[36,9,36,10,1],[37,13,37,114,1],[38,13,38,79,1],[39,13,39,62,1],[41,13,45,75,1],[47,13,47,42,1],[48,13,48,81,1],[49,9,49,10,1],[53,9,53,10,1],[54,13,54,116,1],[55,13,55,79,1],[56,13,56,64,1],[58,13,62,75,1],[64,13,64,43,1],[66,9,66,10,1],[70,9,70,10,1],[71,13,71,104,1],[72,13,72,44,1],[73,13,73,27,1],[74,18,74,27,1],[74,29,74,35,1],[74,37,74,40,1],[75,13,75,14,1],[76,17,76,58,1],[77,17,77,18,1],[78,21,78,33,1],[79,17,79,18,1],[80,17,80,47,1],[81,17,81,105,1],[82,13,82,14,1],[84,13,84,46,1],[85,13,85,50,1],[86,13,86,62,1],[87,13,87,40,1],[89,13,89,52,1],[91,13,91,44,1],[93,9,93,10,1],[97,9,97,10,1],[98,13,98,104,1],[99,13,99,44,1],[100,18,100,27,1],[100,29,100,35,1],[100,37,100,40,1],[101,13,101,14,1],[102,17,102,90,1],[103,13,103,14,1],[104,13,104,40,1],[104,40,104,49,1],[104,49,104,61,1],[104,13,104,61,1],[106,13,106,46,1],[107,13,107,50,1],[108,13,108,63,1],[109,13,109,40,1],[111,13,111,60,1],[113,13,119,19,1],[120,13,120,90,1],[121,13,121,54,1],[123,13,123,67,1],[125,13,125,44,1],[126,13,126,54,1],[127,13,127,54,1],[128,13,128,54,1],[129,9,129,10,1],[133,59,133,63,1],[133,64,133,68,1]]);
    </script>
  </body>
</html>