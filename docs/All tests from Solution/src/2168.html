<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Dynamics\CaseInsensitiveDynamicObject.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Dynamic;
using System.Linq;
using System.Reflection;

namespace Umbraco.Core.Dynamics
{
    /// &lt;summary&gt;
    /// This will check enable dynamic access to properties and methods in a case insensitive manner
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;remarks&gt;
    /// This works by using reflection on the type - the reflection lookup is lazy so it will not execute unless a dynamic method needs to be accessed
    /// &lt;/remarks&gt;
    public abstract class CaseInsensitiveDynamicObject&lt;T&gt; : DynamicObject
        where T: class
    {
        /// &lt;summary&gt;
        /// Used for dynamic access for case insensitive property access
        /// &lt;/summary&gt;`
        private static readonly Lazy&lt;IDictionary&lt;string, Func&lt;T, object&gt;&gt;&gt; CaseInsensitivePropertyAccess = new Lazy&lt;IDictionary&lt;string, Func&lt;T, object&gt;&gt;&gt;(() =&gt;
        {
            var props = typeof(T).GetProperties(BindingFlags.Instance | BindingFlags.Public)
                .DistinctBy(x =&gt; x.Name);
            return props.Select(propInfo =&gt;
            {
                var name = propInfo.Name.ToLowerInvariant();
                Func&lt;T, object&gt; getVal = propInfo.GetValue;
                return new KeyValuePair&lt;string, Func&lt;T, object&gt;&gt;(name, getVal);

            }).ToDictionary(x =&gt; x.Key, x =&gt; x.Value);
        });

        /// &lt;summary&gt;
        /// Used for dynamic access for case insensitive property access
        /// &lt;/summary&gt;
        private static readonly Lazy&lt;IDictionary&lt;string, Tuple&lt;ParameterInfo[], Func&lt;T, object[], object&gt;&gt;&gt;&gt; CaseInsensitiveMethodAccess
            = new Lazy&lt;IDictionary&lt;string, Tuple&lt;ParameterInfo[], Func&lt;T, object[], object&gt;&gt;&gt;&gt;(() =&gt;
            {
                var props = typeof(T).GetMethods(BindingFlags.Instance | BindingFlags.Public)
                    .Where(x =&gt; x.IsSpecialName == false &amp;&amp; x.IsVirtual == false)
                    .DistinctBy(x =&gt; x.Name);
                return props.Select(methodInfo =&gt;
                {
                    var name = methodInfo.Name.ToLowerInvariant();
                    Func&lt;T, object[], object&gt; getVal = methodInfo.Invoke;
                    var val = new Tuple&lt;ParameterInfo[], Func&lt;T, object[], object&gt;&gt;(methodInfo.GetParameters(), getVal);
                    return new KeyValuePair&lt;string, Tuple&lt;ParameterInfo[], Func&lt;T, object[], object&gt;&gt;&gt;(name, val);

                }).ToDictionary(x =&gt; x.Key, x =&gt; x.Value);
            });

        public override bool TryInvokeMember(InvokeMemberBinder binder, object[] args, out object result)
        {
            var name = binder.Name.ToLowerInvariant();
            if (CaseInsensitiveMethodAccess.Value.ContainsKey(name) == false)
                return base.TryInvokeMember(binder, args, out result);

            var val = CaseInsensitiveMethodAccess.Value[name];
            var parameters = val.Item1;
            var callback = val.Item2;
            var fullArgs = new List&lt;object&gt;(args);
            if (args.Length &lt;= parameters.Length)
            {
                //need to fill them up if they&#39;re optional
                for (var i = args.Length; i &lt; parameters.Length; i++)
                {
                    if (parameters[i].IsOptional)
                    {
                        fullArgs.Add(parameters[i].DefaultValue);
                    }
                }
                if (fullArgs.Count == parameters.Length)
                {
                    result = callback((T)(object)this, fullArgs.ToArray());
                    return true;
                }
            }
            return base.TryInvokeMember(binder, args, out result);
        }

        public override bool TryGetMember(GetMemberBinder binder, out object result)
        {
            var name = binder.Name.ToLowerInvariant();
            if (CaseInsensitivePropertyAccess.Value.ContainsKey(name) == false)
                return base.TryGetMember(binder, out result);

            result = CaseInsensitivePropertyAccess.Value[name]((T)(object)this);
            return true;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,23,9,1],[23,9,23,10,1],[23,10,24,13,1],[24,13,25,34,1],[25,34,25,40,1],[25,40,25,42,1],[24,13,25,42,1],[25,42,26,13,1],[26,13,27,13,1],[27,13,27,14,1],[27,14,28,17,1],[28,17,28,61,1],[28,61,29,17,1],[29,17,29,60,1],[29,60,30,17,1],[30,17,30,80,1],[30,80,32,13,1],[32,13,32,14,1],[32,14,32,34,1],[32,34,32,39,1],[32,39,32,46,1],[32,46,32,53,1],[32,53,32,55,1],[26,13,32,55,1],[32,55,33,9,1],[33,9,33,10,1],[33,10,33,12,1],[22,9,33,12,1],[38,9,40,13,1],[40,13,40,14,1],[40,14,41,17,1],[41,17,42,33,1],[42,33,42,81,1],[42,81,43,38,1],[43,38,43,44,1],[43,44,43,46,1],[41,17,43,46,1],[43,46,44,17,1],[44,17,45,17,1],[45,17,45,18,1],[45,18,46,21,1],[46,21,46,67,1],[46,67,47,21,1],[47,21,47,74,1],[47,74,48,21,1],[48,21,48,121,1],[48,121,49,21,1],[49,21,49,115,1],[49,115,51,17,1],[51,17,51,18,1],[51,18,51,38,1],[51,38,51,43,1],[51,43,51,50,1],[51,50,51,57,1],[51,57,51,59,1],[44,17,51,59,1],[51,59,52,13,1],[52,13,52,14,1],[52,14,52,16,1],[38,9,52,16,1],[55,9,55,10,1],[56,13,56,55,1],[57,13,57,78,1],[58,17,58,71,0],[60,13,60,63,1],[61,13,61,40,1],[62,13,62,38,1],[63,13,63,51,1],[64,13,64,50,1],[65,13,65,14,1],[67,22,67,41,1],[67,43,67,64,1],[67,66,67,69,1],[68,17,68,18,1],[69,21,69,50,1],[70,21,70,22,1],[71,25,71,66,1],[72,21,72,22,1],[73,17,73,18,1],[74,17,74,57,1],[75,17,75,18,1],[76,21,76,76,1],[77,21,77,33,1],[79,13,79,14,0],[80,13,80,67,0],[81,9,81,10,1],[84,9,84,10,1],[85,13,85,55,1],[86,13,86,80,1],[87,17,87,62,0],[89,13,89,81,1],[90,13,90,25,1],[91,9,91,10,1]]);
    </script>
  </body>
</html>