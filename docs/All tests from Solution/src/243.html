<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Cache\DistributedCache\DistributedCacheTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Moq;
using NUnit.Framework;
using umbraco.interfaces;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.Sync;

namespace Umbraco.Tests.Cache.DistributedCache
{
    /// &lt;summary&gt;
    /// Ensures that calls to DistributedCache methods carry through to the IServerMessenger correctly
    /// &lt;/summary&gt;
    [TestFixture]
    public class DistributedCacheTests
    {
        [SetUp]
        public void Setup()
        {
            ServerRegistrarResolver.Current = new ServerRegistrarResolver(
                new TestServerRegistrar());
            ServerMessengerResolver.Current = new ServerMessengerResolver(
                new TestServerMessenger());
            CacheRefreshersResolver.Current = new CacheRefreshersResolver(
                new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), () =&gt; new[] { typeof(TestCacheRefresher) });
            Resolution.Freeze();
        }

        [TearDown]
        public void Teardown()
        {
            ServerRegistrarResolver.Reset();
            ServerMessengerResolver.Reset();
            CacheRefreshersResolver.Reset();
        }

        [Test]
        public void RefreshIntId()
        {
            for (var i = 1; i &lt; 11; i++)
            {
                global::Umbraco.Web.Cache.DistributedCache.Instance.Refresh(Guid.Parse(&quot;E0F452CB-DCB2-4E84-B5A5-4F01744C5C73&quot;), i);
            }
            Assert.AreEqual(10, ((TestServerMessenger)ServerMessengerResolver.Current.Messenger).IntIdsRefreshed.Count);
        }

        [Test]
        public void RefreshIntIdFromObject()
        {
            for (var i = 0; i &lt; 10; i++)
            {
                global::Umbraco.Web.Cache.DistributedCache.Instance.Refresh(
                    Guid.Parse(&quot;E0F452CB-DCB2-4E84-B5A5-4F01744C5C73&quot;),
                    x =&gt; x.Id,
                    new TestObjectWithId{Id = i});
            }
            Assert.AreEqual(10, ((TestServerMessenger)ServerMessengerResolver.Current.Messenger).IntIdsRefreshed.Count);
        }

        [Test]
        public void RefreshGuidId()
        {
            for (var i = 0; i &lt; 11; i++)
            {
                global::Umbraco.Web.Cache.DistributedCache.Instance.Refresh(Guid.Parse(&quot;E0F452CB-DCB2-4E84-B5A5-4F01744C5C73&quot;), Guid.NewGuid());
            }
            Assert.AreEqual(11, ((TestServerMessenger)ServerMessengerResolver.Current.Messenger).GuidIdsRefreshed.Count);
        }

        [Test]
        public void RemoveIds()
        {
            for (var i = 1; i &lt; 13; i++)
            {
                global::Umbraco.Web.Cache.DistributedCache.Instance.Remove(Guid.Parse(&quot;E0F452CB-DCB2-4E84-B5A5-4F01744C5C73&quot;), i);
            }
            Assert.AreEqual(12, ((TestServerMessenger)ServerMessengerResolver.Current.Messenger).IntIdsRemoved.Count);
        }

        [Test]
        public void FullRefreshes()
        {
            for (var i = 0; i &lt; 13; i++)
            {
                global::Umbraco.Web.Cache.DistributedCache.Instance.RefreshAll(Guid.Parse(&quot;E0F452CB-DCB2-4E84-B5A5-4F01744C5C73&quot;));
            }
            Assert.AreEqual(13, ((TestServerMessenger)ServerMessengerResolver.Current.Messenger).CountOfFullRefreshes);
        }

        #region internal test classes

        internal class TestObjectWithId
        {
            public int Id { get; set; }
        }

        internal class TestCacheRefresher : ICacheRefresher
        {
            public Guid UniqueIdentifier
            {
                get { return Guid.Parse(&quot;E0F452CB-DCB2-4E84-B5A5-4F01744C5C73&quot;); }
            }
            public string Name
            {
                get { return &quot;Test&quot;; }
            }
            public void RefreshAll()
            {
                
            }

            public void Refresh(int id)
            {
                
            }

            public void Remove(int id)
            {
                
            }

            public void Refresh(Guid id)
            {
               
            }
        }

        internal class TestServerMessenger : IServerMessenger
        {
            //used for tests
            public List&lt;int&gt; IntIdsRefreshed = new List&lt;int&gt;(); 
            public List&lt;Guid&gt; GuidIdsRefreshed = new List&lt;Guid&gt;();
            public List&lt;int&gt; IntIdsRemoved = new List&lt;int&gt;();
            public List&lt;string&gt; PayloadsRemoved = new List&lt;string&gt;();
            public List&lt;string&gt; PayloadsRefreshed = new List&lt;string&gt;(); 
            public int CountOfFullRefreshes = 0;

            public void PerformRefresh(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, object payload)
            {
                // doing nothing
            }

            public void PerformRefresh(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, string jsonPayload)
            {
                PayloadsRefreshed.Add(jsonPayload);
            }

            public void PerformRefresh&lt;T&gt;(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, Func&lt;T, int&gt; getNumericId, params T[] instances)
            {
                IntIdsRefreshed.AddRange(instances.Select(getNumericId));
            }

            public void PerformRefresh&lt;T&gt;(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, Func&lt;T, Guid&gt; getGuidId, params T[] instances)
            {
                GuidIdsRefreshed.AddRange(instances.Select(getGuidId));
            }

            public void PerformRemove(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, string jsonPayload)
            {
                PayloadsRemoved.Add(jsonPayload);
            }

            public void PerformRemove&lt;T&gt;(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, Func&lt;T, int&gt; getNumericId, params T[] instances)
            {
                IntIdsRemoved.AddRange(instances.Select(getNumericId));
            }

            public void PerformRemove(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, params int[] numericIds)
            {
                IntIdsRemoved.AddRange(numericIds);
            }

            public void PerformRefresh(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, params int[] numericIds)
            {
                IntIdsRefreshed.AddRange(numericIds);
            }

            public void PerformRefresh(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, params Guid[] guidIds)
            {
                GuidIdsRefreshed.AddRange(guidIds);
            }

            public void PerformRefreshAll(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher)
            {
                CountOfFullRefreshes++;
            }
        }

        internal class TestServerRegistrar : IServerRegistrar
        {
            public IEnumerable&lt;IServerAddress&gt; Registrations
            {
                get
                {
                    return new List&lt;IServerAddress&gt;()
                        {
                            new TestServerAddress(&quot;localhost&quot;)
                        };
                }
            }
        }

        public class TestServerAddress : IServerAddress
        {
            public TestServerAddress(string address)
            {
                ServerAddress = address;
            }
            public string ServerAddress { get; private set; }
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,24,44,1],[25,13,26,44,1],[27,13,28,75,1],[28,75,28,111,1],[28,111,28,113,1],[27,13,28,113,1],[29,13,29,33,1],[30,9,30,10,1],[34,9,34,10,1],[35,13,35,45,1],[36,13,36,45,1],[37,13,37,45,1],[38,9,38,10,1],[42,9,42,10,1],[43,18,43,27,1],[43,29,43,35,1],[43,37,43,40,1],[44,13,44,14,1],[45,17,45,132,1],[46,13,46,14,1],[47,13,47,121,1],[48,9,48,10,1],[52,9,52,10,1],[53,18,53,27,1],[53,29,53,35,1],[53,37,53,40,1],[54,13,54,14,1],[55,17,57,26,1],[57,26,57,30,1],[57,30,58,51,1],[55,17,58,51,1],[59,13,59,14,1],[60,13,60,121,1],[61,9,61,10,1],[65,9,65,10,1],[66,18,66,27,1],[66,29,66,35,1],[66,37,66,40,1],[67,13,67,14,1],[68,17,68,145,1],[69,13,69,14,1],[70,13,70,122,1],[71,9,71,10,1],[75,9,75,10,1],[76,18,76,27,1],[76,29,76,35,1],[76,37,76,40,1],[77,13,77,14,1],[78,17,78,131,1],[79,13,79,14,1],[80,13,80,119,1],[81,9,81,10,1],[85,9,85,10,1],[86,18,86,27,1],[86,29,86,35,1],[86,37,86,40,1],[87,13,87,14,1],[88,17,88,132,1],[89,13,89,14,1],[90,13,90,120,1],[91,9,91,10,1],[97,29,97,33,1],[97,34,97,38,1],[104,21,104,22,1],[104,23,104,81,1],[104,82,104,83,1],[108,21,108,22,0],[108,23,108,37,0],[108,38,108,39,0],[111,13,111,14,0],[113,13,113,14,0],[116,13,116,14,0],[118,13,118,14,0],[121,13,121,14,0],[123,13,123,14,0],[126,13,126,14,0],[128,13,128,14,0],[134,13,134,64,1],[135,13,135,67,1],[136,13,136,62,1],[137,13,137,70,1],[138,13,138,72,1],[139,13,139,49,1],[142,13,142,14,0],[144,13,144,14,0],[147,13,147,14,0],[148,17,148,52,0],[149,13,149,14,0],[152,13,152,14,1],[153,17,153,74,1],[154,13,154,14,1],[157,13,157,14,0],[158,17,158,72,0],[159,13,159,14,0],[162,13,162,14,0],[163,17,163,50,0],[164,13,164,14,0],[167,13,167,14,0],[168,17,168,72,0],[169,13,169,14,0],[172,13,172,14,1],[173,17,173,52,1],[174,13,174,14,1],[177,13,177,14,1],[178,17,178,54,1],[179,13,179,14,1],[182,13,182,14,1],[183,17,183,52,1],[184,13,184,14,1],[187,13,187,14,1],[188,17,188,40,1],[189,13,189,14,1],[197,17,197,18,1],[198,21,201,27,1],[202,17,202,18,1],[208,13,208,53,1],[209,13,209,14,1],[210,17,210,41,1],[211,13,211,14,1],[212,43,212,47,0],[212,48,212,60,1]]);
    </script>
  </body>
</html>