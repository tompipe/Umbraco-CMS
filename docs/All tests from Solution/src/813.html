<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebApi\Filters\FilterAllowedOutgoingMediaAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Web.Http.Filters;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Membership;
using Umbraco.Web.Models.ContentEditing;

namespace Umbraco.Web.WebApi.Filters
{
    /// &lt;summary&gt;
    /// This inspects the result of the action that returns a collection of content and removes 
    /// any item that the current user doesn&#39;t have access to
    /// &lt;/summary&gt;
    internal class FilterAllowedOutgoingMediaAttribute : ActionFilterAttribute
    {
        private readonly Type _outgoingType;
        private readonly string _propertyName;

        public FilterAllowedOutgoingMediaAttribute(Type outgoingType)
        {
            _outgoingType = outgoingType;
        }

        public FilterAllowedOutgoingMediaAttribute(Type outgoingType, string propertyName)
            : this(outgoingType)
        {
            _propertyName = propertyName;
        }

        /// &lt;summary&gt;
        /// Returns true so that other filters can execute along with this one
        /// &lt;/summary&gt;
        public override bool AllowMultiple
        {
            get { return true; }
        }

        protected virtual int GetUserStartNode(IUser user)
        {
            return user.StartMediaId;
        }

        protected virtual int RecycleBinId
        {
            get { return Constants.System.RecycleBinMedia; }
        }

        public override void OnActionExecuted(HttpActionExecutedContext actionExecutedContext)
        {
            if (actionExecutedContext.Response == null) return;

            var user = UmbracoContext.Current.Security.CurrentUser;
            if (user == null) return;

            var objectContent = actionExecutedContext.Response.Content as ObjectContent;
            if (objectContent != null)
            {
                var collection = GetValueFromResponse(objectContent);

                if (collection != null)
                {
                    var items = Enumerable.ToList(collection);

                    FilterItems(user, items);

                    //set the return value
                    SetValueForResponse(objectContent, items);
                }
            }

            base.OnActionExecuted(actionExecutedContext);
        }

        protected virtual void FilterItems(IUser user, IList items)
        {
            FilterBasedOnStartNode(items, user);
        }

        internal void FilterBasedOnStartNode(IList items, IUser user)
        {
            var toRemove = new List&lt;dynamic&gt;();
            foreach (dynamic item in items)
            {
                var hasPathAccess = (item != null &amp;&amp; UserExtensions.HasPathAccess(item.Path, GetUserStartNode(user), RecycleBinId));
                if (!hasPathAccess)
                {
                    toRemove.Add(item);
                }
            }

            foreach (var item in toRemove)
            {
                items.Remove(item);
            }
        }

        private void SetValueForResponse(ObjectContent objectContent, dynamic newVal)
        {
            if (TypeHelper.IsTypeAssignableFrom(_outgoingType, objectContent.Value.GetType()))
            {
                objectContent.Value = newVal;
            }
            else if (_propertyName.IsNullOrWhiteSpace() == false)
            {
                //try to get the enumerable collection from a property on the result object using reflection
                var property = objectContent.Value.GetType().GetProperty(_propertyName);
                if (property != null)
                {
                    property.SetValue(objectContent.Value, newVal);
                }
            }

        }

        internal dynamic GetValueFromResponse(ObjectContent objectContent)
        {
            if (TypeHelper.IsTypeAssignableFrom(_outgoingType, objectContent.Value.GetType()))
            {
                return objectContent.Value;
            }

            if (_propertyName.IsNullOrWhiteSpace() == false)
            {
                //try to get the enumerable collection from a property on the result object using reflection
                var property = objectContent.Value.GetType().GetProperty(_propertyName);
                if (property != null)
                {
                    var result = property.GetValue(objectContent.Value);
                    if (result != null &amp;&amp; TypeHelper.IsTypeAssignableFrom(_outgoingType, result.GetType()))
                    {
                        return result;
                    }
                }
            }

            return null;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,70,1],[24,9,24,10,1],[25,13,25,42,1],[26,9,26,10,1],[29,15,29,33,1],[30,9,30,10,1],[31,13,31,42,1],[32,9,32,10,1],[39,17,39,18,0],[39,19,39,31,0],[39,32,39,33,0],[43,9,43,10,0],[44,13,44,38,0],[45,9,45,10,0],[49,17,49,18,0],[49,19,49,59,0],[49,60,49,61,0],[53,9,53,10,0],[54,13,54,56,0],[54,57,54,64,0],[56,13,56,68,0],[57,13,57,30,0],[57,31,57,38,0],[59,13,59,89,0],[60,13,60,39,0],[61,13,61,14,0],[62,17,62,70,0],[64,17,64,40,0],[65,17,65,18,0],[66,21,66,63,0],[68,21,68,46,0],[71,21,71,63,0],[72,17,72,18,0],[73,13,73,14,0],[75,13,75,58,0],[76,9,76,10,0],[79,9,79,10,0],[80,13,80,49,0],[81,9,81,10,0],[84,9,84,10,1],[85,13,85,48,1],[86,13,86,20,1],[86,22,86,34,1],[86,35,86,37,1],[86,38,86,43,1],[87,13,87,14,1],[88,17,88,133,1],[89,17,89,36,1],[90,17,90,18,1],[91,21,91,40,1],[92,17,92,18,1],[93,13,93,14,1],[95,13,95,20,1],[95,22,95,30,1],[95,31,95,33,1],[95,34,95,42,1],[96,13,96,14,1],[97,17,97,36,1],[98,13,98,14,1],[99,9,99,10,1],[102,9,102,10,0],[103,13,103,95,0],[104,13,104,14,0],[105,17,105,46,0],[106,13,106,14,0],[107,18,107,66,0],[108,13,108,14,0],[110,17,110,89,0],[111,17,111,38,0],[112,17,112,18,0],[113,21,113,68,0],[114,17,114,18,0],[115,13,115,14,0],[117,9,117,10,0],[120,9,120,10,1],[121,13,121,95,1],[122,13,122,14,1],[123,17,123,44,1],[126,13,126,61,1],[127,13,127,14,1],[129,17,129,89,1],[130,17,130,38,1],[131,17,131,18,1],[132,21,132,73,1],[133,21,133,108,1],[134,21,134,22,1],[135,25,135,39,1],[137,17,137,18,0],[138,13,138,14,1],[140,13,140,25,1],[141,9,141,10,1]]);
    </script>
  </body>
</html>