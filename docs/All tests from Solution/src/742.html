<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebServices\ScheduledPublishController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.Mvc;
using umbraco;
using Umbraco.Core.Logging;
using Umbraco.Core.Publishing;
using Umbraco.Web.Mvc;

namespace Umbraco.Web.WebServices
{
    /// &lt;summary&gt;
    /// A REST controller used for running the scheduled publishing, this is called from the background worker timer
    /// &lt;/summary&gt;
    [AdminTokenAuthorize]
    public class ScheduledPublishController : UmbracoController
    {
        private static bool _isPublishingRunning = false;

        [HttpPost]
        public JsonResult Index()
        {
            if (_isPublishingRunning)
            {
                Logger.Debug&lt;ScheduledPublishController&gt;(() =&gt; &quot;Scheduled publishing is currently executing this request will exit&quot;);
                return null;
            }
                
            _isPublishingRunning = true;

            try
            {
                // DO not run publishing if content is re-loading
                if (content.Instance.isInitializing == false)
                {
                    var publisher = new ScheduledPublisher(Services.ContentService);
                    var count = publisher.CheckPendingAndProcess();
                    Logger.Debug&lt;ScheduledPublishController&gt;(() =&gt; string.Format(&quot;The scheduler processed {0} items&quot;, count));
                }

                return Json(new
                {
                    success = true
                });

            }
            catch (Exception ee)
            {
                var errorMessage = &quot;Error executing scheduled task&quot;;
                if (HttpContext != null &amp;&amp; HttpContext.Request != null)
                {
                    if (HttpContext.Request.Url != null)
                        errorMessage = string.Format(&quot;{0} | Request to {1}&quot;, errorMessage, HttpContext.Request.Url);
                    if (HttpContext.Request.UserHostAddress != null)
                        errorMessage = string.Format(&quot;{0} | Coming from {1}&quot;, errorMessage, HttpContext.Request.UserHostAddress);
                    if (HttpContext.Request.UrlReferrer != null)
                        errorMessage = string.Format(&quot;{0} | Referrer {1}&quot;, errorMessage, HttpContext.Request.UrlReferrer);    
                }
                LogHelper.Error&lt;ScheduledPublishController&gt;(errorMessage, ee);

                Response.StatusCode = 400; 

                return Json(new
                {
                    success = false,
                    message = ee.Message
                });
            }
            finally
            {
                _isPublishingRunning = false;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,58,0],[20,9,20,10,0],[21,13,21,38,0],[22,13,22,14,0],[23,17,23,64,0],[23,64,23,132,0],[23,132,23,134,0],[23,17,23,134,0],[24,17,24,29,0],[27,13,27,41,0],[30,13,30,14,0],[32,17,32,62,0],[33,17,33,18,0],[34,21,34,85,0],[35,21,35,68,0],[36,21,36,68,0],[36,68,36,125,0],[36,125,36,127,0],[36,21,36,127,0],[37,17,37,18,0],[39,17,42,20,0],[45,13,45,33,0],[46,13,46,14,0],[47,17,47,69,0],[48,17,48,72,0],[49,17,49,18,0],[50,21,50,57,0],[51,25,51,117,0],[52,21,52,69,0],[53,25,53,130,0],[54,21,54,65,0],[55,25,55,123,0],[56,17,56,18,0],[57,17,57,79,0],[59,17,59,43,0],[61,17,65,20,0],[68,13,68,14,0],[69,17,69,46,0],[70,13,70,14,0],[71,9,71,10,0]]);
    </script>
  </body>
</html>