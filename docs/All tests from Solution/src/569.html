<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\plugins\tinymce3\JSONReader.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * $Id: JSONReader.cs 439 2007-11-26 13:26:10Z spocke $
 *
 * Copyright ï¿½ 2007, Moxiecode Systems AB, All rights reserved. 
 */

using System;
using System.IO;
using System.Text;
using System.Collections;

namespace umbraco.presentation.plugins.tinymce3
{
    /// &lt;summary&gt;
	/// 
	/// &lt;/summary&gt;
	public enum JSONToken {
		/// &lt;summary&gt; &lt;/summary&gt;
		Boolean,

		/// &lt;summary&gt; &lt;/summary&gt;
		Integer,

		/// &lt;summary&gt; &lt;/summary&gt;
		String,

		/// &lt;summary&gt; &lt;/summary&gt;
		Null,

		/// &lt;summary&gt; &lt;/summary&gt;
		Float,

		/// &lt;summary&gt; &lt;/summary&gt;
		StartArray,

		/// &lt;summary&gt; &lt;/summary&gt;
		EndArray,

		/// &lt;summary&gt; &lt;/summary&gt;
		PropertyName,

		/// &lt;summary&gt; &lt;/summary&gt;
		StartObject,

		/// &lt;summary&gt; &lt;/summary&gt;
		EndObject
	}

	/// &lt;summary&gt;
	///  Description of JSONReader.
	/// &lt;/summary&gt;
	public class JSONReader {
		private TextReader reader;
		private JSONToken token;
		private object val;
		private JSONLocation location;
		private Stack lastLocations;
		private bool needProp;

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;reader&quot;&gt;&lt;/param&gt;
		public JSONReader(TextReader reader) {
			this.reader = reader;
			this.val = null;
			this.token = JSONToken.Null;
			this.location = JSONLocation.Normal;
			this.lastLocations = new Stack();
			this.needProp = false;
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public JSONLocation Location {
			get { return location; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public JSONToken TokenType {
			get {
				return this.token;
			}
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public object Value {
			get {
				return this.val;
			}
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public bool Read() {
			int chr = this.reader.Read();

			if (chr != -1) {
				switch ((char) chr) {
					case &#39;[&#39;:
						this.lastLocations.Push(this.location);
						this.location = JSONLocation.InArray;
						this.token = JSONToken.StartArray;
						this.val = null;
						this.ReadAway();
						return true;

					case &#39;]&#39;:
						this.location = (JSONLocation) this.lastLocations.Pop();
						this.token = JSONToken.EndArray;
						this.val = null;
						this.ReadAway();

						if (this.location == JSONLocation.InObject)
							this.needProp = true;

						return true;

					case &#39;{&#39;:
						this.lastLocations.Push(this.location);
						this.location = JSONLocation.InObject;
						this.needProp = true;
						this.token = JSONToken.StartObject;
						this.val = null;
						this.ReadAway();
						return true;

					case &#39;}&#39;:
						this.location = (JSONLocation) this.lastLocations.Pop();
						this.token = JSONToken.EndObject;
						this.val = null;
						this.ReadAway();

						if (this.location == JSONLocation.InObject)
							this.needProp = true;

						return true;

					// String
					case &#39;&quot;&#39;:
					case &#39;\&#39;&#39;:
						return this.ReadString((char) chr);

					// Null
					case &#39;n&#39;:
						return this.ReadNull();

					// Bool
					case &#39;t&#39;:
					case &#39;f&#39;:
						return this.ReadBool((char) chr);

					default:
						// Is number
						if (Char.IsNumber((char) chr) || (char) chr == &#39;-&#39; || (char) chr == &#39;.&#39;)
							return this.ReadNumber((char) chr);

						return true;
				}
			}

			return false;
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override string ToString() {
			switch (this.token) {
				case JSONToken.Boolean:
					return &quot;[Boolean] = &quot; + ((bool) this.Value ? &quot;true&quot; : &quot;false&quot;);

				case JSONToken.EndArray:
					return &quot;[EndArray]&quot;;

				case JSONToken.EndObject:
					return &quot;[EndObject]&quot;;

				case JSONToken.Float:
					return &quot;[Float] = &quot; + Convert.ToDouble(this.Value);

				case JSONToken.Integer:
					return &quot;[Integer] = &quot; + ((int) this.Value);

				case JSONToken.Null:
					return &quot;[Null]&quot;;

				case JSONToken.StartArray:
					return &quot;[StartArray]&quot;;

				case JSONToken.StartObject:
					return &quot;[StartObject]&quot;;

				case JSONToken.String:
					return &quot;[String]&quot; + (string) this.Value;

				case JSONToken.PropertyName:
					return &quot;[PropertyName]&quot; + (string) this.Value;
			}

			return base.ToString();
		}
		
		#region private methods

		private bool ReadString(char quote) {
			StringBuilder buff = new StringBuilder();
			this.token = JSONToken.String;
			bool endString = false;
			int chr;

			while ((chr = this.reader.Peek()) != -1) {
				switch (chr) {
					case &#39;\\&#39;:
						// Read away slash
						chr = this.reader.Read();

						// Read escape code
						chr = this.reader.Read();
						switch (chr) {
								case &#39;t&#39;:
									buff.Append(&#39;\t&#39;);
									break;

								case &#39;b&#39;:
									buff.Append(&#39;\b&#39;);
									break;

								case &#39;f&#39;:
									buff.Append(&#39;\f&#39;);
									break;

								case &#39;r&#39;:
									buff.Append(&#39;\r&#39;);
									break;

								case &#39;n&#39;:
									buff.Append(&#39;\n&#39;);
									break;

								case &#39;u&#39;:
									buff.Append((char) Convert.ToInt32(ReadLen(4), 16));
									break;

								default:
									buff.Append((char) chr);
									break;
						}

						break;

						case &#39;\&#39;&#39;:
						case &#39;&quot;&#39;:
							if (chr == quote)
								endString = true;

							chr = this.reader.Read();
							if (chr != -1 &amp;&amp; chr != quote)
								buff.Append((char) chr);

							break;

						default:
							buff.Append((char) this.reader.Read());
							break;
				}

				// String terminated
				if (endString)
					break;
			}

			this.ReadAway();

			this.val = buff.ToString();

			// Needed a property
			if (this.needProp) {
				this.token = JSONToken.PropertyName;
				this.needProp = false;
				return true;
			}

			if (this.location == JSONLocation.InObject &amp;&amp; !this.needProp)
				this.needProp = true;

			return true;
		}

		private bool ReadNull() {
			this.token = JSONToken.Null;
			this.val = null;

			this.ReadAway(3); // ull
			this.ReadAway();

			if (this.location == JSONLocation.InObject &amp;&amp; !this.needProp)
				this.needProp = true;

			return true;
		}

		private bool ReadNumber(char start) {
			StringBuilder buff = new StringBuilder();
			int chr;
			bool isFloat = false;

			this.token = JSONToken.Integer;
			buff.Append(start);

			while ((chr = this.reader.Peek()) != -1) {
				if (Char.IsNumber((char) chr) || (char) chr == &#39;-&#39; || (char) chr == &#39;.&#39;) {
					if (((char) chr) == &#39;.&#39;)
						isFloat = true;

					buff.Append((char) this.reader.Read());
				} else
					break;
			}

			this.ReadAway();

			if (isFloat) {
				this.token = JSONToken.Float;
				this.val = Convert.ToDouble(buff.ToString().Replace(&#39;.&#39;, &#39;,&#39;));
			} else
				this.val = Convert.ToInt32(buff.ToString());

			if (this.location == JSONLocation.InObject &amp;&amp; !this.needProp)
				this.needProp = true;

			return true;
		}

		private bool ReadBool(char chr) {
			this.token = JSONToken.Boolean;
			this.val = chr == &#39;t&#39;;

			if (chr == &#39;t&#39;)
				this.ReadAway(3); // rue
			else
				this.ReadAway(4); // alse

			this.ReadAway();

			if (this.location == JSONLocation.InObject &amp;&amp; !this.needProp)
				this.needProp = true;

			return true;
		}

		private void ReadAway() {
			int chr;
			
			while ((chr = this.reader.Peek()) != -1) {
				if (chr != &#39;:&#39; &amp;&amp; chr != &#39;,&#39; &amp;&amp; !Char.IsWhiteSpace((char) chr))
					break;

				this.reader.Read();
			}
		}

		private string ReadLen(int num) {
			StringBuilder buff = new StringBuilder();
			int chr;

			for (int i=0; i&lt;num &amp;&amp; (chr = this.reader.Read()) != -1; i++)
				buff.Append((char) chr);

			return buff.ToString();
		}
		
		private void ReadAway(int num) {
			for (int i=0; i&lt;num &amp;&amp; this.reader.Read() != -1; i++) ;
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[64,3,64,39,0],[64,40,64,41,0],[65,4,65,25,0],[66,4,66,20,0],[67,4,67,32,0],[68,4,68,40,0],[69,4,69,37,0],[70,4,70,26,0],[71,3,71,4,0],[77,8,77,9,0],[77,10,77,26,0],[77,27,77,28,0],[84,8,84,9,0],[85,5,85,23,0],[86,4,86,5,0],[93,8,93,9,0],[94,5,94,21,0],[95,4,95,5,0],[102,22,102,23,0],[103,4,103,33,0],[105,4,105,18,0],[105,19,105,20,0],[106,5,106,24,0],[108,7,108,46,0],[109,7,109,44,0],[110,7,110,41,0],[111,7,111,23,0],[112,7,112,23,0],[113,7,113,19,0],[116,7,116,63,0],[117,7,117,39,0],[118,7,118,23,0],[119,7,119,23,0],[121,7,121,50,0],[122,8,122,29,0],[124,7,124,19,0],[127,7,127,46,0],[128,7,128,45,0],[129,7,129,28,0],[130,7,130,42,0],[131,7,131,23,0],[132,7,132,23,0],[133,7,133,19,0],[136,7,136,63,0],[137,7,137,40,0],[138,7,138,23,0],[139,7,139,23,0],[141,7,141,50,0],[142,8,142,29,0],[144,7,144,19,0],[149,7,149,42,0],[153,7,153,30,0],[158,7,158,40,0],[162,7,162,79,0],[163,8,163,43,0],[165,7,165,19,0],[169,4,169,17,0],[170,3,170,4,0],[176,37,176,38,0],[177,4,177,23,0],[179,6,179,69,0],[182,6,182,26,0],[185,6,185,27,0],[188,6,188,57,0],[191,6,191,49,0],[194,6,194,22,0],[197,6,197,28,0],[200,6,200,29,0],[203,6,203,46,0],[206,6,206,52,0],[209,4,209,27,0],[210,3,210,4,0],[214,39,214,40,0],[215,4,215,45,0],[216,4,216,34,0],[217,4,217,27,0],[220,4,220,44,0],[220,45,220,46,0],[221,5,221,17,0],[224,7,224,32,0],[227,7,227,32,0],[228,7,228,19,0],[230,10,230,28,0],[231,10,231,16,0],[234,10,234,28,0],[235,10,235,16,0],[238,10,238,28,0],[239,10,239,16,0],[242,10,242,28,0],[243,10,243,16,0],[246,10,246,28,0],[247,10,247,16,0],[250,10,250,62,0],[251,10,251,16,0],[254,10,254,34,0],[255,10,255,16,0],[258,7,258,13,0],[262,8,262,25,0],[263,9,263,26,0],[265,8,265,33,0],[266,8,266,38,0],[267,9,267,33,0],[269,8,269,14,0],[272,8,272,47,0],[273,8,273,14,0],[277,5,277,19,0],[278,6,278,12,0],[279,4,279,5,0],[281,4,281,20,0],[283,4,283,31,0],[286,4,286,22,0],[286,23,286,24,0],[287,5,287,41,0],[288,5,288,27,0],[289,5,289,17,0],[292,4,292,65,0],[293,5,293,26,0],[295,4,295,16,0],[296,3,296,4,0],[298,27,298,28,0],[299,4,299,32,0],[300,4,300,20,0],[302,4,302,21,0],[303,4,303,20,0],[305,4,305,65,0],[306,5,306,26,0],[308,4,308,16,0],[309,3,309,4,0],[311,39,311,40,0],[312,4,312,45,0],[314,4,314,25,0],[316,4,316,35,0],[317,4,317,23,0],[319,4,319,44,0],[319,45,319,46,0],[320,5,320,77,0],[320,78,320,79,0],[321,6,321,30,0],[322,7,322,22,0],[324,6,324,45,0],[325,5,325,6,0],[326,6,326,12,0],[327,4,327,5,0],[329,4,329,20,0],[331,4,331,16,0],[331,17,331,18,0],[332,5,332,34,0],[333,5,333,68,0],[334,4,334,5,0],[335,5,335,49,0],[337,4,337,65,0],[338,5,338,26,0],[340,4,340,16,0],[341,3,341,4,0],[343,35,343,36,0],[344,4,344,35,0],[345,4,345,26,0],[347,4,347,19,0],[348,5,348,22,0],[350,5,350,22,0],[352,4,352,20,0],[354,4,354,65,0],[355,5,355,26,0],[357,4,357,16,0],[358,3,358,4,0],[360,27,360,28,0],[363,4,363,44,0],[363,45,363,46,0],[364,5,364,68,0],[365,6,365,12,0],[367,5,367,24,0],[368,4,368,5,0],[369,3,369,4,0],[371,35,371,36,0],[372,4,372,45,0],[375,9,375,16,0],[375,18,375,59,0],[375,61,375,64,0],[376,5,376,29,0],[378,4,378,27,0],[379,3,379,4,0],[381,34,381,35,0],[382,9,382,16,0],[382,18,382,51,0],[382,53,382,56,0],[382,58,382,59,0],[383,3,383,4,0]]);
    </script>
  </body>
</html>