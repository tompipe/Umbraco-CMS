<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Security\Identity\UmbracoBackOfficeCookieAuthOptions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.Owin;
using Microsoft.Owin.Security;
using Microsoft.Owin.Security.Cookies;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Configuration.UmbracoSettings;

namespace Umbraco.Web.Security.Identity
{
    /// &lt;summary&gt;
    /// Umbraco auth cookie options
    /// &lt;/summary&gt;
    public sealed class UmbracoBackOfficeCookieAuthOptions : CookieAuthenticationOptions
    {
        public int LoginTimeoutMinutes { get; private set; }

        public UmbracoBackOfficeCookieAuthOptions()
            : this(UmbracoConfig.For.UmbracoSettings().Security, GlobalSettings.TimeOutInMinutes, GlobalSettings.UseSSL)
        {            
        }
        
        public UmbracoBackOfficeCookieAuthOptions(
            string[] explicitPaths,
            ISecuritySection securitySection,
            int loginTimeoutMinutes,
            bool forceSsl,
            bool useLegacyFormsAuthDataFormat = true)            
        {
            LoginTimeoutMinutes = loginTimeoutMinutes;
            AuthenticationType = Constants.Security.BackOfficeAuthenticationType;

            if (useLegacyFormsAuthDataFormat)
            {
                //If this is not explicitly set it will fall back to the default automatically
                TicketDataFormat = new FormsAuthenticationSecureDataFormat(LoginTimeoutMinutes);
            }

            SlidingExpiration = true;
            ExpireTimeSpan = TimeSpan.FromMinutes(LoginTimeoutMinutes);
            CookieDomain = securitySection.AuthCookieDomain;
            CookieName = securitySection.AuthCookieName;
            CookieHttpOnly = true;
            CookieSecure = forceSsl ? CookieSecureOption.Always : CookieSecureOption.SameAsRequest;
            CookiePath = &quot;/&quot;;            

            //Custom cookie manager so we can filter requests
            CookieManager = new BackOfficeCookieManager(new SingletonUmbracoContextAccessor(), explicitPaths);
        }

        public UmbracoBackOfficeCookieAuthOptions(
            ISecuritySection securitySection,
            int loginTimeoutMinutes,
            bool forceSsl,
            bool useLegacyFormsAuthDataFormat = true)
            : this(null, securitySection, loginTimeoutMinutes, forceSsl, useLegacyFormsAuthDataFormat)
        {
        }

        /// &lt;summary&gt;
        /// Creates the cookie options for saving the auth cookie
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ctx&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;ticket&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public CookieOptions CreateRequestCookieOptions(IOwinContext ctx, AuthenticationTicket ticket)
        {
            if (ctx == null) throw new ArgumentNullException(&quot;ctx&quot;);
            if (ticket == null) throw new ArgumentNullException(&quot;ticket&quot;);

            var issuedUtc = ticket.Properties.IssuedUtc ?? SystemClock.UtcNow;
            var expiresUtc = ticket.Properties.ExpiresUtc ?? issuedUtc.Add(ExpireTimeSpan);

            var cookieOptions = new CookieOptions
            {
                Path = &quot;/&quot;,
                Domain = this.CookieDomain ?? null,
                HttpOnly = true,
                Secure = this.CookieSecure == CookieSecureOption.Always
                                         || (this.CookieSecure == CookieSecureOption.SameAsRequest &amp;&amp; ctx.Request.IsSecure),
            };

            if (ticket.Properties.IsPersistent)
            {
                cookieOptions.Expires = expiresUtc.UtcDateTime;
            }

            return cookieOptions;
        }
          
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,42,18,46,0],[18,47,18,59,0],[21,15,21,121,0],[22,9,22,10,0],[23,9,23,10,0],[25,9,30,54,0],[31,9,31,10,0],[32,13,32,55,0],[33,13,33,82,0],[35,13,35,46,0],[36,13,36,14,0],[38,17,38,97,0],[39,13,39,14,0],[41,13,41,38,0],[42,13,42,72,0],[43,13,43,61,0],[44,13,44,57,0],[45,13,45,35,0],[46,13,46,100,0],[47,13,47,30,0],[50,13,50,111,0],[51,9,51,10,0],[58,15,58,103,0],[59,9,59,10,0],[60,9,60,10,0],[69,9,69,10,0],[70,13,70,29,0],[70,30,70,69,0],[71,13,71,32,0],[71,33,71,75,0],[73,13,73,79,0],[74,13,74,92,0],[76,13,83,15,0],[85,13,85,48,0],[86,13,86,14,0],[87,17,87,64,0],[88,13,88,14,0],[90,13,90,34,0],[91,9,91,10,0]]);
    </script>
  </body>
</html>