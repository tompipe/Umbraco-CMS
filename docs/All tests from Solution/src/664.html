<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\developer\RelationTypes\EditRelationType.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Web.UI;
using System.Web.UI.WebControls;
using umbraco.BasePages;
using umbraco.BusinessLogic;
using Umbraco.Core;
using Umbraco.Core.Models;
using RelationType = umbraco.cms.businesslogic.relation.RelationType;

namespace umbraco.cms.presentation.developer.RelationTypes
{
	/// &lt;summary&gt;
	/// Edit an existing RelationType
	/// &lt;/summary&gt;
    [WebformsPageTreeAuthorize(Constants.Trees.RelationTypes)]
	public partial class EditRelationType : UmbracoEnsuredPage
	{

		/// &lt;summary&gt;
		/// Class scope reference to the current RelationType being edited
		/// &lt;/summary&gt;
		private IRelationType _relationType;

		/// &lt;summary&gt;
		/// Class scope reference to the relations associated with the current RelationType
		/// &lt;/summary&gt;
		private List&lt;ReadOnlyRelation&gt; _relations;

		/// &lt;summary&gt;
		/// Umbraco ObjectType used to represent all parent items in this relation type
		/// &lt;/summary&gt;
		/// 
		private UmbracoObjectTypes _parentObjectType;

		/// &lt;summary&gt;
		/// Umbraco ObjectType used to represent all child items in this relation type
		/// &lt;/summary&gt;
		private UmbracoObjectTypes _childObjectType;

		/// &lt;summary&gt;
		/// Gets the name of the parent object type for all relations in this relation type 
		/// &lt;/summary&gt;
		protected string ParentObjectType
		{
			get
			{
				return this._parentObjectType.GetName();  //UmbracoHelper.GetName(this.parentObjectType);
			}
		}

		/// &lt;summary&gt;
		/// Gets the name of the child object type for all relations in this relation type
		/// &lt;/summary&gt;
		protected string ChildObjectType
		{
			get
			{
				return this._childObjectType.GetName(); //UmbracoHelper.GetName(this.childObjectType);
			}
		}

		/// &lt;summary&gt;
		/// Gets a string representing the current relation type direction
		/// &lt;/summary&gt;
		protected string RelationTypeDirection
		{
			get
			{
				return this._relationType.IsBidirectional ? &quot;bidirectional&quot; : &quot;parentToChild&quot;;
			}
		}

		/// &lt;summary&gt;
		/// Gets the Relations for this RelationType, via lazy load
		/// &lt;/summary&gt;
		private List&lt;ReadOnlyRelation&gt; Relations
		{
			get
			{
				if (this._relations == null)
				{
					this._relations = new List&lt;ReadOnlyRelation&gt;();

                    using (var sqlHelper = BusinessLogic.Application.SqlHelper)
                    using (var reader = sqlHelper.ExecuteReader(@&quot;
                        SELECT  A.id, 
                                A.parentId,
		                        B.[text] AS parentText,
		                        A.childId,
		                        C.[text] AS childText,
                                A.relType,
		                        A.[datetime], 
		                        A.comment
                        FROM umbracoRelation A 
	                        LEFT OUTER JOIN umbracoNode B ON A.parentId = B.id
	                        LEFT OUTER JOIN umbracoNode C ON A.childId = C.id					
                        WHERE A.relType = &quot; + this._relationType.Id.ToString()))
					{
						while (reader.Read())
						{
							var readOnlyRelation = new ReadOnlyRelation();

							readOnlyRelation.Id = reader.GetInt(&quot;id&quot;);
							readOnlyRelation.ParentId = reader.GetInt(&quot;parentId&quot;);
							readOnlyRelation.ParentText = reader.GetString(&quot;parentText&quot;);
							readOnlyRelation.ChildId = reader.GetInt(&quot;childId&quot;);
							readOnlyRelation.ChildText = reader.GetString(&quot;childText&quot;);
							readOnlyRelation.RelType = reader.GetInt(&quot;relType&quot;);
							readOnlyRelation.DateTime = reader.GetDateTime(&quot;datetime&quot;);
							readOnlyRelation.Comment = reader.GetString(&quot;comment&quot;);

							this._relations.Add(readOnlyRelation);
						}
					}
				}

			    return this._relations;
			}
		}

		/// &lt;summary&gt;
		/// On Load event
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;sender&quot;&gt;this aspx page&lt;/param&gt;
		/// &lt;param name=&quot;e&quot;&gt;EventArgs (expect empty)&lt;/param&gt;
		protected void Page_Load(object sender, EventArgs e)
		{
			int id;
			if (int.TryParse(Request.QueryString[&quot;id&quot;], out id))
			{
                var relationService = Services.RelationService;

			    this._relationType = relationService.GetRelationTypeById(id);
				if (this._relationType != null)
				{
				    this._parentObjectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(this._relationType.ParentObjectType);
				    this._childObjectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(this._relationType.ChildObjectType);

					// -----------

				    if (!this.IsPostBack)
				    {
				        this.EnsureChildControls();

				        this.idLiteral.Text = this._relationType.Id.ToString();
				        this.nameTextBox.Text = this._relationType.Name;
				        this.aliasTextBox.Text = this._relationType.Alias;

				        if (this._relationType.IsBidirectional)
				        {
				            this.dualRadioButtonList.Items.FindByValue(&quot;1&quot;).Selected = true;
				        }
				        else
				        {
				            this.dualRadioButtonList.Items.FindByValue(&quot;0&quot;).Selected = true;
				        }

				        this.parentLiteral.Text = this._parentObjectType.GetFriendlyName();
				            // UmbracoHelper.GetFriendlyName(this.parentObjectType);
				        this.childLiteral.Text = this._childObjectType.GetFriendlyName();
				            // UmbracoHelper.GetFriendlyName(this.childObjectType);

				        this.relationsCountLiteral.Text = this.Relations.Count.ToString();

				        this.relationsRepeater.DataSource = this.Relations;
				        this.relationsRepeater.DataBind();
				    }
				}
				else
				{
					throw new Exception(&quot;Unable to get RelationType where ID = &quot; + id);
				}
			}
			else
			{
				throw new Exception(&quot;Invalid RelationType ID&quot;);
			}
		}

		/// &lt;summary&gt;
		/// Creates the child controls used in this page
		/// &lt;/summary&gt;
		protected override void CreateChildControls()
		{
			base.CreateChildControls();

			var relationTypeTabPage = this.tabControl.NewTabPage(&quot;Relation Type&quot;);
			relationTypeTabPage.Controls.Add(this.idPane);
			relationTypeTabPage.Controls.Add(this.nameAliasPane);
			relationTypeTabPage.Controls.Add(this.directionPane);
			relationTypeTabPage.Controls.Add(this.objectTypePane);

			var saveMenuImageButton =  tabControl.Menu.NewButton();
			saveMenuImageButton.ToolTip = &quot;save relation type&quot;;
			saveMenuImageButton.Click +=saveMenuImageButton_Click;
			saveMenuImageButton.CausesValidation = true;
            saveMenuImageButton.Text = ui.Text(&quot;save&quot;);
			saveMenuImageButton.ValidationGroup = &quot;RelationType&quot;;

			var relationsTabPage = this.tabControl.NewTabPage(&quot;Relations&quot;);
			relationsTabPage.Controls.Add(this.relationsCountPane);
			relationsTabPage.Controls.Add(this.relationsPane);

            /*
			var refreshMenuImageButton = relationsTabPage.Menu.NewImageButton();
			refreshMenuImageButton.AlternateText = &quot;refresh relations&quot;;
			refreshMenuImageButton.Click += this.RefreshMenuImageButton_Click;
			refreshMenuImageButton.ImageUrl = &quot;/umbraco/developer/RelationTypes/Images/Refresh.gif&quot;;
			refreshMenuImageButton.CausesValidation = false;*/
		}

       /// &lt;summary&gt;
		/// check that alias hasn&#39;t been changed to clash with another (except itself)
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;source&quot;&gt;the aliasCustomValidator control&lt;/param&gt;
		/// &lt;param name=&quot;args&quot;&gt;to set validation respose&lt;/param&gt;
		protected void AliasCustomValidator_ServerValidate(object source, ServerValidateEventArgs args)
		{
			args.IsValid = (RelationType.GetByAlias(this.aliasTextBox.Text.Trim()) == null) ||
				(this.aliasTextBox.Text.Trim() == this._relationType.Alias);
		}

		/// &lt;summary&gt;
		/// Reload the relations, in case they have changed
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;sender&quot;&gt;expects refreshMenuImageButton&lt;/param&gt;
		/// &lt;param name=&quot;e&quot;&gt;expects ImageClickEventArgs&lt;/param&gt;
		private void RefreshMenuImageButton_Click(object sender, ImageClickEventArgs e)
		{
		}

		/// &lt;summary&gt;
		/// Save button in Umbraco menu
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;sender&quot;&gt;expects saveMenuImageButton object&lt;/param&gt;
		/// &lt;param name=&quot;e&quot;&gt;expects ImageClickEventArgs&lt;/param&gt;
        void saveMenuImageButton_Click(object sender, EventArgs e)
		{
			if (this.Page.IsValid)
			{
				var nameChanged = this._relationType.Name != this.nameTextBox.Text.Trim();
				var aliasChanged = this._relationType.Alias != this.aliasTextBox.Text.Trim();
				var directionChanged = this._relationType.IsBidirectional != (this.dualRadioButtonList.SelectedValue == &quot;1&quot;);

				if (nameChanged || aliasChanged || directionChanged)
				{
					string bubbleBody = string.Empty;

					if (nameChanged)
					{
						bubbleBody += &quot;Name, &quot;;

						this._relationType.Name = this.nameTextBox.Text.Trim();

						// Refresh tree, as the name as changed
						ClientTools.SyncTree(this._relationType.Id.ToString(), true);
					}

					if (directionChanged)
					{
						bubbleBody += &quot;Direction, &quot;;
						this._relationType.IsBidirectional = this.dualRadioButtonList.SelectedValue == &quot;1&quot;;
					}

					if (aliasChanged)
					{
						bubbleBody += &quot;Alias, &quot;;
						this._relationType.Alias = this.aliasTextBox.Text.Trim();
					}

					bubbleBody = bubbleBody.Remove(bubbleBody.LastIndexOf(&#39;,&#39;), 1);
					bubbleBody = bubbleBody + &quot;Changed&quot;;

				    var relationService = Services.RelationService;
                    relationService.Save(this._relationType);
                    
					ClientTools.ShowSpeechBubble(speechBubbleIcon.save, &quot;Relation Type Updated&quot;, bubbleBody);
				}
			}
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[47,4,47,5,0],[48,5,48,45,0],[49,4,49,5,0],[58,4,58,5,0],[59,5,59,44,0],[60,4,60,5,0],[69,4,69,5,0],[70,5,70,83,0],[71,4,71,5,0],[80,4,80,5,0],[81,5,81,33,0],[82,5,82,6,0],[83,6,83,53,0],[85,28,85,79,0],[86,28,98,80,0],[99,6,99,7,0],[100,7,100,28,0],[101,7,101,8,0],[102,8,102,54,0],[104,8,104,50,0],[105,8,105,62,0],[106,8,106,69,0],[107,8,107,60,0],[108,8,108,67,0],[109,8,109,60,0],[110,8,110,67,0],[111,8,111,63,0],[113,8,113,46,0],[114,7,114,8,0],[115,6,115,7,0],[116,5,116,6,0],[118,8,118,31,0],[119,4,119,5,0],[128,3,128,4,0],[130,4,130,56,0],[131,4,131,5,0],[132,17,132,64,0],[134,8,134,69,0],[135,5,135,36,0],[136,5,136,6,0],[137,9,137,121,0],[138,9,138,119,0],[142,9,142,30,0],[143,9,143,10,0],[144,13,144,40,0],[146,13,146,68,0],[147,13,147,61,0],[148,13,148,63,0],[150,13,150,52,0],[151,13,151,14,0],[152,17,152,81,0],[153,13,153,14,0],[155,13,155,14,0],[156,17,156,81,0],[157,13,157,14,0],[159,13,159,80,0],[161,13,161,78,0],[164,13,164,79,0],[166,13,166,64,0],[167,13,167,47,0],[168,9,168,10,0],[169,5,169,6,0],[171,5,171,6,0],[172,6,172,73,0],[174,4,174,5,0],[176,4,176,5,0],[177,5,177,52,0],[179,3,179,4,0],[185,3,185,4,0],[186,4,186,31,0],[188,4,188,74,0],[189,4,189,50,0],[190,4,190,57,0],[191,4,191,57,0],[192,4,192,58,0],[194,4,194,59,0],[195,4,195,55,0],[196,4,196,58,0],[197,4,197,48,0],[198,13,198,56,0],[199,4,199,57,0],[201,4,201,67,0],[202,4,202,59,0],[203,4,203,54,0],[211,3,211,4,0],[219,3,219,4,0],[220,4,221,65,0],[222,3,222,4,0],[230,3,230,4,0],[231,3,231,4,0],[239,3,239,4,0],[240,4,240,26,0],[241,4,241,5,0],[242,5,242,79,0],[243,5,243,82,0],[244,5,244,114,0],[246,5,246,57,0],[247,5,247,6,0],[248,6,248,39,0],[250,6,250,22,0],[251,6,251,7,0],[252,7,252,30,0],[254,7,254,62,0],[257,7,257,68,0],[258,6,258,7,0],[260,6,260,27,0],[261,6,261,7,0],[262,7,262,35,0],[263,7,263,90,0],[264,6,264,7,0],[266,6,266,23,0],[267,6,267,7,0],[268,7,268,31,0],[269,7,269,64,0],[270,6,270,7,0],[272,6,272,69,0],[273,6,273,42,0],[275,9,275,56,0],[276,21,276,62,0],[278,6,278,95,0],[279,5,279,6,0],[280,4,280,5,0],[281,3,281,4,0]]);
    </script>
  </body>
</html>