<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\TestHelpers\Stubs\TestControllerFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Web.Mvc;
using System.Web.Routing;
using System.Web.SessionState;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Web;

namespace Umbraco.Tests.TestHelpers.Stubs
{
	/// &lt;summary&gt;
	/// Used in place of the UmbracoControllerFactory which relies on BuildManager which throws exceptions in a unit test context
	/// &lt;/summary&gt;
	internal class TestControllerFactory : IControllerFactory
	{
	    private readonly UmbracoContext _umbracoContext;
	    private readonly ILogger _logger;

	    public TestControllerFactory(UmbracoContext umbracoContext, ILogger logger)
	    {
	        _umbracoContext = umbracoContext;
	        _logger = logger;
	    }

	    public IController CreateController(RequestContext requestContext, string controllerName)
		{
			var types = TypeFinder.FindClassesOfType&lt;ControllerBase&gt;(new[] { Assembly.GetExecutingAssembly() });

			var controllerTypes = types.Where(x =&gt; x.Name.Equals(controllerName + &quot;Controller&quot;, StringComparison.InvariantCultureIgnoreCase));
			var t = controllerTypes.SingleOrDefault();

			if (t == null)
				return null;

	        var possibleParams = new object[]
	        {
	            _umbracoContext, _logger
	        };
	        var ctors = t.GetConstructors();
	        foreach (var ctor in ctors.OrderByDescending(x =&gt; x.GetParameters().Count()))
	        {
	            var args = new List&lt;object&gt;();
	            var allParams = ctor.GetParameters().ToArray();
	            foreach (var parameter in allParams)
	            {
	                var found = possibleParams.SingleOrDefault(x =&gt; x.GetType() == parameter.ParameterType);
	                if (found != null) args.Add(found);
	            }
	            if (args.Count == allParams.Length)
	            {
                    return Activator.CreateInstance(t, args.ToArray()) as IController;
	            }
	        }
	        return null;
		}

		public System.Web.SessionState.SessionStateBehavior GetControllerSessionBehavior(RequestContext requestContext, string controllerName)
		{
			return SessionStateBehavior.Disabled;
		}

		public void ReleaseController(IController controller)
		{
			controller.DisposeIfDisposable();
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,6,23,81,1],[24,6,24,7,1],[25,10,25,43,1],[26,10,26,27,1],[27,6,27,7,1],[30,3,30,4,1],[31,4,31,104,1],[33,4,33,43,1],[33,43,33,132,1],[33,132,33,134,1],[33,4,33,134,1],[34,4,34,46,1],[36,4,36,18,1],[37,5,37,17,1],[39,10,42,12,1],[43,10,43,42,1],[44,10,44,17,1],[44,19,44,27,1],[44,28,44,30,1],[44,31,44,60,1],[44,60,44,85,1],[44,85,44,86,1],[44,31,44,86,1],[45,10,45,11,1],[46,14,46,44,1],[47,14,47,61,1],[48,14,48,21,1],[48,23,48,36,1],[48,37,48,39,1],[48,40,48,49,1],[49,14,49,15,1],[50,18,50,66,1],[50,66,50,104,1],[50,104,50,106,1],[50,18,50,106,1],[51,18,51,36,1],[51,37,51,53,1],[52,14,52,15,1],[53,14,53,49,1],[54,14,54,15,1],[55,21,55,87,1],[57,10,57,11,0],[58,10,58,22,0],[59,3,59,4,1],[62,3,62,4,1],[63,4,63,41,1],[64,3,64,4,1],[67,3,67,4,0],[68,4,68,37,0],[69,3,69,4,0]]);
    </script>
  </body>
</html>