<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\MemberGroupRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Events;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;

using Umbraco.Core.Persistence.Factories;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Core.Services;
using Umbraco.Core.Cache;

namespace Umbraco.Core.Persistence.Repositories
{


    internal class MemberGroupRepository : PetaPocoRepositoryBase&lt;int, IMemberGroup&gt;, IMemberGroupRepository
    {
        public MemberGroupRepository(IDatabaseUnitOfWork work, CacheHelper cache, ILogger logger, ISqlSyntaxProvider sqlSyntax)
            : base(work, cache, logger, sqlSyntax)
        {
        }

        private readonly MemberGroupFactory _modelFactory = new MemberGroupFactory();

        protected override IMemberGroup PerformGet(int id)
        {
            var sql = GetBaseQuery(false);
            sql.Where(GetBaseWhereClause(), new { Id = id });

            var dto = Database.Fetch&lt;NodeDto&gt;(SqlSyntax.SelectTop(sql, 1)).FirstOrDefault();

            return dto == null ? null : _modelFactory.BuildEntity(dto);
        }

        protected override IEnumerable&lt;IMemberGroup&gt; PerformGetAll(params int[] ids)
        {
            if (ids.Any())
            {
                var sql = new Sql()
                    .Select(&quot;*&quot;)
                    .From&lt;NodeDto&gt;()
                    .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeObjectType == NodeObjectTypeId)
                    .Where(&quot;umbracoNode.id in (@ids)&quot;, new { ids = ids });
                return Database.Fetch&lt;NodeDto&gt;(sql)
                    .Select(x =&gt; _modelFactory.BuildEntity(x));
            }
            else
            {
                var sql = new Sql()
                    .From&lt;NodeDto&gt;()
                    .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeObjectType == NodeObjectTypeId);
                return Database.Fetch&lt;NodeDto&gt;(sql)
                    .Select(x =&gt; _modelFactory.BuildEntity(x));
            }
        }

        protected override IEnumerable&lt;IMemberGroup&gt; PerformGetByQuery(IQuery&lt;IMemberGroup&gt; query)
        {
            var sqlClause = GetBaseQuery(false);
            var translator = new SqlTranslator&lt;IMemberGroup&gt;(sqlClause, query);
            var sql = translator.Translate();

            return Database.Fetch&lt;NodeDto&gt;(sql)
                .Select(x =&gt; _modelFactory.BuildEntity(x));
        }

        protected override Sql GetBaseQuery(bool isCount)
        {
            var sql = new Sql();
            sql.Select(isCount ? &quot;COUNT(*)&quot; : &quot;*&quot;)
                .From&lt;NodeDto&gt;()                
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == NodeObjectTypeId);
            return sql;
        }

        protected override string GetBaseWhereClause()
        {
            return &quot;umbracoNode.id = @Id&quot;;
        }

        protected override IEnumerable&lt;string&gt; GetDeleteClauses()
        {
            var list = new[]
                           {
                               &quot;DELETE FROM umbracoUser2NodeNotify WHERE nodeId = @Id&quot;,
                               &quot;DELETE FROM umbracoUser2NodePermission WHERE nodeId = @Id&quot;,
                               &quot;DELETE FROM umbracoRelation WHERE parentId = @Id&quot;,
                               &quot;DELETE FROM umbracoRelation WHERE childId = @Id&quot;,
                               &quot;DELETE FROM cmsTagRelationship WHERE nodeId = @Id&quot;,
                               &quot;DELETE FROM cmsMember2MemberGroup WHERE MemberGroup = @Id&quot;,
                               &quot;DELETE FROM umbracoNode WHERE id = @Id&quot;
                           };
            return list;
        }

        protected override Guid NodeObjectTypeId
        {
            get { return new Guid(Constants.ObjectTypes.MemberGroup); }
        }

        protected override void PersistNewItem(IMemberGroup entity)
        {
            //Save to db
            var group = (MemberGroup)entity;
            group.AddingEntity();
            var dto = _modelFactory.BuildDto(group);
            var o = Database.IsNew(dto) ? Convert.ToInt32(Database.Insert(dto)) : Database.Update(dto);
            group.Id = dto.NodeId; //Set Id on entity to ensure an Id is set
            
            //Update with new correct path and id            
            dto.Path = string.Concat(&quot;-1,&quot;, dto.NodeId);
            Database.Update(dto);
            //assign to entity
            group.Id = o;
            group.ResetDirtyProperties();
        }

        protected override void PersistUpdatedItem(IMemberGroup entity)
        {
            var dto = _modelFactory.BuildDto(entity);

            Database.Update(dto);
            
            entity.ResetDirtyProperties();
        }

        public IMemberGroup GetByName(string name)
        {
            return RuntimeCache.GetCacheItem&lt;IMemberGroup&gt;(
                string.Format(&quot;{0}.{1}&quot;, typeof (IMemberGroup).FullName, name),
                () =&gt;
                {
                    var qry = new Query&lt;IMemberGroup&gt;().Where(group =&gt; group.Name.Equals(name));
                    var result = GetByQuery(qry);
                    return result.FirstOrDefault();
                },
                //cache for 5 mins since that is the default in the RuntimeCacheProvider
                TimeSpan.FromMinutes(5), 
                //sliding is true
                true);
        }

        public IMemberGroup CreateIfNotExists(string roleName)
        {
            using (var transaction = Database.GetTransaction())
            {
                var qry = new Query&lt;IMemberGroup&gt;().Where(group =&gt; group.Name.Equals(roleName));
                var result = GetByQuery(qry);

                if (result.Any()) return null;

                var grp = new MemberGroup
                {
                    Name = roleName
                };
                PersistNewItem(grp);

                if (SavingMemberGroup.IsRaisedEventCancelled(new SaveEventArgs&lt;IMemberGroup&gt;(grp), this))
                {
                    return null;
                }

                transaction.Complete();

                SavedMemberGroup.RaiseEvent(new SaveEventArgs&lt;IMemberGroup&gt;(grp), this);

                return grp;
            }
        }

        public IEnumerable&lt;IMemberGroup&gt; GetMemberGroupsForMember(int memberId)
        {
            var sql = new Sql();
            sql.Select(&quot;umbracoNode.*&quot;)
                .From&lt;NodeDto&gt;()
                .InnerJoin&lt;Member2MemberGroupDto&gt;()
                .On&lt;NodeDto, Member2MemberGroupDto&gt;(dto =&gt; dto.NodeId, dto =&gt; dto.MemberGroup)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == NodeObjectTypeId)
                .Where&lt;Member2MemberGroupDto&gt;(x =&gt; x.Member == memberId);

            return Database.Fetch&lt;NodeDto&gt;(sql)
                .DistinctBy(dto =&gt; dto.NodeId)
                .Select(x =&gt; _modelFactory.BuildEntity(x));
        }

        public IEnumerable&lt;IMemberGroup&gt; GetMemberGroupsForMember(string username)
        {
            //find the member by username
            var memberSql = new Sql();
            var memberObjectType = new Guid(Constants.ObjectTypes.Member);
            
            memberSql.Select(&quot;umbracoNode.id&quot;)
                .From&lt;NodeDto&gt;()
                .InnerJoin&lt;MemberDto&gt;()
                .On&lt;NodeDto, MemberDto&gt;(dto =&gt; dto.NodeId, dto =&gt; dto.NodeId)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == memberObjectType)
                .Where&lt;MemberDto&gt;(x =&gt; x.LoginName == username);
            var memberIdUsername = Database.Fetch&lt;int?&gt;(memberSql).FirstOrDefault();
            if (memberIdUsername.HasValue == false)
            {
                return Enumerable.Empty&lt;IMemberGroup&gt;();
            }

            var sql = new Sql();
            sql.Select(&quot;umbracoNode.*&quot;)
                .From&lt;NodeDto&gt;()
                .InnerJoin&lt;Member2MemberGroupDto&gt;()
                .On&lt;NodeDto, Member2MemberGroupDto&gt;(dto =&gt; dto.NodeId, dto =&gt; dto.MemberGroup)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == NodeObjectTypeId)
                .Where&lt;Member2MemberGroupDto&gt;(x =&gt; x.Member == memberIdUsername.Value);

            return Database.Fetch&lt;NodeDto&gt;(sql)
                .DistinctBy(dto =&gt; dto.NodeId)
                .Select(x =&gt; _modelFactory.BuildEntity(x));
        }

        public void AssignRoles(string[] usernames, string[] roleNames)
        {
            using (var transaction = Database.GetTransaction())
            {
                //first get the member ids based on the usernames
                var memberSql = new Sql();
                var memberObjectType = new Guid(Constants.ObjectTypes.Member);
                memberSql.Select(&quot;umbracoNode.id&quot;)
                    .From&lt;NodeDto&gt;()
                    .InnerJoin&lt;MemberDto&gt;()
                    .On&lt;NodeDto, MemberDto&gt;(dto =&gt; dto.NodeId, dto =&gt; dto.NodeId)
                    .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == memberObjectType)
                    .Where(&quot;cmsMember.LoginName in (@usernames)&quot;, new { usernames = usernames });
                var memberIds = Database.Fetch&lt;int&gt;(memberSql).ToArray();

                AssignRolesInternal(memberIds, roleNames);
                transaction.Complete();
            }
        }

        public void DissociateRoles(string[] usernames, string[] roleNames)
        {
            using (var transaction = Database.GetTransaction())
            {
                //first get the member ids based on the usernames
                var memberSql = new Sql();
                var memberObjectType = new Guid(Constants.ObjectTypes.Member);
                memberSql.Select(&quot;umbracoNode.id&quot;)
                    .From&lt;NodeDto&gt;()
                    .InnerJoin&lt;MemberDto&gt;()
                    .On&lt;NodeDto, MemberDto&gt;(dto =&gt; dto.NodeId, dto =&gt; dto.NodeId)
                    .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == memberObjectType)
                    .Where(&quot;cmsMember.LoginName in (@usernames)&quot;, new { usernames = usernames });
                var memberIds = Database.Fetch&lt;int&gt;(memberSql).ToArray();

                DissociateRolesInternal(memberIds, roleNames);
                transaction.Complete();
            }
        }

        public void AssignRoles(int[] memberIds, string[] roleNames)
        {
            using (var transaction = Database.GetTransaction())
            {
                AssignRolesInternal(memberIds, roleNames);
                transaction.Complete();
            }
        }

        public void AssignRolesInternal(int[] memberIds, string[] roleNames)
        {
            //ensure they&#39;re unique
            memberIds = memberIds.Distinct().ToArray();

            //create the missing roles first

            var existingSql = new Sql()
               .Select(&quot;*&quot;)
               .From&lt;NodeDto&gt;()
               .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeObjectType == NodeObjectTypeId)
               .Where(&quot;umbracoNode.&quot; + SqlSyntax.GetQuotedColumnName(&quot;text&quot;) + &quot; in (@names)&quot;, new { names = roleNames });
            var existingRoles = Database.Fetch&lt;NodeDto&gt;(existingSql).Select(x =&gt; x.Text);
            var missingRoles = roleNames.Except(existingRoles);
            var missingGroups = missingRoles.Select(x =&gt; new MemberGroup {Name = x}).ToArray();

            if (SavingMemberGroup.IsRaisedEventCancelled(new SaveEventArgs&lt;IMemberGroup&gt;(missingGroups), this))
            {
                return;
            }
            foreach (var m in missingGroups)
            {
                PersistNewItem(m);
            }
            SavedMemberGroup.RaiseEvent(new SaveEventArgs&lt;IMemberGroup&gt;(missingGroups), this);

            //now go get all the dto&#39;s for roles with these role names
            var rolesForNames = Database.Fetch&lt;NodeDto&gt;(existingSql).ToArray();

            //get the groups that are currently assigned to any of these members

            var assignedSql = new Sql();
            assignedSql.Select(string.Format(
                    &quot;{0},{1},{2}&quot;,
                    SqlSyntax.GetQuotedColumnName(&quot;text&quot;),
                    SqlSyntax.GetQuotedColumnName(&quot;Member&quot;),
                    SqlSyntax.GetQuotedColumnName(&quot;MemberGroup&quot;)))
                .From&lt;NodeDto&gt;()
                .InnerJoin&lt;Member2MemberGroupDto&gt;()
                .On&lt;NodeDto, Member2MemberGroupDto&gt;(dto =&gt; dto.NodeId, dto =&gt; dto.MemberGroup)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == NodeObjectTypeId)
                .Where(&quot;cmsMember2MemberGroup.Member in (@ids)&quot;, new { ids = memberIds });

            var currentlyAssigned = Database.Fetch&lt;AssignedRolesDto&gt;(assignedSql).ToArray();

            //assign the roles for each member id

            foreach (var memberId in memberIds)
            {
                //find any roles for the current member that are currently assigned that 
                //exist in the roleNames list, then determine which ones are not currently assigned.
                var mId = memberId;
                var found = currentlyAssigned.Where(x =&gt; x.MemberId == mId).ToArray();
                var assignedRoles = found.Where(x =&gt; roleNames.Contains(x.RoleName)).Select(x =&gt; x.RoleName);
                var nonAssignedRoles = roleNames.Except(assignedRoles);
                foreach (var toAssign in nonAssignedRoles)
                {
                    var groupId = rolesForNames.First(x =&gt; x.Text == toAssign).NodeId;
                    Database.Insert(new Member2MemberGroupDto { Member = mId, MemberGroup = groupId });
                }
            }
        }

        public void DissociateRoles(int[] memberIds, string[] roleNames)
        {
            using (var transaction = Database.GetTransaction())
            {
                DissociateRolesInternal(memberIds, roleNames);
                transaction.Complete();
            }
        }

        private void DissociateRolesInternal(int[] memberIds, string[] roleNames)
        {
            var existingSql = new Sql()
                    .Select(&quot;*&quot;)
                    .From&lt;NodeDto&gt;()
                    .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeObjectType == NodeObjectTypeId)
                    .Where(&quot;umbracoNode.&quot; + SqlSyntax.GetQuotedColumnName(&quot;text&quot;) + &quot; in (@names)&quot;, new { names = roleNames });
            var existingRolesIds = Database.Fetch&lt;NodeDto&gt;(existingSql).Select(x =&gt; x.NodeId).ToArray();

            Database.Execute(&quot;DELETE FROM cmsMember2MemberGroup WHERE Member IN (@memberIds) AND MemberGroup IN (@memberGroups)&quot;,
                new { memberIds = memberIds, memberGroups = existingRolesIds });
        }

        private class AssignedRolesDto
        {
            [Column(&quot;text&quot;)]
            public string RoleName { get; set; }

            [Column(&quot;Member&quot;)]
            public int MemberId { get; set; }

            [Column(&quot;MemberGroup&quot;)]
            public int MemberGroupId { get; set; }
        }

        /// &lt;summary&gt;
        /// Occurs before Save
        /// &lt;/summary&gt;
        internal static event TypedEventHandler&lt;IMemberGroupRepository, SaveEventArgs&lt;IMemberGroup&gt;&gt; SavingMemberGroup;

        /// &lt;summary&gt;
        /// Occurs after Save
        /// &lt;/summary&gt;
        internal static event TypedEventHandler&lt;IMemberGroupRepository, SaveEventArgs&lt;IMemberGroup&gt;&gt; SavedMemberGroup;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,15,24,51,1],[25,9,25,10,1],[26,9,26,10,1],[28,9,28,86,1],[31,9,31,10,0],[32,13,32,43,0],[33,13,33,62,0],[35,13,35,93,0],[37,13,37,72,0],[38,9,38,10,0],[41,9,41,10,1],[42,13,42,27,1],[43,13,43,14,0],[44,17,48,75,0],[49,17,50,34,0],[50,34,50,62,0],[50,62,50,64,0],[49,17,50,64,0],[53,13,53,14,1],[54,17,56,84,1],[57,17,58,34,1],[58,34,58,62,1],[58,62,58,64,1],[57,17,58,64,1],[60,9,60,10,1],[63,9,63,10,1],[64,13,64,49,1],[65,13,65,80,1],[66,13,66,46,1],[68,13,69,30,1],[69,30,69,58,1],[69,58,69,60,1],[68,13,69,60,1],[70,9,70,10,1],[73,9,73,10,1],[74,13,74,33,1],[75,13,77,76,1],[78,13,78,24,1],[79,9,79,10,1],[82,9,82,10,0],[83,13,83,43,0],[84,9,84,10,0],[87,9,87,10,1],[88,13,97,30,1],[98,13,98,25,1],[99,9,99,10,1],[103,17,103,18,1],[103,19,103,70,1],[103,71,103,72,1],[107,9,107,10,1],[109,13,109,45,1],[110,13,110,34,1],[111,13,111,53,1],[112,13,112,104,1],[113,13,113,35,1],[116,13,116,57,1],[117,13,117,34,1],[119,13,119,26,1],[120,13,120,42,1],[121,9,121,10,1],[124,9,124,10,0],[125,13,125,54,0],[127,13,127,34,0],[129,13,129,43,0],[130,9,130,10,0],[133,9,133,10,0],[134,13,137,17,0],[137,17,137,18,0],[137,18,138,21,0],[138,21,138,97,0],[138,97,139,21,0],[139,21,139,50,0],[139,50,140,21,0],[140,21,140,52,0],[140,52,141,17,0],[141,17,141,18,0],[141,18,145,23,0],[134,13,145,23,0],[146,9,146,10,0],[149,9,149,10,1],[150,20,150,63,1],[151,13,151,14,1],[152,17,152,97,1],[153,17,153,46,1],[155,17,155,34,1],[155,35,155,47,1],[157,17,160,19,1],[161,17,161,37,1],[163,17,163,106,1],[164,17,164,18,0],[165,21,165,33,0],[168,17,168,40,1],[170,17,170,89,1],[172,17,172,28,1],[174,9,174,10,1],[177,9,177,10,1],[178,13,178,33,1],[179,13,184,74,1],[186,13,187,36,1],[187,36,187,46,1],[187,46,188,30,1],[188,30,188,58,1],[188,58,188,60,1],[186,13,188,60,1],[189,9,189,10,1],[192,9,192,10,1],[194,13,194,39,1],[195,13,195,75,1],[197,13,202,65,1],[203,13,203,85,1],[204,13,204,52,1],[205,13,205,14,0],[206,17,206,57,0],[209,13,209,33,1],[210,13,215,88,1],[217,13,218,36,1],[218,36,218,46,1],[218,46,219,30,1],[219,30,219,58,1],[219,58,219,60,1],[217,13,219,60,1],[220,9,220,10,1],[223,9,223,10,1],[224,20,224,63,1],[225,13,225,14,1],[227,17,227,43,1],[228,17,228,79,1],[229,17,234,98,1],[235,17,235,74,1],[237,17,237,59,1],[238,17,238,40,1],[239,13,239,14,1],[240,9,240,10,1],[243,9,243,10,1],[244,20,244,63,1],[245,13,245,14,1],[247,17,247,43,1],[248,17,248,79,1],[249,17,254,98,1],[255,17,255,74,1],[257,17,257,63,1],[258,17,258,40,1],[259,13,259,14,1],[260,9,260,10,1],[263,9,263,10,1],[264,20,264,63,1],[265,13,265,14,1],[266,17,266,59,1],[267,17,267,40,1],[268,13,268,14,1],[269,9,269,10,1],[272,9,272,10,1],[274,13,274,56,1],[278,13,282,123,1],[283,13,283,82,1],[283,82,283,88,1],[283,88,283,90,1],[283,13,283,90,1],[284,13,284,64,1],[285,13,285,58,1],[285,58,285,84,1],[285,84,285,96,1],[285,13,285,96,1],[287,13,287,112,1],[288,13,288,14,0],[289,17,289,24,0],[291,13,291,20,1],[291,22,291,27,1],[291,28,291,30,1],[291,31,291,44,1],[292,13,292,14,1],[293,17,293,35,1],[294,13,294,14,1],[295,13,295,95,1],[298,13,298,80,1],[302,13,302,41,1],[303,13,312,91,1],[314,13,314,93,1],[318,13,318,20,1],[318,22,318,34,1],[318,35,318,37,1],[318,38,318,47,1],[319,13,319,14,1],[322,17,322,36,1],[323,17,323,58,1],[323,58,323,75,0],[323,75,323,87,1],[323,17,323,87,1],[324,17,324,54,1],[324,54,324,84,0],[324,84,324,98,1],[324,98,324,108,0],[324,108,324,110,1],[324,17,324,110,1],[325,17,325,72,1],[326,17,326,24,1],[326,26,326,38,1],[326,39,326,41,1],[326,42,326,58,1],[327,17,327,18,1],[328,21,328,60,1],[328,60,328,78,1],[328,78,328,87,1],[328,21,328,87,1],[329,21,329,104,1],[330,17,330,18,1],[331,13,331,14,1],[332,9,332,10,1],[335,9,335,10,1],[336,20,336,63,1],[337,13,337,14,1],[338,17,338,63,1],[339,17,339,40,1],[340,13,340,14,1],[341,9,341,10,1],[344,9,344,10,1],[345,13,349,128,1],[350,13,350,85,1],[350,85,350,93,1],[350,93,350,105,1],[350,13,350,105,1],[352,13,353,81,1],[354,9,354,10,1],[359,38,359,42,0],[359,43,359,47,0],[362,35,362,39,0],[362,40,362,44,0],[365,40,365,44,0],[365,45,365,49,0]]);
    </script>
  </body>
</html>