<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\PublishValuesMultipleValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Newtonsoft.Json.Linq;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Services;

namespace Umbraco.Web.PropertyEditors
{
    /// &lt;summary&gt;
    /// Custom value editor to handle posted json data and to return json data for the multiple selected items as well as ensuring
    /// that the multiple selected int IDs are published to cache as a delimited string (values)
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This is re-used by editors such as the multiple drop down list or check box list
    /// &lt;/remarks&gt;
    internal class PublishValuesMultipleValueEditor : PublishValueValueEditor
    {
        private readonly bool _publishIds;

        internal PublishValuesMultipleValueEditor(bool publishIds, IDataTypeService dataTypeService, PropertyValueEditor wrapped)
            : base(dataTypeService, wrapped)
        {
            _publishIds = publishIds;
        }

        public PublishValuesMultipleValueEditor(bool publishIds, PropertyValueEditor wrapped)
            : this(publishIds, ApplicationContext.Current.Services.DataTypeService, wrapped)
        {
        }

        /// &lt;summary&gt;
        /// If publishing ids, we don&#39;t need to do anything, otherwise we need to look up the pre-values and get the string values
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;property&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;propertyType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeService&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override string ConvertDbToString(Property property, PropertyType propertyType, IDataTypeService dataTypeService)
        {
            if (property.Value == null)
                return null;

            //publishing ids, so just need to return the value as-is
            if (_publishIds)
            {
                return property.Value.ToString();
            }

            //get the multiple ids
            var selectedIds = property.Value.ToString().Split(new[] {&#39;,&#39;}, StringSplitOptions.RemoveEmptyEntries);
            if (selectedIds.Any() == false)
            {
                //nothing there
                return base.ConvertDbToString(property, propertyType, dataTypeService);
            }

            var preValues = GetPreValues(property);
            if (preValues != null)
            {
                //get all pre-values matching our Ids
                return string.Join(&quot;,&quot;, 
                                   preValues.Where(x =&gt; selectedIds.Contains(x.Value.Id.ToInvariantString())).Select(x =&gt; x.Value.Value));
            }

            return base.ConvertDbToString(property, propertyType, dataTypeService);
        }

        /// &lt;summary&gt;
        /// Override so that we can return a json array to the editor for multi-select values
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;property&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;propertyType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeService&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override object ConvertDbToEditor(Property property, PropertyType propertyType, IDataTypeService dataTypeService)
        {
            var delimited = base.ConvertDbToEditor(property, propertyType, dataTypeService).ToString();
            return delimited.Split(new[] { &#39;,&#39; }, StringSplitOptions.RemoveEmptyEntries);
        }

        /// &lt;summary&gt;
        /// When multiple values are selected a json array will be posted back so we need to format for storage in 
        /// the database which is a comma separated ID value
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;editorValue&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;currentValue&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override object ConvertEditorToDb(Core.Models.Editors.ContentPropertyData editorValue, object currentValue)
        {
            var json = editorValue.Value as JArray;
            if (json == null)
            {
                return null;
            }

            var values = json.Select(item =&gt; item.Value&lt;string&gt;()).ToList();
            //change to delimited
            return string.Join(&quot;,&quot;, values);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,15,23,45,1],[24,9,24,10,1],[25,13,25,38,1],[26,9,26,10,1],[29,15,29,93,1],[30,9,30,10,1],[31,9,31,10,1],[41,9,41,10,1],[42,13,42,40,1],[43,17,43,29,0],[46,13,46,29,1],[47,13,47,14,1],[48,17,48,50,1],[52,13,52,115,1],[53,13,53,44,1],[54,13,54,14,0],[56,17,56,88,0],[59,13,59,52,1],[60,13,60,35,1],[61,13,61,14,1],[63,17,64,57,1],[64,57,64,109,1],[64,109,64,123,1],[64,123,64,136,1],[64,136,64,139,1],[63,17,64,139,1],[67,13,67,84,0],[68,9,68,10,1],[78,9,78,10,0],[79,13,79,104,0],[80,13,80,90,0],[81,9,81,10,0],[91,9,91,10,0],[92,13,92,52,0],[93,13,93,30,0],[94,13,94,14,0],[95,17,95,29,0],[98,13,98,46,0],[98,46,98,66,0],[98,66,98,77,0],[98,13,98,77,0],[100,13,100,45,0],[101,9,101,10,0]]);
    </script>
  </body>
</html>