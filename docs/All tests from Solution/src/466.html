<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\Trees\loadMembers.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Text;
using System.Web;
using System.Web.Security;
using System.Xml;
using System.Configuration;
using Umbraco.Core.Security;
using umbraco.BasePages;
using umbraco.BusinessLogic;
using umbraco.businesslogic;
using umbraco.cms.businesslogic;
using umbraco.cms.businesslogic.cache;
using umbraco.cms.businesslogic.contentitem;
using umbraco.cms.businesslogic.datatype;
using umbraco.cms.businesslogic.language;
using umbraco.cms.businesslogic.media;
using umbraco.cms.businesslogic.member;
using umbraco.cms.businesslogic.property;
using umbraco.cms.businesslogic.web;
using umbraco.interfaces;
using umbraco.DataLayer;
using umbraco.BusinessLogic.Utils;
using umbraco.cms.presentation.Trees;
using Umbraco.Core;


namespace umbraco
{
    /// &lt;summary&gt;
    /// Handles loading of the member application into the application tree
    /// &lt;/summary&gt;
    [Obsolete(&quot;This is no longer used and will be removed from the codebase in the future&quot;)]
    public class loadMembers : BaseTree
    {
        public loadMembers(string application) : base(application) { }

        protected override void CreateRootNode(ref XmlTreeNode rootNode)
        {
            rootNode.NodeType = &quot;init&quot; + TreeAlias;
            rootNode.NodeID = &quot;init&quot;;
        }

        /// &lt;summary&gt;
        /// Renders the Javascript.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Javascript&quot;&gt;The javascript.&lt;/param&gt;
        public override void RenderJS(ref StringBuilder Javascript)
        {
            Javascript.Append(
                @&quot;
function openMember(id) {
	UmbClientMgr.contentFrame(&#39;members/editMember.aspx?id=&#39; + id);
}

function searchMembers(id) {
	UmbClientMgr.contentFrame(&#39;members/search.aspx&#39;);
}

function viewMembers(letter) {
	UmbClientMgr.contentFrame(&#39;members/viewMembers.aspx?letter=&#39; + letter);
}

function openContentItem(id) {
	UmbClientMgr.contentFrame(&#39;ContentItem/edit.aspx?id=&#39; + id);
}
&quot;);
        }

        /// &lt;summary&gt;
        /// This will call the normal Render method by passing the converted XmlTree to an XmlDocument.
        /// TODO: need to update this render method to do everything that the obsolete render method does and remove the obsolete method
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;tree&quot;&gt;&lt;/param&gt;
        public override void Render(ref XmlTree tree)
        {
            XmlDocument xDoc = new XmlDocument();
            xDoc.LoadXml(tree.ToString(SerializedTreeType.XmlTree));
            Render(ref xDoc);
            tree = SerializableData.Deserialize(xDoc.OuterXml, typeof(XmlTree)) as XmlTree;
			//ensure that the tree type is set! this wouldn&#39;t need to be done if BaseTree was implemented properly
			foreach (XmlTreeNode node in tree)
				node.TreeType = this.TreeAlias;
        }

        /// &lt;summary&gt;
        /// Renders the specified tree item.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Tree&quot;&gt;The tree.&lt;/param&gt;
        public override void Render(ref XmlDocument Tree)
        {
            var provider = MembershipProviderExtensions.GetMembersMembershipProvider();

            string letter = &quot;&quot;;
            string ContentItemParent = &quot;&quot;;
            if (HttpContext.Current.Request.QueryString.ToString().IndexOf(&quot;letter&quot;) &gt;= 0)
            {
                letter = HttpContext.Current.Request.QueryString.Get(&quot;letter&quot;);
            }
            if (HttpContext.Current.Request.QueryString.ToString().IndexOf(&quot;ContentItemParent&quot;) &gt;= 0)
            {
                ContentItemParent = HttpContext.Current.Request.QueryString.Get(&quot;ContentItemParent&quot;);
            }
            // letter = ;

            XmlNode root = Tree.DocumentElement;
            if (letter != &quot;&quot;)
            {
                if (ContentItemParent != &quot;&quot;) // show contentitems owned by the specific member!
                {
                    CMSNode c = new CMSNode(int.Parse(ContentItemParent));
                    var childs = c.ChildrenOfAllObjectTypes;
                    foreach (CMSNode cn in childs)
                    {
                        XmlElement treeElement = Tree.CreateElement(&quot;tree&quot;);
                        treeElement.SetAttribute(&quot;menu&quot;, &quot;D,L&quot;);
                        treeElement.SetAttribute(&quot;nodeID&quot;, cn.Id.ToString());
                        treeElement.SetAttribute(&quot;text&quot;, cn.Text);
                        // treeElement.SetAttribute(&quot;action&quot;, &quot;javascript:openMember(&quot; + m.Id.ToString() + &quot;);&quot;);
                        treeElement.SetAttribute(&quot;action&quot;, &quot;javascript:openContentItem(&quot; + cn.Id + &quot;);&quot;);
                        if (!cn.HasChildren)
                        {
                            treeElement.SetAttribute(&quot;src&quot;, &quot;&quot;);
                        }
                        else
                        {
                            treeElement.SetAttribute(&quot;src&quot;,
                                &quot;tree.aspx?letter=&quot; + letter + &quot;&amp;app=&quot; + m_app + &quot;&amp;treeType=&quot; +
                                HttpContext.Current.Request.QueryString[&quot;treeType&quot;] + &quot;&amp;ContentItemParent=&quot; + cn.Id + &quot;&amp;rnd=&quot; + Guid.NewGuid());
                        }
                        treeElement.SetAttribute(&quot;icon&quot;, &quot;doc.gif&quot;);
                        treeElement.SetAttribute(&quot;openIcon&quot;, &quot;doc.gif&quot;);
                        treeElement.SetAttribute(&quot;nodeType&quot;, &quot;contentItem&quot;);
                        treeElement.SetAttribute(&quot;hasChildren&quot;, &quot;true&quot;);
                        root.AppendChild(treeElement);
                    }
                }
                else // list all members with selected first character.
                {
                    //if letters equals Others show members that not starts with a through z
                    if (letter.Equals(&quot;Others&quot;))
                    {
                        foreach (Member m in Member.getAllOtherMembers())
                        {
                            XmlElement treeElement = Tree.CreateElement(&quot;tree&quot;);

                            treeElement.SetAttribute(&quot;nodeID&quot;, m.LoginName);
                            treeElement.SetAttribute(&quot;text&quot;, m.Text);
                            treeElement.SetAttribute(&quot;action&quot;, &quot;javascript:openMember(&#39;&quot; + m.Id + &quot;&#39;);&quot;);
                            treeElement.SetAttribute(&quot;menu&quot;, &quot;D&quot;);
                            treeElement.SetAttribute(&quot;icon&quot;, string.IsNullOrEmpty(m.ContentType.IconUrl) ? &quot;member.gif&quot; : m.ContentType.IconUrl);
                            treeElement.SetAttribute(&quot;openIcon&quot;, string.IsNullOrEmpty(m.ContentType.IconUrl) ? &quot;member.gif&quot; : m.ContentType.IconUrl);
                            treeElement.SetAttribute(&quot;nodeType&quot;, &quot;member&quot;);
                            treeElement.SetAttribute(&quot;hasChildren&quot;, &quot;true&quot;);
                            root.AppendChild(treeElement);
                        }
                    }
                    else
                    {
                        if (provider.IsUmbracoMembershipProvider())
                        {
                            foreach (Member m in Member.getMemberFromFirstLetter(letter.ToCharArray()[0]))
                            {
                                XmlElement treeElement = Tree.CreateElement(&quot;tree&quot;);

                                treeElement.SetAttribute(&quot;nodeID&quot;, m.LoginName);
                                treeElement.SetAttribute(&quot;text&quot;, m.Text);
                                treeElement.SetAttribute(&quot;action&quot;, &quot;javascript:openMember(&#39;&quot; + m.Id + &quot;&#39;);&quot;);
                                treeElement.SetAttribute(&quot;menu&quot;, &quot;D&quot;);
                                treeElement.SetAttribute(&quot;icon&quot;, string.IsNullOrEmpty(m.ContentType.IconUrl) ? &quot;member.gif&quot; : m.ContentType.IconUrl);
                                treeElement.SetAttribute(&quot;openIcon&quot;, string.IsNullOrEmpty(m.ContentType.IconUrl) ? &quot;member.gif&quot; : m.ContentType.IconUrl);
                                treeElement.SetAttribute(&quot;nodeType&quot;, &quot;member&quot;);
                                treeElement.SetAttribute(&quot;hasChildren&quot;, &quot;true&quot;);
                                root.AppendChild(treeElement);
                            }
                        }
                        else
                        {
                            int total;
                            foreach (MembershipUser u in provider.FindUsersByName(letter + &quot;%&quot;, 0, 9999, out total))
                            {
                                XmlElement treeElement = Tree.CreateElement(&quot;tree&quot;);

                                treeElement.SetAttribute(&quot;nodeID&quot;, u.UserName);
                                treeElement.SetAttribute(&quot;text&quot;, u.UserName);
                                treeElement.SetAttribute(&quot;action&quot;, &quot;javascript:openMember(&#39;&quot; + HttpContext.Current.Server.UrlEncode(u.UserName) + &quot;&#39;);&quot;);
                                treeElement.SetAttribute(&quot;menu&quot;, &quot;D&quot;);
                                treeElement.SetAttribute(&quot;icon&quot;, &quot;member.gif&quot;);
                                treeElement.SetAttribute(&quot;openIcon&quot;, &quot;member.gif&quot;);
                                treeElement.SetAttribute(&quot;nodeType&quot;, &quot;member&quot;);
                                treeElement.SetAttribute(&quot;hasChildren&quot;, &quot;true&quot;);
                                root.AppendChild(treeElement);
                            }
                        }
                    }
                }
            }
            else
            {
                for (int i = 97; i &lt; 123; i++)
                {
                    XmlElement treeElement = Tree.CreateElement(&quot;tree&quot;);
                    treeElement.SetAttribute(&quot;menu&quot;, &quot;&quot;);
                    treeElement.SetAttribute(&quot;nodeID&quot;, i.ToString());
                    treeElement.SetAttribute(&quot;text&quot;, ((char)i).ToString());
                    treeElement.SetAttribute(&quot;action&quot;, &quot;javascript:viewMembers(&#39;&quot; + ((char)i).ToString() + &quot;&#39;);&quot;);

                    treeElement.SetAttribute(&quot;src&quot;, &quot;&quot;);

                    treeElement.SetAttribute(&quot;icon&quot;, FolderIcon);
                    treeElement.SetAttribute(&quot;openIcon&quot;, FolderIcon);
                    treeElement.SetAttribute(&quot;nodeType&quot;, &quot;member&quot;);
                    treeElement.SetAttribute(&quot;hasChildren&quot;, &quot;true&quot;);

                    treeElement.SetAttribute(&quot;src&quot;,
                        &quot;tree.aspx?letter=&quot; + ((char)i) + &quot;&amp;app=&quot; + m_app + &quot;&amp;treeType=&quot; +
                        HttpContext.Current.Request.QueryString[&quot;treeType&quot;] + &quot;&amp;rnd=&quot; + Guid.NewGuid());


                    root.AppendChild(treeElement);
                }

                //Add folder named &quot;Others&quot;, only supported by umbraco
                if (provider.IsUmbracoMembershipProvider())
                {
                    XmlElement treeElementOther = Tree.CreateElement(&quot;tree&quot;);
                    treeElementOther.SetAttribute(&quot;menu&quot;, &quot;&quot;);
                    treeElementOther.SetAttribute(&quot;nodeID&quot;, &quot;Others&quot;);
                    treeElementOther.SetAttribute(&quot;text&quot;, &quot;Others&quot;);
                    treeElementOther.SetAttribute(&quot;action&quot;, &quot;javascript:viewMembers(&#39;#&#39;);&quot;);
                    treeElementOther.SetAttribute(&quot;src&quot;, &quot;&quot;);
                    treeElementOther.SetAttribute(&quot;icon&quot;, FolderIcon);
                    treeElementOther.SetAttribute(&quot;openIcon&quot;, FolderIcon);
                    treeElementOther.SetAttribute(&quot;nodeType&quot;, &quot;member&quot;);
                    treeElementOther.SetAttribute(&quot;hasChildren&quot;, &quot;true&quot;);

                    treeElementOther.SetAttribute(&quot;src&quot;, &quot;tree.aspx?letter=Others&amp;app=&quot; + m_app + &quot;&amp;treeType=&quot; +
                        HttpContext.Current.Request.QueryString[&quot;treeType&quot;] + &quot;&amp;rnd=&quot; +
                        Guid.NewGuid());

                    root.AppendChild(treeElementOther);
                }

                // Search
                XmlElement treeElementSearch = Tree.CreateElement(&quot;tree&quot;);
                treeElementSearch.SetAttribute(&quot;menu&quot;, &quot;&quot;);
                treeElementSearch.SetAttribute(&quot;nodeID&quot;, &quot;Search&quot;);
                treeElementSearch.SetAttribute(&quot;text&quot;, ui.Text(&quot;search&quot;));
                treeElementSearch.SetAttribute(&quot;action&quot;, &quot;javascript:searchMembers();&quot;);
                treeElementSearch.SetAttribute(&quot;src&quot;, &quot;&quot;);
                treeElementSearch.SetAttribute(&quot;icon&quot;, FolderIcon);
                treeElementSearch.SetAttribute(&quot;openIcon&quot;, FolderIcon);
                treeElementSearch.SetAttribute(&quot;nodeType&quot;, &quot;member&quot;);


                root.AppendChild(treeElementSearch);

            }
        }
    }


}

    </pre>
    <script type="text/javascript">
      highlightRanges([[39,50,39,67,0],[39,68,39,69,0],[39,70,39,71,0],[42,9,42,10,0],[43,13,43,52,0],[44,13,44,38,0],[45,9,45,10,0],[52,9,52,10,0],[53,13,70,4,0],[71,9,71,10,0],[79,9,79,10,0],[80,13,80,50,0],[81,13,81,69,0],[82,13,82,30,0],[83,13,83,92,0],[85,4,85,11,0],[85,13,85,29,0],[85,30,85,32,0],[85,33,85,37,0],[86,5,86,36,0],[87,9,87,10,0],[94,9,94,10,0],[95,13,95,88,0],[97,13,97,32,0],[98,13,98,43,0],[99,13,99,91,0],[100,13,100,14,0],[101,17,101,80,0],[102,13,102,14,0],[103,13,103,102,0],[104,13,104,14,0],[105,17,105,102,0],[106,13,106,14,0],[109,13,109,49,0],[110,13,110,30,0],[111,13,111,14,0],[112,17,112,45,0],[113,17,113,18,0],[114,21,114,75,0],[115,21,115,61,0],[116,21,116,28,0],[116,30,116,40,0],[116,41,116,43,0],[116,44,116,50,0],[117,21,117,22,0],[118,25,118,77,0],[119,25,119,65,0],[120,25,120,78,0],[121,25,121,67,0],[123,25,123,106,0],[124,25,124,45,0],[125,25,125,26,0],[126,29,126,65,0],[127,25,127,26,0],[129,25,129,26,0],[130,29,132,145,0],[133,25,133,26,0],[134,25,134,69,0],[135,25,135,73,0],[136,25,136,77,0],[137,25,137,73,0],[138,25,138,55,0],[139,21,139,22,0],[140,17,140,18,0],[142,17,142,18,0],[144,21,144,49,0],[145,21,145,22,0],[146,25,146,32,0],[146,34,146,42,0],[146,43,146,45,0],[146,46,146,73,0],[147,25,147,26,0],[148,29,148,81,0],[150,29,150,77,0],[151,29,151,70,0],[152,29,152,106,0],[153,29,153,67,0],[154,29,154,146,0],[155,29,155,150,0],[156,29,156,76,0],[157,29,157,77,0],[158,29,158,59,0],[159,25,159,26,0],[160,21,160,22,0],[162,21,162,22,0],[163,25,163,68,0],[164,25,164,26,0],[165,29,165,36,0],[165,38,165,46,0],[165,47,165,49,0],[165,50,165,106,0],[166,29,166,30,0],[167,33,167,85,0],[169,33,169,81,0],[170,33,170,74,0],[171,33,171,110,0],[172,33,172,71,0],[173,33,173,150,0],[174,33,174,154,0],[175,33,175,80,0],[176,33,176,81,0],[177,33,177,63,0],[178,29,178,30,0],[179,25,179,26,0],[181,25,181,26,0],[183,29,183,36,0],[183,38,183,54,0],[183,55,183,57,0],[183,58,183,116,0],[184,29,184,30,0],[185,33,185,85,0],[187,33,187,80,0],[188,33,188,78,0],[189,33,189,154,0],[190,33,190,71,0],[191,33,191,80,0],[192,33,192,84,0],[193,33,193,80,0],[194,33,194,81,0],[195,33,195,63,0],[196,29,196,30,0],[197,25,197,26,0],[198,21,198,22,0],[199,17,199,18,0],[200,13,200,14,0],[202,13,202,14,0],[203,22,203,32,0],[203,34,203,41,0],[203,43,203,46,0],[204,17,204,18,0],[205,21,205,73,0],[206,21,206,58,0],[207,21,207,70,0],[208,21,208,76,0],[209,21,209,115,0],[211,21,211,57,0],[213,21,213,66,0],[214,21,214,70,0],[215,21,215,68,0],[216,21,216,69,0],[218,21,220,105,0],[223,21,223,51,0],[224,17,224,18,0],[227,17,227,60,0],[228,17,228,18,0],[229,21,229,78,0],[230,21,230,63,0],[231,21,231,71,0],[232,21,232,69,0],[233,21,233,93,0],[234,21,234,62,0],[235,21,235,71,0],[236,21,236,75,0],[237,21,237,73,0],[238,21,238,74,0],[240,21,242,41,0],[244,21,244,56,0],[245,17,245,18,0],[248,17,248,75,0],[249,17,249,60,0],[250,17,250,68,0],[251,17,251,75,0],[252,17,252,89,0],[253,17,253,59,0],[254,17,254,68,0],[255,17,255,72,0],[256,17,256,70,0],[259,17,259,53,0],[261,13,261,14,0],[262,9,262,10,0]]);
    </script>
  </body>
</html>