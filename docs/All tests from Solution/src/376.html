<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\MediaTypeRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;

using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class MediaTypeRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        private MediaTypeRepository CreateRepository(IDatabaseUnitOfWork unitOfWork)
        {
            return new MediaTypeRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax);            
        }

        private EntityContainerRepository CreateContainerRepository(IDatabaseUnitOfWork unitOfWork)
        {
            return new EntityContainerRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax, Constants.ObjectTypes.MediaTypeContainerGuid);
        }

        [Test]
        public void Can_Move()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            using (var repository = CreateRepository(unitOfWork))
            {
                var container1 = new EntityContainer(Constants.ObjectTypes.MediaTypeGuid) { Name = &quot;blah1&quot; };
                containerRepository.AddOrUpdate(container1);
                unitOfWork.Commit();

                var container2 = new EntityContainer(Constants.ObjectTypes.MediaTypeGuid) { Name = &quot;blah2&quot;, ParentId = container1.Id };
                containerRepository.AddOrUpdate(container2);
                unitOfWork.Commit();

                var contentType = (IMediaType)MockedContentTypes.CreateVideoMediaType();
                contentType.ParentId = container2.Id;
                repository.AddOrUpdate(contentType);
                unitOfWork.Commit();

                //create a 
                var contentType2 = (IMediaType)new MediaType(contentType, &quot;hello&quot;)
                {
                    Name = &quot;Blahasdfsadf&quot;
                };
                contentType.ParentId = contentType.Id;
                repository.AddOrUpdate(contentType2);
                unitOfWork.Commit();

                var result = repository.Move(contentType, container1).ToArray();
                unitOfWork.Commit();

                Assert.AreEqual(2, result.Count());

                //re-get
                contentType = repository.Get(contentType.Id);
                contentType2 = repository.Get(contentType2.Id);

                Assert.AreEqual(container1.Id, contentType.ParentId);
                Assert.AreNotEqual(result.Single(x =&gt; x.Entity.Id == contentType.Id).OriginalPath, contentType.Path);
                Assert.AreNotEqual(result.Single(x =&gt; x.Entity.Id == contentType2.Id).OriginalPath, contentType2.Path);
            }
            
        }

        [Test]
        public void Can_Create_Container()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            EntityContainer container;
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            {
                container = new EntityContainer(Constants.ObjectTypes.MediaTypeGuid) { Name = &quot;blah&quot; };
                containerRepository.AddOrUpdate(container);
                unitOfWork.Commit();
                Assert.That(container.Id, Is.GreaterThan(0));
            }
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            {
                var found = containerRepository.Get(container.Id);
                Assert.IsNotNull(found);
            }
        }

        [Test]
        public void Can_Delete_Container()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            EntityContainer container;
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            {
                container = new EntityContainer(Constants.ObjectTypes.MediaTypeGuid) { Name = &quot;blah&quot; };
                containerRepository.AddOrUpdate(container);
                unitOfWork.Commit();
                Assert.That(container.Id, Is.GreaterThan(0));
            }
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            {
                // Act
                containerRepository.Delete(container);
                unitOfWork.Commit();
            }
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            {
                var found = containerRepository.Get(container.Id);
                Assert.IsNull(found);
            }
        }

        [Test]
        public void Can_Create_Container_Containing_Media_Types()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            using (var repository = CreateRepository(unitOfWork))
            {
                var container = new EntityContainer(Constants.ObjectTypes.MediaTypeGuid) { Name = &quot;blah&quot; };
                containerRepository.AddOrUpdate(container);
                unitOfWork.Commit();

                var contentType = MockedContentTypes.CreateVideoMediaType();
                contentType.ParentId = container.Id;
                repository.AddOrUpdate(contentType);
                unitOfWork.Commit();

                Assert.AreEqual(container.Id, contentType.ParentId);
            }
        }

        [Test]
        public void Can_Delete_Container_Containing_Media_Types()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            EntityContainer container;
            IMediaType contentType;
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            using (var repository = CreateRepository(unitOfWork))
            {
                container = new EntityContainer(Constants.ObjectTypes.MediaTypeGuid) { Name = &quot;blah&quot; };
                containerRepository.AddOrUpdate(container);
                unitOfWork.Commit();

                contentType = MockedContentTypes.CreateVideoMediaType();
                contentType.ParentId = container.Id;
                repository.AddOrUpdate(contentType);
                unitOfWork.Commit();
            }
            using (var containerRepository = CreateContainerRepository(unitOfWork))
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                containerRepository.Delete(container);
                unitOfWork.Commit();

                var found = containerRepository.Get(container.Id);
                Assert.IsNull(found);

                contentType = repository.Get(contentType.Id);
                Assert.IsNotNull(contentType);
                Assert.AreEqual(-1, contentType.ParentId);
            }
        }

        [Test]
        public void Can_Perform_Add_On_MediaTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var contentType = MockedContentTypes.CreateVideoMediaType();
                repository.AddOrUpdate(contentType);
                unitOfWork.Commit();

                var fetched = repository.Get(contentType.Id);

                // Assert
                Assert.That(contentType.HasIdentity, Is.True);
                Assert.That(contentType.PropertyGroups.All(x =&gt; x.HasIdentity), Is.True);
                Assert.That(contentType.Path.Contains(&quot;,&quot;), Is.True);
                Assert.That(contentType.SortOrder, Is.GreaterThan(0));

                TestHelper.AssertAllPropertyValuesAreEquals(contentType, fetched, &quot;yyyy-MM-dd HH:mm:ss&quot;, ignoreProperties: new[] { &quot;UpdateDate&quot; });
            }

            
        }

        [Test]
        public void Can_Perform_Update_On_MediaTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var videoMediaType = MockedContentTypes.CreateVideoMediaType();
                repository.AddOrUpdate(videoMediaType);
                unitOfWork.Commit();

                // Act
                var mediaType = repository.Get(NodeDto.NodeIdSeed);

                mediaType.Thumbnail = &quot;Doc2.png&quot;;
                mediaType.PropertyGroups[&quot;Media&quot;].PropertyTypes.Add(new PropertyType(&quot;test&quot;, DataTypeDatabaseType.Ntext, &quot;subtitle&quot;)
                    {
                        Name = &quot;Subtitle&quot;,
                        Description = &quot;Optional Subtitle&quot;,
                        Mandatory = false,
                        SortOrder = 1,
                        DataTypeDefinitionId = -88
                    });
                repository.AddOrUpdate(mediaType);
                unitOfWork.Commit();

                var dirty = ((MediaType) mediaType).IsDirty();

                // Assert
                Assert.That(mediaType.HasIdentity, Is.True);
                Assert.That(dirty, Is.False);
                Assert.That(mediaType.Thumbnail, Is.EqualTo(&quot;Doc2.png&quot;));
                Assert.That(mediaType.PropertyTypes.Any(x =&gt; x.Alias == &quot;subtitle&quot;), Is.True);
            }
        }

        [Test]
        public void Can_Perform_Delete_On_MediaTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var mediaType = MockedContentTypes.CreateVideoMediaType();
                repository.AddOrUpdate(mediaType);
                unitOfWork.Commit();

                var contentType2 = repository.Get(mediaType.Id);
                repository.Delete(contentType2);
                unitOfWork.Commit();

                var exists = repository.Exists(mediaType.Id);

                // Assert
                Assert.That(exists, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Get_On_MediaTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var mediaType = repository.Get(1033); //File

                // Assert
                Assert.That(mediaType, Is.Not.Null);
                Assert.That(mediaType.Id, Is.EqualTo(1033));
                Assert.That(mediaType.Name, Is.EqualTo(Constants.Conventions.MediaTypes.File));
            }
        }

        [Test]
        public void Can_Perform_Get_By_Guid_On_MediaTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var mediaType = repository.Get(1033); //File

                // Act
                mediaType = repository.Get(mediaType.Key); 

                // Assert
                Assert.That(mediaType, Is.Not.Null);
                Assert.That(mediaType.Id, Is.EqualTo(1033));
                Assert.That(mediaType.Name, Is.EqualTo(Constants.Conventions.MediaTypes.File));
            }
        }

        [Test]
        public void Can_Perform_GetAll_On_MediaTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var mediaTypes = repository.GetAll();
                int count =
                    DatabaseContext.Database.ExecuteScalar&lt;int&gt;(
                        &quot;SELECT COUNT(*) FROM umbracoNode WHERE nodeObjectType = @NodeObjectType&quot;,
                        new {NodeObjectType = new Guid(Constants.ObjectTypes.MediaType)});

                // Assert
                Assert.That(mediaTypes.Any(), Is.True);
                Assert.That(mediaTypes.Count(), Is.EqualTo(count));
            }
        }

        [Test]
        public void Can_Perform_GetAll_By_Guid_On_MediaTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var allGuidIds = repository.GetAll().Select(x =&gt; x.Key).ToArray();

                // Act

                var mediaTypes = ((IReadRepository&lt;Guid, IMediaType&gt;)repository).GetAll(allGuidIds);

                int count =
                    DatabaseContext.Database.ExecuteScalar&lt;int&gt;(
                        &quot;SELECT COUNT(*) FROM umbracoNode WHERE nodeObjectType = @NodeObjectType&quot;,
                        new { NodeObjectType = new Guid(Constants.ObjectTypes.MediaType) });

                // Assert
                Assert.That(mediaTypes.Any(), Is.True);
                Assert.That(mediaTypes.Count(), Is.EqualTo(count));
            }
        }

        [Test]
        public void Can_Perform_Exists_On_MediaTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var exists = repository.Exists(1032); //Image

                // Assert
                Assert.That(exists, Is.True);
            }
        }

        [Test]
        public void Can_Update_MediaType_With_PropertyType_Removed()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var mediaType = MockedContentTypes.CreateVideoMediaType();
                repository.AddOrUpdate(mediaType);
                unitOfWork.Commit();

                // Act
                var mediaTypeV2 = repository.Get(NodeDto.NodeIdSeed);
                mediaTypeV2.PropertyGroups[&quot;Media&quot;].PropertyTypes.Remove(&quot;title&quot;);
                repository.AddOrUpdate(mediaTypeV2);
                unitOfWork.Commit();

                var mediaTypeV3 = repository.Get(NodeDto.NodeIdSeed);

                // Assert
                Assert.That(mediaTypeV3.PropertyTypes.Any(x =&gt; x.Alias == &quot;title&quot;), Is.False);
                Assert.That(mediaTypeV2.PropertyGroups.Count, Is.EqualTo(mediaTypeV3.PropertyGroups.Count));
                Assert.That(mediaTypeV2.PropertyTypes.Count(), Is.EqualTo(mediaTypeV3.PropertyTypes.Count()));
            }
        }

        [Test]
        public void Can_Verify_PropertyTypes_On_Video_MediaType()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var mediaType = MockedContentTypes.CreateVideoMediaType();
                repository.AddOrUpdate(mediaType);
                unitOfWork.Commit();

                // Act
                var contentType = repository.Get(NodeDto.NodeIdSeed);

                // Assert
                Assert.That(contentType.PropertyTypes.Count(), Is.EqualTo(2));
                Assert.That(contentType.PropertyGroups.Count(), Is.EqualTo(1));
            }
        }

        [Test]
        public void Can_Verify_PropertyTypes_On_File_MediaType()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var contentType = repository.Get(1033); //File

                // Assert
                Assert.That(contentType.PropertyTypes.Count(), Is.EqualTo(3));
                Assert.That(contentType.PropertyGroups.Count(), Is.EqualTo(1));
            }
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,1],[26,13,26,31,1],[27,9,27,10,1],[30,9,30,10,1],[31,13,31,128,1],[32,9,32,10,1],[35,9,35,10,1],[36,13,36,180,1],[37,9,37,10,1],[41,9,41,10,1],[42,13,42,67,1],[43,13,43,55,1],[44,20,44,83,1],[45,20,45,65,1],[46,13,46,14,1],[47,17,47,110,1],[48,17,48,61,1],[49,17,49,37,1],[51,17,51,136,1],[52,17,52,61,1],[53,17,53,37,1],[55,17,55,89,1],[56,17,56,54,1],[57,17,57,53,1],[58,17,58,37,1],[61,17,64,19,1],[65,17,65,55,1],[66,17,66,54,1],[67,17,67,37,1],[69,17,69,81,1],[70,17,70,37,1],[72,17,72,52,1],[75,17,75,62,1],[76,17,76,64,1],[78,17,78,70,1],[79,17,79,55,1],[79,55,79,84,1],[79,84,79,118,1],[79,17,79,118,1],[80,17,80,55,1],[80,55,80,85,1],[80,85,80,120,1],[80,17,80,120,1],[81,13,81,14,1],[83,9,83,10,1],[87,9,87,10,1],[88,13,88,67,1],[89,13,89,55,1],[91,20,91,83,1],[92,13,92,14,1],[93,17,93,104,1],[94,17,94,60,1],[95,17,95,37,1],[96,17,96,62,1],[97,13,97,14,1],[98,20,98,83,1],[99,13,99,14,1],[100,17,100,67,1],[101,17,101,41,1],[102,13,102,14,1],[103,9,103,10,1],[107,9,107,10,1],[108,13,108,67,1],[109,13,109,55,1],[111,20,111,83,1],[112,13,112,14,1],[113,17,113,104,1],[114,17,114,60,1],[115,17,115,37,1],[116,17,116,62,1],[117,13,117,14,1],[118,20,118,83,1],[119,13,119,14,1],[121,17,121,55,1],[122,17,122,37,1],[123,13,123,14,1],[124,20,124,83,1],[125,13,125,14,1],[126,17,126,67,1],[127,17,127,38,1],[128,13,128,14,1],[129,9,129,10,1],[133,9,133,10,1],[134,13,134,67,1],[135,13,135,55,1],[136,20,136,83,1],[137,20,137,65,1],[138,13,138,14,1],[139,17,139,108,1],[140,17,140,60,1],[141,17,141,37,1],[143,17,143,77,1],[144,17,144,53,1],[145,17,145,53,1],[146,17,146,37,1],[148,17,148,69,1],[149,13,149,14,1],[150,9,150,10,1],[154,9,154,10,1],[155,13,155,67,1],[156,13,156,55,1],[159,20,159,83,1],[160,20,160,65,1],[161,13,161,14,1],[162,17,162,104,1],[163,17,163,60,1],[164,17,164,37,1],[166,17,166,73,1],[167,17,167,53,1],[168,17,168,53,1],[169,17,169,37,1],[170,13,170,14,1],[171,20,171,83,1],[172,20,172,65,1],[173,13,173,14,1],[175,17,175,55,1],[176,17,176,37,1],[178,17,178,67,1],[179,17,179,38,1],[181,17,181,62,1],[182,17,182,47,1],[183,17,183,59,1],[184,13,184,14,1],[185,9,185,10,1],[189,9,189,10,1],[191,13,191,67,1],[192,13,192,55,1],[193,20,193,65,1],[194,13,194,14,1],[196,17,196,77,1],[197,17,197,53,1],[198,17,198,37,1],[200,17,200,62,1],[203,17,203,63,1],[204,17,204,65,1],[204,65,204,78,1],[204,78,204,90,1],[204,17,204,90,1],[205,17,205,70,1],[206,17,206,71,1],[208,17,208,148,1],[209,13,209,14,1],[212,9,212,10,1],[216,9,216,10,1],[218,13,218,67,1],[219,13,219,55,1],[220,20,220,65,1],[221,13,221,14,1],[222,17,222,80,1],[223,17,223,56,1],[224,17,224,37,1],[227,17,227,68,1],[229,17,229,50,1],[230,17,237,24,1],[238,17,238,51,1],[239,17,239,37,1],[241,17,241,63,1],[244,17,244,61,1],[245,17,245,46,1],[246,17,246,74,1],[247,17,247,62,1],[247,62,247,83,1],[247,83,247,95,1],[247,17,247,95,1],[248,13,248,14,1],[249,9,249,10,1],[253,9,253,10,1],[255,13,255,67,1],[256,13,256,55,1],[257,20,257,65,1],[258,13,258,14,1],[261,17,261,75,1],[262,17,262,51,1],[263,17,263,37,1],[265,17,265,65,1],[266,17,266,49,1],[267,17,267,37,1],[269,17,269,62,1],[272,17,272,47,1],[273,13,273,14,1],[274,9,274,10,1],[278,9,278,10,1],[280,13,280,67,1],[281,13,281,55,1],[282,20,282,65,1],[283,13,283,14,1],[286,17,286,54,1],[289,17,289,53,1],[290,17,290,61,1],[291,17,291,96,1],[292,13,292,14,1],[293,9,293,10,1],[297,9,297,10,1],[299,13,299,67,1],[300,13,300,55,1],[301,20,301,65,1],[302,13,302,14,1],[303,17,303,54,1],[306,17,306,59,1],[309,17,309,53,1],[310,17,310,61,1],[311,17,311,96,1],[312,13,312,14,1],[313,9,313,10,1],[317,9,317,10,1],[319,13,319,67,1],[320,13,320,55,1],[321,20,321,65,1],[322,13,322,14,1],[324,17,324,54,1],[325,17,328,91,1],[331,17,331,56,1],[332,17,332,68,1],[333,13,333,14,1],[334,9,334,10,1],[338,9,338,10,1],[340,13,340,67,1],[341,13,341,55,1],[342,20,342,65,1],[343,13,343,14,1],[344,17,344,66,1],[344,66,344,71,1],[344,71,344,83,1],[344,17,344,83,1],[348,17,348,101,1],[350,17,353,93,1],[356,17,356,56,1],[357,17,357,68,1],[358,13,358,14,1],[359,9,359,10,1],[363,9,363,10,1],[365,13,365,67,1],[366,13,366,55,1],[367,20,367,65,1],[368,13,368,14,1],[371,17,371,54,1],[374,17,374,46,1],[375,13,375,14,1],[376,9,376,10,1],[380,9,380,10,1],[382,13,382,67,1],[383,13,383,55,1],[384,20,384,65,1],[385,13,385,14,1],[386,17,386,75,1],[387,17,387,51,1],[388,17,388,37,1],[391,17,391,70,1],[392,17,392,83,1],[393,17,393,53,1],[394,17,394,37,1],[396,17,396,70,1],[399,17,399,64,1],[399,64,399,82,1],[399,82,399,95,1],[399,17,399,95,1],[400,17,400,109,1],[401,17,401,111,1],[402,13,402,14,1],[403,9,403,10,1],[407,9,407,10,1],[409,13,409,67,1],[410,13,410,55,1],[411,20,411,65,1],[412,13,412,14,1],[413,17,413,75,1],[414,17,414,51,1],[415,17,415,37,1],[418,17,418,70,1],[421,17,421,79,1],[422,17,422,80,1],[423,13,423,14,1],[424,9,424,10,1],[428,9,428,10,1],[430,13,430,67,1],[431,13,431,55,1],[432,20,432,65,1],[433,13,433,14,1],[436,17,436,56,1],[439,17,439,79,1],[440,17,440,80,1],[441,13,441,14,1],[442,9,442,10,1],[446,9,446,10,1],[447,13,447,29,1],[448,9,448,10,1]]);
    </script>
  </body>
</html>