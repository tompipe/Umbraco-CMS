<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\users\EditUser.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Configuration.Provider;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Xml;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Security;
using Umbraco.Web;
using Umbraco.Web.Models;
using Umbraco.Web.Security;
using umbraco.BasePages;
using umbraco.BusinessLogic;
using umbraco.businesslogic.Exceptions;
using umbraco.cms.businesslogic.media;
using umbraco.cms.businesslogic.web;
using umbraco.controls;
using umbraco.presentation.channels.businesslogic;
using umbraco.uicontrols;
using umbraco.providers;
using umbraco.cms.presentation.Trees;
using Umbraco.Core.IO;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using PropertyType = umbraco.cms.businesslogic.propertytype.PropertyType;
using System.Text.RegularExpressions;
using System.Text;

namespace umbraco.cms.presentation.user
{
    /// &lt;summary&gt;
    /// Summary description for EditUser.
    /// &lt;/summary&gt;
    public partial class EditUser : UmbracoEnsuredPage
    {
        public EditUser()
        {
            CurrentApp = DefaultApps.users.ToString();
        }
        protected HtmlTable macroProperties;
        protected TextBox uname = new TextBox() { ID = &quot;uname&quot; };
        protected RequiredFieldValidator unameValidator = new RequiredFieldValidator();
        protected TextBox lname = new TextBox() { ID = &quot;lname&quot; };
        protected RequiredFieldValidator lnameValidator = new RequiredFieldValidator();
        protected CustomValidator lnameCustomValidator = new CustomValidator();
        protected PlaceHolder passw = new PlaceHolder();
        protected CheckBoxList lapps = new CheckBoxList();
        protected TextBox email = new TextBox() { ID = &quot;email&quot; };
        protected RequiredFieldValidator emailValidator = new RequiredFieldValidator();
        protected CustomValidator emailCustomValidator = new CustomValidator();
        protected DropDownList userType = new DropDownList();
        protected DropDownList userLanguage = new DropDownList();
        protected CheckBox NoConsole = new CheckBox();
        protected CheckBox Disabled = new CheckBox();

        protected ContentPicker mediaPicker = new ContentPicker();
        protected ContentPicker contentPicker = new ContentPicker();

        protected TextBox cName = new TextBox();
        protected CheckBox cFulltree = new CheckBox();
        protected DropDownList cDocumentType = new DropDownList();
        protected DropDownList cDescription = new DropDownList();
        protected DropDownList cCategories = new DropDownList();
        protected DropDownList cExcerpt = new DropDownList();
        protected ContentPicker cMediaPicker = new ContentPicker();
        protected ContentPicker cContentPicker = new ContentPicker();
        protected CustomValidator sectionValidator = new CustomValidator();

        protected Pane pp = new Pane();

        private User u;

        private MembershipHelper _membershipHelper;

        private MembershipProvider BackOfficeProvider
        {
            get { return global::Umbraco.Core.Security.MembershipProviderExtensions.GetUsersMembershipProvider(); }
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            _membershipHelper = new MembershipHelper(UmbracoContext.Current);
            int UID = int.Parse(Request.QueryString[&quot;id&quot;]);
            u = BusinessLogic.User.GetUser(UID);

            //the true admin can only edit the true admin
            if (u.Id == 0 &amp;&amp; CurrentUser.Id != 0)
            {
                throw new Exception(&quot;Only the root user can edit the &#39;root&#39; user (id:0)&quot;);
            }

            //only another admin can edit another admin (who is not the true admin)
            if (u.IsAdmin() &amp;&amp; CurrentUser.IsAdmin() == false)
            {
                throw new Exception(&quot;Admin users can only be edited by admins&quot;);
            }

            // Populate usertype list
            foreach (UserType ut in UserType.getAll)
            {
                if (CurrentUser.IsAdmin() || ut.Alias != &quot;admin&quot;)
                {
                    ListItem li = new ListItem(ui.Text(&quot;user&quot;, ut.Name.ToLower(), UmbracoUser), ut.Id.ToString());
                    if (ut.Id == u.UserType.Id)
                        li.Selected = true;

                    userType.Items.Add(li);
                }
            }
            
            var userCulture = UserExtensions.GetUserCulture(u.Language, Services.TextService);

            // Populate ui language lsit
            foreach (var lang in Services.TextService.GetSupportedCultures())
            {
                var regionCode = Services.TextService.ConvertToRegionCodeFromSupportedCulture(lang);
                
                var li = new ListItem(lang.DisplayName, regionCode);

                if (Equals(lang, userCulture))
                    li.Selected = true;

                userLanguage.Items.Add(li);
            }

            // Console access and disabling
            NoConsole.Checked = u.NoConsole;
            Disabled.Checked = u.Disabled;

            PlaceHolder medias = new PlaceHolder();
            mediaPicker.AppAlias = Constants.Applications.Media;
            mediaPicker.TreeAlias = &quot;media&quot;;

            if (u.StartMediaId &gt; 0)
                mediaPicker.Value = u.StartMediaId.ToString();
            else
                mediaPicker.Value = &quot;-1&quot;;

            medias.Controls.Add(mediaPicker);

            PlaceHolder content = new PlaceHolder();
            contentPicker.AppAlias = Constants.Applications.Content;
            contentPicker.TreeAlias = &quot;content&quot;;

            if (u.StartNodeId &gt; 0)
                contentPicker.Value = u.StartNodeId.ToString();
            else
                contentPicker.Value = &quot;-1&quot;;

            content.Controls.Add(contentPicker);
            
            // Add password changer
            var passwordChanger = (passwordChanger)LoadControl(SystemDirectories.Umbraco + &quot;/controls/passwordChanger.ascx&quot;);
            passwordChanger.MembershipProviderName = UmbracoSettings.DefaultBackofficeProvider;

            //Add a custom validation message for the password changer
            var passwordValidation = new CustomValidator
            {
                ID = &quot;PasswordChangerValidator&quot;
            };
            var validatorContainer = new HtmlGenericControl(&quot;div&quot;)
            {
                Visible = false,
                EnableViewState = false
            };
            validatorContainer.Attributes[&quot;class&quot;] = &quot;alert alert-error&quot;;
            validatorContainer.Style.Add(HtmlTextWriterStyle.MarginTop, &quot;10px&quot;);
            validatorContainer.Style.Add(HtmlTextWriterStyle.Width, &quot;300px&quot;);
            var validatorContainer2 = new HtmlGenericControl(&quot;p&quot;);
            validatorContainer.Controls.Add(validatorContainer2);
            validatorContainer2.Controls.Add(passwordValidation);
            passw.Controls.Add(passwordChanger);
            passw.Controls.Add(validatorContainer);

            var validationSummary = new ValidationSummary
            {
                ID = &quot;validationSummary&quot;,
                DisplayMode = ValidationSummaryDisplayMode.BulletList,
                CssClass = &quot;error&quot;
            };

            pp.addProperty(validationSummary);

            pp.addProperty(ui.Text(&quot;user&quot;, &quot;username&quot;, UmbracoUser), uname, unameValidator);
            pp.addProperty(ui.Text(&quot;user&quot;, &quot;loginname&quot;, UmbracoUser), lname, lnameValidator, lnameCustomValidator);
            pp.addProperty(ui.Text(&quot;user&quot;, &quot;password&quot;, UmbracoUser), passw);

            pp.addProperty(ui.Text(&quot;general&quot;, &quot;email&quot;, UmbracoUser), email, emailValidator, emailCustomValidator);
            pp.addProperty(ui.Text(&quot;user&quot;, &quot;usertype&quot;, UmbracoUser), userType);
            pp.addProperty(ui.Text(&quot;user&quot;, &quot;language&quot;, UmbracoUser), userLanguage);

            //Media  / content root nodes
            Pane ppNodes = new Pane();
            ppNodes.addProperty(ui.Text(&quot;user&quot;, &quot;startnode&quot;, UmbracoUser), content);
            ppNodes.addProperty(ui.Text(&quot;user&quot;, &quot;mediastartnode&quot;, UmbracoUser), medias);

            //Generel umrbaco access
            Pane ppAccess = new Pane();
            ppAccess.addProperty(ui.Text(&quot;user&quot;, &quot;noConsole&quot;, UmbracoUser), NoConsole);
            ppAccess.addProperty(ui.Text(&quot;user&quot;, &quot;disabled&quot;, UmbracoUser), Disabled);

            //access to which modules... 
            Pane ppModules = new Pane();
            ppModules.addProperty(ui.Text(&quot;user&quot;, &quot;modules&quot;, UmbracoUser), lapps);
            ppModules.addProperty(&quot; &quot;, sectionValidator);

            TabPage userInfo = UserTabs.NewTabPage(u.Name);

            userInfo.Controls.Add(pp);

            userInfo.Controls.Add(ppAccess);
            userInfo.Controls.Add(ppNodes);

            userInfo.Controls.Add(ppModules);

            userInfo.HasMenu = true;

            var save = userInfo.Menu.NewButton();
            save.Click += SaveUser_Click;
            save.ID = &quot;save&quot;;
            save.ToolTip = ui.Text(&quot;save&quot;);
            save.Text = ui.Text(&quot;save&quot;);
            save.ButtonType = MenuButtonType.Primary;

            sectionValidator.ServerValidate += SectionValidator_OnServerValidate;
            sectionValidator.ControlToValidate = lapps.ID;
            sectionValidator.ErrorMessage = ui.Text(&quot;errorHandling&quot;, &quot;errorMandatoryWithoutTab&quot;, ui.Text(&quot;user&quot;, &quot;modules&quot;, UmbracoUser), UmbracoUser);
            sectionValidator.CssClass = &quot;error&quot;;
            sectionValidator.Style.Add(&quot;color&quot;, &quot;red&quot;);

            unameValidator.ControlToValidate = uname.ID;
            unameValidator.Display = ValidatorDisplay.Dynamic;
            unameValidator.ErrorMessage = ui.Text(&quot;defaultdialogs&quot;, &quot;requiredField&quot;, UmbracoUser);
            unameValidator.CssClass = &quot;error&quot;;
            unameValidator.Style.Add(&quot;color&quot;, &quot;red&quot;);
            unameValidator.Style.Add(&quot;margin-left&quot;, &quot;5px&quot;);
            unameValidator.Style.Add(&quot;line-height&quot;, &quot;28px&quot;);

            lnameValidator.ControlToValidate = lname.ID;
            lnameValidator.Display = ValidatorDisplay.Dynamic;
            lnameValidator.ErrorMessage = ui.Text(&quot;defaultdialogs&quot;, &quot;requiredField&quot;, UmbracoUser);
            lnameValidator.CssClass = &quot;error&quot;;
            lnameValidator.Style.Add(&quot;color&quot;, &quot;red&quot;);
            lnameValidator.Style.Add(&quot;margin-left&quot;, &quot;5px&quot;);
            lnameValidator.Style.Add(&quot;line-height&quot;, &quot;28px&quot;);

            lnameCustomValidator.ServerValidate += LnameCustomValidator_OnServerValidate;
            lnameCustomValidator.Display = ValidatorDisplay.Dynamic;
            lnameCustomValidator.ControlToValidate = lname.ID;
            var localizedLname = ui.Text(&quot;user&quot;, &quot;loginname&quot;, UmbracoUser);
            lnameCustomValidator.ErrorMessage = ui.Text(&quot;errorHandling&quot;, &quot;errorExistsWithoutTab&quot;, localizedLname, UmbracoUser);
            lnameCustomValidator.CssClass = &quot;error&quot;;
            lnameCustomValidator.Style.Add(&quot;color&quot;, &quot;red&quot;);
            lnameCustomValidator.Style.Add(&quot;margin-left&quot;, &quot;5px&quot;);
            lnameCustomValidator.Style.Add(&quot;line-height&quot;, &quot;28px&quot;);

            emailValidator.ControlToValidate = email.ID;
            emailValidator.Display = ValidatorDisplay.Dynamic;
            emailValidator.ErrorMessage = ui.Text(&quot;defaultdialogs&quot;, &quot;requiredField&quot;, UmbracoUser);
            emailValidator.CssClass = &quot;error&quot;;
            emailValidator.Style.Add(&quot;color&quot;, &quot;red&quot;);
            emailValidator.Style.Add(&quot;margin-left&quot;, &quot;5px&quot;);
            emailValidator.Style.Add(&quot;line-height&quot;, &quot;28px&quot;);

            emailCustomValidator.ServerValidate += EmailCustomValidator_OnServerValidate;
            emailCustomValidator.Display = ValidatorDisplay.Dynamic;
            emailCustomValidator.ControlToValidate = email.ID;
            var localizedEmail = ui.Text(&quot;general&quot;, &quot;email&quot;, UmbracoUser);
            emailCustomValidator.ErrorMessage = ui.Text(&quot;errorHandling&quot;, &quot;errorRegExpWithoutTab&quot;, localizedEmail, UmbracoUser);
            emailCustomValidator.CssClass = &quot;error&quot;;
            emailCustomValidator.Style.Add(&quot;color&quot;, &quot;red&quot;);
            emailCustomValidator.Style.Add(&quot;margin-left&quot;, &quot;5px&quot;);
            emailCustomValidator.Style.Add(&quot;line-height&quot;, &quot;28px&quot;);

            SetupForm();
            SetupChannel();

            ClientTools
                .SetActiveTreeType(TreeDefinitionCollection.Instance.FindTree&lt;loadUsers&gt;().Tree.Alias)
                .SyncTree(UID.ToString(), IsPostBack);
        }

        private void LnameCustomValidator_OnServerValidate(object source, ServerValidateEventArgs args)
        {
            var usersWithLoginName = ApplicationContext.Services.UserService.GetByUsername(lname.Text);
            args.IsValid = usersWithLoginName == null || usersWithLoginName.Id == u.Id;
        }

        private void EmailCustomValidator_OnServerValidate(object source, ServerValidateEventArgs args)
        {
            args.IsValid = MembershipProviderBase.IsEmailValid(email.Text.Trim());
        }

        private void SectionValidator_OnServerValidate(object source, ServerValidateEventArgs args)
        {
            args.IsValid = false;

            if (lapps.SelectedIndex &gt;= 0)
                args.IsValid = true;
        }

        private void SetupChannel()
        {
            Channel userChannel;
            try
            {
                userChannel =
                    new Channel(u.Id);
            }
            catch
            {
                userChannel = new Channel();
            }

            // Populate dropdowns
            var allContentTypes = Services.ContentTypeService.GetAllContentTypes().ToList();
            foreach (var dt in allContentTypes)
            {
                cDocumentType.Items.Add(new ListItem(dt.Name, dt.Alias));
            }

            // populate fields
            var fields = new ArrayList();
            cDescription.ID = &quot;cDescription&quot;;
            cCategories.ID = &quot;cCategories&quot;;
            cExcerpt.ID = &quot;cExcerpt&quot;;
            cDescription.Items.Add(new ListItem(ui.Text(&quot;choose&quot;), &quot;&quot;));
            cCategories.Items.Add(new ListItem(ui.Text(&quot;choose&quot;), &quot;&quot;));
            cExcerpt.Items.Add(new ListItem(ui.Text(&quot;choose&quot;), &quot;&quot;));

            foreach (var pt in allContentTypes.SelectMany(x =&gt; x.PropertyTypes).OrderBy(x =&gt; x.Name))
            {
                if (fields.Contains(pt.Alias) == false)
                {
                    cDescription.Items.Add(new ListItem(string.Format(&quot;{0} ({1})&quot;, pt.Name, pt.Alias), pt.Alias));
                    cCategories.Items.Add(new ListItem(string.Format(&quot;{0} ({1})&quot;, pt.Name, pt.Alias), pt.Alias));
                    cExcerpt.Items.Add(new ListItem(string.Format(&quot;{0} ({1})&quot;, pt.Name, pt.Alias), pt.Alias));
                    fields.Add(pt.Alias);
                }
            }

            // Handle content and media pickers

            PlaceHolder medias = new PlaceHolder();
            cMediaPicker.AppAlias = Constants.Applications.Media;
            cMediaPicker.TreeAlias = &quot;media&quot;;

            if (userChannel.MediaFolder &gt; 0)
                cMediaPicker.Value = userChannel.MediaFolder.ToString();
            else
                cMediaPicker.Value = &quot;-1&quot;;

            medias.Controls.Add(cMediaPicker);

            PlaceHolder content = new PlaceHolder();
            cContentPicker.AppAlias = Constants.Applications.Content;
            cContentPicker.TreeAlias = &quot;content&quot;;

            if (userChannel.StartNode &gt; 0)
                cContentPicker.Value = userChannel.StartNode.ToString();
            else
                cContentPicker.Value = &quot;-1&quot;;

            content.Controls.Add(cContentPicker);


            // Setup the panes
            Pane ppInfo = new Pane();
            ppInfo.addProperty(ui.Text(&quot;name&quot;, UmbracoUser), cName);
            ppInfo.addProperty(ui.Text(&quot;user&quot;, &quot;startnode&quot;, UmbracoUser), content);
            ppInfo.addProperty(ui.Text(&quot;user&quot;, &quot;searchAllChildren&quot;, UmbracoUser), cFulltree);
            ppInfo.addProperty(ui.Text(&quot;user&quot;, &quot;mediastartnode&quot;, UmbracoUser), medias);

            Pane ppFields = new Pane();
            ppFields.addProperty(ui.Text(&quot;user&quot;, &quot;documentType&quot;, UmbracoUser), cDocumentType);
            ppFields.addProperty(ui.Text(&quot;user&quot;, &quot;descriptionField&quot;, UmbracoUser), cDescription);
            ppFields.addProperty(ui.Text(&quot;user&quot;, &quot;categoryField&quot;, UmbracoUser), cCategories);
            ppFields.addProperty(ui.Text(&quot;user&quot;, &quot;excerptField&quot;, UmbracoUser), cExcerpt);


            TabPage channelInfo = UserTabs.NewTabPage(ui.Text(&quot;user&quot;, &quot;contentChannel&quot;, UmbracoUser));

            channelInfo.Controls.Add(ppInfo);
            channelInfo.Controls.Add(ppFields);


            if (!IsPostBack)
            {
                cName.Text = userChannel.Name;
                cDescription.SelectedValue = userChannel.FieldDescriptionAlias;
                cCategories.SelectedValue = userChannel.FieldCategoriesAlias;
                cExcerpt.SelectedValue = userChannel.FieldExcerptAlias;
                cDocumentType.SelectedValue = userChannel.DocumentTypeAlias;
                cFulltree.Checked = userChannel.FullTree;
            }
        }

        /// &lt;summary&gt;
        /// Setups the form.
        /// &lt;/summary&gt;
        private void SetupForm()
        {

            if (!IsPostBack)
            {
                MembershipUser user = BackOfficeProvider.GetUser(u.LoginName, false);
                uname.Text = u.Name;
                lname.Text = (user == null) ? u.LoginName : user.UserName;
                email.Text = (user == null) ? u.Email : user.Email;

                contentPicker.Value = u.StartNodeId.ToString(CultureInfo.InvariantCulture);
                mediaPicker.Value = u.StartMediaId.ToString(CultureInfo.InvariantCulture);

                // get the current users applications
                string currentUserApps = &quot;;&quot;;
                foreach (Application a in CurrentUser.Applications)
                    currentUserApps += a.alias + &quot;;&quot;;

                Application[] uapps = u.Applications;
                foreach (Application app in BusinessLogic.Application.getAll())
                {
                    if (CurrentUser.IsAdmin() || currentUserApps.Contains(&quot;;&quot; + app.alias + &quot;;&quot;))
                    {
                        ListItem li = new ListItem(ui.Text(&quot;sections&quot;, app.alias), app.alias);
                        if (!IsPostBack) foreach (Application tmp in uapps) if (app.alias == tmp.alias) li.Selected = true;
                        lapps.Items.Add(li);
                    }
                }
            }
        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            //lapps.SelectionMode = ListSelectionMode.Multiple;
            lapps.RepeatLayout = RepeatLayout.Flow;
            lapps.RepeatDirection = RepeatDirection.Vertical;
        }

        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/CMSNode.asmx&quot;));
            //      ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/legacyAjaxCalls.asmx&quot;));

        }

        /// &lt;summary&gt;
        /// This handles changing the password
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;passwordChangerControl&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;membershipUser&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;passwordChangerValidator&quot;&gt;&lt;/param&gt;
        private void ChangePassword(passwordChanger passwordChangerControl, MembershipUser membershipUser, CustomValidator passwordChangerValidator)
        {
            if (passwordChangerControl.IsChangingPassword)
            {
                //SD: not sure why this check is here but must have been for some reason at some point?
                if (string.IsNullOrEmpty(passwordChangerControl.ChangingPasswordModel.NewPassword) == false)
                {
                    // make sure password is not empty
                    if (string.IsNullOrEmpty(u.Password)) u.Password = &quot;default&quot;;
                }

                var changePasswordModel = passwordChangerControl.ChangingPasswordModel;

                //now do the actual change
                var changePassResult = _membershipHelper.ChangePassword(
                    membershipUser.UserName, changePasswordModel, BackOfficeProvider);

                if (changePassResult.Success)
                {
                    //if it is successful, we need to show the generated password if there was one, so set
                    //that back on the control
                    passwordChangerControl.ChangingPasswordModel.GeneratedPassword = changePassResult.Result.ResetPassword;
                }
                else
                {
                    passwordChangerValidator.IsValid = false;
                    passwordChangerValidator.ErrorMessage = changePassResult.Result.ChangeError.ErrorMessage;
                    passw.Controls[1].Visible = true;
                }

            }
        }

        /// &lt;summary&gt;
        /// Handles the Click event of the saveUser control.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;System.Web.UI.ImageClickEventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        private void SaveUser_Click(object sender, EventArgs e)
        {
            if (base.IsValid)
            {
                try
                {
                    var membershipUser = BackOfficeProvider.GetUser(u.LoginName, false);
                    if (membershipUser == null)
                    {
                        throw new ProviderException(&quot;Could not find user in the membership provider with login name &quot; + u.LoginName);
                    }

                    var passwordChangerControl = (passwordChanger)passw.Controls[0];
                    var passwordChangerValidator = (CustomValidator)passw.Controls[1].Controls[0].Controls[0];

                    //perform the changing password logic
                    ChangePassword(passwordChangerControl, membershipUser, passwordChangerValidator);

                    //update the membership provider
                    UpdateMembershipProvider(membershipUser);

                    //update the Umbraco user properties - even though we are updating some of these properties in the membership provider that is 
                    // ok since the membership provider might be storing these details someplace totally different! But we want to keep our UI in sync.
                    u.Name = uname.Text.Trim();
                    u.Language = userLanguage.SelectedValue;
                    u.UserType = UserType.GetUserType(int.Parse(userType.SelectedValue));
                    u.Email = email.Text.Trim();
                    u.LoginName = lname.Text;
                    u.Disabled = Disabled.Checked;
                    u.NoConsole = NoConsole.Checked;

                    int startNode;
                    if (int.TryParse(contentPicker.Value, out startNode) == false)
                    {
                        //set to default if nothing is choosen
                        if (u.StartNodeId &gt; 0)
                            startNode = u.StartNodeId;
                        else
                            startNode = -1;
                    }
                    u.StartNodeId = startNode;


                    int mstartNode;
                    if (int.TryParse(mediaPicker.Value, out mstartNode) == false)
                    {
                        //set to default if nothing is choosen
                        if (u.StartMediaId &gt; 0)
                            mstartNode = u.StartMediaId;
                        else
                            mstartNode = -1;
                    }
                    u.StartMediaId = mstartNode;

                    u.ClearApplications();
                    foreach (ListItem li in lapps.Items)
                    {
                        if (li.Selected) u.AddApplication(li.Value);
                    }

                    u.Save();

                    // save data
                    if (cName.Text != &quot;&quot;)
                    {
                        Channel c;
                        try
                        {
                            c = new Channel(u.Id);
                        }
                        catch
                        {
                            c = new Channel();
                            c.User = u;
                        }

                        c.Name = cName.Text;
                        c.FullTree = cFulltree.Checked;
                        c.StartNode = int.Parse(cContentPicker.Value);
                        c.MediaFolder = int.Parse(cMediaPicker.Value);
                        c.FieldCategoriesAlias = cCategories.SelectedValue;
                        c.FieldDescriptionAlias = cDescription.SelectedValue;
                        c.FieldExcerptAlias = cExcerpt.SelectedValue;
                        c.DocumentTypeAlias = cDocumentType.SelectedValue;

                        //
                        c.MediaTypeAlias = Constants.Conventions.MediaTypes.Image; // [LK:2013-03-22] This was previously lowercase; unsure if using const will cause an issue.
                        c.MediaTypeFileProperty = Constants.Conventions.Media.File;
                        c.ImageSupport = true;

                        c.Save();

                    }

                    ClientTools.ShowSpeechBubble(speechBubbleIcon.save, ui.Text(&quot;speechBubbles&quot;, &quot;editUserSaved&quot;, UmbracoUser), &quot;&quot;);
                }
                catch (Exception ex)
                {
                    ClientTools.ShowSpeechBubble(speechBubbleIcon.error, ui.Text(&quot;speechBubbles&quot;, &quot;editUserError&quot;, UmbracoUser), &quot;&quot;);
                    LogHelper.Error&lt;EditUser&gt;(&quot;Exception&quot;, ex);
                }
            }
            else
            {
                ClientTools.ShowSpeechBubble(speechBubbleIcon.error, 
                    ui.Text(&quot;speechBubbles&quot;, &quot;validationFailedHeader&quot;, UmbracoUser), 
                    ui.Text(&quot;speechBubbles&quot;, &quot;validationFailedMessage&quot;, UmbracoUser));
            }
        }

        private void UpdateMembershipProvider(MembershipUser membershipUser)
        {
            //SD: This check must be here for some reason but apparently we don&#39;t want to try to 
            // update when the AD provider is active.
            if ((BackOfficeProvider is ActiveDirectoryMembershipProvider) == false)
            {
                var membershipHelper = new MembershipHelper(ApplicationContext, new HttpContextWrapper(Context));
                //set the writable properties that we are editing
                membershipHelper.UpdateMember(membershipUser, BackOfficeProvider,
                                              email.Text.Trim(),
                                              Disabled.Checked == false);
            }
        }

        /// &lt;summary&gt;
        /// UserTabs control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected TabView UserTabs;
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[44,9,44,26,0],[45,9,45,10,0],[46,13,46,55,0],[47,9,47,10,0],[49,9,49,66,0],[50,9,50,88,0],[51,9,51,66,0],[52,9,52,88,0],[53,9,53,80,0],[54,9,54,57,0],[55,9,55,59,0],[56,9,56,66,0],[57,9,57,88,0],[58,9,58,80,0],[59,9,59,62,0],[60,9,60,66,0],[61,9,61,55,0],[62,9,62,54,0],[64,9,64,67,0],[65,9,65,69,0],[67,9,67,49,0],[68,9,68,55,0],[69,9,69,67,0],[70,9,70,66,0],[71,9,71,65,0],[72,9,72,62,0],[73,9,73,68,0],[74,9,74,70,0],[75,9,75,76,0],[77,9,77,40,0],[85,17,85,18,0],[85,19,85,114,0],[85,115,85,116,0],[89,9,89,10,0],[90,13,90,78,0],[91,13,91,60,0],[92,13,92,49,0],[95,13,95,50,0],[96,13,96,14,0],[97,17,97,91,0],[101,13,101,63,0],[102,13,102,14,0],[103,17,103,81,0],[107,13,107,20,0],[107,22,107,33,0],[107,34,107,36,0],[107,37,107,52,0],[108,13,108,14,0],[109,17,109,66,0],[110,17,110,18,0],[111,21,111,115,0],[112,21,112,48,0],[113,25,113,44,0],[115,21,115,44,0],[116,17,116,18,0],[117,13,117,14,0],[119,13,119,95,0],[122,13,122,20,0],[122,22,122,30,0],[122,31,122,33,0],[122,34,122,77,0],[123,13,123,14,0],[124,17,124,101,0],[126,17,126,69,0],[128,17,128,47,0],[129,21,129,40,0],[131,17,131,44,0],[132,13,132,14,0],[135,13,135,45,0],[136,13,136,43,0],[138,13,138,52,0],[139,13,139,65,0],[140,13,140,45,0],[142,13,142,36,0],[143,17,143,63,0],[145,17,145,42,0],[147,13,147,46,0],[149,13,149,53,0],[150,13,150,69,0],[151,13,151,49,0],[153,13,153,35,0],[154,17,154,64,0],[156,17,156,44,0],[158,13,158,49,0],[161,13,161,126,0],[162,13,162,96,0],[165,13,168,15,0],[169,13,173,15,0],[174,13,174,74,0],[175,13,175,81,0],[176,13,176,78,0],[177,13,177,67,0],[178,13,178,66,0],[179,13,179,66,0],[180,13,180,49,0],[181,13,181,52,0],[183,13,188,15,0],[190,13,190,47,0],[192,13,192,93,0],[193,13,193,116,0],[194,13,194,77,0],[196,13,196,115,0],[197,13,197,80,0],[198,13,198,84,0],[201,13,201,39,0],[202,13,202,85,0],[203,13,203,89,0],[206,13,206,40,0],[207,13,207,88,0],[208,13,208,86,0],[211,13,211,41,0],[212,13,212,83,0],[213,13,213,58,0],[215,13,215,60,0],[217,13,217,39,0],[219,13,219,45,0],[220,13,220,44,0],[222,13,222,46,0],[224,13,224,37,0],[226,13,226,50,0],[227,13,227,42,0],[228,13,228,30,0],[229,13,229,44,0],[230,13,230,41,0],[231,13,231,54,0],[233,13,233,82,0],[234,13,234,59,0],[235,13,235,152,0],[236,13,236,49,0],[237,13,237,56,0],[239,13,239,57,0],[240,13,240,63,0],[241,13,241,99,0],[242,13,242,47,0],[243,13,243,54,0],[244,13,244,60,0],[245,13,245,61,0],[247,13,247,57,0],[248,13,248,63,0],[249,13,249,99,0],[250,13,250,47,0],[251,13,251,54,0],[252,13,252,60,0],[253,13,253,61,0],[255,13,255,90,0],[256,13,256,69,0],[257,13,257,63,0],[258,13,258,76,0],[259,13,259,128,0],[260,13,260,53,0],[261,13,261,60,0],[262,13,262,66,0],[263,13,263,67,0],[265,13,265,57,0],[266,13,266,63,0],[267,13,267,99,0],[268,13,268,47,0],[269,13,269,54,0],[270,13,270,60,0],[271,13,271,61,0],[273,13,273,90,0],[274,13,274,69,0],[275,13,275,63,0],[276,13,276,75,0],[277,13,277,128,0],[278,13,278,53,0],[279,13,279,60,0],[280,13,280,66,0],[281,13,281,67,0],[283,13,283,25,0],[284,13,284,28,0],[286,13,288,55,0],[289,9,289,10,0],[292,9,292,10,0],[293,13,293,104,0],[294,13,294,88,0],[295,9,295,10,0],[298,9,298,10,0],[299,13,299,83,0],[300,9,300,10,0],[303,9,303,10,0],[304,13,304,34,0],[306,13,306,42,0],[307,17,307,37,0],[308,9,308,10,0],[311,9,311,10,0],[314,13,314,14,0],[315,17,316,39,0],[317,13,317,14,0],[318,13,318,18,0],[319,13,319,14,0],[320,17,320,45,0],[321,13,321,14,0],[324,13,324,93,0],[325,13,325,20,0],[325,22,325,28,0],[325,29,325,31,0],[325,32,325,47,0],[326,13,326,14,0],[327,17,327,74,0],[328,13,328,14,0],[331,13,331,42,0],[332,13,332,46,0],[333,13,333,44,0],[334,13,334,38,0],[335,13,335,73,0],[336,13,336,72,0],[337,13,337,69,0],[339,13,339,20,0],[339,22,339,28,0],[339,29,339,31,0],[339,32,339,64,0],[339,64,339,79,0],[339,79,339,94,0],[339,94,339,100,0],[339,100,339,101,0],[339,32,339,101,0],[340,13,340,14,0],[341,17,341,56,0],[342,17,342,18,0],[343,21,343,115,0],[344,21,344,114,0],[345,21,345,111,0],[346,21,346,42,0],[347,17,347,18,0],[348,13,348,14,0],[352,13,352,52,0],[353,13,353,66,0],[354,13,354,46,0],[356,13,356,45,0],[357,17,357,73,0],[359,17,359,43,0],[361,13,361,47,0],[363,13,363,53,0],[364,13,364,70,0],[365,13,365,50,0],[367,13,367,43,0],[368,17,368,73,0],[370,17,370,45,0],[372,13,372,50,0],[376,13,376,38,0],[377,13,377,69,0],[378,13,378,84,0],[379,13,379,94,0],[380,13,380,88,0],[382,13,382,40,0],[383,13,383,95,0],[384,13,384,98,0],[385,13,385,94,0],[386,13,386,90,0],[389,13,389,103,0],[391,13,391,46,0],[392,13,392,48,0],[395,13,395,29,0],[396,13,396,14,0],[397,17,397,47,0],[398,17,398,80,0],[399,17,399,78,0],[400,17,400,72,0],[401,17,401,77,0],[402,17,402,58,0],[403,13,403,14,0],[404,9,404,10,0],[410,9,410,10,0],[412,13,412,29,0],[413,13,413,14,0],[414,17,414,86,0],[415,17,415,37,0],[416,17,416,75,0],[417,17,417,68,0],[419,17,419,92,0],[420,17,420,91,0],[423,17,423,46,0],[424,17,424,24,0],[424,26,424,39,0],[424,40,424,42,0],[424,43,424,67,0],[425,21,425,54,0],[427,17,427,54,0],[428,17,428,24,0],[428,26,428,41,0],[428,42,428,44,0],[428,45,428,79,0],[429,17,429,18,0],[430,21,430,98,0],[431,21,431,22,0],[432,25,432,95,0],[433,25,433,41,0],[433,42,433,49,0],[433,51,433,66,0],[433,67,433,69,0],[433,70,433,75,0],[433,77,433,104,0],[433,105,433,124,0],[434,25,434,45,0],[435,21,435,22,0],[436,17,436,18,0],[437,13,437,14,0],[438,9,438,10,0],[441,9,441,10,0],[442,13,442,28,0],[445,13,445,52,0],[446,13,446,62,0],[447,9,447,10,0],[450,9,450,10,0],[451,13,451,33,0],[453,13,453,110,0],[456,9,456,10,0],[465,9,465,10,0],[466,13,466,59,0],[467,13,467,14,0],[469,17,469,109,0],[470,17,470,18,0],[472,21,472,58,0],[472,59,472,82,0],[473,17,473,18,0],[475,17,475,88,0],[478,17,479,87,0],[481,17,481,46,0],[482,17,482,18,0],[485,21,485,124,0],[486,17,486,18,0],[488,17,488,18,0],[489,21,489,62,0],[490,21,490,110,0],[491,21,491,54,0],[492,17,492,18,0],[494,13,494,14,0],[495,9,495,10,0],[503,9,503,10,0],[504,13,504,30,0],[505,13,505,14,0],[507,17,507,18,0],[508,21,508,89,0],[509,21,509,48,0],[510,21,510,22,0],[511,25,511,134,0],[514,21,514,85,0],[515,21,515,111,0],[518,21,518,102,0],[521,21,521,62,0],[525,21,525,48,0],[526,21,526,61,0],[527,21,527,90,0],[528,21,528,49,0],[529,21,529,46,0],[530,21,530,51,0],[531,21,531,53,0],[534,21,534,83,0],[535,21,535,22,0],[537,25,537,47,0],[538,29,538,55,0],[540,29,540,44,0],[541,21,541,22,0],[542,21,542,47,0],[546,21,546,82,0],[547,21,547,22,0],[549,25,549,48,0],[550,29,550,57,0],[552,29,552,45,0],[553,21,553,22,0],[554,21,554,49,0],[556,21,556,43,0],[557,21,557,28,0],[557,30,557,41,0],[557,42,557,44,0],[557,45,557,56,0],[558,21,558,22,0],[559,25,559,41,0],[559,42,559,69,0],[560,21,560,22,0],[562,21,562,30,0],[565,21,565,42,0],[566,21,566,22,0],[569,25,569,26,0],[570,29,570,51,0],[571,25,571,26,0],[572,25,572,30,0],[573,25,573,26,0],[574,29,574,47,0],[575,29,575,40,0],[576,25,576,26,0],[578,25,578,45,0],[579,25,579,56,0],[580,25,580,71,0],[581,25,581,71,0],[582,25,582,76,0],[583,25,583,78,0],[584,25,584,70,0],[585,25,585,75,0],[588,25,588,83,0],[589,25,589,84,0],[590,25,590,47,0],[592,25,592,34,0],[594,21,594,22,0],[596,21,596,133,0],[597,17,597,18,0],[598,17,598,37,0],[599,17,599,18,0],[600,21,600,134,0],[601,21,601,64,0],[602,17,602,18,0],[603,13,603,14,0],[605,13,605,14,0],[606,17,608,87,0],[609,13,609,14,0],[610,9,610,10,0],[613,9,613,10,0],[616,13,616,84,0],[617,13,617,14,0],[618,17,618,114,0],[620,17,622,74,0],[623,13,623,14,0],[624,9,624,10,0]]);
    </script>
  </body>
</html>