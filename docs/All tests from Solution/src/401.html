<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Issues\U9560.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Issues
{
    [TestFixture]
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    public class U9560 : BaseDatabaseFactoryTest
    {
        [Test]
        public void Test()
        {
            // create a content type and some properties
            var contentType = new ContentType(-1);
            contentType.Alias = &quot;test&quot;;
            contentType.Name = &quot;test&quot;;
            var propertyType = new PropertyType(&quot;test&quot;, DataTypeDatabaseType.Ntext, &quot;prop&quot;) { Name = &quot;Prop&quot;, Description = &quot;&quot;, Mandatory = false, SortOrder = 1, DataTypeDefinitionId = -88 };
            contentType.PropertyTypeCollection.Add(propertyType);
            ServiceContext.ContentTypeService.Save(contentType);

            var aliasName = string.Empty;

            // read fields, same as what we do with PetaPoco Fetch&lt;dynamic&gt;
            var db = DatabaseContext.Database;
            db.OpenSharedConnection();
            try
            {
                var conn = db.Connection;
                var cmd = conn.CreateCommand();
                cmd.CommandText = &quot;SELECT mandatory, dataTypeId, propertyTypeGroupId, contentTypeId, sortOrder, alias, name, validationRegExp, description from cmsPropertyType where id=&quot; + propertyType.Id;
                using (var reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        for (var i = 0; i &lt; reader.FieldCount; i++)
                            Console.WriteLine(reader.GetName(i));
                        aliasName = reader.GetName(5);
                    }
                }
            }
            finally
            {
                db.CloseSharedConnection();
            }

            // note that although the query is for &#39;alias&#39; the field is named &#39;Alias&#39;
            Assert.AreEqual(&quot;Alias&quot;, aliasName);

            // try differently
            db.OpenSharedConnection();
            try
            {
                var conn = db.Connection;
                var cmd = conn.CreateCommand();
                cmd.CommandText = &quot;SELECT mandatory, dataTypeId, propertyTypeGroupId, contentTypeId, sortOrder, alias as alias, name, validationRegExp, description from cmsPropertyType where id=&quot; + propertyType.Id;
                using (var reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        for (var i = 0; i &lt; reader.FieldCount; i++)
                            Console.WriteLine(reader.GetName(i));
                        aliasName = reader.GetName(5);
                    }
                }
            }
            finally
            {
                db.CloseSharedConnection();
            }

            // and now it is OK
            Assert.AreEqual(&quot;alias&quot;, aliasName);

            // get the legacy content type
            var legacyContentType = new umbraco.cms.businesslogic.ContentType(contentType.Id);
            Assert.AreEqual(&quot;test&quot;, legacyContentType.Alias);

            // get the legacy properties
            var legacyProperties = legacyContentType.PropertyTypes;

            // without the fix, due to some (swallowed) inner exception, we have no properties
            //Assert.IsNull(legacyProperties);

            // thanks to the fix, it works
            Assert.IsNotNull(legacyProperties);
            Assert.AreEqual(1, legacyProperties.Count);
            Assert.AreEqual(&quot;prop&quot;, legacyProperties[0].Alias);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[14,9,14,10,1],[16,13,16,51,1],[17,13,17,40,1],[18,13,18,39,1],[19,13,19,191,1],[20,13,20,66,1],[21,13,21,65,1],[23,13,23,42,1],[26,13,26,47,1],[27,13,27,39,1],[29,13,29,14,1],[30,17,30,42,1],[31,17,31,48,1],[32,17,32,206,1],[33,24,33,56,1],[34,17,34,18,1],[35,21,35,42,1],[36,21,36,22,1],[37,30,37,39,1],[37,41,37,62,1],[37,64,37,67,1],[38,29,38,66,1],[39,25,39,55,1],[40,21,40,22,1],[41,17,41,18,1],[42,13,42,14,1],[44,13,44,14,1],[45,17,45,44,1],[46,13,46,14,1],[49,13,49,49,1],[52,13,52,39,1],[54,13,54,14,1],[55,17,55,42,1],[56,17,56,48,1],[57,17,57,215,1],[58,24,58,56,1],[59,17,59,18,1],[60,21,60,42,1],[61,21,61,22,1],[62,30,62,39,1],[62,41,62,62,1],[62,64,62,67,1],[63,29,63,66,1],[64,25,64,55,1],[65,21,65,22,1],[66,17,66,18,1],[67,13,67,14,1],[69,13,69,14,1],[70,17,70,44,1],[71,13,71,14,1],[74,13,74,49,1],[77,13,77,95,1],[78,13,78,62,1],[81,13,81,68,1],[87,13,87,48,1],[88,13,88,56,1],[89,13,89,64,1],[90,9,90,10,1]]);
    </script>
  </body>
</html>