<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\channels\api.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using CookComputing.MetaWeblog;
using CookComputing.XmlRpc;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic;
using umbraco.cms.businesslogic.datatype;
using umbraco.cms.businesslogic.propertytype;
using umbraco.cms.businesslogic.web;
using umbraco.presentation.channels.businesslogic;

namespace umbraco.presentation.channels
{
    /// &lt;summary&gt;
    /// the umbraco channels API is xml-rpc webservice based on the metaweblog and blogger APIs
    /// for editing umbraco data froom external clients
    /// &lt;/summary&gt;
    [XmlRpcService(
        Name = &quot;umbraco metablog api&quot;,
        Description = &quot;For editing umbraco data from external clients&quot;,
        AutoDocumentation = true)]
    public class api : UmbracoMetaWeblogAPI, IRemixWeblogApi
    {
        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;api&quot;/&gt; class.
        /// &lt;/summary&gt;
        public api()
        {
        }


        /// &lt;summary&gt;
        /// Makes a new file to a designated blog using the metaWeblog API
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;blogid&quot;&gt;The blogid.&lt;/param&gt;
        /// &lt;param name=&quot;username&quot;&gt;The username.&lt;/param&gt;
        /// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;
        /// &lt;param name=&quot;file&quot;&gt;The file.&lt;/param&gt;
        /// &lt;returns&gt;Returns url as a string of a struct.&lt;/returns&gt;
        [XmlRpcMethod(&quot;metaWeblog.newMediaObject&quot;,
            Description = &quot;Makes a new file to a designated blog using the &quot;
                          + &quot;metaWeblog API. Returns url as a string of a struct.&quot;)]
        public UrlData newMediaObject(
            string blogid,
            string username,
            string password,
            FileData file)
        {
            return newMediaObjectLogic(blogid, username, password, file);
        }

        #region IRemixWeblogApi Members

        /// &lt;summary&gt;
        /// Gets a summary of all the pages from the blog with the spefied blogId.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;blogid&quot;&gt;The blogid.&lt;/param&gt;
        /// &lt;param name=&quot;username&quot;&gt;The username.&lt;/param&gt;
        /// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public wpPageSummary[] getPageList(string blogid, string username, string password)
        {
            if (User.validateCredentials(username, password, false))
            {
                ArrayList blogPosts = new ArrayList();
                ArrayList blogPostsObjects = new ArrayList();

                User u = new User(username);
                Channel userChannel = new Channel(u.Id);


                Document rootDoc;
                if (userChannel.StartNode &gt; 0)
                    rootDoc = new Document(userChannel.StartNode);
                else
                    rootDoc = new Document(u.StartNodeId);

                //store children array here because iterating over an Array object is very inneficient.
                var c = rootDoc.Children;
                foreach (Document d in c)
                {
                    int count = 0;
                    blogPosts.AddRange(
                        findBlogPosts(userChannel, d, u.Name, ref count, 999, userChannel.FullTree));
                }

                blogPosts.Sort(new DocumentSortOrderComparer());

                foreach (Object o in blogPosts)
                {
                    Document d = (Document)o;
                    wpPageSummary p = new wpPageSummary();
                    p.dateCreated = d.CreateDateTime;
                    p.page_title = d.Text;
                    p.page_id = d.Id;
                    p.page_parent_id = d.ParentId;

                    blogPostsObjects.Add(p);
                }


                return (wpPageSummary[])blogPostsObjects.ToArray(typeof(wpPageSummary));
            }
            else
            {
                return null;
            }
        }

        /// &lt;summary&gt;
        /// Gets a specified number of pages from the blog with the spefied blogId 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;blogid&quot;&gt;The blogid.&lt;/param&gt;
        /// &lt;param name=&quot;username&quot;&gt;The username.&lt;/param&gt;
        /// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;
        /// &lt;param name=&quot;numberOfItems&quot;&gt;The number of pages.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public wpPage[] getPages(string blogid, string username, string password, int numberOfItems)
        {
            if (User.validateCredentials(username, password, false))
            {
                ArrayList blogPosts = new ArrayList();
                ArrayList blogPostsObjects = new ArrayList();

                User u = new User(username);
                Channel userChannel = new Channel(u.Id);


                Document rootDoc;
                if (userChannel.StartNode &gt; 0)
                    rootDoc = new Document(userChannel.StartNode);
                else
                    rootDoc = new Document(u.StartNodeId);

                //store children array here because iterating over an Array object is very inneficient.
                var c = rootDoc.Children;
                foreach (Document d in c)
                {
                    int count = 0;
                    blogPosts.AddRange(
                        findBlogPosts(userChannel, d, u.Name, ref count, numberOfItems, userChannel.FullTree));
                }

                blogPosts.Sort(new DocumentSortOrderComparer());

                foreach (Object o in blogPosts)
                {
                    Document d = (Document)o;
                    wpPage p = new wpPage();
                    p.dateCreated = d.CreateDateTime;
                    p.title = d.Text;
                    p.page_id = d.Id;
                    p.wp_page_parent_id = d.ParentId;
                    p.wp_page_parent_title = d.Parent.Text;
                    p.permalink = library.NiceUrl(d.Id);
                    p.description = d.getProperty(userChannel.FieldDescriptionAlias).Value.ToString();
                    p.link = library.NiceUrl(d.Id);

                    if (userChannel.FieldCategoriesAlias != null &amp;&amp; userChannel.FieldCategoriesAlias != &quot;&quot; &amp;&amp;
                        d.getProperty(userChannel.FieldCategoriesAlias) != null &amp;&amp;
                        ((string)d.getProperty(userChannel.FieldCategoriesAlias).Value) != &quot;&quot;)
                    {
                        String categories = d.getProperty(userChannel.FieldCategoriesAlias).Value.ToString();
                        char[] splitter = { &#39;,&#39; };
                        String[] categoryIds = categories.Split(splitter);
                        p.categories = categoryIds;
                    }


                    blogPostsObjects.Add(p);
                }


                return (wpPage[])blogPostsObjects.ToArray(typeof(wpPage));
            }
            else
            {
                return null;
            }
        }

        /// &lt;summary&gt;
        /// Creates a new blog category / tag.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;blogid&quot;&gt;The blogid.&lt;/param&gt;
        /// &lt;param name=&quot;username&quot;&gt;The username.&lt;/param&gt;
        /// &lt;param name=&quot;password&quot;&gt;The password.&lt;/param&gt;
        /// &lt;param name=&quot;category&quot;&gt;The category.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string newCategory(
            string blogid,
            string username,
            string password,
            wpCategory category)
        {
            if (User.validateCredentials(username, password, false))
            {
                Channel userChannel = new Channel(username);
                if (userChannel.FieldCategoriesAlias != null &amp;&amp; userChannel.FieldCategoriesAlias != &quot;&quot;)
                {
                    // Find the propertytype via the document type
                    ContentType blogPostType = ContentType.GetByAlias(userChannel.DocumentTypeAlias);
                    PropertyType categoryType = blogPostType.getPropertyType(userChannel.FieldCategoriesAlias);
                    interfaces.IUseTags tags = UseTags(categoryType);
                    if (tags != null)
                    {
                        tags.AddTag(category.name);
                    }
                    else
                    {
                        PreValue pv = new PreValue();
                        pv.DataTypeId = categoryType.DataTypeDefinition.Id;
                        pv.Value = category.name;
                        pv.Save();
                    }
                }
            }
            return &quot;&quot;;
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,21,0],[28,9,28,10,0],[29,9,29,10,0],[48,9,48,10,0],[49,13,49,74,0],[50,9,50,10,0],[62,9,62,10,0],[63,13,63,69,0],[64,13,64,14,0],[65,17,65,55,0],[66,17,66,62,0],[68,17,68,45,0],[69,17,69,57,0],[73,17,73,47,0],[74,21,74,67,0],[76,21,76,59,0],[79,17,79,42,0],[80,17,80,24,0],[80,26,80,36,0],[80,37,80,39,0],[80,40,80,41,0],[81,17,81,18,0],[82,21,82,35,0],[83,21,84,102,0],[85,17,85,18,0],[87,17,87,65,0],[89,17,89,24,0],[89,26,89,34,0],[89,35,89,37,0],[89,38,89,47,0],[90,17,90,18,0],[91,21,91,46,0],[92,21,92,59,0],[93,21,93,54,0],[94,21,94,43,0],[95,21,95,38,0],[96,21,96,51,0],[98,21,98,45,0],[99,17,99,18,0],[102,17,102,89,0],[105,13,105,14,0],[106,17,106,29,0],[108,9,108,10,0],[119,9,119,10,0],[120,13,120,69,0],[121,13,121,14,0],[122,17,122,55,0],[123,17,123,62,0],[125,17,125,45,0],[126,17,126,57,0],[130,17,130,47,0],[131,21,131,67,0],[133,21,133,59,0],[136,17,136,42,0],[137,17,137,24,0],[137,26,137,36,0],[137,37,137,39,0],[137,40,137,41,0],[138,17,138,18,0],[139,21,139,35,0],[140,21,141,112,0],[142,17,142,18,0],[144,17,144,65,0],[146,17,146,24,0],[146,26,146,34,0],[146,35,146,37,0],[146,38,146,47,0],[147,17,147,18,0],[148,21,148,46,0],[149,21,149,45,0],[150,21,150,54,0],[151,21,151,38,0],[152,21,152,38,0],[153,21,153,54,0],[154,21,154,60,0],[155,21,155,57,0],[156,21,156,103,0],[157,21,157,52,0],[159,21,161,95,0],[162,21,162,22,0],[163,25,163,110,0],[164,25,164,51,0],[165,25,165,75,0],[166,25,166,52,0],[167,21,167,22,0],[170,21,170,45,0],[171,17,171,18,0],[174,17,174,75,0],[177,13,177,14,0],[178,17,178,29,0],[180,9,180,10,0],[195,9,195,10,0],[196,13,196,69,0],[197,13,197,14,0],[198,17,198,61,0],[199,17,199,104,0],[200,17,200,18,0],[202,21,202,102,0],[203,21,203,112,0],[204,21,204,70,0],[205,21,205,38,0],[206,21,206,22,0],[207,25,207,52,0],[208,21,208,22,0],[210,21,210,22,0],[211,25,211,54,0],[212,25,212,76,0],[213,25,213,50,0],[214,25,214,35,0],[215,21,215,22,0],[216,17,216,18,0],[217,13,217,14,0],[218,13,218,23,0],[219,9,219,10,0]]);
    </script>
  </body>
</html>