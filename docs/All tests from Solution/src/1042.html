<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\AdminTokenAuthorizeAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Net.Http.Headers;
using System.Text;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.Mvc;
using umbraco;
using Umbraco.Core;
using Umbraco.Core.Logging;

namespace Umbraco.Web.Mvc
{
    /// &lt;summary&gt;
    /// Used for authorizing scheduled tasks
    /// &lt;/summary&gt;
    public sealed class AdminTokenAuthorizeAttribute : AuthorizeAttribute
    {
        private readonly ApplicationContext _applicationContext;

        /// &lt;summary&gt;
        /// THIS SHOULD BE ONLY USED FOR UNIT TESTS
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;appContext&quot;&gt;&lt;/param&gt;
        public AdminTokenAuthorizeAttribute(ApplicationContext appContext)
        {
            if (appContext == null) throw new ArgumentNullException(&quot;appContext&quot;);
            _applicationContext = appContext;
        }

        public AdminTokenAuthorizeAttribute()
        {
        }

        private ApplicationContext GetApplicationContext()
        {
            return _applicationContext ?? ApplicationContext.Current;
        }

        public const string AuthorizationType = &quot;AToken&quot;;

        /// &lt;summary&gt;
        /// Used to return the full value that needs to go in the Authorization header
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;appContext&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetAuthHeaderTokenVal(ApplicationContext appContext)
        {
            return string.Format(&quot;{0} {1}&quot;, AuthorizationType, GetAuthHeaderVal(appContext));
        }

        public static AuthenticationHeaderValue GetAuthenticationHeaderValue(ApplicationContext appContext)
        {
            return new AuthenticationHeaderValue(AuthorizationType, GetAuthHeaderVal(appContext));
        }

        private static string GetAuthHeaderVal(ApplicationContext appContext)
        {
            var admin = appContext.Services.UserService.GetUserById(0);

            var token = string.Format(&quot;{0}u____u{1}u____u{2}&quot;, admin.Email, admin.Username, admin.RawPasswordValue);

            var encrypted = token.EncryptWithMachineKey();
            var bytes = Encoding.UTF8.GetBytes(encrypted);
            var base64 = Convert.ToBase64String(bytes);
            return string.Format(&quot;val=\&quot;{0}\&quot;&quot;, base64);
        }
        
        /// &lt;summary&gt;
        /// Ensures that the user must be in the Administrator or the Install role
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;httpContext&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected override bool AuthorizeCore(HttpContextBase httpContext)
        {
            if (httpContext == null) throw new ArgumentNullException(&quot;httpContext&quot;);

            var appContext = GetApplicationContext();

            //we need to that the app is configured and that a user is logged in
            if (appContext.IsConfigured == false) return false;

            //need the auth header
            if (httpContext.Request.Headers[&quot;Authorization&quot;] == null || httpContext.Request.Headers[&quot;Authorization&quot;].IsNullOrWhiteSpace()) return false;

            var header = httpContext.Request.Headers[&quot;Authorization&quot;];
            if (header.StartsWith(&quot;AToken &quot;) == false) return false;

            var keyVal = Regex.Matches(header, &quot;AToken val=(.*?)(?:$|\\s)&quot;);
            if (keyVal.Count != 1) return false;
            if (keyVal[0].Groups.Count != 2) return false;

            var admin = appContext.Services.UserService.GetUserById(0);
            if (admin == null) return false;

            try
            {
                //get the token value from the header
                var val = keyVal[0].Groups[1].Value.Trim(&quot;\&quot;&quot;);
                //un-base 64 the string
                var bytes = Convert.FromBase64String(val);
                var encrypted = Encoding.UTF8.GetString(bytes);
                //decrypt the string
                var text = encrypted.DecryptWithMachineKey();

                //split - some users have not set an email, don&#39;t strip out empty entries
                var split = text.Split(new[] {&quot;u____u&quot;}, StringSplitOptions.None);
                if (split.Length != 3) return false;

                //compare
                return
                    split[0] == admin.Email
                    &amp;&amp; split[1] == admin.Username
                    &amp;&amp; split[2] == admin.RawPasswordValue;
            }
            catch (Exception ex)
            {
                LogHelper.Error&lt;AdminTokenAuthorizeAttribute&gt;(&quot;Failed to format passed in token value&quot;, ex);
                return false;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,75,0],[26,9,26,10,0],[27,13,27,36,0],[27,37,27,83,0],[28,13,28,46,0],[29,9,29,10,0],[31,9,31,46,0],[32,9,32,10,0],[33,9,33,10,0],[36,9,36,10,0],[37,13,37,70,0],[38,9,38,10,0],[48,9,48,10,0],[49,13,49,94,0],[50,9,50,10,0],[53,9,53,10,0],[54,13,54,99,0],[55,9,55,10,0],[58,9,58,10,0],[59,13,59,72,0],[61,13,61,117,0],[63,13,63,59,0],[64,13,64,59,0],[65,13,65,56,0],[66,13,66,57,0],[67,9,67,10,0],[75,9,75,10,0],[76,13,76,37,0],[76,38,76,85,0],[78,13,78,54,0],[81,13,81,50,0],[81,51,81,64,0],[84,13,84,139,0],[84,140,84,153,0],[86,13,86,71,0],[87,13,87,55,0],[87,56,87,69,0],[89,13,89,77,0],[90,13,90,35,0],[90,36,90,49,0],[91,13,91,45,0],[91,46,91,59,0],[93,13,93,72,0],[94,13,94,31,0],[94,32,94,45,0],[97,13,97,14,0],[99,17,99,64,0],[101,17,101,59,0],[102,17,102,64,0],[104,17,104,62,0],[107,17,107,83,0],[108,17,108,39,0],[108,40,108,53,0],[111,17,114,59,0],[116,13,116,33,0],[117,13,117,14,0],[118,17,118,109,0],[119,17,119,30,0],[121,9,121,10,0]]);
    </script>
  </body>
</html>