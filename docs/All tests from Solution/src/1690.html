<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\EntityContainerRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Cache;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Factories;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence.Repositories
{
    /// &lt;summary&gt;
    /// An internal repository for managing entity containers such as doc type, media type, data type containers.
    /// &lt;/summary&gt;
    internal class EntityContainerRepository : PetaPocoRepositoryBase&lt;int, EntityContainer&gt;
    {
        private readonly Guid _containerObjectType;

        public EntityContainerRepository(IDatabaseUnitOfWork work, CacheHelper cache, ILogger logger, ISqlSyntaxProvider sqlSyntax, Guid containerObjectType) 
            : base(work, cache, logger, sqlSyntax)
        {
            var allowedContainers = new[] {Constants.ObjectTypes.DocumentTypeContainerGuid, Constants.ObjectTypes.MediaTypeContainerGuid, Constants.ObjectTypes.DataTypeContainerGuid};
            _containerObjectType = containerObjectType;
            if (allowedContainers.Contains(_containerObjectType) == false)
                throw new InvalidOperationException(&quot;No container type exists with ID: &quot; + _containerObjectType);
        }

        /// &lt;summary&gt;
        /// Do not cache anything
        /// &lt;/summary&gt;
        protected override IRuntimeCacheProvider RuntimeCache
        {
            get { return new NullCacheProvider(); }
        }

        protected override EntityContainer PerformGet(int id)
        {
            var sql = GetBaseQuery(false).Where(GetBaseWhereClause(), new { id = id, NodeObjectType = NodeObjectTypeId });

            var nodeDto = Database.Fetch&lt;NodeDto&gt;(SqlSyntax.SelectTop(sql, 1)).FirstOrDefault();
            return nodeDto == null ? null : CreateEntity(nodeDto);
        }

        // temp - so we don&#39;t have to implement GetByQuery
        public EntityContainer Get(Guid id)
        {
            var sql = GetBaseQuery(false).Where(&quot;UniqueId=@uniqueId&quot;, new { uniqueId = id });

            var nodeDto = Database.Fetch&lt;NodeDto&gt;(sql).FirstOrDefault();
            return nodeDto == null ? null : CreateEntity(nodeDto);
        }

        public IEnumerable&lt;EntityContainer&gt; Get(string name, int level)
        {
            var sql = GetBaseQuery(false).Where(&quot;text=@name AND level=@level AND nodeObjectType=@umbracoObjectTypeId&quot;, new { name, level, umbracoObjectTypeId = NodeObjectTypeId });
            return Database.Fetch&lt;NodeDto&gt;(sql).Select(CreateEntity);
        }

        protected override IEnumerable&lt;EntityContainer&gt; PerformGetAll(params int[] ids)
        {
            if (ids.Any())
            {
                //we need to batch these in groups of 2000 so we don&#39;t exceed the max 2100 limit
                return ids.InGroupsOf(2000).SelectMany(@group =&gt;
                {
                    var sql = GetBaseQuery(false)
                        .Where(&quot;nodeObjectType=@umbracoObjectTypeId&quot;, new {umbracoObjectTypeId = NodeObjectTypeId})
                        .Where(string.Format(&quot;{0} IN (@ids)&quot;, SqlSyntax.GetQuotedColumnName(&quot;id&quot;)), new {ids = @group});

                    sql.OrderBy&lt;NodeDto&gt;(x =&gt; x.Level, SqlSyntax);

                    return Database.Fetch&lt;NodeDto&gt;(sql).Select(CreateEntity);
                });
            }
            else
            {
                var sql = GetBaseQuery(false)
                    .Where(&quot;nodeObjectType=@umbracoObjectTypeId&quot;, new {umbracoObjectTypeId = NodeObjectTypeId});
                sql.OrderBy&lt;NodeDto&gt;(x =&gt; x.Level, SqlSyntax);
                return Database.Fetch&lt;NodeDto&gt;(sql).Select(CreateEntity);
            }
        }

        protected override IEnumerable&lt;EntityContainer&gt; PerformGetByQuery(IQuery&lt;EntityContainer&gt; query)
        {
            throw new NotImplementedException();
        }

        private static EntityContainer CreateEntity(NodeDto nodeDto)
        {
            if (nodeDto.NodeObjectType.HasValue == false)
                throw new InvalidOperationException(&quot;Node with id &quot; + nodeDto.NodeId + &quot; has no object type.&quot;);

            // throws if node is not a container
            var containedObjectType = EntityContainer.GetContainedObjectType(nodeDto.NodeObjectType.Value);

            var entity = new EntityContainer(nodeDto.NodeId, nodeDto.UniqueId,
                nodeDto.ParentId, nodeDto.Path, nodeDto.Level, nodeDto.SortOrder,
                containedObjectType,
                nodeDto.Text, nodeDto.UserId ?? 0);

            //on initial construction we don&#39;t want to have dirty properties tracked
            // http://issues.umbraco.org/issue/U4-1946
            entity.ResetDirtyProperties(false);

            return entity;
        }

        protected override Sql GetBaseQuery(bool isCount)
        {
            var sql = new Sql();
            if (isCount)
            {
                sql.Select(&quot;COUNT(*)&quot;).From&lt;NodeDto&gt;(SqlSyntax);
            }
            else
            {
                sql.Select(&quot;*&quot;).From&lt;NodeDto&gt;(SqlSyntax);
            }
            return sql;
        }

        protected override string GetBaseWhereClause()
        {
            return &quot;umbracoNode.id = @id and nodeObjectType = @NodeObjectType&quot;;
        }

        protected override IEnumerable&lt;string&gt; GetDeleteClauses()
        {
            throw new NotImplementedException();
        }

        protected override Guid NodeObjectTypeId
        {
            get { return _containerObjectType; }
        }

        protected override void PersistDeletedItem(EntityContainer entity)
        {
            EnsureContainerType(entity);

            var nodeDto = Database.FirstOrDefault&lt;NodeDto&gt;(new Sql().Select(&quot;*&quot;)
                .From&lt;NodeDto&gt;(SqlSyntax)
                .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeId == entity.Id &amp;&amp; dto.NodeObjectType == entity.ContainerObjectType));

            if (nodeDto == null) return;

            // move children to the parent so they are not orphans
            var childDtos = Database.Fetch&lt;NodeDto&gt;(new Sql().Select(&quot;*&quot;)
                .From&lt;NodeDto&gt;(SqlSyntax)
                .Where(&quot;parentID=@parentID AND (nodeObjectType=@containedObjectType OR nodeObjectType=@containerObjectType)&quot;,
                    new
                    {
                        parentID = entity.Id,
                        containedObjectType = entity.ContainedObjectType,
                        containerObjectType = entity.ContainerObjectType
                    }));

            foreach (var childDto in childDtos)
            {
                childDto.ParentId = nodeDto.ParentId;
                Database.Update(childDto);
            }

            // delete
            Database.Delete(nodeDto);
        }

        protected override void PersistNewItem(EntityContainer entity)
        {
            EnsureContainerType(entity);

            entity.Name = entity.Name.Trim();
            Mandate.ParameterNotNullOrEmpty(entity.Name, &quot;entity.Name&quot;);

            // guard against duplicates
            var nodeDto = Database.FirstOrDefault&lt;NodeDto&gt;(new Sql().Select(&quot;*&quot;)
                .From&lt;NodeDto&gt;(SqlSyntax)
                .Where&lt;NodeDto&gt;(dto =&gt; dto.ParentId == entity.ParentId &amp;&amp; dto.Text == entity.Name &amp;&amp; dto.NodeObjectType == entity.ContainerObjectType));
            if (nodeDto != null)
                throw new InvalidOperationException(&quot;A container with the same name already exists.&quot;);

            // create
            var level = 0;
            var path = &quot;-1&quot;;
            if (entity.ParentId &gt; -1)
            {
                var parentDto = Database.FirstOrDefault&lt;NodeDto&gt;(new Sql().Select(&quot;*&quot;)
                    .From&lt;NodeDto&gt;(SqlSyntax)
                    .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeId == entity.ParentId &amp;&amp; dto.NodeObjectType == entity.ContainerObjectType));

                if (parentDto == null)
                    throw new NullReferenceException(&quot;Could not find parent container with id &quot; + entity.ParentId);

                level = parentDto.Level;
                path = parentDto.Path;
            }

            // note: sortOrder is NOT managed and always zero for containers

            nodeDto = new NodeDto
            {
                CreateDate = DateTime.Now,
                Level = Convert.ToInt16(level + 1),
                NodeObjectType = entity.ContainerObjectType,
                ParentId = entity.ParentId,
                Path = path,
                SortOrder = 0,
                Text = entity.Name,
                UserId = entity.CreatorId,
                UniqueId = entity.Key
            };

            // insert, get the id, update the path with the id
            var id = Convert.ToInt32(Database.Insert(nodeDto));
            nodeDto.Path = nodeDto.Path + &quot;,&quot; + nodeDto.NodeId;
            Database.Save(nodeDto);

            // refresh the entity
            entity.Id = id;
            entity.Path = nodeDto.Path;
            entity.Level = nodeDto.Level;
            entity.SortOrder = 0;
            entity.CreateDate = nodeDto.CreateDate;
            entity.ResetDirtyProperties();
        }

        // beware! does NOT manage descendants in case of a new parent
        //
        protected override void PersistUpdatedItem(EntityContainer entity)
        {
            EnsureContainerType(entity);

            entity.Name = entity.Name.Trim();
            Mandate.ParameterNotNullOrEmpty(entity.Name, &quot;entity.Name&quot;);

            // find container to update
            var nodeDto = Database.FirstOrDefault&lt;NodeDto&gt;(new Sql().Select(&quot;*&quot;)
                .From&lt;NodeDto&gt;(SqlSyntax)
                .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeId == entity.Id &amp;&amp; dto.NodeObjectType == entity.ContainerObjectType));
            if (nodeDto == null)
                throw new InvalidOperationException(&quot;Could not find container with id &quot; + entity.Id);

            // guard against duplicates
            var dupNodeDto = Database.FirstOrDefault&lt;NodeDto&gt;(new Sql().Select(&quot;*&quot;)
                .From&lt;NodeDto&gt;(SqlSyntax)
                .Where&lt;NodeDto&gt;(dto =&gt; dto.ParentId == entity.ParentId &amp;&amp; dto.Text == entity.Name &amp;&amp; dto.NodeObjectType == entity.ContainerObjectType));
            if (dupNodeDto != null &amp;&amp; dupNodeDto.NodeId != nodeDto.NodeId)
                throw new InvalidOperationException(&quot;A container with the same name already exists.&quot;);

            // update
            nodeDto.Text = entity.Name;
            if (nodeDto.ParentId != entity.ParentId)
            {
                nodeDto.Level = 0;
                nodeDto.Path = &quot;-1&quot;;
                if (entity.ParentId &gt; -1)
                {
                    var parent = Database.FirstOrDefault&lt;NodeDto&gt;(new Sql().Select(&quot;*&quot;)
                        .From&lt;NodeDto&gt;(SqlSyntax)
                        .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeId == entity.ParentId &amp;&amp; dto.NodeObjectType == entity.ContainerObjectType));

                    if (parent == null)
                        throw new NullReferenceException(&quot;Could not find parent container with id &quot; + entity.ParentId);

                    nodeDto.Level = Convert.ToInt16(parent.Level + 1);
                    nodeDto.Path = parent.Path + &quot;,&quot; + nodeDto.NodeId;
                }
                nodeDto.ParentId = entity.ParentId;
            }

            // note: sortOrder is NOT managed and always zero for containers

            // update
            Database.Update(nodeDto);
            
            // refresh the entity
            entity.Path = nodeDto.Path;
            entity.Level = nodeDto.Level;
            entity.SortOrder = 0;
            entity.ResetDirtyProperties();
        }

        private void EnsureContainerType(EntityContainer entity)
        {
            if (entity.ContainerObjectType != NodeObjectTypeId)
            {
                throw new InvalidOperationException(&quot;The container type does not match the repository object type&quot;);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,15,24,51,1],[25,9,25,10,1],[26,13,26,184,1],[27,13,27,56,1],[28,13,28,75,1],[29,17,29,114,0],[30,9,30,10,1],[37,17,37,18,1],[37,19,37,50,1],[37,51,37,52,1],[41,9,41,10,1],[42,13,42,123,1],[44,13,44,97,1],[45,13,45,67,1],[46,9,46,10,1],[50,9,50,10,0],[51,13,51,94,0],[53,13,53,73,0],[54,13,54,67,0],[55,9,55,10,0],[58,9,58,10,0],[59,13,59,181,0],[60,13,60,70,0],[61,9,61,10,0],[64,9,64,10,1],[65,13,65,27,1],[66,13,66,14,0],[68,17,69,17,0],[69,17,69,18,0],[69,18,70,21,0],[70,21,72,121,0],[72,121,74,21,0],[74,21,74,67,0],[74,67,76,21,0],[76,21,76,78,0],[76,78,77,17,0],[77,17,77,18,0],[77,18,77,20,0],[68,17,77,20,0],[80,13,80,14,1],[81,17,82,113,1],[83,17,83,63,1],[84,17,84,74,1],[86,9,86,10,1],[89,9,89,10,0],[90,13,90,49,0],[94,9,94,10,1],[95,13,95,58,1],[96,17,96,112,0],[99,13,99,108,1],[101,13,104,52,1],[108,13,108,48,1],[110,13,110,27,1],[111,9,111,10,1],[114,9,114,10,1],[115,13,115,33,1],[116,13,116,25,1],[117,13,117,14,0],[118,17,118,65,0],[119,13,119,14,0],[121,13,121,14,1],[122,17,122,58,1],[123,13,123,14,1],[124,13,124,24,1],[125,9,125,10,1],[128,9,128,10,1],[129,13,129,80,1],[130,9,130,10,1],[133,9,133,10,0],[134,13,134,49,0],[139,17,139,18,1],[139,19,139,47,1],[139,48,139,49,1],[143,9,143,10,1],[144,13,144,41,1],[146,13,148,118,1],[150,13,150,33,1],[150,34,150,41,0],[153,13,161,25,1],[163,13,163,20,1],[163,22,163,34,1],[163,35,163,37,1],[163,38,163,47,1],[164,13,164,14,1],[165,17,165,54,1],[166,17,166,43,1],[167,13,167,14,1],[170,13,170,38,1],[171,9,171,10,1],[174,9,174,10,1],[175,13,175,41,1],[177,13,177,46,1],[178,13,178,73,1],[181,13,183,153,1],[184,13,184,33,1],[185,17,185,103,0],[188,13,188,27,1],[189,13,189,29,1],[190,13,190,38,1],[191,13,191,14,1],[192,17,194,128,1],[196,17,196,39,1],[197,21,197,116,0],[199,17,199,41,1],[200,17,200,39,1],[201,13,201,14,1],[205,13,216,15,1],[219,13,219,64,1],[220,13,220,64,1],[221,13,221,36,1],[224,13,224,28,1],[225,13,225,40,1],[226,13,226,42,1],[227,13,227,34,1],[228,13,228,52,1],[229,13,229,43,1],[230,9,230,10,1],[235,9,235,10,0],[236,13,236,41,0],[238,13,238,46,0],[239,13,239,73,0],[242,13,244,118,0],[245,13,245,33,0],[246,17,246,102,0],[249,13,251,153,0],[252,13,252,75,0],[253,17,253,103,0],[256,13,256,40,0],[257,13,257,53,0],[258,13,258,14,0],[259,17,259,35,0],[260,17,260,37,0],[261,17,261,42,0],[262,17,262,18,0],[263,21,265,132,0],[267,21,267,40,0],[268,25,268,120,0],[270,21,270,71,0],[271,21,271,71,0],[272,17,272,18,0],[273,17,273,52,0],[274,13,274,14,0],[279,13,279,38,0],[282,13,282,40,0],[283,13,283,42,0],[284,13,284,34,0],[285,13,285,43,0],[286,9,286,10,0],[289,9,289,10,1],[290,13,290,64,1],[291,13,291,14,0],[292,17,292,117,0],[294,9,294,10,1]]);
    </script>
  </body>
</html>