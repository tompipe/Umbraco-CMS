<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\EntityBase\Entity.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.IO;
using System.Reflection;
using System.Runtime.Serialization;
using System.Runtime.Serialization.Formatters.Binary;
using System.Text;

namespace Umbraco.Core.Models.EntityBase
{
    /// &lt;summary&gt;
    /// Base Abstract Entity
    /// &lt;/summary&gt;
    [Serializable]
    [DataContract(IsReference = true)]
    [DebuggerDisplay(&quot;Id: {Id}&quot;)]
    public abstract class Entity : TracksChangesEntityBase, IEntity, IRememberBeingDirty, ICanBeDirty
    {
        private bool _hasIdentity;
        private int _id;
        private Guid _key;
        private DateTime _createDate;
        private DateTime _updateDate;
        private bool _wasCancelled;

        private static readonly Lazy&lt;PropertySelectors&gt; Ps = new Lazy&lt;PropertySelectors&gt;();

        private class PropertySelectors
        {
            public readonly PropertyInfo IdSelector = ExpressionHelper.GetPropertyInfo&lt;Entity, int&gt;(x =&gt; x.Id);
            public readonly PropertyInfo KeySelector = ExpressionHelper.GetPropertyInfo&lt;Entity, Guid&gt;(x =&gt; x.Key);
            public readonly PropertyInfo CreateDateSelector = ExpressionHelper.GetPropertyInfo&lt;Entity, DateTime&gt;(x =&gt; x.CreateDate);
            public readonly PropertyInfo UpdateDateSelector = ExpressionHelper.GetPropertyInfo&lt;Entity, DateTime&gt;(x =&gt; x.UpdateDate);
            public readonly PropertyInfo HasIdentitySelector = ExpressionHelper.GetPropertyInfo&lt;Entity, bool&gt;(x =&gt; x.HasIdentity);
            public readonly PropertyInfo WasCancelledSelector = ExpressionHelper.GetPropertyInfo&lt;Entity, bool&gt;(x =&gt; x.WasCancelled);
        }

        /// &lt;summary&gt;
        /// Integer Id
        /// &lt;/summary&gt;
        [DataMember]
        public int Id
        {
            get { return _id; }
            set
            {
                SetPropertyValueAndDetectChanges(value, ref _id, Ps.Value.IdSelector);
                HasIdentity = true; //set the has Identity
            }
        }
        
        /// &lt;summary&gt;
        /// Guid based Id
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;The key is currectly used to store the Unique Id from the 
        /// umbracoNode table, which many of the entities are based on.&lt;/remarks&gt;
        [DataMember]
        public Guid Key
        {
            get
            {
                // if an entity does NOT have a UniqueId yet, assign one now
                if (_key == Guid.Empty)
                    _key = Guid.NewGuid();
                return _key;
            }
            set { SetPropertyValueAndDetectChanges(value, ref _key, Ps.Value.KeySelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the Created Date
        /// &lt;/summary&gt;
        [DataMember]
        public DateTime CreateDate
        {
            get { return _createDate; }
            set { SetPropertyValueAndDetectChanges(value, ref _createDate, Ps.Value.CreateDateSelector); }            
        }

        /// &lt;summary&gt;
        /// Gets or sets the WasCancelled flag, which is used to track
        /// whether some action against an entity was cancelled through some event.
        /// This only exists so we have a way to check if an event was cancelled through
        /// the new api, which also needs to take effect in the legacy api.
        /// &lt;/summary&gt;
        [IgnoreDataMember]
        [Obsolete(&quot;Anytime there&#39;s a cancellable method it needs to return an Attempt so we know the outcome instead of this hack, not all services have been updated to use this though yet.&quot;)]
        internal bool WasCancelled
        {
            get { return _wasCancelled; }
            set { SetPropertyValueAndDetectChanges(value, ref _wasCancelled, Ps.Value.WasCancelledSelector); }            
        }

        /// &lt;summary&gt;
        /// Gets or sets the Modified Date
        /// &lt;/summary&gt;
        [DataMember]
        public DateTime UpdateDate
        {
            get { return _updateDate; }
            set { SetPropertyValueAndDetectChanges(value, ref _updateDate, Ps.Value.UpdateDateSelector); }           
        }

        internal virtual void ResetIdentity()
        {
            _hasIdentity = false;
            _id = default(int);
            _key = Guid.Empty;
        }

        /// &lt;summary&gt;
        /// Method to call on entity saved when first added
        /// &lt;/summary&gt;
        internal virtual void AddingEntity()
        {
            CreateDate = DateTime.Now;
            UpdateDate = DateTime.Now;
        }

        /// &lt;summary&gt;
        /// Method to call on entity saved/updated
        /// &lt;/summary&gt;
        internal virtual void UpdatingEntity()
        {
            UpdateDate = DateTime.Now;
        }

        /// &lt;summary&gt;
        /// Indicates whether the current entity has an identity, eg. Id.
        /// &lt;/summary&gt;
        [DataMember]
        public virtual bool HasIdentity
        {
            get
            {
                return _hasIdentity;
            }
            protected set { SetPropertyValueAndDetectChanges(value, ref _hasIdentity, Ps.Value.HasIdentitySelector); }
        }

        //TODO: Make this NOT virtual or even exist really!
        public virtual bool SameIdentityAs(IEntity other)
        {
            if (ReferenceEquals(null, other))
                return false;
            if (ReferenceEquals(this, other))
                return true;

            return SameIdentityAs(other as Entity);
        }

        public virtual bool Equals(Entity other)
        {
            if (ReferenceEquals(null, other))
                return false;
            if (ReferenceEquals(this, other))
                return true;

            return SameIdentityAs(other);
        }

        //TODO: Make this NOT virtual or even exist really!
        public virtual Type GetRealType()
        {
            return GetType();
        }

        //TODO: Make this NOT virtual or even exist really!
        public virtual bool SameIdentityAs(Entity other)
        {
            if (ReferenceEquals(null, other))
                return false;

            if (ReferenceEquals(this, other))
                return true;

            if (GetType() == other.GetRealType() &amp;&amp; HasIdentity &amp;&amp; other.HasIdentity)
                return other.Id.Equals(Id);

            return false;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
                return false;
            if (ReferenceEquals(this, obj))
                return true;

            return SameIdentityAs(obj as IEntity);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = HasIdentity.GetHashCode();
                hashCode = (hashCode * 397) ^ Id;
                hashCode = (hashCode * 397) ^ GetType().GetHashCode();
                return hashCode;
            }
        }

        public virtual object DeepClone()
        {
            //Memberwise clone on Entity will work since it doesn&#39;t have any deep elements
            // for any sub class this will work for standard properties as well that aren&#39;t complex object&#39;s themselves.
            var ignored = this.Key; // ensure that &#39;this&#39; has a key, before cloning
            var clone = (Entity)MemberwiseClone();
            //ensure the clone has it&#39;s own dictionaries
            clone.ResetChangeTrackingCollections();
            //turn off change tracking
            clone.DisableChangeTracking();
            //Automatically deep clone ref properties that are IDeepCloneable
            DeepCloneHelper.DeepCloneRefProperties(this, clone);
            //this shouldn&#39;t really be needed since we&#39;re not tracking
            clone.ResetDirtyProperties(false);
            //re-enable tracking
            clone.EnableChangeTracking();

            return clone;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,92,1],[30,13,30,112,1],[31,13,31,115,1],[32,13,32,133,1],[33,13,33,133,1],[34,13,34,131,1],[35,13,35,133,1],[44,17,44,18,1],[44,19,44,30,1],[44,31,44,32,1],[46,13,46,14,1],[47,17,47,87,1],[48,17,48,36,1],[49,13,49,14,1],[61,13,61,14,1],[63,17,63,40,1],[64,21,64,43,1],[65,17,65,29,1],[66,13,66,14,1],[67,17,67,18,1],[67,19,67,91,1],[67,92,67,93,1],[76,17,76,18,1],[76,19,76,38,1],[76,39,76,40,1],[77,17,77,18,1],[77,19,77,105,1],[77,106,77,107,1],[90,17,90,18,1],[90,19,90,40,1],[90,41,90,42,1],[91,17,91,18,0],[91,19,91,109,0],[91,110,91,111,0],[100,17,100,18,1],[100,19,100,38,1],[100,39,100,40,1],[101,17,101,18,1],[101,19,101,105,1],[101,106,101,107,1],[105,9,105,10,1],[106,13,106,34,1],[107,13,107,32,1],[108,13,108,31,1],[109,9,109,10,1],[115,9,115,10,1],[116,13,116,39,1],[117,13,117,39,1],[118,9,118,10,1],[124,9,124,10,1],[125,13,125,39,1],[126,9,126,10,1],[135,13,135,14,1],[136,17,136,37,1],[137,13,137,14,1],[138,27,138,28,1],[138,29,138,117,1],[138,118,138,119,1],[143,9,143,10,1],[144,13,144,46,1],[145,17,145,30,1],[146,13,146,46,1],[147,17,147,29,0],[149,13,149,52,1],[150,9,150,10,1],[153,9,153,10,1],[154,13,154,46,1],[155,17,155,30,0],[156,13,156,46,1],[157,17,157,29,1],[159,13,159,42,1],[160,9,160,10,1],[164,9,164,10,1],[165,13,165,30,1],[166,9,166,10,1],[170,9,170,10,1],[171,13,171,46,1],[172,17,172,30,0],[174,13,174,46,1],[175,17,175,29,0],[177,13,177,86,1],[178,17,178,44,1],[180,13,180,26,1],[181,9,181,10,1],[184,9,184,10,1],[185,13,185,44,1],[186,17,186,30,0],[187,13,187,44,1],[188,17,188,29,1],[190,13,190,51,1],[191,9,191,10,1],[194,9,194,10,1],[196,13,196,14,1],[197,17,197,58,1],[198,17,198,50,1],[199,17,199,71,1],[200,17,200,33,1],[202,9,202,10,1],[205,9,205,10,1],[208,13,208,36,1],[209,13,209,51,1],[211,13,211,52,1],[213,13,213,43,1],[215,13,215,65,1],[217,13,217,47,1],[219,13,219,42,1],[221,13,221,26,1],[222,9,222,10,1]]);
    </script>
  </body>
</html>