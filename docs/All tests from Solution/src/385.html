<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Migrations\FindingMigrationsTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Profiling;
using Umbraco.Core.Services;
using Umbraco.Tests.Migrations.Stubs;

namespace Umbraco.Tests.Migrations
{
    [TestFixture]
    public class FindingMigrationsTest
    {
        [SetUp]
        public void Initialize()
        {
            MigrationResolver.Current = new MigrationResolver(
                Mock.Of&lt;ILogger&gt;(),
                () =&gt; new List&lt;Type&gt;
				{
					typeof (AlterUserTableMigrationStub),
					typeof(Dummy),
					typeof (SixZeroMigration1),					
					typeof (SixZeroMigration2),
					typeof (FourElevenMigration),
                    typeof (FiveZeroMigration)                   
				});

            var sqlSyntax = new SqlCeSyntaxProvider();

            //This is needed because the Migration resolver is creating migration instances with their full ctors
            ApplicationContext.EnsureContext(
                new ApplicationContext(
                    new DatabaseContext(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), sqlSyntax, &quot;test&quot;),
                    new ServiceContext(), 
                    CacheHelper.CreateDisabledCacheHelper(),
                    new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;())),  
                true);

            //This is needed because the Migration resolver is creating the migration instances with their full ctors
            LoggerResolver.Current = new LoggerResolver(Mock.Of&lt;ILogger&gt;())
            {
                CanResolveBeforeFrozen = true
            };
           
			Resolution.Freeze();
            
        }

        [Test]
        public void Can_Find_Migrations_With_Target_Version_Six()
        {
	        var foundMigrations = MigrationResolver.Current.Migrations;
            var targetVersion = new Version(&quot;6.0.0&quot;);
            var list = new List&lt;IMigration&gt;();

            foreach (var migration in foundMigrations)
            {
                var migrationAttribute = migration.GetType().FirstAttribute&lt;MigrationAttribute&gt;();
                if (migrationAttribute != null)
                {
                    if (migrationAttribute.TargetVersion == targetVersion)
                    {
                        list.Add(migration);
                    }
                }
            }

            Assert.That(list.Count, Is.EqualTo(3));

            var context = new MigrationContext(DatabaseProviders.SqlServerCE, null, Mock.Of&lt;ILogger&gt;());
            foreach (var migration1 in list)
            {
                var migration = (MigrationBase) migration1;
                migration.GetUpExpressions(context);
            }

            Assert.That(context.Expressions.Any(), Is.True);

            //Console output
            foreach (var expression in context.Expressions)
            {
                Debug.Print(expression.ToString());
            }
        }

        [TearDown]
        public void TearDown()
        {	        
            LoggerResolver.Reset();
            MigrationResolver.Reset();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,1],[25,13,27,23,1],[27,23,35,6,1],[35,6,35,8,1],[25,13,35,8,1],[37,13,37,55,1],[40,13,46,23,1],[49,13,52,15,1],[54,4,54,24,1],[56,9,56,10,1],[60,9,60,10,1],[61,10,61,69,1],[62,13,62,54,1],[63,13,63,47,1],[65,13,65,20,1],[65,22,65,35,1],[65,36,65,38,1],[65,39,65,54,1],[66,13,66,14,1],[67,17,67,99,1],[68,17,68,48,1],[69,17,69,18,1],[70,21,70,75,1],[71,21,71,22,1],[72,25,72,45,1],[73,21,73,22,1],[74,17,74,18,1],[75,13,75,14,1],[77,13,77,52,1],[79,13,79,105,1],[80,13,80,20,1],[80,22,80,36,1],[80,37,80,39,1],[80,40,80,44,1],[81,13,81,14,1],[82,17,82,60,1],[83,17,83,53,1],[84,13,84,14,1],[86,13,86,61,1],[89,13,89,20,1],[89,22,89,36,1],[89,37,89,39,1],[89,40,89,59,1],[90,13,90,14,1],[91,17,91,52,1],[92,13,92,14,1],[93,9,93,10,1],[97,9,97,10,1],[98,13,98,36,1],[99,13,99,39,1],[100,9,100,10,1]]);
    </script>
  </body>
</html>