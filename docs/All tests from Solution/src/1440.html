<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Xml\UmbracoXPathPathSyntaxParser.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Umbraco.Core.Xml
{
    /// &lt;summary&gt;
    /// This is used to parse our customize Umbraco XPath expressions (i.e. that include special tokens like $site) into 
    /// a real XPath statement
    /// &lt;/summary&gt;
    internal class UmbracoXPathPathSyntaxParser
    {
        /// &lt;summary&gt;
        /// Parses custom umbraco xpath expression
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xpathExpression&quot;&gt;The Xpath expression&lt;/param&gt;
        /// &lt;param name=&quot;nodeContextId&quot;&gt;
        /// The current node id context of executing the query - null if there is no current node, in which case
        /// some of the parameters like $current, $parent, $site will be disabled
        /// &lt;/param&gt;
        /// &lt;param name=&quot;getPath&quot;&gt;The callback to create the nodeId path, given a node Id&lt;/param&gt;
        /// &lt;param name=&quot;publishedContentExists&quot;&gt;The callback to return whether a published node exists based on Id&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string ParseXPathQuery(
            string xpathExpression, 
            int? nodeContextId, 
            Func&lt;int, IEnumerable&lt;string&gt;&gt; getPath,
            Func&lt;int, bool&gt; publishedContentExists)
        {

            //TODO: This should probably support some of the old syntax and token replacements, currently 
            // it does not, there is a ticket raised here about it: http://issues.umbraco.org/issue/U4-6364
            // previous tokens were: &quot;$currentPage&quot;, &quot;$ancestorOrSelf&quot;, &quot;$parentPage&quot; and I beleive they were 
            // allowed &#39;inline&#39;, not just at the beginning... whether or not we want to support that is up 
            // for discussion.

            Mandate.ParameterNotNullOrEmpty(xpathExpression, &quot;xpathExpression&quot;);
            Mandate.ParameterNotNull(getPath, &quot;getPath&quot;);
            Mandate.ParameterNotNull(publishedContentExists, &quot;publishedContentExists&quot;);

            //no need to parse it
            if (xpathExpression.StartsWith(&quot;$&quot;) == false)
                return xpathExpression;

            //get nearest published item
            Func&lt;IEnumerable&lt;string&gt;, int&gt; getClosestPublishedAncestor = (path =&gt;
            {
                foreach (var i in path)
                {
                    int idAsInt;
                    if (int.TryParse(i, out idAsInt))
                    {
                        var exists = publishedContentExists(int.Parse(i));
                        if (exists)
                            return idAsInt;
                    }
                }
                return -1;
            });

            const string rootXpath = &quot;descendant::*[@id={0}]&quot;;

            //parseable items:
            var vars = new Dictionary&lt;string, Func&lt;string, string&gt;&gt;();

            //These parameters must have a node id context
            if (nodeContextId.HasValue)
            {
                vars.Add(&quot;$current&quot;, q =&gt;
                {
                    var closestPublishedAncestorId = getClosestPublishedAncestor(getPath(nodeContextId.Value));
                    return q.Replace(&quot;$current&quot;, string.Format(rootXpath, closestPublishedAncestorId));
                });

                vars.Add(&quot;$parent&quot;, q =&gt;
                {
                    //remove the first item in the array if its the current node
                    //this happens when current is published, but we are looking for its parent specifically
                    var path = getPath(nodeContextId.Value).ToArray();
                    if (path[0] == nodeContextId.ToString())
                    {
                        path = path.Skip(1).ToArray();
                    }

                    var closestPublishedAncestorId = getClosestPublishedAncestor(path);
                    return q.Replace(&quot;$parent&quot;, string.Format(rootXpath, closestPublishedAncestorId));
                });


                vars.Add(&quot;$site&quot;, q =&gt;
                {
                    var closestPublishedAncestorId = getClosestPublishedAncestor(getPath(nodeContextId.Value));
                    return q.Replace(&quot;$site&quot;, string.Format(rootXpath, closestPublishedAncestorId) + &quot;/ancestor-or-self::*[@level = 1]&quot;);
                });
            }

            //TODO: This used to just replace $root with string.Empty BUT, that would never work
            // the root is always &quot;/root . Need to confirm with Per why this was string.Empty before!
            vars.Add(&quot;$root&quot;, q =&gt; q.Replace(&quot;$root&quot;, &quot;/root&quot;));


            foreach (var varible in vars)
            {
                if (xpathExpression.StartsWith(varible.Key))
                {
                    xpathExpression = varible.Value(xpathExpression);
                    break;
                }
            }

            return xpathExpression;
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,10,0],[39,13,39,81,0],[40,13,40,58,0],[41,13,41,88,0],[44,13,44,58,0],[45,17,45,40,0],[48,13,49,13,0],[49,13,49,14,0],[49,14,50,17,0],[50,17,50,24,0],[50,24,50,26,0],[50,26,50,31,0],[50,31,50,32,0],[50,32,50,34,0],[50,34,50,35,0],[50,35,50,39,0],[50,39,51,17,0],[51,17,51,18,0],[51,18,53,21,0],[53,21,53,54,0],[53,54,54,21,0],[54,21,54,22,0],[54,22,55,25,0],[55,25,55,75,0],[55,75,56,25,0],[56,25,56,36,0],[56,36,57,29,0],[57,29,57,44,0],[57,44,58,21,0],[58,21,58,22,0],[58,22,59,17,0],[59,17,59,18,0],[59,18,60,17,0],[60,17,60,27,0],[60,27,61,13,0],[61,13,61,14,0],[61,14,61,16,0],[48,13,61,16,0],[66,13,66,71,0],[69,13,69,40,0],[70,13,70,14,0],[71,17,72,17,0],[72,17,72,18,0],[72,18,73,21,0],[73,21,73,112,0],[73,112,74,21,0],[74,21,74,104,0],[74,104,75,17,0],[75,17,75,18,0],[75,18,75,20,0],[71,17,75,20,0],[77,17,78,17,0],[78,17,78,18,0],[78,18,81,21,0],[81,21,81,71,0],[81,71,82,21,0],[82,21,82,61,0],[82,61,83,21,0],[83,21,83,22,0],[83,22,84,25,0],[84,25,84,55,0],[84,55,85,21,0],[85,21,85,22,0],[85,22,87,21,0],[87,21,87,88,0],[87,88,88,21,0],[88,21,88,103,0],[88,103,89,17,0],[89,17,89,18,0],[89,18,89,20,0],[77,17,89,20,0],[92,17,93,17,0],[93,17,93,18,0],[93,18,94,21,0],[94,21,94,112,0],[94,112,95,21,0],[95,21,95,138,0],[95,138,96,17,0],[96,17,96,18,0],[96,18,96,20,0],[92,17,96,20,0],[97,13,97,14,0],[101,13,101,36,0],[101,36,101,63,0],[101,63,101,65,0],[101,13,101,65,0],[104,13,104,20,0],[104,22,104,33,0],[104,34,104,36,0],[104,37,104,41,0],[105,13,105,14,0],[106,17,106,61,0],[107,17,107,18,0],[108,21,108,70,0],[109,21,109,27,0],[111,13,111,14,0],[113,13,113,36,0],[114,9,114,10,0]]);
    </script>
  </body>
</html>