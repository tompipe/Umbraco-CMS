<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\controls\macroParameterControl.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Text;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using umbraco.cms.businesslogic.macro;
using System.Reflection;
using System.Collections;

namespace umbraco.controls
{
    [DefaultProperty(&quot;Text&quot;)]
    [ToolboxData(&quot;&lt;{0}:macroParameterControl runat=server&gt;&lt;/{0}:macroParameterControl&gt;&quot;)]
    public class macroParameterControl : WebControl
    {
        #region private variables

        private Macro m_macro = null;
        private bool m_parameterValuesEnsured = false;
        private Hashtable m_parameterValues = new Hashtable();
        #endregion

        /// &lt;summary&gt;
        /// Gets the parameter values.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The parameter values.&lt;/value&gt;
        public Hashtable ParameterValues
        {
            get {
                ensureMacroParameterList();
                return m_parameterValues; }
            set { m_parameterValues = value; }
        }

        [Bindable(true)]
        [Category(&quot;Umbraco&quot;)]
        [DefaultValue(&quot;&quot;)]
        [Localizable(true)]
        public string MacroAlias
        {
            get
            {
                String s = (String)ViewState[&quot;MacroAlias&quot;];
                return ((s == null) ? String.Empty : s);
            }

            set
            {
                ViewState[&quot;MacroAlias&quot;] = value;
            }
        }

        /// &lt;summary&gt;
        /// Updates the macro parameter.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;The alias.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value.&lt;/param&gt;
        public void UpdateParameter(string alias, string value)
        {
            if (!m_parameterValues.ContainsKey(alias))
            {
                m_parameterValues.Add(alias, &quot;&quot;);
            }

            m_parameterValues[alias] = value;
        }

        /// &lt;summary&gt;
        /// Gets the macro tag.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The correct syntax for the macro including all parameters&lt;/returns&gt;
        public string GetMacroTag() {
            string tag = &quot;&quot;;
            if (UmbracoConfig.For.UmbracoSettings().Templates.UseAspNetMasterPages)
            {
                tag = &quot;&lt;umbraco:Macro runat=\&quot;server\&quot;&quot;;
            }
            else
            {
                tag = &quot;&lt;?UMBRACO_MACRO&quot;;
            }
            tag += String.Format(&quot; macroAlias=\&quot;{0}\&quot;&quot;, MacroAlias);

            IDictionaryEnumerator ide = ParameterValues.GetEnumerator();
            while (ide.MoveNext())
            {
                tag += String.Format(&quot; {0}=\&quot;{1}\&quot;&quot;, ide.Key.ToString(), ide.Value.ToString());
            }

            tag += &quot; /&gt;&quot;;
            return tag;
        }

        private void ensureMacroParameterList()
        {
            if (!m_parameterValuesEnsured)
            {
                foreach (MacroProperty mp in m_macro.Properties)
                {
                    if (!m_parameterValues.ContainsKey(mp.Alias))
                        m_parameterValues.Add(mp.Alias, &quot;&quot;);
                    m_parameterValues[mp.Alias] = (((umbraco.interfaces.IMacroGuiRendering)this.FindControl(mp.Alias)).Value);
                }
                m_parameterValuesEnsured = true;
            }
        }

        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            loadMacro();

            AddParameterControls();

        }

        private void AddParameterControls()
        {
            Controls.Add(new LiteralControl(&quot;&lt;table border=\&quot;0\&quot; cellspacing=\&quot;0\&quot; cellpadding=\&quot;0\&quot;&gt;&quot;));
            foreach (MacroProperty mp in m_macro.Properties)
            {
                string macroAssembly = mp.Type.Assembly;
                string macroType = mp.Type.Type;
                try
                {

                    Assembly assembly = Assembly.LoadFrom( IOHelper.MapPath(SystemDirectories.Bin + &quot;/&quot; + macroAssembly + &quot;.dll&quot;));

                    Type type = assembly.GetType(macroAssembly + &quot;.&quot; + macroType);
                    var typeInstance = Activator.CreateInstance(type) as interfaces.IMacroGuiRendering;
                    if (typeInstance != null)
                    {
                        ((Control) typeInstance).ID = mp.Alias;
                        if (!Page.IsPostBack)
                        {
                            if (m_parameterValues.ContainsKey(mp.Alias))
                            {
                                typeInstance.Value = m_parameterValues[mp.Alias].ToString();
                            }
                            else
                            {
                                m_parameterValues.Add(mp.Alias, typeInstance.Value);
                            }
                        }

                        // register alias
                        //                        Controls.Add(new LiteralControl(&quot;&lt;script&gt;\nregisterAlias(&#39;&quot; + control.ID + &quot;&#39;);\n&lt;/script&gt;&quot;));
                        Controls.Add(new LiteralControl(&quot;&lt;tr&gt;&lt;th class=\&quot;propertyHeader\&quot; width=\&quot;30%\&quot;&gt;&quot; + mp.Name + &quot;&lt;/td&gt;&lt;td class=\&quot;propertyContent\&quot;&gt;&quot;));
                        Controls.Add((Control) typeInstance);
                        Controls.Add(new LiteralControl(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;));
                    }
                }
                catch (Exception)
                {
                }
            }
            Controls.Add(new LiteralControl(&quot;&lt;/table&gt;&quot;));
        }

        private void loadMacro()
        {
            if (m_macro == null &amp;&amp; MacroAlias != &quot;&quot;)
            {
                m_macro = Macro.GetByAlias(MacroAlias);
                if (m_macro == null)
                {
                    throw new ArgumentException(String.Format(&quot;No macro with alias &#39;{0}&#39; found&quot;, MacroAlias));
                }
            }
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,38,0],[23,9,23,55,0],[24,9,24,63,0],[33,17,33,18,0],[34,17,34,44,0],[35,17,35,42,0],[35,43,35,44,0],[36,17,36,18,0],[36,19,36,45,0],[36,46,36,47,0],[46,13,46,14,0],[47,17,47,60,0],[48,17,48,57,0],[49,13,49,14,0],[52,13,52,14,0],[53,17,53,49,0],[54,13,54,14,0],[63,9,63,10,0],[64,13,64,55,0],[65,13,65,14,0],[66,17,66,50,0],[67,13,67,14,0],[69,13,69,46,0],[70,9,70,10,0],[76,37,76,38,0],[77,13,77,29,0],[78,13,78,84,0],[79,13,79,14,0],[80,17,80,57,0],[81,13,81,14,0],[83,13,83,14,0],[84,17,84,41,0],[85,13,85,14,0],[86,13,86,69,0],[88,13,88,73,0],[89,13,89,35,0],[90,13,90,14,0],[91,17,91,96,0],[92,13,92,14,0],[94,13,94,26,0],[95,13,95,24,0],[96,9,96,10,0],[99,9,99,10,0],[100,13,100,43,0],[101,13,101,14,0],[102,17,102,24,0],[102,26,102,42,0],[102,43,102,45,0],[102,46,102,64,0],[103,17,103,18,0],[104,21,104,66,0],[105,25,105,61,0],[106,21,106,127,0],[107,17,107,18,0],[108,17,108,49,0],[109,13,109,14,0],[110,9,110,10,0],[113,9,113,10,0],[114,13,114,28,0],[116,13,116,25,0],[118,13,118,36,0],[120,9,120,10,0],[123,9,123,10,0],[124,13,124,106,0],[125,13,125,20,0],[125,22,125,38,0],[125,39,125,41,0],[125,42,125,60,0],[126,13,126,14,0],[127,17,127,57,0],[128,17,128,49,0],[130,17,130,18,0],[132,21,132,132,0],[134,21,134,83,0],[135,21,135,104,0],[136,21,136,46,0],[137,21,137,22,0],[138,25,138,64,0],[139,25,139,46,0],[140,25,140,26,0],[141,29,141,73,0],[142,29,142,30,0],[143,33,143,93,0],[144,29,144,30,0],[146,29,146,30,0],[147,33,147,85,0],[148,29,148,30,0],[149,25,149,26,0],[153,25,153,159,0],[154,25,154,62,0],[155,25,155,72,0],[156,21,156,22,0],[157,17,157,18,0],[158,17,158,34,0],[159,17,159,18,0],[160,17,160,18,0],[161,13,161,14,0],[162,13,162,58,0],[163,9,163,10,0],[166,9,166,10,0],[167,13,167,53,0],[168,13,168,14,0],[169,17,169,56,0],[170,17,170,37,0],[171,17,171,18,0],[172,21,172,111,0],[174,13,174,14,0],[175,9,175,10,0]]);
    </script>
  </body>
</html>