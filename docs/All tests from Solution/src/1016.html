<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\ValueConverters\RelatedLinksEditorValueConvertor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.PublishedContent;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.PropertyEditors.ValueConverters;

namespace Umbraco.Web.PropertyEditors.ValueConverters
{
    [PropertyValueType(typeof(JArray))]
    [PropertyValueCache(PropertyCacheValue.All, PropertyCacheLevel.Content)]
    [DefaultPropertyValueConverter(typeof(JsonValueConverter))] //this shadows the JsonValueConverter
    public class RelatedLinksEditorValueConvertor : PropertyValueConverterBase
    {
        public override bool IsConverter(PublishedPropertyType propertyType)
        {
            return Constants.PropertyEditors.RelatedLinksAlias.Equals(propertyType.PropertyEditorAlias);
        }

        public override object ConvertDataToSource(PublishedPropertyType propertyType, object source, bool preview)
        {
            if (source == null) return null;
            var sourceString = source.ToString();

            if (sourceString.DetectIsJson())
            {
                try
                {
                    var obj = JsonConvert.DeserializeObject&lt;JArray&gt;(sourceString);
                    //update the internal links if we have a context
                    if (UmbracoContext.Current != null)
                    {
                        var helper = new UmbracoHelper(UmbracoContext.Current);
                        foreach (var a in obj)
                        {
                            var type = a.Value&lt;string&gt;(&quot;type&quot;);
                            if (type.IsNullOrWhiteSpace() == false)
                            {
                                if (type == &quot;internal&quot;)
                                {
                                    var linkId = a.Value&lt;int&gt;(&quot;link&quot;);
                                    var link = helper.NiceUrl(linkId);
                                    a[&quot;link&quot;] = link;
                                }
                            }
                        }    
                    }
                    return obj;
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;RelatedLinksEditorValueConvertor&gt;(&quot;Could not parse the string &quot; + sourceString + &quot; to a json object&quot;, ex);
                }
            }

            //it&#39;s not json, just return the string
            return sourceString;
        }

        public override object ConvertSourceToXPath(PublishedPropertyType propertyType, object source, bool preview)
        {
            if (source == null) return null;
            var sourceString = source.ToString();

            if (sourceString.DetectIsJson())
            {
                try
                {
                    var obj = JsonConvert.DeserializeObject&lt;Array&gt;(sourceString);

                    var d = new XmlDocument();
                    var e = d.CreateElement(&quot;links&quot;);
                    d.AppendChild(e);

                    var values = (IEnumerable&lt;string&gt;)source;
                    foreach (dynamic link in obj)
                    {
                        var ee = d.CreateElement(&quot;link&quot;);
                        ee.SetAttribute(&quot;title&quot;, link.title);
                        ee.SetAttribute(&quot;link&quot;, link.link);
                        ee.SetAttribute(&quot;type&quot;, link.type);
                        ee.SetAttribute(&quot;newwindow&quot;, link.newWindow);

                        e.AppendChild(ee);
                    }

                    return d.CreateNavigator();
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;RelatedLinksEditorValueConvertor&gt;(&quot;Could not parse the string &quot; + sourceString + &quot; to a json object&quot;, ex);
                }
            }

            //it&#39;s not json, just return the string
            return sourceString;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,0],[24,13,24,105,0],[25,9,25,10,0],[28,9,28,10,0],[29,13,29,32,0],[29,33,29,45,0],[30,13,30,50,0],[32,13,32,45,0],[33,13,33,14,0],[35,17,35,18,0],[36,21,36,83,0],[38,21,38,56,0],[39,21,39,22,0],[40,25,40,80,0],[41,25,41,32,0],[41,34,41,39,0],[41,40,41,42,0],[41,43,41,46,0],[42,25,42,26,0],[43,29,43,64,0],[44,29,44,68,0],[45,29,45,30,0],[46,33,46,56,0],[47,33,47,34,0],[48,37,48,71,0],[49,37,49,71,0],[50,37,50,54,0],[51,33,51,34,0],[52,29,52,30,0],[53,25,53,26,0],[54,21,54,22,0],[55,21,55,32,0],[57,17,57,37,0],[58,17,58,18,0],[59,21,59,143,0],[60,17,60,18,0],[61,13,61,14,0],[64,13,64,33,0],[65,9,65,10,0],[68,9,68,10,0],[69,13,69,32,0],[69,33,69,45,0],[70,13,70,50,0],[72,13,72,45,0],[73,13,73,14,0],[75,17,75,18,0],[76,21,76,82,0],[78,21,78,47,0],[79,21,79,54,0],[80,21,80,38,0],[82,21,82,62,0],[83,21,83,28,0],[83,30,83,42,0],[83,43,83,45,0],[83,46,83,49,0],[84,21,84,22,0],[85,25,85,58,0],[86,25,86,62,0],[87,25,87,60,0],[88,25,88,60,0],[89,25,89,70,0],[91,25,91,43,0],[92,21,92,22,0],[94,21,94,48,0],[96,17,96,37,0],[97,17,97,18,0],[98,21,98,143,0],[99,17,99,18,0],[100,13,100,14,0],[103,13,103,33,0],[104,9,104,10,0]]);
    </script>
  </body>
</html>