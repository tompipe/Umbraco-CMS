<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Routing\NiceUrlRoutesTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using NUnit.Framework;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web.PublishedCache.XmlPublishedCache;
using Umbraco.Web.Routing;

namespace Umbraco.Tests.Routing
{
    // purpose: test the values returned by PublishedContentCache.GetRouteById
    // and .GetByRoute (no caching at all, just routing nice urls) including all
    // the quirks due to hideTopLevelFromPath and backward compatibility.

    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerFixture)]
    [TestFixture]
    public class NiceUrlRoutesTests : BaseRoutingTest
    {
        #region Test Setup

        protected override void FreezeResolution()
        {
            SiteDomainHelperResolver.Current = new SiteDomainHelperResolver(new SiteDomainHelper());

            base.FreezeResolution();
        }

        private IUmbracoSettingsSection _umbracoSettings;

        public override void Initialize()
        {
            base.Initialize();

            //generate new mock settings and assign so we can configure in individual tests
            _umbracoSettings = SettingsForTests.GenerateMockSettings();
            SettingsForTests.ConfigureSettings(_umbracoSettings);
        }

        protected override string GetXmlContent(int templateId)
        {
            return @&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;
&lt;!DOCTYPE root[
&lt;!ELEMENT Doc ANY&gt;
&lt;!ATTLIST Doc id ID #REQUIRED&gt;
]&gt;
&lt;root id=&quot;&quot;-1&quot;&quot;&gt;
	&lt;Doc id=&quot;&quot;1000&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; path=&quot;&quot;-1,1000&quot;&quot; nodeName=&quot;&quot;A&quot;&quot; urlName=&quot;&quot;a&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
		&lt;Doc id=&quot;&quot;1001&quot;&quot; parentID=&quot;&quot;1000&quot;&quot; level=&quot;&quot;2&quot;&quot; path=&quot;&quot;-1,1000,1001&quot;&quot; nodeName=&quot;&quot;B&quot;&quot; urlName=&quot;&quot;b&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
		    &lt;Doc id=&quot;&quot;1002&quot;&quot; parentID=&quot;&quot;1001&quot;&quot; level=&quot;&quot;3&quot;&quot; path=&quot;&quot;-1,1000,1001,1002&quot;&quot; nodeName=&quot;&quot;C&quot;&quot; urlName=&quot;&quot;c&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
		        &lt;Doc id=&quot;&quot;1003&quot;&quot; parentID=&quot;&quot;1002&quot;&quot; level=&quot;&quot;4&quot;&quot; path=&quot;&quot;-1,1000,1001,1002,1003&quot;&quot; nodeName=&quot;&quot;D&quot;&quot; urlName=&quot;&quot;d&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
                &lt;/Doc&gt;
            &lt;/Doc&gt;
        &lt;/Doc&gt;
    &lt;/Doc&gt;
	&lt;Doc id=&quot;&quot;2000&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; path=&quot;&quot;-1,2000&quot;&quot; nodeName=&quot;&quot;X&quot;&quot; urlName=&quot;&quot;x&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
	    &lt;Doc id=&quot;&quot;2001&quot;&quot; parentID=&quot;&quot;2000&quot;&quot; level=&quot;&quot;2&quot;&quot; path=&quot;&quot;-1,2000,2001&quot;&quot; nodeName=&quot;&quot;Y&quot;&quot; urlName=&quot;&quot;y&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
	        &lt;Doc id=&quot;&quot;2002&quot;&quot; parentID=&quot;&quot;2001&quot;&quot; level=&quot;&quot;3&quot;&quot; path=&quot;&quot;-1,2000,2001,2002&quot;&quot; nodeName=&quot;&quot;Z&quot;&quot; urlName=&quot;&quot;z&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
            &lt;/Doc&gt;
        &lt;/Doc&gt;
	    &lt;Doc id=&quot;&quot;2003&quot;&quot; parentID=&quot;&quot;2000&quot;&quot; level=&quot;&quot;2&quot;&quot; path=&quot;&quot;-1,2000,2003&quot;&quot; nodeName=&quot;&quot;A&quot;&quot; urlName=&quot;&quot;a&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
        &lt;/Doc&gt;
	    &lt;Doc id=&quot;&quot;2004&quot;&quot; parentID=&quot;&quot;2000&quot;&quot; level=&quot;&quot;2&quot;&quot; path=&quot;&quot;-1,2000,2004&quot;&quot; nodeName=&quot;&quot;B&quot;&quot; urlName=&quot;&quot;b&quot;&quot; sortOrder=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
	        &lt;Doc id=&quot;&quot;2005&quot;&quot; parentID=&quot;&quot;2004&quot;&quot; level=&quot;&quot;3&quot;&quot; path=&quot;&quot;-1,2000,2004,2005&quot;&quot; nodeName=&quot;&quot;C&quot;&quot; urlName=&quot;&quot;c&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
            &lt;/Doc&gt;
	        &lt;Doc id=&quot;&quot;2006&quot;&quot; parentID=&quot;&quot;2004&quot;&quot; level=&quot;&quot;3&quot;&quot; path=&quot;&quot;-1,2000,2004,2006&quot;&quot; nodeName=&quot;&quot;E&quot;&quot; urlName=&quot;&quot;e&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
            &lt;/Doc&gt;
        &lt;/Doc&gt;
    &lt;/Doc&gt;
&lt;/root&gt;&quot;;
        }

        #endregion

        /*
         * Just so it&#39;s documented somewhere, as of jan. 2017, routes obey the following pseudo-code:

GetByRoute(route, hide = null):

	route is &quot;[id]/[path]&quot;

	hide = hide ?? global.hide

	root = id ? node(id) : document

	content = cached(route) ?? DetermineIdByRoute(route, hide)

	# route is &quot;1234/path/to/content&quot;, finds &quot;content&quot;
	# but if there is domain 5678 on &quot;to&quot;, the *true* route of &quot;content&quot; is &quot;5678/content&quot;
	# so although the route does match, we don&#39;t cache it
	# there are not other reason not to cache it

	if content and no domain between root and content:
		cache route (as trusted)

	return content


DetermineIdByRoute(route, hide):

	route is &quot;[id]/[path]&quot;

	try return NavigateRoute(id ?? 0, path, hide:hide)
	return null


NavigateRoute(id, path, hide):

	if path:
		if id:
			start = node(id)
		else:
			start = document

		# &#39;navigate ... from ...&#39; uses lowest sortOrder in case of collision

		if hide and ![id]:
			# if hiding, then for &quot;/foo&quot; we want to look for &quot;/[any]/foo&quot;
			for each child of start:
				try return navigate path from child

			# but if it fails, we also want to try &quot;/foo&quot;
			# fail now if more than one part eg &quot;/foo/bar&quot;
			if path is &quot;/[any]/...&quot;:
				fail

		try return navigate path from start

	else:
		if id:
			return node(id)
		else:
			return root node with lowest sortOrder


GetRouteById(id):


    route = cached(id)
	if route:
		return route

	# never cache the route, it may be colliding

	route = DetermineRouteById(id)
    if route:
        cache route (as not trusted)

    return route



DetermineRouteById(id):


    node = node(id)

    walk up from node to domain or root, assemble parts = url segments

	if !domain and global.hide:
		if id.parent:
			# got /top/[path]content, can remove /top
			remove top part
		else:
			# got /content, should remove only if it is the
			# node with lowest sort order
			root = root node with lowest sortOrder
			if root == node:
				remove top part

    compose path from parts
    route = assemble &quot;[domain.id]/[path]&quot;
	return route

         */

        /*
         * The Xml structure for the following tests is:
         *
         * root
         *   A 1000
         *     B 1001
         *       C 1002
         *         D 1003
         *   X 2000
         *     Y 2001
         *       Z 2002
         *     A 2003
         *     B 2004
         *       C 2005
         *       E 2006
         *
         */

        [TestCase(1000, false, &quot;/a&quot;)]
        [TestCase(1001, false, &quot;/a/b&quot;)]
        [TestCase(1002, false, &quot;/a/b/c&quot;)]
        [TestCase(1003, false, &quot;/a/b/c/d&quot;)]
        [TestCase(2000, false, &quot;/x&quot;)]
        [TestCase(2001, false, &quot;/x/y&quot;)]
        [TestCase(2002, false, &quot;/x/y/z&quot;)]
        [TestCase(2003, false, &quot;/x/a&quot;)]
        [TestCase(2004, false, &quot;/x/b&quot;)]
        [TestCase(2005, false, &quot;/x/b/c&quot;)]
        [TestCase(2006, false, &quot;/x/b/e&quot;)]
        [TestCase(1000, true, &quot;/&quot;)]
        [TestCase(1001, true, &quot;/b&quot;)]
        [TestCase(1002, true, &quot;/b/c&quot;)]
        [TestCase(1003, true, &quot;/b/c/d&quot;)]
        [TestCase(2000, true, &quot;/x&quot;)]
        [TestCase(2001, true, &quot;/y&quot;)]
        [TestCase(2002, true, &quot;/y/z&quot;)]
        [TestCase(2003, true, &quot;/a&quot;)]
        [TestCase(2004, true, &quot;/b&quot;)] // collision!
        [TestCase(2005, true, &quot;/b/c&quot;)] // collision!
        [TestCase(2006, true, &quot;/b/e&quot;)] // risky!
        public void GetRouteById(int id, bool hide, string expected)
        {
            var umbracoContext = GetUmbracoContext(&quot;/test&quot;, 0);
            var cache = umbracoContext.ContentCache.InnerCache as PublishedContentCache;
            if (cache == null) throw new Exception(&quot;Unsupported IPublishedContentCache, only the Xml one is supported.&quot;);

            SettingsForTests.HideTopLevelNodeFromPath = hide;

            const bool preview = true; // make sure we don&#39;t cache
            var route = cache.GetRouteById(umbracoContext, preview, id);
            Assert.AreEqual(expected, route);
        }

        [Test]
        public void GetRouteByIdCache()
        {
            var umbracoContext = GetUmbracoContext(&quot;/test&quot;, 0);
            var cache = umbracoContext.ContentCache.InnerCache as PublishedContentCache;
            if (cache == null) throw new Exception(&quot;Unsupported IPublishedContentCache, only the Xml one is supported.&quot;);

            SettingsForTests.HideTopLevelNodeFromPath = false;

            // make sure we cache
            PublishedContentCache.UnitTesting = false;
            const bool preview = false;

            var route = cache.GetRouteById(umbracoContext, preview, 1000);
            Assert.AreEqual(&quot;/a&quot;, route);

            // GetRouteById registers a non-trusted route, which is cached for
            // id -&gt; route queries (fast GetUrl) but *not* for route -&gt; id
            // queries (safe inbound routing)

            var cachedRoutes = cache.RoutesCache.GetCachedRoutes();
            Assert.AreEqual(1, cachedRoutes.Count);
            Assert.IsTrue(cachedRoutes.ContainsKey(1000));
            Assert.AreEqual(&quot;/a&quot;, cachedRoutes[1000]);

            var cachedIds = cache.RoutesCache.GetCachedIds();
            Assert.AreEqual(0, cachedIds.Count);
        }

        [TestCase(&quot;/&quot;, false, 1000)]
        [TestCase(&quot;/a&quot;, false, 1000)] // yes!
        [TestCase(&quot;/a/b&quot;, false, 1001)]
        [TestCase(&quot;/a/b/c&quot;, false, 1002)]
        [TestCase(&quot;/a/b/c/d&quot;, false, 1003)]
        [TestCase(&quot;/x&quot;, false, 2000)]
        [TestCase(&quot;/&quot;, true, 1000)]
        [TestCase(&quot;/a&quot;, true, 2003)]
        [TestCase(&quot;/a/b&quot;, true, -1)]
        [TestCase(&quot;/x&quot;, true, 2000)] // oops!
        [TestCase(&quot;/x/y&quot;, true, -1)] // yes!
        [TestCase(&quot;/y&quot;, true, 2001)]
        [TestCase(&quot;/y/z&quot;, true, 2002)]
        [TestCase(&quot;/b&quot;, true, 1001)] // (hence the 2004 collision)
        [TestCase(&quot;/b/c&quot;, true, 1002)] // (hence the 2005 collision)
        public void GetByRoute(string route, bool hide, int expected)
        {
            var umbracoContext = GetUmbracoContext(&quot;/test&quot;, 0);
            var cache = umbracoContext.ContentCache.InnerCache as PublishedContentCache;
            if (cache == null) throw new Exception(&quot;Unsupported IPublishedContentCache, only the Xml one is supported.&quot;);

            SettingsForTests.HideTopLevelNodeFromPath = hide;

            const bool preview = true; // make sure we don&#39;t cache
            var content = cache.GetByRoute(umbracoContext, preview, route);
            if (expected &lt; 0)
            {
                Assert.IsNull(content);
            }
            else
            {
                Assert.IsNotNull(content);
                Assert.AreEqual(expected, content.Id);
            }
        }

        [Test]
        public void GetByRouteCache()
        {
            var umbracoContext = GetUmbracoContext(&quot;/test&quot;, 0);
            var cache = umbracoContext.ContentCache.InnerCache as PublishedContentCache;
            if (cache == null) throw new Exception(&quot;Unsupported IPublishedContentCache, only the Xml one is supported.&quot;);

            SettingsForTests.HideTopLevelNodeFromPath = false;

            // make sure we cache
            PublishedContentCache.UnitTesting = false;
            const bool preview = false;

            var content = cache.GetByRoute(umbracoContext, preview, &quot;/a/b/c&quot;);
            Assert.IsNotNull(content);
            Assert.AreEqual(1002, content.Id);

            // GetByRoute registers a trusted route, which is cached both for
            // id -&gt; route queries (fast GetUrl) and for route -&gt; id queries
            // (fast inbound routing)

            var cachedRoutes = cache.RoutesCache.GetCachedRoutes();
            Assert.AreEqual(1, cachedRoutes.Count);
            Assert.IsTrue(cachedRoutes.ContainsKey(1002));
            Assert.AreEqual(&quot;/a/b/c&quot;, cachedRoutes[1002]);

            var cachedIds = cache.RoutesCache.GetCachedIds();
            Assert.AreEqual(1, cachedIds.Count);
            Assert.IsTrue(cachedIds.ContainsKey(&quot;/a/b/c&quot;));
            Assert.AreEqual(1002, cachedIds[&quot;/a/b/c&quot;]);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,1],[22,13,22,101,1],[24,13,24,37,1],[25,9,25,10,1],[30,9,30,10,1],[31,13,31,31,1],[34,13,34,72,1],[35,13,35,66,1],[36,9,36,10,1],[39,9,39,10,1],[40,13,68,10,1],[69,9,69,10,1],[216,9,216,10,1],[217,13,217,64,1],[218,13,218,89,1],[219,13,219,31,1],[219,32,219,122,0],[221,13,221,62,1],[224,13,224,73,1],[225,13,225,46,1],[226,9,226,10,1],[230,9,230,10,1],[231,13,231,64,1],[232,13,232,89,1],[233,13,233,31,1],[233,32,233,122,0],[235,13,235,63,1],[238,13,238,55,1],[241,13,241,75,1],[242,13,242,42,1],[248,13,248,68,1],[249,13,249,52,1],[250,13,250,59,1],[251,13,251,55,1],[253,13,253,62,1],[254,13,254,49,1],[255,9,255,10,1],[273,9,273,10,1],[274,13,274,64,1],[275,13,275,89,1],[276,13,276,31,1],[276,32,276,122,0],[278,13,278,62,1],[281,13,281,76,1],[282,13,282,30,1],[283,13,283,14,1],[284,17,284,40,1],[285,13,285,14,1],[287,13,287,14,1],[288,17,288,43,1],[289,17,289,55,1],[290,13,290,14,1],[291,9,291,10,1],[295,9,295,10,1],[296,13,296,64,1],[297,13,297,89,1],[298,13,298,31,1],[298,32,298,122,0],[300,13,300,63,1],[303,13,303,55,1],[306,13,306,79,1],[307,13,307,39,1],[308,13,308,47,1],[314,13,314,68,1],[315,13,315,52,1],[316,13,316,59,1],[317,13,317,59,1],[319,13,319,62,1],[320,13,320,49,1],[321,13,321,60,1],[322,13,322,56,1],[323,9,323,10,1]]);
    </script>
  </body>
</html>