<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Dynamics\DynamicXmlConverter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.ComponentModel;
using System.Globalization;
using System.Linq;
using System.Xml;
using System.Xml.Linq;

namespace Umbraco.Core.Dynamics
{
    /// &lt;summary&gt;
    /// Used to return the raw xml string value from DynamicXml when using type converters
    /// &lt;/summary&gt;
    public class RawXmlString
    {
        public string Value { get; private set; }

        public RawXmlString(string value)
        {
            Value = value;
        }
    }

    /// &lt;summary&gt;
    /// Used to return the raw xml XElement value from DynamicXml when using type converters
    /// &lt;/summary&gt;
    public class RawXElement
    {
        public XElement Value { get; private set; }

        public RawXElement(XElement value)
        {
            Value = value;
        }
    }

    /// &lt;summary&gt;
    /// Used to return the raw xml XElement value from DynamicXml when using type converters
    /// &lt;/summary&gt;
    public class RawXmlElement
    {
        public XmlElement Value { get; private set; }

        public RawXmlElement(XmlElement value)
        {
            Value = value;
        }
    }

    /// &lt;summary&gt;
    /// Used to return the raw xml XmlDocument value from DynamicXml when using type converters
    /// &lt;/summary&gt;
    public class RawXmlDocument
    {
        public XmlDocument Value { get; private set; }

        public RawXmlDocument(XmlDocument value)
        {
            Value = value;
        }
    }

	/// &lt;summary&gt;
	/// A custom type converter for DynamicXml
	/// &lt;/summary&gt;
	public class DynamicXmlConverter : TypeConverter
	{
		public override bool CanConvertTo(ITypeDescriptorContext context, Type destinationType)
		{
			var convertableTypes = new[]
			    {
			        typeof(string), 
                    typeof(XElement), 
                    typeof(XmlElement), 
                    typeof(XmlDocument),
                    typeof(RawXmlString), 
                    typeof(RawXElement), 
                    typeof(RawXmlElement), 
                    typeof(RawXmlDocument)
			    };

			return convertableTypes.Any(x =&gt; TypeHelper.IsTypeAssignableFrom(x, destinationType)) 
			       || base.CanConvertFrom(context, destinationType);
		}

		public override object ConvertTo(
			ITypeDescriptorContext context, 
			CultureInfo culture, 
			object value, 
			Type destinationType)
		{
			var dxml = value as DynamicXml;
			if (dxml == null)
				return null;
			//string
			if (TypeHelper.IsTypeAssignableFrom&lt;string&gt;(destinationType))
			{
				return value.ToString();
			}
            
			//XElement
			if (TypeHelper.IsTypeAssignableFrom&lt;XElement&gt;(destinationType))
			{
				return dxml.BaseElement;
			}
			//XmlElement
			if (TypeHelper.IsTypeAssignableFrom&lt;XmlElement&gt;(destinationType))
			{
				var xDoc = new XmlDocument();
				xDoc.LoadXml(dxml.ToString());
				return xDoc.DocumentElement;
			}
			//XmlDocument
			if (TypeHelper.IsTypeAssignableFrom&lt;XmlDocument&gt;(destinationType))
			{
				var xDoc = new XmlDocument();
				xDoc.LoadXml(dxml.ToString());
				return xDoc;
			}

            //RAW values:
            //string
            if (TypeHelper.IsTypeAssignableFrom&lt;RawXmlString&gt;(destinationType))
            {
                return new RawXmlString(dxml.ToRawXml());
            }
            //XElement
            if (TypeHelper.IsTypeAssignableFrom&lt;RawXElement&gt;(destinationType))
            {
                return new RawXElement(dxml.RawXmlElement);
            }
            //XmlElement
            if (TypeHelper.IsTypeAssignableFrom&lt;RawXmlElement&gt;(destinationType))
            {
                var xDoc = new XmlDocument();
                xDoc.LoadXml(dxml.ToRawXml());
                return new RawXmlElement(xDoc.DocumentElement);
            }
            //XmlDocument
            if (TypeHelper.IsTypeAssignableFrom&lt;RawXmlDocument&gt;(destinationType))
            {
                var xDoc = new XmlDocument();
                xDoc.LoadXml(dxml.ToRawXml());
                return new RawXmlDocument(xDoc);
            }


			return base.ConvertTo(context, culture, value, destinationType);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,31,15,35,1],[15,36,15,48,1],[17,9,17,42,1],[18,9,18,10,1],[19,13,19,27,1],[20,9,20,10,1],[28,33,28,37,1],[28,38,28,50,1],[30,9,30,43,1],[31,9,31,10,1],[32,13,32,27,1],[33,9,33,10,1],[41,35,41,39,1],[41,40,41,52,1],[43,9,43,47,1],[44,9,44,10,1],[45,13,45,27,1],[46,9,46,10,1],[54,36,54,40,1],[54,41,54,53,1],[56,9,56,49,1],[57,9,57,10,1],[58,13,58,27,1],[59,9,59,10,1],[68,3,68,4,1],[69,4,79,10,1],[81,4,81,37,1],[81,37,81,88,1],[81,88,82,60,1],[81,4,82,60,1],[83,3,83,4,1],[90,3,90,4,1],[91,4,91,35,1],[92,4,92,21,1],[93,5,93,17,0],[95,4,95,65,1],[96,4,96,5,0],[97,5,97,29,0],[101,4,101,67,1],[102,4,102,5,1],[103,5,103,29,1],[106,4,106,69,1],[107,4,107,5,1],[108,5,108,34,1],[109,5,109,35,1],[110,5,110,33,1],[113,4,113,70,1],[114,4,114,5,1],[115,5,115,34,1],[116,5,116,35,1],[117,5,117,17,1],[122,13,122,80,1],[123,13,123,14,1],[124,17,124,58,1],[127,13,127,79,1],[128,13,128,14,1],[129,17,129,60,1],[132,13,132,81,1],[133,13,133,14,1],[134,17,134,46,1],[135,17,135,47,1],[136,17,136,64,1],[139,13,139,82,1],[140,13,140,14,1],[141,17,141,46,1],[142,17,142,47,1],[143,17,143,49,1],[147,4,147,68,0],[148,3,148,4,1]]);
    </script>
  </body>
</html>