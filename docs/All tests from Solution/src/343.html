<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\SyntaxProvider\SqlCeSyntaxProviderTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.DatabaseAnnotations;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.Migrations.Syntax.Create.Index;
using Umbraco.Core.Persistence.Migrations.Syntax.Expressions;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.SyntaxProvider
{
    [TestFixture]
    public class SqlCeSyntaxProviderTests : BaseUsingSqlCeSyntax
    {

        [Test]
        public void Can_Generate_Delete_SubQuery_Statement()
        {
            var sqlSyntax = new SqlCeSyntaxProvider();

            var mediaObjectType = Guid.Parse(Constants.ObjectTypes.Media);
            var subQuery = new Sql()
                            .Select(&quot;DISTINCT cmsContentXml.nodeId&quot;)
                            .From&lt;ContentXmlDto&gt;(sqlSyntax)
                            .InnerJoin&lt;NodeDto&gt;(sqlSyntax)
                            .On&lt;ContentXmlDto, NodeDto&gt;(sqlSyntax, left =&gt; left.NodeId, right =&gt; right.NodeId)
                            .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeObjectType == mediaObjectType);
            
            var sqlOutput = sqlSyntax.GetDeleteSubquery(&quot;cmsContentXml&quot;, &quot;nodeId&quot;, subQuery);

            Assert.AreEqual(@&quot;DELETE FROM [cmsContentXml] WHERE [nodeId] IN (SELECT [nodeId] FROM (SELECT DISTINCT cmsContentXml.nodeId
FROM [cmsContentXml]
INNER JOIN [umbracoNode]
ON [cmsContentXml].[nodeId] = [umbracoNode].[id]
WHERE (([umbracoNode].[nodeObjectType] = @0))) x)&quot;.Replace(Environment.NewLine, &quot; &quot;).Replace(&quot;\n&quot;, &quot; &quot;).Replace(&quot;\r&quot;, &quot; &quot;),
                                                sqlOutput.SQL.Replace(Environment.NewLine, &quot; &quot;).Replace(&quot;\n&quot;, &quot; &quot;).Replace(&quot;\r&quot;, &quot; &quot;));

            Assert.AreEqual(1, sqlOutput.Arguments.Length);
            Assert.AreEqual(mediaObjectType, sqlOutput.Arguments[0]);
        }

        [NUnit.Framework.Ignore(&quot;This doesn&#39;t actually test anything&quot;)]
        [Test]
        public void Can_Generate_Create_Table_Statement()
        {
            var sqlSyntax = new SqlCeSyntaxProvider();

            var type = typeof (NodeDto);
            var definition = DefinitionFactory.GetTableDefinition(sqlSyntax, type);

            string create = sqlSyntax.Format(definition);
            string primaryKey = sqlSyntax.FormatPrimaryKey(definition);
            var indexes = sqlSyntax.Format(definition.Indexes);
            var keys = sqlSyntax.Format(definition.ForeignKeys);

            Debug.Print(create);
            Debug.Print(primaryKey);
            foreach (var sql in keys)
            {
                Debug.Print(sql);
            }

            foreach (var sql in indexes)
            {
                Debug.Print(sql);
            }
        }

        [Test]
        public void Format_SqlServer_NonClusteredIndexDefinition_AddsNonClusteredDirective()
        {
            var sqlSyntax = new SqlServerSyntaxProvider();
            
            var indexDefinition = CreateIndexDefinition();
            indexDefinition.IndexType = IndexTypes.NonClustered;

            var actual = sqlSyntax.Format(indexDefinition);
            Assert.AreEqual(&quot;CREATE NONCLUSTERED INDEX [IX_A] ON [TheTable] ([A])&quot;, actual);
        }

        [Test]
        public void Format_SqlServer_NonClusteredIndexDefinition_UsingIsClusteredFalse_AddsClusteredDirective()
        {
            var sqlSyntax = new SqlServerSyntaxProvider();

            var indexDefinition = CreateIndexDefinition();
            indexDefinition.IsClustered = false;

            var actual = sqlSyntax.Format(indexDefinition);
            Assert.AreEqual(&quot;CREATE CLUSTERED INDEX [IX_A] ON [TheTable] ([A])&quot;, actual);
        }

        [Test]
        public void CreateIndexBuilder_SqlServer_NonClustered_CreatesNonClusteredIndex()
        {
            var sqlSyntax = new SqlServerSyntaxProvider();
            var createExpression = new CreateIndexExpression(DatabaseProviders.SqlServer, new []{DatabaseProviders.SqlServer}, sqlSyntax)
            {
                Index = { Name = &quot;IX_A&quot; }
            };
            var builder = new CreateIndexBuilder(createExpression);
            builder.OnTable(&quot;TheTable&quot;).OnColumn(&quot;A&quot;).Ascending().WithOptions().NonClustered();
            Assert.AreEqual(&quot;CREATE NONCLUSTERED INDEX [IX_A] ON [TheTable] ([A])&quot;, createExpression.ToString());
        }

        [Test]
        public void CreateIndexBuilder_SqlServer_Unique_CreatesUniqueNonClusteredIndex()
        {
            var sqlSyntax = new SqlServerSyntaxProvider();
            var createExpression = new CreateIndexExpression(DatabaseProviders.SqlServer, new[] { DatabaseProviders.SqlServer }, sqlSyntax)
            {
                Index = { Name = &quot;IX_A&quot; }
            };
            var builder = new CreateIndexBuilder(createExpression);
            builder.OnTable(&quot;TheTable&quot;).OnColumn(&quot;A&quot;).Ascending().WithOptions().Unique();
            Assert.AreEqual(&quot;CREATE UNIQUE NONCLUSTERED INDEX [IX_A] ON [TheTable] ([A])&quot;, createExpression.ToString());
        }

        [Test]
        public void CreateIndexBuilder_SqlServer_Clustered_CreatesClusteredIndex()
        {
            var sqlSyntax = new SqlServerSyntaxProvider();
            var createExpression = new CreateIndexExpression(DatabaseProviders.SqlServer, new[] { DatabaseProviders.SqlServer }, sqlSyntax)
            {
                Index = { Name = &quot;IX_A&quot; }
            };
            var builder = new CreateIndexBuilder(createExpression);
            builder.OnTable(&quot;TheTable&quot;).OnColumn(&quot;A&quot;).Ascending().WithOptions().Clustered();
            Assert.AreEqual(&quot;CREATE CLUSTERED INDEX [IX_A] ON [TheTable] ([A])&quot;, createExpression.ToString());
        }

        private static IndexDefinition CreateIndexDefinition()
        {
            return new IndexDefinition
            {
                ColumnName = &quot;A&quot;,
                Name = &quot;IX_A&quot;,
                TableName = &quot;TheTable&quot;,
                SchemaName = &quot;dbo&quot;
            };
        }
        
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[24,13,24,55,1],[26,13,26,75,1],[27,13,32,91,1],[34,13,34,94,1],[36,13,41,136,1],[43,13,43,60,1],[44,13,44,70,1],[45,9,45,10,1],[50,9,50,10,0],[51,13,51,55,0],[53,13,53,41,0],[54,13,54,84,0],[56,13,56,58,0],[57,13,57,72,0],[58,13,58,64,0],[59,13,59,65,0],[61,13,61,33,0],[62,13,62,37,0],[63,13,63,20,0],[63,22,63,29,0],[63,30,63,32,0],[63,33,63,37,0],[64,13,64,14,0],[65,17,65,34,0],[66,13,66,14,0],[68,13,68,20,0],[68,22,68,29,0],[68,30,68,32,0],[68,33,68,40,0],[69,13,69,14,0],[70,17,70,34,0],[71,13,71,14,0],[72,9,72,10,0],[76,9,76,10,1],[77,13,77,59,1],[79,13,79,59,1],[80,13,80,65,1],[82,13,82,60,1],[83,13,83,93,1],[84,9,84,10,1],[88,9,88,10,1],[89,13,89,59,1],[91,13,91,59,1],[92,13,92,49,1],[94,13,94,60,1],[95,13,95,90,1],[96,9,96,10,1],[100,9,100,10,1],[101,13,101,59,1],[102,13,105,15,1],[106,13,106,68,1],[107,13,107,96,1],[108,13,108,114,1],[109,9,109,10,1],[113,9,113,10,1],[114,13,114,59,1],[115,13,118,15,1],[119,13,119,68,1],[120,13,120,90,1],[121,13,121,121,1],[122,9,122,10,1],[126,9,126,10,1],[127,13,127,59,1],[128,13,131,15,1],[132,13,132,68,1],[133,13,133,93,1],[134,13,134,111,1],[135,9,135,10,1],[138,9,138,10,1],[139,13,145,15,1],[146,9,146,10,1]]);
    </script>
  </body>
</html>