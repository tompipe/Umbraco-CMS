<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Routing\ContentFinderByRedirectUrl.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Web;
using Umbraco.Core;
using Umbraco.Core.Logging;

namespace Umbraco.Web.Routing
{
    /// &lt;summary&gt;
    /// Provides an implementation of &lt;see cref=&quot;IContentFinder&quot;/&gt; that handles page url rewrites
    /// that are stored when moving, saving, or deleting a node.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// &lt;para&gt;Assigns a permanent redirect notification to the request.&lt;/para&gt;
    /// &lt;/remarks&gt;
    public class ContentFinderByRedirectUrl : IContentFinder
    {
        /// &lt;summary&gt;
        /// Tries to find and assign an Umbraco document to a &lt;c&gt;PublishedContentRequest&lt;/c&gt;.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentRequest&quot;&gt;The &lt;c&gt;PublishedContentRequest&lt;/c&gt;.&lt;/param&gt;
        /// &lt;returns&gt;A value indicating whether an Umbraco document was found and assigned.&lt;/returns&gt;
        /// &lt;remarks&gt;Optionally, can also assign the template or anything else on the document request, although that is not required.&lt;/remarks&gt;
        public bool TryFindContent(PublishedContentRequest contentRequest)
        {
            var route = contentRequest.HasDomain
                ? contentRequest.UmbracoDomain.RootContentId + DomainHelper.PathRelativeToDomain(contentRequest.DomainUri, contentRequest.Uri.GetAbsolutePathDecoded())
                : contentRequest.Uri.GetAbsolutePathDecoded();

            var service = contentRequest.RoutingContext.UmbracoContext.Application.Services.RedirectUrlService;
            var redirectUrl = service.GetMostRecentRedirectUrl(route);

            // From: http://stackoverflow.com/a/22468386/5018
            // See http://issues.umbraco.org/issue/U4-8361#comment=67-30532
            // Setting automatic 301 redirects to not be cached because browsers cache these very aggressively which then leads 
            // to problems if you rename a page back to it&#39;s original name or create a new page with the original name
            contentRequest.Cacheability = HttpCacheability.NoCache;
            contentRequest.CacheExtensions = new List&lt;string&gt; { &quot;no-store, must-revalidate&quot; };
            contentRequest.Headers = new Dictionary&lt;string, string&gt; { { &quot;Pragma&quot;, &quot;no-cache&quot; }, { &quot;Expires&quot;, &quot;0&quot; } };

            if (redirectUrl == null)
            {
                LogHelper.Debug&lt;ContentFinderByRedirectUrl&gt;(&quot;No match for route: \&quot;{0}\&quot;.&quot;, () =&gt; route);
                return false;
            }

            var content = contentRequest.RoutingContext.UmbracoContext.ContentCache.GetById(redirectUrl.ContentId);
            var url = content == null ? &quot;#&quot; : content.Url;
            if (url.StartsWith(&quot;#&quot;))
            {
                LogHelper.Debug&lt;ContentFinderByRedirectUrl&gt;(&quot;Route \&quot;{0}\&quot; matches content {1} which has no url.&quot;,
                    () =&gt; route, () =&gt; redirectUrl.ContentId);
                return false;
            }

            LogHelper.Debug&lt;ContentFinderByRedirectUrl&gt;(&quot;Route \&quot;{0}\&quot; matches content {1} with url \&quot;{2}\&quot;, redirecting.&quot;,
                () =&gt; route, () =&gt; content.Id, () =&gt; url);
            contentRequest.SetRedirectPermanent(url);
            return true;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,0],[25,13,27,63,0],[29,13,29,112,0],[30,13,30,71,0],[36,13,36,68,0],[37,13,37,95,0],[38,13,38,118,0],[40,13,40,37,0],[41,13,41,14,0],[42,17,42,99,0],[42,99,42,104,0],[42,104,42,106,0],[42,17,42,106,0],[43,17,43,30,0],[46,13,46,116,0],[47,13,47,59,0],[48,13,48,37,0],[49,13,49,14,0],[50,17,51,27,0],[51,27,51,32,0],[51,32,51,40,0],[51,40,51,61,0],[51,61,51,63,0],[50,17,51,63,0],[52,17,52,30,0],[55,13,56,23,0],[56,23,56,28,0],[56,28,56,36,0],[56,36,56,46,0],[56,46,56,54,0],[56,54,56,57,0],[56,57,56,59,0],[55,13,56,59,0],[57,13,57,54,0],[58,13,58,25,0],[59,9,59,10,0]]);
    </script>
  </body>
</html>