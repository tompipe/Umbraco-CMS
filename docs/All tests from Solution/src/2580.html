<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.datalayer\Utility\Installer\DefaultInstallerUtility.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/************************************************************************************
 * 
 *  Umbraco Data Layer
 *  MIT Licensed work
 *  ï¿½2008 Ruben Verborgh
 * 
 ***********************************************************************************/

using System;
using System.Text.RegularExpressions;

namespace umbraco.DataLayer.Utility.Installer
{

    /// &lt;summary&gt;
    /// Base class for installers that use an ISqlHelper as data source.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;S&quot;&gt;The SQL helper type.&lt;/typeparam&gt;
    [Obsolete(&quot;The legacy installers are no longer used and will be removed from the codebase in the future&quot;)]
    public abstract class DefaultInstallerUtility&lt;S&gt; : BaseUtility&lt;S&gt;, IInstallerUtility where S : ISqlHelper
    {
        #region Private Fields

        /// &lt;summary&gt;The latest available version this installer provides.&lt;/summary&gt;
        private readonly DatabaseVersion m_LatestVersion;

        /// &lt;summary&gt;The currently installed database version, &lt;c&gt;null&lt;/c&gt; if undetermined.&lt;/summary&gt;
        private DatabaseVersion? m_CurrentVersion = null;

        /// &lt;summary&gt;Regular expression that finds multiline block comments.&lt;/summary&gt;
        private static readonly Regex m_findComments = new Regex(@&quot;\/\*.*?\*\/&quot;, RegexOptions.Singleline | RegexOptions.Compiled);

        #endregion

        #region Public Properties

        /// &lt;summary&gt;
        /// Gets the current data source version.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The current version.&lt;/value&gt;
        public DatabaseVersion CurrentVersion
        {
            get
            {
                if (!m_CurrentVersion.HasValue)
                    m_CurrentVersion = DetermineCurrentVersion();
                return m_CurrentVersion.Value;
            }
        }

        /// &lt;summary&gt;
        /// Gets the latest available version.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The latest version.&lt;/value&gt;
        public DatabaseVersion LatestVersion
        {
            get { return m_LatestVersion; }
        }

        /// &lt;summary&gt;
        /// Gets a value indicating whether this installer can connect to the data source.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// 	&lt;c&gt;true&lt;/c&gt; if the installer can connect; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/value&gt;
        public virtual bool CanConnect
        {
            get { return CurrentVersion != DatabaseVersion.Unavailable; }
        }

        /// &lt;summary&gt;
        /// Gets a value indicating whether the data source is empty and ready for installation.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// 	&lt;c&gt;true&lt;/c&gt; if the data source is empty; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/value&gt;
        public virtual bool IsEmpty
        {
            get { return CurrentVersion == DatabaseVersion.None; }
        }
		        
        /// &lt;summary&gt;
        /// Gets a value indicating whether the data source has an up to date version.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// 	&lt;c&gt;true&lt;/c&gt; if the data source is up to date; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/value&gt;
        public bool IsLatestVersion
        {
            get { return CurrentVersion == LatestVersion; }
        }

        /// &lt;summary&gt;
        /// Gets a value indicating whether the installer can upgrade the data source.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// 	&lt;c&gt;true&lt;/c&gt; if the installer can upgrade the data source; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/value&gt;
        /// &lt;remarks&gt;Empty data sources can&#39;t be upgraded, just installed.&lt;/remarks&gt;
        public virtual bool CanUpgrade
        {
            get { return false; }
        }

        /// &lt;summary&gt;
        /// Gets the version specification for evaluation by DetermineCurrentVersion.
        /// Only first matching specification is taken into account.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The version specifications.&lt;/value&gt;
		protected abstract VersionSpecs[] VersionSpecs { get; }

        #endregion

        #region Public Constructors

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;DefaultInstallerUtility&amp;lt;S&amp;gt;&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sqlHelper&quot;&gt;The SQL helper.&lt;/param&gt;
        public DefaultInstallerUtility(S sqlHelper)
            : this(sqlHelper, DatabaseVersion.Unavailable)
        { }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;DefaultInstallerUtility&amp;lt;S&amp;gt;&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sqlHelper&quot;&gt;The SQL helper.&lt;/param&gt;
        /// &lt;param name=&quot;latestVersion&quot;&gt;The latest available version.&lt;/param&gt;
        public DefaultInstallerUtility(S sqlHelper, DatabaseVersion latestVersion)
            : base(sqlHelper)
        {
            m_LatestVersion = latestVersion;
        }

        #endregion

		#region Protected Properties

		protected abstract string FullInstallSql { get; }
		protected abstract string UpgradeSql { get; }

		#endregion

        #region IUmbracoInstaller Members

        /// &lt;summary&gt;
        /// Installs the latest version into the data source.
        /// &lt;/summary&gt;
        /// &lt;exception cref=&quot;System.NotSupportedException&quot;&gt;
        /// If installing or upgrading is not supported.&lt;/exception&gt;
		public void Install()
		{
			if (IsLatestVersion)
				return;

			// installation on empty database
			if (IsEmpty)
			{
				NewInstall(FullInstallSql);
			}
			else
			// upgrade from older version
			{
				if (!CanUpgrade)
					throw new NotSupportedException(&quot;Upgrading from this version is not supported.&quot;);
				
				// execute version specific upgrade set
				Upgrade(UpgradeSql);
			}
		}

        #endregion

        #region Protected Methods
		
		protected virtual void NewInstall(string sql)
		{
			ExecuteStatements(sql);
		}

		protected virtual void Upgrade(string sql)
		{
			ExecuteStatements(sql);
		}

        /// &lt;summary&gt;
        /// Determines the current version of the SQL data source,
        /// by attempting to select a certain field from a certain table.
        /// The specifications are retrieved using the VersionSpecs property.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The current version of the SQL data source&lt;/returns&gt;
        protected virtual DatabaseVersion DetermineCurrentVersion()
        {
            foreach (VersionSpecs v in VersionSpecs)
            {
                try
                {
                    if(v.ExpectedRows &gt; -1)
                    {
                        using (var sqlHelper = SqlHelper)
                        using (var reader = sqlHelper.ExecuteReader(v.Sql))
                        {
                            var rowCount = 0;
                            while (reader.Read())
                                rowCount++;

                            if (v.ExpectedRows != rowCount)
                                continue;
                        }
                    }
                    else
                    {
                        using (var sqlHelper = SqlHelper)
                            sqlHelper.ExecuteNonQuery(v.Sql);
                    }

                    //if (!String.IsNullOrEmpty(v.Table) &amp;&amp; !String.IsNullOrEmpty(v.Field) &amp;&amp; !String.IsNullOrEmpty(v.Value))
                    //{
                    //    IRecordsReader reader = SqlHelper.ExecuteReader(string.Format(&quot;SELECT {0} FROM {1} WHERE {0}={2}&quot;, v.Field, v.Table, v.Value));
                    //    var canRead = reader.Read();
                    //    if ((v.ShouldExist &amp;&amp; !canRead) || (!v.ShouldExist &amp;&amp; canRead))
                    //        continue;
                    //}
                    //else if (String.IsNullOrEmpty(v.Table))
                    //    SqlHelper.ExecuteNonQuery(string.Format(&quot;SELECT {0}&quot;, v.Field));
                    //else
                    //    SqlHelper.ExecuteNonQuery(string.Format(&quot;SELECT {0} FROM {1}&quot;, v.Field, v.Table));

                    return v.Version;
                }
                catch { }
            }

            return DatabaseVersion.Unavailable;
        }

        /// &lt;summary&gt;
        /// Executes a list of semicolon separated statements.
        /// Statements starting with
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;statements&quot;&gt;The statements.&lt;/param&gt;
        protected void ExecuteStatements(string statements)
        {
            if (string.IsNullOrEmpty(statements))
            {
                throw new ArgumentNullException(&quot;statements&quot;, &quot;The sql statement to execute is empty. Database version: &quot; + CurrentVersion.ToString());
            }

            // replace block comments by whitespace
            statements = m_findComments.Replace(statements, &quot; &quot;);
            // execute all non-empty statements
            foreach (string statement in statements.Split(&quot;;&quot;.ToCharArray()))
            {
                string rawStatement = statement.Trim();
                if (rawStatement.Length &gt; 0)
                    using (var sqlHelper = SqlHelper)
                        sqlHelper.ExecuteNonQuery(rawStatement);
            }
        }

        #endregion
    }

   
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,58,0],[31,9,31,131,0],[44,13,44,14,0],[45,17,45,48,0],[46,21,46,66,0],[47,17,47,47,0],[48,13,48,14,0],[57,17,57,18,0],[57,19,57,42,0],[57,43,57,44,0],[68,17,68,18,0],[68,19,68,72,0],[68,73,68,74,0],[79,17,79,18,0],[79,19,79,65,0],[79,66,79,67,0],[90,17,90,18,0],[90,19,90,58,0],[90,59,90,60,0],[102,17,102,18,0],[102,19,102,32,0],[102,33,102,34,0],[121,15,121,59,0],[122,9,122,10,0],[122,11,122,12,0],[130,15,130,30,0],[131,9,131,10,0],[132,13,132,45,0],[133,9,133,10,0],[152,3,152,4,0],[153,4,153,24,0],[154,5,154,12,0],[157,4,157,16,0],[158,4,158,5,0],[159,5,159,32,0],[160,4,160,5,0],[163,4,163,5,0],[164,5,164,21,0],[165,6,165,87,0],[168,5,168,25,0],[169,4,169,5,0],[170,3,170,4,0],[177,3,177,4,0],[178,4,178,27,0],[179,3,179,4,0],[182,3,182,4,0],[183,4,183,27,0],[184,3,184,4,0],[193,9,193,10,0],[194,13,194,20,0],[194,22,194,36,0],[194,37,194,39,0],[194,40,194,52,0],[195,13,195,14,0],[197,17,197,18,0],[198,21,198,44,0],[199,21,199,22,0],[200,32,200,57,0],[201,32,201,75,0],[202,25,202,26,0],[203,29,203,46,0],[204,29,204,50,0],[205,33,205,44,0],[207,29,207,60,0],[208,33,208,42,0],[209,25,209,26,0],[210,21,210,22,0],[212,21,212,22,0],[213,32,213,57,0],[214,29,214,62,0],[215,21,215,22,0],[229,21,229,38,0],[231,17,231,22,0],[231,23,231,24,0],[231,25,231,26,0],[232,13,232,14,0],[234,13,234,48,0],[235,9,235,10,0],[243,9,243,10,0],[244,13,244,50,0],[245,13,245,14,0],[246,17,246,152,0],[250,13,250,66,0],[252,13,252,20,0],[252,22,252,38,0],[252,39,252,41,0],[252,42,252,77,0],[253,13,253,14,0],[254,17,254,56,0],[255,17,255,45,0],[256,28,256,53,0],[257,25,257,65,0],[258,13,258,14,0],[259,9,259,10,0]]);
    </script>
  </body>
</html>