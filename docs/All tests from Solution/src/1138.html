<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\InstallSteps\DatabaseConfigureStep.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using System.Threading.Tasks;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Persistence;
using Umbraco.Web.Install.Models;

namespace Umbraco.Web.Install.InstallSteps
{
    [InstallSetupStep(InstallationType.NewInstall,
        &quot;DatabaseConfigure&quot;, &quot;database&quot;, 10, &quot;Setting up a database, so Umbraco has a place to store your website&quot;,
        PerformsAppRestart = true)]
    internal class DatabaseConfigureStep : InstallSetupStep&lt;DatabaseModel&gt;
    {
        private readonly ApplicationContext _applicationContext;

        public DatabaseConfigureStep(ApplicationContext applicationContext)
        {
            _applicationContext = applicationContext;
        }

        public override InstallSetupResult Execute(DatabaseModel database)
        {
            //if the database model is null then we will apply the defaults
            if (database == null)
            {
                database = new DatabaseModel();
            }

            var dbHelper = new DatabaseHelper();

            if (dbHelper.CheckConnection(database, _applicationContext) == false)
            {
                throw new InstallException(&quot;Could not connect to the database&quot;);
            }
            ConfigureConnection(database);
            return null;
        }

        private void ConfigureConnection(DatabaseModel database)
        {
            var dbContext = _applicationContext.DatabaseContext;
            if (database.ConnectionString.IsNullOrWhiteSpace() == false)
            {
                dbContext.ConfigureDatabaseConnection(database.ConnectionString);
            }
            else if (database.DatabaseType == DatabaseType.SqlCe)
            {
                dbContext.ConfigureEmbeddedDatabaseConnection();
            }
            else if (database.IntegratedAuth)
            {
                dbContext.ConfigureIntegratedSecurityDatabaseConnection(
                    database.Server, database.DatabaseName);
            }
            else
            {
                var password = database.Password.Replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;).Replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;).Replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;).Replace(&quot;\&quot;&quot;, &quot;&amp;quot;&quot;).Replace(&quot;&#39;&quot;, &quot;&#39;&#39;&quot;);
                password = string.Format(&quot;&#39;{0}&#39;&quot;, password);

                dbContext.ConfigureDatabaseConnection(
                    database.Server, database.DatabaseName, database.Login, password,
                    database.DatabaseType.ToString());
            }
        }

        public override string View
        {
            get { return ShouldDisplayView() ? base.View : &quot;&quot;; }
        }

        public override bool RequiresExecution(DatabaseModel model)
        {
            return ShouldDisplayView();
        }

        private bool ShouldDisplayView()
        {
            //If the connection string is already present in web.config we don&#39;t need to show the settings page and we jump to installing/upgrading.
            var databaseSettings = ConfigurationManager.ConnectionStrings[GlobalSettings.UmbracoConnectionName];

            if (_applicationContext.DatabaseContext.IsConnectionStringConfigured(databaseSettings))
            {
                try
                {
                    //Since a connection string was present we verify the db can connect and query
                    var result = _applicationContext.DatabaseContext.ValidateDatabaseSchema();
                    result.DetermineInstalledVersion();
                    return false;
                }
                catch (Exception)
                {
                    //something went wrong, could not connect so probably need to reconfigure
                    return true;
                }
            }

            return true;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,76,0],[24,9,24,10,0],[25,13,25,54,0],[26,9,26,10,0],[29,9,29,10,0],[31,13,31,34,0],[32,13,32,14,0],[33,17,33,48,0],[34,13,34,14,0],[36,13,36,49,0],[38,13,38,82,0],[39,13,39,14,0],[40,17,40,81,0],[42,13,42,43,0],[43,13,43,25,0],[44,9,44,10,0],[47,9,47,10,0],[48,13,48,65,0],[49,13,49,73,0],[50,13,50,14,0],[51,17,51,82,0],[52,13,52,14,0],[53,18,53,66,0],[54,13,54,14,0],[55,17,55,65,0],[56,13,56,14,0],[57,18,57,46,0],[58,13,58,14,0],[59,17,60,61,0],[61,13,61,14,0],[63,13,63,14,0],[64,17,64,157,0],[65,17,65,61,0],[67,17,69,55,0],[70,13,70,14,0],[71,9,71,10,0],[75,17,75,18,0],[75,19,75,63,0],[75,64,75,65,0],[79,9,79,10,0],[80,13,80,40,0],[81,9,81,10,0],[84,9,84,10,0],[86,13,86,113,0],[88,13,88,100,0],[89,13,89,14,0],[91,17,91,18,0],[93,21,93,95,0],[94,21,94,56,0],[95,21,95,34,0],[97,17,97,34,0],[98,17,98,18,0],[100,21,100,33,0],[104,13,104,25,0],[105,9,105,10,0]]);
    </script>
  </body>
</html>