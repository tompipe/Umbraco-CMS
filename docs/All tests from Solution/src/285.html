<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\TestHelpers\SettingsForTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.IO;
using System.Configuration;
using Moq;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Configuration.UmbracoSettings;

namespace Umbraco.Tests.TestHelpers
{
    public class SettingsForTests
    {
        // umbracoSettings

        /// &lt;summary&gt;
        /// Sets the umbraco settings singleton to the object specified
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;
        public static void ConfigureSettings(IUmbracoSettingsSection settings)
        {
            UmbracoConfig.For.SetUmbracoSettings(settings);
        }

        /// &lt;summary&gt;
        /// Returns generated settings which can be stubbed to return whatever values necessary
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IUmbracoSettingsSection GenerateMockSettings()
        {
            var settings = new Mock&lt;IUmbracoSettingsSection&gt;();

            var content = new Mock&lt;IContentSection&gt;();
            var security = new Mock&lt;ISecuritySection&gt;();
            var requestHandler = new Mock&lt;IRequestHandlerSection&gt;();
            var templates = new Mock&lt;ITemplatesSection&gt;();
            var dev = new Mock&lt;IDeveloperSection&gt;();
            var viewStateMover = new Mock&lt;IViewStateMoverModuleSection&gt;();
            var logging = new Mock&lt;ILoggingSection&gt;();
            var tasks = new Mock&lt;IScheduledTasksSection&gt;();
            var distCall = new Mock&lt;IDistributedCallSection&gt;();
            var repos = new Mock&lt;IRepositoriesSection&gt;();
            var providers = new Mock&lt;IProvidersSection&gt;();
            var help = new Mock&lt;IHelpSection&gt;();
            var routing = new Mock&lt;IWebRoutingSection&gt;();
            var scripting = new Mock&lt;IScriptingSection&gt;();

            settings.Setup(x =&gt; x.Content).Returns(content.Object);
            settings.Setup(x =&gt; x.Security).Returns(security.Object);
            settings.Setup(x =&gt; x.RequestHandler).Returns(requestHandler.Object);
            settings.Setup(x =&gt; x.Templates).Returns(templates.Object);
            settings.Setup(x =&gt; x.Developer).Returns(dev.Object);
            settings.Setup(x =&gt; x.ViewStateMoverModule).Returns(viewStateMover.Object);
            settings.Setup(x =&gt; x.Logging).Returns(logging.Object);
            settings.Setup(x =&gt; x.ScheduledTasks).Returns(tasks.Object);
            settings.Setup(x =&gt; x.DistributedCall).Returns(distCall.Object);
            settings.Setup(x =&gt; x.PackageRepositories).Returns(repos.Object);
            settings.Setup(x =&gt; x.Providers).Returns(providers.Object);
            settings.Setup(x =&gt; x.Help).Returns(help.Object);
            settings.Setup(x =&gt; x.WebRouting).Returns(routing.Object);
            settings.Setup(x =&gt; x.Scripting).Returns(scripting.Object);

            //Now configure some defaults - the defaults in the config section classes do NOT pertain to the mocked data!!
            settings.Setup(x =&gt; x.Content.UseLegacyXmlSchema).Returns(false);
            settings.Setup(x =&gt; x.Content.ForceSafeAliases).Returns(true);
            settings.Setup(x =&gt; x.Content.ImageAutoFillProperties).Returns(ContentImagingElement.GetDefaultImageAutoFillProperties());
            settings.Setup(x =&gt; x.Content.ImageFileTypes).Returns(ContentImagingElement.GetDefaultImageFileTypes());
            settings.Setup(x =&gt; x.RequestHandler.AddTrailingSlash).Returns(true);
            settings.Setup(x =&gt; x.RequestHandler.UseDomainPrefixes).Returns(false);
            settings.Setup(x =&gt; x.RequestHandler.CharCollection).Returns(RequestHandlerElement.GetDefaultCharReplacements());
            settings.Setup(x =&gt; x.Content.UmbracoLibraryCacheDuration).Returns(1800);
            settings.Setup(x =&gt; x.WebRouting.UrlProviderMode).Returns(&quot;AutoLegacy&quot;);
            settings.Setup(x =&gt; x.Templates.DefaultRenderingEngine).Returns(RenderingEngine.Mvc);
            
            return settings.Object;
        }

        // from appSettings

        private static readonly IDictionary&lt;string, string&gt; SavedAppSettings = new Dictionary&lt;string, string&gt;();

        static void SaveSetting(string key)
        {
            SavedAppSettings[key] = ConfigurationManager.AppSettings[key];
        }

        static void SaveSettings()
        {
            SaveSetting(&quot;umbracoHideTopLevelNodeFromPath&quot;);
            SaveSetting(&quot;umbracoUseDirectoryUrls&quot;);
            SaveSetting(&quot;umbracoPath&quot;);
            SaveSetting(&quot;umbracoReservedPaths&quot;);
            SaveSetting(&quot;umbracoReservedUrls&quot;);
            SaveSetting(&quot;umbracoConfigurationStatus&quot;);
        }

        public static bool HideTopLevelNodeFromPath
        {
            get { return GlobalSettings.HideTopLevelNodeFromPath; }
            set { ConfigurationManager.AppSettings.Set(&quot;umbracoHideTopLevelNodeFromPath&quot;, value ? &quot;true&quot; : &quot;false&quot;); }
        }

        public static bool UseDirectoryUrls
        {
            get { return GlobalSettings.UseDirectoryUrls; }
            set { ConfigurationManager.AppSettings.Set(&quot;umbracoUseDirectoryUrls&quot;, value ? &quot;true&quot; : &quot;false&quot;); }
        }

        public static string UmbracoPath
        {
            get { return GlobalSettings.Path; }
            set { ConfigurationManager.AppSettings.Set(&quot;umbracoPath&quot;, value); }
        }

        public static string ReservedPaths
        {
            get { return GlobalSettings.ReservedPaths; }
            set { GlobalSettings.ReservedPaths = value; }
        }

        public static string ReservedUrls
        {
            get { return GlobalSettings.ReservedUrls; }
            set { GlobalSettings.ReservedUrls = value; }
        }

        public static string ConfigurationStatus
        {
            get { return GlobalSettings.ConfigurationStatus; }
            set { ConfigurationManager.AppSettings.Set(&quot;umbracoConfigurationStatus&quot;, value); }
        }

        // reset &amp; defaults

        static SettingsForTests()
        {
            SaveSettings();
        }

        public static void Reset()
        {
            ResetUmbracoSettings();
            GlobalSettings.Reset();

            foreach (var kvp in SavedAppSettings)
                ConfigurationManager.AppSettings.Set(kvp.Key, kvp.Value);

            // set some defaults that are wrong in the config file?!
            // this is annoying, really
            HideTopLevelNodeFromPath = false;
        }

        /// &lt;summary&gt;
        /// This sets all settings back to default settings
        /// &lt;/summary&gt;
        private static void ResetUmbracoSettings()
        {
            ConfigureSettings(GetDefault());
        }

        private static IUmbracoSettingsSection _defaultSettings;

        internal static IUmbracoSettingsSection GetDefault()
        {
            if (_defaultSettings == null)
            {
                var config = new FileInfo(TestHelper.MapPathForTest(&quot;~/Configurations/UmbracoSettings/web.config&quot;));

                var fileMap = new ExeConfigurationFileMap() { ExeConfigFilename = config.FullName };
                var configuration = ConfigurationManager.OpenMappedExeConfiguration(fileMap, ConfigurationUserLevel.None);
                _defaultSettings = configuration.GetSection(&quot;umbracoConfiguration/defaultSettings&quot;) as UmbracoSettingsSection;
            }

            return _defaultSettings;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,60,1],[22,9,22,10,1],[29,9,29,10,1],[30,13,30,64,1],[32,13,32,55,1],[33,13,33,57,1],[34,13,34,69,1],[35,13,35,59,1],[36,13,36,53,1],[37,13,37,75,1],[38,13,38,55,1],[39,13,39,60,1],[40,13,40,64,1],[41,13,41,58,1],[42,13,42,59,1],[43,13,43,49,1],[44,13,44,58,1],[45,13,45,59,1],[47,13,47,68,1],[48,13,48,70,1],[49,13,49,82,1],[50,13,50,72,1],[51,13,51,66,1],[52,13,52,88,1],[53,13,53,68,1],[54,13,54,73,1],[55,13,55,77,1],[56,13,56,78,1],[57,13,57,72,1],[58,13,58,62,1],[59,13,59,71,1],[60,13,60,72,1],[63,13,63,78,1],[64,13,64,75,1],[65,13,65,135,1],[66,13,66,117,1],[67,13,67,82,1],[68,13,68,84,1],[69,13,69,126,1],[70,13,70,86,1],[71,13,71,85,1],[72,13,72,98,1],[74,13,74,36,1],[75,9,75,10,1],[79,9,79,113,1],[82,9,82,10,1],[83,13,83,75,1],[84,9,84,10,1],[87,9,87,10,1],[88,13,88,60,1],[89,13,89,52,1],[90,13,90,40,1],[91,13,91,49,1],[92,13,92,48,1],[93,13,93,55,1],[94,9,94,10,1],[98,17,98,18,0],[98,19,98,66,0],[98,67,98,68,0],[99,17,99,18,1],[99,19,99,117,1],[99,118,99,119,1],[104,17,104,18,0],[104,19,104,58,0],[104,59,104,60,0],[105,17,105,18,1],[105,19,105,109,1],[105,110,105,111,1],[110,17,110,18,0],[110,19,110,46,0],[110,47,110,48,0],[111,17,111,18,1],[111,19,111,78,1],[111,79,111,80,1],[116,17,116,18,0],[116,19,116,55,0],[116,56,116,57,0],[117,17,117,18,0],[117,19,117,56,0],[117,57,117,58,0],[122,17,122,18,0],[122,19,122,54,0],[122,55,122,56,0],[123,17,123,18,0],[123,19,123,55,0],[123,56,123,57,0],[128,17,128,18,0],[128,19,128,61,0],[128,62,128,63,0],[129,17,129,18,1],[129,19,129,93,1],[129,94,129,95,1],[135,9,135,10,1],[136,13,136,28,1],[137,9,137,10,1],[140,9,140,10,1],[141,13,141,36,1],[142,13,142,36,1],[144,13,144,20,1],[144,22,144,29,1],[144,30,144,32,1],[144,33,144,49,1],[145,17,145,74,1],[149,13,149,46,1],[150,9,150,10,1],[156,9,156,10,1],[157,13,157,45,1],[158,9,158,10,1],[163,9,163,10,1],[164,13,164,42,1],[165,13,165,14,1],[166,17,166,117,1],[168,17,168,101,1],[169,17,169,123,1],[170,17,170,127,1],[171,13,171,14,1],[173,13,173,37,1],[174,9,174,10,1]]);
    </script>
  </body>
</html>