<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\tinyMCE3\webcontrol\plugin\JSON.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * $Id: JSON.cs 439 2007-11-26 13:26:10Z spocke $
 *
 * Copyright ï¿½ 2007, Moxiecode Systems AB, All rights reserved. 
 */

using System;
using System.IO;
using System.Collections;
using System.Collections.Specialized;

namespace umbraco.editorControls.tinyMCE3.webcontrol.plugin
{
    /// &lt;summary&gt;
	/// Description of JSON.
	/// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class JSON
    {
		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public static void SerializeRPC(string id, object error, object obj, Stream stream) {
			JSONWriter writer = new JSONWriter(new StreamWriter(stream));

			// Start JSON output
			writer.WriteStartObject();
			writer.WritePropertyName(&quot;result&quot;);
			WriteValue(writer, obj);

			// Write id
			writer.WritePropertyName(&quot;id&quot;);
			writer.WriteValue(id);

			// Write error
			writer.WritePropertyName(&quot;error&quot;);
			writer.WriteValue(null);

			// Close
			writer.WriteEndObject();
			writer.Close();
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;writer&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt;
		public static void WriteObject(TextWriter writer, object obj) {
			WriteValue(new JSONWriter(writer), obj);
			writer.Flush();
		}

		private static void WriteValue(JSONWriter writer, object obj) {
			if (obj == null)
				writer.WriteNull();

			if (obj is System.String)
				writer.WriteValue((string) obj);

			if (obj is System.Boolean)
				writer.WriteValue((bool) obj);

			if (obj is System.Double)
				writer.WriteValue(Convert.ToDouble(obj));

			if (obj is System.Int32)
				writer.WriteValue(Convert.ToInt32(obj));

			if (obj is System.Int64)
				writer.WriteValue(Convert.ToInt64(obj));

			if (obj is ArrayList) {
				writer.WriteStartArray();

				foreach (object val in ((ArrayList) obj))
					WriteValue(writer, val);

				writer.WriteEndArray();
			}

			if (obj is string[]) {
				writer.WriteStartArray();

				foreach (string val in ((string[]) obj))
					WriteValue(writer, val);

				writer.WriteEndArray();
			}

			if (obj is NameValueCollection) {
				writer.WriteStartObject();

				string[] keys = GetReversedKeys(obj);
				foreach (string key in keys) {
					writer.WritePropertyName(key);
					WriteValue(writer, ((NameValueCollection) obj)[key]);
				}

				writer.WriteEndObject();
			}

			if (obj is Hashtable) {
				writer.WriteStartObject();

				string[] keys = GetReversedKeys(obj);
				foreach (string key in keys) {
					writer.WritePropertyName((string) key);
					WriteValue(writer, ((Hashtable) obj)[key]);
				}

				writer.WriteEndObject();
			}
		}

		private static string[] GetReversedKeys(object obj) {
			ICollection keyCollection;
			string[] keys;
			int count;

			if (obj is Hashtable)
				keyCollection = ((Hashtable) obj).Keys;
			else
				keyCollection = ((NameValueCollection) obj).AllKeys;

			count = keyCollection.Count;
			keys = new string[count];

			foreach (string key in keyCollection)
				keys[--count] = key;

			Array.Sort(keys);

			return keys;
		}
		
		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;reader&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static object ParseJSON(TextReader reader) {
			return ReadValue(new JSONReader(reader));
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;reader&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static JSONRpcCall ParseRPC(TextReader reader) {
			JSONRpcCall call = new JSONRpcCall();
			object obj = ParseJSON(reader);
			Hashtable jsonRpc = (Hashtable) obj;

			call.Method = (string) jsonRpc[&quot;method&quot;];
			call.Id = (string) jsonRpc[&quot;id&quot;];
			call.Args = (ArrayList) jsonRpc[&quot;params&quot;];

			return call;
		}

		#region private methods

/*		private static void Debug(string str) {
			System.Web.HttpContext.Current.Trace.Write(str);
		}*/

		private static object ReadValue(JSONReader reader) {
			Stack parents = new Stack();
			object cur = null;
			string key = null;
			object obj;

			while (reader.Read()) {
				//Debug(reader.ToString());

				switch (reader.TokenType) {
					case JSONToken.Boolean:
					case JSONToken.Integer:
					case JSONToken.String:
					case JSONToken.Float:
					case JSONToken.Null:
						if (cur is Hashtable) {
							//Debug(key + &quot;=&quot; + reader.ToString());
							((Hashtable) cur)[key] = reader.Value;
						} else if (cur is ArrayList)
							((ArrayList) cur).Add(reader.Value);
						else
							return reader.Value;

						break;

					case JSONToken.PropertyName:
						key = (string) reader.Value;
						break;

					case JSONToken.StartArray:
					case JSONToken.StartObject:
						if (reader.TokenType == JSONToken.StartObject)
							obj = new Hashtable();
						else
							obj = new ArrayList();

						if (cur is Hashtable) {
							//Debug(key + &quot;=&quot; + reader.ToString());
							((Hashtable) cur)[key] = obj;
						} else if (cur is ArrayList)
							((ArrayList) cur).Add(obj);

						parents.Push(cur);
						cur = obj;

						break;

					case JSONToken.EndArray:
					case JSONToken.EndObject:
						obj = parents.Pop();

						if (obj != null)
							cur = obj;

						break;
				}
			}

			return cur;
		}
		
		private static object ReadValue2(JSONReader jsonReader) {
			jsonReader.Read();

			switch (jsonReader.TokenType) {
				case JSONToken.Boolean:
					return (bool) jsonReader.Value;

				case JSONToken.Integer:
					return Convert.ToInt32(jsonReader.Value);

				case JSONToken.String:
					return (string) jsonReader.Value;

				case JSONToken.Float:
					return (double) jsonReader.Value;

				case JSONToken.Null:
					return null;

				case JSONToken.StartObject:
					Hashtable hash = new Hashtable();

					while (jsonReader.TokenType != JSONToken.EndObject) {
						if (jsonReader.TokenType == JSONToken.PropertyName)
							hash[jsonReader.Value] = ReadValue(jsonReader);
						else
							jsonReader.Read();
					}

					return hash;

				case JSONToken.StartArray:
					ArrayList list = new ArrayList();

					while (jsonReader.TokenType != JSONToken.EndArray) {
						if (jsonReader.TokenType == JSONToken.EndArray &amp;&amp; jsonReader.Value == null)
							break;

						list.Add(ReadValue(jsonReader));
					}

					return list;
			}

			return null;
		}

		private static bool FindNext(JSONReader reader, JSONToken token) {
			if (reader.TokenType == token)
				return true;

			while (reader.Read() &amp;&amp; reader.TokenType != JSONToken.EndObject &amp;&amp; reader.TokenType != JSONToken.EndArray) {
				if (reader.TokenType == token)
					return true;
			}

			return false;
		}

		private static bool FindNextValue(JSONReader reader) {
			switch (reader.TokenType) {
				case JSONToken.Boolean:
				case JSONToken.Float:
				case JSONToken.Integer:
				case JSONToken.Null:
				case JSONToken.String:
					return true;
			}

			while (reader.Read() &amp;&amp; reader.TokenType != JSONToken.EndObject) {
				switch (reader.TokenType) {
					case JSONToken.Boolean:
					case JSONToken.Float:
					case JSONToken.Integer:
					case JSONToken.Null:
					case JSONToken.String:
						return true;
				}
			}

			return false;
		}

		#endregion
	}

	/// &lt;summary&gt;
	/// 
	/// &lt;/summary&gt;
	public class JSONRpcCall {
		private string id, method;
		private ArrayList args;

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public JSONRpcCall() {
			this.args = new ArrayList();
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public string Method {
			get { return method; }
			set { method = value; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public string Id {
			get { return id; }
			set { id = value; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public ArrayList Args {
			get { return args; }
			set { args = value; }
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,87,23,88,0],[24,4,24,65,0],[27,4,27,30,0],[28,4,28,39,0],[29,4,29,28,0],[32,4,32,35,0],[33,4,33,26,0],[36,4,36,38,0],[37,4,37,28,0],[40,4,40,28,0],[41,4,41,19,0],[42,3,42,4,0],[49,65,49,66,0],[50,4,50,44,0],[51,4,51,19,0],[52,3,52,4,0],[54,65,54,66,0],[55,4,55,20,0],[56,5,56,24,0],[58,4,58,29,0],[59,5,59,37,0],[61,4,61,30,0],[62,5,62,35,0],[64,4,64,29,0],[65,5,65,46,0],[67,4,67,28,0],[68,5,68,45,0],[70,4,70,28,0],[71,5,71,45,0],[73,4,73,25,0],[73,26,73,27,0],[74,5,74,30,0],[76,5,76,12,0],[76,14,76,24,0],[76,25,76,27,0],[76,28,76,45,0],[77,6,77,30,0],[79,5,79,28,0],[80,4,80,5,0],[82,4,82,24,0],[82,25,82,26,0],[83,5,83,30,0],[85,5,85,12,0],[85,14,85,24,0],[85,25,85,27,0],[85,28,85,44,0],[86,6,86,30,0],[88,5,88,28,0],[89,4,89,5,0],[91,4,91,35,0],[91,36,91,37,0],[92,5,92,31,0],[94,5,94,42,0],[95,5,95,12,0],[95,14,95,24,0],[95,25,95,27,0],[95,28,95,32,0],[95,34,95,35,0],[96,6,96,36,0],[97,6,97,59,0],[98,5,98,6,0],[100,5,100,29,0],[101,4,101,5,0],[103,4,103,25,0],[103,26,103,27,0],[104,5,104,31,0],[106,5,106,42,0],[107,5,107,12,0],[107,14,107,24,0],[107,25,107,27,0],[107,28,107,32,0],[107,34,107,35,0],[108,6,108,45,0],[109,6,109,49,0],[110,5,110,6,0],[112,5,112,29,0],[113,4,113,5,0],[114,3,114,4,0],[116,55,116,56,0],[121,4,121,25,0],[122,5,122,44,0],[124,5,124,57,0],[126,4,126,32,0],[127,4,127,29,0],[129,4,129,11,0],[129,13,129,23,0],[129,24,129,26,0],[129,27,129,40,0],[130,5,130,25,0],[132,4,132,21,0],[134,4,134,16,0],[135,3,135,4,0],[142,53,142,54,0],[143,4,143,45,0],[144,3,144,4,0],[151,57,151,58,0],[152,4,152,41,0],[153,4,153,35,0],[154,4,154,40,0],[156,4,156,45,0],[157,4,157,37,0],[158,4,158,46,0],[160,4,160,16,0],[161,3,161,4,0],[169,54,169,55,0],[170,4,170,32,0],[171,4,171,22,0],[172,4,172,22,0],[175,4,175,25,0],[175,26,175,27,0],[178,5,178,30,0],[184,7,184,28,0],[184,29,184,30,0],[186,8,186,46,0],[187,7,187,8,0],[187,14,187,35,0],[188,8,188,44,0],[190,8,190,28,0],[192,7,192,13,0],[195,7,195,35,0],[196,7,196,13,0],[200,7,200,53,0],[201,8,201,30,0],[203,8,203,30,0],[205,7,205,28,0],[205,29,205,30,0],[207,8,207,37,0],[208,7,208,8,0],[208,14,208,35,0],[209,8,209,35,0],[211,7,211,25,0],[212,7,212,17,0],[214,7,214,13,0],[218,7,218,27,0],[220,7,220,23,0],[221,8,221,18,0],[223,7,223,13,0],[225,4,225,5,0],[227,4,227,15,0],[228,3,228,4,0],[230,59,230,60,0],[231,4,231,22,0],[233,4,233,33,0],[235,6,235,37,0],[238,6,238,47,0],[241,6,241,39,0],[244,6,244,39,0],[247,6,247,18,0],[250,6,250,39,0],[252,6,252,57,0],[252,58,252,59,0],[253,7,253,58,0],[254,8,254,55,0],[256,8,256,26,0],[257,6,257,7,0],[259,6,259,18,0],[262,6,262,39,0],[264,6,264,56,0],[264,57,264,58,0],[265,7,265,82,0],[266,8,266,14,0],[268,7,268,39,0],[269,6,269,7,0],[271,6,271,18,0],[274,4,274,16,0],[275,3,275,4,0],[277,68,277,69,0],[278,4,278,34,0],[279,5,279,17,0],[281,4,281,110,0],[281,111,281,112,0],[282,5,282,35,0],[283,6,283,18,0],[284,4,284,5,0],[286,4,286,17,0],[287,3,287,4,0],[289,56,289,57,0],[290,4,290,29,0],[296,6,296,18,0],[299,4,299,68,0],[299,69,299,70,0],[300,5,300,30,0],[306,7,306,19,0],[308,4,308,5,0],[310,4,310,17,0],[311,3,311,4,0],[326,3,326,23,0],[326,24,326,25,0],[327,4,327,32,0],[328,3,328,4,0],[334,8,334,9,0],[334,10,334,24,0],[334,25,334,26,0],[335,8,335,9,0],[335,10,335,25,0],[335,26,335,27,0],[342,8,342,9,0],[342,10,342,20,0],[342,21,342,22,0],[343,8,343,9,0],[343,10,343,21,0],[343,22,343,23,0],[350,8,350,9,0],[350,10,350,22,0],[350,23,350,24,0],[351,8,351,9,0],[351,10,351,23,0],[351,24,351,25,0]]);
    </script>
  </body>
</html>