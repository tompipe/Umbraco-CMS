<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\DefaultPrevalueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.UI;
using System.Web.UI.WebControls;
using umbraco.interfaces;
using umbraco.BusinessLogic;
using umbraco.DataLayer;

namespace umbraco.editorControls
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class DefaultPrevalueEditor : PlaceHolder, IDataPrevalue
    {
        // UI controls
        private TextBox _textbox;
        private DropDownList _dropdownlist;

        // referenced datatype
        private cms.businesslogic.datatype.BaseDataType _datatype;
        private BaseDataType _datatypeOld;

        private bool _isEnsured = false;
        private string _prevalue;
        private bool _displayTextBox;

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        public static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        /// &lt;summary&gt;
        /// The default editor for editing the built-in pre values in umbraco
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;DataType&quot;&gt;The DataType to be parsed&lt;/param&gt;
        /// &lt;param name=&quot;DisplayTextBox&quot;&gt;Whether to use the default text box&lt;/param&gt;
        public DefaultPrevalueEditor(cms.businesslogic.datatype.BaseDataType DataType, bool DisplayTextBox)
        {
            // state it knows its datatypedefinitionid
            _displayTextBox = DisplayTextBox;
            _datatype = DataType;
            setupChildControls();
        }

        /// &lt;summary&gt;
        /// For backwards compatibility, should be replaced in your extension with the constructor that
        /// uses the BaseDataType from the cms.businesslogic.datatype namespace
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;DataType&quot;&gt;The DataType to be parsed (note: the BaseDataType from editorControls is obsolete)&lt;/param&gt;
        /// &lt;param name=&quot;DisplayTextBox&quot;&gt;Whether to use the default text box&lt;/param&gt;
        public DefaultPrevalueEditor(BaseDataType DataType, bool DisplayTextBox)
        {
            // state it knows its datatypedefinitionid
            _displayTextBox = DisplayTextBox;
            _datatypeOld = DataType;
            setupChildControls();
        }

        private void setupChildControls()
        {
            _dropdownlist = new DropDownList();
            _dropdownlist.ID = &quot;dbtype&quot;;

            _textbox = new TextBox();
            _textbox.ID = &quot;prevalues&quot;;
            _textbox.Visible = _displayTextBox;

            // put the childcontrols in context - ensuring that
            // the viewstate is persisted etc.
            Controls.Add(_textbox);
            Controls.Add(_dropdownlist);

            _dropdownlist.Items.Add(DBTypes.Date.ToString());
            _dropdownlist.Items.Add(DBTypes.Integer.ToString());
            _dropdownlist.Items.Add(DBTypes.Ntext.ToString());
            _dropdownlist.Items.Add(DBTypes.Nvarchar.ToString());
        }

        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
            if (!Page.IsPostBack)
            {
                if (_datatype != null)
                    _dropdownlist.SelectedValue = _datatype.DBType.ToString();
                else
                    _dropdownlist.SelectedValue = _datatypeOld.DBType.ToString();

                _textbox.Text = Prevalue;
            }
        }

        public string Prevalue
        {
            get
            {
                ensurePrevalue();
                if (_prevalue == null) {
                    int defId;
                    if (_datatype != null)
                        defId = _datatype.DataTypeDefinitionId;
                    else if (_datatypeOld != null)
                        defId = _datatypeOld.DataTypeDefinitionId;
                    else
                        throw new ArgumentException(&quot;Datatype is not initialized&quot;);

                    using (var sqlHelper = Application.SqlHelper)
                        _prevalue =
                            sqlHelper.ExecuteScalar&lt;string&gt;(&quot;Select [value] from cmsDataTypePreValues where DataTypeNodeId = &quot; + defId);
                }
                return _prevalue;
            }
            set
            {
                int defId;
                if (_datatype != null)
                    defId = _datatype.DataTypeDefinitionId;
                else if (_datatypeOld != null)
                    defId = _datatypeOld.DataTypeDefinitionId;
                else
                    throw new ArgumentException(&quot;Datatype is not initialized&quot;);

                _prevalue = value;
                ensurePrevalue();
                using (var sqlHelper = Application.SqlHelper)
                {
                    IParameter[] SqlParams = new IParameter[]
                    {
                        sqlHelper.CreateParameter(&quot;@value&quot;, _textbox.Text),
                        sqlHelper.CreateParameter(&quot;@dtdefid&quot;, defId)
                    };
                    // update prevalue
                    sqlHelper.ExecuteNonQuery(&quot;update cmsDataTypePreValues set [value] = @value where datatypeNodeId = @dtdefid&quot;, SqlParams);
                }
            }
        }

        private void ensurePrevalue()
        {
            if (!_isEnsured)
            {

                int defId;
                if (_datatype != null)
                    defId = _datatype.DataTypeDefinitionId;
                else if (_datatypeOld != null)
                    defId = _datatypeOld.DataTypeDefinitionId;
                else
                    throw new ArgumentException(&quot;Datatype is not initialized&quot;);

                using (var sqlHelper = Application.SqlHelper)
                {
                    bool hasPrevalue = (sqlHelper.ExecuteScalar&lt;int&gt;(&quot;select count(id) from cmsDataTypePreValues where dataTypeNodeId = &quot; + defId) &gt; 0);
                    IParameter[] SqlParams = new IParameter[]
                        {
                            sqlHelper.CreateParameter(&quot;@value&quot;, _textbox.Text),
                            sqlHelper.CreateParameter(&quot;@dtdefid&quot;, defId)
                        };
                    if (!hasPrevalue)
                    {
                        sqlHelper.ExecuteNonQuery(&quot;insert into cmsDataTypePreValues (datatypenodeid,[value],sortorder,alias) values (@dtdefid,@value,0,&#39;&#39;)&quot;,
                                                  SqlParams);
                    }
                }
                _isEnsured = true;
            }
        }

        public Control Editor
        {
            get { return this; }
        }

        public void Save()
        {
            // save the prevalue data and get on with you life ;)
            if (_datatype != null)
                _datatype.DBType = (cms.businesslogic.datatype.DBTypes)Enum.Parse(typeof(cms.businesslogic.datatype.DBTypes), _dropdownlist.SelectedValue, true);
            else if (_datatypeOld != null)
                _datatypeOld.DBType = (DBTypes)Enum.Parse(typeof(DBTypes), _dropdownlist.SelectedValue, true);


            if (_displayTextBox)
            {
                // If the prevalue editor has an prevalue textbox - save the textbox value as the prevalue
                Prevalue = _textbox.Text;
            }
        }

        protected override void Render(HtmlTextWriter writer)
        {
            writer.Write(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&lt;div class=&#39;propertyItemheader&#39;&gt;&quot; + ui.Text(&quot;dataBaseDatatype&quot;) + &quot;&lt;/div&gt;&quot;);
            _dropdownlist.RenderControl(writer);
            writer.Write(&quot;&lt;br style=&#39;clear: both&#39;/&gt;&lt;/div&gt;&quot;);


            if (_displayTextBox)
            {
                writer.Write(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&lt;div class=&#39;propertyItemheader&#39;&gt;&quot; + ui.Text(&quot;prevalue&quot;) + &quot;&lt;/div&gt;&quot;);
                _textbox.RenderControl(writer);
                writer.Write(&quot;&lt;br style=&#39;clear: both&#39;/&gt;&lt;/div&gt;&quot;);
            }

            /*
            writer.WriteLine(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&quot;);
            writer.WriteLine(&quot;&lt;tr&gt;&lt;td&gt;Database datatype&lt;/td&gt;&lt;td&gt;&quot;);
            _dropdownlist.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            if (_displayTextBox)
                writer.WriteLine(&quot;&lt;tr&gt;&lt;td&gt;Prevalue: &lt;/td&gt;&lt;td&gt;&quot;);
            _textbox.RenderControl(writer);
            writer.WriteLine(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;/div&gt;&quot;);
             */

        }

        public static string GetPrevalueFromId(int Id)
        {
            using (var sqlHelper = Application.SqlHelper)
                return sqlHelper.ExecuteScalar&lt;string&gt;(&quot;Select [value] from cmsDataTypePreValues where id = @id&quot;,
                    sqlHelper.CreateParameter(&quot;@id&quot;, Id));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,41,0],[21,9,21,41,0],[31,17,31,18,0],[31,19,31,48,0],[31,49,31,50,0],[39,9,39,108,0],[40,9,40,10,0],[42,13,42,46,0],[43,13,43,34,0],[44,13,44,34,0],[45,9,45,10,0],[53,9,53,81,0],[54,9,54,10,0],[56,13,56,46,0],[57,13,57,37,0],[58,13,58,34,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,48,0],[64,13,64,41,0],[66,13,66,38,0],[67,13,67,39,0],[68,13,68,48,0],[72,13,72,36,0],[73,13,73,41,0],[75,13,75,62,0],[76,13,76,65,0],[77,13,77,63,0],[78,13,78,66,0],[79,9,79,10,0],[82,9,82,10,0],[83,13,83,28,0],[84,13,84,34,0],[85,13,85,14,0],[86,17,86,39,0],[87,21,87,79,0],[89,21,89,82,0],[91,17,91,42,0],[92,13,92,14,0],[93,9,93,10,0],[98,13,98,14,0],[99,17,99,34,0],[100,17,100,39,0],[100,40,100,41,0],[102,21,102,43,0],[103,25,103,64,0],[104,26,104,51,0],[105,25,105,67,0],[107,25,107,84,0],[109,28,109,65,0],[110,25,111,137,0],[112,17,112,18,0],[113,17,113,34,0],[114,13,114,14,0],[116,13,116,14,0],[118,17,118,39,0],[119,21,119,60,0],[120,22,120,47,0],[121,21,121,63,0],[123,21,123,80,0],[125,17,125,35,0],[126,17,126,34,0],[127,24,127,61,0],[128,17,128,18,0],[129,21,133,23,0],[135,21,135,142,0],[136,17,136,18,0],[137,13,137,14,0],[141,9,141,10,0],[142,13,142,29,0],[143,13,143,14,0],[146,17,146,39,0],[147,21,147,60,0],[148,22,148,47,0],[149,21,149,63,0],[151,21,151,80,0],[153,24,153,61,0],[154,17,154,18,0],[155,21,155,153,0],[156,21,160,27,0],[161,21,161,38,0],[162,21,162,22,0],[163,25,164,62,0],[165,21,165,22,0],[166,17,166,18,0],[167,17,167,35,0],[168,13,168,14,0],[169,9,169,10,0],[173,17,173,18,0],[173,19,173,31,0],[173,32,173,33,0],[177,9,177,10,0],[179,13,179,35,0],[180,17,180,162,0],[181,18,181,43,0],[182,17,182,111,0],[185,13,185,33,0],[186,13,186,14,0],[188,17,188,42,0],[189,13,189,14,0],[190,9,190,10,0],[193,9,193,10,0],[194,13,194,129,0],[195,13,195,49,0],[196,13,196,61,0],[199,13,199,33,0],[200,13,200,14,0],[201,17,201,125,0],[202,17,202,48,0],[203,17,203,65,0],[204,13,204,14,0],[218,9,218,10,0],[221,9,221,10,0],[222,20,222,57,0],[223,17,224,59,0],[225,9,225,10,0]]);
    </script>
  </body>
</html>