<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\importDocumenttype.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Xml;
using System.Xml.Linq;
using Umbraco.Core;
using Umbraco.Core.IO;

namespace umbraco.presentation.umbraco.dialogs
{
	/// &lt;summary&gt;
	/// Summary description for importDocumentType.
	/// &lt;/summary&gt;
	public class importDocumentType : BasePages.UmbracoEnsuredPage
	{
	    public importDocumentType()
	    {

            CurrentApp = BusinessLogic.DefaultApps.settings.ToString();

	    }
		protected Literal FeedBackMessage;
		protected Literal jsShowWindow;
		protected Panel Wizard;
		protected HtmlTable Table1;
		protected HtmlInputHidden tempFile;
		protected HtmlInputFile documentTypeFile;
		protected Button submit;
		protected Panel Confirm;
		protected Literal dtName;
		protected Literal dtAlias;
		protected Button import;
		protected Literal dtNameConfirm;
		protected Panel done;
		private string tempFileName = &quot;&quot;;

		private void Page_Load(object sender, EventArgs e)
		{
			if (!IsPostBack) 
			{
				submit.Text = ui.Text(&quot;import&quot;);
				import.Text = ui.Text(&quot;import&quot;);
			} 
		}

		#region Web Form Designer generated code
		override protected void OnInit(EventArgs e)
		{
			//
			// CODEGEN: This call is required by the ASP.NET Web Form Designer.
			//
			InitializeComponent();
			base.OnInit(e);
		}
		
		/// &lt;summary&gt;
		/// Required method for Designer support - do not modify
		/// the contents of this method with the code editor.
		/// &lt;/summary&gt;
		private void InitializeComponent()
		{    
			this.submit.Click += new System.EventHandler(this.submit_Click);
			this.import.Click += new System.EventHandler(this.import_Click);
			this.Load += new System.EventHandler(this.Page_Load);

		}
		#endregion

		private void import_Click(object sender, EventArgs e)
		{
            var xd = new XmlDocument();
            xd.Load(tempFile.Value);

		    var userId = base.getUser().Id;

            var element = XElement.Parse(xd.InnerXml);
		    var importContentTypes = ApplicationContext.Current.Services.PackagingService.ImportContentTypes(element, userId);
		    var contentType = importContentTypes.FirstOrDefault();
		    if (contentType != null)
		        dtNameConfirm.Text = contentType.Name;

            // Try to clean up the temporary file.
            try
            {
                System.IO.File.Delete(tempFile.Value);
            }
            catch(Exception ex)
            {
                Umbraco.Core.Logging.LogHelper.Error(typeof(importDocumentType), &quot;Error cleaning up temporary udt file in App_Data: &quot; + ex.Message, ex);
            }

		    Wizard.Visible = false;
			Confirm.Visible = false;
			done.Visible = true;
		}

		private void submit_Click(object sender, EventArgs e)
		{
			tempFileName = &quot;justDelete_&quot; + Guid.NewGuid().ToString() + &quot;.udt&quot;;
			var fileName = IOHelper.MapPath(SystemDirectories.Data + &quot;/&quot; + tempFileName);
			tempFile.Value = fileName;

			documentTypeFile.PostedFile.SaveAs(fileName);

			var xd = new XmlDocument();
			xd.Load(fileName);
			dtName.Text = xd.DocumentElement.SelectSingleNode(&quot;//DocumentType/Info/Name&quot;).FirstChild.Value;
			dtAlias.Text = xd.DocumentElement.SelectSingleNode(&quot;//DocumentType/Info/Alias&quot;).FirstChild.Value;

			Wizard.Visible = false;
			done.Visible = false;
			Confirm.Visible = true;
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,6,17,33,0],[18,6,18,7,0],[20,13,20,72,0],[22,6,22,7,0],[36,3,36,36,0],[39,3,39,4,0],[40,4,40,20,0],[41,4,41,5,0],[42,5,42,37,0],[43,5,43,37,0],[44,4,44,5,0],[45,3,45,4,0],[49,3,49,4,0],[53,4,53,26,0],[54,4,54,19,0],[55,3,55,4,0],[62,3,62,4,0],[63,4,63,68,0],[64,4,64,68,0],[65,4,65,57,0],[67,3,67,4,0],[71,3,71,4,0],[72,13,72,40,0],[73,13,73,37,0],[75,7,75,38,0],[77,13,77,55,0],[78,7,78,121,0],[79,7,79,61,0],[80,7,80,31,0],[81,11,81,49,0],[85,13,85,14,0],[86,17,86,55,0],[87,13,87,14,0],[88,13,88,32,0],[89,13,89,14,0],[90,17,90,153,0],[91,13,91,14,0],[93,7,93,30,0],[94,4,94,28,0],[95,4,95,24,0],[96,3,96,4,0],[99,3,99,4,0],[100,4,100,70,0],[101,4,101,81,0],[102,4,102,30,0],[104,4,104,49,0],[106,4,106,31,0],[107,4,107,22,0],[108,4,108,99,0],[109,4,109,101,0],[111,4,111,27,0],[112,4,112,25,0],[113,4,113,27,0],[114,3,114,4,0]]);
    </script>
  </body>
</html>