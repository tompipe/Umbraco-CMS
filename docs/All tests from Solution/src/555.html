<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\webservices\CheckForUpgrade.asmx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Web;
using System.Web.Services;
using System.Web.Script.Services;
using Umbraco.Core;
using Umbraco.Web.WebServices;
using Umbraco.Core.Configuration;


namespace umbraco.presentation.webservices
{
    /// &lt;summary&gt;
    /// Summary description for CheckForUpgrade
    /// &lt;/summary&gt;
    [WebService(Namespace = &quot;http://umbraco.org/&quot;)]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    [System.ComponentModel.ToolboxItem(false)]
    [ScriptService]
    public class CheckForUpgrade : UmbracoAuthorizedWebService
    {

        [WebMethod]
        [ScriptMethod]
        public UpgradeResult CallUpgradeService()
        {
            if (!AuthorizeRequest()) return null;

            var check = new global::Umbraco.Web.org.umbraco.update.CheckForUpgrade();
            var result = check.CheckUpgrade(UmbracoVersion.Current.Major,
                                                                         UmbracoVersion.Current.Minor,
                                                                         UmbracoVersion.Current.Build,
                                                                         UmbracoVersion.CurrentComment);
            return new UpgradeResult(result.UpgradeType.ToString(), result.Comment, result.UpgradeUrl);
        }

        [WebMethod]
        [ScriptMethod]
        public void InstallStatus(bool isCompleted, string userAgent, string errorMsg)
        {
            bool isUpgrade = false;
            // if it&#39;s an upgrade, you&#39;ll need to be logged in before we allow this call
            if (!String.IsNullOrEmpty(global::Umbraco.Core.Configuration.GlobalSettings.ConfigurationStatus))
            {
                isUpgrade = true;
                try
                {
                    legacyAjaxCalls.Authorize();
                }
                catch (Exception)
                {
                    //we don&#39;t want to throw the exception back to JS
                    return;
                }
            }

            // Check for current install Id
            Guid installId = Guid.NewGuid();
            var installCookie = new BusinessLogic.StateHelper.Cookies.Cookie(&quot;umb_installId&quot;, 1);
            if (string.IsNullOrEmpty(installCookie.GetValue()) == false)
            {
                if (Guid.TryParse(installCookie.GetValue(), out installId))
                {
                    // check that it&#39;s a valid Guid
                    if (installId == Guid.Empty)
                        installId = Guid.NewGuid();

                }
            }
            installCookie.SetValue(installId.ToString());

            string dbProvider = string.Empty;
            if (string.IsNullOrEmpty(global::Umbraco.Core.Configuration.GlobalSettings.ConfigurationStatus) == false)
            dbProvider = ApplicationContext.Current.DatabaseContext.DatabaseProvider.ToString();

            var check = new global::Umbraco.Web.org.umbraco.update.CheckForUpgrade();
            check.Install(installId,
                isUpgrade,
                isCompleted,
                DateTime.Now,
                UmbracoVersion.Current.Major,
                UmbracoVersion.Current.Minor,
                UmbracoVersion.Current.Build,
                UmbracoVersion.CurrentComment,
                errorMsg,
                userAgent,
                dbProvider);
        }
    }


    public class UpgradeResult
    {
        public string UpgradeType { get; set; }
        public string UpgradeComment { get; set; }
        public string UpgradeUrl { get; set; }

        public UpgradeResult() { }
        public UpgradeResult(string upgradeType, string upgradeComment, string upgradeUrl)
        {
            UpgradeType = upgradeType;
            UpgradeComment = upgradeComment;
            UpgradeUrl = upgradeUrl + &quot;?version=&quot; + HttpContext.Current.Server.UrlEncode(UmbracoVersion.Current.ToString(3));
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,0],[27,13,27,37,0],[27,38,27,50,0],[29,13,29,86,0],[30,13,33,105,0],[34,13,34,104,0],[35,9,35,10,0],[40,9,40,10,0],[41,13,41,36,0],[43,13,43,110,0],[44,13,44,14,0],[45,17,45,34,0],[47,17,47,18,0],[48,21,48,49,0],[49,17,49,18,0],[50,17,50,34,0],[51,17,51,18,0],[53,21,53,28,0],[55,13,55,14,0],[58,13,58,45,0],[59,13,59,98,0],[60,13,60,73,0],[61,13,61,14,0],[62,17,62,76,0],[63,17,63,18,0],[65,21,65,49,0],[66,25,66,52,0],[68,17,68,18,0],[69,13,69,14,0],[70,13,70,58,0],[72,13,72,46,0],[73,13,73,118,0],[74,13,74,97,0],[76,13,76,86,0],[77,13,87,29,0],[88,9,88,10,0],[94,37,94,41,0],[94,42,94,46,0],[95,40,95,44,0],[95,45,95,49,0],[96,36,96,40,0],[96,41,96,45,0],[98,9,98,31,0],[98,32,98,33,0],[98,34,98,35,0],[99,9,99,91,0],[100,9,100,10,0],[101,13,101,39,0],[102,13,102,45,0],[103,13,103,126,0],[104,9,104,10,0]]);
    </script>
  </body>
</html>