<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Xml\XmlNodeListFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Xml;
using System.Xml.XPath;

// source: mvpxml.codeplex.com

namespace Umbraco.Core.Xml
{
	class XmlNodeListFactory
	{
		private XmlNodeListFactory() { }

		#region Public members

		/// &lt;summary&gt;
		/// Creates an instance of a &lt;see cref=&quot;XmlNodeList&quot;/&gt; that allows 
		/// enumerating &lt;see cref=&quot;XmlNode&quot;/&gt; elements in the iterator.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;iterator&quot;&gt;The result of a previous node selection 
		/// through an &lt;see cref=&quot;XPathNavigator&quot;/&gt; query.&lt;/param&gt;
		/// &lt;returns&gt;An initialized list ready to be enumerated.&lt;/returns&gt;
		/// &lt;remarks&gt;The underlying XML store used to issue the query must be 
		/// an object inheriting &lt;see cref=&quot;XmlNode&quot;/&gt;, such as 
		/// &lt;see cref=&quot;XmlDocument&quot;/&gt;.&lt;/remarks&gt;
		public static XmlNodeList CreateNodeList(XPathNodeIterator iterator)
		{
			return new XmlNodeListIterator(iterator);
		}

		#endregion Public members

		#region XmlNodeListIterator

		private class XmlNodeListIterator : XmlNodeList
		{
		    readonly XPathNodeIterator _iterator;
		    readonly IList&lt;XmlNode&gt; _nodes = new List&lt;XmlNode&gt;();

			public XmlNodeListIterator(XPathNodeIterator iterator)
			{
				_iterator = iterator.Clone();
			}

			public override System.Collections.IEnumerator GetEnumerator()
			{
				return new XmlNodeListEnumerator(this);
			}

			public override XmlNode Item(int index)
			{

				if (index &gt;= _nodes.Count)
					ReadTo(index);
				// Compatible behavior with .NET
				if (index &gt;= _nodes.Count || index &lt; 0)
					return null;
				return _nodes[index];
			}

			public override int Count
			{
				get
				{
					if (!_done) ReadToEnd();
					return _nodes.Count;
				}
			}


			/// &lt;summary&gt;
			/// Reads the entire iterator.
			/// &lt;/summary&gt;
			private void ReadToEnd()
			{
				while (_iterator.MoveNext())
				{
					var node = _iterator.Current as IHasXmlNode;
					// Check IHasXmlNode interface.
					if (node == null)
						throw new ArgumentException(&quot;IHasXmlNode is missing.&quot;);
					_nodes.Add(node.GetNode());
				}
				_done = true;
			}

			/// &lt;summary&gt;
			/// Reads up to the specified index, or until the 
			/// iterator is consumed.
			/// &lt;/summary&gt;
			private void ReadTo(int to)
			{
				while (_nodes.Count &lt;= to)
				{
					if (_iterator.MoveNext())
					{
						var node = _iterator.Current as IHasXmlNode;
						// Check IHasXmlNode interface.
						if (node == null)
							throw new ArgumentException(&quot;IHasXmlNode is missing.&quot;);
						_nodes.Add(node.GetNode());
					}
					else
					{
						_done = true;
						return;
					}
				}
			}

			/// &lt;summary&gt;
			/// Flags that the iterator has been consumed.
			/// &lt;/summary&gt;
			private bool Done
			{
				get { return _done; }
			}
            
            bool _done;

			/// &lt;summary&gt;
			/// Current count of nodes in the iterator (read so far).
			/// &lt;/summary&gt;
			private int CurrentPosition
			{
				get { return _nodes.Count; }
			}

			#region XmlNodeListEnumerator

			private class XmlNodeListEnumerator : System.Collections.IEnumerator
			{
			    readonly XmlNodeListIterator _iterator;
				int _position = -1;

				public XmlNodeListEnumerator(XmlNodeListIterator iterator)
				{
					_iterator = iterator;
				}

				#region IEnumerator Members

				void System.Collections.IEnumerator.Reset()
				{
					_position = -1;
				}


				bool System.Collections.IEnumerator.MoveNext()
				{
					_position++;
					_iterator.ReadTo(_position);

					// If we reached the end and our index is still 
					// bigger, there&#39;re no more items.
					if (_iterator.Done &amp;&amp; _position &gt;= _iterator.CurrentPosition)
						return false;

					return true;
				}

				object System.Collections.IEnumerator.Current
				{
					get
					{
						return _iterator[_position];
					}
				}

				#endregion
			}

			#endregion XmlNodeListEnumerator
		}

		#endregion XmlNodeListIterator
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,3,12,31,0],[12,32,12,33,0],[12,34,12,35,0],[27,3,27,4,0],[28,4,28,45,0],[29,3,29,4,0],[38,7,38,60,0],[40,4,40,58,0],[41,4,41,5,0],[42,5,42,34,0],[43,4,43,5,0],[46,4,46,5,0],[47,5,47,44,0],[48,4,48,5,0],[51,4,51,5,0],[53,5,53,31,0],[54,6,54,20,0],[56,5,56,44,0],[57,6,57,18,0],[58,5,58,26,0],[59,4,59,5,0],[64,5,64,6,0],[65,6,65,17,0],[65,18,65,30,0],[66,6,66,26,0],[67,5,67,6,0],[75,4,75,5,0],[76,5,76,33,0],[77,5,77,6,0],[78,6,78,50,0],[80,6,80,23,0],[81,7,81,62,0],[82,6,82,33,0],[83,5,83,6,0],[84,5,84,18,0],[85,4,85,5,0],[92,4,92,5,0],[93,5,93,31,0],[94,5,94,6,0],[95,6,95,31,0],[96,6,96,7,0],[97,7,97,51,0],[99,7,99,24,0],[100,8,100,63,0],[101,7,101,34,0],[102,6,102,7,0],[104,6,104,7,0],[105,7,105,20,0],[106,7,106,14,0],[108,5,108,6,0],[109,4,109,5,0],[116,9,116,10,0],[116,11,116,24,0],[116,25,116,26,0],[126,9,126,10,0],[126,11,126,31,0],[126,32,126,33,0],[134,5,134,24,0],[136,5,136,63,0],[137,5,137,6,0],[138,6,138,27,0],[139,5,139,6,0],[144,5,144,6,0],[145,6,145,21,0],[146,5,146,6,0],[150,5,150,6,0],[151,6,151,18,0],[152,6,152,34,0],[156,6,156,67,0],[157,7,157,20,0],[159,6,159,18,0],[160,5,160,6,0],[165,6,165,7,0],[166,7,166,35,0],[167,6,167,7,0]]);
    </script>
  </body>
</html>