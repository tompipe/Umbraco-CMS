<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\translation\Translation.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Net.Mail;
using System.Text.RegularExpressions;
using System.Web;
using Umbraco.Core.Logging;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.language;
using umbraco.cms.businesslogic.property;
using umbraco.cms.businesslogic.task;
using umbraco.cms.businesslogic.web;
using Umbraco.Core;
using Umbraco.Core.IO;

namespace umbraco.cms.businesslogic.translation
{
    [Obsolete(&quot;This will be removed in future versions, the translation utility will not work perfectly in v7.x&quot;)]
    public class Translation
    {
        public static void MakeNew(CMSNode node, User user, User translator, Language language, string comment, bool includeSubpages, bool sendEmail)
        {
            // Get translation taskType for obsolete task constructor
            var taskType = ApplicationContext.Current.Services.TaskService.GetTaskTypeByAlias(&quot;toTranslate&quot;);

            // Create pending task
            var task = new Task(new Umbraco.Core.Models.Task(taskType))
            {
                Comment = comment,
                Node = node,
                ParentUser = user,
                User = translator
            };
            task.Save();

            // Add log entry
            // Note: not updated to LogHelper as LogTypes.SendToTranslate might be something special, not sure
            Log.Add(LogTypes.SendToTranslate, user, node.Id, &quot;Translator: &quot; + translator.Name + &quot;, Language: &quot; + language.FriendlyName);

            // send it
            if (sendEmail)
            {
                var serverName = HttpContext.Current.Request.ServerVariables[&quot;SERVER_NAME&quot;];
                var port = HttpContext.Current.Request.Url.Port;

                if (port != 80)
                    serverName += &quot;:&quot; + port;

                serverName += IOHelper.ResolveUrl(SystemDirectories.Umbraco);

                // Send mail
                var subjectVars = new[] { serverName, node.Text };
                var bodyVars = new[] {
                                        translator.Name, node.Text, user.Name,
                                        serverName, task.Id.ToString(),
                                        language.FriendlyName
                                    };

                if (string.IsNullOrWhiteSpace(user.Email) == false &amp;&amp; user.Email.Contains(&quot;@&quot;) 
                    &amp;&amp; string.IsNullOrWhiteSpace(translator.Email) == false &amp;&amp; translator.Email.Contains(&quot;@&quot;))
                {
                    try
                    {
                        using (var mail = new MailMessage())
                        {
                            mail.From = new MailAddress(user.Email.Trim());
                            mail.To.Add(new MailAddress(translator.Email.Trim()));
                            mail.Subject = ui.Text(&quot;translation&quot;, &quot;mailSubject&quot;, subjectVars, translator); ;
                            mail.IsBodyHtml = false;
                            mail.Body = ui.Text(&quot;translation&quot;, &quot;mailBody&quot;, bodyVars, translator); ;
                            using (var smtpClient = new SmtpClient())
                                smtpClient.Send(mail);
                        }
                    }
                    catch (Exception ex)
                    {
                        LogHelper.Error&lt;Translation&gt;(&quot;Error sending translation e-mail&quot;, ex);
                    }
                }
                else
                {
                    LogHelper.Warn&lt;Translation&gt;(&quot;Could not send translation e-mail because either user or translator lacks e-mail in settings&quot;);
                }
            }

            if (includeSubpages == false)
                return;

            //store children array here because iterating over an Array property object is very inneficient.
            var children = node.Children;
            foreach (var child in children)
            {
                var cmsNode = (CMSNode) child;
                MakeNew(cmsNode, user, translator, language, comment, true, false);
            }
        }

        public static int CountWords(int DocumentId)
        {
            Document d = new Document(DocumentId);

            int words = CountWordsInString(d.Text);
            var props = d.GenericProperties;
            foreach (Property p in props)
            {
                var asString = p.Value as string;
                if (asString != null)
                {
                    var trimmed = asString.Trim();
                    if (trimmed.IsNullOrWhiteSpace() == false)
                    {
                        words += CountWordsInString(trimmed);
                    }
                }
            }

            return words;
        }

        private static int CountWordsInString(string Text)
        {
            string pattern = @&quot;&lt;(.|\n)*?&gt;&quot;;
            string tmpStr = Regex.Replace(Text, pattern, string.Empty);

            tmpStr = tmpStr.Replace(&quot;\t&quot;, &quot; &quot;).Trim();
            tmpStr = tmpStr.Replace(&quot;\n&quot;, &quot; &quot;);
            tmpStr = tmpStr.Replace(&quot;\r&quot;, &quot; &quot;);

            MatchCollection collection = Regex.Matches(tmpStr, @&quot;[\S]+&quot;);
            return collection.Count;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,0],[22,13,22,110,0],[25,13,31,15,0],[32,13,32,25,0],[36,13,36,137,0],[39,13,39,27,0],[40,13,40,14,0],[41,17,41,93,0],[42,17,42,65,0],[44,17,44,32,0],[45,21,45,46,0],[47,17,47,78,0],[50,17,50,67,0],[51,17,55,39,0],[57,17,58,111,0],[59,17,59,18,0],[61,21,61,22,0],[62,32,62,60,0],[63,25,63,26,0],[64,29,64,76,0],[65,29,65,83,0],[66,29,66,107,0],[66,108,66,109,0],[67,29,67,53,0],[68,29,68,98,0],[68,99,68,100,0],[69,36,69,69,0],[70,33,70,55,0],[71,25,71,26,0],[72,21,72,22,0],[73,21,73,41,0],[74,21,74,22,0],[75,25,75,94,0],[76,21,76,22,0],[77,17,77,18,0],[79,17,79,18,0],[80,21,80,145,0],[81,17,81,18,0],[82,13,82,14,0],[84,13,84,42,0],[85,17,85,24,0],[88,13,88,42,0],[89,13,89,20,0],[89,22,89,31,0],[89,32,89,34,0],[89,35,89,43,0],[90,13,90,14,0],[91,17,91,47,0],[92,17,92,84,0],[93,13,93,14,0],[94,9,94,10,0],[97,9,97,10,0],[98,13,98,51,0],[100,13,100,52,0],[101,13,101,45,0],[102,13,102,20,0],[102,22,102,32,0],[102,33,102,35,0],[102,36,102,41,0],[103,13,103,14,0],[104,17,104,50,0],[105,17,105,38,0],[106,17,106,18,0],[107,21,107,51,0],[108,21,108,63,0],[109,21,109,22,0],[110,25,110,62,0],[111,21,111,22,0],[112,17,112,18,0],[113,13,113,14,0],[115,13,115,26,0],[116,9,116,10,0],[119,9,119,10,0],[120,13,120,44,0],[121,13,121,72,0],[123,13,123,55,0],[124,13,124,48,0],[125,13,125,48,0],[127,13,127,74,0],[128,13,128,37,0],[129,9,129,10,0]]);
    </script>
  </body>
</html>