<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\PropertyGroupFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;

namespace Umbraco.Core.Persistence.Factories
{
    internal class PropertyGroupFactory 
    {
        private readonly int _contentTypeId;
        private readonly DateTime _createDate;
        private readonly DateTime _updateDate;
        //a callback to create a property type which can be injected via a contructor
        private readonly Func&lt;string, DataTypeDatabaseType, string, PropertyType&gt; _propertyTypeCtor;

        public PropertyGroupFactory(int contentTypeId)
        {
            _contentTypeId = contentTypeId;
            _propertyTypeCtor = (propertyEditorAlias, dbType, alias) =&gt; new PropertyType(propertyEditorAlias, dbType);
        }

        public PropertyGroupFactory(int contentTypeId, DateTime createDate, DateTime updateDate, Func&lt;string, DataTypeDatabaseType, string, PropertyType&gt; propertyTypeCtor)
        {
            _contentTypeId = contentTypeId;
            _createDate = createDate;
            _updateDate = updateDate;
            _propertyTypeCtor = propertyTypeCtor;
        }

        #region Implementation of IEntityFactory&lt;IEnumerable&lt;PropertyGroup&gt;,IEnumerable&lt;TabDto&gt;&gt;

        public IEnumerable&lt;PropertyGroup&gt; BuildEntity(IEnumerable&lt;PropertyTypeGroupDto&gt; groupDtos)
        {
            // groupDtos contains all the groups, those that are defined on the current
            // content type, and those that are inherited from composition content types
            var propertyGroups = new PropertyGroupCollection();
            foreach (var groupDto in groupDtos)
            {
                var group = new PropertyGroup();

                try
                {
                    group.DisableChangeTracking();

                    // if the group is defined on the current content type,
                    // assign its identifier, else it will be zero
                    if (groupDto.ContentTypeNodeId == _contentTypeId)
                        group.Id = groupDto.Id;

                    group.Name = groupDto.Text;
                    group.SortOrder = groupDto.SortOrder;
                    group.PropertyTypes = new PropertyTypeCollection();
                    group.Key = groupDto.UniqueId;

                    //Because we are likely to have a group with no PropertyTypes we need to ensure that these are excluded
                    var typeDtos = groupDto.PropertyTypeDtos.Where(x =&gt; x.Id &gt; 0);
                    foreach (var typeDto in typeDtos)
                    {
                        var tempGroupDto = groupDto;
                        var propertyType = _propertyTypeCtor(typeDto.DataTypeDto.PropertyEditorAlias,
                            typeDto.DataTypeDto.DbType.EnumParse&lt;DataTypeDatabaseType&gt;(true),
                            typeDto.Alias);

                        try
                        {
                            propertyType.DisableChangeTracking();

                            propertyType.Alias = typeDto.Alias;
                            propertyType.DataTypeDefinitionId = typeDto.DataTypeId;
                            propertyType.Description = typeDto.Description;
                            propertyType.Id = typeDto.Id;
                            propertyType.Key = typeDto.UniqueId;
                            propertyType.Name = typeDto.Name;
                            propertyType.Mandatory = typeDto.Mandatory;
                            propertyType.SortOrder = typeDto.SortOrder;
                            propertyType.ValidationRegExp = typeDto.ValidationRegExp;
                            propertyType.PropertyGroupId = new Lazy&lt;int&gt;(() =&gt; tempGroupDto.Id);
                            propertyType.CreateDate = _createDate;
                            propertyType.UpdateDate = _updateDate;

                            //on initial construction we don&#39;t want to have dirty properties tracked
                            // http://issues.umbraco.org/issue/U4-1946
                            propertyType.ResetDirtyProperties(false);
                            group.PropertyTypes.Add(propertyType);
                        }
                        finally
                        {
                            propertyType.EnableChangeTracking();
                        }
                    }
                    //on initial construction we don&#39;t want to have dirty properties tracked
                    // http://issues.umbraco.org/issue/U4-1946
                    group.ResetDirtyProperties(false);
                    propertyGroups.Add(group);
                }
                finally
                {
                    group.EnableChangeTracking();
                }
            }

            return propertyGroups;
        }

        public IEnumerable&lt;PropertyTypeGroupDto&gt; BuildDto(IEnumerable&lt;PropertyGroup&gt; entity)
        {
            return entity.Select(BuildGroupDto).ToList();
        }

        #endregion

        internal PropertyTypeGroupDto BuildGroupDto(PropertyGroup propertyGroup)
        {
            var dto = new PropertyTypeGroupDto
                             {
                                 ContentTypeNodeId = _contentTypeId,
                                 SortOrder = propertyGroup.SortOrder,
                                 Text = propertyGroup.Name,
                                 UniqueId = propertyGroup.Key
                             };

            if (propertyGroup.HasIdentity)
                dto.Id = propertyGroup.Id;

            dto.PropertyTypeDtos = propertyGroup.PropertyTypes.Select(propertyType =&gt; BuildPropertyTypeDto(propertyGroup.Id, propertyType)).ToList();

            return dto;
        }

        internal PropertyTypeDto BuildPropertyTypeDto(int tabId, PropertyType propertyType)
        {
            var propertyTypeDto = new PropertyTypeDto
            {
                Alias = propertyType.Alias,
                ContentTypeId = _contentTypeId,
                DataTypeId = propertyType.DataTypeDefinitionId,
                Description = propertyType.Description,
                Mandatory = propertyType.Mandatory,
                Name = propertyType.Name,
                SortOrder = propertyType.SortOrder,
                ValidationRegExp = propertyType.ValidationRegExp,
                UniqueId = propertyType.Key
            };

            if (tabId != default(int))
            {
                propertyTypeDto.PropertyTypeGroupId = tabId;
            }
            else
            {
                propertyTypeDto.PropertyTypeGroupId = null;
            }

            if (propertyType.HasIdentity)
                propertyTypeDto.Id = propertyType.Id;

            return propertyTypeDto;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,55,1],[18,9,18,10,1],[19,13,19,44,1],[20,13,20,73,1],[20,73,20,118,0],[20,118,20,119,1],[20,13,20,119,1],[21,9,21,10,1],[23,9,23,172,0],[24,9,24,10,0],[25,13,25,44,0],[26,13,26,38,0],[27,13,27,38,0],[28,13,28,50,0],[29,9,29,10,0],[34,9,34,10,0],[37,13,37,64,0],[38,13,38,20,0],[38,22,38,34,0],[38,35,38,37,0],[38,38,38,47,0],[39,13,39,14,0],[40,17,40,49,0],[43,17,43,18,0],[44,21,44,51,0],[48,21,48,70,0],[49,25,49,48,0],[51,21,51,48,0],[52,21,52,58,0],[53,21,53,72,0],[54,21,54,51,0],[57,21,57,73,0],[57,73,57,81,0],[57,81,57,83,0],[57,21,57,83,0],[58,21,58,28,0],[58,30,58,41,0],[58,42,58,44,0],[58,45,58,53,0],[59,21,59,22,0],[60,25,60,53,0],[61,25,63,44,0],[66,25,66,26,0],[67,29,67,66,0],[69,29,69,64,0],[70,29,70,84,0],[71,29,71,76,0],[72,29,72,58,0],[73,29,73,65,0],[74,29,74,62,0],[75,29,75,72,0],[76,29,76,72,0],[77,29,77,86,0],[78,29,78,80,0],[78,80,78,95,0],[78,95,78,97,0],[78,29,78,97,0],[79,29,79,67,0],[80,29,80,67,0],[84,29,84,70,0],[85,29,85,67,0],[86,25,86,26,0],[88,25,88,26,0],[89,29,89,65,0],[90,25,90,26,0],[91,21,91,22,0],[94,21,94,55,0],[95,21,95,47,0],[96,17,96,18,0],[98,17,98,18,0],[99,21,99,50,0],[100,17,100,18,0],[101,13,101,14,0],[103,13,103,35,0],[104,9,104,10,0],[107,9,107,10,0],[108,13,108,58,0],[109,9,109,10,0],[114,9,114,10,1],[115,13,121,32,1],[123,13,123,43,1],[124,17,124,43,1],[126,13,126,87,1],[126,87,126,139,1],[126,139,126,150,1],[126,13,126,150,1],[128,13,128,24,1],[129,9,129,10,1],[132,9,132,10,1],[133,13,144,15,1],[146,13,146,39,1],[147,13,147,14,1],[148,17,148,61,1],[149,13,149,14,1],[151,13,151,14,1],[152,17,152,60,1],[153,13,153,14,1],[155,13,155,42,1],[156,17,156,54,1],[158,13,158,36,1],[159,9,159,10,1]]);
    </script>
  </body>
</html>