<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\tinyMCE3\webcontrol\plugin\GzipModule.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * $Id: GzipModule.cs 439 2007-11-26 13:26:10Z spocke $
 *
 * @author Moxiecode
 * @copyright Copyright ï¿½ 2004-2007, Moxiecode Systems AB, All rights reserved.
 */

using System;
using System.Web;
using System.Text.RegularExpressions;
using System.IO;
using Umbraco.Core.IO;

namespace umbraco.editorControls.tinyMCE3.webcontrol.plugin
{
    /// &lt;summary&gt;
    /// Description of HttpHandler.
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class GzipModule : IModule
    {
        /// &lt;summary&gt;&lt;/summary&gt;
        /// &lt;param name=&quot;context&quot;&gt;Request context.&lt;/param&gt;
        public void ProcessRequest(HttpContext context)
        {
            HttpRequest request = context.Request;
            HttpResponse response = context.Response;
            HttpServerUtility server = context.Server;
            GzipCompressor gzipCompressor = new GzipCompressor();
            ConfigSection configSection = (ConfigSection)System.Web.HttpContext.Current.GetSection(&quot;TinyMCE&quot;);
            string suffix = &quot;&quot;, enc;
            string[] languages = request.QueryString[&quot;languages&quot;].Split(&#39;,&#39;);
            bool supportsGzip;

            // Set response headers
            response.ContentType = &quot;text/javascript&quot;;
            response.Charset = &quot;UTF-8&quot;;
            response.Buffer = false;

            // UMBRACO: Populate the configsection if it&#39;s empty
            if (configSection == null)
            {
                configSection = new ConfigSection();
                configSection.GzipEnabled = true;
                configSection.InstallPath = umbraco.editorControls.tinymce.tinyMCEConfiguration.JavascriptPath;
                configSection.GzipExpiresOffset = TimeSpan.FromDays(10).Ticks;
            }

            // Setup cache
            response.Cache.SetExpires(DateTime.Now.AddTicks(configSection.GzipExpiresOffset));
            response.Cache.SetCacheability(HttpCacheability.Public);
            response.Cache.SetValidUntilExpires(false);

            // Check if it supports gzip
            enc = Regex.Replace(&quot;&quot; + request.Headers[&quot;Accept-Encoding&quot;], @&quot;\s+&quot;, &quot;&quot;).ToLower();
            supportsGzip = enc.IndexOf(&quot;gzip&quot;) != -1 || request.Headers[&quot;---------------&quot;] != null;
            enc = enc.IndexOf(&quot;x-gzip&quot;) != -1 ? &quot;x-gzip&quot; : &quot;gzip&quot;;

            // Handle mode/suffix
            if (configSection.Mode != null)
                suffix = &quot;_&quot; + configSection.Mode;

            gzipCompressor.AddData(&quot;var tinyMCEPreInit = {base : &#39;&quot; + configSection.InstallPath + &quot;&#39;, suffix : &#39;&quot; + suffix + &quot;&#39;};&quot;);

            // Add core
            gzipCompressor.AddFile(IOHelper.MapPath(configSection.InstallPath + &quot;/tiny_mce&quot; + suffix + &quot;.js&quot;));

            // Add core languages
            foreach (string lang in languages)
                gzipCompressor.AddFile(IOHelper.MapPath(configSection.InstallPath + &quot;/langs/&quot; + lang + &quot;.js&quot;));

            // Add themes
            if (request.QueryString[&quot;themes&quot;] != null)
            {
                foreach (string theme in request.QueryString[&quot;themes&quot;].Split(&#39;,&#39;))
                {
                    gzipCompressor.AddFile(IOHelper.MapPath(configSection.InstallPath + &quot;/themes/&quot; + theme + &quot;/editor_template&quot; + suffix + &quot;.js&quot;));

                    // Add theme languages
                    foreach (string lang in languages)
                    {
                        string path = IOHelper.MapPath(configSection.InstallPath + &quot;/themes/&quot; + theme + &quot;/langs/&quot; + lang + &quot;.js&quot;);

                        if (File.Exists(path))
                            gzipCompressor.AddFile(path);
                    }

                    gzipCompressor.AddData(&quot;tinymce.ThemeManager.urls[&#39;&quot; + theme + &quot;&#39;] = tinymce.baseURL+&#39;/themes/&quot; + theme + &quot;&#39;;&quot;);
                }
            }

            // Add plugins
            if (request.QueryString[&quot;plugins&quot;] != null)
            {
                foreach (string plugin in request.QueryString[&quot;plugins&quot;].Split(&#39;,&#39;))
                {
                    gzipCompressor.AddFile(IOHelper.MapPath(configSection.InstallPath + &quot;/plugins/&quot; + plugin + &quot;/editor_plugin&quot; + suffix + &quot;.js&quot;));

                    // Add plugin languages
                    foreach (string lang in languages)
                    {
                        string path = IOHelper.MapPath(configSection.InstallPath + &quot;/plugins/&quot; + plugin + &quot;/langs/&quot; + lang + &quot;.js&quot;);

                        if (File.Exists(path))
                            gzipCompressor.AddFile(path);
                    }

                    gzipCompressor.AddData(&quot;tinymce.ThemeManager.urls[&#39;&quot; + plugin + &quot;&#39;] = tinymce.baseURL+&#39;/plugins/&quot; + plugin + &quot;&#39;;&quot;);
                }
            }

            // Output compressed file
            gzipCompressor.NoCompression = !supportsGzip || configSection.GzipNoCompression;
            if (!gzipCompressor.NoCompression)
                response.AppendHeader(&quot;Content-Encoding&quot;, enc);

            gzipCompressor.DiskCache = configSection.GzipDiskCache;
            gzipCompressor.CachePath = configSection.GzipCachePath;

            gzipCompressor.Compress(response.OutputStream);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,0],[26,13,26,51,0],[27,13,27,54,0],[28,13,28,55,0],[29,13,29,66,0],[30,13,30,111,0],[31,13,31,31,0],[32,13,32,78,0],[36,13,36,54,0],[37,13,37,40,0],[38,13,38,37,0],[41,13,41,39,0],[42,13,42,14,0],[43,17,43,53,0],[44,17,44,50,0],[45,17,45,112,0],[46,17,46,79,0],[47,13,47,14,0],[50,13,50,95,0],[51,13,51,69,0],[52,13,52,56,0],[55,13,55,96,0],[56,13,56,100,0],[57,13,57,67,0],[60,13,60,44,0],[61,17,61,51,0],[63,13,63,133,0],[66,13,66,112,0],[69,13,69,20,0],[69,22,69,33,0],[69,34,69,36,0],[69,37,69,46,0],[70,17,70,112,0],[73,13,73,55,0],[74,13,74,14,0],[75,17,75,24,0],[75,26,75,38,0],[75,39,75,41,0],[75,42,75,82,0],[76,17,76,18,0],[77,21,77,148,0],[80,21,80,28,0],[80,30,80,41,0],[80,42,80,44,0],[80,45,80,54,0],[81,21,81,22,0],[82,25,82,131,0],[84,25,84,47,0],[85,29,85,58,0],[86,21,86,22,0],[88,21,88,133,0],[89,17,89,18,0],[90,13,90,14,0],[93,13,93,56,0],[94,13,94,14,0],[95,17,95,24,0],[95,26,95,39,0],[95,40,95,42,0],[95,43,95,84,0],[96,17,96,18,0],[97,21,97,148,0],[100,21,100,28,0],[100,30,100,41,0],[100,42,100,44,0],[100,45,100,54,0],[101,21,101,22,0],[102,25,102,133,0],[104,25,104,47,0],[105,29,105,58,0],[106,21,106,22,0],[108,21,108,136,0],[109,17,109,18,0],[110,13,110,14,0],[113,13,113,93,0],[114,13,114,47,0],[115,17,115,64,0],[117,13,117,68,0],[118,13,118,68,0],[120,13,120,60,0],[121,9,121,10,0]]);
    </script>
  </body>
</html>