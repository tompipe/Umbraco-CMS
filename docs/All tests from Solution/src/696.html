<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\HtmlStringUtilities.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Web;
using HtmlAgilityPack;

namespace Umbraco.Web
{
    /// &lt;summary&gt;
    /// Utility class for working with strings and HTML in views
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// The UmbracoHelper uses this class for it&#39;s string methods
    /// &lt;/remarks&gt;
    public sealed class HtmlStringUtilities
    {
        /// &lt;summary&gt;
        /// Replaces text line breaks with html line breaks
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The text.&lt;/param&gt;
        /// &lt;returns&gt;The text with text line breaks replaced with html linebreaks (&lt;br/&gt;)&lt;/returns&gt;
        public string ReplaceLineBreaksForHtml(string text)
        {
            return text.Replace(&quot;\n&quot;, &quot;&lt;br/&gt;\n&quot;);
        }

        public HtmlString StripHtmlTags(string html, params string[] tags)
        {
            var doc = new HtmlDocument();
            doc.LoadHtml(&quot;&lt;p&gt;&quot; + html + &quot;&lt;/p&gt;&quot;);
            var targets = new List&lt;HtmlNode&gt;();

            var nodes = doc.DocumentNode.FirstChild.SelectNodes(&quot;.//*&quot;);
            if (nodes != null)
            {
                foreach (var node in nodes)
                {
                    //is element
                    if (node.NodeType != HtmlNodeType.Element) continue;
                    var filterAllTags = (tags == null || !tags.Any());
                    if (filterAllTags || tags.Any(tag =&gt; string.Equals(tag, node.Name, StringComparison.CurrentCultureIgnoreCase)))
                    {
                        targets.Add(node);
                    }
                }
                foreach (var target in targets)
                {
                    HtmlNode content = doc.CreateTextNode(target.InnerText);
                    target.ParentNode.ReplaceChild(content, target);
                }
            }
            else
            {
                return new HtmlString(html);
            }
            return new HtmlString(doc.DocumentNode.FirstChild.InnerHtml);
        }

        internal string Join&lt;TIgnore&gt;(string seperator, params object[] args)
        {
            var results = args.Where(arg =&gt; arg != null &amp;&amp; arg.GetType() != typeof(TIgnore)).Select(arg =&gt; string.Format(&quot;{0}&quot;, arg)).Where(sArg =&gt; !string.IsNullOrWhiteSpace(sArg)).ToList();
            return string.Join(seperator, results);
        }

        internal string Concatenate&lt;TIgnore&gt;(params object[] args)
        {
            var result = new StringBuilder();
            foreach (var sArg in args.Where(arg =&gt; arg != null &amp;&amp; arg.GetType() != typeof(TIgnore)).Select(arg =&gt; string.Format(&quot;{0}&quot;, arg)).Where(sArg =&gt; !string.IsNullOrWhiteSpace(sArg)))
            {
                result.Append(sArg);
            }
            return result.ToString();
        }

        internal string Coalesce&lt;TIgnore&gt;(params object[] args)
        {
            foreach (var sArg in args.Where(arg =&gt; arg != null &amp;&amp; arg.GetType() != typeof(TIgnore)).Select(arg =&gt; string.Format(&quot;{0}&quot;, arg)).Where(sArg =&gt; !string.IsNullOrWhiteSpace(sArg)))
            {
                return sArg;
            }
            return string.Empty;
        }

        public IHtmlString Truncate(string html, int length, bool addElipsis, bool treatTagsAsContent)
        {
            using (var outputms = new MemoryStream())
            {
                using (var outputtw = new StreamWriter(outputms))
                {
                    using (var ms = new MemoryStream())
                    {
                        using (var tw = new StreamWriter(ms))
                        {
                            tw.Write(html);
                            tw.Flush();
                            ms.Position = 0;
                            var tagStack = new Stack&lt;string&gt;();

                            using (TextReader tr = new StreamReader(ms))
                            {
                                bool isInsideElement = false,
                                    lengthReached = false,
                                    insideTagSpaceEncountered = false,
                                    isTagClose = false;

                                int ic = 0,
                                    currentLength = 0,
                                    currentTextLength = 0;

                                string currentTag = string.Empty,
                                    tagContents = string.Empty;

                                while ((ic = tr.Read()) != -1)
                                {
                                    bool write = true;

                                    switch ((char)ic)
                                    {
                                        case &#39;&lt;&#39;:
                                            if (!lengthReached)
                                            {
                                                isInsideElement = true;
                                            }

                                            insideTagSpaceEncountered = false;
                                            currentTag = string.Empty;
                                            tagContents = string.Empty;
                                            isTagClose = false;
                                            if (tr.Peek() == (int)&#39;/&#39;)
                                            {
                                                isTagClose = true;
                                            }
                                            break;

                                        case &#39;&gt;&#39;:
                                            isInsideElement = false;

                                            if (isTagClose &amp;&amp; tagStack.Count &gt; 0)
                                            {
                                                string thisTag = tagStack.Pop();
                                                outputtw.Write(&quot;&lt;/&quot; + thisTag + &quot;&gt;&quot;);
                                            }
                                            if (!isTagClose &amp;&amp; currentTag.Length &gt; 0)
                                            {
                                                if (!lengthReached)
                                                {
                                                    tagStack.Push(currentTag);
                                                    outputtw.Write(&quot;&lt;&quot; + currentTag);
                                                    if (!string.IsNullOrEmpty(tagContents))
                                                    {
                                                        if (tagContents.EndsWith(&quot;/&quot;))
                                                        {
                                                            // No end tag e.g. &lt;br /&gt;.
                                                            tagStack.Pop();
                                                        }

                                                        outputtw.Write(tagContents);
                                                        write = true;
                                                        insideTagSpaceEncountered = false;
                                                    }
                                                    outputtw.Write(&quot;&gt;&quot;);
                                                }
                                            }
                                            // Continue to next iteration of the text reader.
                                            continue;

                                        default:
                                            if (isInsideElement)
                                            {
                                                if (ic == (int)&#39; &#39;)
                                                {
                                                    if (!insideTagSpaceEncountered)
                                                    {
                                                        insideTagSpaceEncountered = true;
                                                    }
                                                }

                                                if (!insideTagSpaceEncountered)
                                                {
                                                    currentTag += (char)ic;
                                                }
                                            }
                                            break;
                                    }

                                    if (isInsideElement || insideTagSpaceEncountered)
                                    {
                                        write = false;
                                        if (insideTagSpaceEncountered)
                                        {
                                            tagContents += (char)ic;
                                        }
                                    }

                                    if (!isInsideElement || treatTagsAsContent)
                                    {
                                        currentTextLength++;
                                    }

                                    if (currentTextLength &lt;= length || (lengthReached &amp;&amp; isInsideElement))
                                    {
                                        if (write)
                                        {
                                            var charToWrite = (char)ic;
                                            outputtw.Write(charToWrite);
                                            currentLength++;
                                        }
                                    }

                                    if (!lengthReached &amp;&amp; currentTextLength &gt;= length)
                                    {
                                        // if the last character added was the first of a two character unicode pair, add the second character
                                        if (Char.IsHighSurrogate((char)ic))
                                        {
                                            var lowSurrogate = tr.Read();
                                            outputtw.Write((char)lowSurrogate);
                                        }

                                        // Reached truncate limit.
                                        if (addElipsis)
                                        {
                                            outputtw.Write(&quot;&amp;hellip;&quot;);
                                        }
                                        lengthReached = true;
                                    }

                                }

                            }
                        }
                    }
                    outputtw.Flush();
                    outputms.Position = 0;
                    using (TextReader outputtr = new StreamReader(outputms))
                    {
                        return new HtmlString(outputtr.ReadToEnd().Replace(&quot;  &quot;, &quot; &quot;).Trim());
                    }
                }
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,0],[26,13,26,50,0],[27,9,27,10,0],[30,9,30,10,0],[31,13,31,42,0],[32,13,32,49,0],[33,13,33,48,0],[35,13,35,73,0],[36,13,36,31,0],[37,13,37,14,0],[38,17,38,24,0],[38,26,38,34,0],[38,35,38,37,0],[38,38,38,43,0],[39,17,39,18,0],[41,21,41,63,0],[41,64,41,73,0],[42,21,42,71,0],[43,21,43,58,0],[43,58,43,130,0],[43,130,43,132,0],[43,21,43,132,0],[44,21,44,22,0],[45,25,45,43,0],[46,21,46,22,0],[47,17,47,18,0],[48,17,48,24,0],[48,26,48,36,0],[48,37,48,39,0],[48,40,48,47,0],[49,17,49,18,0],[50,21,50,77,0],[51,21,51,69,0],[52,17,52,18,0],[53,13,53,14,0],[55,13,55,14,0],[56,17,56,45,0],[58,13,58,74,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,45,0],[63,45,63,92,0],[63,92,63,108,0],[63,108,63,133,0],[63,133,63,149,0],[63,149,63,181,0],[63,181,63,192,0],[63,13,63,192,0],[64,13,64,52,0],[65,9,65,10,0],[68,9,68,10,0],[69,13,69,46,0],[70,13,70,20,0],[70,22,70,30,0],[70,31,70,33,0],[70,34,70,52,0],[70,52,70,99,0],[70,99,70,115,0],[70,115,70,140,0],[70,140,70,156,0],[70,156,70,188,0],[70,188,70,189,0],[70,34,70,189,0],[71,13,71,14,0],[72,17,72,37,0],[73,13,73,14,0],[74,13,74,38,0],[75,9,75,10,0],[78,9,78,10,0],[79,13,79,20,0],[79,22,79,30,0],[79,31,79,33,0],[79,34,79,52,0],[79,52,79,99,0],[79,99,79,115,0],[79,115,79,140,0],[79,140,79,156,0],[79,156,79,188,0],[79,188,79,189,0],[79,34,79,189,0],[80,13,80,14,0],[81,17,81,29,0],[83,13,83,33,0],[84,9,84,10,0],[87,9,87,10,1],[88,20,88,53,1],[89,13,89,14,1],[90,24,90,65,1],[91,17,91,18,1],[92,28,92,55,1],[93,21,93,22,1],[94,32,94,61,1],[95,25,95,26,1],[96,29,96,44,1],[97,29,97,40,1],[98,29,98,45,1],[99,29,99,64,1],[101,36,101,72,1],[102,29,102,30,1],[103,33,103,61,1],[104,37,104,58,1],[105,37,105,70,1],[106,37,106,55,1],[108,33,108,43,1],[109,37,109,54,1],[110,37,110,58,1],[112,33,112,65,1],[113,37,113,63,1],[115,33,115,63,1],[116,33,116,34,1],[117,37,117,55,1],[119,37,119,54,1],[122,45,122,64,1],[123,45,123,46,1],[124,49,124,72,1],[125,45,125,46,1],[127,45,127,79,1],[128,45,128,71,1],[129,45,129,72,1],[130,45,130,64,1],[131,45,131,71,1],[132,45,132,46,1],[133,49,133,67,1],[134,45,134,46,1],[135,45,135,51,1],[138,45,138,69,1],[140,45,140,82,1],[141,45,141,46,1],[142,49,142,81,1],[143,49,143,86,1],[144,45,144,46,1],[145,45,145,86,1],[146,45,146,46,1],[147,49,147,68,1],[148,49,148,50,1],[149,53,149,79,1],[150,53,150,86,1],[151,53,151,92,1],[152,53,152,54,1],[153,57,153,87,1],[154,57,154,58,0],[156,61,156,76,0],[157,57,157,58,0],[159,57,159,85,1],[160,57,160,70,1],[161,57,161,91,1],[162,53,162,54,1],[163,53,163,73,1],[164,49,164,50,1],[165,45,165,46,1],[167,45,167,54,1],[170,45,170,65,1],[171,45,171,46,1],[172,49,172,68,1],[173,49,173,50,1],[174,53,174,84,1],[175,53,175,54,1],[176,57,176,90,1],[177,53,177,54,1],[178,49,178,50,1],[180,49,180,80,1],[181,49,181,50,1],[182,53,182,76,1],[183,49,183,50,1],[184,45,184,46,1],[185,45,185,51,1],[188,37,188,86,1],[189,37,189,38,1],[190,41,190,55,1],[191,41,191,71,1],[192,41,192,42,1],[193,45,193,69,1],[194,41,194,42,1],[195,37,195,38,1],[197,37,197,80,1],[198,37,198,38,1],[199,41,199,61,1],[200,37,200,38,1],[202,37,202,107,1],[203,37,203,38,1],[204,41,204,51,1],[205,41,205,42,1],[206,45,206,72,1],[207,45,207,73,1],[208,45,208,61,1],[209,41,209,42,1],[210,37,210,38,1],[212,37,212,87,1],[213,37,213,38,1],[215,41,215,76,1],[216,41,216,42,0],[217,45,217,74,0],[218,45,218,80,0],[219,41,219,42,0],[222,41,222,56,1],[223,41,223,42,1],[224,45,224,72,1],[225,41,225,42,1],[226,41,226,62,1],[227,37,227,38,1],[229,33,229,34,1],[231,29,231,30,1],[232,25,232,26,1],[233,21,233,22,1],[234,21,234,38,1],[235,21,235,43,1],[236,28,236,76,1],[237,21,237,22,1],[238,25,238,95,1],[242,9,242,10,1]]);
    </script>
  </body>
</html>