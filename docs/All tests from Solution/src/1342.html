<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\ContentControllerBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Web.Http;
using System.Web.Mvc;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Editors;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebApi.Filters;


namespace Umbraco.Web.Editors
{
    /// &lt;summary&gt;
    /// An abstract base controller used for media/content (and probably members) to try to reduce code replication.
    /// &lt;/summary&gt;
    [OutgoingDateTimeFormat]
    public abstract class ContentControllerBase : BackOfficeNotificationsController
    {
        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        protected ContentControllerBase()
            : this(UmbracoContext.Current)
        {            
        }

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        protected ContentControllerBase(UmbracoContext umbracoContext)
            : base(umbracoContext)
        {
        }

        protected HttpResponseMessage HandleContentNotFound(object id, bool throwException = true)
        {
            ModelState.AddModelError(&quot;id&quot;, string.Format(&quot;content with id: {0} was not found&quot;, id));
            var errorResponse = Request.CreateErrorResponse(
                HttpStatusCode.NotFound,
                ModelState);
            if (throwException)
            {
                throw new HttpResponseException(errorResponse);    
            }
            return errorResponse;
        }

        protected void UpdateName&lt;TPersisted&gt;(ContentBaseItemSave&lt;TPersisted&gt; contentItem) 
            where TPersisted : IContentBase
        {
            //Don&#39;t update the name if it is empty
            if (!contentItem.Name.IsNullOrWhiteSpace())
            {
                contentItem.PersistedContent.Name = contentItem.Name;
            }
        }

        protected HttpResponseMessage PerformSort(ContentSortOrder sorted)
        {
            if (sorted == null)
            {
                return Request.CreateResponse(HttpStatusCode.NotFound);
            }

            //if there&#39;s nothing to sort just return ok
            if (sorted.IdSortOrder.Length == 0)
            {
                return Request.CreateResponse(HttpStatusCode.OK);
            }

            return null;
        }

        /// &lt;summary&gt;
        /// Maps the dto property values to the persisted model
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;TPersisted&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;contentItem&quot;&gt;&lt;/param&gt;
        protected virtual void MapPropertyValues&lt;TPersisted&gt;(ContentBaseItemSave&lt;TPersisted&gt; contentItem)
            where TPersisted : IContentBase
        {
            //Map the property values
            foreach (var property in contentItem.ContentDto.Properties)
            {
                //get the dbo property
                var dboProperty = contentItem.PersistedContent.Properties[property.Alias];

                //create the property data to send to the property editor
                var dictionary = new Dictionary&lt;string, object&gt;();
                //add the files if any
                var files = contentItem.UploadedFiles.Where(x =&gt; x.PropertyAlias == property.Alias).ToArray();

                foreach (var file in files)
                    file.FileName = file.FileName.ToSafeFileName();

                if (files.Any())
                    dictionary.Add(&quot;files&quot;, files);
                
                var data = new ContentPropertyData(property.Value, property.PreValues, dictionary);

                //get the deserialized value from the property editor
                if (property.PropertyEditor == null)
                {
                    LogHelper.Warn&lt;ContentController&gt;(&quot;No property editor found for property &quot; + property.Alias);
                }
                else
                {
                    var valueEditor = property.PropertyEditor.ValueEditor;
                    //don&#39;t persist any bound value if the editor is readonly
                    if (valueEditor.IsReadOnly == false)
                    {                        
                        var propVal = property.PropertyEditor.ValueEditor.ConvertEditorToDb(data, dboProperty.Value);
                        var supportTagsAttribute = TagExtractor.GetAttribute(property.PropertyEditor);
                        if (supportTagsAttribute != null)
                        {
                            TagExtractor.SetPropertyTags(dboProperty, data, propVal, supportTagsAttribute);
                        }
                        else
                        {
                            dboProperty.Value = propVal;
                        }
                    }    
                    
                }
            }
        }

        protected void HandleInvalidModelState&lt;T, TPersisted&gt;(ContentItemDisplayBase&lt;T, TPersisted&gt; display) 
            where TPersisted : IContentBase 
            where T : ContentPropertyBasic
        {
            //lasty, if it is not valid, add the modelstate to the outgoing object and throw a 403
            if (!ModelState.IsValid)
            {
                display.Errors = ModelState.ToErrorDictionary();
                throw new HttpResponseException(Request.CreateValidationErrorResponse(display));
            }
        }

        /// &lt;summary&gt;
        /// A helper method to attempt to get the instance from the request storage if it can be found there,
        /// otherwise gets it from the callback specified
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;TPersisted&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;getFromService&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// This is useful for when filters have alraedy looked up a persisted entity and we don&#39;t want to have
        /// to look it up again.
        /// &lt;/remarks&gt;
        protected TPersisted GetObjectFromRequest&lt;TPersisted&gt;(Func&lt;TPersisted&gt; getFromService)
        {
            //checks if the request contains the key and the item is not null, if that is the case, return it from the request, otherwise return
            // it from the callback
            return Request.Properties.ContainsKey(typeof(TPersisted).ToString()) &amp;&amp; Request.Properties[typeof(TPersisted).ToString()] != null
                ? (TPersisted) Request.Properties[typeof (TPersisted).ToString()]
                : getFromService();
        } 

        /// &lt;summary&gt;
        /// Returns true if the action passed in means we need to create something new
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal static bool IsCreatingAction(ContentSaveAction action)
        {
            return (action.ToString().EndsWith(&quot;New&quot;));
        }

        protected void AddCancelMessage(INotificationModel display, 
            string header = &quot;speechBubbles/operationCancelledHeader&quot;,             
            string message = &quot;speechBubbles/operationCancelledText&quot;,
            bool localizeHeader = true,
            bool localizeMessage = true)
        {
            //if there&#39;s already a default event message, don&#39;t add our default one
            var msgs = UmbracoContext.GetCurrentEventMessages();
            if (msgs != null &amp;&amp; msgs.GetAll().Any(x =&gt; x.IsDefaultEventMessage)) return;

            display.AddWarningNotification(
                localizeHeader ? Services.TextService.Localize(header) : header,
                localizeMessage ? Services.TextService.Localize(message): message);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,15,30,43,0],[31,9,31,10,0],[32,9,32,10,0],[39,15,39,35,0],[40,9,40,10,0],[41,9,41,10,0],[44,9,44,10,0],[45,13,45,101,0],[46,13,48,29,0],[49,13,49,32,0],[50,13,50,14,0],[51,17,51,64,0],[53,13,53,34,0],[54,9,54,10,0],[58,9,58,10,0],[60,13,60,56,0],[61,13,61,14,0],[62,17,62,70,0],[63,13,63,14,0],[64,9,64,10,0],[67,9,67,10,0],[68,13,68,32,0],[69,13,69,14,0],[70,17,70,72,0],[74,13,74,48,0],[75,13,75,14,0],[76,17,76,66,0],[79,13,79,25,0],[80,9,80,10,0],[89,9,89,10,0],[91,13,91,20,0],[91,22,91,34,0],[91,35,91,37,0],[91,38,91,71,0],[92,13,92,14,0],[94,17,94,91,0],[97,17,97,67,0],[99,17,99,66,0],[99,66,99,99,0],[99,99,99,111,0],[99,17,99,111,0],[101,17,101,24,0],[101,26,101,34,0],[101,35,101,37,0],[101,38,101,43,0],[102,21,102,68,0],[104,17,104,33,0],[105,21,105,52,0],[107,17,107,100,0],[110,17,110,53,0],[111,17,111,18,0],[112,21,112,114,0],[113,17,113,18,0],[115,17,115,18,0],[116,21,116,75,0],[118,21,118,57,0],[119,21,119,22,0],[120,25,120,118,0],[121,25,121,103,0],[122,25,122,58,0],[123,25,123,26,0],[124,29,124,108,0],[125,25,125,26,0],[127,25,127,26,0],[128,29,128,57,0],[129,25,129,26,0],[130,21,130,22,0],[132,17,132,18,0],[133,13,133,14,0],[134,9,134,10,0],[139,9,139,10,0],[141,13,141,37,0],[142,13,142,14,0],[143,17,143,65,0],[144,17,144,97,0],[146,9,146,10,0],[160,9,160,10,0],[163,13,165,36,0],[166,9,166,10,0],[174,9,174,10,0],[175,13,175,56,0],[176,9,176,10,0],[183,9,183,10,0],[185,13,185,65,0],[186,13,186,56,0],[186,56,186,79,0],[186,79,186,81,0],[186,13,186,81,0],[186,82,186,89,0],[188,13,190,84,0],[191,9,191,10,0]]);
    </script>
  </body>
</html>