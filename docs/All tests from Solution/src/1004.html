<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\PublishValueValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Services;

namespace Umbraco.Web.PropertyEditors
{
    /// &lt;summary&gt;
    /// A custom value editor for any property editor that stores a pre-value int id so that we can ensure that the &#39;value&#39; not the ID get&#39;s put into cache
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This is required for legacy/backwards compatibility, otherwise we&#39;d just store the string version and cache the string version without
    /// needing additional lookups.
    /// &lt;/remarks&gt;
    internal class PublishValueValueEditor : PropertyValueEditorWrapper
    {
        private readonly IDataTypeService _dataTypeService;

        internal PublishValueValueEditor(IDataTypeService dataTypeService, PropertyValueEditor wrapped)
            : base(wrapped)
        {
            _dataTypeService = dataTypeService;
        }

        public PublishValueValueEditor(PropertyValueEditor wrapped)
            : this(ApplicationContext.Current.Services.DataTypeService, wrapped)
        {
        }

        /// &lt;summary&gt;
        /// Need to lookup the pre-values and put the string version in cache, not the ID (which is what is stored in the db)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;property&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;propertyType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeService&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override string ConvertDbToString(Property property, PropertyType propertyType, IDataTypeService dataTypeService)
        {
            if (property.Value == null)
                return null;

            var idAttempt = property.Value.TryConvertTo&lt;int&gt;();
            if (idAttempt.Success)
            {
                var preValId = idAttempt.Result;
                var preVals = GetPreValues(property);
                if (preVals != null)
                {
                    if (preVals.Any(x =&gt; x.Value.Id == preValId))
                    {
                        return preVals.Single(x =&gt; x.Value.Id == preValId).Value.Value;
                    }

                    LogHelper.Warn&lt;PublishValueValueEditor&gt;(&quot;Could not find a pre value with ID &quot; + preValId + &quot; for property alias &quot; + property.Alias);
                }
            }
            
            return base.ConvertDbToString(property, propertyType, dataTypeService);
        }

        protected IDictionary&lt;string, PreValue&gt; GetPreValues(Property property)
        {
            var preVals = _dataTypeService.GetPreValuesCollectionByDataTypeId(property.PropertyType.DataTypeDefinitionId);
            if (preVals != null)
            {
                var dictionary = preVals.FormatAsDictionary();
                return dictionary;
            }
            return null;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,15,23,28,1],[24,9,24,10,1],[25,13,25,48,1],[26,9,26,10,1],[29,15,29,81,1],[30,9,30,10,1],[31,9,31,10,1],[41,9,41,10,1],[42,13,42,40,1],[43,17,43,29,0],[45,13,45,64,1],[46,13,46,35,1],[47,13,47,14,1],[48,17,48,49,1],[49,17,49,54,1],[50,17,50,37,1],[51,17,51,18,1],[52,21,52,42,1],[52,42,52,64,1],[52,64,52,66,1],[52,21,52,66,1],[53,21,53,22,1],[54,25,54,52,1],[54,52,54,74,1],[54,74,54,88,1],[54,25,54,88,1],[57,21,57,153,1],[58,17,58,18,1],[59,13,59,14,1],[61,13,61,84,1],[62,9,62,10,1],[65,9,65,10,1],[66,13,66,123,1],[67,13,67,33,1],[68,13,68,14,1],[69,17,69,63,1],[70,17,70,35,1],[72,13,72,25,0],[73,9,73,10,1]]);
    </script>
  </body>
</html>