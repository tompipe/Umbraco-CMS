<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Security\Identity\BackOfficeCookieManager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using Microsoft.Owin;
using Microsoft.Owin.Infrastructure;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;

namespace Umbraco.Web.Security.Identity
{
    /// &lt;summary&gt;
    /// A custom cookie manager that is used to read the cookie from the request.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// Umbraco&#39;s back office cookie needs to be read on two paths: /umbraco and /install and /base therefore we cannot just set the cookie path to be /umbraco, 
    /// instead we&#39;ll specify our own cookie manager and return null if the request isn&#39;t for an acceptable path.
    /// &lt;/remarks&gt;
    internal class BackOfficeCookieManager : ChunkingCookieManager, ICookieManager
    {
        private readonly IUmbracoContextAccessor _umbracoContextAccessor;
        private readonly string[] _explicitPaths;
        private readonly string _getRemainingSecondsPath;

        public BackOfficeCookieManager(IUmbracoContextAccessor umbracoContextAccessor)
            : this(umbracoContextAccessor, null)
        {
            
        }
        public BackOfficeCookieManager(IUmbracoContextAccessor umbracoContextAccessor, IEnumerable&lt;string&gt; explicitPaths)
        {
            _umbracoContextAccessor = umbracoContextAccessor;
            _explicitPaths = explicitPaths == null ? null : explicitPaths.ToArray();
            _getRemainingSecondsPath = string.Format(&quot;{0}/backoffice/UmbracoApi/Authentication/GetRemainingTimeoutSeconds&quot;, GlobalSettings.Path);
        }

        /// &lt;summary&gt;
        /// Explicitly implement this so that we filter the request
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;context&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;key&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        string ICookieManager.GetRequestCookie(IOwinContext context, string key)
        {
            if (_umbracoContextAccessor.Value == null || context.Request.Uri.IsClientSideRequest())
            {
                return null;
            }
            
            return ShouldAuthenticateRequest(
                context, 
                _umbracoContextAccessor.Value.OriginalRequestUrl) == false 
                //Don&#39;t auth request, don&#39;t return a cookie
                ? null 
                //Return the default implementation
                : base.GetRequestCookie(context, key);
        }

        /// &lt;summary&gt;
        /// Determines if we should authenticate the request
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ctx&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;originalRequestUrl&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;checkForceAuthTokens&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// We auth the request when:
        /// * it is a back office request
        /// * it is an installer request
        /// * it is a /base request
        /// * it is a preview request
        /// &lt;/remarks&gt;
        internal bool ShouldAuthenticateRequest(IOwinContext ctx, Uri originalRequestUrl, bool checkForceAuthTokens = true)
        {
            if (_umbracoContextAccessor.Value.Application.IsConfigured == false
                &amp;&amp; _umbracoContextAccessor.Value.Application.DatabaseContext.IsDatabaseConfigured == false)
            {
                //Do not authenticate the request if we don&#39;t have a db and we are not configured - since we will never need
                // to know a current user in this scenario - we treat it as a new install. Without this we can have some issues
                // when people have older invalid cookies on the same domain since our user managers might attempt to lookup a user
                // and we don&#39;t even have a db.
                return false;
            }

            var request = ctx.Request;
            var httpCtx = ctx.TryGetHttpContext();
            
            //check the explicit paths
            if (_explicitPaths != null)
            {
                return _explicitPaths.Any(x =&gt; x.InvariantEquals(request.Uri.AbsolutePath));
            }
            
            //check user seconds path
            if (request.Uri.AbsolutePath.InvariantEquals(_getRemainingSecondsPath)) return false;

            if (//check the explicit flag
                (checkForceAuthTokens &amp;&amp; ctx.Get&lt;bool?&gt;(&quot;umbraco-force-auth&quot;) != null)
                || (checkForceAuthTokens &amp;&amp; httpCtx.Success &amp;&amp; httpCtx.Result.Items[&quot;umbraco-force-auth&quot;] != null)                
                //check back office
                || request.Uri.IsBackOfficeRequest(HttpRuntime.AppDomainAppVirtualPath)
                //check installer
                || request.Uri.IsInstallerRequest()                
                //check for base
                || BaseRest.BaseRestHandler.IsBaseRestRequest(originalRequestUrl))
            {
                return true;
            }
            return false;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,15,27,49,1],[28,9,28,10,1],[30,9,30,10,1],[31,9,31,122,1],[32,9,32,10,1],[33,13,33,62,1],[34,13,34,85,1],[35,13,35,146,1],[36,9,36,10,1],[45,9,45,10,0],[46,13,46,100,0],[47,13,47,14,0],[48,17,48,29,0],[51,13,57,55,0],[58,9,58,10,0],[75,9,75,10,1],[76,13,77,108,1],[78,13,78,14,1],[83,17,83,30,1],[86,13,86,39,1],[87,13,87,51,1],[90,13,90,40,1],[91,13,91,14,0],[92,17,92,48,0],[92,48,92,91,0],[92,91,92,93,0],[92,17,92,93,0],[96,13,96,84,1],[96,85,96,98,0],[98,13,106,83,1],[107,13,107,14,1],[108,17,108,29,1],[110,13,110,26,0],[111,9,111,10,1]]);
    </script>
  </body>
</html>