<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebApi\Filters\AppendCurrentEventMessagesAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Net.Http;
using System.Web.Http.Filters;
using Umbraco.Core.Events;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.UI;

namespace Umbraco.Web.WebApi.Filters
{
    /// &lt;summary&gt;
    /// Automatically checks if any request is a non-GET and if the 
    /// resulting message is INotificationModel in which case it will append any Event Messages
    /// currently in the request.
    /// &lt;/summary&gt;
    internal sealed class AppendCurrentEventMessagesAttribute : ActionFilterAttribute
    {
        public override void OnActionExecuted(HttpActionExecutedContext context)
        {
            if (context.Response == null) return;
            if (context.Request.Method == HttpMethod.Get) return;
            if (UmbracoContext.Current == null) return;

            var obj = context.Response.Content as ObjectContent;
            if (obj == null) return;

            var notifications = obj.Value as INotificationModel;
            if (notifications == null) return;

            var msgs = UmbracoContext.Current.GetCurrentEventMessages();
            if (msgs == null) return;

            foreach (var eventMessage in msgs.GetAll())
            {
                SpeechBubbleIcon msgType;
                switch (eventMessage.MessageType)
                {
                    case EventMessageType.Default:
                        msgType = SpeechBubbleIcon.Save;
                        break;
                    case EventMessageType.Info:
                        msgType = SpeechBubbleIcon.Info;
                        break;
                    case EventMessageType.Error:
                        msgType = SpeechBubbleIcon.Error;
                        break;
                    case EventMessageType.Success:
                        msgType = SpeechBubbleIcon.Success;
                        break;
                    case EventMessageType.Warning:
                        msgType = SpeechBubbleIcon.Warning;
                        break;
                    default:
                        throw new ArgumentOutOfRangeException();
                }

                notifications.Notifications.Add(new Notification
                {
                    Message = eventMessage.Message,
                    Header = eventMessage.Category,
                    NotificationType = msgType
                });
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,10,0],[19,13,19,42,0],[19,43,19,50,0],[20,13,20,58,0],[20,59,20,66,0],[21,13,21,48,0],[21,49,21,56,0],[23,13,23,65,0],[24,13,24,29,0],[24,30,24,37,0],[26,13,26,65,0],[27,13,27,39,0],[27,40,27,47,0],[29,13,29,73,0],[30,13,30,30,0],[30,31,30,38,0],[32,13,32,20,0],[32,22,32,38,0],[32,39,32,41,0],[32,42,32,55,0],[33,13,33,14,0],[35,17,35,50,0],[38,25,38,57,0],[39,25,39,31,0],[41,25,41,57,0],[42,25,42,31,0],[44,25,44,58,0],[45,25,45,31,0],[47,25,47,60,0],[48,25,48,31,0],[50,25,50,60,0],[51,25,51,31,0],[53,25,53,65,0],[56,17,61,20,0],[62,13,62,14,0],[63,9,63,10,0]]);
    </script>
  </body>
</html>