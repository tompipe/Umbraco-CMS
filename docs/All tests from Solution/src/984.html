<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\RteEmbedController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Web.Http;
using System.Xml;
using umbraco.BusinessLogic;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Web.Editors;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi.Filters;
using Constants = Umbraco.Core.Constants;
using Umbraco.Core.Media;
using System.IO;

namespace Umbraco.Web.PropertyEditors
{
    /// &lt;summary&gt;
    /// A controller used for the embed dialog
    /// &lt;/summary&gt;
    [PluginController(&quot;UmbracoApi&quot;)]
    public class RteEmbedController : UmbracoAuthorizedJsonController
    {

        public Result GetEmbed(string url, int width, int height)
        {
            var result = new Result();

            //todo cache embed doc
            var xmlConfig = new XmlDocument();
            xmlConfig.Load(GlobalSettings.FullpathToRoot + Path.DirectorySeparatorChar + &quot;config&quot; + Path.DirectorySeparatorChar + &quot;EmbeddedMedia.config&quot;);

            foreach (XmlNode node in xmlConfig.SelectNodes(&quot;//provider&quot;))
            {
                var regexPattern = new Regex(node.SelectSingleNode(&quot;./urlShemeRegex&quot;).InnerText, RegexOptions.IgnoreCase);

                if (regexPattern.IsMatch(url))
                {
                    var prov = (IEmbedProvider)Activator.CreateInstance(Type.GetType(node.Attributes[&quot;type&quot;].Value));

                    if (node.Attributes[&quot;supportsDimensions&quot;] != null)
                        result.SupportsDimensions = node.Attributes[&quot;supportsDimensions&quot;].Value == &quot;True&quot;;
                    else
                        result.SupportsDimensions = prov.SupportsDimensions;

                    var settings = node.ChildNodes.Cast&lt;XmlNode&gt;().ToDictionary(settingNode =&gt; settingNode.Name);

                    foreach (var prop in prov.GetType().GetProperties().Where(prop =&gt; prop.IsDefined(typeof(ProviderSetting), true)))
                    {

                        if (settings.Any(s =&gt; s.Key.ToLower() == prop.Name.ToLower()))
                        {
                            var setting = settings.FirstOrDefault(s =&gt; s.Key.ToLower() == prop.Name.ToLower()).Value;
                            var settingType = typeof(Media.EmbedProviders.Settings.String);

                            if (setting.Attributes[&quot;type&quot;] != null)
                                settingType = Type.GetType(setting.Attributes[&quot;type&quot;].Value);

                            var settingProv = (IEmbedSettingProvider)Activator.CreateInstance(settingType);
                            prop.SetValue(prov, settingProv.GetSetting(settings.FirstOrDefault(s =&gt; s.Key.ToLower() == prop.Name.ToLower()).Value), null);
                        }
                    }
                    try
                    {
                        result.Markup = prov.GetMarkup(url, width, height);
                        result.Status = Status.Success;
                    }
                    catch(Exception ex)
                    {
                        LogHelper.Error&lt;RteEmbedController&gt;(string.Format(&quot;Error embedding url {0} - width: {1} height: {2}&quot;, url, width, height), ex);
                        result.Status = Status.Error;
                    }

                    return result;
                }
            }

            result.Status = Status.NotSupported;
            return result;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[29,13,29,39,0],[32,13,32,47,0],[33,13,33,155,0],[35,13,35,20,0],[35,22,35,34,0],[35,35,35,37,0],[35,38,35,73,0],[36,13,36,14,0],[37,17,37,123,0],[39,17,39,47,0],[40,17,40,18,0],[41,21,41,118,0],[43,21,43,71,0],[44,25,44,107,0],[46,25,46,77,0],[48,21,48,96,0],[48,96,48,112,0],[48,112,48,114,0],[48,21,48,114,0],[50,21,50,28,0],[50,30,50,38,0],[50,39,50,41,0],[50,42,50,87,0],[50,87,50,132,0],[50,132,50,133,0],[50,42,50,133,0],[51,21,51,22,0],[53,25,53,47,0],[53,47,53,85,0],[53,85,53,87,0],[53,25,53,87,0],[54,25,54,26,0],[55,29,55,72,0],[55,72,55,110,0],[55,110,55,118,0],[55,29,55,118,0],[56,29,56,92,0],[58,29,58,68,0],[59,33,59,94,0],[61,29,61,108,0],[62,29,62,101,0],[62,101,62,139,0],[62,139,62,155,0],[62,29,62,155,0],[63,25,63,26,0],[64,21,64,22,0],[66,21,66,22,0],[67,25,67,76,0],[68,25,68,56,0],[69,21,69,22,0],[70,21,70,40,0],[71,21,71,22,0],[72,25,72,152,0],[73,25,73,54,0],[74,21,74,22,0],[76,21,76,35,0],[78,13,78,14,0],[80,13,80,49,0],[81,13,81,27,0],[82,9,82,10,0]]);
    </script>
  </body>
</html>