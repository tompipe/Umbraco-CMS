<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\StylesheetRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.IO;
using System.Linq;
using System.Text;
using Moq;
using NUnit.Framework;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerFixture)]
    [TestFixture]
    public class StylesheetRepositoryTest : BaseDatabaseFactoryTest
    {
        private IFileSystem _fileSystem;

        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            _fileSystem = new PhysicalFileSystem(SystemDirectories.Css);
            var stream = CreateStream(&quot;body {background:#EE7600; color:#FFF;}&quot;);
            _fileSystem.AddFile(&quot;styles.css&quot;, stream);
        }

        [Test]
        public void Can_Instantiate_Repository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();

            // Act
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);


            // Assert
            Assert.That(repository, Is.Not.Null);
        }

        [Test]
        public void Can_Perform_Add()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();

            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            // Act
            var stylesheet = new Stylesheet(&quot;test-add.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();

            //Assert
            Assert.That(_fileSystem.FileExists(&quot;test-add.css&quot;), Is.True);
        }

        [Test]
        public void Can_Perform_Update()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            // Act
            var stylesheet = new Stylesheet(&quot;test-update.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();

            var stylesheetUpdate = repository.Get(&quot;test-update.css&quot;);
            stylesheetUpdate.Content = &quot;body { color:#000; }&quot;;
            repository.AddOrUpdate(stylesheetUpdate);
            unitOfWork.Commit();

            var stylesheetUpdated = repository.Get(&quot;test-update.css&quot;);

            //Assert
            Assert.That(stylesheetUpdated, Is.Not.Null);
            Assert.That(stylesheetUpdated.HasIdentity, Is.True);
            Assert.That(stylesheetUpdated.Content, Is.EqualTo(&quot;body { color:#000; }&quot;));
        }

        [Test]
        public void Can_Perform_Update_With_Property()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            // Act
            var stylesheet = new Stylesheet(&quot;test-update.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();

            stylesheet.AddProperty(new StylesheetProperty(&quot;Test&quot;, &quot;p&quot;, &quot;font-size:2em;&quot;));

            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();

            //re-get
            stylesheet = repository.Get(stylesheet.Name);

            //Assert           
            Assert.That(stylesheet.Content, Is.EqualTo(@&quot;body { color:#000; } .bold {font-weight:bold;}

/**umb_name:Test*/
p{font-size:2em;}&quot;));
            Assert.AreEqual(1, stylesheet.Properties.Count());
        }

        [Test]
        public void Throws_When_Adding_Duplicate_Properties()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();

            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            // Act
            var stylesheet = new Stylesheet(&quot;test-update.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();

            stylesheet.AddProperty(new StylesheetProperty(&quot;Test&quot;, &quot;p&quot;, &quot;font-size:2em;&quot;));

            Assert.Throws&lt;DuplicateNameException&gt;(() =&gt; stylesheet.AddProperty(new StylesheetProperty(&quot;test&quot;, &quot;p&quot;, &quot;font-size:2em;&quot;)));

        }

        [Test]
        public void Can_Perform_Delete()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            // Act
            var stylesheet = new Stylesheet(&quot;test-delete.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();

            repository.Delete(stylesheet);
            unitOfWork.Commit();

            //Assert
            Assert.That(_fileSystem.FileExists(&quot;test-delete.css&quot;), Is.False);
        }

        [Test]
        public void Can_Perform_Get()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            // Act
            var stylesheet = repository.Get(&quot;styles.css&quot;);

            // Assert
            Assert.That(stylesheet, Is.Not.Null);
            Assert.That(stylesheet.HasIdentity, Is.True);
            Assert.That(stylesheet.Content, Is.EqualTo(&quot;body {background:#EE7600; color:#FFF;}&quot;));
            Assert.That(repository.ValidateStylesheet(stylesheet), Is.True);
        }

        [Test]
        public void Can_Perform_GetAll()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            var stylesheet = new Stylesheet(&quot;styles-v2.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();

            // Act
            var stylesheets = repository.GetAll();

            // Assert
            Assert.That(stylesheets, Is.Not.Null);
            Assert.That(stylesheets.Any(), Is.True);
            Assert.That(stylesheets.Any(x =&gt; x == null), Is.False);
            Assert.That(stylesheets.Count(), Is.EqualTo(2));
        }

        [Test]
        public void Can_Perform_GetAll_With_Params()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            var stylesheet = new Stylesheet(&quot;styles-v2.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();

            // Act
            var stylesheets = repository.GetAll(&quot;styles-v2.css&quot;, &quot;styles.css&quot;);

            // Assert
            Assert.That(stylesheets, Is.Not.Null);
            Assert.That(stylesheets.Any(), Is.True);
            Assert.That(stylesheets.Any(x =&gt; x == null), Is.False);
            Assert.That(stylesheets.Count(), Is.EqualTo(2));
        }

        [Test]
        public void Can_Perform_Exists()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            // Act
            var exists = repository.Exists(&quot;styles.css&quot;);

            // Assert
            Assert.That(exists, Is.True);
        }

        [Test]
        public void PathTests()
        {
            // unless noted otherwise, no changes / 7.2.8

            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new StylesheetRepository(unitOfWork, _fileSystem);

            var stylesheet = new Stylesheet(&quot;test-path-1.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;test-path-1.css&quot;));
            Assert.AreEqual(&quot;test-path-1.css&quot;, stylesheet.Path);
            Assert.AreEqual(&quot;/css/test-path-1.css&quot;, stylesheet.VirtualPath);

            stylesheet = new Stylesheet(&quot;path-2/test-path-2.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;path-2/test-path-2.css&quot;));
            Assert.AreEqual(&quot;path-2\\test-path-2.css&quot;, stylesheet.Path); // fixed in 7.3 - 7.2.8 does not update the path
            Assert.AreEqual(&quot;/css/path-2/test-path-2.css&quot;, stylesheet.VirtualPath);

            stylesheet = repository.Get(&quot;path-2/test-path-2.css&quot;);
            Assert.IsNotNull(stylesheet);
            Assert.AreEqual(&quot;path-2\\test-path-2.css&quot;, stylesheet.Path);
            Assert.AreEqual(&quot;/css/path-2/test-path-2.css&quot;, stylesheet.VirtualPath);

            stylesheet = new Stylesheet(&quot;path-2\\test-path-3.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            repository.AddOrUpdate(stylesheet);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;path-2/test-path-3.css&quot;));
            Assert.AreEqual(&quot;path-2\\test-path-3.css&quot;, stylesheet.Path);
            Assert.AreEqual(&quot;/css/path-2/test-path-3.css&quot;, stylesheet.VirtualPath);

            stylesheet = repository.Get(&quot;path-2/test-path-3.css&quot;);
            Assert.IsNotNull(stylesheet);
            Assert.AreEqual(&quot;path-2\\test-path-3.css&quot;, stylesheet.Path);
            Assert.AreEqual(&quot;/css/path-2/test-path-3.css&quot;, stylesheet.VirtualPath);

            stylesheet = repository.Get(&quot;path-2\\test-path-3.css&quot;);
            Assert.IsNotNull(stylesheet);
            Assert.AreEqual(&quot;path-2\\test-path-3.css&quot;, stylesheet.Path);
            Assert.AreEqual(&quot;/css/path-2/test-path-3.css&quot;, stylesheet.VirtualPath);

            stylesheet = new Stylesheet(&quot;\\test-path-4.css&quot;) { Content = &quot;body { color:#000; } .bold {font-weight:bold;}&quot; };
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt; // fixed in 7.3 - 7.2.8 used to strip the \
            {
                repository.AddOrUpdate(stylesheet);
            });

            // fixed in 7.3 - 7.2.8 used to throw
            stylesheet = repository.Get(&quot;missing.css&quot;);
            Assert.IsNull(stylesheet);

            // fixed in 7.3 - 7.2.8 used to...
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt;
            {
                stylesheet = repository.Get(&quot;\\test-path-4.css&quot;); // outside the filesystem, does not exist
            });
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt;
            {
                stylesheet = repository.Get(&quot;../packages.config&quot;); // outside the filesystem, exists
            });
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();

            //Delete all files
            Purge((PhysicalFileSystem) _fileSystem, &quot;&quot;);
            _fileSystem = null;
        }

        private void Purge(PhysicalFileSystem fs, string path)
        {
            var files = fs.GetFiles(path, &quot;*.css&quot;);
            foreach (var file in files)
            {
                fs.DeleteFile(file);
            }
            var dirs = fs.GetDirectories(path);
            foreach (var dir in dirs)
            {
                Purge(fs, dir);
                fs.DeleteDirectory(dir);
            }
        }

        protected Stream CreateStream(string contents = null)
        {
            if (string.IsNullOrEmpty(contents))
                contents = &quot;/* test */&quot;;

            var bytes = Encoding.UTF8.GetBytes(contents);
            var stream = new MemoryStream(bytes);

            return stream;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,1],[26,13,26,31,1],[28,13,28,73,1],[29,13,29,81,1],[30,13,30,55,1],[31,9,31,10,1],[35,9,35,10,1],[37,13,37,57,1],[38,13,38,55,1],[41,13,41,80,1],[45,13,45,50,1],[46,9,46,10,1],[50,9,50,10,1],[52,13,52,57,1],[53,13,53,55,1],[55,13,55,80,1],[58,13,58,124,1],[59,13,59,48,1],[60,13,60,33,1],[63,13,63,74,1],[64,9,64,10,1],[68,9,68,10,1],[70,13,70,57,1],[71,13,71,55,1],[73,13,73,80,1],[76,13,76,127,1],[77,13,77,48,1],[78,13,78,33,1],[80,13,80,70,1],[81,13,81,63,1],[82,13,82,54,1],[83,13,83,33,1],[85,13,85,71,1],[88,13,88,57,1],[89,13,89,65,1],[90,13,90,88,1],[91,9,91,10,1],[95,9,95,10,1],[97,13,97,57,1],[98,13,98,55,1],[100,13,100,80,1],[103,13,103,127,1],[104,13,104,48,1],[105,13,105,33,1],[107,13,107,91,1],[109,13,109,48,1],[110,13,110,33,1],[113,13,113,58,1],[116,13,119,22,1],[120,13,120,63,1],[121,9,121,10,1],[125,9,125,10,1],[127,13,127,57,1],[128,13,128,55,1],[130,13,130,80,1],[133,13,133,127,1],[134,13,134,48,1],[135,13,135,33,1],[137,13,137,91,1],[139,13,139,57,1],[139,57,139,134,1],[139,134,139,136,1],[139,13,139,136,1],[141,9,141,10,1],[145,9,145,10,1],[147,13,147,57,1],[148,13,148,55,1],[150,13,150,80,1],[153,13,153,127,1],[154,13,154,48,1],[155,13,155,33,1],[157,13,157,43,1],[158,13,158,33,1],[161,13,161,78,1],[162,9,162,10,1],[166,9,166,10,1],[168,13,168,57,1],[169,13,169,55,1],[171,13,171,80,1],[174,13,174,59,1],[177,13,177,50,1],[178,13,178,58,1],[179,13,179,99,1],[180,13,180,77,1],[181,9,181,10,1],[185,9,185,10,1],[187,13,187,57,1],[188,13,188,55,1],[190,13,190,80,1],[192,13,192,125,1],[193,13,193,48,1],[194,13,194,33,1],[197,13,197,51,1],[200,13,200,51,1],[201,13,201,53,1],[202,13,202,46,1],[202,46,202,55,1],[202,55,202,68,1],[202,13,202,68,1],[203,13,203,61,1],[204,9,204,10,1],[208,9,208,10,1],[210,13,210,57,1],[211,13,211,55,1],[213,13,213,80,1],[215,13,215,125,1],[216,13,216,48,1],[217,13,217,33,1],[220,13,220,80,1],[223,13,223,51,1],[224,13,224,53,1],[225,13,225,46,1],[225,46,225,55,1],[225,55,225,68,1],[225,13,225,68,1],[226,13,226,61,1],[227,9,227,10,1],[231,9,231,10,1],[233,13,233,57,1],[234,13,234,55,1],[236,13,236,80,1],[239,13,239,58,1],[242,13,242,42,1],[243,9,243,10,1],[247,9,247,10,1],[250,13,250,57,1],[251,13,251,55,1],[252,13,252,80,1],[254,13,254,127,1],[255,13,255,48,1],[256,13,256,33,1],[257,13,257,70,1],[258,13,258,65,1],[259,13,259,77,1],[261,13,261,130,1],[262,13,262,48,1],[263,13,263,33,1],[264,13,264,77,1],[265,13,265,73,1],[266,13,266,84,1],[268,13,268,67,1],[269,13,269,42,1],[270,13,270,73,1],[271,13,271,84,1],[273,13,273,131,1],[274,13,274,48,1],[275,13,275,33,1],[276,13,276,77,1],[277,13,277,73,1],[278,13,278,84,1],[280,13,280,67,1],[281,13,281,42,1],[282,13,282,73,1],[283,13,283,84,1],[285,13,285,68,1],[286,13,286,42,1],[287,13,287,73,1],[288,13,288,84,1],[290,13,290,125,1],[291,13,292,13,1],[292,13,292,14,1],[292,14,293,17,1],[293,17,293,52,1],[293,52,294,13,1],[294,13,294,14,0],[294,14,294,16,1],[291,13,294,16,1],[297,13,297,56,1],[298,13,298,39,1],[301,13,302,13,1],[302,13,302,14,1],[302,14,303,17,1],[303,17,303,66,1],[303,66,304,13,1],[304,13,304,14,0],[304,14,304,16,1],[301,13,304,16,1],[305,13,306,13,1],[306,13,306,14,1],[306,14,307,17,1],[307,17,307,67,1],[307,67,308,13,1],[308,13,308,14,0],[308,14,308,16,1],[305,13,308,16,1],[309,9,309,10,1],[313,9,313,10,1],[314,13,314,29,1],[317,13,317,57,1],[318,13,318,32,1],[319,9,319,10,1],[322,9,322,10,1],[323,13,323,52,1],[324,13,324,20,1],[324,22,324,30,1],[324,31,324,33,1],[324,34,324,39,1],[325,13,325,14,1],[326,17,326,37,1],[327,13,327,14,1],[328,13,328,48,1],[329,13,329,20,1],[329,22,329,29,1],[329,30,329,32,1],[329,33,329,37,1],[330,13,330,14,1],[331,17,331,32,1],[332,17,332,41,1],[333,13,333,14,1],[334,9,334,10,1],[337,9,337,10,1],[338,13,338,48,1],[339,17,339,41,0],[341,13,341,58,1],[342,13,342,50,1],[344,13,344,27,1],[345,9,345,10,1]]);
    </script>
  </body>
</html>