<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\TreeControllerBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Linq;
using System.Net.Http.Formatting;
using Umbraco.Core;
using Umbraco.Core.Events;
using Umbraco.Web.Models.Trees;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebApi.Filters;
using Umbraco.Core.Models;

namespace Umbraco.Web.Trees
{
    /// &lt;summary&gt;
    /// A base controller reference for non-attributed trees (un-registered). Developers should inherit from
    /// TreeController.
    /// &lt;/summary&gt;
    [AngularJsonOnlyConfiguration]
    public abstract class TreeControllerBase : UmbracoAuthorizedApiController
    {
        protected TreeControllerBase()
        {
        }

        protected TreeControllerBase(UmbracoContext umbracoContext) : base(umbracoContext)
        {
        }

        protected TreeControllerBase(UmbracoContext umbracoContext, UmbracoHelper umbracoHelper) : base(umbracoContext, umbracoHelper)
        {
        }

        /// &lt;summary&gt;
        /// The method called to render the contents of the tree structure
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;
        /// All of the query string parameters passed from jsTree
        /// &lt;/param&gt;
        /// &lt;remarks&gt;
        /// We are allowing an arbitrary number of query strings to be pased in so that developers are able to persist custom data from the front-end
        /// to the back end to be used in the query for model data.
        /// &lt;/remarks&gt;
        protected abstract TreeNodeCollection GetTreeNodes(string id, FormDataCollection queryStrings);

        /// &lt;summary&gt;
        /// Returns the menu structure for the node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected abstract MenuItemCollection GetMenuForNode(string id, FormDataCollection queryStrings);

        /// &lt;summary&gt;
        /// The name to display on the root node
        /// &lt;/summary&gt;
        public abstract string RootNodeDisplayName { get; }

        /// &lt;summary&gt;
        /// Gets the current tree alias from the attribute assigned to it.
        /// &lt;/summary&gt;
        public abstract string TreeAlias { get; }

        /// &lt;summary&gt;
        /// Returns the root node for the tree
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpQueryStringFilter(&quot;queryStrings&quot;)]
        public TreeNode GetRootNode(FormDataCollection queryStrings)
        {
            if (queryStrings == null) queryStrings = new FormDataCollection(&quot;&quot;);
            var node = CreateRootNode(queryStrings);

            //add the tree alias to the root
            node.AdditionalData[&quot;treeAlias&quot;] = TreeAlias;

            AddQueryStringsToAdditionalData(node, queryStrings);

            //check if the tree is searchable and add that to the meta data as well
            if (this is ISearchableTree)
            {
                node.AdditionalData.Add(&quot;searchable&quot;, &quot;true&quot;);
            }

            //now update all data based on some of the query strings, like if we are running in dialog mode           
            if (IsDialog(queryStrings))
            {
                node.RoutePath = &quot;#&quot;;
            }

            OnRootNodeRendering(this, new TreeNodeRenderingEventArgs(node, queryStrings));

            return node;
        }

        /// &lt;summary&gt;
        /// The action called to render the contents of the tree structure
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;
        /// All of the query string parameters passed from jsTree
        /// &lt;/param&gt;
        /// &lt;returns&gt;JSON markup for jsTree&lt;/returns&gt;        
        /// &lt;remarks&gt;
        /// We are allowing an arbitrary number of query strings to be pased in so that developers are able to persist custom data from the front-end
        /// to the back end to be used in the query for model data.
        /// &lt;/remarks&gt;
        [HttpQueryStringFilter(&quot;queryStrings&quot;)]
        public TreeNodeCollection GetNodes(string id, FormDataCollection queryStrings)
        {
            if (queryStrings == null) queryStrings = new FormDataCollection(&quot;&quot;);
            var nodes = GetTreeNodes(id, queryStrings);

            foreach (var node in nodes)
            {
                AddQueryStringsToAdditionalData(node, queryStrings);
            }

            //now update all data based on some of the query strings, like if we are running in dialog mode            
            if (IsDialog((queryStrings)))
            {
                foreach (var node in nodes)
                {
                    node.RoutePath = &quot;#&quot;;
                }
            }

            //raise the event
            OnTreeNodesRendering(this, new TreeNodesRenderingEventArgs(nodes, queryStrings));

            return nodes;
        }

        /// &lt;summary&gt;
        /// The action called to render the menu for a tree node
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [HttpQueryStringFilter(&quot;queryStrings&quot;)]
        public MenuItemCollection GetMenu(string id, FormDataCollection queryStrings)
        {
            if (queryStrings == null) queryStrings = new FormDataCollection(&quot;&quot;);
            var menu = GetMenuForNode(id, queryStrings);
            //raise the event
            OnMenuRendering(this, new MenuRenderingEventArgs(id, menu, queryStrings));
            return menu;
        }

        /// &lt;summary&gt;
        /// Helper method to create a root model for a tree
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected virtual TreeNode CreateRootNode(FormDataCollection queryStrings)
        {
            var rootNodeAsString = Constants.System.Root.ToString(CultureInfo.InvariantCulture);
            var currApp = queryStrings.GetValue&lt;string&gt;(TreeQueryStringParameters.Application);

            var node = new TreeNode(
                rootNodeAsString,
                null, //this is a root node, there is no parent
                Url.GetTreeUrl(GetType(), rootNodeAsString, queryStrings),
                Url.GetMenuUrl(GetType(), rootNodeAsString, queryStrings))
                {
                    HasChildren = true,
                    RoutePath = currApp,
                    Name = RootNodeDisplayName
                };

            return node;
        }

        #region Create TreeNode methods

        /// &lt;summary&gt;
        /// Helper method to create tree nodes
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;title&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public TreeNode CreateTreeNode(string id, string parentId, FormDataCollection queryStrings, string title)
        {
            var jsonUrl = Url.GetTreeUrl(GetType(), id, queryStrings);
            var menuUrl = Url.GetMenuUrl(GetType(), id, queryStrings);
            var node = new TreeNode(id, parentId, jsonUrl, menuUrl) { Name = title };
            return node;
        }

        /// &lt;summary&gt;
        /// Helper method to create tree nodes
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;title&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;icon&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public TreeNode CreateTreeNode(string id, string parentId, FormDataCollection queryStrings, string title, string icon)
        {
            var jsonUrl = Url.GetTreeUrl(GetType(), id, queryStrings);
            var menuUrl = Url.GetMenuUrl(GetType(), id, queryStrings);
            var node = new TreeNode(id, parentId, jsonUrl, menuUrl)
            {
                Name = title, 
                Icon = icon,
                NodeType = TreeAlias
            };
            return node;
        }

        /// &lt;summary&gt;
        /// Helper method to create tree nodes
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;title&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;routePath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;icon&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public TreeNode CreateTreeNode(string id, string parentId, FormDataCollection queryStrings, string title, string icon, string routePath)
        {
            var jsonUrl = Url.GetTreeUrl(GetType(), id, queryStrings);
            var menuUrl = Url.GetMenuUrl(GetType(), id, queryStrings);
            var node = new TreeNode(id, parentId, jsonUrl, menuUrl) { Name = title, RoutePath = routePath, Icon = icon };
            return node;
        }

        /// &lt;summary&gt;
        /// Helper method to create tree nodes and automatically generate the json url
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;title&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;icon&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;hasChildren&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public TreeNode CreateTreeNode(string id, string parentId, FormDataCollection queryStrings, string title, string icon, bool hasChildren)
        {
            var treeNode = CreateTreeNode(id, parentId, queryStrings, title, icon);
            treeNode.HasChildren = hasChildren;
            return treeNode;
        }

        /// &lt;summary&gt;
        /// Helper method to create tree nodes and automatically generate the json url
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;title&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;routePath&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;hasChildren&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;icon&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public TreeNode CreateTreeNode(string id, string parentId, FormDataCollection queryStrings, string title, string icon, bool hasChildren, string routePath)
        {
            var treeNode = CreateTreeNode(id, parentId, queryStrings, title, icon);
            treeNode.HasChildren = hasChildren;
            treeNode.RoutePath = routePath;
            return treeNode;
        }

        #endregion

        /// &lt;summary&gt;
        /// The AdditionalData of a node is always populated with the query string data, this method performs this
        /// operation and ensures that special values are not inserted or that duplicate keys are not added.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;node&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        protected void AddQueryStringsToAdditionalData(TreeNode node, FormDataCollection queryStrings)
        {
            foreach (var q in queryStrings.Where(x =&gt; node.AdditionalData.ContainsKey(x.Key) == false))
            {
                node.AdditionalData.Add(q.Key, q.Value);
            }
        }

        /// &lt;summary&gt;
        /// If the request is for a dialog mode tree
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;queryStrings&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected bool IsDialog(FormDataCollection queryStrings)
        {
            return queryStrings.GetValue&lt;bool&gt;(TreeQueryStringParameters.IsDialog);
        }

        /// &lt;summary&gt;
        /// An event that allows developers to modify the tree node collection that is being rendered
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Developers can add/remove/replace/insert/update/etc... any of the tree items in the collection.
        /// &lt;/remarks&gt;
        public static event TypedEventHandler&lt;TreeControllerBase, TreeNodesRenderingEventArgs&gt; TreeNodesRendering;

        private static void OnTreeNodesRendering(TreeControllerBase instance, TreeNodesRenderingEventArgs e)
        {
            var handler = TreeNodesRendering;
            if (handler != null) handler(instance, e);
        }

        /// &lt;summary&gt;
        /// An event that allows developer to modify the root tree node that is being rendered
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;TreeControllerBase, TreeNodeRenderingEventArgs&gt; RootNodeRendering;

        private static void OnRootNodeRendering(TreeControllerBase instance, TreeNodeRenderingEventArgs e)
        {
            var handler = RootNodeRendering;
            if (handler != null) handler(instance, e);
        }

        /// &lt;summary&gt;
        /// An event that allows developers to modify the meun that is being rendered
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Developers can add/remove/replace/insert/update/etc... any of the tree items in the collection.
        /// &lt;/remarks&gt;
        public static event TypedEventHandler&lt;TreeControllerBase, MenuRenderingEventArgs&gt; MenuRendering;

        private static void OnMenuRendering(TreeControllerBase instance, MenuRenderingEventArgs e)
        {
            var handler = MenuRendering;
            if (handler != null) handler(instance, e);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,39,0],[22,9,22,10,0],[23,9,23,10,0],[25,71,25,91,0],[26,9,26,10,0],[27,9,27,10,0],[29,100,29,135,0],[30,9,30,10,0],[31,9,31,10,0],[71,9,71,10,0],[72,13,72,38,0],[72,39,72,81,0],[73,13,73,53,0],[76,13,76,58,0],[78,13,78,65,0],[81,13,81,41,0],[82,13,82,14,0],[83,17,83,63,0],[84,13,84,14,0],[87,13,87,40,0],[88,13,88,14,0],[89,17,89,38,0],[90,13,90,14,0],[92,13,92,91,0],[94,13,94,25,0],[95,9,95,10,0],[111,9,111,10,0],[112,13,112,38,0],[112,39,112,81,0],[113,13,113,56,0],[115,13,115,20,0],[115,22,115,30,0],[115,31,115,33,0],[115,34,115,39,0],[116,13,116,14,0],[117,17,117,69,0],[118,13,118,14,0],[121,13,121,42,0],[122,13,122,14,0],[123,17,123,24,0],[123,26,123,34,0],[123,35,123,37,0],[123,38,123,43,0],[124,17,124,18,0],[125,21,125,42,0],[126,17,126,18,0],[127,13,127,14,0],[130,13,130,94,0],[132,13,132,26,0],[133,9,133,10,0],[143,9,143,10,0],[144,13,144,38,0],[144,39,144,81,0],[145,13,145,57,0],[147,13,147,87,0],[148,13,148,25,0],[149,9,149,10,0],[156,9,156,10,0],[157,13,157,97,0],[158,13,158,96,0],[160,13,169,19,0],[171,13,171,25,0],[172,9,172,10,0],[185,9,185,10,0],[186,13,186,71,0],[187,13,187,71,0],[188,13,188,86,0],[189,13,189,25,0],[190,9,190,10,0],[202,9,202,10,0],[203,13,203,71,0],[204,13,204,71,0],[205,13,210,15,0],[211,13,211,25,0],[212,9,212,10,0],[225,9,225,10,0],[226,13,226,71,0],[227,13,227,71,0],[228,13,228,122,0],[229,13,229,25,0],[230,9,230,10,0],[243,9,243,10,0],[244,13,244,84,0],[245,13,245,48,0],[246,13,246,29,0],[247,9,247,10,0],[261,9,261,10,0],[262,13,262,84,0],[263,13,263,48,0],[264,13,264,44,0],[265,13,265,29,0],[266,9,266,10,0],[277,9,277,10,0],[278,13,278,20,0],[278,22,278,27,0],[278,28,278,30,0],[278,31,278,55,0],[278,55,278,102,0],[278,102,278,103,0],[278,31,278,103,0],[279,13,279,14,0],[280,17,280,57,0],[281,13,281,14,0],[282,9,282,10,0],[290,9,290,10,0],[291,13,291,84,0],[292,9,292,10,0],[303,9,303,10,0],[304,13,304,46,0],[305,13,305,33,0],[305,34,305,55,0],[306,9,306,10,0],[314,9,314,10,0],[315,13,315,45,0],[316,13,316,33,0],[316,34,316,55,0],[317,9,317,10,0],[328,9,328,10,0],[329,13,329,41,0],[330,13,330,33,0],[330,34,330,55,0],[331,9,331,10,0]]);
    </script>
  </body>
</html>