<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Security\Identity\PreviewAuthenticationMiddleware.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Security.Claims;
using System.Threading;
using System.Threading.Tasks;
using System.Web;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.Owin;
using Microsoft.Owin;
using Microsoft.Owin.Extensions;
using Microsoft.Owin.Logging;
using Microsoft.Owin.Security;
using Microsoft.Owin.Security.Cookies;
using Owin;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Identity;
using Umbraco.Core.Security;
using Constants = Umbraco.Core.Constants;

namespace Umbraco.Web.Security.Identity
{
    internal class PreviewAuthenticationMiddleware : OwinMiddleware
    {
        private readonly UmbracoBackOfficeCookieAuthOptions _cookieOptions;

        /// &lt;summary&gt;
        /// Instantiates the middleware with an optional pointer to the next component.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;next&quot;/&gt;
        /// &lt;param name=&quot;cookieOptions&quot;&gt;&lt;/param&gt;
        public PreviewAuthenticationMiddleware(OwinMiddleware next,
            UmbracoBackOfficeCookieAuthOptions cookieOptions) : base(next)
        {
            _cookieOptions = cookieOptions;
        }

        /// &lt;summary&gt;
        /// Process an individual request.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;context&quot;/&gt;
        /// &lt;returns/&gt;
        public override async Task Invoke(IOwinContext context)
        {
            var request = context.Request;
            if (request.Uri.IsClientSideRequest() == false)
            {
                var claimsPrincipal = context.Request.User as ClaimsPrincipal;
                var isPreview = request.HasPreviewCookie()                    
                    &amp;&amp; claimsPrincipal != null
                    &amp;&amp; request.Uri != null
                    &amp;&amp; request.Uri.IsBackOfficeRequest(HttpRuntime.AppDomainAppVirtualPath) == false;
                if (isPreview)
                {
                    //If we&#39;ve gotten this far it means a preview cookie has been set and a front-end umbraco document request is executing.
                    // In this case, authentication will not have occurred for an Umbraco back office User, however we need to perform the authentication
                    // for the user here so that the preview capability can be authorized otherwise only the non-preview page will be rendered.

                    var cookie = request.Cookies[_cookieOptions.CookieName];
                    if (cookie.IsNullOrWhiteSpace() == false)
                    {                        
                        var unprotected = _cookieOptions.TicketDataFormat.Unprotect(cookie);
                        if (unprotected != null)
                        {
                            //Ok, we&#39;ve got a real ticket, now we can add this ticket&#39;s identity to the current 
                            // Principal, this means we&#39;ll have 2 identities assigned to the principal which we can 
                            // use to authorize the preview and allow for a back office User.                            
                            claimsPrincipal.AddIdentity(UmbracoBackOfficeIdentity.FromClaimsIdentity(unprotected.Identity));
                        }
                    }
                }
            }

            if (Next != null)
            {
                await Next.Invoke(context);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[37,65,37,75,0],[38,9,38,10,0],[39,13,39,44,0],[40,9,40,10,0],[48,9,48,10,0],[49,13,49,43,0],[50,13,50,60,0],[51,13,51,14,0],[52,17,52,79,0],[53,17,56,102,0],[57,17,57,31,0],[58,17,58,18,0],[63,21,63,77,0],[64,21,64,62,0],[65,21,65,22,0],[66,25,66,93,0],[67,25,67,49,0],[68,25,68,26,0],[72,29,72,125,0],[73,25,73,26,0],[74,21,74,22,0],[75,17,75,18,0],[76,13,76,14,0],[78,13,78,30,0],[79,13,79,14,0],[80,17,80,44,0],[81,13,81,14,0],[82,9,82,10,0]]);
    </script>
  </body>
</html>