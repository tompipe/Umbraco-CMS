<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\BootManagers\CoreBootManagerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Tests.TestHelpers;
using umbraco.interfaces;
using Umbraco.Core.Persistence;
using Umbraco.Core.Profiling;
using Umbraco.Core.Services;

namespace Umbraco.Tests.BootManagers
{
    [TestFixture]
    public class CoreBootManagerTests : BaseUmbracoConfigurationTest
    {

        private TestApp _testApp;

        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
            _testApp = new TestApp();            
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();

            _testApp = null;
            ResolverCollection.ResetAll();
        }

     
        /// &lt;summary&gt;
        /// test application using a CoreBootManager instance to boot
        /// &lt;/summary&gt;
        public class TestApp : UmbracoApplicationBase
        {
            protected override IBootManager GetBootManager()
            {
                return new TestBootManager(this, new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));
            }
        }

        /// &lt;summary&gt;
        /// Test boot manager to add a custom application event handler
        /// &lt;/summary&gt;
        public class TestBootManager : CoreBootManager
        {
            public TestBootManager(UmbracoApplicationBase umbracoApplication, ProfilingLogger logger)
                : base(umbracoApplication, logger)
            {
            }

            /// &lt;summary&gt;
            /// Creates and returns the application context singleton
            /// &lt;/summary&gt;
            /// &lt;param name=&quot;dbContext&quot;&gt;&lt;/param&gt;
            /// &lt;param name=&quot;serviceContext&quot;&gt;&lt;/param&gt;
            protected override ApplicationContext CreateApplicationContext(DatabaseContext dbContext, ServiceContext serviceContext)
            {
                var appContext = base.CreateApplicationContext(dbContext, serviceContext);

                var dbContextMock = new Mock&lt;DatabaseContext&gt;(Mock.Of&lt;IDatabaseFactory&gt;(), ProfilingLogger.Logger, Mock.Of&lt;ISqlSyntaxProvider&gt;(), &quot;test&quot;);
                dbContextMock.Setup(x =&gt; x.CanConnect).Returns(true);
                appContext.DatabaseContext = dbContextMock.Object;

                return appContext;
            }

            protected override void InitializeApplicationEventsResolver()
            {
                //create an empty resolver so we can add our own custom ones (don&#39;t type find)
                ApplicationEventsResolver.Current = new ApplicationEventsResolver(
                    new ActivatorServiceProvider(), ProfilingLogger.Logger,
                    new Type[]
                    {
                        typeof(LegacyStartupHandler),
                        typeof(TestApplicationEventHandler)
                    })
                    {
                        CanResolveBeforeFrozen = true
                    };
            }
            
            protected override void InitializeLoggerResolver()
            {                
            }
            
            protected override void InitializeProfilerResolver()
            {
            }
        }

        /// &lt;summary&gt;
        /// Test legacy startup handler
        /// &lt;/summary&gt;
        public class LegacyStartupHandler : IApplicationStartupHandler
        {
            public static bool Initialized = false;

            public LegacyStartupHandler()
            {
                Initialized = true;
            }
        }

        /// &lt;summary&gt;
        /// test event handler
        /// &lt;/summary&gt;
        public class TestApplicationEventHandler : IApplicationEventHandler
        {
            public static bool Initialized = false;
            public static bool Starting = false;
            public static bool Started = false;

            public void OnApplicationInitialized(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
            {
                Initialized = true;
            }

            public void OnApplicationStarting(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
            {
                Starting = true;
            }

            public void OnApplicationStarted(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
            {
                Started = true;
            }
        }

        [Test]
        public void Handle_IApplicationEventHandler_Objects_Outside_Web_Context()
        {
            _testApp.StartApplication(_testApp, new EventArgs());

            Assert.IsTrue(TestApplicationEventHandler.Initialized);
            Assert.IsTrue(TestApplicationEventHandler.Starting);
            Assert.IsTrue(TestApplicationEventHandler.Started);
        }

        [Test]
        public void Ensure_Legacy_Startup_Handlers_Not_Started_Until_Complete()
        {
            EventHandler starting = (sender, args) =&gt;
                {
                    Assert.IsTrue(TestApplicationEventHandler.Initialized);
                    Assert.IsTrue(TestApplicationEventHandler.Starting);
                    Assert.IsFalse(LegacyStartupHandler.Initialized);
                };
            EventHandler started = (sender, args) =&gt;
                {
                    Assert.IsTrue(TestApplicationEventHandler.Started);
                    Assert.IsTrue(LegacyStartupHandler.Initialized);
                };
            TestApp.ApplicationStarting += starting;
            TestApp.ApplicationStarted += started;

            _testApp.StartApplication(_testApp, new EventArgs());

            TestApp.ApplicationStarting -= starting;
            TestApp.ApplicationStarting -= started;

        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,29,10,1],[30,13,30,31,1],[31,13,31,38,1],[32,9,32,10,1],[36,9,36,10,1],[37,13,37,29,1],[39,13,39,29,1],[40,13,40,43,1],[41,9,41,10,1],[50,13,50,14,1],[51,17,51,113,1],[52,13,52,14,1],[61,19,61,51,1],[62,13,62,14,1],[63,13,63,14,1],[71,13,71,14,1],[72,17,72,91,1],[74,17,74,155,1],[75,17,75,70,1],[76,17,76,67,1],[78,17,78,35,1],[79,13,79,14,1],[82,13,82,14,1],[84,17,93,23,1],[94,13,94,14,1],[97,13,97,14,1],[98,13,98,14,1],[101,13,101,14,1],[102,13,102,14,1],[110,13,110,52,1],[112,13,112,42,1],[113,13,113,14,1],[114,17,114,36,1],[115,13,115,14,1],[123,13,123,52,1],[124,13,124,49,1],[125,13,125,48,1],[128,13,128,14,1],[129,17,129,36,1],[130,13,130,14,1],[133,13,133,14,1],[134,17,134,33,1],[135,13,135,14,1],[138,13,138,14,1],[139,17,139,32,1],[140,13,140,14,1],[145,9,145,10,1],[146,13,146,66,1],[148,13,148,68,1],[149,13,149,65,1],[150,13,150,64,1],[151,9,151,10,1],[155,9,155,10,1],[156,13,157,17,1],[157,17,157,18,1],[157,18,158,21,1],[158,21,158,76,1],[158,76,159,21,1],[159,21,159,73,1],[159,73,160,21,1],[160,21,160,70,1],[160,70,161,17,1],[161,17,161,18,1],[161,18,161,19,1],[156,13,161,19,1],[162,13,163,17,1],[163,17,163,18,1],[163,18,164,21,1],[164,21,164,72,1],[164,72,165,21,1],[165,21,165,69,1],[165,69,166,17,1],[166,17,166,18,1],[166,18,166,19,1],[162,13,166,19,1],[167,13,167,53,1],[168,13,168,51,1],[170,13,170,66,1],[172,13,172,53,1],[173,13,173,52,1],[175,9,175,10,1]]);
    </script>
  </body>
</html>