<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\PublishedContent\PublishedContentModelFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq.Expressions;

namespace Umbraco.Core.Models.PublishedContent
{
    /// &lt;summary&gt;
    /// Implements a strongly typed content model factory
    /// &lt;/summary&gt;
    public class PublishedContentModelFactory : IPublishedContentModelFactory
    {
        //private readonly Dictionary&lt;string, ConstructorInfo&gt; _constructors
        //    = new Dictionary&lt;string, ConstructorInfo&gt;();

        private readonly Dictionary&lt;string, Func&lt;IPublishedContent, IPublishedContent&gt;&gt; _constructors;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;PublishedContentModelFactory&quot;/&gt; class with types.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;types&quot;&gt;The model types.&lt;/param&gt;
        /// &lt;remarks&gt;
        /// &lt;para&gt;Types must implement &lt;c&gt;IPublishedContent&lt;/c&gt; and have a unique constructor that
        /// accepts one IPublishedContent as a parameter.&lt;/para&gt;
        /// &lt;para&gt;To activate,&lt;/para&gt;
        /// &lt;code&gt;
        /// var types = PluginManager.Current.ResolveTypes{PublishedContentModel}();
        /// var factory = new PublishedContentModelFactoryImpl(types);
        /// PublishedContentModelFactoryResolver.Current.SetFactory(factory);
        /// &lt;/code&gt;
        /// &lt;/remarks&gt;
        public PublishedContentModelFactory(IEnumerable&lt;Type&gt; types)
        {
            var ctorArgTypes = new[] { typeof(IPublishedContent) };
            var constructors = new Dictionary&lt;string, Func&lt;IPublishedContent, IPublishedContent&gt;&gt;(StringComparer.InvariantCultureIgnoreCase);

            foreach (var type in types)
            {
                var constructor = type.GetConstructor(ctorArgTypes);
                if (constructor == null)
                    throw new InvalidOperationException(string.Format(&quot;Type {0} is missing a public constructor with one argument of type IPublishedContent.&quot;, type.FullName));
                var attribute = type.GetCustomAttribute&lt;PublishedContentModelAttribute&gt;(false);
                var typeName = attribute == null ? type.Name : attribute.ContentTypeAlias;

                if (constructors.ContainsKey(typeName))
                    throw new InvalidOperationException(string.Format(&quot;More that one type want to be a model for content type {0}.&quot;, typeName));

                // should work everywhere, but slow
                //_constructors[typeName] = constructor;

                // much faster with a dynamic method but potential MediumTrust issues
                // here http://stackoverflow.com/questions/16363838/how-do-you-call-a-constructor-via-an-expression-tree-on-an-existing-object

                // fast enough and works in MediumTrust
                // read http://boxbinary.com/2011/10/how-to-run-a-unit-test-in-medium-trust-with-nunitpart-three-umbraco-framework-testing/
                var exprArg = Expression.Parameter(typeof(IPublishedContent), &quot;content&quot;);
                var exprNew = Expression.New(constructor, exprArg);
                var expr = Expression.Lambda&lt;Func&lt;IPublishedContent, IPublishedContent&gt;&gt;(exprNew, exprArg);
                var func = expr.Compile();
                constructors[typeName] = func;
            }

            _constructors = constructors.Count &gt; 0 ? constructors : null;
        }

        public IPublishedContent CreateModel(IPublishedContent content)
        {
            // fail fast
            if (_constructors == null)
                return content;

            // be case-insensitive
            var contentTypeAlias = content.DocumentTypeAlias;

            //ConstructorInfo constructor;
            //return _constructors.TryGetValue(contentTypeAlias, out constructor)
            //    ? (IPublishedContent) constructor.Invoke(new object[] { content })
            //    : content;

            Func&lt;IPublishedContent, IPublishedContent&gt; constructor;
            return _constructors.TryGetValue(contentTypeAlias, out constructor)
                ? constructor(content)
                : content;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,69,1],[32,9,32,10,1],[33,13,33,68,1],[34,13,34,142,1],[36,13,36,20,1],[36,22,36,30,1],[36,31,36,33,1],[36,34,36,39,1],[37,13,37,14,1],[38,17,38,69,1],[39,17,39,41,1],[40,21,40,176,0],[41,17,41,96,1],[42,17,42,91,1],[44,17,44,56,1],[45,21,45,145,0],[55,17,55,90,1],[56,17,56,68,1],[57,17,57,108,1],[58,17,58,43,1],[59,17,59,47,1],[60,13,60,14,1],[62,13,62,74,1],[63,9,63,10,1],[66,9,66,10,1],[68,13,68,39,1],[69,17,69,32,0],[72,13,72,62,1],[80,13,82,27,1],[83,9,83,10,1]]);
    </script>
  </body>
</html>