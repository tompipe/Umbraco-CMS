<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\MemberTypeReadOnlyFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Repositories;

namespace Umbraco.Core.Persistence.Factories
{
    internal class MemberTypeReadOnlyFactory 
    {
        public IMemberType BuildEntity(MemberTypeReadOnlyDto dto)
        {
            var standardPropertyTypes = Constants.Conventions.Member.GetStandardPropertyTypeStubs();

            var memberType = new MemberType(dto.ParentId);

            try
            {
                memberType.DisableChangeTracking();

                memberType.Alias = dto.Alias;
                memberType.AllowedAsRoot = dto.AllowAtRoot;
                memberType.CreateDate = dto.CreateDate;
                memberType.CreatorId = dto.UserId.HasValue ? dto.UserId.Value : 0;
                memberType.Description = dto.Description;
                memberType.Icon = dto.Icon;
                memberType.Id = dto.NodeId;
                memberType.IsContainer = dto.IsContainer;
                memberType.Key = dto.UniqueId.Value;
                memberType.Level = dto.Level;
                memberType.Name = dto.Text;
                memberType.Path = dto.Path;
                memberType.SortOrder = dto.SortOrder;
                memberType.Thumbnail = dto.Thumbnail;
                memberType.Trashed = dto.Trashed;
                memberType.UpdateDate = dto.CreateDate;
                memberType.AllowedContentTypes = Enumerable.Empty&lt;ContentTypeSort&gt;();

                var propertyTypeGroupCollection = GetPropertyTypeGroupCollection(dto, memberType, standardPropertyTypes);
                memberType.PropertyGroups = propertyTypeGroupCollection;

                var propertyTypes = GetPropertyTypes(dto, memberType, standardPropertyTypes);

                //By Convention we add 9 stnd PropertyTypes - This is only here to support loading of types that didn&#39;t have these conventions before.            
                foreach (var standardPropertyType in standardPropertyTypes)
                {
                    if (dto.PropertyTypes.Any(x =&gt; x.Alias.Equals(standardPropertyType.Key))) continue;

                    //Add the standard PropertyType to the current list
                    propertyTypes.Add(standardPropertyType.Value);

                    //Internal dictionary for adding &quot;MemberCanEdit&quot; and &quot;VisibleOnProfile&quot; properties to each PropertyType
                    memberType.MemberTypePropertyTypes.Add(standardPropertyType.Key,
                        new MemberTypePropertyProfileAccess(false, false));
                }
                memberType.NoGroupPropertyTypes = propertyTypes;

                return memberType;
            }
            finally
            {
                memberType.EnableChangeTracking();
            }
        }

        private PropertyGroupCollection GetPropertyTypeGroupCollection(MemberTypeReadOnlyDto dto, MemberType memberType, Dictionary&lt;string, PropertyType&gt; standardProps)
        {
            // see PropertyGroupFactory, repeating code here...

            var propertyGroups = new PropertyGroupCollection();
            foreach (var groupDto in dto.PropertyTypeGroups.Where(x =&gt; x.Id.HasValue))
            {
                var group = new PropertyGroup();

                // if the group is defined on the current member type,
                // assign its identifier, else it will be zero
                if (groupDto.ContentTypeNodeId == memberType.Id)
                {
                    // note: no idea why Id is nullable here, but better check
                    if (groupDto.Id.HasValue == false)
                        throw new Exception(&quot;GroupDto.Id has no value.&quot;);
                    group.Id = groupDto.Id.Value;
                }

                group.Key = groupDto.UniqueId;
                group.Name = groupDto.Text;
                group.SortOrder = groupDto.SortOrder;
                group.PropertyTypes = new PropertyTypeCollection();

                //Because we are likely to have a group with no PropertyTypes we need to ensure that these are excluded
                var localGroupDto = groupDto;
                var typeDtos = dto.PropertyTypes.Where(x =&gt; x.Id.HasValue &amp;&amp; x.Id &gt; 0 &amp;&amp; x.PropertyTypeGroupId.HasValue &amp;&amp; x.PropertyTypeGroupId.Value == localGroupDto.Id.Value);
                foreach (var typeDto in typeDtos)
                {
                    //Internal dictionary for adding &quot;MemberCanEdit&quot; and &quot;VisibleOnProfile&quot; properties to each PropertyType
                    memberType.MemberTypePropertyTypes.Add(typeDto.Alias,
                        new MemberTypePropertyProfileAccess(typeDto.ViewOnProfile, typeDto.CanEdit));

                    var tempGroupDto = groupDto;

                    //ensures that any built-in membership properties have their correct dbtype assigned no matter
                    //what the underlying data type is
                    var propDbType = MemberTypeRepository.GetDbTypeForBuiltInProperty(
                        typeDto.Alias,
                        typeDto.DbType.EnumParse&lt;DataTypeDatabaseType&gt;(true),
                        standardProps);
                    
                    var propertyType = new PropertyType(
                        typeDto.PropertyEditorAlias,
                        propDbType.Result,
                        //This flag tells the property type that it has an explicit dbtype and that it cannot be changed
                        // which is what we want for the built-in properties.
                        propDbType.Success,
                        typeDto.Alias)
                    {
                        DataTypeDefinitionId = typeDto.DataTypeId,
                        Description = typeDto.Description,
                        Id = typeDto.Id.Value,
                        Name = typeDto.Name,
                        Mandatory = typeDto.Mandatory,
                        SortOrder = typeDto.SortOrder,
                        ValidationRegExp = typeDto.ValidationRegExp,
                        PropertyGroupId = new Lazy&lt;int&gt;(() =&gt; tempGroupDto.Id.Value),
                        CreateDate = memberType.CreateDate,
                        UpdateDate = memberType.UpdateDate,
                        Key = typeDto.UniqueId
                    };
                    //on initial construction we don&#39;t want to have dirty properties tracked
                    // http://issues.umbraco.org/issue/U4-1946
                    propertyType.ResetDirtyProperties(false);
                    group.PropertyTypes.Add(propertyType);
                }
                //on initial construction we don&#39;t want to have dirty properties tracked
                // http://issues.umbraco.org/issue/U4-1946
                group.ResetDirtyProperties(false);
                propertyGroups.Add(group);
            }

            return propertyGroups;
        }



        private List&lt;PropertyType&gt; GetPropertyTypes(MemberTypeReadOnlyDto dto, MemberType memberType, Dictionary&lt;string, PropertyType&gt; standardProps)
        {
            //Find PropertyTypes that does not belong to a PropertyTypeGroup
            var propertyTypes = new List&lt;PropertyType&gt;();
            foreach (var typeDto in dto.PropertyTypes.Where(x =&gt; (x.PropertyTypeGroupId.HasValue == false || x.PropertyTypeGroupId.Value == 0) &amp;&amp; x.Id.HasValue))
            {
                //Internal dictionary for adding &quot;MemberCanEdit&quot; and &quot;VisibleOnProfile&quot; properties to each PropertyType
                memberType.MemberTypePropertyTypes.Add(typeDto.Alias,
                    new MemberTypePropertyProfileAccess(typeDto.ViewOnProfile, typeDto.CanEdit));

                //ensures that any built-in membership properties have their correct dbtype assigned no matter
                //what the underlying data type is
                var propDbType = MemberTypeRepository.GetDbTypeForBuiltInProperty(
                    typeDto.Alias,
                    typeDto.DbType.EnumParse&lt;DataTypeDatabaseType&gt;(true),
                    standardProps);

                var propertyType = new PropertyType(
                    typeDto.PropertyEditorAlias,
                    propDbType.Result,
                    //This flag tells the property type that it has an explicit dbtype and that it cannot be changed
                    // which is what we want for the built-in properties.
                    propDbType.Success,
                    typeDto.Alias)
                {
                    DataTypeDefinitionId = typeDto.DataTypeId,
                    Description = typeDto.Description,
                    Id = typeDto.Id.Value,
                    Mandatory = typeDto.Mandatory,
                    Name = typeDto.Name,
                    SortOrder = typeDto.SortOrder,
                    ValidationRegExp = typeDto.ValidationRegExp,
                    PropertyGroupId = null,
                    CreateDate = dto.CreateDate,
                    UpdateDate = dto.CreateDate,
                    Key = typeDto.UniqueId
                };
                
                propertyTypes.Add(propertyType);
            }
            return propertyTypes;
        }

        public MemberTypeReadOnlyDto BuildDto(IMemberType entity)
        {
            throw new System.NotImplementedException();
        }
        
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,10,1],[14,13,14,101,1],[16,13,16,59,1],[19,13,19,14,1],[20,17,20,52,1],[22,17,22,46,1],[23,17,23,60,1],[24,17,24,56,1],[25,17,25,83,1],[26,17,26,58,1],[27,17,27,44,1],[28,17,28,44,1],[29,17,29,58,1],[30,17,30,53,1],[31,17,31,46,1],[32,17,32,44,1],[33,17,33,44,1],[34,17,34,54,1],[35,17,35,54,1],[36,17,36,50,1],[37,17,37,56,1],[38,17,38,86,1],[40,17,40,122,1],[41,17,41,73,1],[43,17,43,94,1],[46,17,46,24,1],[46,26,46,50,1],[46,51,46,53,1],[46,54,46,75,1],[47,17,47,18,1],[48,21,48,52,1],[48,52,48,92,1],[48,92,48,94,1],[48,21,48,94,1],[48,95,48,104,1],[51,21,51,67,1],[54,21,55,76,1],[56,17,56,18,1],[57,17,57,65,1],[59,17,59,35,1],[62,13,62,14,1],[63,17,63,51,1],[64,13,64,14,1],[65,9,65,10,1],[68,9,68,10,1],[71,13,71,64,1],[72,13,72,20,1],[72,22,72,34,1],[72,35,72,37,1],[72,38,72,72,1],[72,72,72,85,1],[72,85,72,86,1],[72,38,72,86,1],[73,13,73,14,1],[74,17,74,49,1],[78,17,78,65,1],[79,17,79,18,1],[81,21,81,55,1],[82,25,82,74,0],[83,21,83,50,1],[84,17,84,18,1],[86,17,86,47,1],[87,17,87,44,1],[88,17,88,54,1],[89,17,89,68,1],[92,17,92,46,1],[93,17,93,61,1],[93,61,93,177,1],[93,177,93,179,1],[93,17,93,179,1],[94,17,94,24,1],[94,26,94,37,1],[94,38,94,40,1],[94,41,94,49,1],[95,17,95,18,1],[97,21,98,102,1],[100,21,100,49,1],[104,21,107,40,1],[109,21,124,63,1],[124,63,124,84,0],[124,84,128,23,1],[109,21,128,23,1],[131,21,131,62,1],[132,21,132,59,1],[133,17,133,18,1],[136,17,136,51,1],[137,17,137,43,1],[138,13,138,14,1],[140,13,140,35,1],[141,9,141,10,1],[146,9,146,10,1],[148,13,148,58,1],[149,13,149,20,1],[149,22,149,33,0],[149,34,149,36,1],[149,37,149,66,1],[149,66,149,160,1],[149,160,149,161,1],[149,37,149,161,1],[150,13,150,14,0],[152,17,153,98,0],[157,17,160,36,0],[162,17,181,19,0],[183,17,183,49,0],[184,13,184,14,0],[185,13,185,34,1],[186,9,186,10,1],[189,9,189,10,0],[190,13,190,56,0]]);
    </script>
  </body>
</html>