<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\ThreadExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Globalization;
using System.Threading;

namespace Umbraco.Core
{
    static class ThreadExtensions
    {
        public static void SanitizeThreadCulture(this Thread thread)
        {
            // get the current culture
            var currentCulture = CultureInfo.CurrentCulture;

            // at the top of any culture should be the invariant culture - find it
            // doing an .Equals comparison ensure that we *will* find it and not loop
            // endlessly
            var invariantCulture = currentCulture;
            while (invariantCulture.Equals(CultureInfo.InvariantCulture) == false)
                invariantCulture = invariantCulture.Parent;

            // now that invariant culture should be the same object as CultureInfo.InvariantCulture
            // yet for some reasons, sometimes it is not - and this breaks anything that loops on
            // culture.Parent until a reference equality to CultureInfo.InvariantCulture. See, for
            // example, the following code in PerformanceCounterLib.IsCustomCategory:
            //
            // CultureInfo culture = CultureInfo.CurrentCulture;
            // while (culture != CultureInfo.InvariantCulture)
            // {
            //     library = GetPerformanceCounterLib(machine, culture);
            //     if (library.IsCustomCategory(category))
            //         return true;
            //     culture = culture.Parent;
            // }
            //
            // The reference comparisons never succeeds, hence the loop never ends, and the
            // application hangs.
            //
            // granted, that comparison should probably be a .Equals comparison, but who knows
            // how many times the framework assumes that it can do a reference comparison? So,
            // better fix the cultures.

            if (ReferenceEquals(invariantCulture, CultureInfo.InvariantCulture))
                return;

            // if we do not have equality, fix cultures by replacing them with a culture with
            // the same name, but obtained here and now, with a proper invariant top culture

            thread.CurrentCulture = CultureInfo.GetCultureInfo(thread.CurrentCulture.Name);
            thread.CurrentUICulture = CultureInfo.GetCultureInfo(thread.CurrentUICulture.Name);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[9,9,9,10,0],[11,13,11,61,0],[16,13,16,51,0],[17,13,17,83,0],[18,17,18,60,0],[41,13,41,81,0],[42,17,42,24,0],[47,13,47,92,0],[48,13,48,96,0],[49,9,49,10,0]]);
    </script>
  </body>
</html>