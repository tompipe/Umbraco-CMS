<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\PublicAccessRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Web.UI.WebControls;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;
using Content = Umbraco.Core.Models.Content;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class PublicAccessRepositoryTest : BaseDatabaseFactoryTest
    {
        [Test]
        public void Can_Delete()
        {
            var content = CreateTestData(3).ToArray();

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new PublicAccessRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {

                var entry = new PublicAccessEntry(content[0], content[1], content[2], new[]
                {
                    new PublicAccessRule
                    {
                        RuleValue = &quot;test&quot;,
                        RuleType = &quot;RoleName&quot;
                    },
                });
                repo.AddOrUpdate(entry);
                unitOfWork.Commit();

                repo.Delete(entry);
                unitOfWork.Commit();

                entry = repo.Get(entry.Key);
                Assert.IsNull(entry);
            }
        }

        [Test]
        public void Can_Add()
        {
            var content = CreateTestData(3).ToArray();

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new PublicAccessRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var entry = new PublicAccessEntry(content[0], content[1], content[2], new[]
                {
                    new PublicAccessRule
                    {
                        RuleValue = &quot;test&quot;,
                        RuleType = &quot;RoleName&quot;
                    },
                });
                repo.AddOrUpdate(entry);
                unitOfWork.Commit();

                var found = repo.GetAll().ToArray();

                Assert.AreEqual(1, found.Count());
                Assert.AreEqual(content[0].Id, found[0].ProtectedNodeId);
                Assert.AreEqual(content[1].Id, found[0].LoginNodeId);
                Assert.AreEqual(content[2].Id, found[0].NoAccessNodeId);
                Assert.IsTrue(found[0].HasIdentity);
                Assert.AreNotEqual(default(DateTime), found[0].CreateDate);
                Assert.AreNotEqual(default(DateTime), found[0].UpdateDate);
                Assert.AreEqual(1, found[0].Rules.Count());
                Assert.AreEqual(&quot;test&quot;, found[0].Rules.First().RuleValue);
                Assert.AreEqual(&quot;RoleName&quot;, found[0].Rules.First().RuleType);
                Assert.AreNotEqual(default(DateTime), found[0].Rules.First().CreateDate);
                Assert.AreNotEqual(default(DateTime), found[0].Rules.First().UpdateDate);
                Assert.IsTrue(found[0].Rules.First().HasIdentity);
            }
        }

        [Test]
        public void Can_Update()
        {
            var content = CreateTestData(3).ToArray();

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new PublicAccessRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var entry = new PublicAccessEntry(content[0], content[1], content[2], new[]
                {
                    new PublicAccessRule
                    {
                        RuleValue = &quot;test&quot;,
                        RuleType = &quot;RoleName&quot;
                    },
                });
                repo.AddOrUpdate(entry);
                unitOfWork.Commit();

                //re-get 
                entry = repo.Get(entry.Key);

                entry.Rules.First().RuleValue = &quot;blah&quot;;
                entry.Rules.First().RuleType = &quot;asdf&quot;;
                repo.AddOrUpdate(entry);

                unitOfWork.Commit();

                //re-get 
                entry = repo.Get(entry.Key);

                Assert.AreEqual(&quot;blah&quot;, entry.Rules.First().RuleValue);
                Assert.AreEqual(&quot;asdf&quot;, entry.Rules.First().RuleType);
            }
        }

        [Test]
        public void Get_By_Id()
        {
            var content = CreateTestData(3).ToArray();

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new PublicAccessRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var entry = new PublicAccessEntry(content[0], content[1], content[2], new[]
                {
                    new PublicAccessRule
                    {
                        RuleValue = &quot;test&quot;,
                        RuleType = &quot;RoleName&quot;
                    },
                });
                repo.AddOrUpdate(entry);
                unitOfWork.Commit();

                //re-get 
                entry = repo.Get(entry.Key);

                Assert.IsNotNull(entry);
            }
        }

        [Test]
        public void Get_All()
        {
            var content = CreateTestData(30).ToArray();

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new PublicAccessRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var allEntries = new List&lt;PublicAccessEntry&gt;();
                for (int i = 0; i &lt; 10; i++)
                {
                    var rules = new List&lt;PublicAccessRule&gt;();
                    for (int j = 0; j &lt; 50; j++)
                    {
                        rules.Add(new PublicAccessRule
                        {
                            RuleValue = &quot;test&quot; + j,
                            RuleType = &quot;RoleName&quot; + j
                        });
                    }                    
                    var entry1 = new PublicAccessEntry(content[i], content[i+1], content[i+2], rules);
                    repo.AddOrUpdate(entry1);                    
                    unitOfWork.Commit();
                    allEntries.Add(entry1);
                }

                //now remove a few rules from a few of the items and then add some more, this will put things &#39;out of order&#39; which 
                //we need to verify our sort order is working for the relator
                for (int i = 0; i &lt; allEntries.Count; i++)
                {
                    //all the even ones
                    if (i % 2 == 0)
                    {
                        var rules = allEntries[i].Rules.ToArray();
                        for (int j = 0; j &lt; rules.Length; j++)
                        {
                            //all the even ones
                            if (j % 2 == 0)
                            {
                                allEntries[i].RemoveRule(rules[j]);
                            }
                        }
                        allEntries[i].AddRule(&quot;newrule&quot; + i, &quot;newrule&quot; + i);
                        repo.AddOrUpdate(allEntries[i]);
                        unitOfWork.Commit();
                    }
                }

                var found = repo.GetAll().ToArray();
                Assert.AreEqual(10, found.Length);

                foreach (var publicAccessEntry in found)
                {
                    var matched = allEntries.First(x =&gt; x.Key == publicAccessEntry.Key);

                    Assert.AreEqual(matched.Rules.Count(), publicAccessEntry.Rules.Count());
                }
            }
        }


        [Test]
        public void Get_All_With_Id()
        {
            var content = CreateTestData(3).ToArray();

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repo = new PublicAccessRepository(unitOfWork, CacheHelper, Logger, SqlSyntax))
            {
                var entry1 = new PublicAccessEntry(content[0], content[1], content[2], new[]
                {
                    new PublicAccessRule
                    {
                        RuleValue = &quot;test&quot;,
                        RuleType = &quot;RoleName&quot;
                    },
                });
                repo.AddOrUpdate(entry1);

                var entry2 = new PublicAccessEntry(content[1], content[0], content[2], new[]
                {
                    new PublicAccessRule
                    {
                        RuleValue = &quot;test&quot;,
                        RuleType = &quot;RoleName&quot;
                    },
                });
                repo.AddOrUpdate(entry2);

                unitOfWork.Commit();

                var found = repo.GetAll(entry1.Key).ToArray();
                Assert.AreEqual(1, found.Count());
            }
        }


        private ContentRepository CreateRepository(IDatabaseUnitOfWork unitOfWork, out ContentTypeRepository contentTypeRepository)
        {
            var templateRepository = new TemplateRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, Mock.Of&lt;IFileSystem&gt;(), Mock.Of&lt;IFileSystem&gt;(), Mock.Of&lt;ITemplatesSection&gt;());
            var tagRepository = new TagRepository(unitOfWork, CacheHelper, Logger, SqlSyntax);
            contentTypeRepository = new ContentTypeRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, templateRepository);
            var repository = new ContentRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, contentTypeRepository, templateRepository, tagRepository, Mock.Of&lt;IContentSection&gt;());
            return repository;
        }

        private IEnumerable&lt;IContent&gt; CreateTestData(int count)
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository ctRepo;
            using (var repo = CreateRepository(unitOfWork, out ctRepo))
            {
                var ct = MockedContentTypes.CreateBasicContentType(&quot;testing&quot;);
                ctRepo.AddOrUpdate(ct);
                unitOfWork.Commit();
                var result = new List&lt;IContent&gt;();
                for (int i = 0; i &lt; count; i++)
                {
                    var c = new Content(&quot;test&quot; + i, -1, ct);
                    repo.AddOrUpdate(c);
                    result.Add(c);
                }
                unitOfWork.Commit();

                return result;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,1],[26,13,26,55,1],[28,13,28,67,1],[29,13,29,55,1],[30,20,30,101,1],[31,13,31,14,1],[33,17,40,20,1],[41,17,41,41,1],[42,17,42,37,1],[44,17,44,36,1],[45,17,45,37,1],[47,17,47,45,1],[48,17,48,38,1],[49,13,49,14,1],[50,9,50,10,1],[54,9,54,10,1],[55,13,55,55,1],[57,13,57,67,1],[58,13,58,55,1],[59,20,59,101,1],[60,13,60,14,1],[61,17,68,20,1],[69,17,69,41,1],[70,17,70,37,1],[72,17,72,53,1],[74,17,74,51,1],[75,17,75,74,1],[76,17,76,70,1],[77,17,77,73,1],[78,17,78,53,1],[79,17,79,76,1],[80,17,80,76,1],[81,17,81,60,1],[82,17,82,75,1],[83,17,83,78,1],[84,17,84,90,1],[85,17,85,90,1],[86,17,86,67,1],[87,13,87,14,1],[88,9,88,10,1],[92,9,92,10,1],[93,13,93,55,1],[95,13,95,67,1],[96,13,96,55,1],[97,20,97,101,1],[98,13,98,14,1],[99,17,106,20,1],[107,17,107,41,1],[108,17,108,37,1],[111,17,111,45,1],[113,17,113,56,1],[114,17,114,55,1],[115,17,115,41,1],[117,17,117,37,1],[120,17,120,45,1],[122,17,122,72,1],[123,17,123,71,1],[124,13,124,14,1],[125,9,125,10,1],[129,9,129,10,1],[130,13,130,55,1],[132,13,132,67,1],[133,13,133,55,1],[134,20,134,101,1],[135,13,135,14,1],[136,17,143,20,1],[144,17,144,41,1],[145,17,145,37,1],[148,17,148,45,1],[150,17,150,41,1],[151,13,151,14,1],[152,9,152,10,1],[156,9,156,10,1],[157,13,157,56,1],[159,13,159,67,1],[160,13,160,55,1],[161,20,161,101,1],[162,13,162,14,1],[163,17,163,64,1],[164,22,164,31,1],[164,33,164,39,1],[164,41,164,44,1],[165,17,165,18,1],[166,21,166,62,1],[167,26,167,35,1],[167,37,167,43,1],[167,45,167,48,1],[168,21,168,22,1],[169,25,173,28,1],[174,21,174,22,1],[175,21,175,103,1],[176,21,176,46,1],[177,21,177,41,1],[178,21,178,44,1],[179,17,179,18,1],[183,22,183,31,1],[183,33,183,53,1],[183,55,183,58,1],[184,17,184,18,1],[186,21,186,36,1],[187,21,187,22,1],[188,25,188,67,1],[189,30,189,39,1],[189,41,189,57,1],[189,59,189,62,1],[190,25,190,26,1],[192,29,192,44,1],[193,29,193,30,1],[194,33,194,68,1],[195,29,195,30,1],[196,25,196,26,1],[197,25,197,77,1],[198,25,198,57,1],[199,25,199,45,1],[200,21,200,22,1],[201,17,201,18,1],[203,17,203,53,1],[204,17,204,51,1],[206,17,206,24,1],[206,26,206,47,1],[206,48,206,50,1],[206,51,206,56,1],[207,17,207,18,1],[208,21,208,57,1],[208,57,208,87,1],[208,87,208,89,1],[208,21,208,89,1],[210,21,210,93,1],[211,17,211,18,1],[212,13,212,14,1],[213,9,213,10,1],[218,9,218,10,1],[219,13,219,55,1],[221,13,221,67,1],[222,13,222,55,1],[223,20,223,101,1],[224,13,224,14,1],[225,17,232,20,1],[233,17,233,42,1],[235,17,242,20,1],[243,17,243,42,1],[245,17,245,37,1],[247,17,247,63,1],[248,17,248,51,1],[249,13,249,14,1],[250,9,250,10,1],[254,9,254,10,1],[255,13,255,183,1],[256,13,256,95,1],[257,13,257,127,1],[258,13,258,182,1],[259,13,259,31,1],[260,9,260,10,1],[263,9,263,10,1],[264,13,264,67,1],[265,13,265,55,1],[267,20,267,71,1],[268,13,268,14,1],[269,17,269,79,1],[270,17,270,40,1],[271,17,271,37,1],[272,17,272,51,1],[273,22,273,31,1],[273,33,273,42,1],[273,44,273,47,1],[274,17,274,18,1],[275,21,275,61,1],[276,21,276,41,1],[277,21,277,35,1],[278,17,278,18,1],[279,17,279,37,1],[281,17,281,31,1],[283,9,283,10,1]]);
    </script>
  </body>
</html>