<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\LanguageRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Globalization;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;

using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class LanguageRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            CreateTestData();
        }

        private LanguageRepository CreateRepository(IDatabaseUnitOfWork unitOfWork)
        {
            return new LanguageRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax);            
        }

     

        [Test]
        public void Can_Perform_Get_On_LanguageRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var language = repository.Get(1);

                // Assert
                Assert.That(language, Is.Not.Null);
                Assert.That(language.HasIdentity, Is.True);
                Assert.That(language.CultureName, Is.EqualTo(&quot;en-US&quot;));
                Assert.That(language.IsoCode, Is.EqualTo(&quot;en-US&quot;));   
            }
        }

        [Test]
        public void Can_Perform_Get_By_Iso_Code_On_LanguageRepository()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var au = CultureInfo.GetCultureInfo(&quot;en-AU&quot;);
                var language = (ILanguage)new Language(au.Name)
                {
                    CultureName = au.DisplayName
                };
                repository.AddOrUpdate(language);
                unitOfWork.Commit();

                //re-get 
                language = repository.GetByIsoCode(au.Name);

                // Assert
                Assert.That(language, Is.Not.Null);
                Assert.That(language.HasIdentity, Is.True);
                Assert.That(language.CultureName, Is.EqualTo(au.DisplayName));
                Assert.That(language.IsoCode, Is.EqualTo(au.Name));
            }
        }

        [Test]
        public void Can_Perform_Get_By_Culture_Name_On_LanguageRepository()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var au = CultureInfo.GetCultureInfo(&quot;en-AU&quot;);
                var language = (ILanguage)new Language(au.Name)
                {
                    CultureName = au.DisplayName
                };
                repository.AddOrUpdate(language);
                unitOfWork.Commit();

                //re-get 
                language = repository.GetByCultureName(au.DisplayName);

                // Assert
                Assert.That(language, Is.Not.Null);
                Assert.That(language.HasIdentity, Is.True);
                Assert.That(language.CultureName, Is.EqualTo(au.DisplayName));
                Assert.That(language.IsoCode, Is.EqualTo(au.Name));
            }
        }

        [Test]
        public void Get_WhenIdDoesntExist_ReturnsNull()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var language = repository.Get(0);

                // Assert
                Assert.That(language, Is.Null);
            }
        }

        [Test]
        public void Can_Perform_GetAll_On_LanguageRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var languages = repository.GetAll();

                // Assert
                Assert.That(languages, Is.Not.Null);
                Assert.That(languages.Any(), Is.True);
                Assert.That(languages.Any(x =&gt; x == null), Is.False);
                Assert.That(languages.Count(), Is.EqualTo(5));
            }
        }

        [Test]
        public void Can_Perform_GetAll_With_Params_On_LanguageRepository()
        { 
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var languages = repository.GetAll(1, 2);

                // Assert
                Assert.That(languages, Is.Not.Null);
                Assert.That(languages.Any(), Is.True);
                Assert.That(languages.Any(x =&gt; x == null), Is.False);
                Assert.That(languages.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_GetByQuery_On_LanguageRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var query = Query&lt;ILanguage&gt;.Builder.Where(x =&gt; x.IsoCode == &quot;da-DK&quot;);
                var result = repository.GetByQuery(query);

                // Assert
                Assert.That(result, Is.Not.Null);
                Assert.That(result.Any(), Is.True);
                Assert.That(result.FirstOrDefault().CultureName, Is.EqualTo(&quot;da-DK&quot;));
            }
        }

        [Test]
        public void Can_Perform_Count_On_LanguageRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var query = Query&lt;ILanguage&gt;.Builder.Where(x =&gt; x.IsoCode.StartsWith(&quot;D&quot;));
                int count = repository.Count(query);

                // Assert
                Assert.That(count, Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_Add_On_LanguageRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var languageBR = new Language(&quot;pt-BR&quot;) {CultureName = &quot;pt-BR&quot;};
                repository.AddOrUpdate(languageBR);
                unitOfWork.Commit();

                // Assert
                Assert.That(languageBR.HasIdentity, Is.True);
                Assert.That(languageBR.Id, Is.EqualTo(6)); //With 5 existing entries the Id should be 6
            }
        }

        [Test]
        public void Can_Perform_Update_On_LanguageRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var language = repository.Get(5);
                language.IsoCode = &quot;pt-BR&quot;;
                language.CultureName = &quot;pt-BR&quot;;

                repository.AddOrUpdate(language);
                unitOfWork.Commit();

                var languageUpdated = repository.Get(5);

                // Assert
                Assert.That(languageUpdated, Is.Not.Null);
                Assert.That(languageUpdated.IsoCode, Is.EqualTo(&quot;pt-BR&quot;));
                Assert.That(languageUpdated.CultureName, Is.EqualTo(&quot;pt-BR&quot;));
            }
        }

        [Test]
        public void Can_Perform_Delete_On_LanguageRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var language = repository.Get(3);
                repository.Delete(language);
                unitOfWork.Commit();

                var exists = repository.Exists(3);

                // Assert
                Assert.That(exists, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Exists_On_LanguageRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var exists = repository.Exists(3);
                var doesntExist = repository.Exists(10);

                // Assert
                Assert.That(exists, Is.True);
                Assert.That(doesntExist, Is.False);
            }
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        public void CreateTestData()
        {
            var languageDK = new Language(&quot;da-DK&quot;) { CultureName = &quot;da-DK&quot; };
            ServiceContext.LocalizationService.Save(languageDK);//Id 2

            var languageSE = new Language(&quot;sv-SE&quot;) { CultureName = &quot;sv-SE&quot; };
            ServiceContext.LocalizationService.Save(languageSE);//Id 3

            var languageDE = new Language(&quot;de-DE&quot;) { CultureName = &quot;de-DE&quot; };
            ServiceContext.LocalizationService.Save(languageDE);//Id 4

            var languagePT = new Language(&quot;pt-PT&quot;) { CultureName = &quot;pt-PT&quot; };
            ServiceContext.LocalizationService.Save(languagePT);//Id 5
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[24,13,24,31,1],[26,13,26,30,1],[27,9,27,10,1],[30,9,30,10,1],[31,13,31,127,1],[32,9,32,10,1],[38,9,38,10,1],[40,13,40,67,1],[41,13,41,55,1],[42,20,42,65,1],[43,13,43,14,1],[45,17,45,50,1],[48,17,48,52,1],[49,17,49,60,1],[50,17,50,72,1],[51,17,51,68,1],[52,13,52,14,1],[53,9,53,10,1],[57,9,57,10,1],[58,13,58,67,1],[59,13,59,55,1],[60,20,60,65,1],[61,13,61,14,1],[62,17,62,62,1],[63,17,66,19,1],[67,17,67,50,1],[68,17,68,37,1],[71,17,71,61,1],[74,17,74,52,1],[75,17,75,60,1],[76,17,76,79,1],[77,17,77,68,1],[78,13,78,14,1],[79,9,79,10,1],[83,9,83,10,1],[84,13,84,67,1],[85,13,85,55,1],[86,20,86,65,1],[87,13,87,14,1],[88,17,88,62,1],[89,17,92,19,1],[93,17,93,50,1],[94,17,94,37,1],[97,17,97,72,1],[100,17,100,52,1],[101,17,101,60,1],[102,17,102,79,1],[103,17,103,68,1],[104,13,104,14,1],[105,9,105,10,1],[109,9,109,10,1],[111,13,111,67,1],[112,13,112,55,1],[113,20,113,65,1],[114,13,114,14,1],[116,17,116,50,1],[119,17,119,48,1],[120,13,120,14,1],[121,9,121,10,1],[125,9,125,10,1],[127,13,127,67,1],[128,13,128,55,1],[129,20,129,65,1],[130,13,130,14,1],[133,17,133,53,1],[136,17,136,53,1],[137,17,137,55,1],[138,17,138,48,1],[138,48,138,57,1],[138,57,138,70,1],[138,17,138,70,1],[139,17,139,63,1],[140,13,140,14,1],[141,9,141,10,1],[145,9,145,10,1],[147,13,147,67,1],[148,13,148,55,1],[149,20,149,65,1],[150,13,150,14,1],[153,17,153,57,1],[156,17,156,53,1],[157,17,157,55,1],[158,17,158,48,1],[158,48,158,57,1],[158,57,158,70,1],[158,17,158,70,1],[159,17,159,63,1],[160,13,160,14,1],[161,9,161,10,1],[165,9,165,10,1],[167,13,167,67,1],[168,13,168,55,1],[169,20,169,65,1],[170,13,170,14,1],[173,17,173,87,1],[174,17,174,59,1],[177,17,177,50,1],[178,17,178,52,1],[179,17,179,87,1],[180,13,180,14,1],[181,9,181,10,1],[185,9,185,10,1],[187,13,187,67,1],[188,13,188,55,1],[189,20,189,65,1],[190,13,190,14,1],[193,17,193,92,1],[194,17,194,53,1],[197,17,197,51,1],[198,13,198,14,1],[199,9,199,10,1],[203,9,203,10,1],[205,13,205,67,1],[206,13,206,55,1],[207,20,207,65,1],[208,13,208,14,1],[211,17,211,80,1],[212,17,212,52,1],[213,17,213,37,1],[216,17,216,62,1],[217,17,217,59,1],[218,13,218,14,1],[219,9,219,10,1],[223,9,223,10,1],[225,13,225,67,1],[226,13,226,55,1],[227,20,227,65,1],[228,13,228,14,1],[231,17,231,50,1],[232,17,232,44,1],[233,17,233,48,1],[235,17,235,50,1],[236,17,236,37,1],[238,17,238,57,1],[241,17,241,59,1],[242,17,242,75,1],[243,17,243,79,1],[244,13,244,14,1],[245,9,245,10,1],[249,9,249,10,1],[251,13,251,67,1],[252,13,252,55,1],[253,20,253,65,1],[254,13,254,14,1],[257,17,257,50,1],[258,17,258,45,1],[259,17,259,37,1],[261,17,261,51,1],[264,17,264,47,1],[265,13,265,14,1],[266,9,266,10,1],[270,9,270,10,1],[272,13,272,67,1],[273,13,273,55,1],[274,20,274,65,1],[275,13,275,14,1],[278,17,278,51,1],[279,17,279,57,1],[282,17,282,46,1],[283,17,283,52,1],[284,13,284,14,1],[285,9,285,10,1],[289,9,289,10,1],[290,13,290,29,1],[291,9,291,10,1],[294,9,294,10,1],[295,13,295,78,1],[296,13,296,65,1],[298,13,298,78,1],[299,13,299,65,1],[301,13,301,78,1],[302,13,302,65,1],[304,13,304,78,1],[305,13,305,65,1],[306,9,306,10,1]]);
    </script>
  </body>
</html>