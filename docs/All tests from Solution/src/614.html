<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\create\DLRScripting.ascx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Xml.Linq;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Web.UI;
using umbraco.cms.businesslogic.macro;
using umbraco.scripting;
using umbraco.BasePages;

namespace umbraco.presentation.create
{
    public partial class DLRScripting : System.Web.UI.UserControl
    {
        protected System.Web.UI.WebControls.ListBox nodeType;

        protected void Page_Load(object sender, System.EventArgs e)
        {
            sbmt.Text = ui.Text(&quot;create&quot;);
            if (!Page.IsPostBack)
            {
                foreach (MacroEngineLanguage lang in MacroEngineFactory.GetSupportedUILanguages())
                {
                    filetype.Items.Add(new ListItem(string.Format(&quot;.{0} ({1})&quot;, lang.Extension.ToLowerInvariant(), lang.EngineName), lang.Extension));
                }
                filetype.SelectedIndex = 0;
            }
            LoadTemplates(template, filetype.SelectedValue);
        }

        protected void MacroExistsValidator_OnServerValidate(object source, ServerValidateEventArgs args)
        {
            if (createMacro.Checked)
            {
                //TODO: Shouldn&#39;t this use our string functions to create the alias ?
                var fileName = rename.Text + &quot;.&quot; + filetype.SelectedValue;
                var name = fileName
                    .Substring(0, (fileName.LastIndexOf(&#39;.&#39;) + 1)).Trim(&#39;.&#39;)
                    .SplitPascalCasing().ToFirstUpperInvariant();

                var macro = ApplicationContext.Current.Services.MacroService.GetByAlias(name);
                if (macro != null)
                {
                    args.IsValid = false;
                }
            }
        }

        protected void sbmt_Click(object sender, System.EventArgs e)
        {
            if (Page.IsValid)
            {
                var createMacroVal = 0;
                if (createMacro.Checked)
                    createMacroVal = 1;

                var returnUrl = LegacyDialogHandler.Create(
                    new HttpContextWrapper(Context),
                    BasePage.Current.getUser(),
                    helper.Request(&quot;nodeType&quot;),
                    createMacroVal,
                    template.SelectedValue + &quot;|||&quot; + rename.Text + &quot;.&quot; + filetype.SelectedValue);

                BasePage.Current.ClientTools
                    .ChangeContentFrameUrl(returnUrl)
                    .ChildNodeCreated()
                    .CloseModalWindow();
            }
        }

        public void loadTemplates(object sender, EventArgs e)
        {
            LoadTemplates(template, filetype.SelectedValue);
        }

        private void LoadTemplates(ListBox list, string scriptType)
        {
            string path = SystemDirectories.Umbraco + &quot;/scripting/templates/&quot; + scriptType + &quot;/&quot;;
            string abPath = IOHelper.MapPath(path);
            list.Items.Clear();

            // always add the option of an empty one
            list.Items.Add(scriptType == &quot;cshtml&quot;
                               ? new ListItem(&quot;Empty template&quot;, &quot;cshtml/EmptyTemplate.cshtml&quot;)
                               : new ListItem(&quot;Empty template&quot;, &quot;&quot;));

            if (System.IO.Directory.Exists(abPath))
            {
                string extension = &quot;.&quot; + scriptType;

                //Already adding Empty Template as the first item, so don&#39;t add it again
                foreach (System.IO.FileInfo fi in new System.IO.DirectoryInfo(abPath).GetFiles(&quot;*&quot; + extension).Where(fi =&gt; fi.Name != &quot;EmptyTemplate.cshtml&quot;))
                {
                    string filename = System.IO.Path.GetFileName(fi.FullName);

                    var liText = filename.Replace(extension, &quot;&quot;).SplitPascalCasing().ToFirstUpperInvariant();
                    list.Items.Add(new ListItem(liText, scriptType + &quot;/&quot; + filename));
                }
            }
        }

        protected global::System.Web.UI.WebControls.CustomValidator MacroExistsValidator;

        /// &lt;summary&gt;
        /// rename control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.TextBox rename;

        /// &lt;summary&gt;
        /// RequiredFieldValidator1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.RequiredFieldValidator RequiredFieldValidator1;

        /// &lt;summary&gt;
        /// UpdatePanel1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.UpdatePanel UpdatePanel1;

        /// &lt;summary&gt;
        /// filetype control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.ListBox filetype;

        /// &lt;summary&gt;
        /// template control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.ListBox template;

        /// &lt;summary&gt;
        /// createMacro control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.CheckBox createMacro;

        /// &lt;summary&gt;
        /// sbmt control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Button sbmt;

        /// &lt;summary&gt;
        /// Textbox1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.TextBox Textbox1;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,0],[28,13,28,43,0],[29,13,29,34,0],[30,13,30,14,0],[31,17,31,24,0],[31,26,31,50,0],[31,51,31,53,0],[31,54,31,98,0],[32,17,32,18,0],[33,21,33,151,0],[34,17,34,18,0],[35,17,35,44,0],[36,13,36,14,0],[37,13,37,61,0],[38,9,38,10,0],[41,9,41,10,0],[42,13,42,37,0],[43,13,43,14,0],[45,17,45,75,0],[46,17,48,66,0],[50,17,50,95,0],[51,17,51,35,0],[52,17,52,18,0],[53,21,53,42,0],[54,17,54,18,0],[55,13,55,14,0],[56,9,56,10,0],[59,9,59,10,0],[60,13,60,30,0],[61,13,61,14,0],[62,17,62,40,0],[63,17,63,41,0],[64,21,64,40,0],[66,17,71,98,0],[73,17,76,41,0],[77,13,77,14,0],[78,9,78,10,0],[81,9,81,10,0],[82,13,82,61,0],[83,9,83,10,0],[86,9,86,10,0],[87,13,87,98,0],[88,13,88,52,0],[89,13,89,32,0],[92,13,94,70,0],[96,13,96,52,0],[97,13,97,14,0],[98,17,98,53,0],[101,17,101,24,0],[101,26,101,47,0],[101,48,101,50,0],[101,51,101,125,0],[101,125,101,158,0],[101,158,101,159,0],[101,51,101,159,0],[102,17,102,18,0],[103,21,103,79,0],[105,21,105,110,0],[106,21,106,87,0],[107,17,107,18,0],[108,13,108,14,0],[109,9,109,10,0]]);
    </script>
  </body>
</html>