<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\MigrationEntryRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Semver;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Factories;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence.Repositories
{
    internal class MigrationEntryRepository : PetaPocoRepositoryBase&lt;int, IMigrationEntry&gt;, IMigrationEntryRepository
    {
        public MigrationEntryRepository(IDatabaseUnitOfWork work, CacheHelper cache, ILogger logger, ISqlSyntaxProvider sqlSyntax)
            : base(work, cache, logger, sqlSyntax)
        {
        }

        protected override IMigrationEntry PerformGet(int id)
        {
            var sql = GetBaseQuery(false);
            sql.Where(GetBaseWhereClause(), new { Id = id });

            var dto = Database.Fetch&lt;MigrationDto&gt;(SqlSyntax.SelectTop(sql, 1)).FirstOrDefault();
            if (dto == null)
                return null;

            var factory = new MigrationEntryFactory();
            var entity = factory.BuildEntity(dto);

            //on initial construction we don&#39;t want to have dirty properties tracked
            // http://issues.umbraco.org/issue/U4-1946
            entity.ResetDirtyProperties(false);

            return entity;
        }

        protected override IEnumerable&lt;IMigrationEntry&gt; PerformGetAll(params int[] ids)
        {
            var factory = new MigrationEntryFactory();

            if (ids.Any())
            {
                return Database.Fetch&lt;MigrationDto&gt;(&quot;WHERE id in (@ids)&quot;, new { ids = ids })
                    .Select(x =&gt; factory.BuildEntity(x));
            }

            return Database.Fetch&lt;MigrationDto&gt;(&quot;WHERE id &gt; 0&quot;)
                .Select(x =&gt; factory.BuildEntity(x));
        }

        protected override IEnumerable&lt;IMigrationEntry&gt; PerformGetByQuery(IQuery&lt;IMigrationEntry&gt; query)
        {
            var factory = new MigrationEntryFactory();
            var sqlClause = GetBaseQuery(false);
            var translator = new SqlTranslator&lt;IMigrationEntry&gt;(sqlClause, query);
            var sql = translator.Translate();

            return Database.Fetch&lt;MigrationDto&gt;(sql).Select(x =&gt; factory.BuildEntity(x));
        }

        protected override Sql GetBaseQuery(bool isCount)
        {
            var sql = new Sql();
            sql.Select(isCount ? &quot;COUNT(*)&quot; : &quot;*&quot;)
                .From&lt;MigrationDto&gt;(SqlSyntax);
            return sql;
        }

        protected override string GetBaseWhereClause()
        {
            return &quot;id = @Id&quot;;
        }

        protected override IEnumerable&lt;string&gt; GetDeleteClauses()
        {
            var list = new List&lt;string&gt;
            {
                &quot;DELETE FROM umbracoMigration WHERE id = @Id&quot;                               
            };
            return list;
        }

        protected override Guid NodeObjectTypeId
        {
            get { throw new NotImplementedException(); }
        }

        protected override void PersistNewItem(IMigrationEntry entity)
        {
            ((MigrationEntry)entity).AddingEntity();

            var factory = new MigrationEntryFactory();
            var dto = factory.BuildDto(entity);

            var id = Convert.ToInt32(Database.Insert(dto));
            entity.Id = id;

            entity.ResetDirtyProperties();
        }

        protected override void PersistUpdatedItem(IMigrationEntry entity)
        {
            ((MigrationEntry)entity).UpdatingEntity();

            var factory = new MigrationEntryFactory();
            var dto = factory.BuildDto(entity);

            Database.Update(dto);

            entity.ResetDirtyProperties();
        }

        public IMigrationEntry FindEntry(string migrationName, SemVersion version)
        {
            var versionString = version.ToString();

            var sql = new Sql().Select(&quot;*&quot;)
                .From&lt;MigrationDto&gt;(SqlSyntax)
                .Where&lt;MigrationDto&gt;(x =&gt; x.Name.InvariantEquals(migrationName) &amp;&amp; x.Version == versionString);

            var result = Database.FirstOrDefault&lt;MigrationDto&gt;(sql);

            var factory = new MigrationEntryFactory();

            return result == null ? null : factory.BuildEntity(result);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,15,18,51,0],[19,9,19,10,0],[20,9,20,10,0],[23,9,23,10,0],[24,13,24,43,0],[25,13,25,62,0],[27,13,27,98,0],[28,13,28,29,0],[29,17,29,29,0],[31,13,31,55,0],[32,13,32,51,0],[36,13,36,48,0],[38,13,38,27,0],[39,9,39,10,0],[42,9,42,10,0],[43,13,43,55,0],[45,13,45,27,0],[46,13,46,14,0],[47,17,48,34,0],[48,34,48,56,0],[48,56,48,58,0],[47,17,48,58,0],[51,13,52,30,0],[52,30,52,52,0],[52,52,52,54,0],[51,13,52,54,0],[53,9,53,10,0],[56,9,56,10,0],[57,13,57,55,0],[58,13,58,49,0],[59,13,59,83,0],[60,13,60,46,0],[62,13,62,66,0],[62,66,62,88,0],[62,88,62,90,0],[62,13,62,90,0],[63,9,63,10,0],[66,9,66,10,0],[67,13,67,33,0],[68,13,69,48,0],[70,13,70,24,0],[71,9,71,10,0],[74,9,74,10,0],[75,13,75,31,0],[76,9,76,10,0],[79,9,79,10,0],[80,13,83,15,0],[84,13,84,25,0],[85,9,85,10,0],[89,17,89,18,0],[89,19,89,55,0],[93,9,93,10,0],[94,13,94,53,0],[96,13,96,55,0],[97,13,97,48,0],[99,13,99,60,0],[100,13,100,28,0],[102,13,102,43,0],[103,9,103,10,0],[106,9,106,10,0],[107,13,107,55,0],[109,13,109,55,0],[110,13,110,48,0],[112,13,112,34,0],[114,13,114,43,0],[115,9,115,10,0],[118,9,118,10,0],[119,13,119,52,0],[121,13,123,112,0],[125,13,125,69,0],[127,13,127,55,0],[129,13,129,72,0],[130,9,130,10,0]]);
    </script>
  </body>
</html>