<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\RelationRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;

using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;
using umbraco.editorControls.tinyMCE3;
using umbraco.interfaces;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class RelationRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            CreateTestData();
        }

        private RelationRepository CreateRepository(IDatabaseUnitOfWork unitOfWork, out RelationTypeRepository relationTypeRepository)
        {
            relationTypeRepository = new RelationTypeRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax);
            var repository = new RelationRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax, relationTypeRepository);
            return repository;
        }

        [Test]
        public void Can_Perform_Add_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                // Act
                var relationType = repositoryType.Get(1);
                var relation = new Relation(NodeDto.NodeIdSeed + 2, NodeDto.NodeIdSeed + 3, relationType);
                repository.AddOrUpdate(relation);
                unitOfWork.Commit();

                // Assert
                Assert.That(relation, Is.Not.Null);
                Assert.That(relation.HasIdentity, Is.True);
            }
        }

        [Test]
        public void Can_Perform_Update_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                // Act
                var relation = repository.Get(1);
                relation.Comment = &quot;This relation has been updated&quot;;
                repository.AddOrUpdate(relation);
                unitOfWork.Commit();

                var relationUpdated = repository.Get(1);

                // Assert
                Assert.That(relationUpdated, Is.Not.Null);
                Assert.That(relationUpdated.Comment, Is.EqualTo(&quot;This relation has been updated&quot;));
                Assert.AreNotEqual(relationUpdated.UpdateDate, relation.UpdateDate);
            }
        }

        [Test]
        public void Can_Perform_Delete_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                // Act
                var relation = repository.Get(2);
                repository.Delete(relation);
                unitOfWork.Commit();

                var exists = repository.Exists(2);

                // Assert
                Assert.That(exists, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Get_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                // Act
                var relation = repository.Get(1);

                // Assert
                Assert.That(relation, Is.Not.Null);
                Assert.That(relation.HasIdentity, Is.True);
                Assert.That(relation.ChildId, Is.EqualTo(NodeDto.NodeIdSeed + 2));
                Assert.That(relation.ParentId, Is.EqualTo(NodeDto.NodeIdSeed + 1));
                Assert.That(relation.RelationType.Alias, Is.EqualTo(&quot;relateContentOnCopy&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetAll_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                // Act
                var relations = repository.GetAll();

                // Assert
                Assert.That(relations, Is.Not.Null);
                Assert.That(relations.Any(), Is.True);
                Assert.That(relations.Any(x =&gt; x == null), Is.False);
                Assert.That(relations.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_GetAll_With_Params_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                // Act
                var relations = repository.GetAll(1, 2);

                // Assert
                Assert.That(relations, Is.Not.Null);
                Assert.That(relations.Any(), Is.True);
                Assert.That(relations.Any(x =&gt; x == null), Is.False);
                Assert.That(relations.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_Exists_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                // Act
                var exists = repository.Exists(2);
                var doesntExist = repository.Exists(5);

                // Assert
                Assert.That(exists, Is.True);
                Assert.That(doesntExist, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Count_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                // Act
                var query = Query&lt;IRelation&gt;.Builder.Where(x =&gt; x.ParentId == NodeDto.NodeIdSeed + 1);
                int count = repository.Count(query);

                // Assert
                Assert.That(count, Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_GetByQuery_On_RelationRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {
                
                // Act
                var query = Query&lt;IRelation&gt;.Builder.Where(x =&gt; x.RelationTypeId == RelationTypeDto.NodeIdSeed);
                var relations = repository.GetByQuery(query);

                // Assert
                Assert.That(relations, Is.Not.Null);
                Assert.That(relations.Any(), Is.True);
                Assert.That(relations.Any(x =&gt; x == null), Is.False);
                Assert.That(relations.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Delete_Content_And_Verify_Relation_Is_Removed()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            RelationTypeRepository repositoryType;
            using (var repository = CreateRepository(unitOfWork, out repositoryType))
            {

                var content = ServiceContext.ContentService.GetById(NodeDto.NodeIdSeed + 2);
                ServiceContext.ContentService.Delete(content, 0);

                // Act
                var shouldntExist = repository.Exists(1);
                var shouldExist = repository.Exists(2);

                // Assert
                Assert.That(shouldntExist, Is.False);
                Assert.That(shouldExist, Is.True);
            }
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        public void CreateTestData()
        {
            var relateContent = new RelationType(new Guid(Constants.ObjectTypes.Document), new Guid(&quot;C66BA18E-EAF3-4CFF-8A22-41B16D66A972&quot;), &quot;relateContentOnCopy&quot;) { IsBidirectional = true, Name = &quot;Relate Content on Copy&quot; };
            var relateContentType = new RelationType(new Guid(Constants.ObjectTypes.DocumentType), new Guid(&quot;A2CB7800-F571-4787-9638-BC48539A0EFB&quot;), &quot;relateContentTypeOnCopy&quot;) { IsBidirectional = true, Name = &quot;Relate ContentType on Copy&quot; };

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            var relationTypeRepository = new RelationTypeRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax);
            var relationRepository = new RelationRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax, relationTypeRepository);

            relationTypeRepository.AddOrUpdate(relateContent);
            relationTypeRepository.AddOrUpdate(relateContentType);
            unitOfWork.Commit();

            //Create and Save ContentType &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed)
            ContentType contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage&quot;, &quot;Textpage&quot;);
            ServiceContext.ContentTypeService.Save(contentType);

            //Create and Save Content &quot;Homepage&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 1)
            Content textpage = MockedContent.CreateSimpleContent(contentType);
            ServiceContext.ContentService.Save(textpage, 0);

            //Create and Save Content &quot;Text Page 1&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 2)
            Content subpage = MockedContent.CreateSimpleContent(contentType, &quot;Text Page 1&quot;, textpage.Id);
            ServiceContext.ContentService.Save(subpage, 0);

            //Create and Save Content &quot;Text Page 1&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 3)
            Content subpage2 = MockedContent.CreateSimpleContent(contentType, &quot;Text Page 2&quot;, textpage.Id);
            ServiceContext.ContentService.Save(subpage2, 0);

            var relation = new Relation(textpage.Id, subpage.Id, relateContent) { Comment = string.Empty };
            var relation2 = new Relation(textpage.Id, subpage2.Id, relateContent) { Comment = string.Empty };
            relationRepository.AddOrUpdate(relation);
            relationRepository.AddOrUpdate(relation2);
            unitOfWork.Commit();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,1],[28,13,28,31,1],[30,13,30,30,1],[31,9,31,10,1],[34,9,34,10,1],[35,13,35,149,1],[36,13,36,161,1],[37,13,37,31,1],[38,9,38,10,1],[42,9,42,10,1],[44,13,44,67,1],[45,13,45,55,1],[47,20,47,85,1],[48,13,48,14,1],[51,17,51,58,1],[52,17,52,107,1],[53,17,53,50,1],[54,17,54,37,1],[57,17,57,52,1],[58,17,58,60,1],[59,13,59,14,1],[60,9,60,10,1],[64,9,64,10,1],[66,13,66,67,1],[67,13,67,55,1],[69,20,69,85,1],[70,13,70,14,1],[73,17,73,50,1],[74,17,74,69,1],[75,17,75,50,1],[76,17,76,37,1],[78,17,78,57,1],[81,17,81,59,1],[82,17,82,100,1],[83,17,83,85,1],[84,13,84,14,1],[85,9,85,10,1],[89,9,89,10,1],[91,13,91,67,1],[92,13,92,55,1],[94,20,94,85,1],[95,13,95,14,1],[98,17,98,50,1],[99,17,99,45,1],[100,17,100,37,1],[102,17,102,51,1],[105,17,105,47,1],[106,13,106,14,1],[107,9,107,10,1],[111,9,111,10,1],[113,13,113,67,1],[114,13,114,55,1],[116,20,116,85,1],[117,13,117,14,1],[120,17,120,50,1],[123,17,123,52,1],[124,17,124,60,1],[125,17,125,83,1],[126,17,126,84,1],[127,17,127,93,1],[128,13,128,14,1],[129,9,129,10,1],[133,9,133,10,1],[135,13,135,67,1],[136,13,136,55,1],[138,20,138,85,1],[139,13,139,14,1],[142,17,142,53,1],[145,17,145,53,1],[146,17,146,55,1],[147,17,147,48,1],[147,48,147,57,1],[147,57,147,70,1],[147,17,147,70,1],[148,17,148,63,1],[149,13,149,14,1],[150,9,150,10,1],[154,9,154,10,1],[156,13,156,67,1],[157,13,157,55,1],[159,20,159,85,1],[160,13,160,14,1],[163,17,163,57,1],[166,17,166,53,1],[167,17,167,55,1],[168,17,168,48,1],[168,48,168,57,1],[168,57,168,70,1],[168,17,168,70,1],[169,17,169,63,1],[170,13,170,14,1],[171,9,171,10,1],[175,9,175,10,1],[177,13,177,67,1],[178,13,178,55,1],[180,20,180,85,1],[181,13,181,14,1],[184,17,184,51,1],[185,17,185,56,1],[188,17,188,46,1],[189,17,189,52,1],[190,13,190,14,1],[191,9,191,10,1],[195,9,195,10,1],[197,13,197,67,1],[198,13,198,55,1],[200,20,200,85,1],[201,13,201,14,1],[204,17,204,103,1],[205,17,205,53,1],[208,17,208,51,1],[209,13,209,14,1],[210,9,210,10,1],[214,9,214,10,1],[216,13,216,67,1],[217,13,217,55,1],[219,20,219,85,1],[220,13,220,14,1],[223,17,223,113,1],[224,17,224,62,1],[227,17,227,53,1],[228,17,228,55,1],[229,17,229,48,1],[229,48,229,57,1],[229,57,229,70,1],[229,17,229,70,1],[230,17,230,63,1],[231,13,231,14,1],[232,9,232,10,1],[236,9,236,10,1],[238,13,238,67,1],[239,13,239,55,1],[241,20,241,85,1],[242,13,242,14,1],[244,17,244,93,1],[245,17,245,66,1],[248,17,248,58,1],[249,17,249,56,1],[252,17,252,54,1],[253,17,253,51,1],[254,13,254,14,1],[255,9,255,10,1],[259,9,259,10,1],[260,13,260,29,1],[261,9,261,10,1],[264,9,264,10,1],[265,13,265,225,1],[266,13,266,241,1],[268,13,268,67,1],[269,13,269,55,1],[270,13,270,153,1],[271,13,271,169,1],[273,13,273,63,1],[274,13,274,67,1],[275,13,275,33,1],[278,13,278,109,1],[279,13,279,65,1],[282,13,282,79,1],[283,13,283,61,1],[286,13,286,106,1],[287,13,287,60,1],[290,13,290,107,1],[291,13,291,61,1],[293,13,293,108,1],[294,13,294,110,1],[295,13,295,54,1],[296,13,296,55,1],[297,13,297,33,1],[298,9,298,10,1]]);
    </script>
  </body>
</html>