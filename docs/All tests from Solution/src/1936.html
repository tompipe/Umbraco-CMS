<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Media\MediaSubfolderCounter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using Umbraco.Core.IO;

namespace Umbraco.Core.Media
{
    /// &lt;summary&gt;
    /// Internal singleton to handle the numbering of subfolders within the Media-folder.
    /// When this class is initiated it will look for numbered subfolders and select the highest number,
    /// which will be the start point for the naming of the next subfolders. If no subfolders exists
    /// then the starting point will be 1000, ie. /media/1000/koala.jpg
    /// &lt;/summary&gt;
    internal class MediaSubfolderCounter
    {
        #region Singleton

        private long _numberedFolder = 1000;//Default starting point
        private static readonly ReaderWriterLockSlim ClearLock = new ReaderWriterLockSlim();
        private static readonly Lazy&lt;MediaSubfolderCounter&gt; Lazy = new Lazy&lt;MediaSubfolderCounter&gt;(() =&gt; new MediaSubfolderCounter());

        public static MediaSubfolderCounter Current { get { return Lazy.Value; } }

        private MediaSubfolderCounter()
        {
            var folders = new List&lt;long&gt;();
            var fs = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();
            var directories = fs.GetDirectories(&quot;&quot;);
            foreach (var directory in directories)
            {
                long dirNum;
                if (long.TryParse(directory, out dirNum))
                {
                    folders.Add(dirNum);
                }
            }
            var last = folders.OrderBy(x =&gt; x).LastOrDefault();
            if(last != default(long))
                _numberedFolder = last;
        }

        #endregion

        /// &lt;summary&gt;
        /// Returns an increment of the numbered media subfolders.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;A &lt;see cref=&quot;System.Int64&quot;/&gt; value&lt;/returns&gt;
        public long Increment()
        {
            using (new ReadLock(ClearLock))
            {
                _numberedFolder = _numberedFolder + 1;
                return _numberedFolder;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,45,1],[20,9,20,93,1],[21,9,21,106,1],[21,106,21,133,1],[21,133,21,135,1],[21,9,21,135,1],[23,59,23,60,1],[23,61,23,79,1],[23,80,23,81,1],[25,9,25,40,1],[26,9,26,10,1],[27,13,27,44,1],[28,13,28,97,1],[29,13,29,53,1],[30,13,30,20,1],[30,22,30,35,0],[30,36,30,38,1],[30,39,30,50,1],[31,13,31,14,0],[33,17,33,58,0],[34,17,34,18,0],[35,21,35,41,0],[36,17,36,18,0],[37,13,37,14,0],[38,13,38,45,1],[38,45,38,46,0],[38,46,38,64,1],[38,13,38,64,1],[39,13,39,38,1],[40,17,40,40,0],[41,9,41,10,1],[50,9,50,10,1],[51,13,51,44,1],[52,13,52,14,1],[53,17,53,55,1],[54,17,54,40,1],[56,9,56,10,1]]);
    </script>
  </body>
</html>