<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UI\JavaScript\JsInitialization.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Text.RegularExpressions;
using System.Web;
using ClientDependency.Core;
using ClientDependency.Core.Config;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Manifest;
using System.Linq;

namespace Umbraco.Web.UI.JavaScript
{
    /// &lt;summary&gt;
    /// Reads from all defined manifests and ensures that any of their initialization is output with the
    /// main Umbraco initialization output.
    /// &lt;/summary&gt;
    internal class JsInitialization : AssetInitialization
    {        
        private readonly ManifestParser _parser;

        public JsInitialization(ManifestParser parser)
        {
            _parser = parser;
        }

        //used to strip comments
        internal static readonly Regex Comments = new Regex(&quot;(/\\*.*\\*/)&quot;, RegexOptions.Compiled);
        //used for dealing with js functions inside of json (which is not a supported json syntax)
        private const string PrefixJavaScriptObject = &quot;@@@@&quot;;
        private static readonly Regex JsFunctionParser = new Regex(string.Format(&quot;(\&quot;{0}(.*?)\&quot;)+&quot;, PrefixJavaScriptObject),
                                                                    RegexOptions.Multiline
                                                                    | RegexOptions.CultureInvariant
                                                                    | RegexOptions.Compiled);
        //used to replace the tokens in the js main
        private static readonly Regex Token = new Regex(&quot;(\&quot;##\\w+?##\&quot;)&quot;, RegexOptions.Compiled);

        /// &lt;summary&gt;
        /// Processes all found manifest files and outputs the main.js file containing all plugin manifests
        /// &lt;/summary&gt;
        public string GetJavascriptInitialization(HttpContextBase httpContext, JArray umbracoInit, JArray additionalJsFiles = null)
        {
            var result = GetJavascriptInitializationArray(httpContext, umbracoInit, additionalJsFiles);
                
            return ParseMain(
                result.ToString(),
                IOHelper.ResolveUrl(SystemDirectories.Umbraco));
        }

        public JArray GetJavascriptInitializationArray(HttpContextBase httpContext, JArray umbracoInit, JArray additionalJsFiles = null)
        {
            foreach (var m in _parser.GetManifests())
            {
                ManifestParser.MergeJArrays(umbracoInit, m.JavaScriptInitialize);
            }

            //merge in the additional ones specified if there are any
            if (additionalJsFiles != null)
            {
                ManifestParser.MergeJArrays(umbracoInit, additionalJsFiles);
            }

            //now we can optimize if in release mode
            umbracoInit = OptimizeAssetCollection(umbracoInit, ClientDependencyType.Javascript, httpContext);

            //now we need to merge in any found cdf declarations on property editors
            ManifestParser.MergeJArrays(umbracoInit, ScanPropertyEditors(ClientDependencyType.Javascript, httpContext));

            return umbracoInit;
        }

        /// &lt;summary&gt;
        /// Returns the default config as a JArray
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal static JArray GetDefaultInitialization()
        {
            var init = Resources.JsInitialize;
            var deserialized = JsonConvert.DeserializeObject&lt;JArray&gt;(init);
            var result = new JArray();
            foreach (var j in deserialized.Where(j =&gt; j.Type == JTokenType.String))
            {
                result.Add(j);
            }
            return result;
        }

        /// &lt;summary&gt;
        /// Parses the JsResources.Main and replaces the replacement tokens accordingly.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;replacements&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal static string ParseMain(params string[] replacements)
        {
            var count = 0;

            return Token.Replace(Resources.Main, match =&gt;
            {
                var replaced = replacements[count];

                //we need to cater for the special syntax when we have js function() objects contained in the json
                var jsFunctionParsed = JsFunctionParser.Replace(replaced, &quot;$2&quot;);

                count++;

                return jsFunctionParsed;
            });
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,55,0],[27,9,27,10,0],[28,13,28,30,0],[29,9,29,10,0],[32,9,32,100,1],[35,9,38,94,1],[40,9,40,99,1],[46,9,46,10,0],[47,13,47,104,0],[49,13,51,65,0],[52,9,52,10,0],[55,9,55,10,0],[56,13,56,20,0],[56,22,56,27,0],[56,28,56,30,0],[56,31,56,53,0],[57,13,57,14,0],[58,17,58,82,0],[59,13,59,14,0],[62,13,62,43,0],[63,13,63,14,0],[64,17,64,77,0],[65,13,65,14,0],[68,13,68,110,0],[71,13,71,121,0],[73,13,73,32,0],[74,9,74,10,0],[81,9,81,10,1],[82,13,82,47,1],[83,13,83,76,1],[84,13,84,39,1],[85,13,85,20,1],[85,22,85,27,1],[85,28,85,30,1],[85,31,85,55,1],[85,55,85,82,1],[85,82,85,83,1],[85,31,85,83,1],[86,13,86,14,1],[87,17,87,31,1],[88,13,88,14,1],[89,13,89,27,1],[90,9,90,10,1],[98,9,98,10,1],[99,13,99,27,1],[101,13,102,13,1],[102,13,102,14,1],[102,14,103,17,1],[103,17,103,52,1],[103,52,106,17,1],[106,17,106,81,1],[106,81,108,17,1],[108,17,108,25,1],[108,25,110,17,1],[110,17,110,41,1],[110,41,111,13,1],[111,13,111,14,1],[111,14,111,16,1],[101,13,111,16,1],[112,9,112,10,1]]);
    </script>
  </body>
</html>