<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\MacroServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;

using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Services
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, RequiresSTA]
    public class MacroServiceTests : BaseServiceTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        public override void CreateTestData()
        {            
            base.CreateTestData();

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            using (var unitOfWork = provider.GetUnitOfWork())
            using (var repository = new MacroRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax))
            {
                repository.AddOrUpdate(new Macro(&quot;test1&quot;, &quot;Test1&quot;, &quot;~/usercontrol/test1.ascx&quot;, &quot;MyAssembly1&quot;, &quot;test1.xslt&quot;, &quot;~/views/macropartials/test1.cshtml&quot;));
                repository.AddOrUpdate(new Macro(&quot;test2&quot;, &quot;Test2&quot;, &quot;~/usercontrol/test2.ascx&quot;, &quot;MyAssembly2&quot;, &quot;test2.xslt&quot;, &quot;~/views/macropartials/test2.cshtml&quot;));
                repository.AddOrUpdate(new Macro(&quot;test3&quot;, &quot;Tet3&quot;, &quot;~/usercontrol/test3.ascx&quot;, &quot;MyAssembly3&quot;, &quot;test3.xslt&quot;, &quot;~/views/macropartials/test3.cshtml&quot;));
                unitOfWork.Commit();
            }
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        [Test]
        public void Can_Get_By_Alias()
        {
            // Arrange
            var macroService = ServiceContext.MacroService;
            
            // Act
            var macro = macroService.GetByAlias(&quot;test1&quot;);

            //assert
            Assert.IsNotNull(macro);
            Assert.AreEqual(&quot;Test1&quot;, macro.Name);
        }

        [Test]
        public void Can_Get_All()
        {
            // Arrange
            var macroService = ServiceContext.MacroService;

            // Act
            var result = macroService.GetAll();

            //assert
            Assert.AreEqual(3, result.Count());
        }

        [Test]
        public void Can_Create()
        {
            // Arrange
            var macroService = ServiceContext.MacroService;

            // Act
            var macro = new Macro(&quot;test&quot;, &quot;Test&quot;, scriptPath: &quot;~/Views/MacroPartials/Test.cshtml&quot;, cacheDuration: 1234);
            macroService.Save(macro);

            //assert
            Assert.IsTrue(macro.HasIdentity);
            Assert.Greater(macro.Id, 0);
            var result = macroService.GetById(macro.Id);
            Assert.AreEqual(&quot;test&quot;, result.Alias);
            Assert.AreEqual(&quot;Test&quot;, result.Name);
            Assert.AreEqual(&quot;~/Views/MacroPartials/Test.cshtml&quot;, result.ScriptPath);
            Assert.AreEqual(1234, result.CacheDuration);
        }

        [Test]
        public void Can_Delete()
        {
            // Arrange
            var macroService = ServiceContext.MacroService;
            var macro = new Macro(&quot;test&quot;, &quot;Test&quot;, scriptPath: &quot;~/Views/MacroPartials/Test.cshtml&quot;, cacheDuration: 1234);
            macroService.Save(macro);

            // Act
            macroService.Delete(macro);

            //assert
            var result = macroService.GetById(macro.Id);
            Assert.IsNull(result);
        }

        [Test]
        public void Can_Update()
        {
            // Arrange
            var macroService = ServiceContext.MacroService;
            IMacro macro = new Macro(&quot;test&quot;, &quot;Test&quot;, scriptPath: &quot;~/Views/MacroPartials/Test.cshtml&quot;, cacheDuration: 1234);
            macroService.Save(macro);

            // Act
            macro.Name = &quot;New name&quot;;
            macro.Alias = &quot;NewAlias&quot;;
            macroService.Save(macro);


            macro = macroService.GetById(macro.Id);

            //assert
            Assert.AreEqual(&quot;New name&quot;, macro.Name);
            Assert.AreEqual(&quot;NewAlias&quot;, macro.Alias);

        }

        [Test]
        public void Can_Update_Property()
        {
            // Arrange
            var macroService = ServiceContext.MacroService;
            IMacro macro = new Macro(&quot;test&quot;, &quot;Test&quot;, scriptPath: &quot;~/Views/MacroPartials/Test.cshtml&quot;, cacheDuration: 1234);
            macro.Properties.Add(new MacroProperty(&quot;blah&quot;, &quot;Blah&quot;, 0, &quot;blah&quot;));
            macroService.Save(macro);

            // Act
            macro.Properties.First().Alias = &quot;new Alias&quot;;
            macro.Properties.First().Name = &quot;new Name&quot;;
            macro.Properties.First().SortOrder = 1;
            macro.Properties.First().EditorAlias = &quot;new&quot;;
            macroService.Save(macro);

            macro = macroService.GetById(macro.Id);

            //assert
            Assert.AreEqual(1, macro.Properties.Count());
            Assert.AreEqual(&quot;new Alias&quot;, macro.Properties.First().Alias);
            Assert.AreEqual(&quot;new Name&quot;, macro.Properties.First().Name);
            Assert.AreEqual(1, macro.Properties.First().SortOrder);
            Assert.AreEqual(&quot;new&quot;, macro.Properties.First().EditorAlias);

        }

        [Test]
        public void Can_Update_Remove_Property()
        {
            // Arrange
            var macroService = ServiceContext.MacroService;
            IMacro macro = new Macro(&quot;test&quot;, &quot;Test&quot;, scriptPath: &quot;~/Views/MacroPartials/Test.cshtml&quot;, cacheDuration: 1234);
            macro.Properties.Add(new MacroProperty(&quot;blah1&quot;, &quot;Blah1&quot;, 0, &quot;blah1&quot;));
            macro.Properties.Add(new MacroProperty(&quot;blah2&quot;, &quot;Blah2&quot;, 1, &quot;blah2&quot;));
            macro.Properties.Add(new MacroProperty(&quot;blah3&quot;, &quot;Blah3&quot;, 2, &quot;blah3&quot;));
            macroService.Save(macro);

            // Act
            macro.Properties[&quot;blah1&quot;].Alias = &quot;newAlias&quot;;
            macro.Properties[&quot;blah1&quot;].Name = &quot;new Name&quot;;
            macro.Properties[&quot;blah1&quot;].SortOrder = 1;
            macro.Properties[&quot;blah1&quot;].EditorAlias = &quot;new&quot;;
            macro.Properties.Remove(&quot;blah3&quot;);
            macroService.Save(macro);

            macro = macroService.GetById(macro.Id);

            //assert
            Assert.AreEqual(2, macro.Properties.Count());
            Assert.AreEqual(&quot;newAlias&quot;, macro.Properties[&quot;newAlias&quot;].Alias);
            Assert.AreEqual(&quot;new Name&quot;, macro.Properties[&quot;newAlias&quot;].Name);
            Assert.AreEqual(1, macro.Properties[&quot;newAlias&quot;].SortOrder);
            Assert.AreEqual(&quot;new&quot;, macro.Properties[&quot;newAlias&quot;].EditorAlias);
        }

        [Test]
        public void Can_Add_And_Remove_Properties()
        {
            var macroService = ServiceContext.MacroService;
            var macro = new Macro(&quot;test&quot;, &quot;Test&quot;, scriptPath: &quot;~/Views/MacroPartials/Test.cshtml&quot;, cacheDuration: 1234);
            
            //adds some properties
            macro.Properties.Add(new MacroProperty(&quot;blah1&quot;, &quot;Blah1&quot;, 0, &quot;blah1&quot;));
            macro.Properties.Add(new MacroProperty(&quot;blah2&quot;, &quot;Blah2&quot;, 0, &quot;blah2&quot;));
            macro.Properties.Add(new MacroProperty(&quot;blah3&quot;, &quot;Blah3&quot;, 0, &quot;blah3&quot;));
            macro.Properties.Add(new MacroProperty(&quot;blah4&quot;, &quot;Blah4&quot;, 0, &quot;blah4&quot;));
            macroService.Save(macro);

            var result1 = macroService.GetById(macro.Id);
            Assert.AreEqual(4, result1.Properties.Count());

            //simulate clearing the sections
            foreach (var s in result1.Properties.ToArray())
            {
                result1.Properties.Remove(s.Alias);
            }
            //now just re-add a couple
            result1.Properties.Add(new MacroProperty(&quot;blah3&quot;, &quot;Blah3&quot;, 0, &quot;blah3&quot;));
            result1.Properties.Add(new MacroProperty(&quot;blah4&quot;, &quot;Blah4&quot;, 0, &quot;blah4&quot;));
            macroService.Save(result1);

            //assert

            //re-get
            result1 = macroService.GetById(result1.Id);
            Assert.AreEqual(2, result1.Properties.Count());

        }

        [Test]
        public void Cannot_Save_Macro_With_Empty_Name()
        {
            // Arrange
            var macroService = ServiceContext.MacroService;
            var macro = new Macro(&quot;test&quot;, string.Empty, scriptPath: &quot;~/Views/MacroPartials/Test.cshtml&quot;, cacheDuration: 1234);
            
            // Act &amp; Assert
            Assert.Throws&lt;ArgumentException&gt;(() =&gt; macroService.Save(macro));
        }

        //[Test]
        //public void Can_Get_Many_By_Alias()
        //{
        //    // Arrange
        //    var macroService = ServiceContext.MacroService;

        //    // Act
        //    var result = macroService.GetAll(&quot;test1&quot;, &quot;test2&quot;);

        //    //assert
        //    Assert.AreEqual(2, result.Count());
        //}

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,1],[22,13,22,31,1],[23,9,23,10,1],[26,9,26,10,1],[27,13,27,35,1],[29,13,29,67,1],[30,20,30,61,1],[31,20,31,140,1],[32,13,32,14,1],[33,17,33,164,1],[34,17,34,164,1],[35,17,35,163,1],[36,17,36,37,1],[37,13,37,14,1],[38,9,38,10,1],[42,9,42,10,1],[43,13,43,29,1],[44,9,44,10,1],[48,9,48,10,1],[50,13,50,60,1],[53,13,53,58,1],[56,13,56,37,1],[57,13,57,50,1],[58,9,58,10,1],[62,9,62,10,1],[64,13,64,60,1],[67,13,67,48,1],[70,13,70,48,1],[71,9,71,10,1],[75,9,75,10,1],[77,13,77,60,1],[80,13,80,121,1],[81,13,81,38,1],[84,13,84,46,1],[85,13,85,41,1],[86,13,86,57,1],[87,13,87,51,1],[88,13,88,50,1],[89,13,89,85,1],[90,13,90,57,1],[91,9,91,10,1],[95,9,95,10,1],[97,13,97,60,1],[98,13,98,121,1],[99,13,99,38,1],[102,13,102,40,1],[105,13,105,57,1],[106,13,106,35,1],[107,9,107,10,1],[111,9,111,10,1],[113,13,113,60,1],[114,13,114,124,1],[115,13,115,38,1],[118,13,118,37,1],[119,13,119,38,1],[120,13,120,38,1],[123,13,123,52,1],[126,13,126,53,1],[127,13,127,54,1],[129,9,129,10,1],[133,9,133,10,1],[135,13,135,60,1],[136,13,136,124,1],[137,13,137,80,1],[138,13,138,38,1],[141,13,141,58,1],[142,13,142,56,1],[143,13,143,52,1],[144,13,144,58,1],[145,13,145,38,1],[147,13,147,52,1],[150,13,150,58,1],[151,13,151,74,1],[152,13,152,72,1],[153,13,153,68,1],[154,13,154,74,1],[156,9,156,10,1],[160,9,160,10,1],[162,13,162,60,1],[163,13,163,124,1],[164,13,164,83,1],[165,13,165,83,1],[166,13,166,83,1],[167,13,167,38,1],[170,13,170,58,1],[171,13,171,57,1],[172,13,172,53,1],[173,13,173,59,1],[174,13,174,46,1],[175,13,175,38,1],[177,13,177,52,1],[180,13,180,58,1],[181,13,181,77,1],[182,13,182,76,1],[183,13,183,72,1],[184,13,184,78,1],[185,9,185,10,1],[189,9,189,10,1],[190,13,190,60,1],[191,13,191,121,1],[194,13,194,83,1],[195,13,195,83,1],[196,13,196,83,1],[197,13,197,83,1],[198,13,198,38,1],[200,13,200,58,1],[201,13,201,60,1],[204,13,204,20,1],[204,22,204,27,1],[204,28,204,30,1],[204,31,204,59,1],[205,13,205,14,1],[206,17,206,52,1],[207,13,207,14,1],[209,13,209,85,1],[210,13,210,85,1],[211,13,211,40,1],[216,13,216,56,1],[217,13,217,60,1],[219,9,219,10,1],[223,9,223,10,1],[225,13,225,60,1],[226,13,226,127,1],[229,13,229,52,1],[229,52,229,76,1],[229,76,229,78,1],[229,13,229,78,1],[230,9,230,10,1]]);
    </script>
  </body>
</html>