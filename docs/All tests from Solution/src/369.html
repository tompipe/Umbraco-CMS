<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\ServerRegistrationRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data.SqlServerCe;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;

using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class ServerRegistrationRepositoryTest : BaseDatabaseFactoryTest
    {
        private ICacheProvider _staticCache;

        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            _staticCache = new StaticCacheProvider();
            CreateTestData();
        }

        private ServerRegistrationRepository CreateRepository(IDatabaseUnitOfWork unitOfWork)
        {
            return new ServerRegistrationRepository(unitOfWork, _staticCache, Mock.Of&lt;ILogger&gt;(), SqlSyntax);
        }

        [Test]
        public void Cannot_Add_Duplicate_Server_Identities()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();

            // Act
            using (var repository = CreateRepository(unitOfWork))
            {
                var server = new ServerRegistration(&quot;http://shazwazza.com&quot;, &quot;COMPUTER1&quot;, DateTime.Now);
                repository.AddOrUpdate(server);

                Assert.Throws&lt;SqlCeException&gt;(unitOfWork.Commit);
            }

        }

        [Test]
        public void Cannot_Update_To_Duplicate_Server_Identities()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();

            // Act
            using (var repository = CreateRepository(unitOfWork))
            {
                var server = repository.Get(1);
                server.ServerIdentity = &quot;COMPUTER2&quot;;
                repository.AddOrUpdate(server);
                Assert.Throws&lt;SqlCeException&gt;(unitOfWork.Commit);
            }

        }

        [Test]
        public void Can_Instantiate_Repository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();

            // Act
            using (var repository = CreateRepository(unitOfWork))
            {
                // Assert
                Assert.That(repository, Is.Not.Null);    
            }
        }

        [Test]
        public void Can_Perform_Get_On_Repository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var server = repository.Get(1);

                // Assert
                Assert.That(server, Is.Not.Null);
                Assert.That(server.HasIdentity, Is.True);
                Assert.That(server.ServerAddress, Is.EqualTo(&quot;http://localhost&quot;));    
            }

            
        }

        [Test]
        public void Can_Perform_GetAll_On_Repository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var servers = repository.GetAll();

                // Assert
                Assert.That(servers.Count(), Is.EqualTo(3));    
            }
            
        }

        // queries are not supported due to in-memory caching

        //[Test]
        //public void Can_Perform_GetByQuery_On_Repository()
        //{
        //    // Arrange
        //    var provider = new PetaPocoUnitOfWorkProvider(Logger);
        //    var unitOfWork = provider.GetUnitOfWork();
        //    using (var repository = CreateRepository(unitOfWork))
        //    {
        //        // Act
        //        var query = Query&lt;IServerRegistration&gt;.Builder.Where(x =&gt; x.ServerIdentity.ToUpper() == &quot;COMPUTER3&quot;);
        //        var result = repository.GetByQuery(query);

        //        // Assert
        //        Assert.AreEqual(1, result.Count());    
        //    }
        //}

        //[Test]
        //public void Can_Perform_Count_On_Repository()
        //{
        //    // Arrange
        //    var provider = new PetaPocoUnitOfWorkProvider(Logger);
        //    var unitOfWork = provider.GetUnitOfWork();
        //    using (var repository = CreateRepository(unitOfWork))
        //    {
        //        // Act
        //        var query = Query&lt;IServerRegistration&gt;.Builder.Where(x =&gt; x.ServerAddress.StartsWith(&quot;http://&quot;));
        //        int count = repository.Count(query);

        //        // Assert
        //        Assert.That(count, Is.EqualTo(2));    
        //    }
        //}

        [Test]
        public void Can_Perform_Add_On_Repository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var server = new ServerRegistration(&quot;http://shazwazza.com&quot;, &quot;COMPUTER4&quot;, DateTime.Now);
                repository.AddOrUpdate(server);
                unitOfWork.Commit();

                // Assert
                Assert.That(server.HasIdentity, Is.True);
                Assert.That(server.Id, Is.EqualTo(4));//With 3 existing entries the Id should be 4   
            }            
        }

        [Test]
        public void Can_Perform_Update_On_Repository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var server = repository.Get(2);
                server.ServerAddress = &quot;https://umbraco.com&quot;;
                server.IsActive = true;

                repository.AddOrUpdate(server);
                unitOfWork.Commit();

                var serverUpdated = repository.Get(2);

                // Assert
                Assert.That(serverUpdated, Is.Not.Null);
                Assert.That(serverUpdated.ServerAddress, Is.EqualTo(&quot;https://umbraco.com&quot;));
                Assert.That(serverUpdated.IsActive, Is.EqualTo(true));   
            }            
        }

        [Test]
        public void Can_Perform_Delete_On_Repository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var server = repository.Get(3);
                Assert.IsNotNull(server);
                repository.Delete(server);
                unitOfWork.Commit();

                var exists = repository.Exists(3);

                // Assert
                Assert.That(exists, Is.False);   
            }            
        }

        [Test]
        public void Can_Perform_Exists_On_Repository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                // Act
                var exists = repository.Exists(3);
                var doesntExist = repository.Exists(10);

                // Assert
                Assert.That(exists, Is.True);
                Assert.That(doesntExist, Is.False);    
            }
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        public void CreateTestData()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            using (var unitOfWork = provider.GetUnitOfWork())
            using (var repository = CreateRepository(unitOfWork))
            {
                repository.AddOrUpdate(new ServerRegistration(&quot;http://localhost&quot;, &quot;COMPUTER1&quot;, DateTime.Now) { IsActive = true });
                repository.AddOrUpdate(new ServerRegistration(&quot;http://www.mydomain.com&quot;, &quot;COMPUTER2&quot;, DateTime.Now));
                repository.AddOrUpdate(new ServerRegistration(&quot;https://www.another.domain.com&quot;, &quot;Computer3&quot;, DateTime.Now));
                unitOfWork.Commit();
            }

        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,1],[27,13,27,31,1],[29,13,29,54,1],[30,13,30,30,1],[31,9,31,10,1],[34,9,34,10,1],[35,13,35,110,1],[36,9,36,10,1],[40,9,40,10,1],[42,13,42,67,1],[43,13,43,55,1],[46,20,46,65,1],[47,13,47,14,1],[48,17,48,104,1],[49,17,49,48,1],[51,17,51,66,1],[52,13,52,14,1],[54,9,54,10,1],[58,9,58,10,1],[60,13,60,67,1],[61,13,61,55,1],[64,20,64,65,1],[65,13,65,14,1],[66,17,66,48,1],[67,17,67,53,1],[68,17,68,48,1],[69,17,69,66,1],[70,13,70,14,1],[72,9,72,10,1],[76,9,76,10,1],[78,13,78,67,1],[79,13,79,55,1],[82,20,82,65,1],[83,13,83,14,1],[85,17,85,54,1],[86,13,86,14,1],[87,9,87,10,1],[91,9,91,10,1],[93,13,93,67,1],[94,13,94,55,1],[95,20,95,65,1],[96,13,96,14,1],[98,17,98,48,1],[101,17,101,50,1],[102,17,102,58,1],[103,17,103,83,1],[104,13,104,14,1],[107,9,107,10,1],[111,9,111,10,1],[113,13,113,67,1],[114,13,114,55,1],[115,20,115,65,1],[116,13,116,14,1],[118,17,118,51,1],[121,17,121,61,1],[122,13,122,14,1],[124,9,124,10,1],[164,9,164,10,1],[166,13,166,67,1],[167,13,167,55,1],[168,20,168,65,1],[169,13,169,14,1],[171,17,171,104,1],[172,17,172,48,1],[173,17,173,37,1],[176,17,176,58,1],[177,17,177,55,1],[178,13,178,14,1],[179,9,179,10,1],[183,9,183,10,1],[185,13,185,67,1],[186,13,186,55,1],[187,20,187,65,1],[188,13,188,14,1],[190,17,190,48,1],[191,17,191,62,1],[192,17,192,40,1],[194,17,194,48,1],[195,17,195,37,1],[197,17,197,55,1],[200,17,200,57,1],[201,17,201,93,1],[202,17,202,71,1],[203,13,203,14,1],[204,9,204,10,1],[208,9,208,10,1],[210,13,210,67,1],[211,13,211,55,1],[212,20,212,65,1],[213,13,213,14,1],[215,17,215,48,1],[216,17,216,42,1],[217,17,217,43,1],[218,17,218,37,1],[220,17,220,51,1],[223,17,223,47,1],[224,13,224,14,1],[225,9,225,10,1],[229,9,229,10,1],[231,13,231,67,1],[232,13,232,55,1],[233,20,233,65,1],[234,13,234,14,1],[236,17,236,51,1],[237,17,237,57,1],[240,17,240,46,1],[241,17,241,52,1],[242,13,242,14,1],[243,9,243,10,1],[247,9,247,10,1],[248,13,248,29,1],[249,9,249,10,1],[252,9,252,10,1],[253,13,253,67,1],[254,20,254,61,1],[255,20,255,65,1],[256,13,256,14,1],[257,17,257,131,1],[258,17,258,118,1],[259,17,259,125,1],[260,17,260,37,1],[261,13,261,14,1],[263,9,263,10,1]]);
    </script>
  </body>
</html>