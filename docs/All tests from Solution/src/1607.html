<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\PropertyEditors\PreValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using Newtonsoft.Json;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;

namespace Umbraco.Core.PropertyEditors
{
    /// &lt;summary&gt;
    /// Defines a pre-value editor
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// A pre-value editor is made up of multiple pre-value fields, each field defines a key that the value is stored against.
    /// Each field can have any editor and the value from each field can store any data such as a simple string or a json structure. 
    /// 
    /// The Json serialization attributes are required for manifest property editors to work.
    /// &lt;/remarks&gt;
    public class PreValueEditor
    {
        public PreValueEditor()
        {
            var fields = new List&lt;PreValueField&gt;();
               
            //the ctor checks if we have PreValueFieldAttributes applied and if so we construct our fields from them
            var props = TypeHelper.CachedDiscoverableProperties(GetType())
                .Where(x =&gt; x.Name != &quot;Fields&quot;);
            foreach (var p in props)
            {
                var att = p.GetCustomAttributes(typeof (PreValueFieldAttribute), false).OfType&lt;PreValueFieldAttribute&gt;().SingleOrDefault();
                if (att != null)
                {
                    if (att.PreValueFieldType != null)
                    {
                        //try to create it
                        try
                        {
                            var instance = (PreValueField) Activator.CreateInstance(att.PreValueFieldType);
                            //overwrite values if they are assigned
                            if (!att.Key.IsNullOrWhiteSpace())
                            {
                                instance.Key = att.Key;
                            }
                            //if the key is still empty then assign it to be the property name
                            if (instance.Key.IsNullOrWhiteSpace())
                            {
                                instance.Key = p.Name;
                            }
                                
                            if (!att.Name.IsNullOrWhiteSpace())
                                instance.Name = att.Name;
                            if (!att.View.IsNullOrWhiteSpace())
                                instance.View = att.View;
                            if (!att.Description.IsNullOrWhiteSpace())
                                instance.Description = att.Description;
                            if (att.HideLabel)
                                instance.HideLabel = att.HideLabel;

                            //add the custom field
                            fields.Add(instance);
                        }
                        catch (Exception ex)
                        {
                            LogHelper.WarnWithException&lt;PreValueEditor&gt;(&quot;Could not create an instance of &quot; + att.PreValueFieldType, ex);                            
                        }
                    }
                    else
                    {
                        fields.Add(MapAttributeToField(att, p));
                    }
                }
            }

            Fields = fields;
        }

        private static PreValueField MapAttributeToField(PreValueFieldAttribute att, PropertyInfo prop)
        {
            return new PreValueField
                {
                    //set the key to the property name if it is empty
                    Key = att.Key.IsNullOrWhiteSpace() ? prop.Name : att.Key,
                    Name = att.Name,
                    Description = att.Description,
                    HideLabel = att.HideLabel,
                    View = att.View.StartsWith(&quot;~/&quot;) ? IOHelper.ResolveUrl(att.View) : att.View
                };
        }

        /// &lt;summary&gt;
        /// A collection of pre-value fields to be edited
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// If fields are specified then the master View and Validators will be ignored
        /// &lt;/remarks&gt;
        [JsonProperty(&quot;fields&quot;)]
        public List&lt;PreValueField&gt; Fields { get; private set; }

        /// &lt;summary&gt;
        /// A method to format the posted values from the editor to the values to be persisted
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;editorValue&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;currentValue&quot;&gt;
        /// The current value that has been persisted to the database for this pre-value editor. This value may be usesful for 
        /// how the value then get&#39;s deserialized again to be re-persisted. In most cases it will probably not be used.
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// By default this will just return the Posted editorValue.
        /// 
        /// This can be overridden if perhaps you have a comma delimited string posted value but want to convert those to individual rows, or to convert
        /// a json structure to multiple rows.
        /// &lt;/remarks&gt;
        public virtual IDictionary&lt;string, PreValue&gt; ConvertEditorToDb(IDictionary&lt;string, object&gt; editorValue, PreValueCollection currentValue)
        {
            //convert to a string based value to be saved in the db
            return editorValue.ToDictionary(x =&gt; x.Key, x =&gt; new PreValue(x.Value == null ? null : x.Value.ToString()));
        }

        /// &lt;summary&gt;
        /// This can be used to re-format the currently saved pre-values that will be passed to the editor,
        /// by default this returns the merged default and persisted pre-values.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;defaultPreVals&quot;&gt;
        /// The default/static pre-vals for the property editor
        /// &lt;/param&gt;
        /// &lt;param name=&quot;persistedPreVals&quot;&gt;
        /// The persisted pre-vals for the property editor
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// This is generally not going to be used by anything unless a property editor wants to change the merging
        /// functionality or needs to convert some legacy persisted data, or convert the string values to strongly typed values in json (i.e. booleans)
        /// 
        /// IMPORTANT! When using this method the default pre values dictionary should not be modified which would change the property editor&#39;s global 
        /// singleton pre-values!
        /// &lt;/remarks&gt;
        public virtual IDictionary&lt;string, object&gt; ConvertDbToEditor(IDictionary&lt;string, object&gt; defaultPreVals, PreValueCollection persistedPreVals)
        {
            //we&#39;ll make a copy since we&#39;ll merge into the defaults - but we don&#39;t want to overwrite the global singleton ones passed in!
            var defaultPreValCopy = new Dictionary&lt;string, object&gt;();
            if (defaultPreVals != null)
            {
                defaultPreValCopy = new Dictionary&lt;string, object&gt;(defaultPreVals);
            }

            if (persistedPreVals.IsDictionaryBased)
            {
                //we just need to merge the dictionaries now, the persisted will replace default.
                foreach (var item in persistedPreVals.PreValuesAsDictionary)
                {
                    //The persisted dictionary contains values of type PreValue which contain the ID and the Value, we don&#39;t care
                    // about the Id, just the value so ignore the id.
                    defaultPreValCopy[item.Key] = item.Value.Value;
                }
                //now we&#39;re going to try to see if any of the values are JSON, if they are we&#39;ll convert them to real JSON objects
                // so they can be consumed as real json in angular!
                ConvertItemsToJsonIfDetected(defaultPreValCopy);

                return defaultPreValCopy;
            }

            //it&#39;s an array so need to format it 
            var result = new Dictionary&lt;string, object&gt;();
            var asArray = persistedPreVals.PreValuesAsArray.ToArray();
            for (var i = 0; i &lt; asArray.Length; i++)
            {
                //each item is of type PreValue but we don&#39;t want the ID, just the value so ignore the ID
                result.Add(i.ToInvariantString(), asArray[i].Value);
            }

            //now we&#39;re going to try to see if any of the values are JSON, if they are we&#39;ll convert them to real JSON objects
            // so they can be consumed as real json in angular!
            ConvertItemsToJsonIfDetected(result);

            return result;
        }

        private void ConvertItemsToJsonIfDetected(IDictionary&lt;string, object&gt; result)
        {
            //now we&#39;re going to try to see if any of the values are JSON, if they are we&#39;ll convert them to real JSON objects
            // so they can be consumed as real json in angular!

            var keys = result.Keys.ToArray();
            for (var i = 0; i &lt; keys.Length; i++)
            {
                if (result[keys[i]] is string)
                {
                    var asString = result[keys[i]].ToString();
                    if (asString.DetectIsJson())
                    {
                        try
                        {
                            var json = JsonConvert.DeserializeObject(asString);
                            result[keys[i]] = json;
                        }
                        catch
                        {
                            //swallow this exception, we thought it was json but it really isn&#39;t so continue returning a string
                        }
                    }
                }
            }
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,32,1],[24,9,24,10,1],[25,13,25,52,1],[28,13,29,29,1],[29,29,29,47,1],[29,47,29,49,1],[28,13,29,49,1],[30,13,30,20,1],[30,22,30,27,0],[30,28,30,30,1],[30,31,30,36,1],[31,13,31,14,0],[32,17,32,140,0],[33,17,33,33,0],[34,17,34,18,0],[35,21,35,55,0],[36,21,36,22,0],[39,25,39,26,0],[40,29,40,108,0],[42,29,42,63,0],[43,29,43,30,0],[44,33,44,56,0],[45,29,45,30,0],[47,29,47,67,0],[48,29,48,30,0],[49,33,49,55,0],[50,29,50,30,0],[52,29,52,64,0],[53,33,53,58,0],[54,29,54,64,0],[55,33,55,58,0],[56,29,56,71,0],[57,33,57,72,0],[58,29,58,47,0],[59,33,59,68,0],[62,29,62,50,0],[63,25,63,26,0],[64,25,64,45,0],[65,25,65,26,0],[66,29,66,137,0],[67,25,67,26,0],[68,21,68,22,0],[70,21,70,22,0],[71,25,71,65,0],[72,21,72,22,0],[73,17,73,18,0],[74,13,74,14,0],[76,13,76,29,1],[77,9,77,10,1],[80,9,80,10,0],[81,13,89,19,0],[90,9,90,10,0],[99,45,99,49,1],[99,50,99,62,1],[117,9,117,10,0],[119,13,119,50,0],[119,50,119,55,0],[119,55,119,62,0],[119,62,119,119,0],[119,119,119,121,0],[119,13,119,121,0],[120,9,120,10,0],[141,9,141,10,1],[143,13,143,70,1],[144,13,144,40,1],[145,13,145,14,0],[146,17,146,84,0],[147,13,147,14,0],[149,13,149,52,1],[150,13,150,14,1],[152,17,152,24,1],[152,26,152,34,0],[152,35,152,37,1],[152,38,152,76,1],[153,17,153,18,0],[156,21,156,68,0],[157,17,157,18,0],[160,17,160,65,1],[162,17,162,42,1],[166,13,166,59,1],[167,13,167,71,1],[168,18,168,27,1],[168,29,168,47,1],[168,49,168,52,1],[169,13,169,14,1],[171,17,171,69,1],[172,13,172,14,1],[176,13,176,50,1],[178,13,178,27,1],[179,9,179,10,1],[182,9,182,10,1],[186,13,186,46,1],[187,18,187,27,1],[187,29,187,44,1],[187,46,187,49,1],[188,13,188,14,1],[189,17,189,47,1],[190,17,190,18,1],[191,21,191,63,1],[192,21,192,49,1],[193,21,193,22,0],[195,25,195,26,0],[196,29,196,80,0],[197,29,197,52,0],[198,25,198,26,0],[199,25,199,30,0],[200,25,200,26,0],[202,25,202,26,0],[203,21,203,22,0],[204,17,204,18,1],[205,13,205,14,1],[206,9,206,10,1]]);
    </script>
  </body>
</html>