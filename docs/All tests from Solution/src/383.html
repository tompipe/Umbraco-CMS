<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Migrations\MigrationRunnerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Moq;
using NUnit.Framework;
using Semver;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Persistence.Migrations.Syntax.Alter.Expressions;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Services;

namespace Umbraco.Tests.Migrations
{
    [TestFixture]
    public class MigrationRunnerTests
    {
        [Test]
        public void Executes_Only_One_Migration_For_Spanning_Multiple_Targets()
        {
            var runner = new MigrationRunner(
                Mock.Of&lt;IMigrationEntryService&gt;(),
                Mock.Of&lt;ILogger&gt;(), new SemVersion(4, 0, 0), new SemVersion(6, 0, 0), &quot;Test&quot;);

            var migrations = runner.OrderedUpgradeMigrations(new List&lt;IMigration&gt; { new MultiMigration(new SqlCeSyntaxProvider(), Mock.Of&lt;ILogger&gt;()) });

            var ctx = runner.InitializeMigrations(
                //new List&lt;IMigration&gt; {new DoRunMigration(), new DoNotRunMigration()},
                migrations.ToList(),
                new Database(&quot;umbracoDbDSN&quot;)
                , DatabaseProviders.SqlServerCE, true);

            Assert.AreEqual(1, ctx.Expressions.Count());
        }

        [Test]
        public void Executes_Migration_For_Spanning_One_Target_1()
        {
            var runner = new MigrationRunner(
                Mock.Of&lt;IMigrationEntryService&gt;(),
                Mock.Of&lt;ILogger&gt;(), new SemVersion(4, 0, 0), new SemVersion(5, 0, 0), &quot;Test&quot;);

            var migrations = runner.OrderedUpgradeMigrations(new List&lt;IMigration&gt; { new MultiMigration(new SqlCeSyntaxProvider(), Mock.Of&lt;ILogger&gt;()) });

            var ctx = runner.InitializeMigrations(
                //new List&lt;IMigration&gt; {new DoRunMigration(), new DoNotRunMigration()},
                migrations.ToList(),
                new Database(&quot;umbracoDbDSN&quot;)
                , DatabaseProviders.SqlServerCE, true);

            Assert.AreEqual(1, ctx.Expressions.Count());
        }

        [Test]
        public void Executes_Migration_For_Spanning_One_Target_2()
        {
            var runner = new MigrationRunner(
                Mock.Of&lt;IMigrationEntryService&gt;(),
                Mock.Of&lt;ILogger&gt;(), new SemVersion(5, 0, 1), new SemVersion(6, 0, 0), &quot;Test&quot;);

            var migrations = runner.OrderedUpgradeMigrations(new List&lt;IMigration&gt; { new MultiMigration(new SqlCeSyntaxProvider(), Mock.Of&lt;ILogger&gt;()) });

            var ctx = runner.InitializeMigrations(
                //new List&lt;IMigration&gt; {new DoRunMigration(), new DoNotRunMigration()},
                migrations.ToList(),
                new Database(&quot;umbracoDbDSN&quot;)
                , DatabaseProviders.SqlServerCE, true);

            Assert.AreEqual(1, ctx.Expressions.Count());
        }

        [Migration(&quot;6.0.0&quot;, 1, &quot;Test&quot;)]
        [Migration(&quot;5.0.0&quot;, 1, &quot;Test&quot;)]
        private class MultiMigration : MigrationBase
        {
            public MultiMigration(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
            {
            }

            public override void Up()
            {
                Context.Expressions.Add(new AlterColumnExpression(DatabaseProviders.SqlServerCE, new []{DatabaseProviders.SqlServerCE}, SqlSyntax));
            }

            public override void Down()
            {
                Context.Expressions.Add(new AlterColumnExpression(DatabaseProviders.SqlServerCE, new[] { DatabaseProviders.SqlServerCE }, SqlSyntax));
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,1],[22,13,24,95,1],[26,13,26,154,1],[28,13,32,56,1],[34,13,34,57,1],[35,9,35,10,1],[39,9,39,10,1],[40,13,42,95,1],[44,13,44,154,1],[46,13,50,56,1],[52,13,52,57,1],[53,9,53,10,1],[57,9,57,10,1],[58,13,60,95,1],[62,13,62,154,1],[64,13,68,56,1],[70,13,70,57,1],[71,9,71,10,1],[77,83,77,106,1],[78,13,78,14,1],[79,13,79,14,1],[82,13,82,14,1],[83,17,83,149,1],[84,13,84,14,1],[87,13,87,14,0],[88,17,88,151,0],[89,13,89,14,0]]);
    </script>
  </body>
</html>