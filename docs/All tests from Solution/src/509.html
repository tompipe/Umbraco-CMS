<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\controls\Tree\CustomTreeControl.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using ClientDependency.Core;
using umbraco.controls.Tree;
using Umbraco.Core.IO;

namespace umbraco.controls.Tree
{
    /// &lt;summary&gt;
    /// A custom tree control that uses a custom web service to return the initial node, this is required
    /// due to a bug that exists in Umbraco 4.5.1 tree control/web service.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// Since we&#39;re inheriting from a UserControl and all of the ClientDependency registrations are done inline, we need
    /// to re-register the ClientDependencies.
    /// &lt;/remarks&gt;
    [ClientDependency(10, ClientDependencyType.Css, &quot;Tree/treeIcons.css&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(11, ClientDependencyType.Css, &quot;Tree/menuIcons.css&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(12, ClientDependencyType.Css, &quot;Tree/Themes/umbraco/style.css&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(0, ClientDependencyType.Javascript, &quot;Application/NamespaceManager.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;Application/UmbracoClientManager.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;Application/UmbracoApplicationActions.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;Application/UmbracoUtils.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(0, ClientDependencyType.Javascript, &quot;ui/jquery.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(10, ClientDependencyType.Javascript, &quot;Application/JQuery/jquery.metadata.min.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(11, ClientDependencyType.Javascript, &quot;Tree/jquery.tree.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(12, ClientDependencyType.Javascript, &quot;Tree/UmbracoContext.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(12, ClientDependencyType.Javascript, &quot;Tree/jquery.tree.contextmenu.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(12, ClientDependencyType.Javascript, &quot;Tree/jquery.tree.checkbox.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(12, ClientDependencyType.Javascript, &quot;Tree/NodeDefinition.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(13, ClientDependencyType.Javascript, &quot;Tree/UmbracoTree.js&quot;, &quot;UmbracoClient&quot;)]
    public class CustomTreeControl : TreeControl
    {
        private static readonly object m_Locker = new object();

        /// &lt;summary&gt;
        /// Ensure child controls are created on  init
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            this.EnsureChildControls();
        }

        /// &lt;summary&gt;
        /// Create the child controls
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            base.CreateChildControls();

            TreeContainer = new HtmlGenericControl();
            TreeContainer.TagName = &quot;div&quot;;
            TreeContainer.ID = &quot;TreeContainer&quot;;

            this.Controls.Add(TreeContainer);
        }

        /// &lt;summary&gt;
        /// Adds the internal markup to the TreeContainer control
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            //add the internal markup to the TreeContainer
            /* &lt;div id=&quot;&lt;%=ClientID%&gt;&quot; class=&quot;&lt;%#Mode.ToString().ToLower()%&gt;&quot;&gt;&lt;/div&gt;  */
            TreeContainer.Controls.Add(new LiteralControl(@&quot;&lt;div id=&quot;&quot;&quot; + ClientID + @&quot;&quot;&quot; class=&quot;&quot;&quot; + Mode.ToString().ToLower() + @&quot;&quot;&quot;&gt;&lt;/div&gt;&quot;));
        }

        /// &lt;summary&gt;
        /// Render out the correct markup for the tree
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Since we&#39;re inheriting from a UserControl, we need to render out the markup manually
        /// &lt;/remarks&gt;
        /// &lt;param name=&quot;writer&quot;&gt;&lt;/param&gt;
        protected override void Render(System.Web.UI.HtmlTextWriter writer)
        {
            //You&#39;ll notice that we&#39;re replacing the &#39;serviceUrl&#39; parameter with our own custom web service!

            writer.Write(@&quot;
&lt;script type=&quot;&quot;text/javascript&quot;&quot;&gt;
jQuery(document).ready(function() {
    var ctxMenu = &quot; + GetJSONContextMenu() + @&quot;;	
    var app = &quot;&quot;&quot; + App + @&quot;&quot;&quot;;
    var showContext = &quot; + ShowContextMenu.ToString().ToLower() + @&quot;;
    var isDialog = &quot; + IsDialog.ToString().ToLower() + @&quot;;
    var dialogMode = &quot;&quot;&quot; + DialogMode.ToString() + @&quot;&quot;&quot;;
    var treeType = &quot;&quot;&quot; + TreeType + @&quot;&quot;&quot;;
    var functionToCall = &quot;&quot;&quot; + FunctionToCall + @&quot;&quot;&quot;;
    var nodeKey = &quot;&quot;&quot; + NodeKey + @&quot;&quot;&quot;;
	
    //create the javascript tree
    jQuery(&quot;&quot;#&quot; + ClientID + @&quot;&quot;&quot;).UmbracoTree({
        doNotInit: &quot; + ManualInitialization.ToString().ToLower() + @&quot;,
        jsonFullMenu: ctxMenu,
        appActions: UmbClientMgr.appActions(),
        deletingText: &#39;&quot; + umbraco.ui.GetText(&quot;deleting&quot;) + @&quot;&#39;,
        app: app,
        showContext: showContext,
        isDialog: isDialog,
        dialogMode: dialogMode,
        treeType: treeType,
        functionToCall : functionToCall,
        nodeKey : nodeKey,
        treeMode: &quot;&quot;&quot; + Mode.ToString().ToLower() + @&quot;&quot;&quot;,
        dataUrl: &quot;&quot;&quot; + IOHelper.ResolveUrl(SystemDirectories.Umbraco) + @&quot;/webservices/TreeDataService.ashx&quot;&quot;,
        serviceUrl: &quot;&quot;&quot; + IOHelper.ResolveUrl(SystemDirectories.Umbraco) + @&quot;/controls/Tree/CustomTreeService.asmx/GetInitAppTreeData&quot;&quot;});
        
     //add event handler for ajax errors, this will refresh the whole application
    var mainTree = UmbClientMgr.mainTree();
    if (mainTree != null) {
        mainTree.addEventHandler(&quot;&quot;ajaxError&quot;&quot;, function(e) {
            if (e.msg == &quot;&quot;rebuildTree&quot;&quot;) {
	            UmbClientMgr.mainWindow(&quot;&quot;umbraco.aspx&quot;&quot;);
            }
        });
    }
});	

&lt;/script&gt;&quot;);

            //render the controls
            TreeContainer.RenderControl(writer);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[36,9,36,64,0],[43,9,43,10,0],[44,13,44,28,0],[46,13,46,40,0],[47,9,47,10,0],[53,9,53,10,0],[54,13,54,40,0],[56,13,56,54,0],[57,13,57,43,0],[58,13,58,48,0],[60,13,60,46,0],[61,9,61,10,0],[68,9,68,10,0],[69,13,69,33,0],[73,13,73,146,0],[74,9,74,10,0],[84,9,84,10,0],[87,13,127,13,0],[130,13,130,49,0],[131,9,131,10,0]]);
    </script>
  </body>
</html>