<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\userControlWrapper\usercontrolPrevalueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using System.Drawing;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using System.IO;
using Umbraco.Core;
using umbraco.DataLayer;
using umbraco.BusinessLogic;

using umbraco.editorControls;
using Umbraco.Core.IO;
using System.Collections.Generic;
using umbraco.cms.businesslogic.datatype;

namespace umbraco.editorControls.userControlGrapper
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class usercontrolPrevalueEditor : System.Web.UI.WebControls.PlaceHolder, umbraco.interfaces.IDataPrevalue
    {
        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        public static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        #region IDataPrevalue Members

        // referenced datatype
        private umbraco.cms.businesslogic.datatype.BaseDataType _datatype;

        private DropDownList _dropdownlist;
        private DropDownList _dropdownlistUserControl;
        private PlaceHolder _phSettings;

        private Dictionary&lt;string, DataEditorSettingType&gt; dtSettings = new Dictionary&lt;string, DataEditorSettingType&gt;();

        public usercontrolPrevalueEditor(umbraco.cms.businesslogic.datatype.BaseDataType DataType)
        {
            // state it knows its datatypedefinitionid
            _datatype = DataType;
            setupChildControls();

        }

        private void setupChildControls()
        {
            _dropdownlist = new DropDownList();
            _dropdownlist.ID = &quot;dbtype&quot;;
            _dropdownlist.Items.Add(DBTypes.Date.ToString());
            _dropdownlist.Items.Add(DBTypes.Integer.ToString());
            _dropdownlist.Items.Add(DBTypes.Ntext.ToString());
            _dropdownlist.Items.Add(DBTypes.Nvarchar.ToString());

            _dropdownlistUserControl = new DropDownList();
            _dropdownlistUserControl.ID = &quot;usercontrol&quot;;

            _phSettings = new PlaceHolder();
            _phSettings.ID = &quot;settings&quot;;

            // put the childcontrols in context - ensuring that
            // the viewstate is persisted etc.
            Controls.Add(_dropdownlist);
            Controls.Add(_dropdownlistUserControl);
            Controls.Add(_phSettings);

            // populate the usercontrol dropdown
            _dropdownlistUserControl.Items.Add(new ListItem(ui.Text(&quot;choose&quot;), &quot;&quot;));
            populateUserControls(IOHelper.MapPath(SystemDirectories.UserControls));


        }

        private void populateUserControls(string path)
        {
            DirectoryInfo di = new DirectoryInfo(path);
            if (di.Exists == false) return;

            foreach (FileInfo uc in di.GetFiles(&quot;*.ascx&quot;))
            {
                string ucRoot = IOHelper.MapPath(SystemDirectories.UserControls);

                _dropdownlistUserControl.Items.Add(

                    new ListItem(SystemDirectories.UserControls +
                            uc.FullName.Substring(ucRoot.Length).Replace(IOHelper.DirSepChar, &#39;/&#39;))

                        /*
                        new ListItem( 
                            uc.FullName.Substring( uc.FullName.IndexOf(root), uc.FullName.Length - uc.FullName.IndexOf(root)).Replace(IOHelper.DirSepChar, &#39;/&#39;))
                          */
                        );

            }
            foreach (DirectoryInfo dir in di.GetDirectories())
                populateUserControls(dir.FullName);
        }

        public Control Editor
        {
            get
            {
                return this;
            }
        }


        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
            if (!Page.IsPostBack)
            {
                string config = Configuration;
                if (config != &quot;&quot;)
                {
                    _dropdownlistUserControl.SelectedValue = config;


                }
                _dropdownlist.SelectedValue = _datatype.DBType.ToString();



            }

            //check for settings
            if (!string.IsNullOrEmpty(Configuration))
                LoadSetttings(Configuration);


        }

        private Dictionary&lt;string, DataEditorSetting&gt; GetSettings(Type t)
        {
            Dictionary&lt;string, DataEditorSetting&gt; settings = new Dictionary&lt;string, DataEditorSetting&gt;();

            foreach (System.Reflection.PropertyInfo p in t.GetProperties())
            {

                object[] o = p.GetCustomAttributes(typeof(DataEditorSetting), true);

                if (o.Length &gt; 0)
                    settings.Add(p.Name, (DataEditorSetting)o[0]);
            }
            return settings;
        }

        private bool HasSettings(Type t)
        {
            bool hasSettings = false;
            foreach (System.Reflection.PropertyInfo p in t.GetProperties())
            {
                object[] o = p.GetCustomAttributes(typeof(DataEditorSetting), true);

                if (o.Length &gt; 0)
                {
                    hasSettings = true;
                    break;
                }
            }

            return hasSettings;
        }

        private void LoadSetttings(string fileName)
        {
            // due to legacy, some user controls may not have the tilde start
            if (fileName.StartsWith(&quot;~/&quot;))
                fileName = fileName.Substring(2);

            if (System.IO.File.Exists(IOHelper.MapPath(&quot;~/&quot; + fileName)))
            {

                UserControl oControl = (UserControl)this.Page.LoadControl(@&quot;~/&quot; + fileName);

                Type type = oControl.GetType();


                Dictionary&lt;string, DataEditorSetting&gt; settings = GetSettings(type);

                foreach (KeyValuePair&lt;string, DataEditorSetting&gt; kv in settings)
                {
                    DataEditorSettingType dst = kv.Value.GetDataEditorSettingType();
                    dtSettings.Add(kv.Key, dst);

                    DataEditorPropertyPanel panel = new DataEditorPropertyPanel();
                    panel.Text = kv.Value.GetName();
                    panel.Text += &quot;&lt;br/&gt;&lt;small&gt;&quot; + kv.Value.description + &quot;&lt;/small&gt;&quot;;


                    if (HasSettings(type))
                    {
                        DataEditorSettingsStorage ss = new DataEditorSettingsStorage();

                        List&lt;Setting&lt;string, string&gt;&gt; s = ss.GetSettings(_datatype.DataTypeDefinitionId);
                        ss.Dispose();

                        if (s.Find(set =&gt; set.Key == kv.Key).Value != null)
                            dst.Value = s.Find(set =&gt; set.Key == kv.Key).Value;

                    }

                    panel.Controls.Add(dst.RenderControl(kv.Value));

                    Label invalid = new Label();
                    invalid.Attributes.Add(&quot;style&quot;, &quot;color:#8A1F11&quot;);
                    invalid.ID = &quot;lbl&quot; + kv.Key;
                    panel.Controls.Add(invalid);

                    _phSettings.Controls.Add(panel);

                }
            }
        }

		public void Save()
		{
			bool hasErrors = false;
			foreach (KeyValuePair&lt;string, DataEditorSettingType&gt; k in dtSettings)
			{
				var result = k.Value.Validate();
                Label lbl = _phSettings.FindControlRecursive&lt;Label&gt;(&quot;lbl&quot; + k.Key);
				if(result == null &amp;&amp; lbl != null)
				{
					if(lbl != null)
						lbl.Text = string.Empty;
				}
				else
				{
					if(hasErrors == false)
						hasErrors = true;

					if (lbl != null)
						lbl.Text = &quot; &quot; + result.ErrorMessage;
				}
			}

			if (!hasErrors)
			{
				_datatype.DBType =
					(umbraco.cms.businesslogic.datatype.DBTypes)
					Enum.Parse(typeof (umbraco.cms.businesslogic.datatype.DBTypes), _dropdownlist.SelectedValue, true);

				// Generate data-string
				string data = _dropdownlistUserControl.SelectedValue;

                // If the add new prevalue textbox is filled out - add the value to the collection.
                using (var sqlHelper = Application.SqlHelper)
                {
                    IParameter[] SqlParams = new IParameter[]
                                                 {
                                                     sqlHelper.CreateParameter(&quot;@value&quot;, data),
                                                     sqlHelper.CreateParameter(&quot;@dtdefid&quot;, _datatype.DataTypeDefinitionId)
                                                 };
                    sqlHelper.ExecuteNonQuery(&quot;delete from cmsDataTypePreValues where datatypenodeid = @dtdefid&quot;, SqlParams);
                    // we need to populate the parameters again due to an issue with SQL CE
                    SqlParams = new IParameter[]
                                    {
                                        sqlHelper.CreateParameter(&quot;@value&quot;, data),
                                        sqlHelper.CreateParameter(&quot;@dtdefid&quot;, _datatype.DataTypeDefinitionId)
                                    };
                    sqlHelper.ExecuteNonQuery(
                        &quot;insert into cmsDataTypePreValues (datatypenodeid,[value],sortorder,alias) values (@dtdefid,@value,0,&#39;&#39;)&quot;,
                        SqlParams);
                }

				//settings

				DataEditorSettingsStorage ss = new DataEditorSettingsStorage();

				//ss.ClearSettings(_datatype.DataTypeDefinitionId);

				int i = 0;
				foreach (KeyValuePair&lt;string, DataEditorSettingType&gt; k in dtSettings)
				{
					ss.InsertSetting(_datatype.DataTypeDefinitionId, k.Key, k.Value.Value, i);
					i++;

				}

				ss.Dispose();

				if (dtSettings.Count == 0)
				{
					if (!string.IsNullOrEmpty(Configuration))
						LoadSetttings(Configuration);
				}

			}
		}

        protected override void Render(HtmlTextWriter writer)
        {
            writer.WriteLine(&quot;&lt;div class=\&quot;propertyItem\&quot;&gt;&quot;);
            writer.WriteLine(&quot;&lt;div class=\&quot;propertyItemheader\&quot;&gt;Database datatype&lt;/div&gt;&quot;);
            writer.WriteLine(&quot;&lt;div class=\&quot;propertyItemContent\&quot;&gt;&quot;);
            _dropdownlist.RenderControl(writer);
            writer.Write(&quot;&lt;/div&gt;&lt;/div&gt;&quot;);

            writer.WriteLine(&quot;&lt;div class=\&quot;propertyItem\&quot;&gt;&quot;);
            writer.WriteLine(&quot;&lt;div class=\&quot;propertyItemheader\&quot;&gt;Usercontrol:&lt;/div&gt;&quot;);
            writer.WriteLine(&quot;&lt;div class=\&quot;propertyItemContent\&quot;&gt;&quot;);
            _dropdownlistUserControl.RenderControl(writer);
            writer.Write(&quot;&lt;/div&gt;&lt;/div&gt;&quot;);

            _phSettings.RenderControl(writer);
        }

		public string Configuration
		{
			get
			{
                using (var sqlHelper = Application.SqlHelper) { 
                    object conf =
					    sqlHelper.ExecuteScalar&lt;object&gt;(&quot;select value from cmsDataTypePreValues where datatypenodeid = @datatypenodeid&quot;,
											    sqlHelper.CreateParameter(&quot;@datatypenodeid&quot;, _datatype.DataTypeDefinitionId));
				    if (conf != null)
					    return conf.ToString();
				    else
					    return &quot;&quot;;
                }
			}
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,17,31,18,0],[31,19,31,48,0],[31,49,31,50,0],[43,9,43,120,0],[45,9,45,99,0],[46,9,46,10,0],[48,13,48,34,0],[49,13,49,34,0],[51,9,51,10,0],[54,9,54,10,0],[55,13,55,48,0],[56,13,56,41,0],[57,13,57,62,0],[58,13,58,65,0],[59,13,59,63,0],[60,13,60,66,0],[62,13,62,59,0],[63,13,63,57,0],[65,13,65,45,0],[66,13,66,41,0],[70,13,70,41,0],[71,13,71,52,0],[72,13,72,39,0],[75,13,75,85,0],[76,13,76,84,0],[79,9,79,10,0],[82,9,82,10,0],[83,13,83,56,0],[84,13,84,36,0],[84,37,84,44,0],[86,13,86,20,0],[86,22,86,33,0],[86,34,86,36,0],[86,37,86,58,0],[87,13,87,14,0],[88,17,88,82,0],[90,17,99,27,0],[101,13,101,14,0],[102,13,102,20,0],[102,22,102,39,0],[102,40,102,42,0],[102,43,102,62,0],[103,17,103,52,0],[104,9,104,10,0],[109,13,109,14,0],[110,17,110,29,0],[111,13,111,14,0],[116,9,116,10,0],[117,13,117,28,0],[118,13,118,34,0],[119,13,119,14,0],[120,17,120,47,0],[121,17,121,34,0],[122,17,122,18,0],[123,21,123,69,0],[126,17,126,18,0],[127,17,127,75,0],[131,13,131,14,0],[134,13,134,54,0],[135,17,135,46,0],[138,9,138,10,0],[141,9,141,10,0],[142,13,142,106,0],[144,13,144,20,0],[144,22,144,54,0],[144,55,144,57,0],[144,58,144,75,0],[145,13,145,14,0],[147,17,147,85,0],[149,17,149,34,0],[150,21,150,67,0],[151,13,151,14,0],[152,13,152,29,0],[153,9,153,10,0],[156,9,156,10,0],[157,13,157,38,0],[158,13,158,20,0],[158,22,158,54,0],[158,55,158,57,0],[158,58,158,75,0],[159,13,159,14,0],[160,17,160,85,0],[162,17,162,34,0],[163,17,163,18,0],[164,21,164,40,0],[165,21,165,27,0],[167,13,167,14,0],[169,13,169,32,0],[170,9,170,10,0],[173,9,173,10,0],[175,13,175,43,0],[176,17,176,50,0],[178,13,178,74,0],[179,13,179,14,0],[181,17,181,93,0],[183,17,183,48,0],[186,17,186,84,0],[188,17,188,24,0],[188,26,188,68,0],[188,69,188,71,0],[188,72,188,80,0],[189,17,189,18,0],[190,21,190,85,0],[191,21,191,49,0],[193,21,193,83,0],[194,21,194,53,0],[195,21,195,86,0],[198,21,198,43,0],[199,21,199,22,0],[200,25,200,88,0],[202,25,202,106,0],[203,25,203,38,0],[205,25,205,43,0],[205,43,205,60,0],[205,60,205,76,0],[205,25,205,76,0],[206,29,206,55,0],[206,55,206,72,0],[206,72,206,80,0],[206,29,206,80,0],[208,21,208,22,0],[210,21,210,69,0],[212,21,212,49,0],[213,21,213,70,0],[214,21,214,49,0],[215,21,215,49,0],[217,21,217,53,0],[219,17,219,18,0],[220,13,220,14,0],[221,9,221,10,0],[224,3,224,4,0],[225,4,225,27,0],[226,4,226,11,0],[226,13,226,58,0],[226,59,226,61,0],[226,62,226,72,0],[227,4,227,5,0],[228,5,228,37,0],[229,17,229,84,0],[230,5,230,38,0],[231,5,231,6,0],[232,6,232,21,0],[233,7,233,31,0],[234,5,234,6,0],[236,5,236,6,0],[237,6,237,28,0],[238,7,238,24,0],[240,6,240,22,0],[241,7,241,44,0],[242,5,242,6,0],[243,4,243,5,0],[245,4,245,19,0],[246,4,246,5,0],[247,5,249,105,0],[252,5,252,58,0],[255,24,255,61,0],[256,17,256,18,0],[257,21,261,52,0],[262,21,262,126,0],[264,21,268,39,0],[269,21,271,36,0],[272,17,272,18,0],[276,5,276,68,0],[280,5,280,15,0],[281,5,281,12,0],[281,14,281,59,0],[281,60,281,62,0],[281,63,281,73,0],[282,5,282,6,0],[283,6,283,80,0],[284,6,284,10,0],[286,5,286,6,0],[288,5,288,18,0],[290,5,290,31,0],[291,5,291,6,0],[292,6,292,47,0],[293,7,293,36,0],[294,5,294,6,0],[296,4,296,5,0],[297,3,297,4,0],[300,9,300,10,0],[301,13,301,62,0],[302,13,302,91,0],[303,13,303,69,0],[304,13,304,49,0],[305,13,305,42,0],[307,13,307,62,0],[308,13,308,86,0],[309,13,309,69,0],[310,13,310,60,0],[311,13,311,42,0],[313,13,313,47,0],[314,9,314,10,0],[319,4,319,5,0],[320,24,320,61,0],[320,63,320,64,0],[321,21,323,94,0],[324,9,324,26,0],[325,10,325,33,0],[327,10,327,20,0],[329,4,329,5,0]]);
    </script>
  </body>
</html>