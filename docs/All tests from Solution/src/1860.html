<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSevenThreeZero\MigrateAndRemoveTemplateMasterColumn.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSevenThreeZero
{
    /// &lt;summary&gt;
    /// Remove the master column after we&#39;ve migrated all of the values into the &#39;ParentId&#39; and Path column of Umbraco node
    /// &lt;/summary&gt;
    [Migration(&quot;7.3.0&quot;, 1, GlobalSettings.UmbracoMigrationName)]
    public class MigrateAndRemoveTemplateMasterColumn : MigrationBase
    {

        public MigrateAndRemoveTemplateMasterColumn(ISqlSyntaxProvider sqlSyntax, ILogger logger)
            : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {

            //Don&#39;t execute anything if there is no &#39;master&#39; column - this might occur if the db is already upgraded
            var cols = SqlSyntax.GetColumnsInSchema(Context.Database).ToArray();
            if (cols.Any(x =&gt; x.ColumnName.InvariantEquals(&quot;master&quot;) &amp;&amp; x.TableName.InvariantEquals(&quot;cmsTemplate&quot;)) == false)
            {
                return;
            }
            
            var constraints = SqlSyntax.GetConstraintsPerColumn(Context.Database).Distinct().ToArray();

            //update the parentId column for all templates to be correct so it matches the current &#39;master&#39; template

            //In some old corrupted databases, the information will not be correct in the master column so we need to fix that
            //first by nulling out the master column where the id doesn&#39;t actually exist
            Execute.Sql(@&quot;UPDATE cmsTemplate SET master = NULL WHERE &quot; + 
                SqlSyntax.GetQuotedColumnName(&quot;master&quot;) + @&quot; IS NOT NULL AND &quot; + 
                SqlSyntax.GetQuotedColumnName(&quot;master&quot;) + @&quot; NOT IN (&quot; +
                //Stupid MySQL... needs this stupid syntax because it can do an update with a sub query of itself,
                // yet it can do one with a sub sub query
                // ... this will work in all dbs too
                @&quot;SELECT nodeId FROM (SELECT * FROM cmsTemplate a) b)&quot;);

            //Now we can bulk update the parentId column

            //NOTE: This single statement should be used but stupid SQLCE doesn&#39;t support Update with a FROM !!
            // so now we have to do this by individual rows :(
                    //Execute.Sql(@&quot;UPDATE umbracoNode
                    //SET parentID = COALESCE(t2.&quot; + SqlSyntax.GetQuotedColumnName(&quot;master&quot;)  +  @&quot;, -1)
                    //FROM umbracoNode t1
                    //INNER JOIN cmsTemplate t2
                    //ON t1.id = t2.nodeId&quot;);
            Execute.Code(database =&gt;
            {
                var templateData = database.Fetch&lt;dynamic&gt;(&quot;SELECT * FROM cmsTemplate&quot;);

                foreach (var template in templateData)
                {
                    var sql = &quot;SET parentID=@parentId WHERE id=@nodeId&quot;;

                    LogHelper.Info&lt;MigrateAndRemoveTemplateMasterColumn&gt;(&quot;Executing sql statement: UPDATE umbracoNode &quot; + sql);

                    database.Update&lt;NodeDto&gt;(sql,
                        new {parentId = template.master ?? -1, nodeId = template.nodeId});
                }

                return string.Empty;
            });

            //Now we can update the path, but this needs to be done in a delegate callback so that the query runs after the updates just completed
            Execute.Code(database =&gt;
            {
                //NOTE: we are using dynamic because we need to get the data in a column that no longer exists in the schema
                var templates = database.Fetch&lt;dynamic&gt;(new Sql().Select(&quot;*&quot;).From&lt;TemplateDto&gt;());
                foreach (var template in templates)
                {
                    var sql = string.Format(SqlSyntax.UpdateData,
                        SqlSyntax.GetQuotedTableName(&quot;umbracoNode&quot;),
                        &quot;path=@buildPath&quot;,
                        &quot;id=@nodeId&quot;);

                    LogHelper.Info&lt;MigrateAndRemoveTemplateMasterColumn&gt;(&quot;Executing sql statement: &quot; + sql);

                    //now build the correct path for the template
                    database.Execute(sql, new
                    {
                        buildPath = BuildPath(template, templates),
                        nodeId = template.nodeId
                    });
                }

                return string.Empty;
            });

            

            //now remove the master column and key
            if (this.Context.CurrentDatabaseProvider == DatabaseProviders.MySql)
            {
                //Because MySQL doesn&#39;t name keys with what you want, we need to query for the one that is associated
                // this is required for this specific case because there are 2 foreign keys on the cmsTemplate table
                var fkName = constraints.FirstOrDefault(x =&gt; x.Item1.InvariantEquals(&quot;cmsTemplate&quot;) &amp;&amp; x.Item2.InvariantEquals(&quot;master&quot;));
                if (fkName != null)
                {
                    Delete.ForeignKey(fkName.Item3).OnTable(&quot;cmsTemplate&quot;);
                }
            }
            else
            {
                if (constraints.Any(x =&gt; x.Item1.InvariantEquals(&quot;cmsTemplate&quot;) &amp;&amp; x.Item3.InvariantEquals(&quot;FK_cmsTemplate_cmsTemplate&quot;)))
                {
                    Delete.ForeignKey(&quot;FK_cmsTemplate_cmsTemplate&quot;).OnTable(&quot;cmsTemplate&quot;);                   
                }

                //TODO: Hopefully it&#39;s not named something else silly in some crazy old versions
            }


            var dbIndexes = SqlSyntax.GetDefinedIndexes(Context.Database)
                .Select(x =&gt; new DbIndexDefinition()
                {
                    TableName = x.Item1,
                    IndexName = x.Item2,
                    ColumnName = x.Item3,
                    IsUnique = x.Item4
                }).ToArray();

            //in some databases there&#39;s an index (IX_Master) on the master column which needs to be dropped first
            var foundIndex = dbIndexes.FirstOrDefault(x =&gt; x.TableName.InvariantEquals(&quot;cmsTemplate&quot;) &amp;&amp; x.ColumnName.InvariantEquals(&quot;master&quot;));
            if (foundIndex != null)
            {
                Delete.Index(foundIndex.IndexName).OnTable(&quot;cmsTemplate&quot;);
            }

            if (cols.Any(x =&gt; x.ColumnName.InvariantEquals(&quot;master&quot;) &amp;&amp; x.TableName.InvariantEquals(&quot;cmsTemplate&quot;)))
            {
                Delete.Column(&quot;master&quot;).FromTable(&quot;cmsTemplate&quot;);    
            }
        }

        public override void Down()
        {
        }

        private string BuildPath(dynamic template, IEnumerable&lt;dynamic&gt; allTemplates)
        {
            if (template.master == null)
            {
                return string.Format(&quot;-1,{0}&quot;, template.nodeId);
            }

            var parent = allTemplates.FirstOrDefault(x =&gt; x.nodeId == template.master);

            if (parent == null)
            {
                //this shouldn&#39;t happen but i suppose it could if people have bad data
                return string.Format(&quot;-1,{0}&quot;, template.nodeId);
            }

            //recurse
            var parentPath = BuildPath(parent, allTemplates);

            var path = parentPath + string.Format(&quot;,{0}&quot;, template.nodeId);
            return path;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,15,19,38,0],[20,9,20,10,0],[21,9,21,10,0],[24,9,24,10,0],[27,13,27,81,0],[28,13,28,31,0],[28,31,28,115,0],[28,115,28,126,0],[28,13,28,126,0],[29,13,29,14,0],[30,17,30,24,0],[33,13,33,104,0],[39,13,45,73,0],[56,13,57,13,0],[57,13,57,14,0],[57,14,58,17,0],[58,17,58,89,0],[58,89,60,17,0],[60,17,60,24,0],[60,24,60,26,0],[60,26,60,38,0],[60,38,60,39,0],[60,39,60,41,0],[60,41,60,42,0],[60,42,60,54,0],[60,54,61,17,0],[61,17,61,18,0],[61,18,62,21,0],[62,21,62,73,0],[62,73,64,21,0],[64,21,64,128,0],[64,128,66,21,0],[66,21,67,91,0],[67,91,68,17,0],[68,17,68,18,0],[68,18,70,17,0],[70,17,70,37,0],[70,37,71,13,0],[71,13,71,14,0],[71,14,71,16,0],[56,13,71,16,0],[74,13,75,13,0],[75,13,75,14,0],[75,14,77,17,0],[77,17,77,100,0],[77,100,78,17,0],[78,17,78,24,0],[78,24,78,26,0],[78,26,78,38,0],[78,38,78,39,0],[78,39,78,41,0],[78,41,78,42,0],[78,42,78,51,0],[78,51,79,17,0],[79,17,79,18,0],[79,18,80,21,0],[80,21,83,39,0],[83,39,85,21,0],[85,21,85,109,0],[85,109,88,21,0],[88,21,92,24,0],[92,24,93,17,0],[93,17,93,18,0],[93,18,95,17,0],[95,17,95,37,0],[95,37,96,13,0],[96,13,96,14,0],[96,14,96,16,0],[74,13,96,16,0],[101,13,101,81,0],[102,13,102,14,0],[105,17,105,62,0],[105,62,105,137,0],[105,137,105,139,0],[105,17,105,139,0],[106,17,106,36,0],[107,17,107,18,0],[108,21,108,76,0],[109,17,109,18,0],[110,13,110,14,0],[112,13,112,14,0],[113,17,113,42,0],[113,42,113,137,0],[113,137,113,139,0],[113,17,113,139,0],[114,17,114,18,0],[115,21,115,92,0],[116,17,116,18,0],[119,13,119,14,0],[122,13,123,30,0],[123,30,129,18,0],[129,18,129,30,0],[122,13,129,30,0],[132,13,132,60,0],[132,60,132,144,0],[132,144,132,146,0],[132,13,132,146,0],[133,13,133,36,0],[134,13,134,14,0],[135,17,135,75,0],[136,13,136,14,0],[138,13,138,31,0],[138,31,138,115,0],[138,115,138,117,0],[138,13,138,117,0],[139,13,139,14,0],[140,17,140,66,0],[141,13,141,14,0],[142,9,142,10,0],[145,9,145,10,0],[146,9,146,10,0],[149,9,149,10,0],[150,13,150,41,0],[151,13,151,14,0],[152,17,152,65,0],[155,13,155,59,0],[155,59,155,86,0],[155,86,155,88,0],[155,13,155,88,0],[157,13,157,32,0],[158,13,158,14,0],[160,17,160,65,0],[164,13,164,62,0],[166,13,166,76,0],[167,13,167,25,0],[168,9,168,10,0]]);
    </script>
  </body>
</html>