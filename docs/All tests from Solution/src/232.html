<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Models\Mapping\ContentWebModelMappingTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using AutoMapper;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Dictionary;
using Umbraco.Core.Models;
using Umbraco.Core.PropertyEditors;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;
using Umbraco.Web.Dictionary;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Models.Mapping;
using umbraco;

namespace Umbraco.Tests.Models.Mapping
{
    [RequiresAutoMapperMappings]
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerFixture)]
    [TestFixture]
    public class ContentWebModelMappingTests : BaseDatabaseFactoryTest
    {
        protected override void FreezeResolution()
        {
            CultureDictionaryFactoryResolver.Current = new CultureDictionaryFactoryResolver(
                Mock.Of&lt;ICultureDictionaryFactory&gt;());

            base.FreezeResolution();
        }

        [PropertyEditor(&quot;Test.Test&quot;, &quot;Test&quot;, &quot;~/Test.html&quot;)]
        public class TestPropertyEditor : PropertyEditor
        {
            
        }

        //protected override void FreezeResolution()
        //{
        //    PropertyEditorResolver.Current = new PropertyEditorResolver(
        //        () =&gt; PluginManager.Current.ResolvePropertyEditors());

        //    base.FreezeResolution();
        //}

        [Test]
        public void To_Media_Item_Simple()
        {
            var contentType = MockedContentTypes.CreateImageMediaType();
            var content = MockedMedia.CreateMediaImage(contentType, -1);

            var result = Mapper.Map&lt;IMedia, ContentItemBasic&lt;ContentPropertyBasic, IMedia&gt;&gt;(content);

            AssertBasics(result, content);

            foreach (var p in content.Properties)
            {
                AssertBasicProperty(result, p);
            }
        }

        [Test]
        public void To_Content_Item_Simple()
        {
            var contentType = MockedContentTypes.CreateSimpleContentType();
            var content = MockedContent.CreateSimpleContent(contentType);

            var result = Mapper.Map&lt;IContent, ContentItemBasic&lt;ContentPropertyBasic, IContent&gt;&gt;(content);

            AssertBasics(result, content);

            foreach (var p in content.Properties)
            {
                AssertBasicProperty(result, p);
            }
        }

        [Test]
        public void To_Content_Item_Dto()
        {
            var contentType = MockedContentTypes.CreateSimpleContentType();
            var content = MockedContent.CreateSimpleContent(contentType);

            var result = Mapper.Map&lt;IContent, ContentItemDto&lt;IContent&gt;&gt;(content);

            AssertContentItem(result, content);    
        }

        [Test]
        public void To_Media_Item_Dto()
        {
            var contentType = MockedContentTypes.CreateImageMediaType();
            var content = MockedMedia.CreateMediaImage(contentType, -1);

            var result = Mapper.Map&lt;IMedia, ContentItemDto&lt;IMedia&gt;&gt;(content);

            AssertContentItem(result, content);
        }

        [Test]
        public void To_Display_Model()
        {
            var contentType = MockedContentTypes.CreateSimpleContentType();
            var content = MockedContent.CreateSimpleContent(contentType);
            //need ids for tabs
            var id = 1;
            foreach (var g in content.PropertyGroups)
            {
                g.Id = id;
                id++;
            }

            var result = Mapper.Map&lt;IContent, ContentItemDisplay&gt;(content);

            AssertBasics(result, content);
            foreach (var p in content.Properties)
            {
                AssertDisplayProperty(result, p, ApplicationContext);
            }            
            Assert.AreEqual(content.PropertyGroups.Count(), result.Tabs.Count() - 1);
            Assert.IsTrue(result.Tabs.Any(x =&gt; x.Label == ui.Text(&quot;general&quot;, &quot;properties&quot;)));
            Assert.IsTrue(result.Tabs.First().IsActive);
            Assert.IsTrue(result.Tabs.Except(new[] {result.Tabs.First()}).All(x =&gt; x.IsActive == false));
        }

        [Test]
        public void To_Display_Model_With_Non_Grouped_Properties()
        {
            var idSeed = 1;
            var contentType = MockedContentTypes.CreateSimpleContentType();            
            //add non-grouped properties
            contentType.AddPropertyType(new PropertyType(Constants.PropertyEditors.TextboxAlias, DataTypeDatabaseType.Ntext, &quot;nonGrouped1&quot;) { Name = &quot;Non Grouped 1&quot;, Description = &quot;&quot;, Mandatory = false, SortOrder = 1, DataTypeDefinitionId = -88 });
            contentType.AddPropertyType(new PropertyType(Constants.PropertyEditors.TextboxAlias, DataTypeDatabaseType.Ntext, &quot;nonGrouped2&quot;) { Name = &quot;Non Grouped 2&quot;, Description = &quot;&quot;, Mandatory = false, SortOrder = 1, DataTypeDefinitionId = -88 });
            //set ids or it wont work
            contentType.Id = idSeed;
            foreach (var p in contentType.PropertyTypes)
            {
                p.Id = idSeed;
                idSeed++;
            }
            var content = MockedContent.CreateSimpleContent(contentType);
            foreach (var p in content.Properties)
            {
                p.Id = idSeed;
                idSeed++;
            }
            //need ids for tabs
            var id = 1;
            foreach (var g in content.PropertyGroups)
            {
                g.Id = id;
                id++;
            }
            //ensure that nothing is marked as dirty
            contentType.ResetDirtyProperties(false);
            //ensure that nothing is marked as dirty
            content.ResetDirtyProperties(false);

            var result = Mapper.Map&lt;IContent, ContentItemDisplay&gt;(content);

            AssertBasics(result, content);
            foreach (var p in content.Properties)
            {
                AssertDisplayProperty(result, p, ApplicationContext);
            }
            Assert.AreEqual(content.PropertyGroups.Count(), result.Tabs.Count() - 1);
            Assert.IsTrue(result.Tabs.Any(x =&gt; x.Label == ui.Text(&quot;general&quot;, &quot;properties&quot;)));
            Assert.AreEqual(2, result.Tabs.Where(x =&gt; x.Label == ui.Text(&quot;general&quot;, &quot;properties&quot;)).SelectMany(x =&gt; x.Properties.Where(p =&gt; p.Alias.StartsWith(&quot;_umb_&quot;) == false)).Count());
        }

        #region Assertions

        private void AssertDisplayProperty&lt;T, TPersisted&gt;(ContentItemBasic&lt;T, TPersisted&gt; result, Property p, ApplicationContext applicationContext)
            where T : ContentPropertyDisplay
            where TPersisted : IContentBase
        {
            AssertBasicProperty(result, p);
            
            var pDto = result.Properties.SingleOrDefault(x =&gt; x.Alias == p.Alias);
            Assert.IsNotNull(pDto);
            
            //pDto.Alias = p.Alias;
            //pDto.Description = p.PropertyType.Description;
            //pDto.Label = p.PropertyType.Name;
            //pDto.Config = applicationContext.Services.DataTypeService.GetPreValuesByDataTypeId(p.PropertyType.DataTypeDefinitionId);

        }

        private void AssertBasics&lt;T, TPersisted&gt;(ContentItemBasic&lt;T, TPersisted&gt; result, TPersisted content)
            where T : ContentPropertyBasic
            where TPersisted : IContentBase
        {
            Assert.AreEqual(content.Id, result.Id);
            Assert.AreEqual(0, result.Owner.UserId);
            Assert.AreEqual(&quot;Administrator&quot;, result.Owner.Name);
            Assert.AreEqual(content.ParentId, result.ParentId);
            Assert.AreEqual(content.UpdateDate, result.UpdateDate);
            Assert.AreEqual(content.CreateDate, result.CreateDate);
            Assert.AreEqual(content.Name, result.Name);
            Assert.AreEqual(content.Properties.Count(), result.Properties.Count(x =&gt; x.Alias.StartsWith(&quot;_umb_&quot;) == false));
        }

        private void AssertBasicProperty&lt;T, TPersisted&gt;(ContentItemBasic&lt;T, TPersisted&gt; result, Property p)
            where T : ContentPropertyBasic
            where TPersisted : IContentBase
        {
            var pDto = result.Properties.SingleOrDefault(x =&gt; x.Alias == p.Alias);
            Assert.IsNotNull(pDto);
            Assert.AreEqual(p.Alias, pDto.Alias);
            Assert.AreEqual(p.Id, pDto.Id);

            if (p.Value == null)
                Assert.AreEqual(pDto.Value, string.Empty);
            else if (p.Value is decimal)
                Assert.AreEqual(pDto.Value, ((decimal) p.Value).ToString(NumberFormatInfo.InvariantInfo));
            else
                Assert.AreEqual(pDto.Value, p.Value.ToString());
        }

        private void AssertProperty&lt;TPersisted&gt;(ContentItemBasic&lt;ContentPropertyDto, TPersisted&gt; result, Property p)
            where TPersisted : IContentBase
        {
            AssertBasicProperty(result, p);

            var pDto = result.Properties.SingleOrDefault(x =&gt; x.Alias == p.Alias);
            Assert.IsNotNull(pDto);
            Assert.AreEqual(p.PropertyType.Mandatory, pDto.IsRequired);
            Assert.AreEqual(p.PropertyType.ValidationRegExp, pDto.ValidationRegExp);
            Assert.AreEqual(p.PropertyType.Description, pDto.Description);
            Assert.AreEqual(p.PropertyType.Name, pDto.Label);
            Assert.AreEqual(ApplicationContext.Services.DataTypeService.GetDataTypeDefinitionById(p.PropertyType.DataTypeDefinitionId), pDto.DataType);
            Assert.AreEqual(PropertyEditorResolver.Current.GetByAlias(p.PropertyType.PropertyEditorAlias), pDto.PropertyEditor);
        }

        private void AssertContentItem&lt;T&gt;(ContentItemBasic&lt;ContentPropertyDto, T&gt; result, T content)
            where T : IContentBase
        {
            AssertBasics(result, content);

            foreach (var p in content.Properties)
            {
                AssertProperty(result, p);
            }
        }
        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,29,10,1],[30,13,31,55,1],[33,13,33,37,1],[34,9,34,10,1],[52,9,52,10,1],[53,13,53,73,1],[54,13,54,73,1],[56,13,56,102,1],[58,13,58,43,1],[60,13,60,20,1],[60,22,60,27,1],[60,28,60,30,1],[60,31,60,49,1],[61,13,61,14,1],[62,17,62,48,1],[63,13,63,14,1],[64,9,64,10,1],[68,9,68,10,1],[69,13,69,76,1],[70,13,70,74,1],[72,13,72,106,1],[74,13,74,43,1],[76,13,76,20,1],[76,22,76,27,1],[76,28,76,30,1],[76,31,76,49,1],[77,13,77,14,1],[78,17,78,48,1],[79,13,79,14,1],[80,9,80,10,1],[84,9,84,10,1],[85,13,85,76,1],[86,13,86,74,1],[88,13,88,82,1],[90,13,90,48,1],[91,9,91,10,1],[95,9,95,10,1],[96,13,96,73,1],[97,13,97,73,1],[99,13,99,78,1],[101,13,101,48,1],[102,9,102,10,1],[106,9,106,10,1],[107,13,107,76,1],[108,13,108,74,1],[110,13,110,24,1],[111,13,111,20,1],[111,22,111,27,1],[111,28,111,30,1],[111,31,111,53,1],[112,13,112,14,1],[113,17,113,27,1],[114,17,114,22,1],[115,13,115,14,1],[117,13,117,76,1],[119,13,119,43,1],[120,13,120,20,1],[120,22,120,27,1],[120,28,120,30,1],[120,31,120,49,1],[121,13,121,14,1],[122,17,122,70,1],[123,13,123,14,1],[124,13,124,86,1],[125,13,125,48,1],[125,48,125,91,1],[125,91,125,94,1],[125,13,125,94,1],[126,13,126,57,1],[127,13,127,84,1],[127,84,127,103,1],[127,103,127,106,1],[127,13,127,106,1],[128,9,128,10,1],[132,9,132,10,1],[133,13,133,28,1],[134,13,134,76,1],[136,13,136,249,1],[137,13,137,249,1],[139,13,139,37,1],[140,13,140,20,1],[140,22,140,27,1],[140,28,140,30,1],[140,31,140,56,1],[141,13,141,14,1],[142,17,142,31,1],[143,17,143,26,1],[144,13,144,14,1],[145,13,145,74,1],[146,13,146,20,1],[146,22,146,27,1],[146,28,146,30,1],[146,31,146,49,1],[147,13,147,14,1],[148,17,148,31,1],[149,17,149,26,1],[150,13,150,14,1],[152,13,152,24,1],[153,13,153,20,1],[153,22,153,27,1],[153,28,153,30,1],[153,31,153,53,1],[154,13,154,14,1],[155,17,155,27,1],[156,17,156,22,1],[157,13,157,14,1],[159,13,159,53,1],[161,13,161,49,1],[163,13,163,76,1],[165,13,165,43,1],[166,13,166,20,1],[166,22,166,27,1],[166,28,166,30,1],[166,31,166,49,1],[167,13,167,14,1],[168,17,168,70,1],[169,13,169,14,1],[170,13,170,86,1],[171,13,171,48,1],[171,48,171,91,1],[171,91,171,94,1],[171,13,171,94,1],[172,13,172,55,1],[172,55,172,98,1],[172,98,172,116,1],[172,116,172,140,1],[172,140,172,176,1],[172,176,172,177,1],[172,116,172,177,1],[172,177,172,188,1],[172,13,172,188,1],[173,9,173,10,1],[180,9,180,10,1],[181,13,181,44,1],[183,13,183,63,1],[183,63,183,81,1],[183,81,183,83,1],[183,13,183,83,1],[184,13,184,36,1],[191,9,191,10,1],[196,9,196,10,1],[197,13,197,52,1],[198,13,198,53,1],[199,13,199,65,1],[200,13,200,64,1],[201,13,201,68,1],[202,13,202,68,1],[203,13,203,56,1],[204,13,204,86,1],[204,86,204,122,1],[204,122,204,125,1],[204,13,204,125,1],[205,9,205,10,1],[210,9,210,10,1],[211,13,211,63,1],[211,63,211,81,1],[211,81,211,83,1],[211,13,211,83,1],[212,13,212,36,1],[213,13,213,50,1],[214,13,214,44,1],[216,13,216,33,1],[217,17,217,59,1],[218,18,218,41,1],[219,17,219,107,0],[221,17,221,65,1],[222,9,222,10,1],[226,9,226,10,1],[227,13,227,44,1],[229,13,229,63,1],[229,63,229,81,1],[229,81,229,83,1],[229,13,229,83,1],[230,13,230,36,1],[231,13,231,72,1],[232,13,232,85,1],[233,13,233,75,1],[234,13,234,62,1],[235,13,235,152,1],[236,13,236,129,1],[237,9,237,10,1],[241,9,241,10,1],[242,13,242,43,1],[244,13,244,20,1],[244,22,244,27,1],[244,28,244,30,1],[244,31,244,49,1],[245,13,245,14,1],[246,17,246,43,1],[247,13,247,14,1],[248,9,248,10,1]]);
    </script>
  </body>
</html>