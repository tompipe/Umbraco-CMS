<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\InstallSteps\DatabaseInstallStep.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Web.Install.Models;

namespace Umbraco.Web.Install.InstallSteps
{
    [InstallSetupStep(InstallationType.NewInstall | InstallationType.Upgrade,
        &quot;DatabaseInstall&quot;, 11, &quot;&quot;)]
    internal class DatabaseInstallStep : InstallSetupStep&lt;object&gt;
    {
        private readonly ApplicationContext _applicationContext;

        public DatabaseInstallStep(ApplicationContext applicationContext)
        {
            _applicationContext = applicationContext;
        }

        public override InstallSetupResult Execute(object model)
        {
            var result = _applicationContext.DatabaseContext.CreateDatabaseSchemaAndData(_applicationContext);

            if (result.Success == false)
            {
                throw new InstallException(&quot;The database failed to install. ERROR: &quot; + result.Message);
            }
            
            if (result.RequiresUpgrade == false)
            {
                HandleConnectionStrings();
                return null;
            }
            else
            {
                //upgrade is required so set the flag for the next step

                return new InstallSetupResult(new Dictionary&lt;string, object&gt;
                {
                    {&quot;upgrade&quot;, true}
                });
            }
            
        }

        internal static void HandleConnectionStrings()
        {
            // Remove legacy umbracoDbDsn configuration setting if it exists and connectionstring also exists
            if (ConfigurationManager.ConnectionStrings[GlobalSettings.UmbracoConnectionName] != null)
            {
                GlobalSettings.RemoveSetting(GlobalSettings.UmbracoConnectionName);
            }
            else
            {
                var ex = new ArgumentNullException(string.Format(&quot;ConfigurationManager.ConnectionStrings[{0}]&quot;, GlobalSettings.UmbracoConnectionName), &quot;Install / upgrade did not complete successfully, umbracoDbDSN was not set in the connectionStrings section&quot;);
                LogHelper.Error&lt;DatabaseInstallStep&gt;(&quot;&quot;, ex);
                throw ex;
            }
        }

        public override bool RequiresExecution(object model)
        {
            return true;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,74,0],[18,9,18,10,0],[19,13,19,54,0],[20,9,20,10,0],[23,9,23,10,0],[24,13,24,111,0],[26,13,26,41,0],[27,13,27,14,0],[28,17,28,104,0],[31,13,31,49,0],[32,13,32,14,0],[33,17,33,43,0],[34,17,34,29,0],[37,13,37,14,0],[40,17,43,20,0],[46,9,46,10,0],[49,9,49,10,0],[51,13,51,102,0],[52,13,52,14,0],[53,17,53,84,0],[54,13,54,14,0],[56,13,56,14,0],[57,17,57,262,0],[58,17,58,62,0],[59,17,59,26,0],[61,9,61,10,0],[64,9,64,10,0],[65,13,65,25,0],[66,9,66,10,0]]);
    </script>
  </body>
</html>