<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\UmbracoEntityFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Reflection;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Strings;

namespace Umbraco.Core.Persistence.Factories
{
    internal class UmbracoEntityFactory 
    {
        internal void AddAdditionalData(UmbracoEntity entity, IDictionary&lt;string, object&gt; originalEntityProperties)
        {
            var entityProps = typeof(IUmbracoEntity).GetPublicProperties().Select(x =&gt; x.Name).ToArray();
            
            //figure out what extra properties we have that are not on the IUmbracoEntity and add them to additional data
            foreach (var k in originalEntityProperties.Keys
                .Select(x =&gt; new { orig = x, title = x.ToCleanString(CleanStringType.PascalCase | CleanStringType.Ascii | CleanStringType.ConvertCase) })
                .Where(x =&gt; entityProps.InvariantContains(x.title) == false))
            {
                entity.AdditionalData[k.title] = originalEntityProperties[k.orig];
            }
        }

        internal UmbracoEntity BuildEntityFromDynamic(dynamic d)
        {
            var asDictionary = (IDictionary&lt;string, object&gt;)d;

            var entity = new UmbracoEntity(d.trashed);

            try
            {
                entity.DisableChangeTracking();

                entity.CreateDate = d.createDate;
                entity.CreatorId = d.nodeUser;
                entity.Id = d.id;
                entity.Key = d.uniqueID;
                entity.Level = d.level;
                entity.Name = d.text;
                entity.NodeObjectTypeId = d.nodeObjectType;
                entity.ParentId = d.parentID;
                entity.Path = d.path;
                entity.SortOrder = d.sortOrder;
                entity.HasChildren = d.children &gt; 0;
                entity.ContentTypeAlias = asDictionary.ContainsKey(&quot;alias&quot;) ? (d.alias ?? string.Empty) : string.Empty;
                entity.ContentTypeIcon = asDictionary.ContainsKey(&quot;icon&quot;) ? (d.icon ?? string.Empty) : string.Empty;
                entity.ContentTypeThumbnail = asDictionary.ContainsKey(&quot;thumbnail&quot;) ? (d.thumbnail ?? string.Empty) : string.Empty;

                var publishedVersion = default(Guid);
                //some content items don&#39;t have a published version
                if (asDictionary.ContainsKey(&quot;publishedVersion&quot;) &amp;&amp; asDictionary[&quot;publishedVersion&quot;] != null)
                {
                    Guid.TryParse(d.publishedVersion.ToString(), out publishedVersion);
                }
                var newestVersion = default(Guid);
                if (asDictionary.ContainsKey(&quot;newestVersion&quot;) &amp;&amp; d.newestVersion != null)
                {
                    Guid.TryParse(d.newestVersion.ToString(), out newestVersion);
                }

                entity.IsPublished = publishedVersion != default(Guid) || (newestVersion != default(Guid) &amp;&amp; publishedVersion == newestVersion);
                entity.IsDraft = newestVersion != default(Guid) &amp;&amp; (publishedVersion == default(Guid) || publishedVersion != newestVersion);
                entity.HasPendingChanges = (publishedVersion != default(Guid) &amp;&amp; newestVersion != default(Guid)) &amp;&amp; publishedVersion != newestVersion;

                //Now we can assign the additional data!                        
                AddAdditionalData(entity, asDictionary);

                return entity;
            }
            finally
            {
                entity.EnableChangeTracking();
            }
        }
        
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,1],[17,13,17,88,1],[17,88,17,94,1],[17,94,17,106,1],[17,13,17,106,1],[20,13,20,20,1],[20,22,20,27,1],[20,28,20,30,1],[20,31,21,30,1],[21,30,21,153,1],[21,153,22,29,1],[22,29,22,76,1],[22,76,22,77,1],[20,31,22,77,1],[23,13,23,14,1],[24,17,24,83,1],[25,13,25,14,1],[26,9,26,10,1],[29,9,29,10,1],[30,13,30,63,1],[32,13,32,55,1],[35,13,35,14,1],[36,17,36,48,1],[38,17,38,50,1],[39,17,39,47,1],[40,17,40,34,1],[41,17,41,41,1],[42,17,42,40,1],[43,17,43,38,1],[44,17,44,60,1],[45,17,45,46,1],[46,17,46,38,1],[47,17,47,48,1],[48,17,48,53,1],[49,17,49,120,1],[50,17,50,117,1],[51,17,51,132,1],[53,17,53,54,1],[55,17,55,110,1],[56,17,56,18,1],[57,21,57,88,1],[58,17,58,18,1],[59,17,59,51,1],[60,17,60,90,1],[61,17,61,18,1],[62,21,62,82,1],[63,17,63,18,1],[65,17,65,145,1],[66,17,66,141,1],[67,17,67,151,1],[70,17,70,57,1],[72,17,72,31,1],[75,13,75,14,1],[76,17,76,47,1],[77,13,77,14,1],[78,9,78,10,1]]);
    </script>
  </body>
</html>