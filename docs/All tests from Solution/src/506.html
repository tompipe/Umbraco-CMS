<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\controls\Images\ImageViewerUpdater.asmx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Services;
using System.ComponentModel;
using System.Web.Script.Services;
using System.Web.UI;
using umbraco.controls.Images;
using System.IO;
using System.Web.Script.Serialization;
using umbraco.businesslogic.Utils;
using umbraco.presentation.webservices;

namespace umbraco.controls.Images
{
	/// &lt;summary&gt;
	/// An ajax service to return the html for an image based on a media id
	/// &lt;/summary&gt;
	[WebService(Namespace = &quot;http://tempuri.org/&quot;)]
	[WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
	[ToolboxItem(false)]
	[ScriptService]
	public class ImageViewerUpdater : System.Web.Services.WebService
	{

		/// &lt;summary&gt;
		/// return the a json object with the properties
        /// html = the html returned for rendering the image viewer
        /// mediaId = the media id loaded
        /// width = the width of the media (0) if not found
        /// height = the height of the media (0) if not found
        /// url = the url of the image
        /// alt = the alt text for the image
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		[WebMethod]
        public Dictionary&lt;string, string&gt; UpdateImage(int mediaId, string style, string linkTarget)
		{
            legacyAjaxCalls.Authorize();


			//load the control with the specified properties and render the output as a string and return it
			Page page = new Page();
			string path = Umbraco.Core.IO.IOHelper.ResolveUrl(Umbraco.Core.IO.SystemDirectories.Umbraco) + &quot;/controls/Images/ImageViewer.ascx&quot;;
			
			ImageViewer imageViewer = page.LoadControl(path) as ImageViewer;
			imageViewer.MediaId = mediaId;
            ImageViewer.Style _style = (ImageViewer.Style)Enum.Parse(typeof(ImageViewer.Style), style);
            imageViewer.ViewerStyle = _style;
			imageViewer.LinkTarget = linkTarget;

			//this adds only the anchor with image to be rendered, not the whole control!
			page.Controls.Add(imageViewer);
			
			imageViewer.DataBind();

			StringWriter sw = new StringWriter();
			HttpContext.Current.Server.Execute(page, sw, false);

            Dictionary&lt;string, string&gt; rVal = new Dictionary&lt;string, string&gt;();
            rVal.Add(&quot;html&quot;, sw.ToString());
            rVal.Add(&quot;mediaId&quot;, imageViewer.MediaId.ToString());
            rVal.Add(&quot;width&quot;, imageViewer.FileWidth.ToString());
            rVal.Add(&quot;height&quot;, imageViewer.FileHeight.ToString());
            rVal.Add(&quot;url&quot;, imageViewer.MediaItemPath);
            rVal.Add(&quot;alt&quot;, imageViewer.AltText);

            return rVal;
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[39,3,39,4,0],[40,13,40,41,0],[44,4,44,27,0],[45,4,45,135,0],[47,4,47,68,0],[48,4,48,34,0],[49,13,49,104,0],[50,13,50,46,0],[51,4,51,40,0],[54,4,54,35,0],[56,4,56,27,0],[58,4,58,41,0],[59,4,59,56,0],[61,13,61,80,0],[62,13,62,45,0],[63,13,63,65,0],[64,13,64,65,0],[65,13,65,67,0],[66,13,66,56,0],[67,13,67,50,0],[69,13,69,25,0],[70,3,70,4,0]]);
    </script>
  </body>
</html>