<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Models\Mapping\ContentModelMapper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using AutoMapper;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Mapping;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Trees;
using Umbraco.Web.Routing;
using umbraco.BusinessLogic.Actions;
using Umbraco.Core.PropertyEditors;

namespace Umbraco.Web.Models.Mapping
{
    /// &lt;summary&gt;
    /// Declares how model mappings for content
    /// &lt;/summary&gt;
    internal class ContentModelMapper : MapperConfiguration
    {
        public override void ConfigureMappings(IConfiguration config, ApplicationContext applicationContext)
        {

            //FROM IContent TO ContentItemDisplay
            config.CreateMap&lt;IContent, ContentItemDisplay&gt;()
                .ForMember(display =&gt; display.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IContent&gt;()))
                .ForMember(display =&gt; display.Updater, expression =&gt; expression.ResolveUsing(new CreatorResolver()))
                .ForMember(display =&gt; display.Icon, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Icon))
                .ForMember(display =&gt; display.ContentTypeAlias, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Alias))
                .ForMember(display =&gt; display.ContentTypeName, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Name))
                .ForMember(display =&gt; display.IsContainer, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.IsContainer))
                .ForMember(display =&gt; display.IsChildOfListView, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Trashed, expression =&gt; expression.MapFrom(content =&gt; content.Trashed))
                .ForMember(display =&gt; display.PublishDate, expression =&gt; expression.MapFrom(content =&gt; GetPublishedDate(content)))
                .ForMember(display =&gt; display.TemplateAlias, expression =&gt; expression.MapFrom(content =&gt; content.Template.Alias))
                .ForMember(display =&gt; display.HasPublishedVersion, expression =&gt; expression.MapFrom(content =&gt; content.HasPublishedVersion))
                .ForMember(display =&gt; display.Urls,
                    expression =&gt; expression.MapFrom(content =&gt;
                        UmbracoContext.Current == null
                            ? new[] {&quot;Cannot generate urls without a current Umbraco Context&quot;}
                            : content.GetContentUrls(UmbracoContext.Current)))
                .ForMember(display =&gt; display.Properties, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.AllowPreview, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.TreeNodeUrl, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Notifications, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Errors, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Alias, expression =&gt; expression.Ignore())
                .ForMember(display =&gt; display.Tabs, expression =&gt; expression.ResolveUsing(new TabsAndPropertiesResolver(applicationContext.Services.TextService)))
                .ForMember(display =&gt; display.AllowedActions, expression =&gt; expression.ResolveUsing(
                    new ActionButtonsResolver(new Lazy&lt;IUserService&gt;(() =&gt; applicationContext.Services.UserService))))
                .AfterMap((content, display) =&gt; AfterMap(content, display, applicationContext.Services.DataTypeService, applicationContext.Services.TextService,
                    applicationContext.Services.ContentTypeService));

            //FROM IContent TO ContentItemBasic&lt;ContentPropertyBasic, IContent&gt;
            config.CreateMap&lt;IContent, ContentItemBasic&lt;ContentPropertyBasic, IContent&gt;&gt;()
                .ForMember(dto =&gt; dto.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IContent&gt;()))
                .ForMember(dto =&gt; dto.Updater, expression =&gt; expression.ResolveUsing(new CreatorResolver()))
                .ForMember(dto =&gt; dto.Icon, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Icon))
                .ForMember(dto =&gt; dto.Trashed, expression =&gt; expression.MapFrom(content =&gt; content.Trashed))
                .ForMember(dto =&gt; dto.HasPublishedVersion, expression =&gt; expression.MapFrom(content =&gt; content.HasPublishedVersion))
                .ForMember(dto =&gt; dto.ContentTypeAlias, expression =&gt; expression.MapFrom(content =&gt; content.ContentType.Alias))
                .ForMember(dto =&gt; dto.Alias, expression =&gt; expression.Ignore());

            //FROM IContent TO ContentItemDto&lt;IContent&gt;
            config.CreateMap&lt;IContent, ContentItemDto&lt;IContent&gt;&gt;()
                .ForMember(dto =&gt; dto.Owner, expression =&gt; expression.ResolveUsing(new OwnerResolver&lt;IContent&gt;()))
                .ForMember(dto =&gt; dto.HasPublishedVersion, expression =&gt; expression.MapFrom(content =&gt; content.HasPublishedVersion))
                .ForMember(dto =&gt; dto.Updater, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Icon, expression =&gt; expression.Ignore())
                .ForMember(dto =&gt; dto.Alias, expression =&gt; expression.Ignore());
        }

        private static DateTime? GetPublishedDate(IContent content)
        {
            var date = ((Content) content).PublishedDate;
            return date == default (DateTime) ? (DateTime?) null : date;
        }

        /// &lt;summary&gt;
        /// Maps the generic tab with custom properties for content
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;content&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;display&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;localizedText&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;contentTypeService&quot;&gt;&lt;/param&gt;
        private static void AfterMap(IContent content, ContentItemDisplay display, IDataTypeService dataTypeService,
            ILocalizedTextService localizedText, IContentTypeService contentTypeService)
        {
            // map the IsChildOfListView (this is actually if it is a descendant of a list view!)
            var parent = content.Parent();
            display.IsChildOfListView = parent != null &amp;&amp; (parent.ContentType.IsContainer || contentTypeService.HasContainerInPath(parent.Path));

            //map the tree node url
            if (HttpContext.Current != null)
            {
                var urlHelper = new UrlHelper(new RequestContext(new HttpContextWrapper(HttpContext.Current), new RouteData()));
                var url = urlHelper.GetUmbracoApiService&lt;ContentTreeController&gt;(controller =&gt; controller.GetTreeNode(display.Id.ToString(), null));
                display.TreeNodeUrl = url;
            }

            //fill in the template config to be passed to the template drop down.
            var templateItemConfig = new Dictionary&lt;string, string&gt; {{&quot;&quot;, &quot;Choose...&quot;}};
            foreach (var t in content.ContentType.AllowedTemplates
                .Where(t =&gt; t.Alias.IsNullOrWhiteSpace() == false &amp;&amp; t.Name.IsNullOrWhiteSpace() == false))
            {
                templateItemConfig.Add(t.Alias, t.Name);
            }

            if (content.ContentType.IsContainer)
            {
                TabsAndPropertiesResolver.AddListView(display, &quot;content&quot;, dataTypeService, localizedText);
            }

            var properties = new List&lt;ContentPropertyDisplay&gt;
            {
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}doctype&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;content/documentType&quot;),
                    Value = localizedText.UmbracoDictionaryTranslate(display.ContentTypeName),
                    View = PropertyEditorResolver.Current.GetByAlias(Constants.PropertyEditors.NoEditAlias).ValueEditor.View
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}releasedate&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;content/releaseDate&quot;),
                    Value = display.ReleaseDate.HasValue ? display.ReleaseDate.Value.ToIsoString() : null,
                    //Not editible for people without publish permission (U4-287)
                    View = display.AllowedActions.Contains(ActionPublish.Instance.Letter) ? &quot;datepicker&quot; : PropertyEditorResolver.Current.GetByAlias(Constants.PropertyEditors.NoEditAlias).ValueEditor.View,
                    Config = new Dictionary&lt;string, object&gt;
                    {
                        {&quot;offsetTime&quot;, &quot;1&quot;}
                    }
                    //TODO: Fix up hard coded datepicker
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}expiredate&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;content/unpublishDate&quot;),
                    Value = display.ExpireDate.HasValue ? display.ExpireDate.Value.ToIsoString() : null,
                    //Not editible for people without publish permission (U4-287)
                    View = display.AllowedActions.Contains(ActionPublish.Instance.Letter) ? &quot;datepicker&quot; : PropertyEditorResolver.Current.GetByAlias(Constants.PropertyEditors.NoEditAlias).ValueEditor.View,
                    Config = new Dictionary&lt;string, object&gt;
                    {
                        {&quot;offsetTime&quot;, &quot;1&quot;}
                    }
                    //TODO: Fix up hard coded datepicker
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}template&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;template/template&quot;),
                    Value = display.TemplateAlias,
                    View = &quot;dropdown&quot;, //TODO: Hard coding until we make a real dropdown property editor to lookup
                    Config = new Dictionary&lt;string, object&gt;
                    {
                        {&quot;items&quot;, templateItemConfig}
                    }
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}urls&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedText.Localize(&quot;content/urls&quot;),
                    Value = string.Join(&quot;,&quot;, display.Urls),
                    View = &quot;urllist&quot; //TODO: Hard coding this because the templatepicker doesn&#39;t necessarily need to be a resolvable (real) property editor
                }
            };

            TabsAndPropertiesResolver.MapGenericProperties(content, display, localizedText, properties.ToArray(),
                genericProperties =&gt;
                {
                    //TODO: This would be much nicer with the IUmbracoContextAccessor so we don&#39;t use singletons
                    //If this is a web request and there&#39;s a user signed in and the 
                    // user has access to the settings section, we will 
                    if (HttpContext.Current != null &amp;&amp; UmbracoContext.Current != null &amp;&amp; UmbracoContext.Current.Security.CurrentUser != null
                        &amp;&amp; UmbracoContext.Current.Security.CurrentUser.AllowedSections.Any(x =&gt; x.Equals(Constants.Applications.Settings)))
                    {
                        var currentDocumentType = contentTypeService.GetContentType(display.ContentTypeAlias);
                        var currentDocumentTypeName = currentDocumentType == null ? string.Empty : localizedText.UmbracoDictionaryTranslate(currentDocumentType.Name);

                        var currentDocumentTypeId = currentDocumentType == null ? string.Empty : currentDocumentType.Id.ToString(CultureInfo.InvariantCulture);
                        //TODO: Hard coding this is not good
                        var docTypeLink = string.Format(&quot;#/settings/documenttypes/edit/{0}&quot;, currentDocumentTypeId);

                        //Replace the doc type property
                        var docTypeProperty = genericProperties.First(x =&gt; x.Alias == string.Format(&quot;{0}doctype&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix));
                        docTypeProperty.Value = new List&lt;object&gt;
                        {
                            new
                            {
                                linkText = currentDocumentTypeName,
                                url = docTypeLink,
                                target = &quot;_self&quot;,
                                icon = &quot;icon-item-arrangement&quot;
                            }
                        };
                        //TODO: Hard coding this because the templatepicker doesn&#39;t necessarily need to be a resolvable (real) property editor
                        docTypeProperty.View = &quot;urllist&quot;;
                    }
                });
        }

        /// &lt;summary&gt;
                //TODO: This is horribly inneficient
        /// Creates the list of action buttons allowed for this user - Publish, Send to publish, save, unpublish returned as the button&#39;s &#39;letter&#39;
        /// &lt;/summary&gt;
        private class ActionButtonsResolver : ValueResolver&lt;IContent, IEnumerable&lt;char&gt;&gt;
        {
            private readonly Lazy&lt;IUserService&gt; _userService;

            public ActionButtonsResolver(Lazy&lt;IUserService&gt; userService)
            {
                _userService = userService;
            }

            protected override IEnumerable&lt;char&gt; ResolveCore(IContent source)
            {
                if (UmbracoContext.Current == null)
                {
                    //cannot check permissions without a context
                    return Enumerable.Empty&lt;char&gt;();
                }
                var svc = _userService.Value;

                var permissions = svc.GetPermissions(
                        //TODO: This is certainly not ideal usage here - perhaps the best way to deal with this in the future is
                        // with the IUmbracoContextAccessor. In the meantime, if used outside of a web app this will throw a null
                        // refrence exception :(
                        UmbracoContext.Current.Security.CurrentUser,
                        // Here we need to do a special check since this could be new content, in which case we need to get the permissions
                        // from the parent, not the existing one otherwise permissions would be coming from the root since Id is 0.
                        source.HasIdentity ? source.Id : source.ParentId)
                    .FirstOrDefault();

                return permissions == null
                    ? Enumerable.Empty&lt;char&gt;()
                    : permissions.AssignedPermissions.Where(x =&gt; x.Length == 1).Select(x =&gt; x.ToUpperInvariant()[0]);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,1],[30,13,31,68,1],[31,68,31,122,1],[31,122,32,70,1],[32,70,32,116,1],[32,116,33,67,1],[33,67,33,122,1],[33,122,34,79,1],[34,79,34,135,1],[34,135,35,78,1],[35,78,35,133,1],[35,133,36,74,1],[36,74,36,136,1],[36,136,37,80,1],[37,80,37,99,1],[37,99,38,70,1],[38,70,38,116,1],[38,116,39,74,1],[39,74,39,130,1],[39,130,40,76,1],[40,76,40,129,1],[40,129,41,82,1],[41,82,41,140,1],[41,140,43,35,1],[43,35,46,78,1],[46,78,47,73,1],[47,73,47,92,1],[47,92,48,75,1],[48,75,48,94,1],[48,94,49,74,1],[49,74,49,93,1],[49,93,50,76,1],[50,76,50,95,1],[50,95,51,69,1],[51,69,51,88,1],[51,88,52,68,1],[52,68,52,87,1],[52,87,53,67,1],[53,67,53,162,1],[53,162,54,77,1],[54,77,55,76,1],[55,76,55,115,0],[55,115,55,118,1],[54,77,55,118,1],[55,118,56,49,1],[56,49,57,68,1],[57,68,57,70,1],[30,13,57,70,1],[60,13,61,60,1],[61,60,61,114,1],[61,114,62,62,1],[62,62,62,108,1],[62,108,63,59,1],[63,59,63,114,1],[63,114,64,62,1],[64,62,64,108,1],[64,108,65,74,1],[65,74,65,132,1],[65,132,66,71,1],[66,71,66,127,1],[66,127,67,60,1],[67,60,67,79,1],[67,79,67,81,1],[60,13,67,81,1],[70,13,71,60,1],[71,60,71,114,1],[71,114,72,74,1],[72,74,72,132,1],[72,132,73,62,1],[73,62,73,81,1],[73,81,74,59,1],[74,59,74,78,1],[74,78,75,60,1],[75,60,75,79,1],[75,79,75,81,1],[70,13,75,81,1],[76,9,76,10,1],[79,9,79,10,1],[80,13,80,58,1],[81,13,81,73,1],[82,9,82,10,1],[94,9,94,10,1],[96,13,96,43,1],[97,13,97,146,1],[100,13,100,45,1],[101,13,101,14,0],[102,17,102,129,0],[103,17,103,148,0],[104,17,104,43,0],[105,13,105,14,0],[108,13,108,89,1],[109,13,109,20,1],[109,22,109,27,0],[109,28,109,30,1],[109,31,110,29,1],[110,29,110,106,0],[110,106,110,107,1],[109,31,110,107,1],[111,13,111,14,0],[112,17,112,57,0],[113,13,113,14,0],[115,13,115,49,1],[116,13,116,14,0],[117,17,117,107,0],[118,13,118,14,0],[120,13,173,15,1],[175,13,177,17,1],[177,17,177,18,1],[177,18,181,21,1],[181,21,182,97,1],[182,97,182,138,0],[182,138,182,140,1],[181,21,182,140,1],[182,140,183,21,1],[183,21,183,22,0],[183,22,184,25,1],[184,25,184,111,0],[184,111,185,25,1],[185,25,185,167,0],[185,167,187,25,1],[187,25,187,160,0],[187,160,189,25,1],[189,25,189,117,0],[189,117,192,25,1],[192,25,192,76,0],[192,76,192,173,0],[192,173,192,175,0],[192,25,192,175,0],[192,175,193,25,1],[193,25,202,27,0],[202,27,204,25,1],[204,25,204,58,0],[204,58,205,21,1],[205,21,205,22,0],[205,22,206,17,1],[206,17,206,18,1],[206,18,206,20,1],[175,13,206,20,1],[207,9,207,10,1],[217,13,217,73,1],[218,13,218,14,1],[219,17,219,44,1],[220,13,220,14,1],[223,13,223,14,1],[224,17,224,52,1],[225,17,225,18,1],[227,21,227,53,1],[229,17,229,46,0],[231,17,239,39,0],[241,17,243,66,0],[243,66,243,79,0],[243,79,243,93,0],[243,93,243,116,0],[243,116,243,118,0],[241,17,243,118,0],[244,13,244,14,1]]);
    </script>
  </body>
</html>