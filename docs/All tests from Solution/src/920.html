<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Security\Identity\AuthenticationManagerExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.Owin;
using Microsoft.Owin.Security;

namespace Umbraco.Web.Security.Identity
{
    public static class AuthenticationManagerExtensions
    {
        private static ExternalLoginInfo GetExternalLoginInfo(AuthenticateResult result)
        {
            if (result == null || result.Identity == null)
            {
                return null;
            }
            var idClaim = result.Identity.FindFirst(ClaimTypes.NameIdentifier);
            if (idClaim == null)
            {
                return null;
            }
            // By default we don&#39;t allow spaces in user names
            var name = result.Identity.Name;
            if (name != null)
            {
                name = name.Replace(&quot; &quot;, &quot;&quot;);
            }
            var email = result.Identity.FindFirstValue(ClaimTypes.Email);
            return new ExternalLoginInfo
            {
                ExternalIdentity = result.Identity,
                Login = new UserLoginInfo(idClaim.Issuer, idClaim.Value),
                DefaultUserName = name,
                Email = email
            };
        }

        /// &lt;summary&gt;
        ///     Extracts login info out of an external identity
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;manager&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;authenticationType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;xsrfKey&quot;&gt;key that will be used to find the userId to verify&lt;/param&gt;
        /// &lt;param name=&quot;expectedValue&quot;&gt;
        ///     the value expected to be found using the xsrfKey in the AuthenticationResult.Properties
        ///     dictionary
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static async Task&lt;ExternalLoginInfo&gt; GetExternalLoginInfoAsync(this IAuthenticationManager manager,
            string authenticationType,
            string xsrfKey, string expectedValue)
        {
            if (manager == null)
            {
                throw new ArgumentNullException(&quot;manager&quot;);
            }
            var result = await manager.AuthenticateAsync(authenticationType);
            // Verify that the userId is the same as what we expect if requested
            if (result != null &amp;&amp;
                result.Properties != null &amp;&amp;
                result.Properties.Dictionary != null &amp;&amp;
                result.Properties.Dictionary.ContainsKey(xsrfKey) &amp;&amp;
                result.Properties.Dictionary[xsrfKey] == expectedValue)
            {
                return GetExternalLoginInfo(result);
            }
            return null;
        }

        /// &lt;summary&gt;
        ///     Extracts login info out of an external identity
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;manager&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;authenticationType&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static async Task&lt;ExternalLoginInfo&gt; GetExternalLoginInfoAsync(this IAuthenticationManager manager, string authenticationType)
        {
            if (manager == null)
            {
                throw new ArgumentNullException(&quot;manager&quot;);
            }
            return GetExternalLoginInfo(await manager.AuthenticateAsync(authenticationType));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,10,0],[14,13,14,59,0],[15,13,15,14,0],[16,17,16,29,0],[18,13,18,80,0],[19,13,19,33,0],[20,13,20,14,0],[21,17,21,29,0],[24,13,24,45,0],[25,13,25,30,0],[26,13,26,14,0],[27,17,27,46,0],[28,13,28,14,0],[29,13,29,74,0],[30,13,36,15,0],[37,9,37,10,0],[53,9,53,10,0],[54,13,54,33,0],[55,13,55,14,0],[56,17,56,60,0],[58,13,58,78,0],[60,13,64,72,0],[65,13,65,14,0],[66,17,66,53,0],[68,13,68,25,0],[69,9,69,10,0],[78,9,78,10,0],[79,13,79,33,0],[80,13,80,14,0],[81,17,81,60,0],[83,13,83,94,0],[84,9,84,10,0]]);
    </script>
  </body>
</html>