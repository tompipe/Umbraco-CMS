<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\developer\Packages\LoadNitros.ascx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.IO;
using System;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Collections;
using System.Web.UI;
using System.Web.UI.WebControls.WebParts;
using System.Collections.Generic;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using umbraco.BusinessLogic;

namespace umbraco.presentation.developer.packages {
    public partial class LoadNitros : System.Web.UI.UserControl {

        private List&lt;CheckBox&gt; _nitroList = new List&lt;CheckBox&gt;();
        private List&lt;string&gt; _selectedNitros = new List&lt;string&gt;();

        protected void Page_Load(object sender, EventArgs e) { }

        public void installNitros(object sender, EventArgs e) {

            string repoGuid = &quot;65194810-1f85-11dd-bd0b-0800200c9a66&quot;; //Hardcoded official package repo key.

            var p = new cms.businesslogic.packager.Installer(Umbraco.Web.UmbracoContext.Current.Security.CurrentUser.Id);
            var repo = cms.businesslogic.packager.repositories.Repository.getByGuid(repoGuid);

            if (repo == null)
            {
                throw new InvalidOperationException(&quot;Could not find repository with id &quot; + repoGuid);
            }

            foreach (CheckBox cb in _nitroList) {
                if (cb.Checked) {
                    if (!_selectedNitros.Contains(cb.ID))
                        _selectedNitros.Add(cb.ID);
                }
            }

            foreach (string guid in _selectedNitros) {

                string tempFile = p.Import(repo.fetch(guid));
                p.LoadConfig(tempFile);

                int pId = p.CreateManifest(tempFile, guid, repoGuid);

                //and then copy over the files. This will take some time if it contains .dlls that will reboot the system..
                p.InstallFiles(pId, tempFile);

                //finally install the businesslogic
                p.InstallBusinessLogic(pId, tempFile);

                //cleanup.. 
                p.InstallCleanUp(pId, tempFile);

            }

            ApplicationContext.Current.ApplicationCache.RuntimeCache.ClearAllCache();
            ApplicationContext.Current.ApplicationCache.IsolatedRuntimeCache.ClearAllCaches();
            library.RefreshContent();

            loadNitros.Visible = false;

            RaiseBubbleEvent(new object(), new EventArgs());
        }

        protected void onCategoryDataBound(object sender, RepeaterItemEventArgs e) {

            if (e.Item.ItemType == ListItemType.AlternatingItem || e.Item.ItemType == ListItemType.Item) {

                cms.businesslogic.packager.repositories.Category cat = (cms.businesslogic.packager.repositories.Category)e.Item.DataItem;
                Literal _name = (Literal)e.Item.FindControl(&quot;lit_name&quot;);
                Literal _desc = (Literal)e.Item.FindControl(&quot;lit_desc&quot;);
                PlaceHolder _nitros = (PlaceHolder)e.Item.FindControl(&quot;ph_nitroHolder&quot;);

                _name.Text = cat.Text;
                _desc.Text = cat.Description;

                e.Item.Visible = false;

                foreach (cms.businesslogic.packager.repositories.Package nitro in cat.Packages) {
                    bool installed = cms.businesslogic.packager.InstalledPackage.isPackageInstalled(nitro.RepoGuid.ToString());
                    int localPackageID = 0;

                    if (installed)
                        localPackageID = cms.businesslogic.packager.InstalledPackage.GetByGuid(nitro.RepoGuid.ToString()).Data.Id;

                    CheckBox cb_nitro = new CheckBox();
                    cb_nitro.ID = nitro.RepoGuid.ToString();
                    cb_nitro.Enabled = !installed;

                    cb_nitro.CssClass = &quot;nitroCB&quot;;                   

                    cb_nitro.Text = &quot;&lt;div class=&#39;nitro&#39;&gt;&lt;h3&gt;&quot; + nitro.Text;

                    if (installed) {
                        cb_nitro.CssClass = &quot;nitroCB installed&quot;;
                        cb_nitro.Text += &quot;&lt;span&gt;&lt;a href=&#39;#&#39; onclick=\&quot;openDemoModal(&#39;&quot; + nitro.RepoGuid.ToString() + &quot;&#39;,&#39;&quot; + nitro.Text + &quot;&#39;); return false;\&quot;&gt;Already installed&lt;/a&gt;&lt;/span&gt;&quot;;
                    }
                    
                    cb_nitro.Text += &quot;&lt;/h3&gt;&lt;small&gt;&quot; + nitro.Description + &quot;&lt;br/&gt;&quot;;

                    if (!string.IsNullOrEmpty(nitro.Demo)) {
                        cb_nitro.Text += &quot;&lt;a href=&#39;#&#39; onclick=\&quot;openDemoModal(&#39;&quot; + nitro.RepoGuid.ToString() + &quot;&#39;,&#39;&quot; + nitro.Text + &quot;&#39;); return false;\&quot;&gt;Demonstration&lt;/a&gt; &amp;nbsp;&quot;;
                    }

                    if (!string.IsNullOrEmpty(nitro.Documentation)) {
                        cb_nitro.Text += &quot;&lt;a href=&#39;&quot; + nitro.Documentation + &quot;&#39; target=&#39;_blank&#39;&gt;Documentation&lt;/a&gt; &amp;nbsp;&quot;;
                    }

                    cb_nitro.Text += &quot;&lt;/small&gt;&lt;/div&gt;&lt;br style=&#39;clear: both&#39;/&gt;&quot;;

                    _nitros.Controls.Add(cb_nitro);
                    _nitroList.Add(cb_nitro);

                    e.Item.Visible = true;

                    if (nitro.EditorsPick) {

                        CheckBox cb_Recnitro = new CheckBox();
                        cb_Recnitro.ID = nitro.RepoGuid.ToString();
                        cb_Recnitro.CssClass = &quot;nitroCB&quot;;
                        cb_Recnitro.Enabled = !installed;

                        cb_Recnitro.Text = &quot;&lt;div class=&#39;nitro&#39;&gt;&lt;h3&gt;&quot; + nitro.Text;

                        if (installed) {
                            cb_Recnitro.CssClass = &quot;nitroCB installed&quot;;
                            cb_Recnitro.Text += &quot;&lt;span&gt;&lt;a href=&#39;&#39; onclick=\&quot;openDemoModal(&#39;&quot; + nitro.RepoGuid.ToString() + &quot;&#39;,&#39;&quot; + nitro.Text + &quot;&#39;); return false;\&quot;&gt;Already installed&lt;/a&gt;&lt;/span&gt;&quot;;
                        }

                        cb_Recnitro.Text += &quot;&lt;/h3&gt;&lt;small&gt;&quot; + nitro.Description + &quot;&lt;br/&gt;&quot;;

                        if (!string.IsNullOrEmpty(nitro.Demo)) {
                            cb_Recnitro.Text += &quot;&lt;a href=&#39;#&#39; onclick=\&quot;openDemoModal(&#39;&quot; + nitro.RepoGuid.ToString() + &quot;&#39;,&#39;&quot; + nitro.Text + &quot;&#39;); return false;\&quot;&gt;Demonstration&lt;/a&gt; &amp;nbsp;&quot;;
                        }

                        if (!string.IsNullOrEmpty(nitro.Documentation)) {
                            cb_Recnitro.Text += &quot;&lt;a href=&#39;&quot; + nitro.Documentation + &quot;&#39; target=&#39;_blank&#39;&gt;Documentation&lt;/a&gt; &amp;nbsp;&quot;;
                        }

                        cb_Recnitro.Text += &quot;&lt;/small&gt;&lt;/div&gt;&lt;br style=&#39;clear: both&#39;/&gt;&quot;;


                        _nitroList.Add(cb_Recnitro);
                        ph_recommendedHolder.Controls.Add(cb_Recnitro);

                    }
                }

            }
        }


        protected override void OnInit(EventArgs e) {

            base.OnInit(e);

            string repoGuid = &quot;65194810-1f85-11dd-bd0b-0800200c9a66&quot;;
            var repo = cms.businesslogic.packager.repositories.Repository.getByGuid(repoGuid);

            if (repo == null)
            {
                throw new InvalidOperationException(&quot;Could not find repository with id &quot; + repoGuid);
            }

            var fb = new global::umbraco.uicontrols.Feedback();
            fb.type = global::umbraco.uicontrols.Feedback.feedbacktype.error;
            fb.Text = &quot;&lt;strong&gt;No connection to repository.&lt;/strong&gt; Modules could not be fetched from the repository as there was no connection to: &#39;&quot; + repo.RepositoryUrl + &quot;&#39;&quot;;


			if (repo.HasConnection())
			{
				try
				{

					if (UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema)
						rep_nitros.DataSource = repo.Webservice.NitrosCategorizedByVersion(cms.businesslogic.packager.repositories.Version.Version4);
					else
						rep_nitros.DataSource = repo.Webservice.NitrosCategorizedByVersion(cms.businesslogic.packager.repositories.Version.Version41);

					rep_nitros.DataBind();
				}
				catch (Exception ex)
				{
					LogHelper.Error&lt;LoadNitros&gt;(&quot;An error occurred&quot;, ex);

					loadNitros.Controls.Clear();
					loadNitros.Controls.Add(fb);
					//nitroList.Visible = false;
					//lt_status.Text = &quot;&lt;div class=&#39;error&#39;&gt;&lt;p&gt;Nitros could not be fetched from the repository. Please check your internet connection&lt;/p&gt;&lt;p&gt;You can always install Nitros later in the packages section&lt;/p&gt;&lt;p&gt;&quot; + ex.ToString() + &quot;&lt;/p&gt;&lt;/div&gt;&quot;;
				}
			}
			else
			{
				loadNitros.Controls.Clear();
				loadNitros.Controls.Add(fb);
			}
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,66,0],[21,9,21,67,0],[23,62,23,63,0],[23,64,23,65,0],[25,63,25,64,0],[27,13,27,70,0],[29,13,29,122,0],[30,13,30,95,0],[32,13,32,30,0],[33,13,33,14,0],[34,17,34,102,0],[37,13,37,20,0],[37,22,37,33,0],[37,34,37,36,0],[37,37,37,47,0],[37,49,37,50,0],[38,17,38,32,0],[38,33,38,34,0],[39,21,39,58,0],[40,25,40,52,0],[41,17,41,18,0],[42,13,42,14,0],[44,13,44,20,0],[44,22,44,33,0],[44,34,44,36,0],[44,37,44,52,0],[44,54,44,55,0],[46,17,46,62,0],[47,17,47,40,0],[49,17,49,70,0],[52,17,52,47,0],[55,17,55,55,0],[58,17,58,49,0],[60,13,60,14,0],[62,13,62,86,0],[63,13,63,95,0],[64,13,64,38,0],[66,13,66,40,0],[68,13,68,61,0],[69,9,69,10,0],[71,84,71,85,0],[73,13,73,105,0],[73,106,73,107,0],[75,17,75,138,0],[76,17,76,73,0],[77,17,77,73,0],[78,17,78,89,0],[80,17,80,39,0],[81,17,81,46,0],[83,17,83,40,0],[85,17,85,24,0],[85,26,85,79,0],[85,80,85,82,0],[85,83,85,95,0],[85,97,85,98,0],[86,21,86,128,0],[87,21,87,44,0],[89,21,89,35,0],[90,25,90,131,0],[92,21,92,56,0],[93,21,93,61,0],[94,21,94,51,0],[96,21,96,51,0],[98,21,98,76,0],[100,21,100,35,0],[100,36,100,37,0],[101,25,101,65,0],[102,25,102,190,0],[103,21,103,22,0],[105,21,105,83,0],[107,21,107,59,0],[107,60,107,61,0],[108,25,108,180,0],[109,21,109,22,0],[111,21,111,68,0],[111,69,111,70,0],[112,25,112,123,0],[113,21,113,22,0],[115,21,115,80,0],[117,21,117,52,0],[118,21,118,46,0],[120,21,120,43,0],[122,21,122,43,0],[122,44,122,45,0],[124,25,124,63,0],[125,25,125,68,0],[126,25,126,58,0],[127,25,127,58,0],[129,25,129,83,0],[131,25,131,39,0],[131,40,131,41,0],[132,29,132,72,0],[133,29,133,196,0],[134,25,134,26,0],[136,25,136,90,0],[138,25,138,63,0],[138,64,138,65,0],[139,29,139,187,0],[140,25,140,26,0],[142,25,142,72,0],[142,73,142,74,0],[143,29,143,130,0],[144,25,144,26,0],[146,25,146,87,0],[149,25,149,53,0],[150,25,150,72,0],[152,21,152,22,0],[153,17,153,18,0],[155,13,155,14,0],[156,9,156,10,0],[159,53,159,54,0],[161,13,161,28,0],[163,13,163,70,0],[164,13,164,95,0],[166,13,166,30,0],[167,13,167,14,0],[168,17,168,102,0],[171,13,171,64,0],[172,13,172,78,0],[173,13,173,180,0],[176,4,176,29,0],[177,4,177,5,0],[179,5,179,6,0],[181,6,181,73,0],[182,7,182,132,0],[184,7,184,133,0],[186,6,186,28,0],[187,5,187,6,0],[188,5,188,25,0],[189,5,189,6,0],[190,6,190,59,0],[192,6,192,34,0],[193,6,193,34,0],[196,5,196,6,0],[197,4,197,5,0],[199,4,199,5,0],[200,5,200,33,0],[201,5,201,33,0],[202,4,202,5,0],[203,9,203,10,0]]);
    </script>
  </body>
</html>