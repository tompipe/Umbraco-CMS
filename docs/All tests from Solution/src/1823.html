<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSixTwoZero\UpdateToNewMemberPropertyAliases.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSixTwoZero
{
    [Migration(&quot;7.1.0&quot;, 4, GlobalSettings.UmbracoMigrationName)]
    [Migration(&quot;6.2.0&quot;, 4, GlobalSettings.UmbracoMigrationName)]
    public class UpdateToNewMemberPropertyAliases : MigrationBase
    {
        public UpdateToNewMemberPropertyAliases(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {
            Execute.Code(Update);
        }

        internal string Update(Database database)
        {
            if (database != null)
            {
                var aliasMap = new Dictionary&lt;string, string&gt;
                {
                    {&quot;umbracoPasswordRetrievalQuestionPropertyTypeAlias&quot;, Constants.Conventions.Member.PasswordQuestion},
                    {&quot;umbracoPasswordRetrievalAnswerPropertyTypeAlias&quot;,   Constants.Conventions.Member.PasswordAnswer},
                    {&quot;umbracoCommentPropertyTypeAlias&quot;,                   Constants.Conventions.Member.Comments},
                    {&quot;umbracoApprovePropertyTypeAlias&quot;,                   Constants.Conventions.Member.IsApproved},
                    {&quot;umbracoLockPropertyTypeAlias&quot;,                      Constants.Conventions.Member.IsLockedOut},
                    {&quot;umbracoLastLoginPropertyTypeAlias&quot;,                 Constants.Conventions.Member.LastLoginDate},
                    {&quot;umbracoMemberLastPasswordChange&quot;,                   Constants.Conventions.Member.LastPasswordChangeDate},
                    {&quot;umbracoMemberLastLockout&quot;,                          Constants.Conventions.Member.LastLockoutDate},
                    {&quot;umbracoFailedPasswordAttemptsPropertyTypeAlias&quot;,    Constants.Conventions.Member.FailedPasswordAttempts}
                };


                //This query is structured to work with MySql, SQLCE and SqlServer:
                // http://issues.umbraco.org/issue/U4-3876

                const string propertyTypeUpdateSql = @&quot;UPDATE cmsPropertyType
SET Alias = @newAlias
WHERE Alias = @oldAlias AND contentTypeId IN (
SELECT nodeId FROM (SELECT DISTINCT cmsContentType.nodeId FROM cmsPropertyType
INNER JOIN cmsContentType ON cmsPropertyType.contentTypeId = cmsContentType.nodeId
INNER JOIN umbracoNode ON cmsContentType.nodeId = umbracoNode.id
WHERE umbracoNode.nodeObjectType = @objectType) x)&quot;;

                const string xmlSelectSql = @&quot;SELECT cmsContentXml.* FROM cmsContentXml 
INNER JOIN umbracoNode ON cmsContentXml.nodeId = umbracoNode.id
WHERE umbracoNode.nodeObjectType = @objectType&quot;;

                using (var trans = database.GetTransaction())
                {
                    try
                    {

                        //Upate all of the property type aliases
                        foreach (var map in aliasMap)
                        {
                            database.Execute(propertyTypeUpdateSql, new { newAlias = map.Value, oldAlias = map.Key, objectType = Constants.ObjectTypes.MemberType });
                        }

                        //Update all of the XML
                        var items = database.Fetch&lt;ContentXmlDto&gt;(xmlSelectSql, new { objectType = Constants.ObjectTypes.Member });
                        foreach (var item in items)
                        {
                            foreach (var map in aliasMap)
                            {
                                item.Xml = item.Xml.Replace(&quot;&lt;&quot; + map.Key + &quot;&gt;&quot;, &quot;&lt;&quot; + map.Value + &quot;&gt;&quot;);
                                item.Xml = item.Xml.Replace(&quot;&lt;/&quot; + map.Key + &quot;&gt;&quot;, &quot;&lt;/&quot; + map.Value + &quot;&gt;&quot;);
                            }
                            database.Update(item);
                        }

                        trans.Complete();
                    }
                    catch (Exception ex)
                    {
                        Logger.Error&lt;UpdateToNewMemberPropertyAliases&gt;(&quot;Exception was thrown when trying to upgrade old member aliases to the new ones&quot;, ex);
                        throw;
                    }
                }


            }
            return string.Empty;
        }

        public override void Down()
        {
            throw new NotImplementedException();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[14,97,14,120,0],[15,9,15,10,0],[16,9,16,10,0],[19,9,19,10,0],[20,13,20,34,0],[21,9,21,10,0],[24,9,24,10,0],[25,13,25,34,0],[26,13,26,14,0],[27,17,38,19,0],[56,24,56,61,0],[57,17,57,18,0],[59,21,59,22,0],[62,25,62,32,0],[62,34,62,41,0],[62,42,62,44,0],[62,45,62,53,0],[63,25,63,26,0],[64,29,64,166,0],[65,25,65,26,0],[68,25,68,132,0],[69,25,69,32,0],[69,34,69,42,0],[69,43,69,45,0],[69,46,69,51,0],[70,25,70,26,0],[71,29,71,36,0],[71,38,71,45,0],[71,46,71,48,0],[71,49,71,57,0],[72,29,72,30,0],[73,33,73,105,0],[74,33,74,107,0],[75,29,75,30,0],[76,29,76,51,0],[77,25,77,26,0],[79,25,79,42,0],[80,21,80,22,0],[81,21,81,41,0],[82,21,82,22,0],[83,25,83,158,0],[84,25,84,31,0],[86,17,86,18,0],[89,13,89,14,0],[90,13,90,33,0],[91,9,91,10,0],[94,9,94,10,0],[95,13,95,49,0]]);
    </script>
  </body>
</html>