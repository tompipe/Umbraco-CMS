<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\Content.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization;

namespace Umbraco.Core.Models
{
    /// &lt;summary&gt;
    /// Represents a Content object
    /// &lt;/summary&gt;
    [Serializable]
    [DataContract(IsReference = true)]
    public class Content : ContentBase, IContent
    {
        private IContentType _contentType;
        private ITemplate _template;
        private bool _published;
        private string _language;
        private DateTime? _releaseDate;
        private DateTime? _expireDate;
        private int _writer;
        private string _nodeName;//NOTE Once localization is introduced this will be the non-localized Node Name.
        private bool _permissionsChanged;
        /// &lt;summary&gt;
        /// Constructor for creating a Content object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;Name of the content&lt;/param&gt;
        /// &lt;param name=&quot;parent&quot;&gt;Parent &lt;see cref=&quot;IContent&quot;/&gt; object&lt;/param&gt;
        /// &lt;param name=&quot;contentType&quot;&gt;ContentType for the current Content object&lt;/param&gt;
        public Content(string name, IContent parent, IContentType contentType)
			: this(name, parent, contentType, new PropertyCollection())
		{			
		}

        /// &lt;summary&gt;
        /// Constructor for creating a Content object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;Name of the content&lt;/param&gt;
        /// &lt;param name=&quot;parent&quot;&gt;Parent &lt;see cref=&quot;IContent&quot;/&gt; object&lt;/param&gt;
        /// &lt;param name=&quot;contentType&quot;&gt;ContentType for the current Content object&lt;/param&gt;
        /// &lt;param name=&quot;properties&quot;&gt;Collection of properties&lt;/param&gt;
		public Content(string name, IContent parent, IContentType contentType, PropertyCollection properties)
			: base(name, parent, contentType, properties)
		{
			Mandate.ParameterNotNull(contentType, &quot;contentType&quot;);

			_contentType = contentType;
		}

        /// &lt;summary&gt;
        /// Constructor for creating a Content object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;Name of the content&lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;Id of the Parent content&lt;/param&gt;
        /// &lt;param name=&quot;contentType&quot;&gt;ContentType for the current Content object&lt;/param&gt;
        public Content(string name, int parentId, IContentType contentType)
            : this(name, parentId, contentType, new PropertyCollection())
        {
        }

        /// &lt;summary&gt;
        /// Constructor for creating a Content object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;Name of the content&lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;Id of the Parent content&lt;/param&gt;
        /// &lt;param name=&quot;contentType&quot;&gt;ContentType for the current Content object&lt;/param&gt;
        /// &lt;param name=&quot;properties&quot;&gt;Collection of properties&lt;/param&gt;
        public Content(string name, int parentId, IContentType contentType, PropertyCollection properties) 
			: base(name, parentId, contentType, properties)
        {
            Mandate.ParameterNotNull(contentType, &quot;contentType&quot;);

            _contentType = contentType;
        }

        private static readonly Lazy&lt;PropertySelectors&gt; Ps = new Lazy&lt;PropertySelectors&gt;();

        private class PropertySelectors
        {
            public readonly PropertyInfo TemplateSelector = ExpressionHelper.GetPropertyInfo&lt;Content, ITemplate&gt;(x =&gt; x.Template);
            public readonly PropertyInfo PublishedSelector = ExpressionHelper.GetPropertyInfo&lt;Content, bool&gt;(x =&gt; x.Published);
            public readonly PropertyInfo LanguageSelector = ExpressionHelper.GetPropertyInfo&lt;Content, string&gt;(x =&gt; x.Language);
            public readonly PropertyInfo ReleaseDateSelector = ExpressionHelper.GetPropertyInfo&lt;Content, DateTime?&gt;(x =&gt; x.ReleaseDate);
            public readonly PropertyInfo ExpireDateSelector = ExpressionHelper.GetPropertyInfo&lt;Content, DateTime?&gt;(x =&gt; x.ExpireDate);
            public readonly PropertyInfo WriterSelector = ExpressionHelper.GetPropertyInfo&lt;Content, int&gt;(x =&gt; x.WriterId);
            public readonly PropertyInfo NodeNameSelector = ExpressionHelper.GetPropertyInfo&lt;Content, string&gt;(x =&gt; x.NodeName);
            public readonly PropertyInfo PermissionsChangedSelector = ExpressionHelper.GetPropertyInfo&lt;Content, bool&gt;(x =&gt; x.PermissionsChanged);
        }

        /// &lt;summary&gt;
        /// Gets or sets the template used by the Content.
        /// This is used to override the default one from the ContentType.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// If no template is explicitly set on the Content object, 
        /// the Default template from the ContentType will be returned.
        /// &lt;/remarks&gt;
        [DataMember]
        public virtual ITemplate Template
        {
            get { return _template; }
            set { SetPropertyValueAndDetectChanges(value, ref _template, Ps.Value.TemplateSelector); }
        }

        /// &lt;summary&gt;
        /// Gets the current status of the Content
        /// &lt;/summary&gt;
        [IgnoreDataMember]
        public ContentStatus Status
        {
            get
            {
                if(Trashed)
                    return ContentStatus.Trashed;

                if(ExpireDate.HasValue &amp;&amp; ExpireDate.Value &gt; DateTime.MinValue &amp;&amp; DateTime.Now &gt; ExpireDate.Value)
                    return ContentStatus.Expired;

                if(ReleaseDate.HasValue &amp;&amp; ReleaseDate.Value &gt; DateTime.MinValue &amp;&amp; ReleaseDate.Value &gt; DateTime.Now)
                    return ContentStatus.AwaitingRelease;

                if(Published)
                    return ContentStatus.Published;

                return ContentStatus.Unpublished;
            }
        }

        /// &lt;summary&gt;
        /// Boolean indicating whether this Content is Published or not
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Setting Published to true/false should be private or internal and should ONLY be used for wiring up the value
        /// from the db or modifying it based on changing the published state.
        /// &lt;/remarks&gt;
        [DataMember]
        public bool Published
        {
            get { return _published; }
            internal set { SetPropertyValueAndDetectChanges(value, ref _published, Ps.Value.PublishedSelector); }
        }

        /// &lt;summary&gt;
        /// Language of the data contained within this Content object.
        /// &lt;/summary&gt;
        [Obsolete(&quot;This is not used and will be removed from the codebase in future versions&quot;)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public string Language
        {
            get { return _language; }
            set { SetPropertyValueAndDetectChanges(value, ref _language, Ps.Value.LanguageSelector); }
        }

        /// &lt;summary&gt;
        /// The date this Content should be released and thus be published
        /// &lt;/summary&gt;
        [DataMember]
        public DateTime? ReleaseDate
        {
            get { return _releaseDate; }
            set { SetPropertyValueAndDetectChanges(value, ref _releaseDate, Ps.Value.ReleaseDateSelector); }
        }

        /// &lt;summary&gt;
        /// The date this Content should expire and thus be unpublished
        /// &lt;/summary&gt;
        [DataMember]
        public DateTime? ExpireDate
        {
            get { return _expireDate; }
            set { SetPropertyValueAndDetectChanges(value, ref _expireDate, Ps.Value.ExpireDateSelector); }
        }

        /// &lt;summary&gt;
        /// Id of the user who wrote/updated this Content
        /// &lt;/summary&gt;
        [DataMember]
        public virtual int WriterId
        {
            get { return _writer; }
            set { SetPropertyValueAndDetectChanges(value, ref _writer, Ps.Value.WriterSelector); }
        }

        /// &lt;summary&gt;
        /// Name of the Node (non-localized).
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// This Property is kept internal until localization is introduced.
        /// &lt;/remarks&gt;
        [DataMember]
        internal string NodeName
        {
            get { return _nodeName; }
            set { SetPropertyValueAndDetectChanges(value, ref _nodeName, Ps.Value.NodeNameSelector); }
        }

        /// &lt;summary&gt;
        /// Used internally to track if permissions have been changed during the saving process for this entity
        /// &lt;/summary&gt;
        [IgnoreDataMember]
        internal bool PermissionsChanged
        {
            get { return _permissionsChanged; }
            set { SetPropertyValueAndDetectChanges(value, ref _permissionsChanged, Ps.Value.PermissionsChangedSelector); }
        }

        /// &lt;summary&gt;
        /// Gets the ContentType used by this content object
        /// &lt;/summary&gt;
        [IgnoreDataMember]
        public IContentType ContentType
        {
            get { return _contentType; }
        }

        /// &lt;summary&gt;
        /// Changes the &lt;see cref=&quot;ContentType&quot;/&gt; for the current content object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentType&quot;&gt;New ContentType for this content&lt;/param&gt;
        /// &lt;remarks&gt;Leaves PropertyTypes intact after change&lt;/remarks&gt;
        public void ChangeContentType(IContentType contentType)
        {
            ContentTypeId = contentType.Id;
            _contentType = contentType;
            ContentTypeBase = contentType;
            Properties.EnsurePropertyTypes(PropertyTypes);
            Properties.CollectionChanged += PropertiesChanged;
        }

        /// &lt;summary&gt;
        /// Changes the &lt;see cref=&quot;ContentType&quot;/&gt; for the current content object and removes PropertyTypes,
        /// which are not part of the new ContentType.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentType&quot;&gt;New ContentType for this content&lt;/param&gt;
        /// &lt;param name=&quot;clearProperties&quot;&gt;Boolean indicating whether to clear PropertyTypes upon change&lt;/param&gt;
        public void ChangeContentType(IContentType contentType, bool clearProperties)
        {
            if(clearProperties)
            {
                ContentTypeId = contentType.Id;
                _contentType = contentType;
                ContentTypeBase = contentType;
                Properties.EnsureCleanPropertyTypes(PropertyTypes);
                Properties.CollectionChanged += PropertiesChanged;
                return;
            }

            ChangeContentType(contentType);
        }

        /// &lt;summary&gt;
        /// Changes the Published state of the content object
        /// &lt;/summary&gt;
        public void ChangePublishedState(PublishedState state)
        {
            Published = state == PublishedState.Published;
            PublishedState = state;
        }

        [DataMember]
        internal PublishedState PublishedState { get; set; }

        /// &lt;summary&gt;
        /// Gets or sets the unique identifier of the published version, if any.
        /// &lt;/summary&gt;
        [IgnoreDataMember]
        public Guid PublishedVersionGuid { get; internal set; }

        /// &lt;summary&gt;
        /// Gets a value indicating whether the content has a published version.
        /// &lt;/summary&gt;
        public bool HasPublishedVersion { get { return PublishedVersionGuid != default(Guid); } }

        [IgnoreDataMember]
        internal DateTime PublishedDate { get; set; }

        /// &lt;summary&gt;
        /// Changes the Trashed state of the content object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;isTrashed&quot;&gt;Boolean indicating whether content is trashed (true) or not trashed (false)&lt;/param&gt;
        /// &lt;param name=&quot;parentId&quot;&gt; &lt;/param&gt;
        public override void ChangeTrashedState(bool isTrashed, int parentId = -20)
        {
            Trashed = isTrashed;
            ParentId = parentId;

            //If the content is trashed and is published it should be marked as unpublished
            if (isTrashed &amp;&amp; Published)
            {
                ChangePublishedState(PublishedState.Unpublished);
            }
        }
        
        /// &lt;summary&gt;
        /// Method to call when Entity is being updated
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Modified Date is set and a new Version guid is set&lt;/remarks&gt;
        internal override void UpdatingEntity()
        {
            base.UpdatingEntity();
            Version = Guid.NewGuid();
        }

        /// &lt;summary&gt;
        /// Creates a deep clone of the current entity with its identity and it&#39;s property identities reset
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use DeepCloneWithResetIdentities instead&quot;)]
        public IContent Clone()
        {
            return DeepCloneWithResetIdentities();
        }

        /// &lt;summary&gt;
        /// Creates a deep clone of the current entity with its identity and it&#39;s property identities reset
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IContent DeepCloneWithResetIdentities()
        {
            var clone = (Content)DeepClone();
            clone.Key = Guid.Empty;
            clone.Version = Guid.NewGuid();
            clone.ResetIdentity();

            foreach (var property in clone.Properties)
            {
                property.ResetIdentity();
                property.Version = clone.Version;
            }

            return clone;
        }

        public override object DeepClone()
        {
            var clone = (Content)base.DeepClone();
            //turn off change tracking
            clone.DisableChangeTracking();
            //need to manually clone this since it&#39;s not settable
            clone._contentType = (IContentType)ContentType.DeepClone();
            //this shouldn&#39;t really be needed since we&#39;re not tracking
            clone.ResetDirtyProperties(false);
            //re-enable tracking
            clone.EnableChangeTracking();

            return clone;

        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[34,6,34,63,1],[35,3,35,4,1],[36,3,36,4,1],[46,6,46,49,1],[47,3,47,4,1],[48,4,48,57,1],[50,4,50,31,1],[51,3,51,4,1],[60,15,60,74,1],[61,9,61,10,1],[62,9,62,10,1],[72,6,72,51,1],[73,9,73,10,1],[74,13,74,66,1],[76,13,76,40,1],[77,9,77,10,1],[79,9,79,92,1],[83,13,83,131,1],[84,13,84,128,1],[85,13,85,128,1],[86,13,86,137,1],[87,13,87,135,1],[88,13,88,123,1],[89,13,89,128,1],[90,13,90,146,1],[104,17,104,18,1],[104,19,104,36,1],[104,37,104,38,1],[105,17,105,18,1],[105,19,105,101,1],[105,102,105,103,1],[115,13,115,14,1],[116,17,116,28,1],[117,21,117,50,1],[119,17,119,115,1],[120,21,120,50,1],[122,17,122,118,1],[123,21,123,58,0],[125,17,125,30,1],[126,21,126,52,1],[128,17,128,50,1],[129,13,129,14,1],[142,17,142,18,1],[142,19,142,37,1],[142,38,142,39,1],[143,26,143,27,1],[143,28,143,112,1],[143,113,143,114,1],[153,17,153,18,1],[153,19,153,36,1],[153,37,153,38,1],[154,17,154,18,1],[154,19,154,101,1],[154,102,154,103,1],[163,17,163,18,1],[163,19,163,39,1],[163,40,163,41,1],[164,17,164,18,1],[164,19,164,107,1],[164,108,164,109,1],[173,17,173,18,1],[173,19,173,38,1],[173,39,173,40,1],[174,17,174,18,1],[174,19,174,105,1],[174,106,174,107,1],[183,17,183,18,1],[183,19,183,34,1],[183,35,183,36,1],[184,17,184,18,1],[184,19,184,97,1],[184,98,184,99,1],[196,17,196,18,1],[196,19,196,36,1],[196,37,196,38,1],[197,17,197,18,1],[197,19,197,101,1],[197,102,197,103,1],[206,17,206,18,0],[206,19,206,46,0],[206,47,206,48,0],[207,17,207,18,1],[207,19,207,121,1],[207,122,207,123,1],[216,17,216,18,1],[216,19,216,39,1],[216,40,216,41,1],[225,9,225,10,1],[226,13,226,44,1],[227,13,227,40,1],[228,13,228,43,1],[229,13,229,59,1],[230,13,230,63,1],[231,9,231,10,1],[240,9,240,10,1],[241,13,241,32,1],[242,13,242,14,1],[243,17,243,48,1],[244,17,244,44,1],[245,17,245,47,1],[246,17,246,68,1],[247,17,247,67,1],[248,17,248,24,1],[251,13,251,44,0],[252,9,252,10,1],[258,9,258,10,1],[259,13,259,59,1],[260,13,260,36,1],[261,9,261,10,1],[264,50,264,54,1],[264,55,264,59,1],[270,44,270,48,1],[270,49,270,62,1],[275,47,275,48,1],[275,49,275,94,1],[275,95,275,96,1],[278,43,278,47,1],[278,48,278,52,1],[286,9,286,10,1],[287,13,287,33,1],[288,13,288,33,1],[291,13,291,40,1],[292,13,292,14,0],[293,17,293,66,0],[294,13,294,14,0],[295,9,295,10,1],[302,9,302,10,1],[303,13,303,35,1],[304,13,304,38,1],[305,9,305,10,1],[313,9,313,10,1],[314,13,314,51,1],[315,9,315,10,1],[322,9,322,10,1],[323,13,323,46,1],[324,13,324,36,1],[325,13,325,44,1],[326,13,326,35,1],[328,13,328,20,1],[328,22,328,34,1],[328,35,328,37,1],[328,38,328,54,1],[329,13,329,14,1],[330,17,330,42,1],[331,17,331,50,1],[332,13,332,14,1],[334,13,334,26,1],[335,9,335,10,1],[338,9,338,10,1],[339,13,339,51,1],[341,13,341,43,1],[343,13,343,72,1],[345,13,345,47,1],[347,13,347,42,1],[349,13,349,26,1],[351,9,351,10,1]]);
    </script>
  </body>
</html>