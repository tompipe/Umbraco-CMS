<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\KeyValuePrevalueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Web.UI;
using System.Web.UI.WebControls;
using ClientDependency.Core;
using umbraco.BusinessLogic;
using umbraco.DataLayer;
using System.Collections.Generic;
using System.Web.UI.HtmlControls;



[assembly: System.Web.UI.WebResource(&quot;umbraco.editorControls.KeyValuePrevalueEditor.js&quot;, &quot;text/js&quot;)]
[assembly: System.Web.UI.WebResource(&quot;umbraco.editorControls.KeyValuePrevalueEditor.css&quot;, &quot;text/css&quot;)]
namespace umbraco.editorControls
{
    /// &lt;summary&gt;
    /// Summary description for KeyValuePrevalueEditor.
    /// &lt;/summary&gt;

    [ClientDependency(ClientDependencyType.Javascript, &quot;Jeditable/jquery.jeditable.js&quot;, &quot;UmbracoClient&quot;)]
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class KeyValuePrevalueEditor : System.Web.UI.WebControls.PlaceHolder, interfaces.IDataPrevalue
    {

        // UI controls
        public System.Web.UI.WebControls.DropDownList _dropdownlist;
        public TextBox _textbox;
        private TextBox _tbhidden;
        public umbraco.uicontrols.PropertyPanel pp1 = new umbraco.uicontrols.PropertyPanel();
        public umbraco.uicontrols.PropertyPanel pp2 = new umbraco.uicontrols.PropertyPanel();

        private Hashtable DeleteButtons = new Hashtable();

        // referenced datatype
        private cms.businesslogic.datatype.BaseDataType _datatype;

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        protected static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        public KeyValuePrevalueEditor(cms.businesslogic.datatype.BaseDataType DataType)
        {
            // state it knows its datatypedefinitionid
            _datatype = DataType;

            setupChildControls();

            // Bootstrap delete.
			if (System.Web.HttpContext.Current.Request[&quot;delete&quot;] != null) {
                DeletePrevalue(int.Parse(System.Web.HttpContext.Current.Request[&quot;delete&quot;]));
            }

        }

		private void DeletePrevalue(int id) {
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsDataTypePreValues where id = &quot; + id);
        }

        private void setupChildControls()
        {
            _dropdownlist = new DropDownList();
            _dropdownlist.ID = &quot;dbtype&quot;;

            _textbox = new TextBox();
            _textbox.ID = &quot;AddValue&quot;;

            _tbhidden = new TextBox();
            _tbhidden.Attributes.Add(&quot;style&quot;, &quot;display:none;&quot;);
            _tbhidden.CssClass = &quot;valuesHiddenInput&quot;;

            // put the childcontrols in context - ensuring that
            // the viewstate is persisted etc.
            this.Controls.Add(_dropdownlist);
            this.Controls.Add(_textbox);
            this.Controls.Add(_tbhidden);

            _dropdownlist.Items.Add(DBTypes.Date.ToString());
            _dropdownlist.Items.Add(DBTypes.Integer.ToString());
            _dropdownlist.Items.Add(DBTypes.Ntext.ToString());
            _dropdownlist.Items.Add(DBTypes.Nvarchar.ToString());
        }

        protected override void OnInit(EventArgs e) {
            base.OnInit(e);


            System.Web.UI.Page page = (System.Web.UI.Page)System.Web.HttpContext.Current.Handler;


            page.ClientScript.RegisterClientScriptInclude(
                &quot;umbraco.editorControls.KeyValuePrevalueEditor.js&quot;,
                page.ClientScript.GetWebResourceUrl(typeof(KeyValuePrevalueEditor), &quot;umbraco.editorControls.KeyValuePrevalueEditor.js&quot;));


            HtmlHead head = (HtmlHead)page.Header;
            HtmlLink link = new HtmlLink();
            link.Attributes.Add(&quot;href&quot;, page.ClientScript.GetWebResourceUrl(typeof(KeyValuePrevalueEditor), &quot;umbraco.editorControls.KeyValuePrevalueEditor.css&quot;));
            link.Attributes.Add(&quot;type&quot;, &quot;text/css&quot;);
            link.Attributes.Add(&quot;rel&quot;, &quot;stylesheet&quot;);
            head.Controls.Add(link);

        }

        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            if (!Page.IsPostBack)
            {
                _dropdownlist.SelectedValue = _datatype.DBType.ToString();

            }


        }

        public Control Editor
        {
            get
            {
                return this;
            }
        }

		public void Save() 
		{
            _datatype.DBType = (cms.businesslogic.datatype.DBTypes)Enum.Parse(typeof(cms.businesslogic.datatype.DBTypes), _dropdownlist.SelectedValue, true);
			
            //changes in name and sortorder
            if (!string.IsNullOrEmpty(_tbhidden.Text))
            {
                int so = 0;
                foreach (string row in _tbhidden.Text.Split(&#39;ï¿½&#39;))
                {
                    if (!string.IsNullOrEmpty(row))
                    {
                     
                        int id = 0;

                        if (row.Split(&#39;|&#39;).Length == 2 &amp;&amp;  int.TryParse(row.Split(&#39;|&#39;)[0], out id) &amp;&amp; row.Split(&#39;|&#39;)[1].Length &gt; 0)
                        {
                            using (var sqlHelper = Application.SqlHelper)
                            {
                                IParameter[] SqlParams = new IParameter[] {
                                sqlHelper.CreateParameter(&quot;@value&quot;,row.Split(&#39;|&#39;)[1]),
                                sqlHelper.CreateParameter(&quot;@sortorder&quot;,so),
                                sqlHelper.CreateParameter(&quot;@id&quot;,id)};
                                sqlHelper.ExecuteNonQuery(&quot;update cmsDataTypePreValues set [value] = @value, sortorder = @sortorder where id = @id&quot;, SqlParams);
                            }
                        }

                        so++;
                    }
                }

                _tbhidden.Text = &quot;&quot;;
            }

            // If the add new prevalue textbox is filled out - add the value to the collection.
			if (_textbox.Text != &quot;&quot;) 
			{

                int so = -1;

                try
                {
                    using (var sqlHelper = Application.SqlHelper)
                        so = sqlHelper.ExecuteScalar&lt;int&gt;(&quot;select max(sortorder) from cmsDataTypePreValues where datatypenodeid = @dtdefid&quot;,
                            sqlHelper.CreateParameter(&quot;@dtdefid&quot;, _datatype.DataTypeDefinitionId));
                    so++;
                }
                catch { }

                using (var sqlHelper = Application.SqlHelper)
                {
                    IParameter[] SqlParams = new IParameter[] {
                                    sqlHelper.CreateParameter(&quot;@value&quot;,_textbox.Text),
                                    sqlHelper.CreateParameter(&quot;@dtdefid&quot;,_datatype.DataTypeDefinitionId),
                                    sqlHelper.CreateParameter(&quot;@so&quot;,so)};
                    sqlHelper.ExecuteNonQuery(&quot;insert into cmsDataTypePreValues (datatypenodeid,[value],sortorder,alias) values (@dtdefid,@value,@so,&#39;&#39;)&quot;, SqlParams);
                }
				_textbox.Text = &quot;&quot;;

                ScriptManager.GetCurrent(Page).SetFocus(_textbox);
			}
		}

        protected override void Render(HtmlTextWriter writer)
        {
            writer.Write(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&lt;div class=&#39;propertyItemheader&#39;&gt;&quot; + ui.Text(&quot;dataBaseDatatype&quot;) + &quot;&lt;/div&gt;&quot;);
            _dropdownlist.RenderControl(writer);
            writer.Write(&quot;&lt;br style=&#39;clear: both&#39;/&gt;&lt;/div&gt;&quot;);

            List&lt;KeyValuePair&lt;int, String&gt;&gt; _prevalues = PrevaluesAsKeyValuePairList;
            if (_prevalues.Count &gt; 0) {
                writer.Write(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&lt;table style=&#39;width: 100%&#39; id=\&quot;prevalues\&quot;&gt;&quot;);
                writer.Write(&quot;&lt;tr class=&#39;header&#39;&gt;&lt;th style=&#39;width: 15%&#39;&gt;Text&lt;/th&gt;&lt;td colspan=&#39;2&#39;&gt;Value&lt;/td&gt;&lt;/tr&gt;&quot;);

                foreach (KeyValuePair&lt;int, String&gt; item in _prevalues)
                {
                    writer.Write(&quot;&lt;tr class=\&quot;row\&quot;&gt;&lt;td class=\&quot;text\&quot;&gt;&quot; + item.Value + &quot;&lt;/td&gt;&lt;td class=\&quot;value\&quot;&gt; &quot; + item.Key.ToString() + &quot;&lt;/td&gt;&lt;td&gt;&lt;a onclick=&#39;javascript:return ConfirmPrevalueDelete();&#39; href=&#39;?id=&quot; + _datatype.DataTypeDefinitionId + &quot;&amp;delete=&quot; + item.Key.ToString() + &quot;&#39;&gt;&quot; + ui.Text(&quot;delete&quot;) + &quot;&lt;/a&gt; &lt;span class=\&quot;handle\&quot; style=\&quot;cursor:move\&quot;&gt;sort&lt;span&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
                }
                writer.Write(&quot;&lt;/table&gt;&lt;br style=&#39;clear: both&#39;/&gt;&lt;/div&gt;&quot;);
            }

            writer.Write(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&lt;div class=&#39;propertyItemheader&#39;&gt;&quot; + ui.Text(&quot;addPrevalue&quot;) + &quot;&lt;/div&gt;&quot;);
            _textbox.RenderControl(writer);
            writer.Write(&quot;&lt;br style=&#39;clear: both&#39;/&gt;&lt;/div&gt;&quot;);

            _tbhidden.RenderControl(writer);


        }

        public SortedList Prevalues {
            get
            {
                SortedList retval = new SortedList();
                using (var sqlHelper = Application.SqlHelper)
                using (IRecordsReader dr = sqlHelper.ExecuteReader(
                   &quot;Select id, [value] from cmsDataTypePreValues where DataTypeNodeId = &quot;
                    + _datatype.DataTypeDefinitionId + &quot; order by sortorder&quot;))
                {
                    while (dr.Read())
                        retval.Add(dr.GetInt(&quot;id&quot;), dr.GetString(&quot;value&quot;));

                    return retval;
                }
            }
        }

        public List&lt;KeyValuePair&lt;int, String&gt;&gt; PrevaluesAsKeyValuePairList
        {
            get
            {

                List&lt;KeyValuePair&lt;int, String&gt;&gt; items = new List&lt;KeyValuePair&lt;int, String&gt;&gt;();

                using (var sqlHelper = Application.SqlHelper)
                {
                    using (IRecordsReader dr = sqlHelper.ExecuteReader(
                        &quot;Select id, [value] from cmsDataTypePreValues where DataTypeNodeId = &quot;
                        + _datatype.DataTypeDefinitionId + &quot; order by sortorder&quot;))
                    {
                        while (dr.Read())
                            items.Add(new KeyValuePair&lt;int, string&gt;(dr.GetInt(&quot;id&quot;), dr.GetString(&quot;value&quot;)));
                    }
                }
                return items;
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,94,0],[31,9,31,94,0],[33,9,33,59,0],[44,17,44,18,0],[44,19,44,48,0],[44,49,44,50,0],[47,9,47,88,0],[48,9,48,10,0],[50,13,50,34,0],[52,13,52,34,0],[55,4,55,65,0],[55,66,55,67,0],[56,17,56,93,0],[57,13,57,14,0],[59,9,59,10,0],[61,39,61,40,0],[62,20,62,57,0],[63,17,63,96,0],[64,9,64,10,0],[67,9,67,10,0],[68,13,68,48,0],[69,13,69,41,0],[71,13,71,38,0],[72,13,72,38,0],[74,13,74,39,0],[75,13,75,64,0],[76,13,76,54,0],[80,13,80,46,0],[81,13,81,41,0],[82,13,82,42,0],[84,13,84,62,0],[85,13,85,65,0],[86,13,86,63,0],[87,13,87,66,0],[88,9,88,10,0],[90,53,90,54,0],[91,13,91,28,0],[94,13,94,98,0],[97,13,99,138,0],[102,13,102,51,0],[103,13,103,44,0],[104,13,104,163,0],[105,13,105,53,0],[106,13,106,54,0],[107,13,107,37,0],[109,9,109,10,0],[112,9,112,10,0],[113,13,113,28,0],[115,13,115,34,0],[116,13,116,14,0],[117,17,117,75,0],[119,13,119,14,0],[122,9,122,10,0],[127,13,127,14,0],[128,17,128,29,0],[129,13,129,14,0],[133,3,133,4,0],[134,13,134,158,0],[137,13,137,55,0],[138,13,138,14,0],[139,17,139,28,0],[140,17,140,24,0],[140,26,140,36,0],[140,37,140,39,0],[140,40,140,65,0],[141,17,141,18,0],[142,21,142,52,0],[143,21,143,22,0],[145,25,145,36,0],[147,25,147,132,0],[148,25,148,26,0],[149,36,149,73,0],[150,29,150,30,0],[151,33,154,70,0],[155,33,155,161,0],[156,29,156,30,0],[157,25,157,26,0],[159,25,159,30,0],[160,21,160,22,0],[161,17,161,18,0],[163,17,163,37,0],[164,13,164,14,0],[167,4,167,28,0],[168,4,168,5,0],[170,17,170,29,0],[173,17,173,18,0],[174,28,174,65,0],[175,25,176,100,0],[177,21,177,26,0],[178,17,178,18,0],[179,17,179,22,0],[179,23,179,24,0],[179,25,179,26,0],[181,24,181,61,0],[182,17,182,18,0],[183,21,186,74,0],[187,21,187,167,0],[188,17,188,18,0],[189,5,189,24,0],[191,17,191,67,0],[192,4,192,5,0],[193,3,193,4,0],[196,9,196,10,0],[197,13,197,129,0],[198,13,198,49,0],[199,13,199,61,0],[201,13,201,86,0],[202,13,202,38,0],[202,39,202,40,0],[203,17,203,104,0],[204,17,204,116,0],[206,17,206,24,0],[206,26,206,56,0],[206,57,206,59,0],[206,60,206,70,0],[207,17,207,18,0],[208,21,208,391,0],[209,17,209,18,0],[210,17,210,73,0],[211,13,211,14,0],[213,13,213,124,0],[214,13,214,44,0],[215,13,215,61,0],[217,13,217,45,0],[220,9,220,10,0],[224,13,224,14,0],[225,17,225,54,0],[226,24,226,61,0],[227,24,229,78,0],[230,17,230,18,0],[231,21,231,38,0],[232,25,232,76,0],[234,21,234,35,0],[236,13,236,14,0],[242,13,242,14,0],[244,17,244,95,0],[246,24,246,61,0],[247,17,247,18,0],[248,28,250,82,0],[251,21,251,22,0],[252,25,252,42,0],[253,29,253,110,0],[254,21,254,22,0],[255,17,255,18,0],[256,17,256,30,0],[257,13,257,14,0]]);
    </script>
  </body>
</html>