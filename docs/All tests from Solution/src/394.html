<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Migrations\Upgrades\ValidateOlderSchemaTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using System.Data.SqlServerCe;
using System.IO;
using System.Text.RegularExpressions;
using Moq;
using NUnit.Framework;
using SQLCE4Umbraco;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations.Initial;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Migrations.Upgrades
{
    [TestFixture]
    public class ValidateOlderSchemaTest
    {
        /// &lt;summary&gt;Regular expression that finds multiline block comments.&lt;/summary&gt;
        private static readonly Regex FindComments = new Regex(@&quot;\/\*.*?\*\/&quot;, RegexOptions.Singleline | RegexOptions.Compiled);

        [Test]
        public virtual void DatabaseSchemaCreation_Returns_DatabaseSchemaResult_Where_DetermineInstalledVersion_Is_4_7_0()
        {
            // Arrange
            var db = GetConfiguredDatabase();
            var schema = new DatabaseSchemaCreation(db, Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider());

            //Create db schema and data from old Total.sql file for Sql Ce
            string statements = GetDatabaseSpecificSqlScript();
            // replace block comments by whitespace
            statements = FindComments.Replace(statements, &quot; &quot;);
            // execute all non-empty statements
            foreach (string statement in statements.Split(&quot;;&quot;.ToCharArray()))
            {
                string rawStatement = statement.Replace(&quot;GO&quot;, &quot;&quot;).Trim();
                if (rawStatement.Length &gt; 0)
                    db.Execute(new Sql(rawStatement));
            }

            // Act
            var result = schema.ValidateSchema();

            // Assert
            var expected = new Version(4, 7, 0);
            Assert.AreEqual(expected, result.DetermineInstalledVersion());
        }

        [SetUp]
        public virtual void Initialize()
        {
            TestHelper.InitializeContentDirectories();

            Path = TestHelper.CurrentAssemblyDirectory;
            AppDomain.CurrentDomain.SetData(&quot;DataDirectory&quot;, Path);

            //Delete database file before continueing
            string filePath = string.Concat(Path, &quot;\\UmbracoPetaPocoTests.sdf&quot;);
            if (File.Exists(filePath))
            {
                File.Delete(filePath);
            }

            //Get the connectionstring settings from config
            var settings = ConfigurationManager.ConnectionStrings[Core.Configuration.GlobalSettings.UmbracoConnectionName];

            Resolution.Freeze();

            //Create the Sql CE database
            using (var engine = new SqlCeEngine(settings.ConnectionString))
            {
                engine.CreateDatabase();
            }

            SqlSyntaxContext.SqlSyntaxProvider = new SqlCeSyntaxProvider();
        }

        [TearDown]
        public virtual void TearDown()
        {
            SqlSyntaxContext.SqlSyntaxProvider = null;
            Resolution.Reset();

            TestHelper.CleanContentDirectories();

            Path = TestHelper.CurrentAssemblyDirectory;
            AppDomain.CurrentDomain.SetData(&quot;DataDirectory&quot;, null);

            //legacy API database connection close
            SqlCeContextGuardian.CloseBackgroundConnection();

            string filePath = string.Concat(Path, &quot;\\UmbracoPetaPocoTests.sdf&quot;);
            if (File.Exists(filePath))
            {
                File.Delete(filePath);
            }
        }
        
        public string Path { get; set; }

        public UmbracoDatabase GetConfiguredDatabase()
        {
            return new UmbracoDatabase(&quot;Datasource=|DataDirectory|UmbracoPetaPocoTests.sdf;Flush Interval=1;&quot;, Constants.DatabaseProviders.SqlCe, Mock.Of&lt;ILogger&gt;());
        }

        public string GetDatabaseSpecificSqlScript()
        {
            return SqlScripts.SqlResources.SqlCeTotal_480;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,129,1],[28,9,28,10,1],[30,13,30,46,1],[31,13,31,104,1],[34,13,34,64,1],[36,13,36,64,1],[38,13,38,20,1],[38,22,38,38,1],[38,39,38,41,1],[38,42,38,77,1],[39,13,39,14,1],[40,17,40,74,1],[41,17,41,45,1],[42,21,42,55,1],[43,13,43,14,1],[46,13,46,50,1],[49,13,49,49,1],[50,13,50,75,1],[51,9,51,10,1],[55,9,55,10,1],[56,13,56,55,1],[58,13,58,56,1],[59,13,59,68,1],[62,13,62,81,1],[63,13,63,39,1],[64,13,64,14,1],[65,17,65,39,1],[66,13,66,14,1],[69,13,69,124,1],[71,13,71,33,1],[74,20,74,75,1],[75,13,75,14,1],[76,17,76,41,1],[77,13,77,14,1],[79,13,79,76,1],[80,9,80,10,1],[84,9,84,10,1],[85,13,85,55,1],[86,13,86,32,1],[88,13,88,50,1],[90,13,90,56,1],[91,13,91,68,1],[94,13,94,62,1],[96,13,96,81,1],[97,13,97,39,1],[98,13,98,14,1],[99,17,99,39,1],[100,13,100,14,1],[101,9,101,10,1],[103,30,103,34,1],[103,35,103,39,1],[106,9,106,10,1],[107,13,107,167,1],[108,9,108,10,1],[111,9,111,10,1],[112,13,112,59,1],[113,9,113,10,1]]);
    </script>
  </body>
</html>