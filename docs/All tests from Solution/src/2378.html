<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\Content.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Xml;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using umbraco.cms.businesslogic.property;
using umbraco.DataLayer;
using System.Runtime.CompilerServices;
using umbraco.BusinessLogic;
using umbraco.cms.helpers;
using umbraco.cms.businesslogic.datatype.controls;
using File = System.IO.File;
using Property = umbraco.cms.businesslogic.property.Property;
using PropertyType = umbraco.cms.businesslogic.propertytype.PropertyType;

namespace umbraco.cms.businesslogic
{
    /// &lt;summary&gt;
    /// Content is an intermediate layer between CMSNode and class&#39;es which will use generic data.
    /// 
    /// Content is a datastructure that holds generic data defined in its corresponding ContentType. Content can in some
    /// sence be compared to a row in a database table, it&#39;s contenttype hold a definition of the columns and the Content
    /// contains the data
    /// 
    /// Note that Content data in umbraco is *not* tablular but in a treestructure.
    /// 
    /// &lt;/summary&gt;
    [Obsolete(&quot;Obsolete, Use Umbraco.Core.Models.Content or Umbraco.Core.Models.Media&quot;, false)]
    public class Content : CMSNode
    {
        #region Private Members

        private Guid _version;
        private DateTime _versionDate;
        private XmlNode _xml;
        private bool _versionDateInitialized;
        private string _contentTypeIcon;
        private ContentType _contentType;
        private Properties _loadedProperties = null;
        protected internal IContentBase ContentBase;

        #endregion

        #region Constructors

        protected internal Content(int id, Guid version)
            : base(id, new object[] { version })
        {
        }

        public Content(int id) : base(id) { }

        protected Content(int id, bool noSetup) : base(id, noSetup) { }

        protected Content(Guid id) : base(id) { }

        protected Content(Guid id, bool noSetup) : base(id, noSetup) { }

        protected internal Content(IUmbracoEntity entity) : base(entity) { }

        protected internal Content(IContentBase contentBase)
            : base(contentBase)
        {
            ContentBase = contentBase;
            _version = ContentBase.Version;
            _versionDate = ContentBase.UpdateDate;
            _versionDateInitialized = true;
        }

        #endregion

        #region Static Methods

        /// &lt;summary&gt;
        /// Retrive a list of Content sharing the ContentType
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ct&quot;&gt;The ContentType&lt;/param&gt;
        /// &lt;returns&gt;A list of Content objects sharing the ContentType defined.&lt;/returns&gt;
        [Obsolete(&quot;Obsolete, Use Umbraco.Core.Services.ContentService.GetContentOfContentType() or Umbraco.Core.Services.MediaService.GetMediaOfMediaType()&quot;, false)]
        public static Content[] getContentOfContentType(ContentType ct)
        {
            var list = new List&lt;Content&gt;();
            var content = ApplicationContext.Current.Services.ContentService.GetContentOfContentType(ct.Id);
            list.AddRange(content.OrderBy(x =&gt; x.Name).Select(x =&gt; new Content(x)));

            var media = ApplicationContext.Current.Services.MediaService.GetMediaOfMediaType(ct.Id);
            list.AddRange(media.OrderBy(x =&gt; x.Name).Select(x =&gt; new Content(x)));

            return list.ToArray();
        }

        /// &lt;summary&gt;
        /// Initialize a contentobject given a version.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;version&quot;&gt;The version identifier&lt;/param&gt;
        /// &lt;returns&gt;The Content object from the given version&lt;/returns&gt;
        [Obsolete(&quot;Obsolete, Use Umbraco.Core.Services.ContentService.GetByIdVersion() or Umbraco.Core.Services.MediaService.GetByIdVersion()&quot;, false)]
        public static Content GetContentFromVersion(Guid version)
        {
            var content = ApplicationContext.Current.Services.ContentService.GetByVersion(version);
            if (content != null)
            {
                return new Content(content);
            }

            var media = ApplicationContext.Current.Services.MediaService.GetByVersion(version);
            return new Content(media);
        }

        #endregion

        #region Public Properties

        /// &lt;summary&gt;
        /// Get the newParent id of the node
        /// &lt;/summary&gt;
        public override int ParentId
        {
            get { return ContentBase == null ? base.ParentId : ContentBase.ParentId; }
        }

        /// &lt;summary&gt;
        /// The current Content objects ContentType, which defines the Properties of the Content (data)
        /// &lt;/summary&gt;
        public ContentType ContentType
        {
            get
            {
                using (var sqlHelper = Application.SqlHelper)
                {
                    if (_contentType == null)
                    {
                        object o = sqlHelper.ExecuteScalar&lt;object&gt;(
                            &quot;Select ContentType from cmsContent where nodeId=@nodeid&quot;,
                            sqlHelper.CreateParameter(&quot;@nodeid&quot;, this.Id));
                        if (o == null)
                            return null;
                        int contentTypeId;
                        if (int.TryParse(o.ToString(), out contentTypeId) == false)
                            return null;

                        try
                        {
                            _contentType = new ContentType(contentTypeId);
                        }
                        catch
                        {
                            return null;
                        }
                    }
                }
                return _contentType;
            }
            set
            {
                _contentType = value;
            }
        }

        /// &lt;summary&gt;
        /// The icon used in the tree - placed in this layer for performance reasons.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// This is here for performance reasons only. If the _contentTypeIcon is manually set
        /// then a database call is not made to initialize the ContentType.
        /// 
        /// The data layer has slightly changed in 4.1 so that for Document and Media, the ContentType
        /// is automatically initialized with one SQL call when creating the documents/medias so using this
        /// method or the ContentType.IconUrl property when accessing the icon from Media or Document 
        /// won&#39;t affect performance.
        /// &lt;/remarks&gt;
        public string ContentTypeIcon
        {
            get
            {
                if (_contentTypeIcon == null &amp;&amp; this.ContentType != null)
                    _contentTypeIcon = this.ContentType.IconUrl;
                return _contentTypeIcon ?? string.Empty;
            }
            set
            {
                _contentTypeIcon = value;
            }
        }

        /// &lt;summary&gt;
        /// The createtimestamp on this version
        /// &lt;/summary&gt;
        public DateTime VersionDate
        {
            get
            {
                if (!_versionDateInitialized)
                {
                    // A Media item only contains a single version (which relates to it&#39;s creation) so get this value from the media xml fragment instead
                    if (this is media.Media)
                    {
                        // get the xml fragment from cmsXmlContent
                        using (var sqlHelper = Application.SqlHelper)
                        {
                            string xmlFragment = sqlHelper.ExecuteScalar&lt;string&gt;(@&quot;SELECT [xml] FROM cmsContentXml WHERE nodeId = &quot; + this.Id);
                            if (!string.IsNullOrWhiteSpace(xmlFragment))
                            {
                                XmlDocument xmlDocument = new XmlDocument();
                                xmlDocument.LoadXml(xmlFragment);

                                _versionDateInitialized = DateTime.TryParse(xmlDocument.SelectSingleNode(&quot;//*[1]&quot;).Attributes[&quot;updateDate&quot;].Value, out _versionDate);
                            }
                        }
                    }

                    if (!_versionDateInitialized)
                    {

                        using (var sqlHelper = Application.SqlHelper)
                        {
                            object o = sqlHelper.ExecuteScalar&lt;object&gt;(
                                &quot;select VersionDate from cmsContentVersion where versionId = &#39;&quot; + this.Version.ToString() + &quot;&#39;&quot;);
                            if (o == null)
                            {
                                _versionDate = DateTime.Now;
                            }
                            else
                            {
                                _versionDateInitialized = DateTime.TryParse(o.ToString(), out _versionDate);
                            }
                        }
                    }
                }
                return _versionDate;
            }
            set
            {
                _versionDate = value;
                _versionDateInitialized = true;
            }
        }

        /// &lt;summary&gt;
        /// Retrieve a list of generic properties of the content
        /// &lt;/summary&gt;
        public Properties GenericProperties
        {
            get
            {
                EnsureProperties();
                return _loadedProperties;
            }
        }

        /// &lt;summary&gt;
        /// Retrieve a list of generic properties of the content
        /// &lt;/summary&gt;
        [Obsolete(&quot;Use the GenericProperties property instead&quot;)]
        public Property[] getProperties
        {
            get
            {
                EnsureProperties();
                return _loadedProperties.ToArray();
            }
        }

        /// &lt;summary&gt;
        /// Content is under version control, you are able to programatically create new versions
        /// &lt;/summary&gt;
        public Guid Version
        {
            get
            {
                if (_version == Guid.Empty)
                {
                    string sql = &quot;Select versionId from cmsContentVersion where contentID = &quot; + this.Id +
                                 &quot; order by id desc &quot;;

                    using (var sqlHelper = Application.SqlHelper)
                    using (IRecordsReader dr = sqlHelper.ExecuteReader(sql))
                    {
                        if (!dr.Read())
                            _version = Guid.Empty;
                        else
                            _version = dr.GetGuid(&quot;versionId&quot;);
                    }
                }
                return _version;
            }
            set { _version = value; }
        }

        #endregion

        #region Public Methods

        /// &lt;summary&gt;
        /// Used to persist object changes to the database. This ensures that the properties are re-loaded from the database.
        /// &lt;/summary&gt;
        public override void Save()
        {
            base.Save();

            ClearLoadedProperties();
        }

        /// &lt;summary&gt;
        /// Retrieve a Property given the alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;Propertyalias (defined in the documenttype)&lt;/param&gt;
        /// &lt;returns&gt;The property with the given alias&lt;/returns&gt;
        public virtual Property getProperty(string alias)
        {
            EnsureProperties();

            return _loadedProperties.SingleOrDefault(x =&gt; x.PropertyType.Alias == alias);
        }

        /// &lt;summary&gt;
        /// Retrieve a property given the propertytype
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pt&quot;&gt;PropertyType&lt;/param&gt;
        /// &lt;returns&gt;The property with the given propertytype&lt;/returns&gt;
        public virtual Property getProperty(PropertyType pt)
        {
            EnsureProperties();

            return _loadedProperties.SingleOrDefault(x =&gt; x.PropertyType.Id == pt.Id);
        }

        /// &lt;summary&gt;
        /// Add a property to the Content
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pt&quot;&gt;The PropertyType of the Property&lt;/param&gt;
        /// &lt;param name=&quot;versionId&quot;&gt;The version of the document on which the property should be add&#39;ed&lt;/param&gt;
        /// &lt;returns&gt;The new Property&lt;/returns&gt;
        public virtual Property addProperty(PropertyType pt, Guid versionId)
        {
            ClearLoadedProperties();

            return property.Property.MakeNew(pt, this, versionId);

        }

        /// &lt;summary&gt;
        /// An Xmlrepresentation of a Content object.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xd&quot;&gt;Xmldocument context&lt;/param&gt;
        /// &lt;param name=&quot;Deep&quot;&gt;If true, the Contents children are appended to the Xmlnode recursive&lt;/param&gt;
        /// &lt;returns&gt;The Xmlrepresentation of the data on the Content object&lt;/returns&gt;
        public override XmlNode ToXml(XmlDocument xd, bool Deep)
        {
            if (_xml == null)
            {
                XmlDocument xmlDoc = new XmlDocument();
                // we add a try/catch clause here, as the xmlreader will throw an exception if there&#39;s no xml in the table
                // after the empty catch we&#39;ll generate the xml which is why we don&#39;t do anything in the catch part
                try
                {
                    using (var sqlHelper = Application.SqlHelper)
                    using (var xr = sqlHelper.ExecuteXmlReader(&quot;select xml from cmsContentXml where nodeID = &quot; + this.Id.ToString()))
                    {
                        if (xr.MoveToContent() != System.Xml.XmlNodeType.None)
                        {
                            xmlDoc.Load(xr);
                            _xml = xmlDoc.FirstChild;
                        }
                    }
                }
                catch
                {
                }


                // Generate xml if xml still null (then it hasn&#39;t been initialized before)
                if (_xml == null)
                {
                    this.XmlGenerate(new XmlDocument());
                    _xml = importXml();
                }

            }

            XmlNode x = xd.ImportNode(_xml, true);

            if (Deep)
            {
                var childs = this.Children;
                foreach (BusinessLogic.console.IconI c in childs)
                {
                    try
                    {
                        x.AppendChild(new Content(c.Id).ToXml(xd, true));
                    }
                    catch (Exception mExp)
                    {
                        System.Web.HttpContext.Current.Trace.Warn(&quot;Content&quot;, &quot;Error adding node to xml: &quot; + mExp.ToString());
                    }
                }
            }

            return x;

        }

        /// &lt;summary&gt;
        /// Removes the Xml cached in the database - unpublish and cleaning
        /// &lt;/summary&gt;
        public virtual void XmlRemoveFromDB()
        {
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsContentXml where nodeId = @nodeId&quot;, sqlHelper.CreateParameter(&quot;@nodeId&quot;, this.Id));
        }

        /// &lt;summary&gt;
        /// Generates the Content XmlNode
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xd&quot;&gt;&lt;/param&gt;
        public virtual void XmlGenerate(XmlDocument xd)
        {
            SaveXmlDocument(generateXmlWithoutSaving(xd));
        }

        public virtual void XmlPopulate(XmlDocument xd, ref XmlNode x, bool Deep)
        {
            var props = this.GenericProperties;
            foreach (property.Property p in props)
                if (p != null &amp;&amp; p.Value != null &amp;&amp; string.IsNullOrEmpty(p.Value.ToString()) == false)
                    x.AppendChild(p.ToXml(xd));

            // attributes
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;id&quot;, this.Id.ToString()));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;key&quot;, this.UniqueId.ToString()));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;version&quot;, this.Version.ToString()));
            if (this.Level &gt; 1)
                x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;parentID&quot;, this.ParentId.ToString()));
            else
                x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;parentID&quot;, &quot;-1&quot;));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;level&quot;, this.Level.ToString()));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;writerID&quot;, this.User.Id.ToString()));
            if (this.ContentType != null)
                x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;nodeType&quot;, this.ContentType.Id.ToString()));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;template&quot;, &quot;0&quot;));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;sortOrder&quot;, this.sortOrder.ToString()));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;createDate&quot;, this.CreateDateTime.ToString(&quot;s&quot;)));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;updateDate&quot;, this.VersionDate.ToString(&quot;s&quot;)));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;nodeName&quot;, this.Text));
            if (this.Text != null)
                x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;urlName&quot;, this.Text.Replace(&quot; &quot;, &quot;&quot;).ToLower()));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;writerName&quot;, this.User.Name));
            if (this.ContentType != null)
                x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;nodeTypeAlias&quot;, this.ContentType.Alias));
            x.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;path&quot;, this.Path));

            if (Deep)
            {
                //store children array here because iterating over an Array property object is very inneficient.
                var children = this.Children;
                foreach (Content c in children)
                    x.AppendChild(c.ToXml(xd, true));
            }
        }

        /// &lt;summary&gt;
        /// Deletes the current Content object, must be overridden in the child class.
        /// &lt;/summary&gt;
        public override void delete()
        {
            ClearLoadedProperties();

            // Delete all data associated with this content
            this.deleteAllProperties();

            // Remove all content preview xml
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsPreviewXml where nodeId = &quot; + Id);

            // Delete version history
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;Delete from cmsContentVersion where ContentId = &quot; + this.Id);

            // Delete xml
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsContentXml where nodeID = @nodeId&quot;, sqlHelper.CreateParameter(&quot;@nodeId&quot;, this.Id));

            // Delete Contentspecific data ()
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;Delete from cmsContent where NodeId = &quot; + this.Id);

            // Delete Nodeinformation!!
            base.delete();
        }

        #endregion

        #region Protected Methods

        /// &lt;summary&gt;
        /// This is purely for a hackity hack hack hack in order to make the new Document(id, version) constructor work because
        /// the Version property needs to be set on the object before setupNode is called, otherwise it never works!
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ctorArgs&quot;&gt;&lt;/param&gt;
        internal override void PreSetupNode(params object[] ctorArgs)
        {
            //we know that there is one ctor arg and it is a GUID since we are only calling the base
            // ctor with this overload for one purpose.
            var version = (Guid)ctorArgs[0];
            _version = version;

            base.PreSetupNode(ctorArgs);
        }

        /// &lt;summary&gt;
        /// Sets up the ContentType property for this content item and sets the addition content properties manually.
        /// If the ContentType property is not already set, then this will get the ContentType from Cache.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;InitContentType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;InitVersion&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;InitVersionDate&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;InitContentTypeIcon&quot;&gt;&lt;/param&gt;
        protected void InitializeContent(int InitContentType, Guid InitVersion, DateTime InitVersionDate, string InitContentTypeIcon)
        {
            ClearLoadedProperties();

            if (_contentType == null)
                _contentType = ContentType.GetContentType(InitContentType);

            _version = InitVersion;
            _versionDate = InitVersionDate;
            _contentTypeIcon = InitContentTypeIcon;
        }

        /// &lt;summary&gt;
        /// Creates a new Content object from the ContentType.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ct&quot;&gt;&lt;/param&gt;
        protected virtual void CreateContent(ContentType ct)
        {
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;insert into cmsContent (nodeId,ContentType) values (&quot; + this.Id + &quot;,&quot; + ct.Id + &quot;)&quot;);
            createNewVersion(DateTime.Now);
        }

        /// &lt;summary&gt;
        /// Method for creating a new version of the data associated to the Content. 
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The new version Id&lt;/returns&gt;
        protected Guid createNewVersion(DateTime versionDate = default(DateTime))
        {
            if (versionDate == default(DateTime))
            {
                versionDate = DateTime.Now;
            }

            ClearLoadedProperties();

            Guid newVersion = Guid.NewGuid();
            bool tempHasVersion = hasVersion();

            // we need to ensure that a version in the db exist before we add related data
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;Insert into cmsContentVersion (ContentId,versionId,versionDate) values (&quot; + this.Id + &quot;,&#39;&quot; + newVersion + &quot;&#39;, @updateDate)&quot;,
                sqlHelper.CreateParameter(&quot;@updateDate&quot;, versionDate));

            List&lt;PropertyType&gt; pts = ContentType.PropertyTypes;
            foreach (propertytype.PropertyType pt in pts)
            {
                object oldValue = &quot;&quot;;
                if (tempHasVersion)
                {
                    try
                    {
                        oldValue = this.getProperty(pt.Alias).Value;
                    }
                    catch { }
                }
                property.Property p = this.addProperty(pt, newVersion);
                if (oldValue != null &amp;&amp; oldValue.ToString() != &quot;&quot;) p.Value = oldValue;
            }
            this.Version = newVersion;
            return newVersion;
        }

        protected virtual XmlNode generateXmlWithoutSaving(XmlDocument xd)
        {
            string nodeName = UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema ? &quot;node&quot; : Casing.SafeAliasWithForcingCheck(ContentType.Alias);
            XmlNode x = xd.CreateNode(XmlNodeType.Element, nodeName, &quot;&quot;);
            XmlPopulate(xd, ref x, false);
            return x;
        }

        /// &lt;summary&gt;
        /// Saves the XML document to the data source.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;node&quot;&gt;The XML Document.&lt;/param&gt;
        [MethodImpl(MethodImplOptions.Synchronized)]
        protected virtual void SaveXmlDocument(XmlNode node)
        {
            // Method is synchronized so exists remains consistent (avoiding race condition)
            using (var sqlHelper = Application.SqlHelper)
            {
                bool exists = sqlHelper.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(nodeId) FROM cmsContentXml WHERE nodeId = @nodeId&quot;,
                                           sqlHelper.CreateParameter(&quot;@nodeId&quot;, Id)) &gt; 0;
                string query;
                if (exists)
                    query = &quot;UPDATE cmsContentXml SET xml = @xml WHERE nodeId = @nodeId&quot;;
                else
                    query = &quot;INSERT INTO cmsContentXml(nodeId, xml) VALUES (@nodeId, @xml)&quot;;
            
                sqlHelper.ExecuteNonQuery(query,
                                      sqlHelper.CreateParameter(&quot;@nodeId&quot;, Id),
                                      sqlHelper.CreateParameter(&quot;@xml&quot;, node.OuterXml));
            }
        }

        /// &lt;summary&gt;
        /// Deletes all files and the folder that have been saved with this content item which are based on the Upload data
        /// type. This is called when a media or content tree node is deleted. 
        /// &lt;/summary&gt;
        protected void DeleteAssociatedMediaFiles()
        {
            // Remove all files

            var fs = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();
            var uploadField = DataTypesResolver.Current.GetById(new Guid(Constants.PropertyEditors.UploadField));

            foreach (Property p in GenericProperties)
            {
                var isUploadField = false;
                try
                {
                    if (p.PropertyType.DataTypeDefinition.DataType.Id == uploadField.Id
                         &amp;&amp; p.Value.ToString() != &quot;&quot;
                         &amp;&amp; File.Exists(global::Umbraco.Core.IO.IOHelper.MapPath(p.Value.ToString())))
                    {
                        isUploadField = true;
                    }
                }
                catch (ArgumentException)
                {
                    //the data type definition may not exist anymore at this point because another thread may
                    //have deleted it.
                    isUploadField = false;
                }
                if (isUploadField)
                {
                    var relativeFilePath = fs.GetRelativePath(p.Value.ToString());
                    var parentDirectory = System.IO.Path.GetDirectoryName(relativeFilePath);

                    // don&#39;t want to delete the media folder if not using directories.
                    if (UmbracoConfig.For.UmbracoSettings().Content.UploadAllowDirectories &amp;&amp; parentDirectory != fs.GetRelativePath(&quot;/&quot;))
                    {
                        //issue U4-771: if there is a parent directory the recursive parameter should be true
                        fs.DeleteDirectory(parentDirectory, String.IsNullOrEmpty(parentDirectory) == false);
                    }
                    else
                    {
                        fs.DeleteFile(relativeFilePath, true);
                    }
                }
            }
        }

        #endregion

        #region Private Methods

        /// &lt;summary&gt;
        /// Clears the locally loaded properties which forces them to be reloaded next time they requested
        /// &lt;/summary&gt;
        private void ClearLoadedProperties()
        {
            _loadedProperties = null;
        }

        /// &lt;summary&gt;
        /// Makes sure that the properties are initialized. If they are already initialized, this does nothing.
        /// &lt;/summary&gt;
        private void EnsureProperties()
        {
            if (_loadedProperties == null)
            {
                InitializeProperties();
            }
        }

        /// &lt;summary&gt;
        /// Loads all properties from database into objects. If this method is re-called, it will re-query the database.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// This optimizes sql calls. This will first check if all of the properties have been loaded. If not, 
        /// then it will query for all property types for the current version from the db. It will then iterate over each
        /// cmdPropertyData row and store the id and propertyTypeId in a list for lookup later. Once the records have been 
        /// read, we iterate over the cached property types for this ContentType and create a new property based on
        /// our stored list of proeprtyTypeIds. We then have a cached list of Property objects which will get returned
        /// on all subsequent calls and is also used to return a property with calls to getProperty.
        /// &lt;/remarks&gt;
        private void InitializeProperties()
        {
            _loadedProperties = new Properties();

            if (ContentBase != null)
            {
                //NOTE: we will not load any properties where HasIdentity = false - this is because if properties are 
                // added to the property collection that aren&#39;t persisted we&#39;ll get ysods
                _loadedProperties.AddRange(ContentBase.Properties.Where(x =&gt; x.HasIdentity).Select(x =&gt; new Property(x)));
                return;
            }

            if (this.ContentType == null)
                return;

            //Create anonymous typed list with 2 props, Id and PropertyTypeId of type Int.
            //This will still be an empty list since the props list is empty.
            var propData = _loadedProperties.Select(x =&gt; new { Id = 0, PropertyTypeId = 0 }).ToList();

            string sql = @&quot;select id, propertyTypeId from cmsPropertyData where versionId=@versionId&quot;;

            using (var sqlHelper = Application.SqlHelper)
            using (IRecordsReader dr = sqlHelper.ExecuteReader(sql,
                sqlHelper.CreateParameter(&quot;@versionId&quot;, Version)))
            {
                while (dr.Read())
                {
                    //add the item to our list
                    propData.Add(new { Id = dr.Get&lt;int&gt;(&quot;id&quot;), PropertyTypeId = dr.Get&lt;int&gt;(&quot;propertyTypeId&quot;) });
                }
            }

            foreach (PropertyType pt in this.ContentType.PropertyTypes)
            {
                if (pt == null)
                    continue;

                //get the propertyId
                var property = propData.LastOrDefault(x =&gt; x.PropertyTypeId == pt.Id);
                if (property == null)
                {
                    continue;
                    //var prop = Property.MakeNew(pt, this, Version);
                    //property = new {Id = prop.Id, PropertyTypeId = pt.Id};
                }
                var propertyId = property.Id;

                Property p = null;
                try
                {
                    p = new Property(propertyId, pt);
                }
                catch
                {
                    continue; //this remains from old code... not sure why we would do this?
                }

                _loadedProperties.Add(p);
            }
        }

        /// &lt;summary&gt;
        /// Optimized method for bulk deletion of properties�on a Content object.
        /// &lt;/summary&gt;
        protected void deleteAllProperties()
        {
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;Delete from cmsPropertyData where contentNodeId = @nodeId&quot;, sqlHelper.CreateParameter(&quot;@nodeId&quot;, this.Id));
        }

        private XmlNode importXml()
        {
            XmlDocument xmlDoc = new XmlDocument();
            using (var sqlHelper = Application.SqlHelper)
            using (var doc = sqlHelper.ExecuteXmlReader(&quot;select xml from cmsContentXml where nodeID = &quot; + this.Id.ToString()))
                xmlDoc.Load(doc);

            return xmlDoc.FirstChild;
        }

        /// &lt;summary&gt;
        /// Indication if the Content exists in at least one version.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;Returns true if the Content has a version&lt;/returns&gt;
        private bool hasVersion()
        {
            using (var sqlHelper = Application.SqlHelper)
            {
                int versionCount = sqlHelper.ExecuteScalar&lt;int&gt;(&quot;select Count(Id) as tmp from cmsContentVersion where contentId = &quot; + this.Id.ToString());
                return (versionCount &gt; 0);
            }
        }

        #endregion

        #region XmlPreivew

        public override XmlNode ToPreviewXml(XmlDocument xd)
        {
            if (!PreviewExists(Version))
            {
                saveXmlPreview(xd);
            }
            return GetPreviewXml(xd, Version);
        }

        private void saveXmlPreview(XmlDocument xd)
        {
            SavePreviewXml(generateXmlWithoutSaving(xd), Version);
        }
        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[44,9,44,53,0],[44,9,44,53,0],[44,9,44,53,0],[44,9,44,53,1],[44,9,44,53,0],[44,9,44,53,0],[44,9,44,53,0],[52,15,52,49,0],[53,9,53,10,0],[54,9,54,10,0],[56,34,56,42,0],[56,43,56,44,0],[56,45,56,46,0],[58,51,58,68,0],[58,69,58,70,0],[58,71,58,72,0],[60,38,60,46,0],[60,47,60,48,0],[60,49,60,50,0],[62,52,62,69,0],[62,70,62,71,0],[62,72,62,73,0],[64,61,64,73,0],[64,74,64,75,0],[64,76,64,77,0],[67,15,67,32,1],[68,9,68,10,1],[69,13,69,39,1],[70,13,70,44,1],[71,13,71,51,1],[72,13,72,44,1],[73,9,73,10,1],[86,9,86,10,0],[87,13,87,44,0],[88,13,88,109,0],[89,13,89,48,0],[89,48,89,54,0],[89,54,89,68,0],[89,68,89,82,0],[89,82,89,85,0],[89,13,89,85,0],[91,13,91,101,0],[92,13,92,46,0],[92,46,92,52,0],[92,52,92,66,0],[92,66,92,80,0],[92,80,92,83,0],[92,13,92,83,0],[94,13,94,35,0],[95,9,95,10,0],[104,9,104,10,0],[105,13,105,100,0],[106,13,106,33,0],[107,13,107,14,0],[108,17,108,45,0],[111,13,111,96,0],[112,13,112,39,0],[113,9,113,10,0],[124,17,124,18,0],[124,19,124,85,0],[124,86,124,87,0],[133,13,133,14,1],[134,24,134,61,1],[135,17,135,18,1],[136,21,136,46,1],[137,21,137,22,1],[138,25,140,76,1],[141,25,141,39,1],[142,29,142,41,0],[144,25,144,84,1],[145,29,145,41,0],[148,25,148,26,1],[149,29,149,75,1],[150,25,150,26,1],[151,25,151,30,0],[152,25,152,26,0],[153,29,153,41,0],[155,21,155,22,1],[156,17,156,18,1],[157,17,157,37,1],[158,13,158,14,1],[160,13,160,14,0],[161,17,161,38,0],[162,13,162,14,0],[180,13,180,14,0],[181,17,181,74,0],[182,21,182,65,0],[183,17,183,57,0],[184,13,184,14,0],[186,13,186,14,0],[187,17,187,42,0],[188,13,188,14,0],[197,13,197,14,0],[198,17,198,46,0],[199,17,199,18,0],[201,21,201,45,0],[202,21,202,22,0],[204,32,204,69,0],[205,25,205,26,0],[206,29,206,144,0],[207,29,207,73,0],[208,29,208,30,0],[209,33,209,77,0],[210,33,210,66,0],[212,33,212,166,0],[213,29,213,30,0],[214,25,214,26,0],[215,21,215,22,0],[217,21,217,50,0],[218,21,218,22,0],[220,32,220,69,0],[221,25,221,26,0],[222,29,223,130,0],[224,29,224,43,0],[225,29,225,30,0],[226,33,226,61,0],[227,29,227,30,0],[229,29,229,30,0],[230,33,230,109,0],[231,29,231,30,0],[232,25,232,26,0],[233,21,233,22,0],[234,17,234,18,0],[235,17,235,37,0],[236,13,236,14,0],[238,13,238,14,0],[239,17,239,38,0],[240,17,240,48,0],[241,13,241,14,0],[250,13,250,14,0],[251,17,251,36,0],[252,17,252,42,0],[253,13,253,14,0],[263,13,263,14,0],[264,17,264,36,0],[265,17,265,52,0],[266,13,266,14,0],[275,13,275,14,1],[276,17,276,44,1],[277,17,277,18,0],[278,21,279,55,0],[281,28,281,65,0],[282,28,282,76,0],[283,21,283,22,0],[284,25,284,40,0],[285,29,285,51,0],[287,29,287,64,0],[288,21,288,22,0],[289,17,289,18,0],[290,17,290,33,1],[291,13,291,14,1],[292,17,292,18,0],[292,19,292,36,0],[292,37,292,38,0],[303,9,303,10,0],[304,13,304,25,0],[306,13,306,37,0],[307,9,307,10,0],[315,9,315,10,0],[316,13,316,32,0],[318,13,318,59,0],[318,59,318,88,0],[318,88,318,90,0],[318,13,318,90,0],[319,9,319,10,0],[327,9,327,10,0],[328,13,328,32,0],[330,13,330,59,0],[330,59,330,85,0],[330,85,330,87,0],[330,13,330,87,0],[331,9,331,10,0],[340,9,340,10,0],[341,13,341,37,0],[343,13,343,67,0],[345,9,345,10,0],[354,9,354,10,0],[355,13,355,30,0],[356,13,356,14,0],[357,17,357,56,0],[361,17,361,18,0],[362,28,362,65,0],[363,28,363,133,0],[364,21,364,22,0],[365,25,365,79,0],[366,25,366,26,0],[367,29,367,45,0],[368,29,368,54,0],[369,25,369,26,0],[370,21,370,22,0],[371,17,371,18,0],[372,17,372,22,0],[373,17,373,18,0],[374,17,374,18,0],[378,17,378,34,0],[379,17,379,18,0],[380,21,380,57,0],[381,21,381,40,0],[382,17,382,18,0],[384,13,384,14,0],[386,13,386,51,0],[388,13,388,22,0],[389,13,389,14,0],[390,17,390,44,0],[391,17,391,24,0],[391,26,391,55,0],[391,56,391,58,0],[391,59,391,65,0],[392,17,392,18,0],[394,21,394,22,0],[395,25,395,74,0],[396,21,396,22,0],[397,21,397,43,0],[398,21,398,22,0],[399,25,399,126,0],[400,21,400,22,0],[401,17,401,18,0],[402,13,402,14,0],[404,13,404,22,0],[406,9,406,10,0],[412,9,412,10,0],[413,20,413,57,0],[414,17,414,142,0],[415,9,415,10,0],[422,9,422,10,0],[423,13,423,59,0],[424,9,424,10,0],[427,9,427,10,0],[428,13,428,48,0],[429,13,429,20,0],[429,22,429,41,0],[429,42,429,44,0],[429,45,429,50,0],[430,17,430,103,0],[431,21,431,48,0],[434,13,434,87,0],[435,13,435,94,0],[436,13,436,97,0],[437,13,437,32,0],[438,17,438,103,0],[440,17,440,83,0],[441,13,441,93,0],[442,13,442,98,0],[443,13,443,42,0],[444,17,444,109,0],[445,13,445,78,0],[446,13,446,101,0],[447,13,447,110,0],[448,13,448,107,0],[449,13,449,84,0],[450,13,450,35,0],[451,17,451,114,0],[452,13,452,91,0],[453,13,453,42,0],[454,17,454,106,0],[455,13,455,80,0],[457,13,457,22,0],[458,13,458,14,0],[460,17,460,46,0],[461,17,461,24,0],[461,26,461,35,0],[461,36,461,38,0],[461,39,461,47,0],[462,21,462,54,0],[463,13,463,14,0],[464,9,464,10,0],[470,9,470,10,0],[471,13,471,37,0],[474,13,474,40,0],[477,20,477,57,0],[478,17,478,93,0],[481,20,481,57,0],[482,17,482,105,0],[485,20,485,57,0],[486,17,486,142,0],[489,20,489,57,0],[490,17,490,95,0],[493,13,493,27,0],[494,9,494,10,0],[506,9,506,10,0],[509,13,509,45,0],[510,13,510,32,0],[512,13,512,41,0],[513,9,513,10,0],[524,9,524,10,0],[525,13,525,37,0],[527,13,527,38,0],[528,17,528,76,0],[530,13,530,36,0],[531,13,531,44,0],[532,13,532,52,0],[533,9,533,10,0],[540,9,540,10,0],[541,20,541,57,0],[542,17,542,129,0],[543,13,543,44,0],[544,9,544,10,0],[551,9,551,10,0],[552,13,552,50,0],[553,13,553,14,0],[554,17,554,44,0],[555,13,555,14,0],[557,13,557,37,0],[559,13,559,46,0],[560,13,560,48,0],[563,20,563,57,0],[564,17,565,72,0],[567,13,567,64,0],[568,13,568,20,0],[568,22,568,50,0],[568,51,568,53,0],[568,54,568,57,0],[569,13,569,14,0],[570,17,570,38,0],[571,17,571,36,0],[572,17,572,18,0],[574,21,574,22,0],[575,25,575,69,0],[576,21,576,22,0],[577,21,577,26,0],[577,27,577,28,0],[577,29,577,30,0],[578,17,578,18,0],[579,17,579,72,0],[580,17,580,67,0],[580,68,580,87,0],[581,13,581,14,0],[582,13,582,39,0],[583,13,583,31,0],[584,9,584,10,0],[587,9,587,10,0],[588,13,588,157,0],[589,13,589,74,0],[590,13,590,43,0],[591,13,591,22,0],[592,9,592,10,0],[600,9,600,10,0],[602,20,602,57,0],[603,13,603,14,0],[604,17,605,90,0],[607,17,607,28,0],[608,21,608,90,0],[610,21,610,93,0],[612,17,614,89,0],[615,13,615,14,0],[616,9,616,10,0],[623,9,623,10,0],[626,13,626,97,0],[627,13,627,114,0],[629,13,629,20,0],[629,22,629,32,0],[629,33,629,35,0],[629,36,629,53,0],[630,13,630,14,0],[631,17,631,43,0],[633,17,633,18,0],[634,21,636,103,0],[637,21,637,22,0],[638,25,638,46,0],[639,21,639,22,0],[640,17,640,18,0],[641,17,641,42,0],[642,17,642,18,0],[645,21,645,43,0],[646,17,646,18,0],[647,17,647,35,0],[648,17,648,18,0],[649,21,649,83,0],[650,21,650,93,0],[653,21,653,138,0],[654,21,654,22,0],[656,25,656,109,0],[657,21,657,22,0],[659,21,659,22,0],[660,25,660,63,0],[661,21,661,22,0],[662,17,662,18,0],[663,13,663,14,0],[664,9,664,10,0],[674,9,674,10,0],[675,13,675,38,0],[676,9,676,10,0],[682,9,682,10,0],[683,13,683,43,0],[684,13,684,14,0],[685,17,685,40,0],[686,13,686,14,0],[687,9,687,10,0],[701,9,701,10,0],[702,13,702,50,0],[704,13,704,37,0],[705,13,705,14,0],[708,17,708,78,0],[708,78,708,91,0],[708,91,708,105,0],[708,105,708,120,0],[708,120,708,123,0],[708,17,708,123,0],[709,17,709,24,0],[712,13,712,42,0],[713,17,713,24,0],[717,13,717,58,0],[717,58,717,92,0],[717,92,717,103,0],[717,13,717,103,0],[719,13,719,103,0],[721,20,721,57,0],[722,20,723,66,0],[724,13,724,14,0],[725,17,725,34,0],[726,17,726,18,0],[728,21,728,114,0],[729,17,729,18,0],[730,13,730,14,0],[732,13,732,20,0],[732,22,732,37,0],[732,38,732,40,0],[732,41,732,71,0],[733,13,733,14,0],[734,17,734,32,0],[735,21,735,30,0],[738,17,738,60,0],[738,60,738,85,0],[738,85,738,87,0],[738,17,738,87,0],[739,17,739,38,0],[740,17,740,18,0],[741,21,741,30,0],[745,17,745,46,0],[747,17,747,35,0],[749,17,749,18,0],[750,21,750,54,0],[751,17,751,18,0],[752,17,752,22,0],[753,17,753,18,0],[754,21,754,30,0],[757,17,757,42,0],[758,13,758,14,0],[759,9,759,10,0],[765,9,765,10,0],[766,20,766,57,0],[767,17,767,151,0],[768,9,768,10,0],[771,9,771,10,0],[772,13,772,52,0],[773,20,773,57,0],[774,20,774,126,0],[775,17,775,34,0],[777,13,777,38,0],[778,9,778,10,0],[785,9,785,10,0],[786,20,786,57,0],[787,13,787,14,0],[788,17,788,155,0],[789,17,789,43,0],[791,9,791,10,0],[798,9,798,10,0],[799,13,799,41,0],[800,13,800,14,0],[801,17,801,36,0],[802,13,802,14,0],[803,13,803,47,0],[804,9,804,10,0],[807,9,807,10,0],[808,13,808,67,0],[809,9,809,10,0]]);
    </script>
  </body>
</html>