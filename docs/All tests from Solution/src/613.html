<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\developer\Packages\SubmitPackage.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Collections.Generic;

using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;

namespace umbraco.presentation.developer.packages {
    public partial class SubmitPackage : BasePages.UmbracoEnsuredPage {

        public SubmitPackage()
        {
            CurrentApp = BusinessLogic.DefaultApps.developer.ToString();

        }
        private cms.businesslogic.packager.PackageInstance pack;
        private cms.businesslogic.packager.CreatedPackage createdPackage;

        protected void Page_Load(object sender, EventArgs e) {

            if(!String.IsNullOrEmpty(helper.Request(&quot;id&quot;))){

                if (!IsPostBack) {
                    dd_repositories.Items.Clear();

                    dd_repositories.Items.Add(new ListItem(&quot;Choose a repository...&quot;, &quot;&quot;));

                    List&lt;cms.businesslogic.packager.repositories.Repository&gt; repos = cms.businesslogic.packager.repositories.Repository.getAll();

                    if (repos.Count == 1) {
                        ListItem li = new ListItem(repos[0].Name, repos[0].Guid);
                        li.Selected = true;

                        dd_repositories.Items.Add(li);
                        
                        pl_repoChoose.Visible = false;
                        pl_repoLogin.Style.Clear();
                        
                        privateRepoHelp.Visible = false;
                        publicRepoHelp.Style.Clear();

                    } else if (repos.Count == 0) {
                        Response.Redirect(&quot;editpackage.aspx?id=&quot; + helper.Request(&quot;id&quot;));
                    } else {

                        foreach (cms.businesslogic.packager.repositories.Repository repo in repos) {
                            dd_repositories.Items.Add(new ListItem(repo.Name, repo.Guid));
                        }

                        dd_repositories.Items[0].Selected = true;

                        dd_repositories.Attributes.Add(&quot;onChange&quot;, &quot;onRepoChange()&quot;);

                    }
                }

                createdPackage = cms.businesslogic.packager.CreatedPackage.GetById(int.Parse(helper.Request(&quot;id&quot;)));
                pack = createdPackage.Data;

                if (pack.Url != &quot;&quot;) {
                    Panel1.Text = &quot;Submit &#39;&quot; + pack.Name + &quot;&#39; to a repository&quot;;
                }
            }
        }

        protected void submitPackage(object sender, EventArgs e) {

            Page.Validate();
            string feedback = &quot;&quot;;

            if (Page.IsValid) {

                try {
                    var repo = cms.businesslogic.packager.repositories.Repository.getByGuid(dd_repositories.SelectedValue);

                    if (repo == null)
                    {
                        throw new InvalidOperationException(&quot;Could not find repository with id &quot; + dd_repositories.SelectedValue);
                    }
                    
                    var memberKey = repo.Webservice.authenticate(tb_email.Text, library.md5(tb_password.Text));

                    byte[] doc = new byte[0];

                    if (fu_doc.HasFile)
                        doc = fu_doc.FileBytes;



                    if (memberKey != &quot;&quot;) {

                        string result = repo.SubmitPackage(memberKey, pack, doc).ToString().ToLower();

                        switch (result) {
                            case &quot;complete&quot;:
                                feedback = &quot;Your package has been submitted successfully. It will be reviewed by the package repository administrator before it&#39;s publicly available&quot;;
                                fb_feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.success;
                                break;
                            case &quot;error&quot;:
                                feedback = &quot;There was a general error submitting your package to the repository. This can be due to general communitations error or too much traffic. Please try again later&quot;;
                                fb_feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.error;
                                break;
                            case &quot;exists&quot;:
                                feedback = &quot;This package has already been submitted to the repository. You cannot submit it again. If you have updates for a package, you should contact the repositor administrator to submit an update&quot;;
                                fb_feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.error;
                                break;
                            case &quot;noaccess&quot;:
                                feedback = &quot;Authentication failed, You do not have access to this repository. Contact your package repository administrator&quot;;
                                fb_feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.error;
                                break;
                            default:
                                break;
                        }

                        if (result == &quot;complete&quot;) {
                            Pane1.Visible = false;
                            Pane2.Visible = false;
                            submitControls.Visible = false;
                            feedbackControls.Visible = true;
                        } else {
                            Pane1.Visible = true;
                            Pane2.Visible = true;
                            submitControls.Visible = true;
                            feedbackControls.Visible = false;
                        }

                    } else {
                        feedback = &quot;Authentication failed, You do not have access to this repository. Contact your package repository administrator&quot;;
                        fb_feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.error;
                    }
                } catch {
                    feedback = &quot;Authentication failed, or the repository is currently off-line. Contact your package repository administrator&quot;;
                    fb_feedback.type = global::umbraco.uicontrols.Feedback.feedbacktype.error;
                }

                fb_feedback.Text = feedback;
            }



        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,31,0],[18,9,18,10,0],[19,13,19,73,0],[21,9,21,10,0],[25,62,25,63,0],[27,13,27,60,0],[27,60,27,61,0],[29,17,29,33,0],[29,34,29,35,0],[30,21,30,51,0],[32,21,32,91,0],[34,21,34,146,0],[36,21,36,42,0],[36,43,36,44,0],[37,25,37,82,0],[38,25,38,44,0],[40,25,40,55,0],[42,25,42,55,0],[43,25,43,52,0],[45,25,45,57,0],[46,25,46,54,0],[48,21,48,22,0],[48,28,48,49,0],[48,50,48,51,0],[49,25,49,90,0],[50,21,50,22,0],[50,28,50,29,0],[52,25,52,32,0],[52,34,52,89,0],[52,90,52,92,0],[52,93,52,98,0],[52,100,52,101,0],[53,29,53,91,0],[54,25,54,26,0],[56,25,56,66,0],[58,25,58,86,0],[60,21,60,22,0],[61,17,61,18,0],[63,17,63,117,0],[64,17,64,44,0],[66,17,66,36,0],[66,37,66,38,0],[67,21,67,80,0],[68,17,68,18,0],[69,13,69,14,0],[70,9,70,10,0],[72,66,72,67,0],[74,13,74,29,0],[75,13,75,34,0],[77,13,77,30,0],[77,31,77,32,0],[79,21,79,22,0],[80,21,80,124,0],[82,21,82,38,0],[83,21,83,22,0],[84,25,84,131,0],[87,21,87,112,0],[89,21,89,46,0],[91,21,91,40,0],[92,25,92,48,0],[96,21,96,41,0],[96,42,96,43,0],[98,25,98,103,0],[100,25,100,40,0],[102,33,102,183,0],[103,33,103,109,0],[104,33,104,39,0],[106,33,106,207,0],[107,33,107,107,0],[108,33,108,39,0],[110,33,110,235,0],[111,33,111,107,0],[112,33,112,39,0],[114,33,114,158,0],[115,33,115,107,0],[116,33,116,39,0],[118,33,118,39,0],[121,25,121,50,0],[121,51,121,52,0],[122,29,122,51,0],[123,29,123,51,0],[124,29,124,60,0],[125,29,125,61,0],[126,25,126,26,0],[126,32,126,33,0],[127,29,127,50,0],[128,29,128,50,0],[129,29,129,59,0],[130,29,130,62,0],[131,25,131,26,0],[133,21,133,22,0],[133,28,133,29,0],[134,25,134,150,0],[135,25,135,99,0],[136,21,136,22,0],[137,17,137,18,0],[137,19,137,24,0],[137,25,137,26,0],[138,21,138,144,0],[139,21,139,95,0],[140,17,140,18,0],[142,17,142,45,0],[143,13,143,14,0],[147,9,147,10,0]]);
    </script>
  </body>
</html>