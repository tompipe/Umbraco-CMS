<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Security\Identity\AuthenticationOptionsExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using Microsoft.Owin;
using Microsoft.Owin.Security;
using Umbraco.Core;
using Umbraco.Core.Logging;

namespace Umbraco.Web.Security.Identity
{
    public static class AuthenticationOptionsExtensions
    {

        /// &lt;summary&gt;
        /// When trying to implement an Azure AD B2C provider or other OAuth provider that requires a customized Challenge Result in order to work then
        /// this must be used.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;authOptions&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;authProperties&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// See: http://issues.umbraco.org/issue/U4-7353
        /// &lt;/remarks&gt;
        public static void SetSignInChallengeResultCallback(
            this AuthenticationOptions authOptions,
            Func&lt;IOwinContext, AuthenticationProperties&gt; authProperties)
        {   
            authOptions.Description.Properties[&quot;ChallengeResultCallback&quot;] = authProperties;
        }
        
        public static AuthenticationProperties GetSignInChallengeResult(this AuthenticationDescription authenticationDescription, IOwinContext ctx)
        {
            if (authenticationDescription.Properties.ContainsKey(&quot;ChallengeResultCallback&quot;) == false) return null;
            var cb = authenticationDescription.Properties[&quot;ChallengeResultCallback&quot;] as Func&lt;IOwinContext, AuthenticationProperties&gt;;
            if (cb == null) return null;
            return cb(ctx);
        }

        /// &lt;summary&gt;
        /// Used during the External authentication process to assign external sign-in options
        /// that are used by the Umbraco authentication process.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;authOptions&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;options&quot;&gt;&lt;/param&gt;
        public static void SetExternalSignInAutoLinkOptions(
            this AuthenticationOptions authOptions,
            ExternalSignInAutoLinkOptions options)
        {
            authOptions.Description.Properties[&quot;ExternalSignInAutoLinkOptions&quot;] = options;
        }

        /// &lt;summary&gt;
        /// Used during the External authentication process to retrieve external sign-in options
        /// that have been set with SetExternalAuthenticationOptions
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;authenticationDescription&quot;&gt;&lt;/param&gt;
        public static ExternalSignInAutoLinkOptions GetExternalAuthenticationOptions(this AuthenticationDescription authenticationDescription)
        {
            if (authenticationDescription.Properties.ContainsKey(&quot;ExternalSignInAutoLinkOptions&quot;) == false) return null;
            var options = authenticationDescription.Properties[&quot;ExternalSignInAutoLinkOptions&quot;] as ExternalSignInAutoLinkOptions;
            return options;
        }

        /// &lt;summary&gt;
        /// Configures the properties of the authentication description instance for use with Umbraco back office
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;options&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;style&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;icon&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;callbackPath&quot;&gt;
        /// This is important if the identity provider is to be able to authenticate when upgrading Umbraco. We will try to extract this from
        /// any options passed in via reflection since none of the default OWIN providers inherit from a base class but so far all of them have a consistent
        /// name for the &#39;CallbackPath&#39; property which is of type PathString. So we&#39;ll try to extract it if it&#39;s not found or supplied.
        /// 
        /// If a value is extracted or supplied, this will be added to an internal list which the UmbracoModule will use to allow the request to pass
        /// through without redirecting to the installer.
        /// &lt;/param&gt;
        public static void ForUmbracoBackOffice(this AuthenticationOptions options, string style, string icon, string callbackPath = null)
        {
            Mandate.ParameterNotNullOrEmpty(options.AuthenticationType, &quot;options.AuthenticationType&quot;);

            //Ensure the prefix is set
            if (options.AuthenticationType.StartsWith(Constants.Security.BackOfficeExternalAuthenticationTypePrefix) == false)
            {
                options.AuthenticationType = Constants.Security.BackOfficeExternalAuthenticationTypePrefix + options.AuthenticationType;    
            }

            options.Description.Properties[&quot;SocialStyle&quot;] = style;
            options.Description.Properties[&quot;SocialIcon&quot;] = icon;

            //flag for use in back office
            options.Description.Properties[&quot;UmbracoBackOffice&quot;] = true;

            if (callbackPath.IsNullOrWhiteSpace())
            {
                try
                {
                    //try to get it with reflection
                    var prop = options.GetType().GetProperty(&quot;CallbackPath&quot;);
                    if (prop != null &amp;&amp; TypeHelper.IsTypeAssignableFrom&lt;PathString&gt;(prop.PropertyType))
                    {
                        //get the value
                        var path = (PathString) prop.GetValue(options);
                        if (path.HasValue)
                        {
                            UmbracoModule.ReservedPaths.TryAdd(path.ToString());
                        }
                    }
                }
                catch (System.Exception ex)
                {
                    LogHelper.Error(typeof (AuthenticationOptionsExtensions), &quot;Could not read AuthenticationOptions properties&quot;, ex);
                }
            }
            else
            {
                UmbracoModule.ReservedPaths.TryAdd(callbackPath);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,0],[25,13,25,92,0],[26,9,26,10,0],[29,9,29,10,0],[30,13,30,102,0],[30,103,30,115,0],[31,13,31,134,0],[32,13,32,28,0],[32,29,32,41,0],[33,13,33,28,0],[34,9,34,10,0],[45,9,45,10,0],[46,13,46,91,0],[47,9,47,10,0],[55,9,55,10,0],[56,13,56,108,0],[56,109,56,121,0],[57,13,57,130,0],[58,13,58,28,0],[59,9,59,10,0],[76,9,76,10,0],[77,13,77,103,0],[80,13,80,127,0],[81,13,81,14,0],[82,17,82,137,0],[83,13,83,14,0],[85,13,85,67,0],[86,13,86,65,0],[89,13,89,72,0],[91,13,91,51,0],[92,13,92,14,0],[94,17,94,18,0],[96,21,96,78,0],[97,21,97,104,0],[98,21,98,22,0],[100,25,100,72,0],[101,25,101,43,0],[102,25,102,26,0],[103,29,103,81,0],[104,25,104,26,0],[105,21,105,22,0],[106,17,106,18,0],[107,17,107,44,0],[108,17,108,18,0],[109,21,109,134,0],[110,17,110,18,0],[111,13,111,14,0],[113,13,113,14,0],[114,17,114,66,0],[115,13,115,14,0],[116,9,116,10,0]]);
    </script>
  </body>
</html>