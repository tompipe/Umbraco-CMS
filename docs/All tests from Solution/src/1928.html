<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\PropertyFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;

namespace Umbraco.Core.Persistence.Factories
{
    internal class PropertyFactory
    {
        private readonly PropertyType[] _compositionTypeProperties;
        private readonly Guid _version;
        private readonly int _id;
        private readonly DateTime _createDate;
        private readonly DateTime _updateDate;

        public PropertyFactory(PropertyType[] compositionTypeProperties, Guid version, int id)
        {
            _compositionTypeProperties = compositionTypeProperties;
            _version = version;
            _id = id;
        }

        public PropertyFactory(PropertyType[] compositionTypeProperties, Guid version, int id, DateTime createDate, DateTime updateDate)
        {
            _compositionTypeProperties = compositionTypeProperties;
            _version = version;
            _id = id;
            _createDate = createDate;
            _updateDate = updateDate;
        }

        public static IEnumerable&lt;Property&gt; BuildEntity(IReadOnlyCollection&lt;PropertyDataDto&gt; dtos, PropertyType[] compositionTypeProperties, DateTime createDate, DateTime updateDate)
        {
            var properties = new List&lt;Property&gt;();

            foreach (var propertyType in compositionTypeProperties)
            {
                var propertyDataDto = dtos.LastOrDefault(x =&gt; x.PropertyTypeId == propertyType.Id);
                var property = propertyDataDto == null
                                   ? propertyType.CreatePropertyFromValue(null)
                                   : propertyType.CreatePropertyFromRawValue(propertyDataDto.GetValue,
                                                                             propertyDataDto.VersionId.Value,
                                                                             propertyDataDto.Id);
                try
                {
                    //on initial construction we don&#39;t want to have dirty properties tracked
                    property.DisableChangeTracking();

                    property.CreateDate = createDate;
                    property.UpdateDate = updateDate;
                    // http://issues.umbraco.org/issue/U4-1946
                    property.ResetDirtyProperties(false);
                    properties.Add(property);
                }
                finally
                {
                    property.EnableChangeTracking();
                }

            }

            return properties;
        }

        [Obsolete(&quot;Use the static method instead, there&#39;s no reason to allocate one of these classes everytime we want to map values&quot;)]
        public IEnumerable&lt;Property&gt; BuildEntity(PropertyDataDto[] dtos)
        {
            return BuildEntity(dtos, _compositionTypeProperties, _createDate, _updateDate);
        }

        public IEnumerable&lt;PropertyDataDto&gt; BuildDto(IEnumerable&lt;Property&gt; properties)
        {
            var propertyDataDtos = new List&lt;PropertyDataDto&gt;();

            foreach (var property in properties)
            {
                var dto = new PropertyDataDto { NodeId = _id, PropertyTypeId = property.PropertyTypeId, VersionId = _version };

                //Check if property has an Id and set it, so that it can be updated if it already exists
                if (property.HasIdentity)
                {
                    dto.Id = property.Id;
                }

                if (property.DataTypeDatabaseType == DataTypeDatabaseType.Integer)
                {
                    if (property.Value is bool || property.PropertyType.PropertyEditorAlias == Constants.PropertyEditors.TrueFalseAlias)
                    {
                        dto.Integer = property.Value != null &amp;&amp; string.IsNullOrEmpty(property.Value.ToString())
                                          ? 0
                                          : Convert.ToInt32(property.Value);
                    }
                    else
                    {
                        int val;
                        if ((property.Value != null &amp;&amp; string.IsNullOrWhiteSpace(property.Value.ToString()) == false) &amp;&amp; int.TryParse(property.Value.ToString(), out val))
                        {
                            dto.Integer = val;
                        }
                    }
                }
                else if (property.DataTypeDatabaseType == DataTypeDatabaseType.Decimal &amp;&amp; property.Value != null)
                {
                    decimal val;
                    if (decimal.TryParse(property.Value.ToString(), out val))
                    {
                        dto.Decimal = val; // property value should be normalized already
                    }
                }
                else if (property.DataTypeDatabaseType == DataTypeDatabaseType.Date &amp;&amp; property.Value != null &amp;&amp; string.IsNullOrWhiteSpace(property.Value.ToString()) == false)
                {
                    DateTime date;
                    if (DateTime.TryParse(property.Value.ToString(), out date))
                    {
                        dto.Date = date;
                    }
                }
                else if (property.DataTypeDatabaseType == DataTypeDatabaseType.Ntext &amp;&amp; property.Value != null)
                {
                    dto.Text = property.Value.ToString();
                }
                else if (property.DataTypeDatabaseType == DataTypeDatabaseType.Nvarchar &amp;&amp; property.Value != null)
                {
                    dto.VarChar = property.Value.ToString();
                }

                propertyDataDtos.Add(dto);
            }
            return propertyDataDtos;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,95,1],[18,9,18,10,1],[19,13,19,68,1],[20,13,20,32,1],[21,13,21,22,1],[22,9,22,10,1],[24,9,24,137,0],[25,9,25,10,0],[26,13,26,68,0],[27,13,27,32,0],[28,13,28,22,0],[29,13,29,38,0],[30,13,30,38,0],[31,9,31,10,0],[34,9,34,10,1],[35,13,35,51,1],[37,13,37,20,1],[37,22,37,38,1],[37,39,37,41,1],[37,42,37,67,1],[38,13,38,14,1],[39,17,39,63,1],[39,63,39,98,1],[39,98,39,100,1],[39,17,39,100,1],[40,17,44,98,1],[46,17,46,18,1],[48,21,48,54,1],[50,21,50,54,1],[51,21,51,54,1],[53,21,53,58,1],[54,21,54,46,1],[55,17,55,18,1],[57,17,57,18,1],[58,21,58,53,1],[59,17,59,18,1],[61,13,61,14,1],[63,13,63,31,1],[64,9,64,10,1],[68,9,68,10,0],[69,13,69,92,0],[70,9,70,10,0],[73,9,73,10,1],[74,13,74,64,1],[76,13,76,20,1],[76,22,76,34,1],[76,35,76,37,1],[76,38,76,48,1],[77,13,77,14,1],[78,17,78,128,1],[81,17,81,42,1],[82,17,82,18,1],[83,21,83,42,1],[84,17,84,18,1],[86,17,86,83,1],[87,17,87,18,1],[88,21,88,137,1],[89,21,89,22,1],[90,25,92,77,1],[93,21,93,22,1],[95,21,95,22,1],[97,25,97,171,1],[98,25,98,26,1],[99,29,99,47,1],[100,25,100,26,1],[101,21,101,22,1],[102,17,102,18,1],[103,22,103,114,1],[104,17,104,18,1],[106,21,106,78,1],[107,21,107,22,1],[108,25,108,43,1],[109,21,109,22,1],[110,17,110,18,1],[111,22,111,176,1],[112,17,112,18,1],[114,21,114,80,1],[115,21,115,22,1],[116,25,116,41,1],[117,21,117,22,1],[118,17,118,18,1],[119,22,119,112,1],[120,17,120,18,1],[121,21,121,58,1],[122,17,122,18,1],[123,22,123,115,1],[124,17,124,18,1],[125,21,125,61,1],[126,17,126,18,1],[128,17,128,43,1],[129,13,129,14,1],[130,13,130,37,1],[131,9,131,10,1]]);
    </script>
  </body>
</html>