<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Dictionary\UmbracoCultureDictionary.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Dynamic;
using System.Globalization;
using System.Linq;
using System.Web;
using Umbraco.Core.Logging;
using umbraco.cms.businesslogic;
using umbraco.cms.businesslogic.language;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Models;
using Umbraco.Core.Services;

namespace Umbraco.Web.Dictionary
{

    /// &lt;summary&gt;
    /// A culture dictionary that uses the Umbraco ILocalizationService
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// TODO: The ICultureDictionary needs to represent the &#39;fast&#39; way to do dictionary item retrieval - for front-end and back office.
    /// The ILocalizationService is the service used for interacting with this data from the database which isn&#39;t all that fast 
    /// (even though there is caching involved, if there&#39;s lots of dictionary items the caching is not great)
    /// &lt;/remarks&gt;
	public class DefaultCultureDictionary : Umbraco.Core.Dictionary.ICultureDictionary
	{
	    private readonly ILocalizationService _localizationService;
        private readonly ICacheProvider _requestCacheProvider;
        private readonly CultureInfo _specificCulture = null;

	    public DefaultCultureDictionary()
            : this(ApplicationContext.Current.Services.LocalizationService, ApplicationContext.Current.ApplicationCache.RequestCache)
	    {
	        
	    }

	    public DefaultCultureDictionary(ILocalizationService localizationService, ICacheProvider requestCacheProvider)
	    {
	        if (localizationService == null) throw new ArgumentNullException(&quot;localizationService&quot;);
	        if (requestCacheProvider == null) throw new ArgumentNullException(&quot;requestCacheProvider&quot;);
	        _localizationService = localizationService;
	        _requestCacheProvider = requestCacheProvider;
	    }

        public DefaultCultureDictionary(CultureInfo specificCulture)
            : this(ApplicationContext.Current.Services.LocalizationService, ApplicationContext.Current.ApplicationCache.RequestCache)
        {
            if (specificCulture == null) throw new ArgumentNullException(&quot;specificCulture&quot;);
            _specificCulture = specificCulture;
        }

        public DefaultCultureDictionary(CultureInfo specificCulture, ILocalizationService localizationService, ICacheProvider requestCacheProvider)
        {
            if (specificCulture == null) throw new ArgumentNullException(&quot;specificCulture&quot;);
            if (localizationService == null) throw new ArgumentNullException(&quot;localizationService&quot;);
            if (requestCacheProvider == null) throw new ArgumentNullException(&quot;requestCacheProvider&quot;);
            _localizationService = localizationService;
            _requestCacheProvider = requestCacheProvider;
            _specificCulture = specificCulture;
        }

	    /// &lt;summary&gt;
		/// Returns the dictionary value based on the key supplied
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;key&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public string this[string key]
		{
			get
			{
			    var found = _localizationService.GetDictionaryItemByKey(key);
			    if (found == null)
			    {
			        return string.Empty;
			    }

			    var byLang = found.Translations.FirstOrDefault(x =&gt; x.Language.Equals(Language));
			    if (byLang == null)
			    {
			        return string.Empty;
			    }

			    return byLang.Value;
			}
		}

		/// &lt;summary&gt;
		/// Returns the current culture
		/// &lt;/summary&gt;
		public CultureInfo Culture
		{
		    get { return _specificCulture ?? System.Threading.Thread.CurrentThread.CurrentUICulture; }
		}

        /// &lt;summary&gt;
        /// Returns the child dictionary entries for a given key
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// NOTE: The result of this is not cached anywhere - the underlying repository does not cache 
        /// the child lookups because that is done by a query lookup. This method isn&#39;t used in our codebase
        /// so I don&#39;t think this is a performance issue but if devs are using this it could be optimized here.
        /// &lt;/remarks&gt;
        public IDictionary&lt;string, string&gt; GetChildren(string key)
        {
            var result = new Dictionary&lt;string, string&gt;();

            var found = _localizationService.GetDictionaryItemByKey(key);
            if (found == null)
            {
                return result;
            }

            var children = _localizationService.GetDictionaryItemChildren(found.Key);
            if (children == null)
            {
                return result;
            }

            foreach (var dictionaryItem in children)
            {
                var byLang = dictionaryItem.Translations.FirstOrDefault((x =&gt; x.Language.Equals(Language)));
                if (byLang != null)
                {
                    result.Add(dictionaryItem.ItemKey, byLang.Value);
                }
            }

            return result;
        }

        private ILanguage Language
		{
            get
            {
                //ensure it&#39;s stored/retrieved from request cache
                //NOTE: This is no longer necessary since these are cached at the runtime level, but we can leave it here for now.
                return _requestCacheProvider.GetCacheItem&lt;ILanguage&gt;(typeof (DefaultCultureDictionary).Name + &quot;Culture&quot; + Culture.Name,
                    () =&gt; _localizationService.GetLanguageByIsoCode(Culture.Name));
            }
		}
	}

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,62,0],[30,9,30,62,0],[33,15,33,134,0],[34,6,34,7,0],[36,6,36,7,0],[38,6,38,116,0],[39,6,39,7,0],[40,10,40,42,0],[40,43,40,98,0],[41,10,41,43,0],[41,44,41,100,0],[42,10,42,53,0],[43,10,43,55,0],[44,6,44,7,0],[47,15,47,134,0],[48,9,48,10,0],[49,13,49,41,0],[49,42,49,93,0],[50,13,50,48,0],[51,9,51,10,0],[53,9,53,148,0],[54,9,54,10,0],[55,13,55,41,0],[55,42,55,93,0],[56,13,56,45,0],[56,46,56,101,0],[57,13,57,46,0],[57,47,57,103,0],[58,13,58,56,0],[59,13,59,58,0],[60,13,60,48,0],[61,9,61,10,0],[71,4,71,5,0],[72,8,72,69,0],[73,8,73,26,0],[74,8,74,9,0],[75,12,75,32,0],[78,8,78,60,0],[78,60,78,87,0],[78,87,78,89,0],[78,8,78,89,0],[79,8,79,27,0],[80,8,80,9,0],[81,12,81,32,0],[84,8,84,28,0],[85,4,85,5,0],[93,11,93,12,0],[93,13,93,95,0],[93,96,93,97,0],[107,9,107,10,0],[108,13,108,59,0],[110,13,110,74,0],[111,13,111,31,0],[112,13,112,14,0],[113,17,113,31,0],[116,13,116,86,0],[117,13,117,34,0],[118,13,118,14,0],[119,17,119,31,0],[122,13,122,20,0],[122,22,122,40,0],[122,41,122,43,0],[122,44,122,52,0],[123,13,123,14,0],[124,17,124,79,0],[124,79,124,106,0],[124,106,124,109,0],[124,17,124,109,0],[125,17,125,36,0],[126,17,126,18,0],[127,21,127,70,0],[128,17,128,18,0],[129,13,129,14,0],[131,13,131,27,0],[132,9,132,10,0],[137,13,137,14,0],[140,17,141,27,0],[141,27,141,82,0],[141,82,141,84,0],[140,17,141,84,0],[142,13,142,14,0]]);
    </script>
  </body>
</html>