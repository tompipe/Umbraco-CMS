<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\MultiNodeTreePicker\MNTP_DataType.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web;
using System.Xml;
using System.Xml.Linq;
using umbraco.cms.businesslogic.datatype;
using umbraco.interfaces;

namespace umbraco.editorControls.MultiNodeTreePicker
{
    /// &lt;summary&gt;
    /// Multi-node tree picker data type
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class MNTP_DataType : AbstractDataEditor
    {

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;MNTP_DataType&quot;/&gt; class.
        /// &lt;/summary&gt;
        public MNTP_DataType()
        {
            RenderControl = m_Tree;
            m_Tree.Init += Tree_Init;
            m_Tree.Load += Tree_Load;
            DataEditorControl.OnSave += DataEditorControl_OnSave;

        }

        private umbraco.interfaces.IData m_Data;

        /// &lt;summary&gt;
        /// The internal tree picker control to render
        /// &lt;/summary&gt;
        private readonly MNTP_DataEditor m_Tree = new MNTP_DataEditor();

        /// &lt;summary&gt;
        /// Internal pre value editor to render
        /// &lt;/summary&gt;
        private MNTP_PrevalueEditor m_PreValues;

        ///&lt;summary&gt;
        ///&lt;/summary&gt;
        public override Guid Id
        {
            get
            {
                return new Guid(DataTypeGuids.MultiNodeTreePickerId);
            }
        }

        ///&lt;summary&gt;
        ///&lt;/summary&gt;
        public override string DataTypeName
        {
            get
            {
                return &quot;Multi-Node Tree Picker&quot;;
            }
        }

        ///&lt;summary&gt;
        ///&lt;/summary&gt;
        public override IData Data
        {
            get
            {
                if (this.m_Data == null)
                {
                    m_Data = StoreAsCommaDelimited
                                 ? new umbraco.cms.businesslogic.datatype.DefaultData(this)
                                 : new XmlData(this);
                }

                return m_Data;
            }

        }

        /// &lt;summary&gt;
        /// Value indicating whether to store as comma separated or Xml
        /// &lt;/summary&gt;
        public bool StoreAsCommaDelimited
        {
            get
            {
                return ((MNTP_PrevalueEditor)PrevalueEditor).StoreAsCommaDelimited;
            }
        }

        /// &lt;summary&gt;
        /// Initialize the tree, here&#39;s where we can set some initial properties for the tree
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        private void Tree_Init(object sender, EventArgs e)
        {
            var preVal = ((MNTP_PrevalueEditor)PrevalueEditor);
            m_Tree.TreeToRender = preVal.SelectedTreeType;
            m_Tree.XPathFilter = preVal.XPathFilter;
            m_Tree.MaxNodeCount = preVal.MaxNodeCount;
            m_Tree.ShowToolTips = preVal.ShowToolTip;
            m_Tree.XPathFilterMatchType = preVal.XPathFilterMatchType;
            m_Tree.StartNodeId = preVal.StartNodeId;
            m_Tree.DataTypeDefinitionId = DataTypeDefinitionId;
            m_Tree.ShowThumbnailsForMedia = preVal.ShowThumbnailsForMedia;
            m_Tree.PropertyName = this.DataTypeName;
            m_Tree.StartNodeSelectionType = preVal.StartNodeSelectionType;
            m_Tree.StartNodeXPathExpression = preVal.StartNodeXPathExpression;
            m_Tree.StartNodeXPathExpressionType = preVal.StartNodeXPathExpressionType;
            m_Tree.ControlHeight = preVal.ControlHeight;
            m_Tree.MinNodeCount = preVal.MinNodeCount;


        }

        /// &lt;summary&gt;
        /// Set the data source for the editor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        private void Tree_Load(object sender, EventArgs e)
        {
            if (!m_Tree.Page.IsPostBack)
            {
                // set the value of the control
                if (Data.Value != null &amp;&amp; !string.IsNullOrEmpty(Data.Value.ToString()))
                {
                    var strVal = this.Data.Value.ToString();

                    //check how the data is stored
                    if (StoreAsCommaDelimited)
                    {
                        //need to check if it was XML, if so, we&#39;ll clear the data (Error checkign)
                        if (!strVal.StartsWith(&quot;&lt;&quot;))
                        {
                            m_Tree.SelectedIds = this.Data.Value.ToString().Split(&#39;,&#39;);
                        }
                        else
                        {
                            //this must have been saved as XML before, we&#39;ll reset it but this will cause a loss of data
                            m_Tree.SelectedIds = new string[] { };
                        }
                    }
                    else
                    {
                        try
                        {
                            var xmlDoc = XDocument.Parse(this.Data.Value.ToString());
                            m_Tree.XmlValue = xmlDoc;
                        }
                        catch (XmlException)
                        {
                            //not a valid xml doc, must have been saved as csv before.
                            //set to empty val, this will cause a loss of data
                            m_Tree.XmlValue = null;
                        }
                    }
                }
            }

        }

        /// &lt;summary&gt;
        /// Handle the saving event, need to give data to Umbraco
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The source of the event.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;System.EventArgs&quot; /&gt; instance containing the event data.&lt;/param&gt;
        private void DataEditorControl_OnSave(EventArgs e)
        {
            string val;
            if (StoreAsCommaDelimited)
            {
                val = string.Join(&quot;,&quot;, m_Tree.SelectedIds);
            }
            else
            {
                val = m_Tree.XmlValue == null ? string.Empty : m_Tree.XmlValue.ToString();
            }

            Data.Value = !string.IsNullOrEmpty(val) ? val : null;
        }

        /// &lt;summary&gt;
        /// return a custom pre value editor
        /// &lt;/summary&gt;
        public override IDataPrevalue PrevalueEditor
        {
            get
            {
                return m_PreValues ?? (m_PreValues = new MNTP_PrevalueEditor(this));
            }
        }

        internal const string PersistenceCookieName = &quot;MultiNodeTreePicker&quot;;

        /// &lt;summary&gt;
        /// Helper method to ensure the pesistence cookie is cleared.
        /// This is used on app startup and after editing the pre-value editor
        /// &lt;/summary&gt;
        internal static void ClearCookiePersistence()
        {
            if (HttpContext.Current == null)
            {
                return;
            }

            if (HttpContext.Current.Response.Cookies[PersistenceCookieName] != null)
            {
                HttpContext.Current.Response.Cookies[PersistenceCookieName].Expires = DateTime.Now.AddDays(-1);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,31,0],[21,9,21,10,0],[22,13,22,36,0],[23,13,23,38,0],[24,13,24,38,0],[25,13,25,66,0],[27,9,27,10,0],[34,9,34,73,0],[46,13,46,14,0],[47,17,47,70,0],[48,13,48,14,0],[56,13,56,14,0],[57,17,57,49,0],[58,13,58,14,0],[66,13,66,14,0],[67,17,67,41,0],[68,17,68,18,0],[69,21,71,54,0],[72,17,72,18,0],[74,17,74,31,0],[75,13,75,14,0],[85,13,85,14,0],[86,17,86,84,0],[87,13,87,14,0],[96,9,96,10,0],[97,13,97,64,0],[98,13,98,59,0],[99,13,99,53,0],[100,13,100,55,0],[101,13,101,54,0],[102,13,102,71,0],[103,13,103,53,0],[104,13,104,64,0],[105,13,105,75,0],[106,13,106,53,0],[107,13,107,75,0],[108,13,108,79,0],[109,13,109,87,0],[110,13,110,57,0],[111,13,111,55,0],[114,9,114,10,0],[122,9,122,10,0],[123,13,123,41,0],[124,13,124,14,0],[126,17,126,88,0],[127,17,127,18,0],[128,21,128,61,0],[131,21,131,47,0],[132,21,132,22,0],[134,25,134,53,0],[135,25,135,26,0],[136,29,136,88,0],[137,25,137,26,0],[139,25,139,26,0],[141,29,141,67,0],[142,25,142,26,0],[143,21,143,22,0],[145,21,145,22,0],[147,25,147,26,0],[148,29,148,86,0],[149,29,149,54,0],[150,25,150,26,0],[151,25,151,45,0],[152,25,152,26,0],[155,29,155,52,0],[156,25,156,26,0],[157,21,157,22,0],[158,17,158,18,0],[159,13,159,14,0],[161,9,161,10,0],[169,9,169,10,0],[171,13,171,39,0],[172,13,172,14,0],[173,17,173,60,0],[174,13,174,14,0],[176,13,176,14,0],[177,17,177,91,0],[178,13,178,14,0],[180,13,180,66,0],[181,9,181,10,0],[189,13,189,14,0],[190,17,190,85,0],[191,13,191,14,0],[201,9,201,10,0],[202,13,202,45,0],[203,13,203,14,0],[204,17,204,24,0],[207,13,207,85,0],[208,13,208,14,0],[209,17,209,112,0],[210,13,210,14,0],[211,9,211,10,0]]);
    </script>
  </body>
</html>