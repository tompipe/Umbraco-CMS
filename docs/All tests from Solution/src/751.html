<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Templates\TemplateUtilities.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Text.RegularExpressions;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;

namespace Umbraco.Web.Templates
{
    //NOTE: I realize there is only one class in this namespace but I&#39;m pretty positive that there will be more classes in 
    //this namespace once we start migrating and cleaning up more code.

    /// &lt;summary&gt;
    /// Utility class used for templates
    /// &lt;/summary&gt;
    public static class TemplateUtilities
    {
        //TODO: Pass in an Umbraco context!!!!!!!! Don&#39;t rely on the singleton so things are more testable
        internal static string ParseInternalLinks(string text, bool preview)
        {
            // save and set for url provider
            var inPreviewMode = UmbracoContext.Current.InPreviewMode;
            UmbracoContext.Current.InPreviewMode = preview;

            try
            {
                text = ParseInternalLinks(text);
            }
            finally
            {
                // restore
                UmbracoContext.Current.InPreviewMode = inPreviewMode;
            }

            return text;
        }

        /// &lt;summary&gt;
        /// Parses the string looking for the {localLink} syntax and updates them to their correct links.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string ParseInternalLinks(string text)
        {
            //TODO: Pass in an Umbraco context!!!!!!!! Don&#39;t rely on the singleton so things are more testable, better yet, pass in urlprovider, routing context, separately

            //don&#39;t attempt to proceed without a context as we cannot lookup urls without one
            if (UmbracoContext.Current == null || UmbracoContext.Current.RoutingContext == null)
            {
                return text;
            }

            var urlProvider = UmbracoContext.Current.UrlProvider;

            // Parse internal links
            var tags = Regex.Matches(text, @&quot;href=&quot;&quot;[/]?(?:\{|\%7B)localLink:([0-9]+)(?:\}|\%7D)&quot;, RegexOptions.IgnoreCase | RegexOptions.IgnorePatternWhitespace);
            foreach (Match tag in tags)
                if (tag.Groups.Count &gt; 0)
                {
                    var id = tag.Groups[1].Value; //.Remove(tag.Groups[1].Value.Length - 1, 1);
                    var newLink = urlProvider.GetUrl(int.Parse(id));
                    text = text.Replace(tag.Value, &quot;href=\&quot;&quot; + newLink);
                }

            return text;
        }

        // static compiled regex for faster performance
        private readonly static Regex ResolveUrlPattern = new Regex(&quot;(=[\&quot;\&#39;]?)(\\W?\\~(?:.(?![\&quot;\&#39;]?\\s+(?:\\S+)=|[&gt;\&quot;\&#39;]))+.)[\&quot;\&#39;]?&quot;,
            RegexOptions.Compiled | RegexOptions.IgnoreCase | RegexOptions.IgnorePatternWhitespace);

        /// &lt;summary&gt;
        /// The RegEx matches any HTML attribute values that start with a tilde (~), those that match are passed to ResolveUrl to replace the tilde with the application path.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// When used with a Virtual-Directory set-up, this would resolve all URLs correctly.
        /// The recommendation is that the &quot;ResolveUrlsFromTextString&quot; option (in umbracoSettings.config) is set to false for non-Virtual-Directory installs.
        /// &lt;/remarks&gt;
        public static string ResolveUrlsFromTextString(string text)
        {
            if (UmbracoConfig.For.UmbracoSettings().Content.ResolveUrlsFromTextString == false) return text;

            using (var timer = DisposableTimer.DebugDuration(typeof(IOHelper), &quot;ResolveUrlsFromTextString starting&quot;, &quot;ResolveUrlsFromTextString complete&quot;))
            {
                // find all relative urls (ie. urls that contain ~)
                var tags = ResolveUrlPattern.Matches(text);
                LogHelper.Debug(typeof(IOHelper), &quot;After regex: &quot; + timer.Stopwatch.ElapsedMilliseconds + &quot; matched: &quot; + tags.Count);
                foreach (Match tag in tags)
                {
                    var url = &quot;&quot;;
                    if (tag.Groups[1].Success)
                        url = tag.Groups[1].Value;

                    // The richtext editor inserts a slash in front of the url. That&#39;s why we need this little fix
                    //                if (url.StartsWith(&quot;/&quot;))
                    //                    text = text.Replace(url, ResolveUrl(url.Substring(1)));
                    //                else
                    if (String.IsNullOrEmpty(url) == false)
                    {
                        var resolvedUrl = (url.Substring(0, 1) == &quot;/&quot;) ? IOHelper.ResolveUrl(url.Substring(1)) : IOHelper.ResolveUrl(url);
                        text = text.Replace(url, resolvedUrl);
                    }
                }
            }

            return text;
        }

        public static string CleanForXss(string text, params char[] ignoreFromClean)
        {
            return text.CleanForXss(ignoreFromClean);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,0],[22,13,22,70,0],[23,13,23,60,0],[26,13,26,14,0],[27,17,27,49,0],[28,13,28,14,0],[30,13,30,14,0],[32,17,32,70,0],[33,13,33,14,0],[35,13,35,25,0],[36,9,36,10,0],[44,9,44,10,1],[48,13,48,97,1],[49,13,49,14,0],[50,17,50,29,0],[53,13,53,66,1],[56,13,56,164,1],[57,13,57,20,1],[57,22,57,31,0],[57,32,57,34,1],[57,35,57,39,1],[58,17,58,42,0],[59,17,59,18,0],[60,21,60,50,0],[61,21,61,69,0],[62,21,62,73,0],[63,17,63,18,0],[65,13,65,25,1],[66,9,66,10,1],[69,9,70,101,1],[82,9,82,10,1],[83,13,83,96,1],[83,97,83,109,1],[85,20,85,155,0],[86,13,86,14,0],[88,17,88,60,0],[89,17,89,134,0],[90,17,90,24,0],[90,26,90,35,0],[90,36,90,38,0],[90,39,90,43,0],[91,17,91,18,0],[92,21,92,34,0],[93,21,93,47,0],[94,25,94,51,0],[100,21,100,60,0],[101,21,101,22,0],[102,25,102,139,0],[103,25,103,63,0],[104,21,104,22,0],[105,17,105,18,0],[106,13,106,14,0],[108,13,108,25,0],[109,9,109,10,1],[112,9,112,10,0],[113,13,113,54,0],[114,9,114,10,0]]);
    </script>
  </body>
</html>