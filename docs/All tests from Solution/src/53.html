<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\PublishedContent\DynamicDocumentTestsBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Dynamics;
using Umbraco.Core.Models.PublishedContent;
using Umbraco.Core.PropertyEditors;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.PublishedContent
{
	[TestFixture]
    public abstract class DynamicDocumentTestsBase&lt;TDocument, TDocumentList&gt; : PublishedContentTestBase
	{
        private IUmbracoSettingsSection _umbracoSettings;

        public override void Initialize()
        {
            // required so we can access property.Value
            //PropertyValueConvertersResolver.Current = new PropertyValueConvertersResolver();

            base.Initialize();

            //generate new mock settings and assign so we can configure in individual tests
            _umbracoSettings = SettingsForTests.GenerateMockSettings();
            SettingsForTests.ConfigureSettings(_umbracoSettings);

            var scriptingMock = Mock.Get(_umbracoSettings.Scripting);
            scriptingMock.Setup(x =&gt; x.DataTypeModelStaticMappings).Returns(new List&lt;IRazorStaticMapping&gt;());

            // need to specify a custom callback for unit tests
            // AutoPublishedContentTypes generates properties automatically
            // when they are requested, but we must declare those that we
            // explicitely want to be here...

            var propertyTypes = new[]
                {
                    // AutoPublishedContentType will auto-generate other properties
                    new PublishedPropertyType(&quot;umbracoNaviHide&quot;, 0, &quot;?&quot;), 
                    new PublishedPropertyType(&quot;selectedNodes&quot;, 0, &quot;?&quot;), 
                    new PublishedPropertyType(&quot;umbracoUrlAlias&quot;, 0, &quot;?&quot;), 
                    new PublishedPropertyType(&quot;content&quot;, 0, Constants.PropertyEditors.TinyMCEAlias), 
                    new PublishedPropertyType(&quot;testRecursive&quot;, 0, &quot;?&quot;), 
                    new PublishedPropertyType(&quot;siteTitle&quot;, 0, &quot;?&quot;), 
                    new PublishedPropertyType(&quot;creatorName&quot;, 0, &quot;?&quot;), 
                    new PublishedPropertyType(&quot;blah&quot;, 0, &quot;?&quot;), // ugly error when that one is missing...
                };
            var type = new AutoPublishedContentType(0, &quot;anything&quot;, propertyTypes);
            PublishedContentType.GetPublishedContentTypeCallback = (alias) =&gt; type;

        }
        
        protected override string GetXmlContent(int templateId)
		{
			return @&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;
&lt;!DOCTYPE root[ 
&lt;!ELEMENT Home ANY&gt;
&lt;!ATTLIST Home id ID #REQUIRED&gt;
&lt;!ELEMENT CustomDocument ANY&gt;
&lt;!ATTLIST CustomDocument id ID #REQUIRED&gt;
]&gt;
&lt;root id=&quot;&quot;-1&quot;&quot;&gt;
	&lt;Home id=&quot;&quot;1046&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; nodeName=&quot;&quot;Home&quot;&quot; urlName=&quot;&quot;home&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
		&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;umbracoUrlAlias&gt;&lt;![CDATA[this/is/my/alias, anotheralias]]&gt;&lt;/umbracoUrlAlias&gt;
		&lt;umbracoNaviHide&gt;1&lt;/umbracoNaviHide&gt;
        &lt;siteTitle&gt;&lt;![CDATA[This is my site]]&gt;&lt;/siteTitle&gt;
		&lt;Home id=&quot;&quot;1173&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; nodeName=&quot;&quot;Sub1&quot;&quot; urlName=&quot;&quot;sub1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;content&gt;&lt;![CDATA[&lt;div&gt;This is some content&lt;/div&gt;]]&gt;&lt;/content&gt;
			&lt;umbracoUrlAlias&gt;&lt;![CDATA[page2/alias, 2ndpagealias]]&gt;&lt;/umbracoUrlAlias&gt;			
			&lt;Home id=&quot;&quot;1174&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:07:54&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:27&quot;&quot; nodeName=&quot;&quot;Sub2&quot;&quot; urlName=&quot;&quot;sub2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1174&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;umbracoUrlAlias&gt;&lt;![CDATA[only/one/alias]]&gt;&lt;/umbracoUrlAlias&gt;
				&lt;creatorName&gt;&lt;![CDATA[Custom data with same property name as the member name]]&gt;&lt;/creatorName&gt;
			&lt;/Home&gt;			
			&lt;CustomDocument id=&quot;&quot;1177&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;custom sub 1&quot;&quot; urlName=&quot;&quot;custom-sub-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1177&quot;&quot; isDoc=&quot;&quot;&quot;&quot; /&gt;
			&lt;CustomDocument id=&quot;&quot;1178&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;3&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-16T14:23:35&quot;&quot; nodeName=&quot;&quot;custom sub 2&quot;&quot; urlName=&quot;&quot;custom-sub-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1178&quot;&quot; isDoc=&quot;&quot;&quot;&quot; /&gt;
            &lt;Home id=&quot;&quot;1176&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;4&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;sub-3&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1176&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[some content]]&gt;&lt;/content&gt;
				&lt;blah&gt;&lt;![CDATA[some content]]&gt;&lt;/blah&gt;
                &lt;umbracoNaviHide&gt;1&lt;/umbracoNaviHide&gt;
			&lt;/Home&gt;
		&lt;/Home&gt;
		&lt;Home id=&quot;&quot;1175&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;3&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub 2&quot;&quot; urlName=&quot;&quot;sub-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1175&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;/Home&gt;
		&lt;CustomDocument id=&quot;&quot;4444&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;4&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;Test&quot;&quot; urlName=&quot;&quot;test-page&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,4444&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;selectedNodes&gt;&lt;![CDATA[1172,1176,1173]]&gt;&lt;/selectedNodes&gt;
			&lt;CustomDocument id=&quot;&quot;5555&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;Test&quot;&quot; urlName=&quot;&quot;test-page&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,4444,5555&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;/CustomDocument&gt;
		&lt;/CustomDocument&gt;
	&lt;/Home&gt;
	&lt;CustomDocument id=&quot;&quot;1172&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId + @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;Test&quot;&quot; urlName=&quot;&quot;test-page&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1172&quot;&quot; isDoc=&quot;&quot;&quot;&quot; /&gt;
&lt;/root&gt;&quot;;
		}

		/// &lt;summary&gt;
		/// Returns the dynamic node/document to run tests against
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		protected abstract dynamic GetDynamicNode(int id);

        [Test]
        public void Recursive_Property()
        {
            var doc = GetDynamicNode(1174);
            var prop = doc.GetProperty(&quot;siteTitle&quot;, true);
            Assert.IsNotNull(prop);
            Assert.AreEqual(&quot;This is my site&quot;, prop.Value);
            prop = doc.GetProperty(&quot;_siteTitle&quot;); //test with underscore prefix
            Assert.IsNotNull(prop);
            Assert.AreEqual(&quot;This is my site&quot;, prop.Value);
            Assert.AreEqual(&quot;This is my site&quot;, doc._siteTitle);
        }

        /// &lt;summary&gt;
        /// Tests the internal instance level caching of returning properties
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// http://issues.umbraco.org/issue/U4-1824
        /// http://issues.umbraco.org/issue/U4-1825
        /// &lt;/remarks&gt;
        [Test]
        public void Can_Return_Property_And_Value()
        {
            var doc = GetDynamicNode(1173);

            Assert.IsTrue(doc.HasProperty(Constants.Conventions.Content.UrlAlias));
            var prop = doc.GetProperty(Constants.Conventions.Content.UrlAlias);
            Assert.IsNotNull(prop);
            Assert.AreEqual(&quot;page2/alias, 2ndpagealias&quot;, prop.Value);
            Assert.AreEqual(&quot;page2/alias, 2ndpagealias&quot;, doc.umbracoUrlAlias);
        }

        /// &lt;summary&gt;
        /// Tests the IsLast method with the result set from a Where statement
        /// &lt;/summary&gt;
        [Test]
        public void Is_Last_From_Where_Filter()
        {
            var doc = GetDynamicNode(1173);

            foreach (var d in doc.Children.Where(&quot;Visible&quot;))
            {
                if (d.Id != 1178)
                {
                    Assert.IsFalse(d.IsLast());
                }
                else
                {
                    Assert.IsTrue(d.IsLast());
                }
            }

        }

		[Test]
		public void Single()
		{
			var doc = GetDynamicNode(4444);

			var result = doc.Children().Single();				

			Assert.IsNotNull(result);
			Assert.AreEqual(5555, result.Id);
		}

		[Test]
		public void Single_With_Query()
		{
			var doc = GetDynamicNode(1046);

			var result = doc.Children().Single(&quot;id==1175&quot;);

			Assert.IsNotNull(result);
			Assert.AreEqual(1175, result.Id);
		}

		[Test]
		public void First()
		{
			var doc = GetDynamicNode(1173);

			var result = doc.Children().First();

			Assert.IsNotNull(result);
			Assert.AreEqual(1174, result.Id);
		}

		[Test]
		public void First_With_Query()
		{
			var doc = GetDynamicNode(1173);

			var result = doc.Children().First(&quot;blah==\&quot;some content\&quot;&quot;);

			Assert.IsNotNull(result);
			Assert.AreEqual(1176, result.Id);
		}

		[Test]
		public void Where_User_Property_Value()
		{
			var doc = GetDynamicNode(1173);

			var result = (IEnumerable&lt;dynamic&gt;)doc.Children().Where(&quot;blah==\&quot;some content\&quot;&quot;);

			Assert.IsNotNull(result);
			Assert.AreEqual(1, result.Count());
			Assert.AreEqual(1176, result.Single().Id);		
		}

		[Test]
		public void String_ContainsValue_Extension_Method()
		{
			var doc = GetDynamicNode(1046);

			var paramVals = new Dictionary&lt;string, object&gt; { { &quot;searchId&quot;, 1173 } }; //this is an integer value
			var result = doc.Children()
				.Where(&quot;selectedNodes.ContainsValue(searchId)&quot;, paramVals) //call an extension method
				.FirstOrDefault();

			Assert.IsNotNull(result);
			Assert.AreEqual(4444, result.Id);

			//don&#39;t find!
			paramVals = new Dictionary&lt;string, object&gt; { { &quot;searchId&quot;, 1111777 } };
			result = doc.Children()
				.Where(&quot;selectedNodes.ContainsValue(searchId)&quot;, paramVals)
				.FirstOrDefault();

			Assert.IsNotNull(result);
			Assert.IsTrue(result.GetType() == typeof(DynamicNull) || result.GetType() == typeof(umbraco.MacroEngines.DynamicNull));
			//Assert.AreEqual(typeof(DynamicNull), result.GetType());
		}

		[Test]
		public void String_Contains_Method()
		{
			var doc = GetDynamicNode(1046);

			var paramVals = new Dictionary&lt;string, object&gt; { { &quot;searchId&quot;, &quot;1173&quot; } };
			var result = doc.Children()
				.Where(&quot;selectedNodes.Contains(searchId)&quot;, paramVals)
				.FirstOrDefault();

			Assert.IsNotNull(result);
			Assert.AreEqual(4444, result.Id);

			//don&#39;t find!
			paramVals = new Dictionary&lt;string, object&gt; { { &quot;searchId&quot;, &quot;1aaa173&quot; } };
			result = doc.Children()
				.Where(&quot;selectedNodes.Contains(searchId)&quot;, paramVals)
				.FirstOrDefault();

			Assert.IsNotNull(result);
			Assert.IsTrue(result.GetType() == typeof (DynamicNull) || result.GetType() == typeof (umbraco.MacroEngines.DynamicNull));
			//Assert.AreEqual(typeof (DynamicNull), result.GetType());
		}

		[Test]
		public void String_Split_Method()
		{
			var doc = GetDynamicNode(1046);

			var paramVals = new Dictionary&lt;string, object&gt;
				{
					{ &quot;splitTerm&quot;, new char[] { &#39;,&#39; } },
					{ &quot;splitOptions&quot;, StringSplitOptions.RemoveEmptyEntries }
				};
			var result = doc.Children()
				.Where(&quot;selectedNodes.Split(splitTerm, splitOptions).Length == 3&quot;, paramVals)
				.FirstOrDefault();

			Assert.IsNotNull(result);
			Assert.AreEqual(4444, result.Id);
		}

        [Ignore(&quot;We are ignoring this test because currently our ExpressionParser class cannot deal with this... it needs some serious TLC but it is very complex.&quot;)]
		[Test]
		public void Complex_Linq()
		{
			var doc = GetDynamicNode(1173);

			var paramVals = new Dictionary&lt;string, object&gt; {{&quot;splitTerm&quot;, new char[] {&#39;,&#39;}}, {&quot;searchId&quot;, &quot;1173&quot;}};
			var result = doc.Ancestors().OrderBy(&quot;level&quot;)
				.Single()
				.Descendants()
				.Where(&quot;selectedNodes != null &amp;&amp; selectedNodes != String.Empty &amp;&amp; selectedNodes.Split(splitTerm).Contains(searchId)&quot;, paramVals)
				.FirstOrDefault();

			Assert.IsNotNull(result);
			Assert.AreEqual(4444, result.Id);	
		}

		[Test]
		public void Index()
		{
			var doc = GetDynamicNode(1173);
			Assert.AreEqual(0, doc.Index());
			doc = GetDynamicNode(1176);
			Assert.AreEqual(3, doc.Index());
			doc = GetDynamicNode(1177);
			Assert.AreEqual(1, doc.Index());
			doc = GetDynamicNode(1178);
			Assert.AreEqual(2, doc.Index());
		}

		[Test]
		public virtual void Is_First_Root_Nodes()
		{
			var doc = GetDynamicNode(1046); //test root nodes
			Assert.IsTrue(doc.IsFirst());
			doc = GetDynamicNode(1172);
		    Assert.IsFalse(doc.IsFirst());
		}

        [Test]
        public void Is_First()
        {
            var doc = GetDynamicNode(1173); //test normal nodes
            Assert.IsTrue(doc.IsFirst());
            doc = GetDynamicNode(1175);
            Assert.IsFalse(doc.IsFirst());
        }

        [Test]
        public virtual void Is_Not_First_Root_Nodes()
        {
            var doc = GetDynamicNode(1046); //test root nodes
            Assert.IsFalse(doc.IsNotFirst());
            doc = GetDynamicNode(1172);
            Assert.IsTrue(doc.IsNotFirst());
        }

		[Test]
		public void Is_Not_First()
		{		
			var doc = GetDynamicNode(1173); //test normal nodes
			Assert.IsFalse(doc.IsNotFirst());
			doc = GetDynamicNode(1175);
			Assert.IsTrue(doc.IsNotFirst());
		}

        [Test]
        public virtual void Is_Position_Root_Nodes()
        {
            var doc = GetDynamicNode(1046); //test root nodes
            Assert.IsTrue(doc.IsPosition(0));
            doc = GetDynamicNode(1172);
            Assert.IsTrue(doc.IsPosition(1));            
        }

		[Test]
		public void Is_Position()
		{
			var doc = GetDynamicNode(1173); //test normal nodes
			Assert.IsTrue(doc.IsPosition(0));
			doc = GetDynamicNode(1175);
			Assert.IsTrue(doc.IsPosition(1));
		}

		[Test]
		public void Children_GroupBy_DocumentTypeAlias()
		{
			var doc = GetDynamicNode(1046);

			var found1 = doc.Children.GroupBy(&quot;DocumentTypeAlias&quot;);

			var casted = (IEnumerable&lt;IGrouping&lt;object, dynamic&gt;&gt;)(found1);
			Assert.AreEqual(2, casted.Count());
			Assert.AreEqual(2, casted.Single(x =&gt; x.Key.ToString() == &quot;Home&quot;).Count());
			Assert.AreEqual(1, casted.Single(x =&gt; x.Key.ToString() == &quot;CustomDocument&quot;).Count());
		}

		[Test]
		public void Children_Where_DocumentTypeAlias()
		{
			var doc = GetDynamicNode(1046);

			var found1 = doc.Children.Where(&quot;DocumentTypeAlias == \&quot;CustomDocument\&quot;&quot;);
			var found2 = doc.Children.Where(&quot;DocumentTypeAlias == \&quot;Home\&quot;&quot;);

			Assert.AreEqual(1, found1.Count());
			Assert.AreEqual(2, found2.Count());
		}

		[Test]
		public void Children_Where_NodeTypeAlias()
		{
			var doc = GetDynamicNode(1046);

			var found1 = doc.Children.Where(&quot;NodeTypeAlias == \&quot;CustomDocument\&quot;&quot;);
			var found2 = doc.Children.Where(&quot;NodeTypeAlias == \&quot;Home\&quot;&quot;);

			Assert.AreEqual(1, found1.Count());
			Assert.AreEqual(2, found2.Count());
		}

		[Test]
		public void Children_Order_By_Update_Date()
		{
			var asDynamic = GetDynamicNode(1173);

			var ordered = asDynamic.Children.OrderBy(&quot;UpdateDate&quot;);
			var casted = (IEnumerable&lt;TDocument&gt;)ordered;

			var correctOrder = new[] { 1178, 1177, 1174, 1176 };
			for (var i = 0; i &lt; correctOrder.Length ;i++)
			{
				Assert.AreEqual(correctOrder[i], ((dynamic)casted.ElementAt(i)).Id);
			}

		}

		[Test]
		public void Children_Order_By_Update_Date_Descending()
		{
			var asDynamic = GetDynamicNode(1173);

			var ordered = asDynamic.Children.OrderBy(&quot;UpdateDate desc&quot;);
			var casted = (IEnumerable&lt;TDocument&gt;)ordered;

			var correctOrder = new[] { 1176, 1174, 1177, 1178 };
			for (var i = 0; i &lt; correctOrder.Length; i++)
			{
				Assert.AreEqual(correctOrder[i], ((dynamic)casted.ElementAt(i)).Id);
			}

		}

		[Test]
		public void HasProperty()
		{
			var asDynamic = GetDynamicNode(1173);

			var hasProp = asDynamic.HasProperty(Constants.Conventions.Content.UrlAlias);

			Assert.AreEqual(true, (bool)hasProp);

		}

		[Test]
		public void Skip()
		{
			var asDynamic = GetDynamicNode(1173);

			var skip = asDynamic.Children.Skip(2);
			var casted = (IEnumerable&lt;TDocument&gt;)skip;

			Assert.AreEqual(2, casted.Count());
		    Assert.IsTrue(casted.Select(x =&gt; ((dynamic) x).Id).ContainsAll(new dynamic[] {1178, 1176}));

		}

		[Test]
		public void HasValue()
		{
			var asDynamic = GetDynamicNode(1173);

			var hasValue = asDynamic.HasValue(Constants.Conventions.Content.UrlAlias);
			var noValue = asDynamic.HasValue(&quot;blahblahblah&quot;);

			Assert.IsTrue(hasValue);
			Assert.IsFalse(noValue);
		}

		[Test]
		public void Take()
		{
			var asDynamic = GetDynamicNode(1173);
			
			var take = asDynamic.Children.Take(2);
			var casted = (IEnumerable&lt;TDocument&gt;)take;

			Assert.AreEqual(2, casted.Count());
			Assert.IsTrue(casted.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1174, 1177 }));
		}

		[Test]
		public void Ancestors_Where_Visible()
		{
			var asDynamic = GetDynamicNode(1174);

			var whereVisible = asDynamic.Ancestors().Where(&quot;Visible&quot;);
			var casted = (IEnumerable&lt;TDocument&gt;)whereVisible;

			Assert.AreEqual(1, casted.Count());
			
		}

		[Test]
		public void Visible()
		{
			var asDynamicHidden = GetDynamicNode(1046);
			var asDynamicVisible = GetDynamicNode(1173);

			Assert.IsFalse(asDynamicHidden.Visible);
			Assert.IsTrue(asDynamicVisible.Visible);
		}

		[Test]
		public void Ensure_TinyMCE_Converted_Type_User_Property()
		{
			var asDynamic = GetDynamicNode(1173);

			Assert.IsTrue(TypeHelper.IsTypeAssignableFrom&lt;IHtmlString&gt;(asDynamic.Content.GetType()));
			Assert.AreEqual(&quot;&lt;div&gt;This is some content&lt;/div&gt;&quot;, asDynamic.Content.ToString());
		}

		[Test]
		public void Get_Children_With_Pluralized_Alias()
		{
			var asDynamic = GetDynamicNode(1173);

			Action&lt;object&gt; doAssert = d =&gt;
				{
					Assert.IsTrue(TypeHelper.IsTypeAssignableFrom&lt;IEnumerable&gt;(d));
					var casted = (IEnumerable&lt;TDocument&gt;)d;
					Assert.AreEqual(2, casted.Count());
				};

			doAssert(asDynamic.Homes); //pluralized alias
			doAssert(asDynamic.homes); //pluralized alias
			doAssert(asDynamic.CustomDocuments); //pluralized alias			
			doAssert(asDynamic.customDocuments); //pluralized alias
		}

		[Test]
		public void GetPropertyValue_Non_Reflected()
		{
			var asDynamic = GetDynamicNode(1174);

			Assert.AreEqual(&quot;Custom data with same property name as the member name&quot;, asDynamic.GetPropertyValue(&quot;creatorName&quot;));
			Assert.AreEqual(&quot;Custom data with same property name as the member name&quot;, asDynamic.GetPropertyValue(&quot;CreatorName&quot;));
		}

		[Test]
		public void Get_User_Property_With_Same_Name_As_Member_Property()
		{
			var asDynamic = GetDynamicNode(1174);

			Assert.AreEqual(&quot;Custom data with same property name as the member name&quot;, asDynamic.creatorName);

			//because CreatorName is defined on DynamicNode, it will not return the user defined property
			Assert.AreEqual(&quot;admin&quot;, asDynamic.CreatorName);
		}

		[Test]
		public void Get_Member_Property()
		{
			var asDynamic = GetDynamicNode(1173);
			
			Assert.AreEqual((int) 2, (int) asDynamic.Level);
			Assert.AreEqual((int) 2, (int) asDynamic.level);

			Assert.AreEqual((int) 1046, (int) asDynamic.ParentId);
			Assert.AreEqual((int) 1046, (int) asDynamic.parentId);
		}

		[Test]
		public void Get_Children()
		{
			var asDynamic = GetDynamicNode(1173);

			var children = asDynamic.Children;
			Assert.IsTrue(TypeHelper.IsTypeAssignableFrom&lt;IEnumerable&gt;(children));

			var childrenAsList = asDynamic.ChildrenAsList; //test ChildrenAsList too
			Assert.IsTrue(TypeHelper.IsTypeAssignableFrom&lt;IEnumerable&gt;(childrenAsList));

			var castChildren = (IEnumerable&lt;TDocument&gt;)children;
			Assert.AreEqual(4, castChildren.Count());

			var castChildrenAsList = (IEnumerable&lt;TDocument&gt;)childrenAsList;
			Assert.AreEqual(4, castChildrenAsList.Count());
		}

		[Test]
		public void Ancestor_Or_Self()
		{
			var asDynamic = GetDynamicNode(1173);

			var result = asDynamic.AncestorOrSelf();

			Assert.IsNotNull(result);

            // ancestor-or-self has to be self!
            // but that&#39;s not what the &quot;legacy&quot; razor macro engine does...
            if (result is Umbraco.Web.Models.DynamicPublishedContent)
    			Assert.AreEqual(1173, (int)result.Id); // that one works
            else
                Assert.AreEqual(1046, (int)result.Id); // that one still is fubar
		}

		[Test]
		public void Ancestors_Or_Self()
		{
			var asDynamic = GetDynamicNode(1174);

			var result = asDynamic.AncestorsOrSelf();

			Assert.IsNotNull(result);

			var list = (IEnumerable&lt;TDocument&gt;)result;
			Assert.AreEqual(3, list.Count());
			Assert.IsTrue(list.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1174, 1173, 1046 }));
		}

		[Test]
		public void Ancestors()
		{
			var asDynamic = GetDynamicNode(1174);

			var result = asDynamic.Ancestors();

			Assert.IsNotNull(result);

			var list = (IEnumerable&lt;TDocument&gt;)result;
			Assert.AreEqual(2, list.Count());
			Assert.IsTrue(list.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1173, 1046 }));
		}

		[Test]
		public void Descendants_Or_Self()
		{
			var asDynamic = GetDynamicNode(1046);

			var result = asDynamic.DescendantsOrSelf();

			Assert.IsNotNull(result);

			var list = (IEnumerable&lt;TDocument&gt;)result;
			Assert.AreEqual(9, list.Count());
			Assert.IsTrue(list.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1046, 1173, 1174, 1176, 1175, 4444 }));
		}

		[Test]
		public void Descendants()
		{
			var asDynamic = GetDynamicNode(1046);

			var result = asDynamic.Descendants();

			Assert.IsNotNull(result);

			var list = (IEnumerable&lt;TDocument&gt;)result;
			Assert.AreEqual(8, list.Count());
			Assert.IsTrue(list.Select(x =&gt; ((dynamic)x).Id).ContainsAll(new dynamic[] { 1173, 1174, 1176, 1175, 4444 }));
		}

		[Test]
		public void Up()
		{
			var asDynamic = GetDynamicNode(1173);

			var result = asDynamic.Up();

			Assert.IsNotNull(result);

			Assert.AreEqual((int) 1046, (int) result.Id);
		}

		[Test]
		public void Down()
		{
			var asDynamic = GetDynamicNode(1173);

			var result = asDynamic.Down();

			Assert.IsNotNull(result);

			Assert.AreEqual((int) 1174, (int) result.Id);
		}

		[Test]
		public void Next()
		{
			var asDynamic = GetDynamicNode(1173);

			var result = asDynamic.Next();

			Assert.IsNotNull(result);

			Assert.AreEqual((int) 1175, (int) result.Id);
		}

		[Test]
		public void Next_Without_Sibling()
		{
            var asDynamic = GetDynamicNode(1176);

			Assert.IsNull(asDynamic.Next());
		}

		[Test]
		public void Previous_Without_Sibling()
		{
			var asDynamic = GetDynamicNode(1173);

			Assert.IsNull(asDynamic.Previous());
		}

		[Test]
		public void Previous()
		{
			var asDynamic = GetDynamicNode(1176);

			var result = asDynamic.Previous();

			Assert.IsNotNull(result);

            Assert.AreEqual((int)1178, (int)result.Id);
		}
	}

	/// &lt;summary&gt;
	/// Extension methods used in tests
	/// &lt;/summary&gt;
	public static class TestExtensionMethods
	{
		public static bool ContainsValue(this string s, int val)
		{
			return s.Contains(val.ToString());
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[27,13,27,31,1],[30,13,30,72,1],[31,13,31,66,1],[33,13,33,70,1],[34,13,34,110,1],[41,13,52,19,1],[53,13,53,83,1],[54,13,54,79,1],[54,79,54,83,1],[54,83,54,84,1],[54,13,54,84,1],[56,9,56,10,1],[59,3,59,4,1],[60,4,98,10,1],[99,3,99,4,1],[110,9,110,10,1],[111,13,111,44,1],[112,13,112,59,1],[113,13,113,36,1],[114,13,114,60,1],[115,13,115,50,1],[116,13,116,36,1],[117,13,117,60,1],[118,13,118,64,1],[119,9,119,10,1],[130,9,130,10,1],[131,13,131,44,1],[133,13,133,84,1],[134,13,134,80,1],[135,13,135,36,1],[136,13,136,70,1],[137,13,137,79,1],[138,9,138,10,1],[145,9,145,10,1],[146,13,146,44,1],[148,13,148,20,1],[148,22,148,27,1],[148,28,148,30,1],[148,31,148,60,1],[149,13,149,14,1],[150,17,150,34,1],[151,17,151,18,1],[152,21,152,48,1],[153,17,153,18,1],[155,17,155,18,1],[156,21,156,47,1],[157,17,157,18,1],[158,13,158,14,1],[160,9,160,10,1],[164,3,164,4,1],[165,4,165,35,1],[167,4,167,41,1],[169,4,169,29,1],[170,4,170,37,1],[171,3,171,4,1],[175,3,175,4,1],[176,4,176,35,1],[178,4,178,51,1],[180,4,180,29,1],[181,4,181,37,1],[182,3,182,4,1],[186,3,186,4,1],[187,4,187,35,1],[189,4,189,40,1],[191,4,191,29,1],[192,4,192,37,1],[193,3,193,4,1],[197,3,197,4,1],[198,4,198,35,1],[200,4,200,64,1],[202,4,202,29,1],[203,4,203,37,1],[204,3,204,4,1],[208,3,208,4,1],[209,4,209,35,1],[211,4,211,86,1],[213,4,213,29,1],[214,4,214,39,1],[215,4,215,46,1],[216,3,216,4,1],[220,3,220,4,1],[221,4,221,35,1],[223,4,223,76,1],[224,4,226,23,1],[228,4,228,29,1],[229,4,229,37,1],[232,4,232,75,1],[233,4,235,23,1],[237,4,237,29,1],[238,4,238,123,1],[240,3,240,4,1],[244,3,244,4,1],[245,4,245,35,1],[247,4,247,78,1],[248,4,250,23,1],[252,4,252,29,1],[253,4,253,37,1],[256,4,256,77,1],[257,4,259,23,1],[261,4,261,29,1],[262,4,262,125,1],[264,3,264,4,1],[268,3,268,4,1],[269,4,269,35,1],[271,4,275,7,1],[276,4,278,23,1],[280,4,280,29,1],[281,4,281,37,1],[282,3,282,4,1],[287,3,287,4,0],[288,4,288,35,0],[290,4,290,107,0],[291,4,295,23,0],[297,4,297,29,0],[298,4,298,37,0],[299,3,299,4,0],[303,3,303,4,1],[304,4,304,35,1],[305,4,305,36,1],[306,4,306,31,1],[307,4,307,36,1],[308,4,308,31,1],[309,4,309,36,1],[310,4,310,31,1],[311,4,311,36,1],[312,3,312,4,1],[316,3,316,4,1],[317,4,317,35,1],[318,4,318,33,1],[319,4,319,31,1],[320,7,320,37,1],[321,3,321,4,1],[325,9,325,10,1],[326,13,326,44,1],[327,13,327,42,1],[328,13,328,40,1],[329,13,329,43,1],[330,9,330,10,1],[334,9,334,10,1],[335,13,335,44,1],[336,13,336,46,1],[337,13,337,40,1],[338,13,338,45,1],[339,9,339,10,1],[343,3,343,4,1],[344,4,344,35,1],[345,4,345,37,1],[346,4,346,31,1],[347,4,347,36,1],[348,3,348,4,1],[352,9,352,10,1],[353,13,353,44,1],[354,13,354,46,1],[355,13,355,40,1],[356,13,356,46,1],[357,9,357,10,1],[361,3,361,4,1],[362,4,362,35,1],[363,4,363,37,1],[364,4,364,31,1],[365,4,365,37,1],[366,3,366,4,1],[370,3,370,4,1],[371,4,371,35,1],[373,4,373,59,1],[375,4,375,67,1],[376,4,376,39,1],[377,4,377,42,1],[377,42,377,68,1],[377,68,377,79,1],[377,4,377,79,1],[378,4,378,42,1],[378,42,378,78,1],[378,78,378,89,1],[378,4,378,89,1],[379,3,379,4,1],[383,3,383,4,1],[384,4,384,35,1],[386,4,386,79,1],[387,4,387,69,1],[389,4,389,39,1],[390,4,390,39,1],[391,3,391,4,1],[395,3,395,4,1],[396,4,396,35,1],[398,4,398,75,1],[399,4,399,65,1],[401,4,401,39,1],[402,4,402,39,1],[403,3,403,4,1],[407,3,407,4,1],[408,4,408,41,1],[410,4,410,59,1],[411,4,411,49,1],[413,4,413,56,1],[414,9,414,18,1],[414,20,414,43,1],[414,45,414,48,1],[415,4,415,5,1],[416,5,416,73,1],[417,4,417,5,1],[419,3,419,4,1],[423,3,423,4,1],[424,4,424,41,1],[426,4,426,64,1],[427,4,427,49,1],[429,4,429,56,1],[430,9,430,18,1],[430,20,430,43,1],[430,45,430,48,1],[431,4,431,5,1],[432,5,432,73,1],[433,4,433,5,1],[435,3,435,4,1],[439,3,439,4,1],[440,4,440,41,1],[442,4,442,80,1],[444,4,444,41,1],[446,3,446,4,1],[450,3,450,4,1],[451,4,451,41,1],[453,4,453,42,1],[454,4,454,46,1],[456,4,456,39,1],[457,7,457,40,1],[457,40,457,56,1],[457,56,457,99,1],[457,7,457,99,1],[459,3,459,4,1],[463,3,463,4,1],[464,4,464,41,1],[466,4,466,78,1],[467,4,467,53,1],[469,4,469,28,1],[470,4,470,28,1],[471,3,471,4,1],[475,3,475,4,1],[476,4,476,41,1],[478,4,478,42,1],[479,4,479,46,1],[481,4,481,39,1],[482,4,482,37,1],[482,37,482,52,1],[482,52,482,97,1],[482,4,482,97,1],[483,3,483,4,1],[487,3,487,4,1],[488,4,488,41,1],[490,4,490,62,1],[491,4,491,54,1],[493,4,493,39,1],[495,3,495,4,1],[499,3,499,4,1],[500,4,500,47,1],[501,4,501,48,1],[503,4,503,44,1],[504,4,504,44,1],[505,3,505,4,1],[509,3,509,4,1],[510,4,510,41,1],[512,4,512,93,1],[513,4,513,85,1],[514,3,514,4,1],[518,3,518,4,1],[519,4,519,41,1],[521,4,522,5,1],[522,5,522,6,1],[522,6,523,6,1],[523,6,523,69,1],[523,69,524,6,1],[524,6,524,45,1],[524,45,525,6,1],[525,6,525,41,1],[525,41,526,5,1],[526,5,526,6,1],[526,6,526,7,1],[521,4,526,7,1],[528,4,528,30,1],[529,4,529,30,1],[530,4,530,40,1],[531,4,531,40,1],[532,3,532,4,1],[536,3,536,4,1],[537,4,537,41,1],[539,4,539,121,1],[540,4,540,121,1],[541,3,541,4,1],[545,3,545,4,1],[546,4,546,41,1],[548,4,548,101,1],[551,4,551,52,1],[552,3,552,4,1],[556,3,556,4,1],[557,4,557,41,1],[559,4,559,52,1],[560,4,560,52,1],[562,4,562,58,1],[563,4,563,58,1],[564,3,564,4,1],[568,3,568,4,1],[569,4,569,41,1],[571,4,571,38,1],[572,4,572,74,1],[574,4,574,50,1],[575,4,575,80,1],[577,4,577,56,1],[578,4,578,45,1],[580,4,580,68,1],[581,4,581,51,1],[582,3,582,4,1],[586,3,586,4,1],[587,4,587,41,1],[589,4,589,44,1],[591,4,591,29,1],[595,13,595,70,1],[596,8,596,46,1],[598,17,598,55,1],[599,3,599,4,1],[603,3,603,4,1],[604,4,604,41,1],[606,4,606,45,1],[608,4,608,29,1],[610,4,610,46,1],[611,4,611,37,1],[612,4,612,35,1],[612,35,612,50,1],[612,50,612,101,1],[612,4,612,101,1],[613,3,613,4,1],[617,3,617,4,1],[618,4,618,41,1],[620,4,620,39,1],[622,4,622,29,1],[624,4,624,46,1],[625,4,625,37,1],[626,4,626,35,1],[626,35,626,50,1],[626,50,626,95,1],[626,4,626,95,1],[627,3,627,4,1],[631,3,631,4,1],[632,4,632,41,1],[634,4,634,47,1],[636,4,636,29,1],[638,4,638,46,1],[639,4,639,37,1],[640,4,640,35,1],[640,35,640,50,1],[640,50,640,119,1],[640,4,640,119,1],[641,3,641,4,1],[645,3,645,4,1],[646,4,646,41,1],[648,4,648,41,1],[650,4,650,29,1],[652,4,652,46,1],[653,4,653,37,1],[654,4,654,35,1],[654,35,654,50,1],[654,50,654,113,1],[654,4,654,113,1],[655,3,655,4,1],[659,3,659,4,1],[660,4,660,41,1],[662,4,662,32,1],[664,4,664,29,1],[666,4,666,49,1],[667,3,667,4,1],[671,3,671,4,1],[672,4,672,41,1],[674,4,674,34,1],[676,4,676,29,1],[678,4,678,49,1],[679,3,679,4,1],[683,3,683,4,1],[684,4,684,41,1],[686,4,686,34,1],[688,4,688,29,1],[690,4,690,49,1],[691,3,691,4,1],[695,3,695,4,1],[696,13,696,50,1],[698,4,698,36,1],[699,3,699,4,1],[703,3,703,4,1],[704,4,704,41,1],[706,4,706,40,1],[707,3,707,4,1],[711,3,711,4,1],[712,4,712,41,1],[714,4,714,38,1],[716,4,716,29,1],[718,13,718,56,1],[719,3,719,4,1],[728,3,728,4,1],[729,4,729,38,1],[730,3,730,4,1]]);
    </script>
  </body>
</html>