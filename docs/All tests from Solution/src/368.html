<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\UserTypeRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Persistence;

using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class UserTypeRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        private UserTypeRepository CreateRepository(IDatabaseUnitOfWork unitOfWork)
        {
            return new UserTypeRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax);            
        }

        [Test]
        public void Can_Perform_Add_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                var userType = MockedUserType.CreateUserType();

                // Act
                repository.AddOrUpdate(userType);
                unitOfWork.Commit();

                // Assert
                Assert.That(userType.HasIdentity, Is.True);
            }
        }

        [Test]
        public void Can_Perform_Multiple_Adds_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                var userType1 = MockedUserType.CreateUserType(&quot;1&quot;);
                var userType2 = MockedUserType.CreateUserType(&quot;2&quot;);

                // Act
                repository.AddOrUpdate(userType1);
                unitOfWork.Commit();
                repository.AddOrUpdate(userType2);
                unitOfWork.Commit();

                // Assert
                Assert.That(userType1.HasIdentity, Is.True);
                Assert.That(userType2.HasIdentity, Is.True);
            }
        }

        [Test]
        public void Can_Verify_Fresh_Entity_Is_Not_Dirty()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var userType = MockedUserType.CreateUserType();
                repository.AddOrUpdate(userType);
                unitOfWork.Commit();

                // Act
                var resolved = repository.Get(userType.Id);
                bool dirty = ((UserType) resolved).IsDirty();

                // Assert
                Assert.That(dirty, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Update_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var userType = MockedUserType.CreateUserType();
                repository.AddOrUpdate(userType);
                unitOfWork.Commit();

                // Act
                var resolved = repository.Get(userType.Id);
                resolved.Name = &quot;New Name&quot;;
                resolved.Permissions = new[]{&quot;Z&quot;, &quot;Y&quot;, &quot;X&quot;};
                repository.AddOrUpdate(resolved);
                unitOfWork.Commit();
                var updatedItem = repository.Get(userType.Id);

                // Assert
                Assert.That(updatedItem.Id, Is.EqualTo(resolved.Id));
                Assert.That(updatedItem.Name, Is.EqualTo(resolved.Name));
                Assert.That(updatedItem.Permissions, Is.EqualTo(resolved.Permissions));
            }
        }

        [Test]
        public void Can_Perform_Delete_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                var userType = MockedUserType.CreateUserType();

                // Act
                repository.AddOrUpdate(userType);
                unitOfWork.Commit();
                var id = userType.Id;

                using (var repository2 = new UserTypeRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Logger, SqlSyntax))
                {
                    repository2.Delete(userType);
                    unitOfWork.Commit();

                    var resolved = repository2.Get(id);

                    // Assert
                    Assert.That(resolved, Is.Null);    
                }
                
            }
        }

        [Test]
        public void Can_Perform_Get_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var userType = MockedUserType.CreateUserType();
                repository.AddOrUpdate(userType);
                unitOfWork.Commit();

                // Act
                var resolved = repository.Get(userType.Id);

                // Assert
                Assert.That(resolved.Id, Is.EqualTo(userType.Id));
                //Assert.That(resolved.CreateDate, Is.GreaterThan(DateTime.MinValue));
                //Assert.That(resolved.UpdateDate, Is.GreaterThan(DateTime.MinValue));
                Assert.That(resolved.Name, Is.EqualTo(userType.Name));
                Assert.That(resolved.Alias, Is.EqualTo(userType.Alias));
                Assert.That(resolved.Permissions, Is.EqualTo(userType.Permissions));
            }
        }

        [Test]
        public void Can_Perform_GetByQuery_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                CreateAndCommitMultipleUserTypes(repository, unitOfWork);

                // Act
                var query = Query&lt;IUserType&gt;.Builder.Where(x =&gt; x.Alias == &quot;testUserType1&quot;);
                var result = repository.GetByQuery(query);

                // Assert
                Assert.That(result.Count(), Is.GreaterThanOrEqualTo(1));
            }
        }

        [Test]
        public void Can_Perform_GetAll_By_Param_Ids_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var userTypes = CreateAndCommitMultipleUserTypes(repository, unitOfWork);

                // Act
                var result = repository.GetAll(userTypes[0].Id, userTypes[1].Id);

                // Assert
                Assert.That(result, Is.Not.Null);
                Assert.That(result.Any(), Is.True);
                Assert.That(result.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_GetAll_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                CreateAndCommitMultipleUserTypes(repository, unitOfWork);

                // Act
                var result = repository.GetAll();

                // Assert
                Assert.That(result, Is.Not.Null);
                Assert.That(result.Any(), Is.True);
                Assert.That(result.Count(), Is.GreaterThanOrEqualTo(3));
            }
        }

        [Test]
        public void Can_Perform_Exists_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var userTypes = CreateAndCommitMultipleUserTypes(repository, unitOfWork);

                // Act
                var exists = repository.Exists(userTypes[0].Id);

                // Assert
                Assert.That(exists, Is.True);
            }
        }

        [Test]
        public void Can_Perform_Count_On_UserTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {
                var userTypes = CreateAndCommitMultipleUserTypes(repository, unitOfWork);

                // Act
                var query = Query&lt;IUserType&gt;.Builder.Where(x =&gt; x.Alias == &quot;testUserType1&quot; || x.Alias == &quot;testUserType2&quot;);
                var result = repository.Count(query);

                // Assert
                Assert.That(result, Is.GreaterThanOrEqualTo(2));
            }
        }

        private IUserType[] CreateAndCommitMultipleUserTypes(IUserTypeRepository repository, IUnitOfWork unitOfWork)
        {
            var userType1 = MockedUserType.CreateUserType(&quot;1&quot;);
            var userType2 = MockedUserType.CreateUserType(&quot;2&quot;);
            var userType3 = MockedUserType.CreateUserType(&quot;3&quot;);
            repository.AddOrUpdate(userType1);
            repository.AddOrUpdate(userType2);
            repository.AddOrUpdate(userType3);
            unitOfWork.Commit();
            return new IUserType[] {userType1, userType2, userType3};
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[24,13,24,31,1],[25,9,25,10,1],[29,9,29,10,1],[30,13,30,29,1],[31,9,31,10,1],[34,9,34,10,1],[35,13,35,127,1],[36,9,36,10,1],[40,9,40,10,1],[42,13,42,67,1],[43,13,43,55,1],[44,20,44,65,1],[45,13,45,14,1],[47,17,47,64,1],[50,17,50,50,1],[51,17,51,37,1],[54,17,54,60,1],[55,13,55,14,1],[56,9,56,10,1],[60,9,60,10,1],[62,13,62,67,1],[63,13,63,55,1],[64,20,64,65,1],[65,13,65,14,1],[67,17,67,68,1],[68,17,68,68,1],[71,17,71,51,1],[72,17,72,37,1],[73,17,73,51,1],[74,17,74,37,1],[77,17,77,61,1],[78,17,78,61,1],[79,13,79,14,1],[80,9,80,10,1],[84,9,84,10,1],[86,13,86,67,1],[87,13,87,55,1],[88,20,88,65,1],[89,13,89,14,1],[90,17,90,64,1],[91,17,91,50,1],[92,17,92,37,1],[95,17,95,60,1],[96,17,96,62,1],[99,17,99,46,1],[100,13,100,14,1],[101,9,101,10,1],[105,9,105,10,1],[107,13,107,67,1],[108,13,108,55,1],[109,20,109,65,1],[110,13,110,14,1],[111,17,111,64,1],[112,17,112,50,1],[113,17,113,37,1],[116,17,116,60,1],[117,17,117,44,1],[118,17,118,61,1],[119,17,119,50,1],[120,17,120,37,1],[121,17,121,63,1],[124,17,124,70,1],[125,17,125,74,1],[126,17,126,88,1],[127,13,127,14,1],[128,9,128,10,1],[132,9,132,10,1],[134,13,134,67,1],[135,13,135,55,1],[136,20,136,65,1],[137,13,137,14,1],[139,17,139,64,1],[142,17,142,50,1],[143,17,143,37,1],[144,17,144,38,1],[146,24,146,136,1],[147,17,147,18,1],[148,21,148,50,1],[149,21,149,41,1],[151,21,151,56,1],[154,21,154,52,1],[155,17,155,18,1],[157,13,157,14,1],[158,9,158,10,1],[162,9,162,10,1],[164,13,164,67,1],[165,13,165,55,1],[166,20,166,65,1],[167,13,167,14,1],[168,17,168,64,1],[169,17,169,50,1],[170,17,170,37,1],[173,17,173,60,1],[176,17,176,67,1],[179,17,179,71,1],[180,17,180,73,1],[181,17,181,85,1],[182,13,182,14,1],[183,9,183,10,1],[187,9,187,10,1],[189,13,189,67,1],[190,13,190,55,1],[191,20,191,65,1],[192,13,192,14,1],[193,17,193,74,1],[196,17,196,93,1],[197,17,197,59,1],[200,17,200,73,1],[201,13,201,14,1],[202,9,202,10,1],[206,9,206,10,1],[208,13,208,67,1],[209,13,209,55,1],[210,20,210,65,1],[211,13,211,14,1],[212,17,212,90,1],[215,17,215,82,1],[218,17,218,50,1],[219,17,219,52,1],[220,17,220,60,1],[221,13,221,14,1],[222,9,222,10,1],[226,9,226,10,1],[228,13,228,67,1],[229,13,229,55,1],[230,20,230,65,1],[231,13,231,14,1],[232,17,232,74,1],[235,17,235,50,1],[238,17,238,50,1],[239,17,239,52,1],[240,17,240,73,1],[241,13,241,14,1],[242,9,242,10,1],[246,9,246,10,1],[248,13,248,67,1],[249,13,249,55,1],[250,20,250,65,1],[251,13,251,14,1],[252,17,252,90,1],[255,17,255,65,1],[258,17,258,46,1],[259,13,259,14,1],[260,9,260,10,1],[264,9,264,10,1],[266,13,266,67,1],[267,13,267,55,1],[268,20,268,65,1],[269,13,269,14,1],[270,17,270,90,1],[273,17,273,123,1],[274,17,274,54,1],[277,17,277,65,1],[278,13,278,14,1],[279,9,279,10,1],[282,9,282,10,1],[283,13,283,64,1],[284,13,284,64,1],[285,13,285,64,1],[286,13,286,47,1],[287,13,287,47,1],[288,13,288,47,1],[289,13,289,33,1],[290,13,290,70,1],[291,9,291,10,1]]);
    </script>
  </body>
</html>