<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\controls\Tree\JTreeContextMenu.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.Script.Serialization;
using Umbraco.Core.Logging;
using umbraco.interfaces;
using System.Text.RegularExpressions;
using umbraco.BusinessLogic.Actions;
using umbraco.businesslogic.Utils;
using System.Text;
using umbraco.cms.presentation.Trees;
using umbraco.BasePages;
using System.Web.Services;
using umbraco.BusinessLogic;

namespace umbraco.controls.Tree
{
	internal class JTreeContextMenu
	{
		public string RenderJSONMenu()
		{

			JSONSerializer jSSerializer = new JSONSerializer();

			jSSerializer.RegisterConverters(new List&lt;JavaScriptConverter&gt;() 
					{ 	
						new JTreeContextMenuItem()
					});

			List&lt;IAction&gt; allActions = new List&lt;IAction&gt;();
			foreach (IAction a in global::umbraco.BusinessLogic.Actions.Action.GetAll())
			{
                // NH: Added a try/catch block to this as an error in a 3rd party action can crash the whole menu initialization
                try
                {
                    if (!string.IsNullOrEmpty(a.Alias) &amp;&amp; (!string.IsNullOrEmpty(a.JsFunctionName) || !string.IsNullOrEmpty(a.JsSource)))
                    {
                        // if the action is using invalid javascript we need to do something about this
                        if (!umbraco.BusinessLogic.Actions.Action.ValidateActionJs(a))
                        {
                            // Make new Iaction
                            PlaceboAction pa = new PlaceboAction(a);
                            pa.JsFunctionName = &quot;IActionProxy_&quot; + umbraco.cms.helpers.Casing.SafeAlias(pa.Alias) + &quot;()&quot;;
                            allActions.Add(pa);

                        }
                        else
                        {
                            allActions.Add(a);
                        }
                    }
                }
                catch (Exception ee)
                {
	                LogHelper.Error&lt;JTreeContextMenu&gt;(&quot;Error initializing tree action&quot;, ee);
                }

			}


			return jSSerializer.Serialize(allActions);
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,3,23,4,0],[25,4,25,55,0],[27,4,30,9,0],[32,4,32,51,0],[33,4,33,11,0],[33,13,33,22,0],[33,23,33,25,0],[33,26,33,79,0],[34,4,34,5,0],[37,17,37,18,0],[38,21,38,138,0],[39,21,39,22,0],[41,25,41,87,0],[42,25,42,26,0],[44,29,44,69,0],[45,29,45,121,0],[46,29,46,48,0],[48,25,48,26,0],[50,25,50,26,0],[51,29,51,47,0],[52,25,52,26,0],[53,21,53,22,0],[54,17,54,18,0],[55,17,55,37,0],[56,17,56,18,0],[57,18,57,90,0],[58,17,58,18,0],[60,4,60,5,0],[63,4,63,46,0],[64,3,64,4,0]]);
    </script>
  </body>
</html>