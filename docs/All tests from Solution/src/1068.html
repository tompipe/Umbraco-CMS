<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\HtmlTagWrapper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Web.UI;
using System.IO;
using System.Web;
using Umbraco.Core;

namespace Umbraco.Web.Mvc
{
    public class HtmlTagWrapper : IHtmlTagWrapper, IHtmlString
    {
        public HtmlTagWrapper Parent;
    	
		private readonly List&lt;IHtmlTagWrapper&gt; _children;
    	public IEnumerable&lt;IHtmlTagWrapper&gt; Children
    	{
    		get { return _children; }
    	}

    	private List&lt;KeyValuePair&lt;string, string&gt;&gt; _attributes;
    	public IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt; Attributes
    	{
    		get { return _attributes; }
    	}

    	public void ReflectAttributesFromAnonymousType(List&lt;KeyValuePair&lt;string, string&gt;&gt; newAttributes)
        {
            List&lt;KeyValuePair&lt;string, string&gt;&gt; mergedAttributes =
             newAttributes
             .Concat(Attributes)
             .GroupBy(kvp =&gt; kvp.Key, kvp =&gt; kvp.Value)
             .Select(g =&gt; new KeyValuePair&lt;string, string&gt;(g.Key, string.Join(&quot; &quot;, g.ToArray())))
             .ToList();

			_attributes = mergedAttributes;
        }
        public void ReflectAttributesFromAnonymousType(object anonymousAttributes)
        {
            var newAttributes =
                anonymousAttributes
                    .GetType()
                    .GetProperties()
                    .Where(prop =&gt; !string.IsNullOrWhiteSpace(string.Format(&quot;{0}&quot;, prop.GetValue(anonymousAttributes, null))))
                    .ToList()
                    .ConvertAll(prop =&gt;
                        new KeyValuePair&lt;string, string&gt;(
                            prop.Name,
                            string.Format(&quot;{0}&quot;, prop.GetValue(anonymousAttributes, null))
                        )
                    );
            ReflectAttributesFromAnonymousType(newAttributes);

        }

        public List&lt;string&gt; CssClasses;
        public string Tag;
        public bool Visible;

        public HtmlTagWrapper(string tag)
        {
            this.Tag = tag;
			this._children = new List&lt;IHtmlTagWrapper&gt;();
            this.CssClasses = new List&lt;string&gt;();
			this._attributes = new List&lt;KeyValuePair&lt;string, string&gt;&gt;();
            this.Visible = true;
        }
        public HtmlString Write()
        {
            if ((Children.Any() || Attributes.Any() || CssClasses.Count &gt; 0) &amp;&amp; Visible)
            {
                using (MemoryStream ms = new MemoryStream())
                {
                    using (TextWriter tw = new StreamWriter(ms))
                    {
                        HtmlTextWriter html = new HtmlTextWriter(tw);
                        this.WriteToHtmlTextWriter(html);
                        tw.Flush();
                        ms.Position = 0;
                        using (TextReader tr = new StreamReader(ms))
                        {
                            string result = tr.ReadToEnd();
                            return new HtmlString(result);
                        }
                    }
                }
            }
            return new HtmlString(string.Empty);
        }
        public override string ToString()
        {
            return &quot;Use @item.Write() to emit the HTML rather than @item&quot;;
        }
        public IHtmlString ToHtml()
        {
            return this.Write();
        }
        public void WriteToHtmlTextWriter(HtmlTextWriter html)
        {
            html.WriteBeginTag(Tag);
            string cssClassNames = string.Join(&quot; &quot;, CssClasses.ToArray()).Trim();
            foreach (var attribute in Attributes)
            {
                html.WriteAttribute(attribute.Key, attribute.Value);
            }
            if (!string.IsNullOrWhiteSpace(cssClassNames))
            {
                html.WriteAttribute(&quot;class&quot;, cssClassNames);
            }
            html.Write(HtmlTextWriter.TagRightChar);
            foreach (var child in Children)
            {
                child.WriteToHtmlTextWriter(html);
            }
            html.WriteEndTag(Tag);
        }

        public HtmlTagWrapper AddClassName(string className)
        {
            className = className.Trim();
            if (!this.CssClasses.Contains(className))
            {
                this.CssClasses.Add(className);
            }
            return this;
        }

        public HtmlTagWrapper RemoveClassName(string className)
        {
            className = className.Trim();
            if (this.CssClasses.Contains(className))
            {
                this.CssClasses.Remove(className);
            }
            return this;
        }

        public bool HasClassName(string className)
        {
            className = className.Trim();
            return (this.CssClasses.Contains(className));
        }

        public HtmlTagWrapper Attr(object newAttributes)
        {
            this.ReflectAttributesFromAnonymousType(newAttributes);
            return this;
        }
        public HtmlTagWrapper Attr(string name, string value)
        {
            if (!string.IsNullOrWhiteSpace(value))
            {
                var newAttributes = new List&lt;KeyValuePair&lt;string, string&gt;&gt; {new KeyValuePair&lt;string, string&gt;(name, value)};
            	this.ReflectAttributesFromAnonymousType(newAttributes);
            }
            else
            {
                var existingKey = this._attributes.Find(item =&gt; item.Key == name);
				_attributes.Remove(existingKey);
            }
            return this;
        }

        public HtmlTagWrapper AddChild(IHtmlTagWrapper newChild)
        {
			_children.Add(newChild);
            return this;
        }
        public HtmlTagWrapper AddChildren(params IHtmlTagWrapper[] collection)
        {
			_children.AddRange(collection);
            return this;
        }
        public HtmlTagWrapper AddChild(string text)
        {
			_children.Add(new HtmlTagWrapperTextNode(text));
            return this;
        }
        public HtmlTagWrapper AddChildAt(int index, IHtmlTagWrapper newChild)
        {
			_children.Insert(index, newChild);
            return this;
        }
        public HtmlTagWrapper AddChildAt(int index, string text)
        {
			_children.Insert(index, new HtmlTagWrapperTextNode(text));
            return this;
        }
        public HtmlTagWrapper AddChildrenAt(int index, params IHtmlTagWrapper[] collection)
        {
			_children.InsertRange(index, collection);
            return this;
        }
        public HtmlTagWrapper RemoveChildAt(int index)
        {
            return this;
        }
        public int CountChildren()
        {
            return this.Children.Count();
        }
        public HtmlTagWrapper ClearChildren()
        {
            return this;
        }

        public string ToHtmlString()
        {
            return this.Write().ToHtmlString();
        }
    }

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,11,17,12,1],[17,13,17,30,1],[17,31,17,32,1],[23,11,23,12,1],[23,13,23,32,1],[23,33,23,34,1],[27,9,27,10,1],[28,13,31,30,1],[31,30,31,37,1],[31,37,31,46,1],[31,46,31,55,1],[31,55,32,27,1],[32,27,32,97,1],[32,97,33,24,1],[28,13,33,24,1],[35,4,35,35,1],[36,9,36,10,1],[38,9,38,10,1],[39,13,43,36,1],[43,36,43,126,1],[43,126,46,25,1],[46,25,49,26,1],[49,26,50,23,1],[39,13,50,23,1],[51,13,51,63,1],[53,9,53,10,1],[59,9,59,42,1],[60,9,60,10,1],[61,13,61,28,1],[62,4,62,49,1],[63,13,63,50,1],[64,4,64,64,1],[65,13,65,33,1],[66,9,66,10,1],[68,9,68,10,1],[69,13,69,89,1],[70,13,70,14,1],[71,24,71,60,1],[72,17,72,18,1],[73,28,73,64,1],[74,21,74,22,1],[75,25,75,70,1],[76,25,76,58,1],[77,25,77,36,1],[78,25,78,41,1],[79,32,79,68,1],[80,25,80,26,1],[81,29,81,60,1],[82,29,82,59,1],[87,13,87,49,0],[88,9,88,10,1],[90,9,90,10,0],[91,13,91,75,0],[92,9,92,10,0],[94,9,94,10,0],[95,13,95,33,0],[96,9,96,10,0],[98,9,98,10,1],[99,13,99,37,1],[100,13,100,82,1],[101,13,101,20,1],[101,22,101,35,1],[101,36,101,38,1],[101,39,101,49,1],[102,13,102,14,1],[103,17,103,69,1],[104,13,104,14,1],[105,13,105,59,1],[106,13,106,14,0],[107,17,107,61,0],[108,13,108,14,0],[109,13,109,53,1],[110,13,110,20,1],[110,22,110,31,1],[110,32,110,34,1],[110,35,110,43,1],[111,13,111,14,1],[112,17,112,51,1],[113,13,113,14,1],[114,13,114,35,1],[115,9,115,10,1],[118,9,118,10,0],[119,13,119,42,0],[120,13,120,54,0],[121,13,121,14,0],[122,17,122,48,0],[123,13,123,14,0],[124,13,124,25,0],[125,9,125,10,0],[128,9,128,10,0],[129,13,129,42,0],[130,13,130,53,0],[131,13,131,14,0],[132,17,132,51,0],[133,13,133,14,0],[134,13,134,25,0],[135,9,135,10,0],[138,9,138,10,0],[139,13,139,42,0],[140,13,140,58,0],[141,9,141,10,0],[144,9,144,10,0],[145,13,145,68,0],[146,13,146,25,0],[147,9,147,10,0],[149,9,149,10,0],[150,13,150,51,0],[151,13,151,14,0],[152,17,152,124,0],[153,14,153,69,0],[154,13,154,14,0],[156,13,156,14,0],[157,17,157,65,0],[157,65,157,81,0],[157,81,157,83,0],[157,17,157,83,0],[158,5,158,37,0],[159,13,159,14,0],[160,13,160,25,0],[161,9,161,10,0],[164,9,164,10,1],[165,4,165,28,1],[166,13,166,25,1],[167,9,167,10,1],[169,9,169,10,0],[170,4,170,35,0],[171,13,171,25,0],[172,9,172,10,0],[174,9,174,10,0],[175,4,175,52,0],[176,13,176,25,0],[177,9,177,10,0],[179,9,179,10,0],[180,4,180,38,0],[181,13,181,25,0],[182,9,182,10,0],[184,9,184,10,0],[185,4,185,62,0],[186,13,186,25,0],[187,9,187,10,0],[189,9,189,10,0],[190,4,190,45,0],[191,13,191,25,0],[192,9,192,10,0],[194,9,194,10,0],[195,13,195,25,0],[196,9,196,10,0],[198,9,198,10,0],[199,13,199,42,0],[200,9,200,10,0],[202,9,202,10,0],[203,13,203,25,0],[204,9,204,10,0],[207,9,207,10,1],[208,13,208,48,1],[209,9,209,10,1]]);
    </script>
  </body>
</html>