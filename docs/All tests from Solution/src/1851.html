<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSevenThreeZero\CleanUpCorruptedPublishedFlags.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSevenThreeZero
{
    /// &lt;summary&gt;
    /// Older corrupted dbs might have multiple published flags for a content item, this shouldn&#39;t be possible
    /// so we need to clear the content flag on the older version
    /// &lt;/summary&gt;
    [Migration(&quot;7.3.0&quot;, 18, GlobalSettings.UmbracoMigrationName)]
    public class CleanUpCorruptedPublishedFlags : MigrationBase
    {
        public CleanUpCorruptedPublishedFlags(ISqlSyntaxProvider sqlSyntax, ILogger logger)
            : base(sqlSyntax, logger)
        {
        }
        
        public override void Up()
        {
            //Get all cmsDocument items that have more than one published date set
            var sql = @&quot;SELECT * FROM cmsDocument WHERE nodeId IN 
(SELECT nodeId
FROM cmsDocument
GROUP BY nodeId
HAVING SUM(CASE WHEN published = 0 THEN 0 ELSE 1 END) &gt; 1)
AND published = 1
ORDER BY nodeId, updateDate&quot;;

            var docs = Context.Database.Fetch&lt;DocumentDto&gt;(sql).GroupBy(x =&gt; x.NodeId);

            foreach (var doc in docs)
            {
                var latest = doc.OrderByDescending(x =&gt; x.UpdateDate).First();
                foreach (var old in doc.Where(x =&gt; x.VersionId != latest.VersionId))
                {
                    Update.Table(&quot;cmsDocument&quot;).Set(new {published = 0}).Where(new {nodeId = old.NodeId});
                }
            }
        }

        public override void Down()
        {
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,15,18,38,0],[19,9,19,10,0],[20,9,20,10,0],[23,9,23,10,0],[25,13,31,30,0],[33,13,33,78,0],[33,78,33,86,0],[33,86,33,88,0],[33,13,33,88,0],[35,13,35,20,0],[35,22,35,29,0],[35,30,35,32,0],[35,33,35,37,0],[36,13,36,14,0],[37,17,37,57,0],[37,57,37,69,0],[37,69,37,79,0],[37,17,37,79,0],[38,17,38,24,0],[38,26,38,33,0],[38,34,38,36,0],[38,37,38,52,0],[38,52,38,83,0],[38,83,38,84,0],[38,37,38,84,0],[39,17,39,18,0],[40,21,40,107,0],[41,17,41,18,0],[42,13,42,14,0],[43,9,43,10,0],[46,9,46,10,0],[47,9,47,10,0]]);
    </script>
  </body>
</html>