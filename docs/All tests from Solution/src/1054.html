<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\AreaRegistrationExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Web.Http;
using System.Web.Mvc;
using System.Web.Routing;
using System.Web.SessionState;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Web.WebApi;

namespace Umbraco.Web.Mvc
{
    internal static class AreaRegistrationExtensions
    {
        /// &lt;summary&gt;
        /// Creates a custom individual route for the specified controller plugin. Individual routes
        /// are required by controller plugins to map to a unique URL based on ID.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;routes&quot;&gt;An existing route collection&lt;/param&gt;
        /// &lt;param name=&quot;controllerSuffixName&quot;&gt;
        /// The suffix name that the controller name must end in before the &quot;Controller&quot; string for example:
        /// ContentTreeController has a controllerSuffixName of &quot;Tree&quot;, this is used for route constraints.
        /// &lt;/param&gt;
        /// &lt;param name=&quot;defaultAction&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;defaultId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;umbracoTokenValue&quot;&gt;The DataToken value to set for the &#39;umbraco&#39; key, this defaults to &#39;backoffice&#39; &lt;/param&gt;
        /// &lt;param name=&quot;routeTokens&quot;&gt;By default this value is just {action}/{id} but can be modified for things like web api routes&lt;/param&gt;
        /// &lt;param name=&quot;isMvc&quot;&gt;Default is true for MVC, otherwise false for WebAPI&lt;/param&gt;
        /// &lt;param name=&quot;areaPathPrefix&quot;&gt;
        /// If specified will add this string to the path between the umbraco path and the area path name, for example:
        ///     /umbraco/CUSTOMPATHPREFIX/areaname
        /// if not specified, will just route like:
        ///     /umbraco/areaname
        /// &lt;/param&gt;
        /// &lt;remarks&gt;
        /// &lt;/remarks&gt;
        internal static Route RouteControllerPlugin(this AreaRegistration area, string controllerName, Type controllerType, RouteCollection routes,
                                                    string controllerSuffixName, string defaultAction, object defaultId,
                                                    string umbracoTokenValue = &quot;backoffice&quot;,
                                                    string routeTokens = &quot;{action}/{id}&quot;,
                                                    bool isMvc = true,
                                                    string areaPathPrefix = &quot;&quot;)
        {
            Mandate.ParameterNotNullOrEmpty(controllerName, &quot;controllerName&quot;);
            Mandate.ParameterNotNull(controllerSuffixName, &quot;controllerSuffixName&quot;);
            
            Mandate.ParameterNotNull(controllerType, &quot;controllerType&quot;);
            Mandate.ParameterNotNull(routes, &quot;routes&quot;);
            Mandate.ParameterNotNull(defaultId, &quot;defaultId&quot;);

            var umbracoArea = GlobalSettings.UmbracoMvcArea;

            //routes are explicitly named with controller names and IDs
            var url = umbracoArea + &quot;/&quot; + 
                (areaPathPrefix.IsNullOrWhiteSpace() ? &quot;&quot; : areaPathPrefix + &quot;/&quot;) + 
                area.AreaName + &quot;/&quot; + controllerName + &quot;/&quot; + routeTokens;

            Route controllerPluginRoute;
            //var meta = PluginController.GetMetadata(controllerType);
            if (isMvc)
            {
                //create a new route with custom name, specified url, and the namespace of the controller plugin
                controllerPluginRoute = routes.MapRoute(
                    //name
                    string.Format(&quot;umbraco-{0}-{1}&quot;, area.AreaName, controllerName),
                    //url format
                    url,
                    //set the namespace of the controller to match
                    new[] {controllerType.Namespace});

                //set defaults
                controllerPluginRoute.Defaults = new RouteValueDictionary(
                    new Dictionary&lt;string, object&gt;
                    {
                        {&quot;controller&quot;, controllerName},
                        {&quot;action&quot;, defaultAction},
                        {&quot;id&quot;, defaultId}
                    });
            }
            else
            {
                controllerPluginRoute = routes.MapHttpRoute(
                    //name
                    string.Format(&quot;umbraco-{0}-{1}-{2}&quot;, &quot;api&quot;, area.AreaName, controllerName),
                    //url format
                    url,
                    new { controller = controllerName, id = defaultId });
                //web api routes don&#39;t set the data tokens object
                if (controllerPluginRoute.DataTokens == null)
                {
                    controllerPluginRoute.DataTokens = new RouteValueDictionary();
                }
                //look in this namespace to create the controller
                controllerPluginRoute.DataTokens.Add(&quot;Namespaces&quot;, new[] {controllerType.Namespace});

                //Special case! Check if the controller type implements IRequiresSessionState and if so use our
                //custom webapi session handler
                if (typeof(IRequiresSessionState).IsAssignableFrom(controllerType))
                {
                    controllerPluginRoute.RouteHandler = new SessionHttpControllerRouteHandler();
                }
            }

            //Don&#39;t look anywhere else except this namespace!
            controllerPluginRoute.DataTokens.Add(&quot;UseNamespaceFallback&quot;, false);

            //constraints: only match controllers ending with &#39;controllerSuffixName&#39; and only match this controller&#39;s ID for this route            
            if (controllerSuffixName.IsNullOrWhiteSpace() == false)
            {
                controllerPluginRoute.Constraints = new RouteValueDictionary(
                    new Dictionary&lt;string, object&gt;
                    {
                        {&quot;controller&quot;, @&quot;(\w+)&quot; + controllerSuffixName}
                    });
            }

            //match this area
            controllerPluginRoute.DataTokens.Add(&quot;area&quot;, area.AreaName);
            controllerPluginRoute.DataTokens.Add(Core.Constants.Web.UmbracoDataToken, umbracoTokenValue); //ensure the umbraco token is set

            return controllerPluginRoute;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[46,9,46,10,1],[47,13,47,79,1],[48,13,48,84,1],[50,13,50,72,1],[51,13,51,56,1],[52,13,52,62,1],[54,13,54,61,1],[57,13,59,74,1],[63,13,63,23,1],[64,13,64,14,0],[66,17,72,55,0],[75,17,81,24,0],[82,13,82,14,0],[84,13,84,14,1],[85,17,90,74,1],[92,17,92,62,1],[93,17,93,18,1],[94,21,94,83,1],[95,17,95,18,1],[97,17,97,102,1],[101,17,101,84,1],[102,17,102,18,1],[103,21,103,98,1],[104,17,104,18,1],[105,13,105,14,1],[108,13,108,81,1],[111,13,111,68,1],[112,13,112,14,0],[113,17,117,24,0],[118,13,118,14,0],[121,13,121,73,1],[122,13,122,106,1],[124,13,124,42,1],[125,9,125,10,1]]);
    </script>
  </body>
</html>