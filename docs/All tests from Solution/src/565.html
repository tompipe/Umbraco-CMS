<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\plugins\tinymce3\GzipModule.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * $Id: GzipModule.cs 439 2007-11-26 13:26:10Z spocke $
 *
 * @author Moxiecode
 * @copyright Copyright ï¿½ 2004-2007, Moxiecode Systems AB, All rights reserved.
 */

using System;
using System.Web;
using System.Text.RegularExpressions;
using System.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.IO;

namespace umbraco.presentation.plugins.tinymce3
{
    /// &lt;summary&gt;
    /// Description of HttpHandler.
    /// &lt;/summary&gt;
    public class GzipModule : IModule
    {
        /// &lt;summary&gt;&lt;/summary&gt;
        /// &lt;param name=&quot;context&quot;&gt;Request context.&lt;/param&gt;
        public void ProcessRequest(HttpContext context)
        {
            HttpRequest request = context.Request;
            HttpResponse response = context.Response;
            HttpServerUtility server = context.Server;
            GzipCompressor gzipCompressor = new GzipCompressor();
            System.Collections.Specialized.NameValueCollection configSection = new System.Collections.Specialized.NameValueCollection();
            string suffix = &quot;_src&quot;, enc;
            string[] languages = request.QueryString[&quot;languages&quot;].Split(&#39;,&#39;);
            bool supportsGzip;

            // Set response headers
            response.ContentType = &quot;text/javascript&quot;;
            response.Charset = &quot;UTF-8&quot;;
            response.Buffer = false;

            // UMBRACO: Populate the configsection if it&#39;s empty
            configSection.Add(&quot;GzipEnabled&quot;, &quot;true&quot;);
            configSection.Add(&quot;InstallPath&quot;, IOHelper.ResolveUrl(SystemDirectories.UmbracoClient) + &quot;/tinymce3&quot;);
            configSection.Add(&quot;GzipExpiresOffset&quot;, TimeSpan.FromDays(10).Ticks.ToString());

            // Setup cache
            response.Cache.SetExpires(DateTime.Now.AddTicks(long.Parse(configSection[&quot;GzipExpiresOffset&quot;])));
            response.Cache.SetCacheability(HttpCacheability.Public);
            response.Cache.SetValidUntilExpires(false);

            // Check if it supports gzip
            enc = Regex.Replace(&quot;&quot; + request.Headers[&quot;Accept-Encoding&quot;], @&quot;\s+&quot;, &quot;&quot;).ToLower();
            supportsGzip = enc.IndexOf(&quot;gzip&quot;) != -1 || request.Headers[&quot;---------------&quot;] != null;
            enc = enc.IndexOf(&quot;x-gzip&quot;) != -1 ? &quot;x-gzip&quot; : &quot;gzip&quot;;

            gzipCompressor.AddData(&quot;var tinyMCEPreInit = {base : &#39;&quot; + configSection[&quot;InstallPath&quot;] + &quot;&#39;, suffix : &#39;&quot; + suffix + &quot;&#39;};&quot;);

            // Add core
            gzipCompressor.AddFile(IOHelper.MapPath(configSection[&quot;InstallPath&quot;] + &quot;/tiny_mce&quot; + suffix + &quot;.js&quot;));

            // Add core languages
            foreach (string lang in languages)
            {
                if (File.Exists(IOHelper.MapPath(configSection[&quot;InstallPath&quot;] + &quot;/langs/&quot; + lang + &quot;.js&quot;)))
                {
                    gzipCompressor.AddFile(IOHelper.MapPath(configSection[&quot;InstallPath&quot;] + &quot;/langs/&quot; + lang + &quot;.js&quot;));
                }
                else
                {
                    LogHelper.Info&lt;GzipModule&gt;(string.Format(&quot;TinyMCE: Error loading language &#39;{0}&#39;. Please download language pack from tinymce.moxiecode.com&quot;, lang));
                }
            }
            // Add themes
            if (request.QueryString[&quot;themes&quot;] != null)
            {
                foreach (string theme in request.QueryString[&quot;themes&quot;].Split(&#39;,&#39;))
                {
                    gzipCompressor.AddFile(IOHelper.MapPath(configSection[&quot;InstallPath&quot;] + &quot;/themes/&quot; + theme + &quot;/editor_template&quot; + suffix + &quot;.js&quot;));

                    // Add theme languages
                    foreach (string lang in languages)
                    {
                        string path = IOHelper.MapPath(configSection[&quot;InstallPath&quot;] + &quot;/themes/&quot; + theme + &quot;/langs/&quot; + lang + &quot;.js&quot;);

                        if (File.Exists(path))
                            gzipCompressor.AddFile(path);
                    }

                    gzipCompressor.AddData(&quot;tinymce.ThemeManager.urls[&#39;&quot; + theme + &quot;&#39;] = tinymce.baseURL+&#39;/themes/&quot; + theme + &quot;&#39;;&quot;);
                }
            }

            // Add plugins
            if (request.QueryString[&quot;plugins&quot;] != null)
            {
                foreach (string plugin in request.QueryString[&quot;plugins&quot;].Split(&#39;,&#39;))
                {
                    gzipCompressor.AddFile(IOHelper.MapPath(configSection[&quot;InstallPath&quot;] + &quot;/plugins/&quot; + plugin + &quot;/editor_plugin&quot; + suffix + &quot;.js&quot;));

                    // Add plugin languages
                    foreach (string lang in languages)
                    {
                        string path = IOHelper.MapPath(configSection[&quot;InstallPath&quot;] + &quot;/plugins/&quot; + plugin + &quot;/langs/&quot; + lang + &quot;.js&quot;);

                        if (File.Exists(path))
                            gzipCompressor.AddFile(path);
                    }

                    gzipCompressor.AddData(&quot;tinymce.ThemeManager.urls[&#39;&quot; + plugin + &quot;&#39;] = tinymce.baseURL+&#39;/plugins/&quot; + plugin + &quot;&#39;;&quot;);
                }
            }

            // Add ASP.NET AJAX Script Notification 
            gzipCompressor.AddData(&quot;if (typeof (Sys) !== &#39;undefined&#39;) {\nSys.Application.notifyScriptLoaded();\n}&quot;);

            // Output compressed file
            gzipCompressor.NoCompression = !supportsGzip || (!String.IsNullOrEmpty(configSection[&quot;GzipNoCompression&quot;]) &amp;&amp; bool.Parse(configSection[&quot;GzipNoCompression&quot;]));

            if (!gzipCompressor.NoCompression)
                response.AppendHeader(&quot;Content-Encoding&quot;, enc);


            gzipCompressor.DiskCache = !String.IsNullOrEmpty(configSection[&quot;GzipDiskCache&quot;]) ? bool.Parse(configSection[&quot;GzipDiskCache&quot;]) : false;
            gzipCompressor.CachePath = configSection[&quot;GzipCachePath&quot;];

            gzipCompressor.Compress(response.OutputStream);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,0],[26,13,26,51,0],[27,13,27,54,0],[28,13,28,55,0],[29,13,29,66,0],[30,13,30,137,0],[31,13,31,35,0],[32,13,32,78,0],[36,13,36,54,0],[37,13,37,40,0],[38,13,38,37,0],[41,13,41,54,0],[42,13,42,114,0],[43,13,43,92,0],[46,13,46,110,0],[47,13,47,69,0],[48,13,48,56,0],[51,13,51,96,0],[52,13,52,100,0],[53,13,53,67,0],[55,13,55,136,0],[58,13,58,115,0],[61,13,61,20,0],[61,22,61,33,0],[61,34,61,36,0],[61,37,61,46,0],[62,13,62,14,0],[63,17,63,108,0],[64,17,64,18,0],[65,21,65,119,0],[66,17,66,18,0],[68,17,68,18,0],[69,21,69,168,0],[70,17,70,18,0],[71,13,71,14,0],[73,13,73,55,0],[74,13,74,14,0],[75,17,75,24,0],[75,26,75,38,0],[75,39,75,41,0],[75,42,75,82,0],[76,17,76,18,0],[77,21,77,151,0],[80,21,80,28,0],[80,30,80,41,0],[80,42,80,44,0],[80,45,80,54,0],[81,21,81,22,0],[82,25,82,134,0],[84,25,84,47,0],[85,29,85,58,0],[86,21,86,22,0],[88,21,88,133,0],[89,17,89,18,0],[90,13,90,14,0],[93,13,93,56,0],[94,13,94,14,0],[95,17,95,24,0],[95,26,95,39,0],[95,40,95,42,0],[95,43,95,84,0],[96,17,96,18,0],[97,21,97,151,0],[100,21,100,28,0],[100,30,100,41,0],[100,42,100,44,0],[100,45,100,54,0],[101,21,101,22,0],[102,25,102,136,0],[104,25,104,47,0],[105,29,105,58,0],[106,21,106,22,0],[108,21,108,136,0],[109,17,109,18,0],[110,13,110,14,0],[113,13,113,117,0],[116,13,116,171,0],[118,13,118,47,0],[119,17,119,64,0],[122,13,122,147,0],[123,13,123,71,0],[125,13,125,60,0],[126,9,126,10,0]]);
    </script>
  </body>
</html>