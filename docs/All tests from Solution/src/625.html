<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\developer\Xslt\xsltVisualize.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

using System.Text;
using System.Xml;
using System.IO;
using Umbraco.Core;
using Umbraco.Core.IO;

namespace umbraco.presentation.umbraco.developer.Xslt
{
    [WebformsPageTreeAuthorize(Constants.Trees.Xslt)]
    public partial class xsltVisualize : BasePages.UmbracoEnsuredPage
    {
        
		// zb-00004 #29956 : refactor cookies names &amp; handling
		static global::umbraco.BusinessLogic.StateHelper.Cookies.Cookie cookie
			= new global::umbraco.BusinessLogic.StateHelper.Cookies.Cookie(&quot;UMB_XSLTVISPG&quot;, TimeSpan.FromMinutes(20)); // was &quot;XSLTVisualizerPage&quot;

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                // Check if cookie exists in the current request.
				// zb-00004 #29956 : refactor cookies names &amp; handling
				if (cookie.HasValue)
                    contentPicker.Value = cookie.GetValue();
            }            

        }

        protected void visualizeDo_Click(object sender, EventArgs e)
        {

            // get xslt file
            string xslt = &quot;&quot;;
            if (xsltSelection.Value.Contains(&quot;&lt;xsl:stylesheet&quot;))
            {
                xslt = xsltSelection.Value;
            }
            else
            {
                System.IO.StreamReader xsltFile =
                System.IO.File.OpenText(
                    IOHelper.MapPath(SystemDirectories.Umbraco + &quot;/xslt/templates/clean.xslt&quot;)
                );

                xslt = xsltFile.ReadToEnd();
                xsltFile.Close();

                // parse xslt
                xslt = xslt.Replace(&quot;&lt;!-- start writing XSLT --&gt;&quot;, xsltSelection.Value);

                // prepare support for XSLT extensions
                xslt = macro.AddXsltExtensionsToHeader(xslt);

            }

            Dictionary&lt;string, object&gt; parameters = new Dictionary&lt;string, object&gt;(1);
            parameters.Add(&quot;currentPage&quot;, library.GetXmlNodeById(contentPicker.Value));


            // apply the XSLT transformation
            string xsltResult = &quot;&quot;;
            XmlTextReader xslReader = null;
            try
            {
                xslReader = new XmlTextReader(new StringReader(xslt));
                System.Xml.Xsl.XslCompiledTransform xsl = macro.CreateXsltTransform(xslReader, false);
                xsltResult = macro.GetXsltTransformResult(new XmlDocument(), xsl, parameters);
            }
            catch (Exception ee)
            {
                xsltResult = string.Format(
                    &quot;&lt;div class=\&quot;error\&quot;&gt;&lt;h3&gt;Error parsing the XSLT:&lt;/h3&gt;&lt;p&gt;{0}&lt;/p&gt;&lt;/div&gt;&quot;,
                    ee.ToString());
            }
            finally
            {
                xslReader.Close();
            }
            visualizeContainer.Visible = true;

            // update output
            visualizeArea.Text = !String.IsNullOrEmpty(xsltResult) ? &quot;&lt;div id=\&quot;result\&quot;&gt;&quot; + xsltResult + &quot;&lt;/Div&gt;&quot; : &quot;&lt;div class=\&quot;notice\&quot;&gt;&lt;p&gt;The XSLT didn&#39;t generate any output&lt;/p&gt;&lt;/div&gt;&quot;;


            // add cookie with current page
			// zb-00004 #29956 : refactor cookies names &amp; handling
			cookie.SetValue(contentPicker.Value);
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,3,21,110,0],[24,9,24,10,0],[25,13,25,29,0],[26,13,26,14,0],[29,5,29,25,0],[30,21,30,61,0],[31,13,31,14,0],[33,9,33,10,0],[36,9,36,10,0],[39,13,39,30,0],[40,13,40,65,0],[41,13,41,14,0],[42,17,42,44,0],[43,13,43,14,0],[45,13,45,14,0],[46,17,49,19,0],[51,17,51,45,0],[52,17,52,34,0],[55,17,55,89,0],[58,17,58,62,0],[60,13,60,14,0],[62,13,62,87,0],[63,13,63,88,0],[67,13,67,36,0],[68,13,68,44,0],[70,13,70,14,0],[71,17,71,71,0],[72,17,72,103,0],[73,17,73,95,0],[74,13,74,14,0],[75,13,75,33,0],[76,13,76,14,0],[77,17,79,36,0],[80,13,80,14,0],[82,13,82,14,0],[83,17,83,35,0],[84,13,84,14,0],[85,13,85,47,0],[88,13,88,191,0],[93,4,93,41,0],[94,9,94,10,0]]);
    </script>
  </body>
</html>