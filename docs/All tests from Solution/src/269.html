<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\UmbracoExamine\IndexTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using Examine;
using Examine.LuceneEngine;
using Examine.LuceneEngine.Providers;
using Examine.LuceneEngine.SearchCriteria;
using Examine.SearchCriteria;
using Lucene.Net.Analysis.Standard;
using Lucene.Net.Index;
using Lucene.Net.Search;
using Lucene.Net.Store;
using NUnit.Framework;
using Umbraco.Tests.TestHelpers;
using UmbracoExamine;

namespace Umbraco.Tests.UmbracoExamine
{
    /// &lt;summary&gt;
    /// Tests the standard indexing capabilities
    /// &lt;/summary&gt;
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, RequiresSTA]
    public class IndexTest : ExamineBaseTest
    {
        /// &lt;summary&gt;
        /// Check that the node signalled as protected in the content service is not present in the index.
        /// &lt;/summary&gt;
        [Test]
        public void Index_Protected_Content_Not_Indexed()
        {

            using (var luceneDir = new RandomIdRAMDirectory())
            using (var writer = new IndexWriter(luceneDir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29), IndexWriter.MaxFieldLength.LIMITED))
            using (var indexer = IndexInitializer.GetUmbracoIndexer(writer))
            using (var searcher = IndexInitializer.GetUmbracoSearcher(writer))
            {
                indexer.RebuildIndex();

                var protectedQuery = new BooleanQuery();
                protectedQuery.Add(
                    new BooleanClause(
                        new TermQuery(new Term(LuceneIndexer.IndexTypeFieldName, IndexTypes.Content)),
                        BooleanClause.Occur.MUST));

                protectedQuery.Add(
                    new BooleanClause(
                        new TermQuery(new Term(LuceneIndexer.IndexNodeIdFieldName, TestContentService.ProtectedNode.ToString())),
                        BooleanClause.Occur.MUST));

                var collector = new AllHitsCollector(false, true);
                var s = searcher.GetSearcher();
                s.Search(protectedQuery, collector);

                Assert.AreEqual(0, collector.Count, &quot;Protected node should not be indexed&quot;);
            }

        }

        [Test]
        public void Index_Move_Media_From_Non_Indexable_To_Indexable_ParentID()
        {
            using (var luceneDir = new RandomIdRAMDirectory())
            using (var writer = new IndexWriter(luceneDir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29), IndexWriter.MaxFieldLength.LIMITED))
            using (var indexer = IndexInitializer.GetUmbracoIndexer(writer))
            using (var searcher = IndexInitializer.GetUmbracoSearcher(writer))
            {
                indexer.RebuildIndex();

                var mediaService = new TestMediaService();

                //change parent id to 1116
                var existingCriteria = indexer.IndexerData;
                indexer.IndexerData = new IndexCriteria(existingCriteria.StandardFields, existingCriteria.UserFields, existingCriteria.IncludeNodeTypes, existingCriteria.ExcludeNodeTypes,
                    1116);

                //rebuild so it excludes children unless they are under 1116
                indexer.RebuildIndex();

                //ensure that node 2112 doesn&#39;t exist
                var results = searcher.Search(searcher.CreateSearchCriteria().Id(2112).Compile());
                Assert.AreEqual(0, results.TotalItemCount);

                //get a node from the data repo (this one exists underneath 2222)
                var node = mediaService.GetLatestMediaByXpath(&quot;//*[string-length(@id)&gt;0 and number(@id)&gt;0]&quot;)
                                        .Root
                                        .Elements()
                                        .First(x =&gt; (int)x.Attribute(&quot;id&quot;) == 2112);

                var currPath = (string)node.Attribute(&quot;path&quot;); //should be : -1,1111,2222,2112
                Assert.AreEqual(&quot;-1,1111,2222,2112&quot;, currPath);

                //now mimic moving 2112 to 1116
                //node.SetAttributeValue(&quot;path&quot;, currPath.Replace(&quot;2222&quot;, &quot;1116&quot;));
                node.SetAttributeValue(&quot;path&quot;, &quot;-1,1116,2112&quot;);
                node.SetAttributeValue(&quot;parentID&quot;, &quot;1116&quot;);

                //now reindex the node, this should first delete it and then WILL add it because of the parent id constraint
                indexer.ReIndexNode(node, IndexTypes.Media);

                //RESET the parent id
                existingCriteria = ((IndexCriteria)indexer.IndexerData);
                indexer.IndexerData = new IndexCriteria(existingCriteria.StandardFields, existingCriteria.UserFields, existingCriteria.IncludeNodeTypes, existingCriteria.ExcludeNodeTypes,
                    null);

                //now ensure it&#39;s deleted
                var newResults = searcher.Search(searcher.CreateSearchCriteria().Id(2112).Compile());
                Assert.AreEqual(1, newResults.TotalItemCount);
            }

            
        }

        [Test]
        public void Index_Move_Media_To_Non_Indexable_ParentID()
        {
            using (var luceneDir = new RandomIdRAMDirectory())
            using (var writer = new IndexWriter(luceneDir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29), IndexWriter.MaxFieldLength.LIMITED))
            using (var indexer = IndexInitializer.GetUmbracoIndexer(writer))
            using (var searcher = IndexInitializer.GetUmbracoSearcher(writer))
            {
                indexer.RebuildIndex();

                var mediaService = new TestMediaService();

                //get a node from the data repo (this one exists underneath 2222)
                var node = mediaService.GetLatestMediaByXpath(&quot;//*[string-length(@id)&gt;0 and number(@id)&gt;0]&quot;)
                                    .Root
                                    .Elements()
                                    .First(x =&gt; (int)x.Attribute(&quot;id&quot;) == 2112);

                var currPath = (string)node.Attribute(&quot;path&quot;); //should be : -1,1111,2222,2112
                Assert.AreEqual(&quot;-1,1111,2222,2112&quot;, currPath);

                //ensure it&#39;s indexed
                indexer.ReIndexNode(node, IndexTypes.Media);

                //change the parent node id to be the one it used to exist under
                var existingCriteria = indexer.IndexerData;
                indexer.IndexerData = new IndexCriteria(existingCriteria.StandardFields, existingCriteria.UserFields, existingCriteria.IncludeNodeTypes, existingCriteria.ExcludeNodeTypes,
                    2222);

                //now mimic moving the node underneath 1116 instead of 2222
                node.SetAttributeValue(&quot;path&quot;, currPath.Replace(&quot;2222&quot;, &quot;1116&quot;));
                node.SetAttributeValue(&quot;parentID&quot;, &quot;1116&quot;);

                //now reindex the node, this should first delete it and then NOT add it because of the parent id constraint
                indexer.ReIndexNode(node, IndexTypes.Media);

                //RESET the parent id
                existingCriteria = ((IndexCriteria)indexer.IndexerData);
                indexer.IndexerData = new IndexCriteria(existingCriteria.StandardFields, existingCriteria.UserFields, existingCriteria.IncludeNodeTypes, existingCriteria.ExcludeNodeTypes,
                    null);

                //now ensure it&#39;s deleted
                var results = searcher.Search(searcher.CreateSearchCriteria().Id(2112).Compile());
                Assert.AreEqual(0, results.TotalItemCount);
            }
        }


        /// &lt;summary&gt;
        /// This will ensure that all &#39;Content&#39; (not media) is cleared from the index using the Lucene API directly.
        /// We then call the Examine method to re-index Content and do some comparisons to ensure that it worked correctly.
        /// &lt;/summary&gt;
        [Test]
        public void Index_Reindex_Content()
        {
            using (var luceneDir = new RandomIdRAMDirectory())
            using (var writer = new IndexWriter(luceneDir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29), IndexWriter.MaxFieldLength.LIMITED))
            using (var indexer = IndexInitializer.GetUmbracoIndexer(writer, supportUnpublishedContent: true))
            using (var searcher = IndexInitializer.GetUmbracoSearcher(writer))
            {
                indexer.RebuildIndex();

                var s = (IndexSearcher)searcher.GetSearcher();

                //first delete all &#39;Content&#39; (not media). This is done by directly manipulating the index with the Lucene API, not examine!

                var contentTerm = new Term(LuceneIndexer.IndexTypeFieldName, IndexTypes.Content);
                writer.DeleteDocuments(contentTerm);
                writer.Commit();

                //make sure the content is gone. This is done with lucene APIs, not examine!
                var collector = new AllHitsCollector(false, true);
                var query = new TermQuery(contentTerm);
                s = (IndexSearcher)searcher.GetSearcher(); //make sure the searcher is up do date.
                s.Search(query, collector);
                Assert.AreEqual(0, collector.Count);

                //call our indexing methods
                indexer.IndexAll(IndexTypes.Content);

                collector = new AllHitsCollector(false, true);
                s = (IndexSearcher)searcher.GetSearcher(); //make sure the searcher is up do date.
                s.Search(query, collector);
                //var ids = new List&lt;string&gt;();
                //for (var i = 0; i &lt; collector.Count;i++)
                //{
                //    ids.Add(s.Doc(collector.GetDocId(i)).GetValues(&quot;__NodeId&quot;)[0]);
                //}
                Assert.AreEqual(21, collector.Count);
            }
        }

        /// &lt;summary&gt;
        /// This will delete an item from the index and ensure that all children of the node are deleted too!
        /// &lt;/summary&gt;
        [Test]
        public void Index_Delete_Index_Item_Ensure_Heirarchy_Removed()
        {

            using (var luceneDir = new RandomIdRAMDirectory())
            using (var writer = new IndexWriter(luceneDir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29), IndexWriter.MaxFieldLength.LIMITED))
            using (var indexer = IndexInitializer.GetUmbracoIndexer(writer))
            using (var searcher = IndexInitializer.GetUmbracoSearcher(writer))
            {
                indexer.RebuildIndex();

                //now delete a node that has children

                indexer.DeleteFromIndex(1140.ToString());
                //this node had children: 1141 &amp; 1142, let&#39;s ensure they are also removed

                var results = searcher.Search(searcher.CreateSearchCriteria().Id(1141).Compile());
                Assert.AreEqual(0, results.TotalItemCount);

                results = searcher.Search(searcher.CreateSearchCriteria().Id(1142).Compile());
                Assert.AreEqual(0, results.TotalItemCount);
            }
        }
        
        #region Initialize and Cleanup
            
        public override void TearDown()
        {
            base.TearDown();
        
            UmbracoExamineSearcher.DisableInitializationCheck = null;
            BaseUmbracoIndexer.DisableInitializationCheck = null;
        }
        
        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,10,1],[32,20,32,62,1],[33,20,33,152,1],[34,20,34,76,1],[35,20,35,78,1],[36,13,36,14,1],[37,17,37,40,1],[39,17,39,57,1],[40,17,43,52,1],[45,17,48,52,1],[50,17,50,67,1],[51,17,51,48,1],[52,17,52,53,1],[54,17,54,93,1],[55,13,55,14,1],[57,9,57,10,1],[61,9,61,10,1],[62,20,62,62,1],[63,20,63,152,1],[64,20,64,76,1],[65,20,65,78,1],[66,13,66,14,1],[67,17,67,40,1],[69,17,69,59,1],[72,17,72,60,1],[73,17,74,27,1],[77,17,77,40,1],[80,17,80,99,1],[81,17,81,60,1],[84,17,87,53,1],[87,53,87,83,1],[87,83,87,85,1],[84,17,87,85,1],[89,17,89,63,1],[90,17,90,64,1],[94,17,94,64,1],[95,17,95,60,1],[98,17,98,61,1],[101,17,101,73,1],[102,17,103,27,1],[106,17,106,102,1],[107,17,107,63,1],[108,13,108,14,1],[111,9,111,10,1],[115,9,115,10,1],[116,20,116,62,1],[117,20,117,152,1],[118,20,118,76,1],[119,20,119,78,1],[120,13,120,14,1],[121,17,121,40,1],[123,17,123,59,1],[126,17,129,49,1],[129,49,129,79,1],[129,79,129,81,1],[126,17,129,81,1],[131,17,131,63,1],[132,17,132,64,1],[135,17,135,61,1],[138,17,138,60,1],[139,17,140,27,1],[143,17,143,82,1],[144,17,144,60,1],[147,17,147,61,1],[150,17,150,73,1],[151,17,152,27,1],[155,17,155,99,1],[156,17,156,60,1],[157,13,157,14,1],[158,9,158,10,1],[167,9,167,10,1],[168,20,168,62,1],[169,20,169,152,1],[170,20,170,109,1],[171,20,171,78,1],[172,13,172,14,1],[173,17,173,40,1],[175,17,175,63,1],[179,17,179,98,1],[180,17,180,53,1],[181,17,181,33,1],[184,17,184,67,1],[185,17,185,56,1],[186,17,186,59,1],[187,17,187,44,1],[188,17,188,53,1],[191,17,191,54,1],[193,17,193,63,1],[194,17,194,59,1],[195,17,195,44,1],[201,17,201,54,1],[202,13,202,14,1],[203,9,203,10,1],[210,9,210,10,1],[212,20,212,62,1],[213,20,213,152,1],[214,20,214,76,1],[215,20,215,78,1],[216,13,216,14,1],[217,17,217,40,1],[221,17,221,58,1],[224,17,224,99,1],[225,17,225,60,1],[227,17,227,95,1],[228,17,228,60,1],[229,13,229,14,1],[230,9,230,10,1],[235,9,235,10,1],[236,13,236,29,1],[238,13,238,70,1],[239,13,239,66,1],[240,9,240,10,1]]);
    </script>
  </body>
</html>