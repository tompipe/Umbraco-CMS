<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.controls\TreePicker\BaseTreePicker.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.UI;
using ClientDependency.Core;
using ClientDependency.Core.Controls;
using umbraco.interfaces;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using umbraco.cms.businesslogic;
namespace umbraco.uicontrols.TreePicker
{

    /*
    [ClientDependency(0, ClientDependencyType.Javascript, &quot;Application/NamespaceManager.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Css, &quot;modal/style.css&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;modal/modal.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;Application/UmbracoClientManager.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Javascript, &quot;Application/UmbracoUtils.js&quot;, &quot;UmbracoClient&quot;)]*/

    [ValidationProperty(&quot;Value&quot;)]
    public abstract class BaseTreePicker : Control, INamingContainer
    {
        
        protected HiddenField ItemIdValue;
        protected HtmlAnchor DeleteLink;
        protected HtmlAnchor ChooseLink;
        protected HtmlGenericControl ItemTitle;
        protected HtmlGenericControl ButtonContainer;
        protected HtmlGenericControl RootContainer;

        public BaseTreePicker()
        {
            ShowDelete = true;
            ModalHeight = 400;
            ModalWidth = 300;
            ShowHeader = true;
        }

        /// &lt;summary&gt;
        /// Wraps the hidden vield value
        /// &lt;/summary&gt;
        public string Value
        {
            get
            {
                EnsureChildControls();
                return ItemIdValue.Value;
            }
            set
            {
                EnsureChildControls();
                ItemIdValue.Value = value;
            }
        }

        public int ModalWidth { get; set; }
        public int ModalHeight { get; set; }
        public bool ShowDelete { get; set; }
        public bool ShowHeader { get; set; }

        /// &lt;summary&gt;
        /// Need to specify the tree picker url (iframe)
        /// &lt;/summary&gt;
        public abstract string TreePickerUrl { get; }

        /// &lt;summary&gt;
        /// The title to specify for the picker window
        /// &lt;/summary&gt;
        public abstract string ModalWindowTitle { get; }

        /// &lt;summary&gt;
        /// If item has been selected or stored, this will query the db for its title
        /// &lt;/summary&gt;
        protected virtual string GetItemTitle()
        {
            if (!string.IsNullOrEmpty(ItemIdValue.Value))
            {
                try
                {
                    return new CMSNode(int.Parse(ItemIdValue.Value)).Text;
                }
                catch (ArgumentException) { /*the node does not exist! we will ignore*/ }
            }
            return &quot;&quot;;
        }

        /// &lt;summary&gt;
        /// Just like GetItemTitle, except returns the full path (breadcrumbs) of the node
        /// &lt;/summary&gt;
        protected virtual string GetItemBreadcrumbs()
        {
            if (!string.IsNullOrEmpty(ItemIdValue.Value))
            {
                try
                {
                    int nodeId = -1;
                    if (int.TryParse(ItemIdValue.Value, out nodeId))
                    {
                        CMSNode node = new CMSNode(nodeId);
                        string title = node.Text;
                        string separator = &quot; &gt; &quot;;
                        while (node != null &amp;&amp; node.Level &gt; 1)
                        {
                            node = node.Parent;
                            title = node.Text + separator + title;
                        }
                        return title;
                    }
                    else
                    {
                        return ItemIdValue.Value;
                    }
                    
                }
                catch (ArgumentException) { /*the node does not exist! we will ignore*/ }
            }
            return &quot;&quot;;
        }

        /// &lt;summary&gt;
        /// Outputs the JavaScript instances used to make this control work
        /// &lt;/summary&gt;
        protected virtual string GetJSScript()
        {            
            /* 0 = this control&#39;s client id
             * 1 = label 
             * 2 = itemIdValueClientID
             * 3 = itemTitleClientID
             * 4 = itemPickerUrl
             * 5 = popup width
             * 6 = popup height
             * 7 = show header
             * 8 = umbraco path
            */
            return string.Format(@&quot;
                var mc_{0} = new Umbraco.Controls.TreePicker(&#39;{0}&#39;,&#39;{1}&#39;,&#39;{2}&#39;,&#39;{3}&#39;,&#39;{4}&#39;,{5},{6},{7},&#39;{8}&#39;);&quot;,
                    new string[]
                 {
                    this.ClientID,
                    ModalWindowTitle,
                    ItemIdValue.ClientID,                    
                    ItemTitle.ClientID,
                    TreePickerUrl,
                    ModalWidth.ToString(),
                    ModalHeight.ToString(),
                    ShowHeader.ToString().ToLower(),
                    Umbraco.Core.IO.IOHelper.ResolveUrl(Umbraco.Core.IO.SystemDirectories.Umbraco).TrimEnd(&#39;/&#39;)
                 });
        }

        /// &lt;summary&gt;
        /// Registers the required JS classes required to make this control work
        /// &lt;/summary&gt;
        protected virtual void RenderJSComponents()
        {
            const string scriptKey = &quot;BaseTreePickerScripts&quot;;
            if (ScriptManager.GetCurrent(Page).IsInAsyncPostBack)
            {
                ScriptManager.RegisterStartupScript(this, this.GetType(), scriptKey, BaseTreePickerScripts.BaseTreePicker, true);
            }
            else
            {
                Page.ClientScript.RegisterClientScriptBlock(typeof(BaseTreePicker), scriptKey, BaseTreePickerScripts.BaseTreePicker, true);
            }
        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            EnsureChildControls();

            //disable view state for this control
            this.EnableViewState = false;
        }

        /// &lt;summary&gt;
        /// Create the native .net child controls for this control
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            base.CreateChildControls();

            RootContainer = new HtmlGenericControl(&quot;span&quot;);
            RootContainer.Attributes.Add(&quot;class&quot;, &quot;umb-tree-picker&quot;);
            this.Controls.Add(RootContainer);

            //create the hidden field
            ItemIdValue = new HiddenField();
            ItemIdValue.ID = &quot;ContentIdValue&quot;;
            RootContainer.Controls.Add(ItemIdValue);

            
            ButtonContainer = new HtmlGenericControl(&quot;span&quot;);
            ButtonContainer.ID = &quot;btns&quot;;

            //add item title with padding
            ItemTitle = new HtmlGenericControl(&quot;span&quot;);
            ItemTitle.ID = &quot;title&quot;;
            ItemTitle.Style.Add(HtmlTextWriterStyle.FontWeight, &quot;bold&quot;);
            ItemTitle.Attributes.Add(&quot;class&quot;, &quot;treePickerTitle&quot;);      // solely for styling, e.g. with an underline or dotted border, etc.
            ButtonContainer.Controls.Add(ItemTitle);
            ButtonContainer.Attributes.Add(&quot;class&quot;, &quot;buttons&quot;);
            ButtonContainer.Controls.Add(new LiteralControl(&quot;&amp;nbsp;&quot;));
            ButtonContainer.Controls.Add(new LiteralControl(&quot;&amp;nbsp;&quot;));

            //add the delete link with padding                
            DeleteLink = new HtmlAnchor();
            DeleteLink.HRef = &quot;#&quot;; //set on pre-render
            DeleteLink.Style.Add(HtmlTextWriterStyle.Color, &quot;red&quot;);
            DeleteLink.Title = ui.GetText(&quot;delete&quot;);
            DeleteLink.InnerText = ui.GetText(&quot;delete&quot;);
            DeleteLink.Attributes.Add(&quot;class&quot;, &quot;clear&quot;);

            ButtonContainer.Controls.Add(DeleteLink);
            ButtonContainer.Controls.Add(new LiteralControl(&quot;&amp;nbsp;&quot;));
            ButtonContainer.Controls.Add(new LiteralControl(&quot;&amp;nbsp;&quot;));
            if (!ShowDelete)
            {
                DeleteLink.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            }

            RootContainer.Controls.Add(ButtonContainer);

            //add choose link with padding
            ChooseLink = new HtmlAnchor();
            ChooseLink.HRef = &quot;#&quot;; //filled in on pre-render
            ChooseLink.InnerText = ui.GetText(&quot;choose&quot;) + &quot;...&quot;;
            ChooseLink.Attributes.Add(&quot;data-section&quot;, this.TreePickerUrl);
            ChooseLink.Attributes.Add(&quot;class&quot;, &quot;choose&quot;);

            RootContainer.Controls.Add(ChooseLink);
        }

        /// &lt;summary&gt;
        /// Registers the JavaScript required for the control to function and hides/shows controls depending on it&#39;s properties
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            //hide the buttons if no item, otherwise get the item title
            if (string.IsNullOrEmpty(ItemIdValue.Value))
            {
                ButtonContainer.Style.Add(HtmlTextWriterStyle.Display, &quot;none&quot;);
            }
            else
            {
                ItemTitle.InnerText = GetItemTitle();
                ItemTitle.Attributes.Add(&quot;title&quot;, GetItemBreadcrumbs());   // Adding full path/meta info (Issue U4-192)
            }  
            /*
            ChooseLink.HRef = string.Format(&quot;javascript:mc_{0}.LaunchPicker();&quot;, this.ClientID);
            DeleteLink.HRef = string.Format(&quot;javascript:mc_{0}.ClearSelection();&quot;, this.ClientID);
            */

            RenderJSComponents();

            /*
            if (ScriptManager.GetCurrent(Page).IsInAsyncPostBack)
            {
                ScriptManager.RegisterStartupScript(this, this.GetType(), this.ClientID + &quot;TreePicker&quot;, GetJSScript(), true);
            }
            else
            {
                Page.ClientScript.RegisterStartupScript(this.GetType(), this.ClientID + &quot;TreePicker&quot;, GetJSScript(), true);
            }*/

        }

        
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,32,0],[31,9,31,10,0],[32,13,32,31,0],[33,13,33,31,0],[34,13,34,30,0],[35,13,35,31,0],[36,9,36,10,0],[44,13,44,14,0],[45,17,45,39,0],[46,17,46,42,0],[47,13,47,14,0],[49,13,49,14,0],[50,17,50,39,0],[51,17,51,43,0],[52,13,52,14,0],[55,33,55,37,0],[55,38,55,42,0],[56,34,56,38,0],[56,39,56,43,0],[57,34,57,38,0],[57,39,57,43,0],[58,34,58,38,0],[58,39,58,43,0],[74,9,74,10,0],[75,13,75,58,0],[76,13,76,14,0],[78,17,78,18,0],[79,21,79,75,0],[81,17,81,42,0],[81,43,81,44,0],[81,89,81,90,0],[82,13,82,14,0],[83,13,83,23,0],[84,9,84,10,0],[90,9,90,10,0],[91,13,91,58,0],[92,13,92,14,0],[94,17,94,18,0],[95,21,95,37,0],[96,21,96,69,0],[97,21,97,22,0],[98,25,98,60,0],[99,25,99,50,0],[100,25,100,50,0],[101,25,101,63,0],[102,25,102,26,0],[103,29,103,48,0],[104,29,104,67,0],[105,25,105,26,0],[106,25,106,38,0],[109,21,109,22,0],[110,25,110,50,0],[114,17,114,42,0],[114,43,114,44,0],[114,89,114,90,0],[115,13,115,14,0],[116,13,116,23,0],[117,9,117,10,0],[123,9,123,10,0],[134,13,147,21,0],[148,9,148,10,0],[154,9,154,10,0],[156,13,156,66,0],[157,13,157,14,0],[158,17,158,130,0],[159,13,159,14,0],[161,13,161,14,0],[162,17,162,140,0],[163,13,163,14,0],[164,9,164,10,0],[167,9,167,10,0],[168,13,168,28,0],[170,13,170,35,0],[173,13,173,42,0],[174,9,174,10,0],[180,9,180,10,0],[181,13,181,40,0],[183,13,183,60,0],[184,13,184,70,0],[185,13,185,46,0],[188,13,188,45,0],[189,13,189,47,0],[190,13,190,53,0],[193,13,193,62,0],[194,13,194,41,0],[197,13,197,56,0],[198,13,198,36,0],[199,13,199,73,0],[200,13,200,66,0],[201,13,201,53,0],[202,13,202,64,0],[203,13,203,72,0],[204,13,204,72,0],[207,13,207,43,0],[208,13,208,35,0],[209,13,209,68,0],[210,13,210,53,0],[211,13,211,57,0],[212,13,212,57,0],[214,13,214,54,0],[215,13,215,72,0],[216,13,216,72,0],[217,13,217,29,0],[218,13,218,14,0],[219,17,219,75,0],[220,13,220,14,0],[222,13,222,57,0],[225,13,225,43,0],[226,13,226,35,0],[227,13,227,65,0],[228,13,228,75,0],[229,13,229,58,0],[231,13,231,52,0],[232,9,232,10,0],[239,9,239,10,0],[240,13,240,33,0],[243,13,243,57,0],[244,13,244,14,0],[245,17,245,80,0],[246,13,246,14,0],[248,13,248,14,0],[249,17,249,54,0],[250,17,250,73,0],[251,13,251,14,0],[257,13,257,34,0],[269,9,269,10,0]]);
    </script>
  </body>
</html>