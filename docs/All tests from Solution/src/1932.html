<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\TemplateFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;

namespace Umbraco.Core.Persistence.Factories
{
    internal class TemplateFactory
    {
        private readonly int _primaryKey;
        private readonly Guid _nodeObjectTypeId;

        public TemplateFactory()
        {
            
        }

        public TemplateFactory(Guid nodeObjectTypeId)
        {
            _nodeObjectTypeId = nodeObjectTypeId;
        }

        public TemplateFactory(int primaryKey, Guid nodeObjectTypeId)
        {
            _primaryKey = primaryKey;
            _nodeObjectTypeId = nodeObjectTypeId;
        }

        #region Implementation of IEntityFactory&lt;ITemplate,TemplateDto&gt;

        public Template BuildEntity(TemplateDto dto, IEnumerable&lt;IUmbracoEntity&gt; childDefinitions, Func&lt;File, string&gt; getFileContent)
        {
            var template = new Template(dto.NodeDto.Text, dto.Alias, getFileContent);

            try
            {
                template.DisableChangeTracking();

                template.CreateDate = dto.NodeDto.CreateDate;
                template.Id = dto.NodeId;
                template.Key = dto.NodeDto.UniqueId;
                template.Path = dto.NodeDto.Path;

                template.IsMasterTemplate = childDefinitions.Any(x =&gt; x.ParentId == dto.NodeId);

                if (dto.NodeDto.ParentId &gt; 0)
                    template.MasterTemplateId = new Lazy&lt;int&gt;(() =&gt; dto.NodeDto.ParentId);

                //on initial construction we don&#39;t want to have dirty properties tracked
                // http://issues.umbraco.org/issue/U4-1946
                template.ResetDirtyProperties(false);
                return template;
            }
            finally
            {
                template.EnableChangeTracking();
            }
        }

        public TemplateDto BuildDto(Template entity)
        {
            var dto = new TemplateDto
                       {
                           Alias = entity.Alias,
                           Design = entity.Content ?? string.Empty,
                           NodeDto = BuildNodeDto(entity)
                       };

            if (entity.MasterTemplateId != null &amp;&amp; entity.MasterTemplateId.Value &gt; 0)
            {
                dto.NodeDto.ParentId = entity.MasterTemplateId.Value;
            }

            if (entity.HasIdentity)
            {
                dto.NodeId = entity.Id;
                dto.PrimaryKey = _primaryKey;
            }

            return dto;
        }

        #endregion

        private NodeDto BuildNodeDto(Template entity)
        {
            var nodeDto = new NodeDto
                              {
                                  CreateDate = entity.CreateDate,
                                  NodeId = entity.Id,
                                  Level = 1,
                                  NodeObjectType = _nodeObjectTypeId,
                                  ParentId = entity.MasterTemplateId.Value,
                                  Path = entity.Path,
                                  Text = entity.Name,
                                  Trashed = false,
                                  UniqueId = entity.Key
                              };

            return nodeDto;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,33,1],[19,9,19,10,1],[21,9,21,10,1],[23,9,23,54,1],[24,9,24,10,1],[25,13,25,50,1],[26,9,26,10,1],[28,9,28,70,1],[29,9,29,10,1],[30,13,30,38,1],[31,13,31,50,1],[32,9,32,10,1],[37,9,37,10,1],[38,13,38,86,1],[41,13,41,14,1],[42,17,42,50,1],[44,17,44,62,1],[45,17,45,42,1],[46,17,46,53,1],[47,17,47,50,1],[49,17,49,71,1],[49,71,49,95,1],[49,95,49,97,1],[49,17,49,97,1],[51,17,51,46,1],[52,21,52,69,1],[52,69,52,89,0],[52,89,52,91,1],[52,21,52,91,1],[56,17,56,54,1],[57,17,57,33,1],[60,13,60,14,1],[61,17,61,49,1],[62,13,62,14,1],[63,9,63,10,1],[66,9,66,10,1],[67,13,72,26,1],[74,13,74,86,1],[75,13,75,14,1],[76,17,76,70,1],[77,13,77,14,1],[79,13,79,36,1],[80,13,80,14,1],[81,17,81,40,1],[82,17,82,46,1],[83,13,83,14,1],[85,13,85,24,1],[86,9,86,10,1],[91,9,91,10,1],[92,13,103,33,1],[105,13,105,28,1],[106,9,106,10,1]]);
    </script>
  </body>
</html>