<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\FaultHandling\Strategies\ExponentialBackoff.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;

namespace Umbraco.Core.Persistence.FaultHandling.Strategies
{
    /// &lt;summary&gt;
    /// A retry strategy with back-off parameters for calculating the exponential delay between retries.
    /// &lt;/summary&gt;
    public class ExponentialBackoff : RetryStrategy
    {
        private readonly int retryCount;
        private readonly TimeSpan minBackoff;
        private readonly TimeSpan maxBackoff;
        private readonly TimeSpan deltaBackoff;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;ExponentialBackoff&quot;/&gt; class. 
        /// &lt;/summary&gt;
        public ExponentialBackoff()
            : this(DefaultClientRetryCount, DefaultMinBackoff, DefaultMaxBackoff, DefaultClientBackoff)
        {
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;ExponentialBackoff&quot;/&gt; class. 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;retryCount&quot;&gt;The maximum number of retry attempts.&lt;/param&gt;
        /// &lt;param name=&quot;minBackoff&quot;&gt;The minimum back-off time&lt;/param&gt;
        /// &lt;param name=&quot;maxBackoff&quot;&gt;The maximum back-off time.&lt;/param&gt;
        /// &lt;param name=&quot;deltaBackoff&quot;&gt;The value that will be used for calculating a random delta in the exponential delay between retries.&lt;/param&gt;
        public ExponentialBackoff(int retryCount, TimeSpan minBackoff, TimeSpan maxBackoff, TimeSpan deltaBackoff)
            : this(null, retryCount, minBackoff, maxBackoff, deltaBackoff, DefaultFirstFastRetry)
        {
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;ExponentialBackoff&quot;/&gt; class. 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;The name of the retry strategy.&lt;/param&gt;
        /// &lt;param name=&quot;retryCount&quot;&gt;The maximum number of retry attempts.&lt;/param&gt;
        /// &lt;param name=&quot;minBackoff&quot;&gt;The minimum back-off time&lt;/param&gt;
        /// &lt;param name=&quot;maxBackoff&quot;&gt;The maximum back-off time.&lt;/param&gt;
        /// &lt;param name=&quot;deltaBackoff&quot;&gt;The value that will be used for calculating a random delta in the exponential delay between retries.&lt;/param&gt;
        public ExponentialBackoff(string name, int retryCount, TimeSpan minBackoff, TimeSpan maxBackoff, TimeSpan deltaBackoff)
            : this(name, retryCount, minBackoff, maxBackoff, deltaBackoff, DefaultFirstFastRetry)
        {
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;ExponentialBackoff&quot;/&gt; class. 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;The name of the retry strategy.&lt;/param&gt;
        /// &lt;param name=&quot;retryCount&quot;&gt;The maximum number of retry attempts.&lt;/param&gt;
        /// &lt;param name=&quot;minBackoff&quot;&gt;The minimum back-off time&lt;/param&gt;
        /// &lt;param name=&quot;maxBackoff&quot;&gt;The maximum back-off time.&lt;/param&gt;
        /// &lt;param name=&quot;deltaBackoff&quot;&gt;The value that will be used for calculating a random delta in the exponential delay between retries.&lt;/param&gt;
        /// &lt;param name=&quot;firstFastRetry&quot;&gt;
        /// Indicates whether or not the very first retry attempt will be made immediately 
        /// whereas the subsequent retries will remain subject to retry interval.
        /// &lt;/param&gt;
        public ExponentialBackoff(string name, int retryCount, TimeSpan minBackoff, TimeSpan maxBackoff, TimeSpan deltaBackoff, bool firstFastRetry)
            : base(name, firstFastRetry)
        {
            //Guard.ArgumentNotNegativeValue(retryCount, &quot;retryCount&quot;);
            //Guard.ArgumentNotNegativeValue(minBackoff.Ticks, &quot;minBackoff&quot;);
            //Guard.ArgumentNotNegativeValue(maxBackoff.Ticks, &quot;maxBackoff&quot;);
            //Guard.ArgumentNotNegativeValue(deltaBackoff.Ticks, &quot;deltaBackoff&quot;);
            //Guard.ArgumentNotGreaterThan(minBackoff.TotalMilliseconds, maxBackoff.TotalMilliseconds, &quot;minBackoff&quot;);

            this.retryCount = retryCount;
            this.minBackoff = minBackoff;
            this.maxBackoff = maxBackoff;
            this.deltaBackoff = deltaBackoff;
        }

        /// &lt;summary&gt;
        /// Returns the corresponding ShouldRetry delegate.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The ShouldRetry delegate.&lt;/returns&gt;
        public override ShouldRetry GetShouldRetry()
        {
            return delegate(int currentRetryCount, Exception lastException, out TimeSpan retryInterval)
            {
                if (currentRetryCount &lt; this.retryCount)
                {
                    var random = new Random();

                    var delta = (int)((Math.Pow(2.0, currentRetryCount) - 1.0) * random.Next((int)(this.deltaBackoff.TotalMilliseconds * 0.8), (int)(this.deltaBackoff.TotalMilliseconds * 1.2)));
                    var interval = (int)Math.Min(checked(this.minBackoff.TotalMilliseconds + delta), this.maxBackoff.TotalMilliseconds);

                    retryInterval = TimeSpan.FromMilliseconds(interval);

                    return true;
                }

                retryInterval = TimeSpan.Zero;
                return false;
            };
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,15,19,104,1],[20,9,20,10,1],[21,9,21,10,1],[31,15,31,98,1],[32,9,32,10,1],[33,9,33,10,1],[44,15,44,98,0],[45,9,45,10,0],[46,9,46,10,0],[61,15,61,41,1],[62,9,62,10,1],[69,13,69,42,1],[70,13,70,42,1],[71,13,71,42,1],[72,13,72,46,1],[73,9,73,10,1],[80,9,80,10,1],[81,13,82,13,1],[82,13,82,14,0],[82,14,83,17,1],[83,17,83,57,0],[83,57,84,17,1],[84,17,84,18,0],[84,18,85,21,1],[85,21,85,47,0],[85,47,87,21,1],[87,21,87,195,0],[87,195,88,21,1],[88,21,88,137,0],[88,137,90,21,1],[90,21,90,73,0],[90,73,92,21,1],[92,21,92,33,0],[92,33,95,17,1],[95,17,95,47,0],[95,47,96,17,1],[96,17,96,30,0],[96,30,97,13,1],[97,13,97,14,0],[97,14,97,15,1],[81,13,97,15,1],[98,9,98,10,1]]);
    </script>
  </body>
</html>