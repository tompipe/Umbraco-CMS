<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebApi\Filters\FilterAllowedOutgoingContentAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Reflection;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Services;
using umbraco.BusinessLogic.Actions;
using Umbraco.Core;

namespace Umbraco.Web.WebApi.Filters
{
    /// &lt;summary&gt;
    /// This inspects the result of the action that returns a collection of content and removes 
    /// any item that the current user doesn&#39;t have access to
    /// &lt;/summary&gt;
    internal sealed class FilterAllowedOutgoingContentAttribute : FilterAllowedOutgoingMediaAttribute
    {
        private readonly char _permissionToCheck;

        public FilterAllowedOutgoingContentAttribute(Type outgoingType) 
            : base(outgoingType)
        {
            _permissionToCheck = ActionBrowse.Instance.Letter;
        }

        public FilterAllowedOutgoingContentAttribute(Type outgoingType, char permissionToCheck)
            : base(outgoingType)
        {
            _permissionToCheck = permissionToCheck;
        }

        public FilterAllowedOutgoingContentAttribute(Type outgoingType, string propertyName)
            : base(outgoingType, propertyName)
        {
            _permissionToCheck = ActionBrowse.Instance.Letter;
        }

        protected override void FilterItems(IUser user, IList items)
        {
            base.FilterItems(user, items);

            FilterBasedOnPermissions(items, user, ApplicationContext.Current.Services.UserService);
        }

        protected override int GetUserStartNode(IUser user)
        {
            return user.StartContentId;
        }

        protected override int RecycleBinId
        {
            get { return Constants.System.RecycleBinContent; }
        }

        internal void FilterBasedOnPermissions(IList items, IUser user, IUserService userService)
        {
            var length = items.Count;

            if (length &gt; 0)
            {
                var ids = new List&lt;int&gt;();
                for (var i = 0; i &lt; length; i++)
                {
                    ids.Add(((dynamic)items[i]).Id);
                }
                //get all the permissions for these nodes in one call
                var permissions = userService.GetPermissions(user, ids.ToArray()).ToArray();
                var toRemove = new List&lt;dynamic&gt;();
                foreach (dynamic item in items)
                {
                    var nodePermission = permissions.Where(x =&gt; x.EntityId == Convert.ToInt32(item.Id)).ToArray();
                    //if there are no permissions for this id then we need to check what the user&#39;s default
                    // permissions are.
                    if (nodePermission.Any() == false)
                    {
                        //var defaultP = user.DefaultPermissions

                        toRemove.Add(item);
                    }
                    else
                    {
                        foreach (var n in nodePermission)
                        {
                            //if the permission being checked doesn&#39;t exist then remove the item
                            if (n.AssignedPermissions.Contains(_permissionToCheck.ToString(CultureInfo.InvariantCulture)) == false)
                            {
                                toRemove.Add(item);
                            }
                        }
                    }
                }
                foreach (var item in toRemove)
                {
                    items.Remove(item);
                }
            }
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,15,23,33,1],[24,9,24,10,1],[25,13,25,63,1],[26,9,26,10,1],[29,15,29,33,0],[30,9,30,10,0],[31,13,31,52,0],[32,9,32,10,0],[35,15,35,47,1],[36,9,36,10,1],[37,13,37,63,1],[38,9,38,10,1],[41,9,41,10,0],[42,13,42,43,0],[44,13,44,100,0],[45,9,45,10,0],[48,9,48,10,1],[49,13,49,40,1],[50,9,50,10,1],[54,17,54,18,1],[54,19,54,61,1],[54,62,54,63,1],[58,9,58,10,1],[59,13,59,38,1],[61,13,61,28,1],[62,13,62,14,1],[63,17,63,43,1],[64,22,64,31,1],[64,33,64,43,1],[64,45,64,48,1],[65,17,65,18,1],[66,21,66,53,1],[67,17,67,18,1],[69,17,69,93,1],[70,17,70,52,1],[71,17,71,24,1],[71,26,71,38,1],[71,39,71,41,1],[71,42,71,47,1],[72,17,72,18,1],[73,21,73,65,1],[73,65,73,103,1],[73,103,73,115,1],[73,21,73,115,1],[76,21,76,55,1],[77,21,77,22,1],[80,25,80,44,1],[81,21,81,22,1],[83,21,83,22,1],[84,25,84,32,1],[84,34,84,39,1],[84,40,84,42,1],[84,43,84,57,1],[85,25,85,26,1],[87,29,87,132,1],[88,29,88,30,1],[89,33,89,52,1],[90,29,90,30,1],[91,25,91,26,1],[92,21,92,22,1],[93,17,93,18,1],[94,17,94,24,1],[94,26,94,34,1],[94,35,94,37,1],[94,38,94,46,1],[95,17,95,18,1],[96,21,96,40,1],[97,17,97,18,1],[98,13,98,14,1],[99,9,99,10,1]]);
    </script>
  </body>
</html>