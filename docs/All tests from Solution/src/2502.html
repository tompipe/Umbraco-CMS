<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.businesslogic\ui.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Globalization;
using System.Linq;
using System.Text.RegularExpressions;
using System.Threading;
using System.Web;
using System.Web.Caching;
using System.Xml;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Membership;
using umbraco.BasePages;
using Umbraco.Core.Services;
using File = System.IO.File;
using User = umbraco.BusinessLogic.User;

namespace umbraco
{

    //TODO: Make the User overloads obsolete, then publicize the IUser object

    /// &lt;summary&gt;
    /// The ui class handles the multilingual text in the umbraco back-end.
    /// Provides access to language settings and language files used in the umbraco back-end.
    /// &lt;/summary&gt;
    [Obsolete(&quot;Use the ILocalizedTextService instead which is on the ApplicationContext.Services.TextService&quot;)]
    public class ui
    {
        private static readonly string UmbracoDefaultUiLanguage = GlobalSettings.DefaultUILanguage;
        private static readonly string UmbracoPath = SystemDirectories.Umbraco;

        [EditorBrowsable(EditorBrowsableState.Never)]
        [Obsolete(&quot;Get the current culture/language from the currently logged in IUser, the IUser object is available on most Umbraco base classes and on the UmbracoContext&quot;)]
        public static string Culture(User u)
        {
            if (ApplicationContext.Current == null) return string.Empty;

            var found = UserExtensions.GetUserCulture(u.Language, ApplicationContext.Current.Services.TextService);
            return found == null ? string.Empty : found.Name;
        }

        [EditorBrowsable(EditorBrowsableState.Never)]
        [Obsolete(&quot;Get the current culture/language from the currently logged in IUser, the IUser object is available on most Umbraco base classes and on the UmbracoContext&quot;)]
        internal static string Culture(IUser u)
        {
            if (ApplicationContext.Current == null) return string.Empty;

            var found = u.GetUserCulture(ApplicationContext.Current.Services.TextService);
            return found == null ? string.Empty : found.Name;
        }
        
        private static string GetLanguage()
        {
            var user = UmbracoEnsuredPage.CurrentUser;
            return GetLanguage(user);
        }

        private static string GetLanguage(User u)
        {
            if (u != null)
            {
                return u.Language;
            }
            return GetLanguage(&quot;&quot;);
        }

        private static string GetLanguage(IUser u)
        {
            if (u != null)
            {
                return u.Language;
            }
            return GetLanguage(&quot;&quot;);
        }

        private static string GetLanguage(string userLanguage)
        {
            if (userLanguage.IsNullOrWhiteSpace() == false)
            {
                return userLanguage;
            }
            var language = Thread.CurrentThread.CurrentCulture.TwoLetterISOLanguageName;
            if (string.IsNullOrEmpty(language))
                language = UmbracoDefaultUiLanguage;
            return language;
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key based on the specified user&#39;s language settings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;u&quot;&gt;The user.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string Text(string Key, User u)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + Key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(Key, GetCultureFromUserLanguage(GetLanguage(u)));
        }

        internal static string Text(string key, IUser u)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(key, GetCultureFromUserLanguage(GetLanguage(u)));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key based on the logged-in user&#39;s language settings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string Text(string Key)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + Key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(Key, GetCultureFromUserLanguage(GetLanguage()));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key and area, based on the specified users language settings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Area&quot;&gt;The area.&lt;/param&gt;
        /// &lt;param name=&quot;Key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;u&quot;&gt;The user.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string Text(string Area, string Key, User u)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + Key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, Area, Key),
                GetCultureFromUserLanguage(GetLanguage(u)));
        }

        public static string Text(string area, string key, IUser u)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, area, key),
                GetCultureFromUserLanguage(GetLanguage(u)));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key and area, based on the logged-in users language settings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Area&quot;&gt;The area.&lt;/param&gt;
        /// &lt;param name=&quot;Key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string Text(string Area, string Key)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + Key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, Area, Key),
                GetCultureFromUserLanguage(GetLanguage()));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific area and key. based on the specified users language settings and variables array passed to the method
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Area&quot;&gt;The area.&lt;/param&gt;
        /// &lt;param name=&quot;Key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;Variables&quot;&gt;The variables array.&lt;/param&gt;
        /// &lt;param name=&quot;u&quot;&gt;The user.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string Text(string Area, string Key, string[] Variables, User u)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + Key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, Area, Key),
                GetCultureFromUserLanguage(GetLanguage(u)),
                ConvertToDictionaryVars(Variables));
        }

        internal static string Text(string area, string key, string[] variables)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, area, key),
                GetCultureFromUserLanguage(GetLanguage()),
                ConvertToDictionaryVars(variables));
        }

        internal static string Text(string area, string key, string[] variables, IUser u)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, area, key),
                GetCultureFromUserLanguage(GetLanguage(u)),
                ConvertToDictionaryVars(variables));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key and area based on the specified users language settings and single variable passed to the method
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Area&quot;&gt;The area.&lt;/param&gt;
        /// &lt;param name=&quot;Key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;Variable&quot;&gt;The variable.&lt;/param&gt;
        /// &lt;param name=&quot;u&quot;&gt;The u.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string Text(string Area, string Key, string Variable, User u)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + Key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, Area, Key),
                GetCultureFromUserLanguage(GetLanguage(u)),
                ConvertToDictionaryVars(new[] { Variable }));
        }

        internal static string Text(string area, string key, string variable)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, area, key),
                GetCultureFromUserLanguage(GetLanguage()),
                ConvertToDictionaryVars(new[] { variable }));
        }

        internal static string Text(string area, string key, string variable, IUser u)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, area, key),
                GetCultureFromUserLanguage(GetLanguage(u)),
                ConvertToDictionaryVars(new[] { variable }));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key based on the logged-in user&#39;s language settings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetText(string key)
        {
            return ApplicationContext.Current.Services.TextService.Localize(key, GetCultureFromUserLanguage(GetLanguage()));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key and area based on the logged-in users language settings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;area&quot;&gt;The area.&lt;/param&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetText(string area, string key)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
                string.Format(&quot;{0}/{1}&quot;, area, key),
                GetCultureFromUserLanguage(GetLanguage()));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key and area based on the logged-in users language settings and variables array send to the method.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;area&quot;&gt;The area.&lt;/param&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;variables&quot;&gt;The variables.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetText(string area, string key, string[] variables)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
               string.Format(&quot;{0}/{1}&quot;, area, key),
               GetCultureFromUserLanguage(GetLanguage()),
               ConvertToDictionaryVars(variables));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key and area matching the variable send to the method.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;area&quot;&gt;The area.&lt;/param&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;variable&quot;&gt;The variable.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetText(string area, string key, string variable)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
               string.Format(&quot;{0}/{1}&quot;, area, key),
               GetCultureFromUserLanguage(GetLanguage()),
               ConvertToDictionaryVars(new[] { variable }));
        }

        /// &lt;summary&gt;
        /// Returns translated UI text with a specific key, area and language matching the variables send to the method.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;area&quot;&gt;The area (Optional)&lt;/param&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key (Required)&lt;/param&gt;
        /// &lt;param name=&quot;variables&quot;&gt;The variables (Optional)&lt;/param&gt;
        /// &lt;param name=&quot;language&quot;&gt;The language (Optional)&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;This is the underlying call for all Text/GetText method calls&lt;/remarks&gt;
        public static string GetText(string area, string key, string[] variables, string language)
        {
            if (ApplicationContext.Current == null) return &quot;[&quot; + key + &quot;]&quot;;

            return ApplicationContext.Current.Services.TextService.Localize(
               string.Format(&quot;{0}/{1}&quot;, area, key),
               GetCultureFromUserLanguage(GetLanguage()),
               ConvertToDictionaryVars(variables));
        }
    
        /// &lt;summary&gt;
        /// Gets the language file as a xml document.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;language&quot;&gt;The language.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;This is no longer used and will be removed from the codebase in future versions, to get the contents of language text use ILocalizedTextService.GetAllStoredValues&quot;)]
        public static XmlDocument getLanguageFile(string language)
        {
            var cacheKey = &quot;uitext_&quot; + language;

            var file = IOHelper.MapPath(UmbracoPath + &quot;/config/lang/&quot; + language + &quot;.xml&quot;);
            if (File.Exists(file))
            {
                return ApplicationContext.Current.ApplicationCache.GetCacheItem(
                    cacheKey,
                    CacheItemPriority.Default,
                    new CacheDependency(IOHelper.MapPath(UmbracoPath + &quot;/config/lang/&quot; + language + &quot;.xml&quot;)),
                    () =&gt;
                        {
                            using (var langReader = new XmlTextReader(IOHelper.MapPath(UmbracoPath + &quot;/config/lang/&quot; + language + &quot;.xml&quot;)))
                            {
                                try
                                {
                                    var langFile = new XmlDocument();
                                    langFile.Load(langReader);
                                    return langFile;
                                }
                                catch (Exception e)
                                {
                                    LogHelper.Error&lt;ui&gt;(&quot;Error reading umbraco language xml source (&quot; + language + &quot;)&quot;, e);
                                    return null;
                                }
                            }
                        });
            }
            else
            {
                return null;
            }

        }

        /// &lt;summary&gt;
        /// Convert an array of strings to a dictionary of indicies -&gt; values
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;variables&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal static IDictionary&lt;string, string&gt; ConvertToDictionaryVars(string[] variables)
        {
            if (variables == null) return null;
            if (variables.Any() == false) return null;

            return variables.Select((s, i) =&gt; new {index = i.ToString(CultureInfo.InvariantCulture), value = s})
                .ToDictionary(keyvals =&gt; keyvals.index, keyvals =&gt; keyvals.value);
        }

        private static CultureInfo GetCultureFromUserLanguage(string userLang)
        {
            return CultureInfo.GetCultureInfo(userLang.Replace(&quot;_&quot;, &quot;-&quot;));
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[34,9,34,100,1],[35,9,35,80,1],[40,9,40,10,0],[41,13,41,52,0],[41,53,41,73,0],[43,13,43,116,0],[44,13,44,62,0],[45,9,45,10,0],[50,9,50,10,0],[51,13,51,52,0],[51,53,51,73,0],[53,13,53,91,0],[54,13,54,62,0],[55,9,55,10,0],[58,9,58,10,1],[59,13,59,55,1],[60,13,60,38,1],[61,9,61,10,1],[64,9,64,10,1],[65,13,65,27,1],[66,13,66,14,0],[67,17,67,35,0],[69,13,69,36,1],[70,9,70,10,1],[73,9,73,10,0],[74,13,74,27,0],[75,13,75,14,0],[76,17,76,35,0],[78,13,78,36,0],[79,9,79,10,0],[82,9,82,10,1],[83,13,83,60,1],[84,13,84,14,0],[85,17,85,37,0],[87,13,87,89,1],[88,13,88,48,1],[89,17,89,53,0],[90,13,90,29,1],[91,9,91,10,1],[100,9,100,10,0],[101,13,101,52,0],[101,53,101,76,0],[103,13,103,126,0],[104,9,104,10,0],[107,9,107,10,0],[108,13,108,52,0],[108,53,108,76,0],[110,13,110,126,0],[111,9,111,10,0],[119,9,119,10,0],[120,13,120,52,0],[120,53,120,76,0],[122,13,122,125,0],[123,9,123,10,0],[133,9,133,10,0],[134,13,134,52,0],[134,53,134,76,0],[136,13,138,61,0],[139,9,139,10,0],[142,9,142,10,0],[143,13,143,52,0],[143,53,143,76,0],[145,13,147,61,0],[148,9,148,10,0],[157,9,157,10,1],[158,13,158,52,1],[158,53,158,76,1],[160,13,162,60,1],[163,9,163,10,1],[174,9,174,10,0],[175,13,175,52,0],[175,53,175,76,0],[177,13,180,53,0],[181,9,181,10,0],[184,9,184,10,0],[185,13,185,52,0],[185,53,185,76,0],[187,13,190,53,0],[191,9,191,10,0],[194,9,194,10,0],[195,13,195,52,0],[195,53,195,76,0],[197,13,200,53,0],[201,9,201,10,0],[212,9,212,10,0],[213,13,213,52,0],[213,53,213,76,0],[215,13,218,62,0],[219,9,219,10,0],[222,9,222,10,0],[223,13,223,52,0],[223,53,223,76,0],[225,13,228,62,0],[229,9,229,10,0],[232,9,232,10,0],[233,13,233,52,0],[233,53,233,76,0],[235,13,238,62,0],[239,9,239,10,0],[247,9,247,10,0],[248,13,248,125,0],[249,9,249,10,0],[258,9,258,10,0],[259,13,259,52,0],[259,53,259,76,0],[261,13,263,60,0],[264,9,264,10,0],[274,9,274,10,0],[275,13,275,52,0],[275,53,275,76,0],[277,13,280,52,0],[281,9,281,10,0],[291,9,291,10,0],[292,13,292,52,0],[292,53,292,76,0],[294,13,297,61,0],[298,9,298,10,0],[310,9,310,10,0],[311,13,311,52,0],[311,53,311,76,0],[313,13,316,52,0],[317,9,317,10,0],[326,9,326,10,0],[327,13,327,49,0],[329,13,329,92,0],[330,13,330,35,0],[331,13,331,14,0],[332,17,337,25,0],[337,25,337,26,0],[337,26,338,36,0],[338,36,338,139,0],[338,139,339,29,0],[339,29,339,30,0],[339,30,341,33,0],[341,33,341,34,0],[341,34,342,37,0],[342,37,342,70,0],[342,70,343,37,0],[343,37,343,63,0],[343,63,344,37,0],[344,37,344,53,0],[344,53,346,33,0],[346,33,346,52,0],[346,52,347,33,0],[347,33,347,34,0],[347,34,348,37,0],[348,37,348,124,0],[348,124,349,37,0],[349,37,349,49,0],[349,49,352,25,0],[352,25,352,26,0],[352,26,352,28,0],[332,17,352,28,0],[355,13,355,14,0],[356,17,356,29,0],[359,9,359,10,0],[367,9,367,10,0],[368,13,368,35,0],[368,36,368,48,0],[369,13,369,42,0],[369,43,369,55,0],[371,13,371,47,0],[371,47,371,112,0],[371,112,372,42,0],[372,42,372,55,0],[372,55,372,68,0],[372,68,372,81,0],[372,81,372,83,0],[371,13,372,83,0],[373,9,373,10,0],[376,9,376,10,1],[377,13,377,75,1],[378,9,378,10,1]]);
    </script>
  </body>
</html>