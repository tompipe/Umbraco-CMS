<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.businesslogic\BasePages\BasePage.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Web;
using System.Linq;
using System.Web.Mvc;
using System.Web.Routing;
using System.Web.Security;
using System.Web.UI;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Cache;
using Umbraco.Core.Logging;
using Umbraco.Core.Services;
using umbraco.BusinessLogic;
using umbraco.DataLayer;
using Umbraco.Core;
using Umbraco.Core.Security;

namespace umbraco.BasePages
{
    /// &lt;summary&gt;
    /// umbraco.BasePages.BasePage is the default page type for the umbraco backend.
    /// The basepage keeps track of the current user and the page context. But does not 
    /// Restrict access to the page itself.
    /// The keep the page secure, the umbracoEnsuredPage class should be used instead
    /// &lt;/summary&gt;
    [Obsolete(&quot;This class has been superceded by Umbraco.Web.UI.Pages.BasePage&quot;)]
    public class BasePage : System.Web.UI.Page
    {
        private User _user;
        private bool _userisValidated = false;
        private ClientTools _clientTools;
        
        /// &lt;summary&gt;
        /// The path to the umbraco root folder
        /// &lt;/summary&gt;
        protected string UmbracoPath = SystemDirectories.Umbraco;

        /// &lt;summary&gt;
        /// The current user ID
        /// &lt;/summary&gt;
        protected int uid = 0;

        /// &lt;summary&gt;
        /// The page timeout in seconds.
        /// &lt;/summary&gt;
        protected long timeout = 0;

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        protected static ISqlHelper SqlHelper
        {
            get { return BusinessLogic.Application.SqlHelper; }
        }        

        /// &lt;summary&gt;
        /// Returns the current ApplicationContext
        /// &lt;/summary&gt;
        public ApplicationContext ApplicationContext
        {
            get { return ApplicationContext.Current; }
        }

        /// &lt;summary&gt;
        /// Returns a ServiceContext
        /// &lt;/summary&gt;
        public ServiceContext Services
        {
            get { return ApplicationContext.Services; }
        }

        /// &lt;summary&gt;
        /// Returns a DatabaseContext
        /// &lt;/summary&gt;
        public DatabaseContext DatabaseContext
        {
            get { return ApplicationContext.DatabaseContext; }
        }

        /// &lt;summary&gt;
        /// Returns the current BasePage for the current request. 
        /// This assumes that the current page is a BasePage, otherwise, returns null;
        /// &lt;/summary&gt;
        [Obsolete(&quot;Should use the Umbraco.Web.UmbracoContext.Current singleton instead to access common methods and properties&quot;)]
        public static BasePage Current
        {
            get
            {
                var page = HttpContext.Current.CurrentHandler as BasePage;
                if (page != null) return page;
                //the current handler is not BasePage but people might be expecting this to be the case if they 
                // are using this singleton accesor... which is legacy code now and shouldn&#39;t be used. When people
                // start using Umbraco.Web.UI.Pages.BasePage then this will not be the case! So, we&#39;ll just return a 
                // new instance of BasePage as a hack to make it work.
                if (HttpContext.Current.Items[&quot;umbraco.BasePages.BasePage&quot;] == null)
                {
                    HttpContext.Current.Items[&quot;umbraco.BasePages.BasePage&quot;] = new BasePage();
                }
                return (BasePage)HttpContext.Current.Items[&quot;umbraco.BasePages.BasePage&quot;];
            }
        }

	    private UrlHelper _url;
		/// &lt;summary&gt;
		/// Returns a UrlHelper
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// This URL helper is created without any route data and an empty request context
		/// &lt;/remarks&gt;
	    public UrlHelper Url
	    {
		    get { return _url ?? (_url = new UrlHelper(new RequestContext(new HttpContextWrapper(Context), new RouteData()))); }
	    }

        /// &lt;summary&gt;
        /// Returns a refernce of an instance of ClientTools for access to the pages client API
        /// &lt;/summary&gt;
        public ClientTools ClientTools
        {
            get
            {
                if (_clientTools == null)
                    _clientTools = new ClientTools(this);
                return _clientTools;
            }
        }

        [Obsolete(&quot;Use ClientTools instead&quot;)]
        public void RefreshPage(int Seconds)
        {
            ClientTools.RefreshAdmin(Seconds);
        }

        //NOTE: This is basically replicated in WebSecurity because this class exists in a poorly placed assembly. - also why it is obsolete.
        private void ValidateUser()
        {
            var ticket = Context.GetUmbracoAuthTicket();

            if (ticket != null)
            {
                if (ticket.Expired == false)
                {
                    _user = BusinessLogic.User.GetUser(GetUserId(&quot;&quot;));

                    // Check for console access
                    if (_user.Disabled || (_user.NoConsole &amp;&amp; GlobalSettings.RequestIsInUmbracoApplication(Context)))
                    {
                        throw new ArgumentException(&quot;You have no priviledges to the umbraco console. Please contact your administrator&quot;);
                    }
                    _userisValidated = true;
                    UpdateLogin();
                }
                else
                {
                    throw new ArgumentException(&quot;User has timed out!!&quot;);
                }
            }
            else
            {
                throw new InvalidOperationException(&quot;The user has no umbraco contextid - try logging in&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Gets the user id.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoUserContextID&quot;&gt;This is not used&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;This method is no longer used, use the GetUserId() method without parameters instead&quot;)]
        public static int GetUserId(string umbracoUserContextID)
        {
            return GetUserId();
        }

        /// &lt;summary&gt;
        /// Gets the currnet user&#39;s id.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static int GetUserId()
        {
            var identity = HttpContext.Current.GetCurrentIdentity(
                //DO NOT AUTO-AUTH UNLESS THE CURRENT HANDLER IS WEBFORMS!
                // Without this check, anything that is using this legacy API, like ui.Text will
                // automatically log the back office user in even if it is a front-end request (if there is 
                // a back office user logged in. This can cause problems becaues the identity is changing mid
                // request. For example: http://issues.umbraco.org/issue/U4-4010
                HttpContext.Current.CurrentHandler is Page);

            if (identity == null)
                return -1;
            return Convert.ToInt32(identity.Id);
        }

        // Added by NH to use with webservices authentications
        /// &lt;summary&gt;
        /// Validates the user context ID.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;currentUmbracoUserContextID&quot;&gt;This doesn&#39;t do anything&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;This method is no longer used, use the ValidateCurrentUser() method instead&quot;)]
        public static bool ValidateUserContextID(string currentUmbracoUserContextID)
        {
            return ValidateCurrentUser();
        }

        /// &lt;summary&gt;
        /// Validates the currently logged in user and ensures they are not timed out
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static bool ValidateCurrentUser()
        {
            var identity = HttpContext.Current.GetCurrentIdentity(
                //DO NOT AUTO-AUTH UNLESS THE CURRENT HANDLER IS WEBFORMS!
                // Without this check, anything that is using this legacy API, like ui.Text will
                // automatically log the back office user in even if it is a front-end request (if there is 
                // a back office user logged in. This can cause problems becaues the identity is changing mid
                // request. For example: http://issues.umbraco.org/issue/U4-4010
                HttpContext.Current.CurrentHandler is Page);

            if (identity != null)
            {
                return true;
            }
            return false;
        }

        //[Obsolete(&quot;Use Umbraco.Web.Security.WebSecurity.GetTimeout instead&quot;)]
        public static long GetTimeout(bool bypassCache)
        {
            var ticket = HttpContext.Current.GetUmbracoAuthTicket();
            if (ticket.Expired) return 0;
            var ticks = ticket.Expiration.Ticks - DateTime.Now.Ticks;         
            return ticks;
        }

        // Changed to public by NH to help with webservice authentication
        /// &lt;summary&gt;
        /// Gets or sets the umbraco user context ID.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The umbraco user context ID.&lt;/value&gt;
        [Obsolete(&quot;Returns the current user&#39;s unique umbraco sesion id - this cannot be set and isn&#39;t intended to be used in your code&quot;)]
        public static string umbracoUserContextID
        {
            get
            {
                var identity = HttpContext.Current.GetCurrentIdentity(
                    //DO NOT AUTO-AUTH UNLESS THE CURRENT HANDLER IS WEBFORMS!
                    // Without this check, anything that is using this legacy API, like ui.Text will
                    // automatically log the back office user in even if it is a front-end request (if there is 
                    // a back office user logged in. This can cause problems becaues the identity is changing mid
                    // request. For example: http://issues.umbraco.org/issue/U4-4010
                    HttpContext.Current.CurrentHandler is Page);

                return identity == null ? &quot;&quot; : identity.SessionId;
            }
            set
            {
            }
        }


        /// &lt;summary&gt;
        /// Clears the login.
        /// &lt;/summary&gt;
        public void ClearLogin()
        {
            Context.UmbracoLogout();
        }

        private void UpdateLogin()
        {
            Context.RenewUmbracoAuthTicket();
        }

        public static void RenewLoginTimeout()
        {
            HttpContext.Current.RenewUmbracoAuthTicket();           
        }

        /// &lt;summary&gt;
        /// Logs a user in.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;u&quot;&gt;The user&lt;/param&gt;
        public static void doLogin(User u)
        {
            HttpContext.Current.CreateUmbracoAuthTicket(new UserData(Guid.NewGuid().ToString(&quot;N&quot;))
            {
                Id = u.Id,
                AllowedApplications = u.GetApplications().Select(x =&gt; x.alias).ToArray(),
                RealName = u.Name,
                //currently we only have one user type!
                Roles = new[] { u.UserType.Alias },
                StartContentNode = u.StartNodeId,
                StartMediaNode = u.StartMediaId,
                Username = u.LoginName,
                Culture = ui.Culture(u)

            });
			LogHelper.Info&lt;BasePage&gt;(&quot;User {0} (Id: {1}) logged in&quot;, () =&gt; u.Name, () =&gt; u.Id);
        }


        /// &lt;summary&gt;
        /// Gets the user.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use UmbracoUser property instead.&quot;)]
        public User getUser()
        {
            return UmbracoUser;
        }

        /// &lt;summary&gt;
        /// Gets the user.
        /// &lt;/summary&gt;
        /// &lt;value&gt;&lt;/value&gt;
        public User UmbracoUser
        {
            get
            {
                if (!_userisValidated) ValidateUser();
                return _user;
            }
        }

        /// &lt;summary&gt;
        /// Ensures the page context.
        /// &lt;/summary&gt;
        public void ensureContext()
        {
            ValidateUser();
        }

        [Obsolete(&quot;Use ClientTools instead&quot;)]
        public void speechBubble(speechBubbleIcon i, string header, string body)
        {
            ClientTools.ShowSpeechBubble(i, header, body);
        }

        //[Obsolete(&quot;Use ClientTools instead&quot;)]
        //public void reloadParentNode() 
        //{
        //    ClientTools.ReloadParentNode(true);
        //}

        /// &lt;summary&gt;
        /// a collection of available speechbubble icons
        /// &lt;/summary&gt;
        [Obsolete(&quot;This has been superceded by Umbraco.Web.UI.SpeechBubbleIcon but that requires the use of the Umbraco.Web.UI.Pages.BasePage or Umbraco.Web.UI.Pages.EnsuredPage objects&quot;)]
        public enum speechBubbleIcon
        {
            /// &lt;summary&gt;
            /// Save icon
            /// &lt;/summary&gt;
            save,
            /// &lt;summary&gt;
            /// Info icon
            /// &lt;/summary&gt;
            info,
            /// &lt;summary&gt;
            /// Error icon
            /// &lt;/summary&gt;
            error,
            /// &lt;summary&gt;
            /// Success icon
            /// &lt;/summary&gt;
            success,
            /// &lt;summary&gt;
            /// Warning icon
            /// &lt;/summary&gt;
            warning
        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            //This must be set on each page to mitigate CSRF attacks which ensures that this unique token 
            // is added to the viewstate of each request
            if (umbracoUserContextID.IsNullOrWhiteSpace() == false)
            {
                ViewStateUserKey = umbracoUserContextID;
            }
        }

        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;E:System.Web.UI.Control.Load&quot;&gt;&lt;/see&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;T:System.EventArgs&quot;&gt;&lt;/see&gt; object that contains the event data.&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            if (!Request.IsSecureConnection &amp;&amp; GlobalSettings.UseSSL)
            {
                string serverName = HttpUtility.UrlEncode(Request.ServerVariables[&quot;SERVER_NAME&quot;]);
                Response.Redirect(string.Format(&quot;https://{0}{1}&quot;, serverName, Request.FilePath));
            }
        }

        /// &lt;summary&gt;
        /// Override client target.
        /// &lt;/summary&gt;
        [Obsolete(&quot;This is no longer supported&quot;)]
        public bool OverrideClientTarget = false;
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,47,0],[39,9,39,66,0],[44,9,44,31,0],[49,9,49,36,0],[57,17,57,18,0],[57,19,57,62,0],[57,63,57,64,0],[65,17,65,18,0],[65,19,65,53,0],[65,54,65,55,0],[73,17,73,18,0],[73,19,73,54,0],[73,55,73,56,0],[81,17,81,18,0],[81,19,81,61,0],[81,62,81,63,0],[92,13,92,14,0],[93,17,93,75,0],[94,17,94,34,0],[94,35,94,47,0],[99,17,99,85,0],[100,17,100,18,0],[101,21,101,94,0],[102,17,102,18,0],[103,17,103,90,0],[104,13,104,14,0],[116,11,116,12,0],[116,13,116,121,0],[116,122,116,123,0],[125,13,125,14,0],[126,17,126,42,0],[127,21,127,58,0],[128,17,128,37,0],[129,13,129,14,0],[134,9,134,10,0],[135,13,135,47,0],[136,9,136,10,0],[140,9,140,10,0],[141,13,141,57,0],[143,13,143,32,0],[144,13,144,14,0],[145,17,145,45,0],[146,17,146,18,0],[147,21,147,71,0],[150,21,150,118,0],[151,21,151,22,0],[152,25,152,138,0],[154,21,154,45,0],[155,21,155,35,0],[156,17,156,18,0],[158,17,158,18,0],[159,21,159,73,0],[161,13,161,14,0],[163,13,163,14,0],[164,17,164,107,0],[166,9,166,10,0],[175,9,175,10,0],[176,13,176,32,0],[177,9,177,10,0],[184,9,184,10,0],[185,13,191,61,0],[193,13,193,34,0],[194,17,194,27,0],[195,13,195,49,0],[196,9,196,10,0],[206,9,206,10,0],[207,13,207,42,0],[208,9,208,10,0],[215,9,215,10,0],[216,13,222,61,0],[224,13,224,34,0],[225,13,225,14,0],[226,17,226,29,0],[228,13,228,26,0],[229,9,229,10,0],[233,9,233,10,0],[234,13,234,69,0],[235,13,235,32,0],[235,33,235,42,0],[236,13,236,70,0],[237,13,237,26,0],[238,9,238,10,0],[249,13,249,14,1],[250,17,256,65,1],[258,17,258,67,0],[259,13,259,14,0],[261,13,261,14,0],[262,13,262,14,0],[270,9,270,10,0],[271,13,271,37,0],[272,9,272,10,0],[275,9,275,10,0],[276,13,276,46,0],[277,9,277,10,0],[280,9,280,10,0],[281,13,281,58,0],[282,9,282,10,0],[289,9,289,10,0],[290,13,293,71,0],[293,71,293,78,0],[293,78,302,16,0],[290,13,302,16,0],[303,4,303,67,0],[303,67,303,73,0],[303,73,303,81,0],[303,81,303,85,0],[303,85,303,87,0],[303,4,303,87,0],[304,9,304,10,0],[313,9,313,10,0],[314,13,314,32,0],[315,9,315,10,0],[324,13,324,14,0],[325,17,325,39,0],[325,40,325,55,0],[326,17,326,30,0],[327,13,327,14,0],[334,9,334,10,0],[335,13,335,28,0],[336,9,336,10,0],[340,9,340,10,0],[341,13,341,59,0],[342,9,342,10,0],[379,9,379,10,0],[380,13,380,28,0],[384,13,384,68,0],[385,13,385,14,0],[386,17,386,57,0],[387,13,387,14,0],[388,9,388,10,0],[395,9,395,10,0],[396,13,396,28,0],[398,13,398,70,0],[399,13,399,14,0],[400,17,400,99,0],[401,17,401,98,0],[402,13,402,14,0],[403,9,403,10,0],[409,9,409,50,0]]);
    </script>
  </body>
</html>