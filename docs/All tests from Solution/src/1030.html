<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Profiling\WebProfiler.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Threading;
using System.Web;
using StackExchange.Profiling;
using StackExchange.Profiling.SqlFormatters;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Profiling;

namespace Umbraco.Web.Profiling
{
    /// &lt;summary&gt;
    /// A profiler used for web based activity based on the MiniProfiler framework
    /// &lt;/summary&gt;    
    internal class WebProfiler : IProfiler
    {
        private const string BootRequestItemKey = &quot;Umbraco.Web.Profiling.WebProfiler__isBootRequest&quot;;
        private WebProfilerProvider _provider;
        private int _first;

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;        
        internal WebProfiler()
        {
            // create our own provider, which can provide a profiler even during boot
            // MiniProfiler&#39;s default cannot because there&#39;s no HttpRequest in HttpContext
            _provider = new WebProfilerProvider();

            // settings
            MiniProfiler.Settings.SqlFormatter = new SqlServerFormatter();
            MiniProfiler.Settings.StackMaxLength = 5000;
            MiniProfiler.Settings.ProfilerProvider = _provider;

            //Binds to application events to enable the MiniProfiler with a real HttpRequest
            UmbracoApplicationBase.ApplicationInit += UmbracoApplicationApplicationInit;
        }

        /// &lt;summary&gt;
        /// Handle the Init event o fthe UmbracoApplication which allows us to subscribe to the HttpApplication events
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        void UmbracoApplicationApplicationInit(object sender, EventArgs e)
        {
            var app = sender as HttpApplication;
            if (app == null) return;

            if (SystemUtilities.GetCurrentTrustLevel() &lt; AspNetHostingPermissionLevel.High)
            {
                //If we don&#39;t have a high enough trust level we cannot bind to the events
                LogHelper.Info&lt;WebProfiler&gt;(&quot;Cannot start the WebProfiler since the application is running in Medium trust&quot;);
            }
            else
            {
                app.BeginRequest += UmbracoApplicationBeginRequest;
                app.EndRequest += UmbracoApplicationEndRequest;
            }
        }

        void UmbracoApplicationBeginRequest(object sender, EventArgs e)
        {
            // if this is the first request, notify our own provider that this request is the boot request
            var first = Interlocked.Exchange(ref _first, 1) == 0;
            if (first)
            {
                _provider.BeginBootRequest();
                ((HttpApplication)sender).Context.Items[BootRequestItemKey] = true;
                // and no need to start anything, profiler is already there
            }
            // else start a profiler, the normal way
            else if (ShouldProfile(sender))
                Start();
        }

        void UmbracoApplicationEndRequest(object sender, EventArgs e)
        {
            // if this is the boot request, or if we should profile this request, stop
            // (the boot request is always profiled, no matter what)
            var isBootRequest = ((HttpApplication)sender).Context.Items[BootRequestItemKey] != null; // fixme perfs
            if (isBootRequest)
                _provider.EndBootRequest();
            if (isBootRequest || ShouldProfile(sender))
                Stop();
        }

        private bool ShouldProfile(object sender)
        {
            if (GlobalSettings.DebugMode == false) 
                return false;
            
            //will not run in medium trust
            if (SystemUtilities.GetCurrentTrustLevel() &lt; AspNetHostingPermissionLevel.High) 
                return false;

            var request = TryGetRequest(sender);

            if (request.Success == false || request.Result.Url.IsClientSideRequest())
                return false;

            if (string.IsNullOrEmpty(request.Result.QueryString[&quot;umbDebug&quot;]))
                return false;

            if (request.Result.Url.IsBackOfficeRequest(HttpRuntime.AppDomainAppVirtualPath))
                return false;

            return true;
        }

        /// &lt;summary&gt;
        /// Render the UI to display the profiler 
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// Generally used for HTML displays
        /// &lt;/remarks&gt;
        public string Render()
        {
            return MiniProfiler.RenderIncludes(RenderPosition.Right).ToString();
        }

        /// &lt;summary&gt;
        /// Profile a step
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// Use the &#39;using(&#39; syntax
        /// &lt;/remarks&gt;
        public IDisposable Step(string name)
        {
            return GlobalSettings.DebugMode == false ? null : MiniProfiler.Current.Step(name);
        }

        /// &lt;summary&gt;
        /// Start the profiler
        /// &lt;/summary&gt;
        public void Start()
        {            
            MiniProfiler.Start();
        }

        /// &lt;summary&gt;
        /// Start the profiler
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// set discardResults to false when you want to abandon all profiling, this is useful for 
        /// when someone is not authenticated or you want to clear the results based on some other mechanism.
        /// &lt;/remarks&gt;
        public void Stop(bool discardResults = false)
        {
            MiniProfiler.Stop(discardResults);
        }

        /// &lt;summary&gt;
        /// Gets the request object from the app instance if it is available
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The application object&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private Attempt&lt;HttpRequestBase&gt; TryGetRequest(object sender)
        {
            var app = sender as HttpApplication;
            if (app == null) return Attempt&lt;HttpRequestBase&gt;.Fail();

            try
            {
                var req = app.Request;
                return Attempt&lt;HttpRequestBase&gt;.Succeed(new HttpRequestWrapper(req));
            }
            catch (HttpException ex)
            {
                return Attempt&lt;HttpRequestBase&gt;.Fail(ex);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,31,0],[26,9,26,10,0],[29,13,29,51,0],[32,13,32,75,0],[33,13,33,57,0],[34,13,34,64,0],[37,13,37,89,0],[38,9,38,10,0],[46,9,46,10,0],[47,13,47,49,0],[48,13,48,29,0],[48,30,48,37,0],[50,13,50,92,0],[51,13,51,14,0],[53,17,53,126,0],[54,13,54,14,0],[56,13,56,14,0],[57,17,57,68,0],[58,17,58,64,0],[59,13,59,14,0],[60,9,60,10,0],[63,9,63,10,0],[65,13,65,66,0],[66,13,66,23,0],[67,13,67,14,0],[68,17,68,46,0],[69,17,69,84,0],[71,13,71,14,0],[73,18,73,44,0],[74,17,74,25,0],[75,9,75,10,0],[78,9,78,10,0],[81,13,81,101,0],[82,13,82,31,0],[83,17,83,44,0],[84,13,84,56,0],[85,17,85,24,0],[86,9,86,10,0],[89,9,89,10,0],[90,13,90,51,0],[91,17,91,30,0],[94,13,94,92,0],[95,17,95,30,0],[97,13,97,49,0],[99,13,99,86,0],[100,17,100,30,0],[102,13,102,78,0],[103,17,103,30,0],[105,13,105,93,0],[106,17,106,30,0],[108,13,108,25,0],[109,9,109,10,0],[119,9,119,10,0],[120,13,120,81,0],[121,9,121,10,0],[132,9,132,10,0],[133,13,133,95,0],[134,9,134,10,0],[140,9,140,10,0],[141,13,141,34,0],[142,9,142,10,0],[152,9,152,10,0],[153,13,153,47,0],[154,9,154,10,0],[162,9,162,10,0],[163,13,163,49,0],[164,13,164,29,0],[164,30,164,69,0],[167,13,167,14,0],[168,17,168,39,0],[169,17,169,86,0],[171,13,171,37,0],[172,13,172,14,0],[173,17,173,58,0],[175,9,175,10,0]]);
    </script>
  </body>
</html>