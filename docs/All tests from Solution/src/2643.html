<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\tinyMCE3\webcontrol\plugin\GzipCompressor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * $Id: GzipCompressor.cs 439 2007-11-26 13:26:10Z spocke $
 *
 * @author Moxiecode
 * @copyright Copyright ï¿½ 2004-2007, Moxiecode Systems AB, All rights reserved.
 */

using System;
using System.Web;
using System.Collections;
using System.IO;
using System.IO.Compression;
using System.Security.Cryptography;
using System.Text;

namespace umbraco.editorControls.tinyMCE3.webcontrol.plugin
{
    /// &lt;summary&gt;
	/// Description of GzipCompressor.
	/// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class GzipCompressor
    {
		#region private
		private bool diskCache, noCompression;
		private string cachePath;
		private ArrayList items;
		#endregion

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public GzipCompressor() {
			this.items = new ArrayList();
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public bool NoCompression {
			get { return noCompression; }
			set { noCompression = value; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public bool DiskCache {
			get { return diskCache; }
			set { diskCache = value; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public string CachePath {
			get { return cachePath; }
			set { cachePath = value; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt;
		public void AddFile(string path) {
			//System.Web.HttpContext.Current.Response.Write(path + &quot;\n&quot;);
			if (File.Exists(path))
				this.items.Add(new CompressItem(CompressItemType.File, path));
			else
				throw new Exception(&quot;File could not be found \&quot;&quot; + path + &quot;\&quot;, unable to add it for Gzip compression.&quot;);
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;data&quot;&gt;&lt;/param&gt;
		public void AddData(string data) {
			this.items.Add(new CompressItem(CompressItemType.Chunk, data));
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;to_stream&quot;&gt;&lt;/param&gt;
		public void Compress(Stream to_stream) {
			GZipStream gzipStream = null;
			string key = &quot;&quot;;
			byte[] bytes;

			// Build cache key
			foreach (CompressItem item in this.items) {
				if (item.Type == CompressItemType.File)
					key += item.Data;
			}

			key = MD5(key);
			if (this.NoCompression) {
				this.SendPlainText(key, to_stream);
				return;
			}

			// Check for cached file on disk, stream that one if it was found
			if (this.DiskCache &amp;&amp; File.Exists(Path.Combine(this.CachePath, key + &quot;.gz&quot;))) {
				this.StreamFromTo(File.OpenRead(Path.Combine(this.CachePath, key + &quot;.gz&quot;)), to_stream, 4096, CloseMode.InStream);
				return;
			}

			try {
				// Build new gzipped stream
				if (this.DiskCache) {
						gzipStream = new GZipStream(File.OpenWrite(Path.Combine(this.CachePath, key + &quot;.gz&quot;)), CompressionMode.Compress);

						// Compress all files into memory
						foreach (CompressItem item in this.items) {
							// Add file
							if (item.Type == CompressItemType.File)
								StreamFromTo(File.OpenRead(item.Data), gzipStream, 4096, CloseMode.InStream);

							// Add chunk
							if (item.Type == CompressItemType.Chunk) {
								bytes = Encoding.ASCII.GetBytes(item.Data.ToCharArray());
								gzipStream.Write(bytes, 0, bytes.Length);
							}
						}

						// Close gzip stream
						gzipStream.Close();
						gzipStream = null;

						// Send cached file to user
						this.StreamFromTo(File.OpenRead(Path.Combine(this.CachePath, key + &quot;.gz&quot;)), to_stream, 4096, CloseMode.InStream);
				} else {
					gzipStream = new GZipStream(to_stream, CompressionMode.Compress);

					// Compress all files into output stream
					foreach (CompressItem item in this.items) {
						// Add file
						if (item.Type == CompressItemType.File)
							StreamFromTo(File.OpenRead(item.Data), gzipStream, 4096, CloseMode.InStream);

						// Add chunk
						if (item.Type == CompressItemType.Chunk) {
							bytes = Encoding.ASCII.GetBytes(item.Data.ToCharArray());
							gzipStream.Write(bytes, 0, bytes.Length);
						}
					}
				}
			} finally {
				if (gzipStream != null)
					gzipStream.Close();
			}
		}

		#region private

		private void SendPlainText(string key, Stream to_stream) {
			Stream fileStream = null;
			byte[] bytes;

			// Check for cached file on disk, stream that one if it was found
			if (this.DiskCache &amp;&amp; File.Exists(Path.Combine(this.CachePath, key + &quot;.js&quot;))) {
				this.StreamFromTo(File.OpenRead(Path.Combine(this.CachePath, key + &quot;.js&quot;)), to_stream, 4096, CloseMode.InStream);
				return;
			}

			// Build new plain text stream
			if (this.DiskCache) {
				try {
					fileStream = File.OpenWrite(Path.Combine(this.CachePath, key + &quot;.js&quot;));

					// Compress all files into memory
					foreach (CompressItem item in this.items) {
						// Add file
						if (item.Type == CompressItemType.File)
							StreamFromTo(File.OpenRead(item.Data), fileStream, 4096, CloseMode.InStream);

						// Add chunk
						if (item.Type == CompressItemType.Chunk) {
							bytes = Encoding.ASCII.GetBytes(item.Data.ToCharArray());
							fileStream.Write(bytes, 0, bytes.Length);
						}
					}

					// Close file stream
					fileStream.Close();
					fileStream = null;
				} finally {
					// Close file stream
					if (fileStream != null)
						fileStream.Close();
				}

				// Send cached file to user
				this.StreamFromTo(File.OpenRead(Path.Combine(this.CachePath, key + &quot;.js&quot;)), to_stream, 4096, CloseMode.InStream);
			} else {
				// Concat all files into output stream
				foreach (CompressItem item in this.items) {
					// Add file
					if (item.Type == CompressItemType.File)
						StreamFromTo(File.OpenRead(item.Data), to_stream, 4096, CloseMode.InStream);

					// Add chunk
					if (item.Type == CompressItemType.Chunk) {
						bytes = Encoding.ASCII.GetBytes(item.Data.ToCharArray());
						to_stream.Write(bytes, 0, bytes.Length);
					}
				}
			}
		}

		private void StreamFromTo(Stream in_stream, Stream out_stream, int buff_size, CloseMode mode) {
			byte[] buff = new byte[buff_size];
			int len;

			try {
				while ((len = in_stream.Read(buff, 0, buff_size)) &gt; 0) {
					out_stream.Write(buff, 0, len);
					out_stream.Flush();
				}
			} finally {
				if (in_stream != null &amp;&amp; (mode == CloseMode.Both || mode == CloseMode.InStream))
					in_stream.Close();

				if (out_stream != null &amp;&amp; (mode == CloseMode.Both || mode == CloseMode.OutStream))
					out_stream.Close();
			}
		}

		private string MD5(string str) {
			MD5 md5 = new MD5CryptoServiceProvider();
			byte[] result = md5.ComputeHash(Encoding.ASCII.GetBytes(str));
			str = BitConverter.ToString(result);

			return str.Replace(&quot;-&quot;, &quot;&quot;);
		}

		#endregion
	}

	enum CloseMode {
		None, InStream, OutStream, Both
	}

	enum CompressItemType {
		File, Chunk
	}

	class CompressItem {
		private string data;
		private CompressItemType type;

		public CompressItem(CompressItemType type, string data) {
			this.type = type;
			this.data = data;
		}

		public string Data {
			get { return data; }
			set { data = value; }
		}

		public CompressItemType Type {
			get { return type; }
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[33,3,33,26,0],[33,27,33,28,0],[34,4,34,33,0],[35,3,35,4,0],[41,8,41,9,0],[41,10,41,31,0],[41,32,41,33,0],[42,8,42,9,0],[42,10,42,32,0],[42,33,42,34,0],[49,8,49,9,0],[49,10,49,27,0],[49,28,49,29,0],[50,8,50,9,0],[50,10,50,28,0],[50,29,50,30,0],[57,8,57,9,0],[57,10,57,27,0],[57,28,57,29,0],[58,8,58,9,0],[58,10,58,28,0],[58,29,58,30,0],[65,36,65,37,0],[67,4,67,26,0],[68,5,68,67,0],[70,5,70,109,0],[71,3,71,4,0],[77,36,77,37,0],[78,4,78,67,0],[79,3,79,4,0],[85,42,85,43,0],[86,4,86,33,0],[87,4,87,20,0],[91,4,91,11,0],[91,13,91,30,0],[91,31,91,33,0],[91,34,91,44,0],[91,46,91,47,0],[92,5,92,44,0],[93,6,93,23,0],[94,4,94,5,0],[96,4,96,19,0],[97,4,97,27,0],[97,28,97,29,0],[98,5,98,40,0],[99,5,99,12,0],[103,4,103,81,0],[103,82,103,83,0],[104,5,104,118,0],[105,5,105,12,0],[108,8,108,9,0],[110,5,110,24,0],[110,25,110,26,0],[111,7,111,120,0],[114,7,114,14,0],[114,16,114,33,0],[114,34,114,36,0],[114,37,114,47,0],[114,49,114,50,0],[116,8,116,47,0],[117,9,117,86,0],[120,8,120,48,0],[120,49,120,50,0],[121,9,121,66,0],[122,9,122,50,0],[123,8,123,9,0],[124,7,124,8,0],[127,7,127,26,0],[128,7,128,25,0],[131,7,131,120,0],[132,5,132,6,0],[132,12,132,13,0],[133,6,133,71,0],[136,6,136,13,0],[136,15,136,32,0],[136,33,136,35,0],[136,36,136,46,0],[136,48,136,49,0],[138,7,138,46,0],[139,8,139,85,0],[142,7,142,47,0],[142,48,142,49,0],[143,8,143,65,0],[144,8,144,49,0],[145,7,145,8,0],[146,6,146,7,0],[147,5,147,6,0],[148,4,148,5,0],[148,14,148,15,0],[149,5,149,28,0],[150,6,150,25,0],[151,4,151,5,0],[152,3,152,4,0],[156,60,156,61,0],[157,4,157,29,0],[161,4,161,81,0],[161,82,161,83,0],[162,5,162,118,0],[163,5,163,12,0],[167,4,167,23,0],[167,24,167,25,0],[168,9,168,10,0],[169,6,169,77,0],[172,6,172,13,0],[172,15,172,32,0],[172,33,172,35,0],[172,36,172,46,0],[172,48,172,49,0],[174,7,174,46,0],[175,8,175,85,0],[178,7,178,47,0],[178,48,178,49,0],[179,8,179,65,0],[180,8,180,49,0],[181,7,181,8,0],[182,6,182,7,0],[185,6,185,25,0],[186,6,186,24,0],[187,5,187,6,0],[187,15,187,16,0],[189,6,189,29,0],[190,7,190,26,0],[191,5,191,6,0],[194,5,194,118,0],[195,4,195,5,0],[195,11,195,12,0],[197,5,197,12,0],[197,14,197,31,0],[197,32,197,34,0],[197,35,197,45,0],[197,47,197,48,0],[199,6,199,45,0],[200,7,200,83,0],[203,6,203,46,0],[203,47,203,48,0],[204,7,204,64,0],[205,7,205,47,0],[206,6,206,7,0],[207,5,207,6,0],[208,4,208,5,0],[209,3,209,4,0],[211,97,211,98,0],[212,4,212,38,0],[215,8,215,9,0],[216,5,216,59,0],[216,60,216,61,0],[217,6,217,37,0],[218,6,218,25,0],[219,5,219,6,0],[220,4,220,5,0],[220,14,220,15,0],[221,5,221,85,0],[222,6,222,24,0],[224,5,224,87,0],[225,6,225,25,0],[226,4,226,5,0],[227,3,227,4,0],[229,34,229,35,0],[230,4,230,45,0],[231,4,231,66,0],[232,4,232,40,0],[234,4,234,32,0],[235,3,235,4,0],[252,3,252,58,0],[252,59,252,60,0],[253,4,253,21,0],[254,4,254,21,0],[255,3,255,4,0],[258,8,258,9,0],[258,10,258,22,0],[258,23,258,24,0],[259,8,259,9,0],[259,10,259,23,0],[259,24,259,25,0],[263,8,263,9,0],[263,10,263,22,0],[263,23,263,24,0]]);
    </script>
  </body>
</html>