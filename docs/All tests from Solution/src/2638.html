<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\ultimatepicker\ultimatePickerPrevalueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using System.IO;

using umbraco.DataLayer;
using umbraco.BusinessLogic;

using umbraco.editorControls;

namespace umbraco.editorControls.ultimatepicker
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class ultimatePickerPrevalueEditor : System.Web.UI.WebControls.PlaceHolder, umbraco.interfaces.IDataPrevalue
    {
        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        public static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        #region IDataPrevalue Members

        // referenced datatype
        private umbraco.cms.businesslogic.datatype.BaseDataType _datatype;

        private DropDownList _dropdownlist;
        private DropDownList _dropdownlistType;
        private TextBox _textboxParentNode;
        private TextBox _textboxDocumentTypeFilter;
        private CheckBox _checkboxShowGrandChildren;

        public ultimatePickerPrevalueEditor(umbraco.cms.businesslogic.datatype.BaseDataType DataType)
        {
            // state it knows its datatypedefinitionid
            _datatype = DataType;
            setupChildControls();

        }

        private void setupChildControls()
        {
            _dropdownlist = new DropDownList();
            _dropdownlist.ID = &quot;dbtype&quot;;
            _dropdownlist.Items.Add(DBTypes.Date.ToString());
            _dropdownlist.Items.Add(DBTypes.Integer.ToString());
            _dropdownlist.Items.Add(DBTypes.Ntext.ToString());
            _dropdownlist.Items.Add(DBTypes.Nvarchar.ToString());

            _dropdownlistType = new DropDownList();
            _dropdownlistType.ID = &quot;type&quot;;
            _dropdownlistType.Items.Add(&quot;AutoComplete&quot;);
            _dropdownlistType.Items.Add(&quot;CheckBoxList&quot;);
            _dropdownlistType.Items.Add(&quot;DropDownList&quot;);
            _dropdownlistType.Items.Add(&quot;ListBox&quot;);
            _dropdownlistType.Items.Add(&quot;RadioButtonList&quot;);

            _textboxParentNode = new TextBox();
            _textboxParentNode.ID = &quot;parentnode&quot;;
            _textboxParentNode.CssClass = &quot;umbEditorTextField&quot;;

            _textboxDocumentTypeFilter = new TextBox();
            _textboxDocumentTypeFilter.ID = &quot;documentTypeFilter&quot;;
            _textboxDocumentTypeFilter.CssClass = &quot;umbEditorTextField&quot;;

            _checkboxShowGrandChildren = new CheckBox();
            _checkboxShowGrandChildren.ID = &quot;showgrandchildren&quot;;

            // put the childcontrols in context - ensuring that
            // the viewstate is persisted etc.
            Controls.Add(_dropdownlist);
            Controls.Add(_dropdownlistType);
            Controls.Add(_textboxParentNode);
            Controls.Add(_textboxDocumentTypeFilter);
            Controls.Add(_checkboxShowGrandChildren);
        }



        public Control Editor
        {
            get
            {
                return this;
            }
        }


        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
            if (!Page.IsPostBack)
            {
                string[] config = Configuration.Split(&quot;|&quot;.ToCharArray());
                if (config.Length &gt; 1)
                {
                    _dropdownlistType.SelectedValue = config[0];
                    _textboxParentNode.Text = config[1];
                    _textboxDocumentTypeFilter.Text = config[2];
                    _checkboxShowGrandChildren.Checked = Convert.ToBoolean(config[3]);

                }
                _dropdownlist.SelectedValue = _datatype.DBType.ToString();

            }


        }

        public void Save()
        {
            _datatype.DBType = (umbraco.cms.businesslogic.datatype.DBTypes)Enum.Parse(typeof(umbraco.cms.businesslogic.datatype.DBTypes), _dropdownlist.SelectedValue, true);
            
            string validatedFilter = validateFilterInput(_textboxDocumentTypeFilter.Text);

            // Generate data-string
            string data = _dropdownlistType.SelectedValue + &quot;|&quot; + _textboxParentNode.Text + &quot;|&quot; + validatedFilter + &quot;|&quot; + _checkboxShowGrandChildren.Checked.ToString();

            using (var sqlHelper = Application.SqlHelper)
            {
                // If the add new prevalue textbox is filled out - add the value to the collection.
                IParameter[] SqlParams = new IParameter[] {
                            sqlHelper.CreateParameter(&quot;@value&quot;,data),
                            sqlHelper.CreateParameter(&quot;@dtdefid&quot;,_datatype.DataTypeDefinitionId)};
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsDataTypePreValues where datatypenodeid = @dtdefid&quot;, SqlParams);
                // need to unlock the parameters (for SQL CE compat)
                SqlParams = new IParameter[] {
                                            sqlHelper.CreateParameter(&quot;@value&quot;,data),
                                            sqlHelper.CreateParameter(&quot;@dtdefid&quot;,_datatype.DataTypeDefinitionId)};
                sqlHelper.ExecuteNonQuery(&quot;insert into cmsDataTypePreValues (datatypenodeid,[value],sortorder,alias) values (@dtdefid,@value,0,&#39;&#39;)&quot;, SqlParams);
            }

        }

        protected override void Render(HtmlTextWriter writer)
        {
            writer.WriteLine(&quot;&lt;table&gt;&quot;);
            writer.WriteLine(&quot;&lt;tr&gt;&lt;th&gt;Database datatype:&lt;/th&gt;&lt;td&gt;&quot;);
            _dropdownlist.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;Type:&lt;/th&gt;&lt;td&gt;&quot;);
            _dropdownlistType.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;Parent nodeid:&lt;/th&gt;&lt;td&gt;&quot;);
            _textboxParentNode.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;Document Alias filter (comma-separated):&lt;/th&gt;&lt;td&gt;&quot;);
            _textboxDocumentTypeFilter.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;Show grandchildren:&lt;/th&gt;&lt;td&gt;&quot;);
            _checkboxShowGrandChildren.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;/table&gt;&quot;);
        }

        public string Configuration
        {
            get
            {
                using (var sqlHelper = Application.SqlHelper) { 
                    object conf =
                        sqlHelper.ExecuteScalar&lt;object&gt;(&quot;select value from cmsDataTypePreValues where datatypenodeid = @datatypenodeid&quot;,
                                                sqlHelper.CreateParameter(&quot;@datatypenodeid&quot;, _datatype.DataTypeDefinitionId));
                    if (conf != null)
                        return conf.ToString();
                    else
                        return &quot;&quot;;
                }
            }
        }

        #endregion

        /// &lt;summary&gt;
        /// Validates and clears the filter input from errorneous entries
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;filterInput&quot;&gt;The filter string to be validated&lt;/param&gt;
        /// &lt;returns&gt;A validated filtered comma separated string&lt;/returns&gt;
        public string validateFilterInput(string filterInput)
        {
            string[] filters = filterInput.Split(&quot;,&quot;.ToCharArray());
            string validatedFilter = string.Empty;
            List&lt;string&gt; validatedFilters = new List&lt;string&gt;();

            foreach (string filter in filters)
            {
                string trimmedFilter = filter.TrimStart(&quot; &quot;.ToCharArray());
                trimmedFilter = trimmedFilter.TrimEnd(&quot; &quot;.ToCharArray());

                if (trimmedFilter != string.Empty)
                {
                    validatedFilters.Add(trimmedFilter);
                }
            }

            for (int i = 0; i &lt; validatedFilters.Count; i++)
            {
                if (i &gt; 0)
                    validatedFilter += &quot;,&quot;;
                validatedFilter += validatedFilters[i];
            }
            return validatedFilter;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,17,28,18,0],[28,19,28,48,0],[28,49,28,50,0],[42,9,42,102,0],[43,9,43,10,0],[45,13,45,34,0],[46,13,46,34,0],[48,9,48,10,0],[51,9,51,10,0],[52,13,52,48,0],[53,13,53,41,0],[54,13,54,62,0],[55,13,55,65,0],[56,13,56,63,0],[57,13,57,66,0],[59,13,59,52,0],[60,13,60,43,0],[61,13,61,57,0],[62,13,62,57,0],[63,13,63,57,0],[64,13,64,52,0],[65,13,65,60,0],[67,13,67,48,0],[68,13,68,50,0],[69,13,69,64,0],[71,13,71,56,0],[72,13,72,66,0],[73,13,73,72,0],[75,13,75,57,0],[76,13,76,65,0],[80,13,80,41,0],[81,13,81,45,0],[82,13,82,46,0],[83,13,83,54,0],[84,13,84,54,0],[85,9,85,10,0],[92,13,92,14,0],[93,17,93,29,0],[94,13,94,14,0],[99,9,99,10,0],[100,13,100,28,0],[101,13,101,34,0],[102,13,102,14,0],[103,17,103,74,0],[104,17,104,39,0],[105,17,105,18,0],[106,21,106,65,0],[107,21,107,57,0],[108,21,108,65,0],[109,21,109,87,0],[111,17,111,18,0],[112,17,112,75,0],[114,13,114,14,0],[117,9,117,10,0],[120,9,120,10,0],[121,13,121,174,0],[123,13,123,91,0],[126,13,126,169,0],[128,20,128,57,0],[129,13,129,14,0],[131,17,133,99,0],[134,17,134,122,0],[136,17,138,115,0],[139,17,139,161,0],[140,13,140,14,0],[142,9,142,10,0],[145,9,145,10,0],[146,13,146,41,0],[147,13,147,69,0],[148,13,148,49,0],[149,13,149,40,0],[150,13,150,52,0],[151,13,151,53,0],[152,13,152,40,0],[153,13,153,61,0],[154,13,154,54,0],[155,13,155,40,0],[156,13,156,87,0],[157,13,157,62,0],[158,13,158,40,0],[159,13,159,66,0],[160,13,160,62,0],[161,13,161,40,0],[162,13,162,38,0],[163,9,163,10,0],[168,13,168,14,0],[169,24,169,61,0],[169,63,169,64,0],[170,21,172,127,0],[173,21,173,38,0],[174,25,174,48,0],[176,25,176,35,0],[178,13,178,14,0],[189,9,189,10,0],[190,13,190,69,0],[191,13,191,51,0],[192,13,192,64,0],[194,13,194,20,0],[194,22,194,35,0],[194,36,194,38,0],[194,39,194,46,0],[195,13,195,14,0],[196,17,196,76,0],[197,17,197,74,0],[199,17,199,51,0],[200,17,200,18,0],[201,21,201,57,0],[202,17,202,18,0],[203,13,203,14,0],[205,18,205,27,0],[205,29,205,55,0],[205,57,205,60,0],[206,13,206,14,0],[207,17,207,27,0],[208,21,208,44,0],[209,17,209,56,0],[210,13,210,14,0],[211,13,211,36,0],[212,9,212,10,0]]);
    </script>
  </body>
</html>