<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Querying\PetaPocoSqlTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Tests.TestHelpers;
using Umbraco.Core.Persistence.Querying;

namespace Umbraco.Tests.Persistence.Querying
{
    [TestFixture]
    public class PetaPocoSqlTests : BaseUsingSqlCeSyntax
    {
        //x =&gt; 

        [Test]
        public void Where_Clause_With_Starts_With_Additional_Parameters()
        {
            var content = new NodeDto() { NodeId = 123, Path = &quot;-1,123&quot; };
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Path.SqlStartsWith(content.Path, TextColumnType.NVarchar));

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE (upper([umbracoNode].[path]) LIKE upper(@0))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(content.Path + &quot;%&quot;, sql.Arguments[0]);        
        }

        [Test]
        public void Where_Clause_With_Starts_With_By_Variable()
        {
            var content = new NodeDto() {NodeId = 123, Path = &quot;-1,123&quot;};
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Path.StartsWith(content.Path) &amp;&amp; x.NodeId != content.NodeId);

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE ((upper([umbracoNode].[path]) LIKE upper(@0) AND ([umbracoNode].[id] &lt;&gt; @1)))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(2, sql.Arguments.Length);
            Assert.AreEqual(content.Path + &quot;%&quot;, sql.Arguments[0]);
            Assert.AreEqual(content.NodeId, sql.Arguments[1]);
        }

        [Test]
        public void Where_Clause_With_Not_Starts_With()
        {
            var level = 1;
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Level == level &amp;&amp; !x.Path.StartsWith(&quot;-20&quot;));

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE ((([umbracoNode].[level] = @0) AND NOT (upper([umbracoNode].[path]) LIKE upper(@1))))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(2, sql.Arguments.Length);
            Assert.AreEqual(level, sql.Arguments[0]);
            Assert.AreEqual(&quot;-20%&quot;, sql.Arguments[1]);
        }

        [Test]
        public void Where_Clause_With_EqualsFalse_Starts_With()
        {
            var level = 1;
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Level == level &amp;&amp; x.Path.StartsWith(&quot;-20&quot;) == false);

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE ((([umbracoNode].[level] = @0) AND NOT (upper([umbracoNode].[path]) LIKE upper(@1))))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(2, sql.Arguments.Length);
            Assert.AreEqual(level, sql.Arguments[0]);
            Assert.AreEqual(&quot;-20%&quot;, sql.Arguments[1]);
        }

        [Test]
        public void Where_Clause_With_Equals_Clause()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Text.Equals(&quot;Hello@world.com&quot;));

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE (upper([umbracoNode].[text]) = upper(@0))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(&quot;Hello@world.com&quot;, sql.Arguments[0]);
        }

        [Test]
        public void Where_Clause_With_False_Boolean()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; !x.Trashed);

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE (NOT ([umbracoNode].[trashed] = @0))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(true, sql.Arguments[0]);
        }

        [Test]
        public void Where_Clause_With_EqualsFalse_Boolean()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Trashed == false);

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE (NOT ([umbracoNode].[trashed] = @0))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(true, sql.Arguments[0]);
        }

        [Test]
        public void Where_Clause_With_Boolean()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Trashed);

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE ([umbracoNode].[trashed] = @0)&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(true, sql.Arguments[0]);
        }

        [Test]
        public void Where_Clause_With_ToUpper()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Text.ToUpper() == &quot;hello&quot;.ToUpper());

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE ((upper([umbracoNode].[text]) = upper(@0)))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(&quot;hello&quot;, sql.Arguments[0]);
        }

        [Test]
        public void Where_Clause_With_ToString()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Text == 1.ToString());

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE (([umbracoNode].[text] = @0))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(&quot;1&quot;, sql.Arguments[0]);
        }

        [Test]
        public void Where_Clause_With_Wildcard()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Text.StartsWith(&quot;D&quot;));

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE (upper([umbracoNode].[text]) LIKE upper(@0))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(&quot;D%&quot;, sql.Arguments[0]);
        }

        [Test]
        public void Where_Clause_Single_Constant()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.NodeId == 2);

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE (([umbracoNode].[id] = @0))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(1, sql.Arguments.Length);
            Assert.AreEqual(2, sql.Arguments[0]);
        }

        [Test]
        public void Where_Clause_And_Constant()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.NodeId != 2 &amp;&amp; x.NodeId != 3);

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE ((([umbracoNode].[id] &lt;&gt; @0) AND ([umbracoNode].[id] &lt;&gt; @1)))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(2, sql.Arguments.Length);
            Assert.AreEqual(2, sql.Arguments[0]);
            Assert.AreEqual(3, sql.Arguments[1]);
        }

        [Test]
        public void Where_Clause_Or_Constant()
        {
            var sql = new Sql(&quot;SELECT *&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.Text == &quot;hello&quot; || x.NodeId == 3);

            Assert.AreEqual(&quot;SELECT * FROM [umbracoNode] WHERE ((([umbracoNode].[text] = @0) OR ([umbracoNode].[id] = @1)))&quot;, sql.SQL.Replace(&quot;\n&quot;, &quot; &quot;));
            Assert.AreEqual(2, sql.Arguments.Length);
            Assert.AreEqual(&quot;hello&quot;, sql.Arguments[0]);
            Assert.AreEqual(3, sql.Arguments[1]);
        }

        [Test]
        public void Can_Select_From_With_Type()
        {
            var expected = new Sql();
            expected.Select(&quot;*&quot;).From(&quot;[cmsContent]&quot;);

            var sql = new Sql();
            sql.Select(&quot;*&quot;).From&lt;ContentDto&gt;();

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));

            Debug.Print(sql.SQL);
        }

        [Test]
        public void Can_InnerJoin_With_Types()
        {
            var expected = new Sql();
            expected.Select(&quot;*&quot;)
                .From(&quot;[cmsDocument]&quot;)
                .InnerJoin(&quot;[cmsContentVersion]&quot;)
                .On(&quot;[cmsDocument].[versionId] = [cmsContentVersion].[VersionId]&quot;);

            var sql = new Sql();
            sql.Select(&quot;*&quot;).From&lt;DocumentDto&gt;()
                .InnerJoin&lt;ContentVersionDto&gt;()
                .On&lt;DocumentDto, ContentVersionDto&gt;(left =&gt; left.VersionId, right =&gt; right.VersionId);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));

            Debug.Print(sql.SQL);
        }

        [Test]
        public void Can_OrderBy_With_Type()
        {
            var expected = new Sql();
            expected.Select(&quot;*&quot;).From(&quot;[cmsContent]&quot;).OrderBy(&quot;([cmsContent].[contentType])&quot;);

            var sql = new Sql();
            sql.Select(&quot;*&quot;).From&lt;ContentDto&gt;().OrderBy&lt;ContentDto&gt;(x =&gt; x.ContentTypeId);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));

            Debug.Print(sql.SQL);
        }

        [Test]
        public void Can_GroupBy_With_Type()
        {
            var expected = new Sql();
            expected.Select(&quot;*&quot;).From(&quot;[cmsContent]&quot;).GroupBy(&quot;[contentType]&quot;);

            var sql = new Sql();
            sql.Select(&quot;*&quot;).From&lt;ContentDto&gt;().GroupBy&lt;ContentDto&gt;(x =&gt; x.ContentTypeId);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));

            Debug.Print(sql.SQL);
        }

        [Test]
        public void Can_Use_Where_Predicate()
        {
            var expected = new Sql();
            expected.Select(&quot;*&quot;).From(&quot;[cmsContent]&quot;).Where(&quot;([cmsContent].[nodeId] = @0)&quot;, 1045);

            var sql = new Sql();
            sql.Select(&quot;*&quot;).From&lt;ContentDto&gt;().Where&lt;ContentDto&gt;(x =&gt; x.NodeId == 1045);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));

            Debug.Print(sql.SQL);
        }

        [Test]
        public void Can_Use_Where_And_Predicate()
        {
            var expected = new Sql();
            expected.Select(&quot;*&quot;)
                .From(&quot;[cmsContent]&quot;)
                .Where(&quot;([cmsContent].[nodeId] = @0)&quot;, 1045)
                .Where(&quot;([cmsContent].[contentType] = @0)&quot;, 1050);

            var sql = new Sql();
            sql.Select(&quot;*&quot;)
                .From&lt;ContentDto&gt;()
                .Where&lt;ContentDto&gt;(x =&gt; x.NodeId == 1045)
                .Where&lt;ContentDto&gt;(x =&gt; x.ContentTypeId == 1050);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));

            Debug.Print(sql.SQL);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,75,1],[24,13,24,140,1],[26,13,26,139,1],[27,13,27,54,1],[28,13,28,67,1],[29,9,29,10,1],[33,9,33,10,1],[34,13,34,73,1],[35,13,35,142,1],[37,13,37,172,1],[38,13,38,54,1],[39,13,39,67,1],[40,13,40,63,1],[41,9,41,10,1],[45,9,45,10,1],[46,13,46,27,1],[47,13,47,126,1],[49,13,49,180,1],[50,13,50,54,1],[51,13,51,54,1],[52,13,52,55,1],[53,9,53,10,1],[57,9,57,10,1],[58,13,58,27,1],[59,13,59,134,1],[61,13,61,180,1],[62,13,62,54,1],[63,13,63,54,1],[64,13,64,55,1],[65,9,65,10,1],[69,9,69,10,1],[70,13,70,113,1],[72,13,72,136,1],[73,13,73,54,1],[74,13,74,66,1],[75,9,75,10,1],[79,9,79,10,1],[80,13,80,91,1],[82,13,82,131,1],[83,13,83,54,1],[84,13,84,53,1],[85,9,85,10,1],[89,9,89,10,1],[90,13,90,99,1],[92,13,92,131,1],[93,13,93,54,1],[94,13,94,53,1],[95,9,95,10,1],[99,9,99,10,1],[100,13,100,90,1],[102,13,102,125,1],[103,13,103,54,1],[104,13,104,53,1],[105,9,105,10,1],[109,9,109,10,1],[110,13,110,118,1],[112,13,112,138,1],[113,13,113,54,1],[114,13,114,56,1],[115,9,115,10,1],[119,9,119,10,1],[120,13,120,103,1],[122,13,122,124,1],[123,13,123,54,1],[124,13,124,52,1],[125,9,125,10,1],[129,9,129,10,1],[130,13,130,103,1],[132,13,132,139,1],[133,13,133,54,1],[134,13,134,53,1],[135,9,135,10,1],[139,9,139,10,1],[140,13,140,94,1],[142,13,142,122,1],[143,13,143,54,1],[144,13,144,50,1],[145,9,145,10,1],[149,9,149,10,1],[150,13,150,111,1],[152,13,152,156,1],[153,13,153,54,1],[154,13,154,50,1],[155,13,155,50,1],[156,9,156,10,1],[160,9,160,10,1],[161,13,161,115,1],[163,13,163,155,1],[164,13,164,54,1],[165,13,165,56,1],[166,13,166,50,1],[167,9,167,10,1],[171,9,171,10,1],[172,13,172,38,1],[173,13,173,55,1],[175,13,175,33,1],[176,13,176,48,1],[178,13,178,60,1],[180,13,180,34,1],[181,9,181,10,1],[185,9,185,10,1],[186,13,186,38,1],[187,13,190,84,1],[192,13,192,33,1],[193,13,195,103,1],[197,13,197,60,1],[199,13,199,34,1],[200,9,200,10,1],[204,9,204,10,1],[205,13,205,38,1],[206,13,206,95,1],[208,13,208,33,1],[209,13,209,90,1],[211,13,211,60,1],[213,13,213,34,1],[214,9,214,10,1],[218,9,218,10,1],[219,13,219,38,1],[220,13,220,80,1],[222,13,222,33,1],[223,13,223,90,1],[225,13,225,60,1],[227,13,227,34,1],[228,9,228,10,1],[232,9,232,10,1],[233,13,233,38,1],[234,13,234,99,1],[236,13,236,33,1],[237,13,237,89,1],[239,13,239,60,1],[241,13,241,34,1],[242,9,242,10,1],[246,9,246,10,1],[247,13,247,38,1],[248,13,251,67,1],[253,13,253,33,1],[254,13,257,66,1],[259,13,259,60,1],[261,13,261,34,1],[262,9,262,10,1]]);
    </script>
  </body>
</html>