<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\PetaPocoExtensionsTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Text.RegularExpressions;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class PetaPocoExtensionsTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        [Test]
        public void Can_Bulk_Insert_One_By_One()
        {
            // Arrange
            var db = DatabaseContext.Database;

            var servers = new List&lt;ServerRegistrationDto&gt;();
            for (var i = 0; i &lt; 1000; i++)
            {
                servers.Add(new ServerRegistrationDto
                    {
                        ServerAddress = &quot;address&quot; + i,
                        ServerIdentity = &quot;computer&quot; + i,
                        DateRegistered = DateTime.Now,
                        IsActive = true,
                        DateAccessed = DateTime.Now
                    });
            }

            // Act
            using (ProfilingLogger.TraceDuration&lt;PetaPocoExtensionsTest&gt;(&quot;starting insert&quot;, &quot;finished insert&quot;))
            {
                using (var tr = db.GetTransaction())
                {
                    db.BulkInsertRecords(servers, tr, SqlSyntax, useNativeSqlPlatformBulkInsert:false);
                    tr.Complete();
                }                
            }

            // Assert
            Assert.That(db.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM umbracoServer&quot;), Is.EqualTo(1000));
        }

        [Test]
        public void Can_Bulk_Insert_One_By_One_Transaction_Rollback()
        {
            // Arrange
            var db = DatabaseContext.Database;

            var servers = new List&lt;ServerRegistrationDto&gt;();
            for (var i = 0; i &lt; 1000; i++)
            {
                servers.Add(new ServerRegistrationDto
                {
                    ServerAddress = &quot;address&quot; + i,
                    ServerIdentity = &quot;computer&quot; + i,
                    DateRegistered = DateTime.Now,
                    IsActive = true,
                    DateAccessed = DateTime.Now
                });
            }

            // Act
            using (ProfilingLogger.TraceDuration&lt;PetaPocoExtensionsTest&gt;(&quot;starting insert&quot;, &quot;finished insert&quot;))
            {
                using (var tr = db.GetTransaction())
                {
                    db.BulkInsertRecords(servers, tr, SqlSyntax, useNativeSqlPlatformBulkInsert: false);
                    //don&#39;t call complete here - the trans will be rolled back
                }
            }

            // Assert
            Assert.That(db.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM umbracoServer&quot;), Is.EqualTo(0));
        }

        
        [NUnit.Framework.Ignore(&quot;Ignored because you need to configure your own SQL Server to test thsi with&quot;)]
        [Test]
        public void Can_Bulk_Insert_Native_Sql_Server_Bulk_Inserts()
        {
            //create the db
            var dbSqlServer = new UmbracoDatabase(
                &quot;server=.\\SQLExpress;database=YOURDB;user id=YOURUSER;password=YOURPASSWORD&quot;,
                Constants.DatabaseProviders.SqlServer,
                new DebugDiagnosticsLogger());

            //drop the table
            dbSqlServer.Execute(&quot;DROP TABLE [umbracoServer]&quot;);

            //re-create it
            dbSqlServer.Execute(@&quot;CREATE TABLE [umbracoServer](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[address] [nvarchar](500) NOT NULL,
	[computerName] [nvarchar](255) NOT NULL,
	[registeredDate] [datetime] NOT NULL CONSTRAINT [DF_umbracoServer_registeredDate]  DEFAULT (getdate()),
	[lastNotifiedDate] [datetime] NOT NULL,
	[isActive] [bit] NOT NULL,
	[isMaster] [bit] NOT NULL,
 CONSTRAINT [PK_umbracoServer] PRIMARY KEY CLUSTERED 
(
	[id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
)&quot;);
            var data = new List&lt;ServerRegistrationDto&gt;();
            for (var i = 0; i &lt; 1000; i++)
            {
                data.Add(new ServerRegistrationDto
                {
                    ServerAddress = &quot;address&quot; + i,
                    ServerIdentity = &quot;computer&quot; + i,
                    DateRegistered = DateTime.Now,
                    IsActive = true,
                    DateAccessed = DateTime.Now
                });
            }

            var sqlServerSyntax = new SqlServerSyntaxProvider();
            using (var tr = dbSqlServer.GetTransaction())
            {
                dbSqlServer.BulkInsertRecords(data, tr, sqlServerSyntax, useNativeSqlPlatformBulkInsert: true);
                tr.Complete();
            }

            // Assert
            Assert.That(dbSqlServer.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM umbracoServer&quot;), Is.EqualTo(1000));
        }

        [Test]
        public void Can_Bulk_Insert_Native_Sql_Bulk_Inserts()
        {
            // Arrange
            var db = DatabaseContext.Database;

            var servers = new List&lt;ServerRegistrationDto&gt;();
            for (var i = 0; i &lt; 1000; i++)
            {
                servers.Add(new ServerRegistrationDto
                {
                    ServerAddress = &quot;address&quot; + i,
                    ServerIdentity = &quot;computer&quot; + i,
                    DateRegistered = DateTime.Now,
                    IsActive = true,
                    DateAccessed = DateTime.Now
                });
            }

            // Act
            using (ProfilingLogger.TraceDuration&lt;PetaPocoExtensionsTest&gt;(&quot;starting insert&quot;, &quot;finished insert&quot;))
            {
                using (var tr = db.GetTransaction())
                {
                    db.BulkInsertRecords(servers, tr, SqlSyntax, useNativeSqlPlatformBulkInsert: true);
                    tr.Complete();
                }
            }

            // Assert
            Assert.That(db.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM umbracoServer&quot;), Is.EqualTo(1000));
        }

        [Test]
        public void Can_Bulk_Insert_Native_Sql_Bulk_Inserts_Transaction_Rollback()
        {
            // Arrange
            var db = DatabaseContext.Database;

            var servers = new List&lt;ServerRegistrationDto&gt;();
            for (var i = 0; i &lt; 1000; i++)
            {
                servers.Add(new ServerRegistrationDto
                {
                    ServerAddress = &quot;address&quot; + i,
                    ServerIdentity = &quot;computer&quot; + i,
                    DateRegistered = DateTime.Now,
                    IsActive = true,
                    DateAccessed = DateTime.Now
                });
            }

            // Act
            using (ProfilingLogger.TraceDuration&lt;PetaPocoExtensionsTest&gt;(&quot;starting insert&quot;, &quot;finished insert&quot;))
            {
                using (var tr = db.GetTransaction())
                {
                    db.BulkInsertRecords(servers, tr, SqlSyntax, useNativeSqlPlatformBulkInsert: true);
                    //don&#39;t call complete here - the trans will be rolled back
                }
            }

            // Assert
            Assert.That(db.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM umbracoServer&quot;), Is.EqualTo(0));
        }

        [Test]
        public void Generate_Bulk_Import_Sql()
        {
            // Arrange
            var db = DatabaseContext.Database;

            var servers = new List&lt;ServerRegistrationDto&gt;();
            for (var i = 0; i &lt; 2; i++)
            {
                servers.Add(new ServerRegistrationDto
                    {
                        ServerAddress = &quot;address&quot; + i,
                        ServerIdentity = &quot;computer&quot; + i,
                        DateRegistered = DateTime.Now,
                        IsActive = true,
                        DateAccessed = DateTime.Now
                    });
            }
            db.OpenSharedConnection();

            // Act
            string[] sql;
            db.GenerateBulkInsertCommand(
                Database.PocoData.ForType(typeof(ServerRegistrationDto)), 
                servers, out sql);
            db.CloseSharedConnection();

            // Assert
            Assert.That(sql[0],
                        Is.EqualTo(&quot;INSERT INTO [umbracoServer] ([umbracoServer].[address], [umbracoServer].[computerName], [umbracoServer].[registeredDate], [umbracoServer].[lastNotifiedDate], [umbracoServer].[isActive], [umbracoServer].[isMaster]) VALUES (@0,@1,@2,@3,@4,@5), (@6,@7,@8,@9,@10,@11)&quot;));
        }


        [Test]
        public void Generate_Bulk_Import_Sql_Exceeding_Max_Params()
        {
            // Arrange
            var db = DatabaseContext.Database;

            var servers = new List&lt;ServerRegistrationDto&gt;();
            for (var i = 0; i &lt; 1500; i++)
            {
                servers.Add(new ServerRegistrationDto
                {
                    ServerAddress = &quot;address&quot; + i,
                    ServerIdentity = &quot;computer&quot; + i,
                    DateRegistered = DateTime.Now,
                    IsActive = true,
                    DateAccessed = DateTime.Now,
                    IsMaster = true
                });
            }
            db.OpenSharedConnection();

            // Act
            string[] sql;
            db.GenerateBulkInsertCommand(Database.PocoData.ForType(typeof(ServerRegistrationDto)), servers, out sql);
            db.CloseSharedConnection();

            // Assert
            Assert.That(sql.Length, Is.EqualTo(5));
            foreach (var s in sql)
            {
                Assert.LessOrEqual(Regex.Matches(s, &quot;@\\d+&quot;).Count, 2000);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,31,1],[22,9,22,10,1],[26,9,26,10,1],[27,13,27,29,1],[28,9,28,10,1],[32,9,32,10,1],[34,13,34,47,1],[36,13,36,61,1],[37,18,37,27,1],[37,29,37,37,1],[37,39,37,42,1],[38,13,38,14,1],[39,17,46,24,1],[47,13,47,14,1],[50,13,50,112,1],[51,13,51,14,1],[52,24,52,52,1],[53,17,53,18,1],[54,21,54,104,1],[55,21,55,35,1],[56,17,56,18,1],[57,13,57,14,1],[60,13,60,104,1],[61,9,61,10,1],[65,9,65,10,1],[67,13,67,47,1],[69,13,69,61,1],[70,18,70,27,1],[70,29,70,37,1],[70,39,70,42,1],[71,13,71,14,1],[72,17,79,20,1],[80,13,80,14,1],[83,13,83,112,1],[84,13,84,14,1],[85,24,85,52,1],[86,17,86,18,1],[87,21,87,105,1],[89,17,89,18,1],[90,13,90,14,1],[93,13,93,101,1],[94,9,94,10,1],[100,9,100,10,0],[102,13,105,47,0],[108,13,108,63,0],[111,13,123,5,0],[124,13,124,58,0],[125,18,125,27,0],[125,29,125,37,0],[125,39,125,42,0],[126,13,126,14,0],[127,17,134,20,0],[135,13,135,14,0],[137,13,137,65,0],[138,20,138,57,0],[139,13,139,14,0],[140,17,140,112,0],[141,17,141,31,0],[142,13,142,14,0],[145,13,145,113,0],[146,9,146,10,0],[150,9,150,10,1],[152,13,152,47,1],[154,13,154,61,1],[155,18,155,27,1],[155,29,155,37,1],[155,39,155,42,1],[156,13,156,14,1],[157,17,164,20,1],[165,13,165,14,1],[168,13,168,112,1],[169,13,169,14,1],[170,24,170,52,1],[171,17,171,18,1],[172,21,172,104,1],[173,21,173,35,1],[174,17,174,18,1],[175,13,175,14,1],[178,13,178,104,1],[179,9,179,10,1],[183,9,183,10,1],[185,13,185,47,1],[187,13,187,61,1],[188,18,188,27,1],[188,29,188,37,1],[188,39,188,42,1],[189,13,189,14,1],[190,17,197,20,1],[198,13,198,14,1],[201,13,201,112,1],[202,13,202,14,1],[203,24,203,52,1],[204,17,204,18,1],[205,21,205,104,1],[207,17,207,18,1],[208,13,208,14,1],[211,13,211,101,1],[212,9,212,10,1],[216,9,216,10,1],[218,13,218,47,1],[220,13,220,61,1],[221,18,221,27,1],[221,29,221,34,1],[221,36,221,39,1],[222,13,222,14,1],[223,17,230,24,1],[231,13,231,14,1],[232,13,232,39,1],[236,13,238,35,1],[239,13,239,40,1],[242,13,243,304,1],[244,9,244,10,1],[249,9,249,10,1],[251,13,251,47,1],[253,13,253,61,1],[254,18,254,27,1],[254,29,254,37,1],[254,39,254,42,1],[255,13,255,14,1],[256,17,264,20,1],[265,13,265,14,1],[266,13,266,39,1],[270,13,270,118,1],[271,13,271,40,1],[274,13,274,52,1],[275,13,275,20,1],[275,22,275,27,1],[275,28,275,30,1],[275,31,275,34,1],[276,13,276,14,1],[277,17,277,75,1],[278,13,278,14,1],[279,9,279,10,1]]);
    </script>
  </body>
</html>