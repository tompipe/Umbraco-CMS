<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\datatype\DefaultPreValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core;
using umbraco.interfaces;
using umbraco.BusinessLogic;
using umbraco.DataLayer;
using System.Collections.Generic;

namespace umbraco.cms.businesslogic.datatype
{

    [Obsolete(&quot;This class is no longer used and will be removed from the codebase in the future.&quot;)]
    public class DefaultPreValueEditor : PlaceHolder, interfaces.IDataPrevalue
    {
        // UI controls
        private TextBox _textbox;
        private DropDownList _dropdownlist;

        // referenced datatype
        private cms.businesslogic.datatype.BaseDataType _datatype;
        
        //WHY IS THIS HERE... IT IS NEVER SET!?
        private BaseDataType _datatypeOld;

        private bool _isEnsured = false;
        private string _prevalue;
        private bool _displayTextBox;


        private Dictionary&lt;string, DataEditorSettingType&gt; dtSettings = new Dictionary&lt;string, DataEditorSettingType&gt;();

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        public static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        /// &lt;summary&gt;
        /// The default editor for editing the built-in pre values in umbraco
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;DataType&quot;&gt;The DataType to be parsed&lt;/param&gt;
        /// &lt;param name=&quot;DisplayTextBox&quot;&gt;Whether to use the default text box&lt;/param&gt;
        public DefaultPreValueEditor(cms.businesslogic.datatype.BaseDataType DataType, bool DisplayTextBox)
        {
            // state it knows its datatypedefinitionid
            _displayTextBox = DisplayTextBox;
            _datatype = DataType;
            //setupChildControls();
        }


        //private void setupChildControls()
        //{
        //    DataEditorPropertyPanel pnlType = new DataEditorPropertyPanel();
        //    pnlType.Text = ui.Text(&quot;dataBaseDatatype&quot;);

        //    _dropdownlist = new DropDownList();
        //    _dropdownlist.ID = &quot;dbtype&quot;;

        //    _dropdownlist.Items.Add(DBTypes.Date.ToString());
        //    _dropdownlist.Items.Add(DBTypes.Integer.ToString());
        //    _dropdownlist.Items.Add(DBTypes.Ntext.ToString());
        //    _dropdownlist.Items.Add(DBTypes.Nvarchar.ToString());

        //    DataEditorPropertyPanel pnlPrevalue = new DataEditorPropertyPanel();
        //    pnlPrevalue.Text = ui.Text(&quot;prevalue&quot;);

        //    _textbox = new TextBox();
        //    _textbox.ID = &quot;prevalues&quot;;
        //    _textbox.Visible = _displayTextBox;

        //    // put the childcontrols in context - ensuring that
        //    // the viewstate is persisted etc.

        //    pnlType.Controls.Add(_dropdownlist);
        //    Controls.Add(pnlType);

        //    if (_displayTextBox)
        //    {
        //        pnlPrevalue.Controls.Add(_textbox);
        //        Controls.Add(pnlPrevalue);
        //    }

            
        //}

        protected override void OnLoad(EventArgs e)
        {
            LoadSettings();

            base.OnLoad(e);
            if (!Page.IsPostBack)
            {
                if (_datatype != null)
                    _dropdownlist.SelectedValue = _datatype.DBType.ToString();
                else
                    _dropdownlist.SelectedValue = _datatypeOld.DBType.ToString();

                _textbox.Text = Prevalue;
            }
        }

        public string Prevalue
        {
            get
            {
                ensurePrevalue();
                if (_prevalue == null)
                {
                    int defId;
                    if (_datatype != null)
                        defId = _datatype.DataTypeDefinitionId;
                    else if (_datatypeOld != null)
                        defId = _datatypeOld.DataTypeDefinitionId;
                    else
                        throw new ArgumentException(&quot;Datatype is not initialized&quot;);

                    using (var sqlHelper = Application.SqlHelper)
                        _prevalue = sqlHelper.ExecuteScalar&lt;string&gt;(&quot;Select [value] from cmsDataTypePreValues where DataTypeNodeId = &quot; + defId);
                }
                return _prevalue;
            }
            set
            {
                int defId;
                if (_datatype != null)
                    defId = _datatype.DataTypeDefinitionId;
                else if (_datatypeOld != null)
                    defId = _datatypeOld.DataTypeDefinitionId;
                else
                    throw new ArgumentException(&quot;Datatype is not initialized&quot;);

                _prevalue = value;
                ensurePrevalue();
                using (var sqlHelper = Application.SqlHelper)
                {
                    IParameter[] SqlParams = new IParameter[]
                    {
                        sqlHelper.CreateParameter(&quot;@value&quot;, _textbox.Text),
                        sqlHelper.CreateParameter(&quot;@dtdefid&quot;, defId)
                    };

                    // update prevalue
                    sqlHelper.ExecuteNonQuery(&quot;update cmsDataTypePreValues set [value] = @value where datatypeNodeId = @dtdefid&quot;, SqlParams);
                }
            }
        }

        private void ensurePrevalue()
        {
            if (!_isEnsured)
            {

                int defId;
                if (_datatype != null)
                    defId = _datatype.DataTypeDefinitionId;
                else if (_datatypeOld != null)
                    defId = _datatypeOld.DataTypeDefinitionId;
                else
                    throw new ArgumentException(&quot;Datatype is not initialized&quot;);

                bool hasPrevalue = PreValues.CountOfPreValues(defId) &gt; 0;
                
                if (!hasPrevalue)
                {
                    PreValue.MakeNew(defId, _textbox.Text);
                }
                _isEnsured = true;
            }
        }

        public Control Editor
        {
            get { return this; }
        }

        public void Save()
        {
            bool hasErrors = false;
            foreach (KeyValuePair&lt;string, DataEditorSettingType&gt; k in dtSettings)
            {
                var result = k.Value.Validate();
                Label lbl = this.FindControlRecursive&lt;Label&gt;(&quot;lbl&quot; + k.Key);
                if (result == null &amp;&amp; lbl != null)
                {
                    if (lbl != null)
                        lbl.Text = string.Empty;
                }
                else
                {
                    if (hasErrors == false)
                        hasErrors = true;

                    if (lbl != null)
                        lbl.Text = &quot; &quot; + result.ErrorMessage;
                }
            }

            if (!hasErrors)
            {
                // save the prevalue data and get on with you life ;)
                if (_datatype != null)
                    _datatype.DBType =
                        (cms.businesslogic.datatype.DBTypes)
                        Enum.Parse(typeof (cms.businesslogic.datatype.DBTypes), _dropdownlist.SelectedValue, true);
                else if (_datatypeOld != null)
                    _datatypeOld.DBType = (DBTypes) Enum.Parse(typeof (DBTypes), _dropdownlist.SelectedValue, true);


                if (_displayTextBox)
                {
                    // If the prevalue editor has an prevalue textbox - save the textbox value as the prevalue
                    Prevalue = _textbox.Text;
                }

                DataEditorSettingsStorage ss = new DataEditorSettingsStorage();

                ss.ClearSettings(_datatype.DataTypeDefinitionId);

                int i = 0;
                foreach (KeyValuePair&lt;string, DataEditorSettingType&gt; k in dtSettings)
                {
                    ss.InsertSetting(_datatype.DataTypeDefinitionId, k.Key, k.Value.Value, i);
                    i++;

                }

                ss.Dispose();
            }
        }

        //protected override void Render(HtmlTextWriter writer)
        //{
        //    writer.Write(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&lt;div class=&#39;propertyItemheader&#39;&gt;&quot; + ui.Text(&quot;dataBaseDatatype&quot;) + &quot;&lt;/div&gt;&quot;);
        //    _dropdownlist.RenderControl(writer);
        //    writer.Write(&quot;&lt;br style=&#39;clear: both&#39;/&gt;&lt;/div&gt;&quot;);


        //    if (_displayTextBox)
        //    {
        //        writer.Write(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&lt;div class=&#39;propertyItemheader&#39;&gt;&quot; + ui.Text(&quot;prevalue&quot;) + &quot;&lt;/div&gt;&quot;);
        //        _textbox.RenderControl(writer);
        //        writer.Write(&quot;&lt;br style=&#39;clear: both&#39;/&gt;&lt;/div&gt;&quot;);
        //    }

        //    /*
        //    writer.WriteLine(&quot;&lt;div class=&#39;propertyItem&#39;&gt;&quot;);
        //    writer.WriteLine(&quot;&lt;tr&gt;&lt;td&gt;Database datatype&lt;/td&gt;&lt;td&gt;&quot;);
        //    _dropdownlist.RenderControl(writer);
        //    writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
        //    if (_displayTextBox)
        //        writer.WriteLine(&quot;&lt;tr&gt;&lt;td&gt;Prevalue: &lt;/td&gt;&lt;td&gt;&quot;);
        //    _textbox.RenderControl(writer);
        //    writer.WriteLine(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
        //    writer.Write(&quot;&lt;/div&gt;&quot;);
        //     */

        //}

        [Obsolete(&quot;Use the PreValues class for data access instead&quot;)]
        public static string GetPrevalueFromId(int Id)
        {
            using (var sqlHelper = Application.SqlHelper)
                return sqlHelper.ExecuteScalar&lt;string&gt;(&quot;Select [value] from cmsDataTypePreValues where id = @id&quot;,
                                                   sqlHelper.CreateParameter(&quot;@id&quot;, Id));
        }



        protected void LoadSettings()
        {
            DataEditorPropertyPanel pnlType = new DataEditorPropertyPanel();
            pnlType.Text = ui.Text(&quot;dataBaseDatatype&quot;);

            _dropdownlist = new DropDownList();
            _dropdownlist.ID = &quot;dbtype&quot;;

            _dropdownlist.Items.Add(DBTypes.Date.ToString());
            _dropdownlist.Items.Add(DBTypes.Integer.ToString());
            _dropdownlist.Items.Add(DBTypes.Ntext.ToString());
            _dropdownlist.Items.Add(DBTypes.Nvarchar.ToString());

            DataEditorPropertyPanel pnlPrevalue = new DataEditorPropertyPanel();
            pnlPrevalue.Text = ui.Text(&quot;prevalue&quot;);

            _textbox = new TextBox();
            _textbox.ID = &quot;prevalues&quot;;
            _textbox.Visible = _displayTextBox;

            // put the childcontrols in context - ensuring that
            // the viewstate is persisted etc.

            pnlType.Controls.Add(_dropdownlist);
            Controls.Add(pnlType);

            if (_displayTextBox)
            {
                pnlPrevalue.Controls.Add(_textbox);
                Controls.Add(pnlPrevalue);
            }

           
            foreach (KeyValuePair&lt;string, DataEditorSetting&gt; kv in _datatype.Settings())
            {
                DataEditorSettingType dst = kv.Value.GetDataEditorSettingType();
                dtSettings.Add(kv.Key, dst);

                DataEditorPropertyPanel panel = new DataEditorPropertyPanel();
                panel.Text = kv.Value.GetName();
                panel.Text += &quot;&lt;br/&gt;&lt;small&gt;&quot; + kv.Value.description + &quot;&lt;/small&gt;&quot;;


                if (_datatype.HasSettings())
                {
                    DataEditorSettingsStorage ss = new DataEditorSettingsStorage();

                    List&lt;Setting&lt;string, string&gt;&gt; s = ss.GetSettings(_datatype.DataTypeDefinitionId);
                    ss.Dispose();

                    if (s.Find(set =&gt; set.Key == kv.Key).Value != null)
                        dst.Value = s.Find(set =&gt; set.Key == kv.Key).Value;

                }

                panel.Controls.Add(dst.RenderControl(kv.Value));

                Label invalid = new Label();
                invalid.Attributes.Add(&quot;style&quot;, &quot;color:#8A1F11&quot;);
                invalid.ID = &quot;lbl&quot; + kv.Key;
                panel.Controls.Add(invalid);

                this.Controls.Add(panel);
            }
            
        }
    }


    public class DataEditorPropertyPanel : System.Web.UI.WebControls.Panel
    {
        public DataEditorPropertyPanel()
        {

        }

        private string m_Text = string.Empty;
        public string Text
        {
            get { return m_Text; }
            set { m_Text = value; }
        }


        protected override void OnLoad(System.EventArgs EventArguments)
        {
        }

        protected override void Render(System.Web.UI.HtmlTextWriter writer)
        {

            this.CreateChildControls();
            string styleString = &quot;&quot;;

            foreach (string key in this.Style.Keys)
            {
                styleString += key + &quot;:&quot; + this.Style[key] + &quot;;&quot;;
            }

            writer.WriteLine(&quot;&lt;div class=\&quot;propertyItem\&quot; style=&#39;&quot; + styleString + &quot;&#39;&gt;&quot;);
            if (m_Text != string.Empty)
            {
                writer.WriteLine(&quot;&lt;div class=\&quot;propertyItemheader\&quot;&gt;&quot; + m_Text + &quot;&lt;/div&gt;&quot;);
                writer.WriteLine(&quot;&lt;div class=\&quot;propertyItemContent\&quot;&gt;&quot;);
            }

            try
            {
                this.RenderChildren(writer);
            }
            catch (Exception ex)
            {
                writer.WriteLine(&quot;Error creating control &lt;br /&gt;&quot;);
                writer.WriteLine(ex.ToString());
            }

            if (m_Text != string.Empty)
                writer.WriteLine(&quot;&lt;/div&gt;&quot;);

            writer.WriteLine(&quot;&lt;/div&gt;&quot;);


        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,41,0],[31,9,31,120,0],[39,17,39,18,0],[39,19,39,48,0],[39,49,39,50,0],[47,9,47,108,0],[48,9,48,10,0],[50,13,50,46,0],[51,13,51,34,0],[53,9,53,10,0],[92,9,92,10,0],[93,13,93,28,0],[95,13,95,28,0],[96,13,96,34,0],[97,13,97,14,0],[98,17,98,39,0],[99,21,99,79,0],[101,21,101,82,0],[103,17,103,42,0],[104,13,104,14,0],[105,9,105,10,0],[110,13,110,14,0],[111,17,111,34,0],[112,17,112,39,0],[113,17,113,18,0],[115,21,115,43,0],[116,25,116,64,0],[117,26,117,51,0],[118,25,118,67,0],[120,25,120,84,0],[122,28,122,65,0],[123,25,123,145,0],[124,17,124,18,0],[125,17,125,34,0],[126,13,126,14,0],[128,13,128,14,0],[130,17,130,39,0],[131,21,131,60,0],[132,22,132,47,0],[133,21,133,63,0],[135,21,135,80,0],[137,17,137,35,0],[138,17,138,34,0],[139,24,139,61,0],[140,17,140,18,0],[141,21,145,23,0],[148,21,148,142,0],[149,17,149,18,0],[150,13,150,14,0],[154,9,154,10,0],[155,13,155,29,0],[156,13,156,14,0],[159,17,159,39,0],[160,21,160,60,0],[161,22,161,47,0],[162,21,162,63,0],[164,21,164,80,0],[166,17,166,74,0],[168,17,168,34,0],[169,17,169,18,0],[170,21,170,60,0],[171,17,171,18,0],[172,17,172,35,0],[173,13,173,14,0],[174,9,174,10,0],[178,17,178,18,0],[178,19,178,31,0],[178,32,178,33,0],[182,9,182,10,0],[183,13,183,36,0],[184,13,184,20,0],[184,22,184,67,0],[184,68,184,70,0],[184,71,184,81,0],[185,13,185,14,0],[186,17,186,49,0],[187,17,187,77,0],[188,17,188,51,0],[189,17,189,18,0],[190,21,190,37,0],[191,25,191,49,0],[192,17,192,18,0],[194,17,194,18,0],[195,21,195,44,0],[196,25,196,42,0],[198,21,198,37,0],[199,25,199,62,0],[200,17,200,18,0],[201,13,201,14,0],[203,13,203,28,0],[204,13,204,14,0],[206,17,206,39,0],[207,21,209,116,0],[210,22,210,47,0],[211,21,211,117,0],[214,17,214,37,0],[215,17,215,18,0],[217,21,217,46,0],[218,17,218,18,0],[220,17,220,80,0],[222,17,222,66,0],[224,17,224,27,0],[225,17,225,24,0],[225,26,225,71,0],[225,72,225,74,0],[225,75,225,85,0],[226,17,226,18,0],[227,21,227,95,0],[228,21,228,25,0],[230,17,230,18,0],[232,17,232,30,0],[233,13,233,14,0],[234,9,234,10,0],[266,9,266,10,0],[267,20,267,57,0],[268,17,269,90,0],[270,9,270,10,0],[275,9,275,10,0],[276,13,276,77,0],[277,13,277,56,0],[279,13,279,48,0],[280,13,280,41,0],[282,13,282,62,0],[283,13,283,65,0],[284,13,284,63,0],[285,13,285,66,0],[287,13,287,81,0],[288,13,288,52,0],[290,13,290,38,0],[291,13,291,39,0],[292,13,292,48,0],[297,13,297,49,0],[298,13,298,35,0],[300,13,300,33,0],[301,13,301,14,0],[302,17,302,52,0],[303,17,303,43,0],[304,13,304,14,0],[307,13,307,20,0],[307,22,307,64,0],[307,65,307,67,0],[307,68,307,88,0],[308,13,308,14,0],[309,17,309,81,0],[310,17,310,45,0],[312,17,312,79,0],[313,17,313,49,0],[314,17,314,82,0],[317,17,317,45,0],[318,17,318,18,0],[319,21,319,84,0],[321,21,321,102,0],[322,21,322,34,0],[324,21,324,39,0],[324,39,324,56,0],[324,56,324,72,0],[324,21,324,72,0],[325,25,325,51,0],[325,51,325,68,0],[325,68,325,76,0],[325,25,325,76,0],[327,17,327,18,0],[329,17,329,65,0],[331,17,331,45,0],[332,17,332,66,0],[333,17,333,45,0],[334,17,334,45,0],[336,17,336,42,0],[337,13,337,14,0],[339,9,339,10,0],[345,9,345,41,0],[346,9,346,10,0],[348,9,348,10,0],[350,9,350,46,0],[353,17,353,18,0],[353,19,353,33,0],[353,34,353,35,0],[354,17,354,18,0],[354,19,354,34,0],[354,35,354,36,0],[359,9,359,10,0],[360,9,360,10,0],[363,9,363,10,0],[365,13,365,40,0],[366,13,366,37,0],[368,13,368,20,0],[368,22,368,32,0],[368,33,368,35,0],[368,36,368,51,0],[369,13,369,14,0],[370,17,370,66,0],[371,13,371,14,0],[373,13,373,90,0],[374,13,374,40,0],[375,13,375,14,0],[376,17,376,92,0],[377,17,377,73,0],[378,13,378,14,0],[381,13,381,14,0],[382,17,382,45,0],[383,13,383,14,0],[384,13,384,33,0],[385,13,385,14,0],[386,17,386,67,0],[387,17,387,49,0],[388,13,388,14,0],[390,13,390,40,0],[391,17,391,44,0],[393,13,393,40,0],[396,9,396,10,0]]);
    </script>
  </body>
</html>