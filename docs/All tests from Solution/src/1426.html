<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\UmbracoApplicationBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.Linq;
using System.Reflection;
using System.Threading;
using System.Web;
using System.Web.Hosting;
using log4net;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;

namespace Umbraco.Core
{

    /// &lt;summary&gt;
    /// The abstract class for the Umbraco HttpApplication
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This is exposed in the core so that we can have the IApplicationEventHandler in the core project so that 
    /// IApplicationEventHandler&#39;s can fire/execute outside of the web contenxt (i.e. in console applications)
    /// &lt;/remarks&gt;
    public abstract class UmbracoApplicationBase : System.Web.HttpApplication
    {

        public static event EventHandler ApplicationStarting;
        public static event EventHandler ApplicationStarted;

        /// &lt;summary&gt;
        /// Called when the HttpApplication.Init() is fired, allows developers to subscribe to the HttpApplication events
        /// &lt;/summary&gt;
        public static event EventHandler ApplicationInit;

        /// &lt;summary&gt;
        /// Boots up the Umbraco application
        /// &lt;/summary&gt;
        internal void StartApplication(object sender, EventArgs e)
        {
            //take care of unhandled exceptions - there is nothing we can do to 
            // prevent the entire w3wp process to go down but at least we can try
            // and log the exception
            AppDomain.CurrentDomain.UnhandledException += (_, args) =&gt;
            {
                var exception = (Exception) args.ExceptionObject;
                var isTerminating = args.IsTerminating; // always true?

                var msg = &quot;Unhandled exception in AppDomain&quot;;
                if (isTerminating) msg += &quot; (terminating)&quot;;
                LogHelper.Error&lt;UmbracoApplicationBase&gt;(msg, exception);
            };

            // this only gets called when an assembly can&#39;t be resolved
            AppDomain.CurrentDomain.AssemblyResolve += CurrentDomainOnAssemblyResolve;

            //boot up the application
            GetBootManager()
                .Initialize()
                .Startup(appContext =&gt; OnApplicationStarting(sender, e))
                .Complete(appContext =&gt; OnApplicationStarted(sender, e));

            //And now we can dispose of our startup handlers - save some memory
            ApplicationEventsResolver.Current.Dispose();
        }

        /// &lt;summary&gt;
        /// Called when an assembly can&#39;t be resolved. In here we can do magic with the assembly name and try loading another.
        /// This is used for loading a signed assembly of AutoMapper (v. 3.1+) without having to recompile old code.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private Assembly CurrentDomainOnAssemblyResolve(object sender, ResolveEventArgs args)
        {
            // ensure the assembly is indeed AutoMapper and that the PublicKeyToken is null before trying to Load again
            // do NOT just replace this with &#39;return Assembly&#39;, as it will cause an infinite loop -&gt; stackoverflow
            if (args.Name.StartsWith(&quot;AutoMapper&quot;) &amp;&amp; args.Name.EndsWith(&quot;PublicKeyToken=null&quot;))
                return Assembly.Load(args.Name.Replace(&quot;, PublicKeyToken=null&quot;, &quot;, PublicKeyToken=be96cd2c38ef1005&quot;));
            return null;
        }

        /// &lt;summary&gt;
        /// Initializes the Umbraco application
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void Application_Start(object sender, EventArgs e)
        {
            Thread.CurrentThread.SanitizeThreadCulture();
            StartApplication(sender, e);
        }

        /// &lt;summary&gt;
        /// Override init and raise the event
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// DID YOU KNOW? The Global.asax Init call is the thing that initializes all of the httpmodules, ties up a bunch of stuff with IIS, etc...
        /// Therefore, since OWIN is an HttpModule when running in IIS/ASP.Net the OWIN startup is not executed until this method fires and by that
        /// time, Umbraco has performed it&#39;s bootup sequence.
        /// &lt;/remarks&gt;
        public override void Init()
        {
            base.Init();
            OnApplicationInit(this, new EventArgs());
        }

        /// &lt;summary&gt;
        /// Developers can override this method to modify objects on startup
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected virtual void OnApplicationStarting(object sender, EventArgs e)
        {
            if (ApplicationStarting != null)
            {
                try
                {
                    ApplicationStarting(sender, e);
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;UmbracoApplicationBase&gt;(&quot;An error occurred in an ApplicationStarting event handler&quot;, ex);
                    throw;
                }
            }
                
        }

        /// &lt;summary&gt;
        /// Developers can override this method to do anything they need to do once the application startup routine is completed.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected virtual void OnApplicationStarted(object sender, EventArgs e)
        {
            if (ApplicationStarted != null)
            {
                try
                {
                    ApplicationStarted(sender, e);
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;UmbracoApplicationBase&gt;(&quot;An error occurred in an ApplicationStarted event handler&quot;, ex);
                    throw;
                }
            }
        }

        /// &lt;summary&gt;
        /// Called to raise the ApplicationInit event
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        private void OnApplicationInit(object sender, EventArgs e)
        {
            if (ApplicationInit != null)
            {
                try
                {
                    ApplicationInit(sender, e);
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;UmbracoApplicationBase&gt;(&quot;An error occurred in an ApplicationInit event handler&quot;, ex);
                    throw;
                }
            }
        }

        /// &lt;summary&gt;
        /// A method that can be overridden to invoke code when the application has an error.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected virtual void OnApplicationError(object sender, EventArgs e)
        {

        }

        protected void Application_Error(object sender, EventArgs e)
        {
            // Code that runs when an unhandled error occurs

            // Get the exception object.
            var exc = Server.GetLastError();

            // Ignore HTTP errors
            if (exc.GetType() == typeof(HttpException))
            {
                return;
            }
            
            Logger.Error&lt;UmbracoApplicationBase&gt;(&quot;An unhandled exception occurred&quot;, exc);

            OnApplicationError(sender, e);
        }

        /// &lt;summary&gt;
        /// A method that can be overridden to invoke code when the application shuts down.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected virtual void OnApplicationEnd(object sender, EventArgs e)
        {

        }

        protected void Application_End(object sender, EventArgs e)
        {
            if (SystemUtilities.GetCurrentTrustLevel() == AspNetHostingPermissionLevel.Unrestricted)
            {
                //Try to log the detailed shutdown message (typical asp.net hack: http://weblogs.asp.net/scottgu/433194)
                try
                {
                    var runtime = (HttpRuntime)typeof(HttpRuntime).InvokeMember(&quot;_theRuntime&quot;,
                                BindingFlags.NonPublic
                                | BindingFlags.Static
                                | BindingFlags.GetField,
                                null,
                                null,
                                null);
                    if (runtime == null)
                        return;

                    var shutDownMessage = (string)runtime.GetType().InvokeMember(&quot;_shutDownMessage&quot;,
                        BindingFlags.NonPublic
                        | BindingFlags.Instance
                        | BindingFlags.GetField,
                        null,
                        runtime,
                        null);

                    var shutDownStack = (string)runtime.GetType().InvokeMember(&quot;_shutDownStack&quot;,
                        BindingFlags.NonPublic
                        | BindingFlags.Instance
                        | BindingFlags.GetField,
                        null,
                        runtime,
                        null);

                    var shutdownMsg = string.Format(&quot;{0}\r\n\r\n_shutDownMessage={1}\r\n\r\n_shutDownStack={2}&quot;,
                        HostingEnvironment.ShutdownReason,
                        shutDownMessage,
                        shutDownStack);

                    Logger.Info&lt;UmbracoApplicationBase&gt;(&quot;Application shutdown. Details: &quot; + shutdownMsg);
                }
                catch (Exception)
                {
                    //if for some reason that fails, then log the normal output
                    Logger.Info&lt;UmbracoApplicationBase&gt;(&quot;Application shutdown. Reason: &quot; + HostingEnvironment.ShutdownReason);
                }
            }
            OnApplicationEnd(sender, e);

            //Last thing to do is shutdown log4net
            LogManager.Shutdown();
        }

        protected abstract IBootManager GetBootManager();

        protected ILogger Logger
        {
            get
            {
                // LoggerResolver can resolve before resolution is frozen
                if (LoggerResolver.HasCurrent &amp;&amp; LoggerResolver.Current.HasValue)
                {
                    return LoggerResolver.Current.Logger;
                }
                return new HttpTraceLogger();
            }
        }

        private class HttpTraceLogger : ILogger
        {
            public void Error(Type callingType, string message, Exception exception)
            {
                if (HttpContext.Current == null) return;
                HttpContext.Current.Trace.Warn(callingType.ToString(), message + Environment.NewLine + exception);
            }

            public void Warn(Type callingType, string message, params Func&lt;object&gt;[] formatItems)
            {
                if (HttpContext.Current == null) return;
                HttpContext.Current.Trace.Warn(callingType.ToString(), string.Format(message, formatItems.Select(x =&gt; x())));
            }

            public void WarnWithException(Type callingType, string message, Exception e, params Func&lt;object&gt;[] formatItems)
            {
                if (HttpContext.Current == null) return;
                HttpContext.Current.Trace.Warn(callingType.ToString(), string.Format(message + Environment.NewLine + e, formatItems.Select(x =&gt; x())));
            }

            public void Info(Type callingType, Func&lt;string&gt; generateMessage)
            {
                if (HttpContext.Current == null) return;
                HttpContext.Current.Trace.Write(callingType.ToString(), generateMessage());
            }

            public void Info(Type type, string generateMessageFormat, params Func&lt;object&gt;[] formatItems)
            {
                if (HttpContext.Current == null) return;
                HttpContext.Current.Trace.Write(type.ToString(), string.Format(generateMessageFormat, formatItems.Select(x =&gt; x())));
            }

            public void Debug(Type callingType, Func&lt;string&gt; generateMessage)
            {
                if (HttpContext.Current == null) return;
                HttpContext.Current.Trace.Write(callingType.ToString(), generateMessage());
            }

            public void Debug(Type type, string generateMessageFormat, params Func&lt;object&gt;[] formatItems)
            {
                if (HttpContext.Current == null) return;
                HttpContext.Current.Trace.Write(type.ToString(), string.Format(generateMessageFormat, formatItems.Select(x =&gt; x())));
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[37,9,37,10,1],[41,13,42,13,1],[42,13,42,14,0],[42,14,43,17,1],[43,17,43,66,0],[43,66,44,17,1],[44,17,44,56,0],[44,56,46,17,1],[46,17,46,62,0],[46,62,47,17,1],[47,17,47,35,0],[47,35,47,36,1],[47,36,47,60,0],[47,60,48,17,1],[48,17,48,73,0],[48,73,49,13,1],[49,13,49,14,0],[49,14,49,15,1],[41,13,49,15,1],[52,13,52,87,1],[55,13,57,40,1],[57,40,57,72,1],[57,72,58,41,1],[58,41,58,72,1],[58,72,58,74,1],[55,13,58,74,1],[61,13,61,57,1],[62,9,62,10,1],[72,9,72,10,1],[75,13,75,97,1],[76,17,76,119,0],[77,13,77,25,1],[78,9,78,10,1],[86,9,86,10,0],[87,13,87,58,0],[88,13,88,41,0],[89,9,89,10,0],[100,9,100,10,0],[101,13,101,25,0],[102,13,102,54,0],[103,9,103,10,0],[111,9,111,10,1],[112,13,112,45,1],[113,13,113,14,1],[115,17,115,18,1],[116,21,116,52,1],[117,17,117,18,1],[118,17,118,37,0],[119,17,119,18,0],[120,21,120,126,0],[121,21,121,27,0],[123,13,123,14,1],[125,9,125,10,1],[133,9,133,10,1],[134,13,134,44,1],[135,13,135,14,1],[137,17,137,18,1],[138,21,138,51,1],[139,17,139,18,1],[140,17,140,37,0],[141,17,141,18,0],[142,21,142,125,0],[143,21,143,27,0],[145,13,145,14,1],[146,9,146,10,1],[154,9,154,10,0],[155,13,155,41,0],[156,13,156,14,0],[158,17,158,18,0],[159,21,159,48,0],[160,17,160,18,0],[161,17,161,37,0],[162,17,162,18,0],[163,21,163,122,0],[164,21,164,27,0],[166,13,166,14,0],[167,9,167,10,0],[175,9,175,10,0],[177,9,177,10,0],[180,9,180,10,0],[184,13,184,45,0],[187,13,187,56,0],[188,13,188,14,0],[189,17,189,24,0],[192,13,192,90,0],[194,13,194,43,0],[195,9,195,10,0],[203,9,203,10,0],[205,9,205,10,0],[208,9,208,10,0],[209,13,209,101,0],[210,13,210,14,0],[213,17,213,18,0],[214,21,220,39,0],[221,21,221,41,0],[222,25,222,32,0],[224,21,230,31,0],[232,21,238,31,0],[240,21,243,40,0],[245,21,245,106,0],[246,17,246,18,0],[247,17,247,34,0],[248,17,248,18,0],[250,21,250,127,0],[251,17,251,18,0],[252,13,252,14,0],[253,13,253,41,0],[256,13,256,35,0],[257,9,257,10,0],[264,13,264,14,0],[266,17,266,82,0],[267,17,267,18,0],[268,21,268,58,0],[270,17,270,46,0],[271,13,271,14,0],[277,13,277,14,0],[278,17,278,49,0],[278,50,278,57,0],[279,17,279,115,0],[280,13,280,14,0],[283,13,283,14,0],[284,17,284,49,0],[284,50,284,57,0],[285,17,285,119,0],[285,119,285,122,0],[285,122,285,126,0],[285,17,285,126,0],[286,13,286,14,0],[289,13,289,14,0],[290,17,290,49,0],[290,50,290,57,0],[291,17,291,145,0],[291,145,291,148,0],[291,148,291,152,0],[291,17,291,152,0],[292,13,292,14,0],[295,13,295,14,0],[296,17,296,49,0],[296,50,296,57,0],[297,17,297,92,0],[298,13,298,14,0],[301,13,301,14,0],[302,17,302,49,0],[302,50,302,57,0],[303,17,303,127,0],[303,127,303,130,0],[303,130,303,134,0],[303,17,303,134,0],[304,13,304,14,0],[307,13,307,14,0],[308,17,308,49,0],[308,50,308,57,0],[309,17,309,92,0],[310,13,310,14,0],[313,13,313,14,0],[314,17,314,49,0],[314,50,314,57,0],[315,17,315,127,0],[315,127,315,130,0],[315,130,315,134,0],[315,17,315,134,0],[316,13,316,14,0]]);
    </script>
  </body>
</html>