<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\MediaRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Xml.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class MediaRepositoryTest : BaseDatabaseFactoryTest
    {
        public MediaRepositoryTest()
        {
        }

        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            CreateTestData();
        }

        private MediaRepository CreateRepository(IDatabaseUnitOfWork unitOfWork, out MediaTypeRepository mediaTypeRepository)
        {
            mediaTypeRepository = new MediaTypeRepository(unitOfWork, CacheHelper, Mock.Of&lt;ILogger&gt;(), SqlSyntax);
            var tagRepository = new TagRepository(unitOfWork, CacheHelper, Mock.Of&lt;ILogger&gt;(), SqlSyntax);
            var repository = new MediaRepository(unitOfWork, CacheHelper, Mock.Of&lt;ILogger&gt;(), SqlSyntax, mediaTypeRepository, tagRepository, Mock.Of&lt;IContentSection&gt;());
            return repository;
        }

        [Test]
        public void Rebuild_All_Xml_Structures()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                var mediaType = mediaTypeRepository.Get(1032);

                for (var i = 0; i &lt; 100; i++)
                {
                    var image = MockedMedia.CreateMediaImage(mediaType, -1);
                    repository.AddOrUpdate(image);
                }
                unitOfWork.Commit();

                //delete all xml
                unitOfWork.Database.Execute(&quot;DELETE FROM cmsContentXml&quot;);
                Assert.AreEqual(0, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));

                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10);

                Assert.AreEqual(103, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));
            }
        }

        [Test]
        public void Rebuild_All_Xml_Structures_Ensure_Orphaned_Are_Removed()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                //delete all xml
                unitOfWork.Database.Execute(&quot;DELETE FROM cmsContentXml&quot;);

                var mediaType = mediaTypeRepository.Get(1032);

                for (var i = 0; i &lt; 100; i++)
                {
                    var image = MockedMedia.CreateMediaImage(mediaType, -1);
                    repository.AddOrUpdate(image);
                }
                unitOfWork.Commit();

                //Add some extra orphaned rows that shouldn&#39;t be there
                var trashed = MockedMedia.CreateMediaImage(mediaType, -1);
                trashed.ChangeTrashedState(true, Constants.System.RecycleBinMedia);
                repository.AddOrUpdate(trashed);
                unitOfWork.Commit();
                //Force add it
                unitOfWork.Database.Insert(new ContentXmlDto
                {
                    NodeId = trashed.Id,
                    Xml = &quot;&lt;test&gt;&lt;/test&gt;&quot;
                });

                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10);

                Assert.AreEqual(103, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));
            }
        }

        [Test]
        public void Rebuild_Some_Xml_Structures()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                var mediaType = mediaTypeRepository.Get(1032);

                IMedia img50 = null;
                for (var i = 0; i &lt; 100; i++)
                {
                    var image = MockedMedia.CreateMediaImage(mediaType, -1);
                    repository.AddOrUpdate(image);
                    if (i == 50) img50 = image;
                }
                unitOfWork.Commit();

                // assume this works (see other test)
                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10);

                //delete some xml
                unitOfWork.Database.Execute(&quot;DELETE FROM cmsContentXml WHERE nodeId &lt; &quot; + img50.Id);
                Assert.AreEqual(50, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));

                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10);

                Assert.AreEqual(103, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));
            }
        }

        [Test]
        public void Rebuild_All_Xml_Structures_For_Content_Type()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                var imageMediaType = mediaTypeRepository.Get(1032);
                var fileMediaType = mediaTypeRepository.Get(1033);
                var folderMediaType = mediaTypeRepository.Get(1031);

                for (var i = 0; i &lt; 30; i++)
                {
                    var image = MockedMedia.CreateMediaImage(imageMediaType, -1);
                    repository.AddOrUpdate(image);
                }
                for (var i = 0; i &lt; 30; i++)
                {
                    var file = MockedMedia.CreateMediaFile(fileMediaType, -1);
                    repository.AddOrUpdate(file);
                }
                for (var i = 0; i &lt; 30; i++)
                {
                    var folder = MockedMedia.CreateMediaFolder(folderMediaType, -1);
                    repository.AddOrUpdate(folder);
                }
                unitOfWork.Commit();

                //delete all xml
                unitOfWork.Database.Execute(&quot;DELETE FROM cmsContentXml&quot;);
                Assert.AreEqual(0, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));

                repository.RebuildXmlStructures(media =&gt; new XElement(&quot;test&quot;), 10, contentTypeIds: new[] { 1032, 1033 });

                Assert.AreEqual(62, unitOfWork.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM cmsContentXml&quot;));
            }
        }

        [Test]
        public void Can_Perform_Add_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                var mediaType = mediaTypeRepository.Get(1032);
                var image = MockedMedia.CreateMediaImage(mediaType, -1);

                // Act
                mediaTypeRepository.AddOrUpdate(mediaType);
                repository.AddOrUpdate(image);
                unitOfWork.Commit();

                var fetched = repository.Get(image.Id);

                // Assert
                Assert.That(mediaType.HasIdentity, Is.True);
                Assert.That(image.HasIdentity, Is.True);

                TestHelper.AssertAllPropertyValuesAreEquals(image, fetched, &quot;yyyy-MM-dd HH:mm:ss&quot;);
            }
        }

        [Test]
        public void Can_Perform_Multiple_Adds_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                var mediaType = mediaTypeRepository.Get(1032);
                var file = MockedMedia.CreateMediaFile(mediaType, -1);

                // Act
                repository.AddOrUpdate(file);
                unitOfWork.Commit();

                var image = MockedMedia.CreateMediaImage(mediaType, -1);
                repository.AddOrUpdate(image);
                unitOfWork.Commit();

                // Assert
                Assert.That(file.HasIdentity, Is.True);
                Assert.That(image.HasIdentity, Is.True);
                Assert.That(file.Name, Is.EqualTo(&quot;Test File&quot;));
                Assert.That(image.Name, Is.EqualTo(&quot;Test Image&quot;));
                Assert.That(file.ContentTypeId, Is.EqualTo(mediaType.Id));
                Assert.That(image.ContentTypeId, Is.EqualTo(mediaType.Id));
            }
        }

        [Test]
        public void Can_Perform_Multiple_Adds_On_MediaRepository_With_RepositoryResolver()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                var mediaType = mediaTypeRepository.Get(1032);
                var file = MockedMedia.CreateMediaFile(mediaType, -1);

                // Act
                repository.AddOrUpdate(file);
                unitOfWork.Commit();

                var image = MockedMedia.CreateMediaImage(mediaType, -1);
                repository.AddOrUpdate(image);
                unitOfWork.Commit();

                // Assert
                Assert.That(file.HasIdentity, Is.True);
                Assert.That(image.HasIdentity, Is.True);
                Assert.That(file.Name, Is.EqualTo(&quot;Test File&quot;));
                Assert.That(image.Name, Is.EqualTo(&quot;Test Image&quot;));
                Assert.That(file.ContentTypeId, Is.EqualTo(mediaType.Id));
                Assert.That(image.ContentTypeId, Is.EqualTo(mediaType.Id));
            }
        }

        [Test]
        public void Can_Verify_Fresh_Entity_Is_Not_Dirty()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                // Act
                var media = repository.Get(NodeDto.NodeIdSeed + 1);
                bool dirty = ((ICanBeDirty)media).IsDirty();

                // Assert
                Assert.That(dirty, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Update_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                // Act
                var content = repository.Get(NodeDto.NodeIdSeed + 2);
                content.Name = &quot;Test File Updated&quot;;
                repository.AddOrUpdate(content);
                unitOfWork.Commit();

                var updatedContent = repository.Get(NodeDto.NodeIdSeed + 2);

                // Assert
                Assert.That(updatedContent.Id, Is.EqualTo(content.Id));
                Assert.That(updatedContent.Name, Is.EqualTo(content.Name));
            }
        }

        [Test]
        public void Can_Perform_Delete_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                // Act
                var media = repository.Get(NodeDto.NodeIdSeed + 2);
                repository.Delete(media);
                unitOfWork.Commit();

                var deleted = repository.Get(NodeDto.NodeIdSeed + 2);
                var exists = repository.Exists(NodeDto.NodeIdSeed + 2);

                // Assert
                Assert.That(deleted, Is.Null);
                Assert.That(exists, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Get_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                // Act
                var media = repository.Get(NodeDto.NodeIdSeed + 1);

                // Assert
                Assert.That(media.Id, Is.EqualTo(NodeDto.NodeIdSeed + 1));
                Assert.That(media.CreateDate, Is.GreaterThan(DateTime.MinValue));
                Assert.That(media.UpdateDate, Is.GreaterThan(DateTime.MinValue));
                Assert.That(media.ParentId, Is.Not.EqualTo(0));
                Assert.That(media.Name, Is.EqualTo(&quot;Test Image&quot;));
                Assert.That(media.SortOrder, Is.EqualTo(0));
                Assert.That(media.Version, Is.Not.EqualTo(Guid.Empty));
                Assert.That(media.ContentTypeId, Is.EqualTo(1032));
                Assert.That(media.Path, Is.Not.Empty);
                Assert.That(media.Properties.Any(), Is.True);
            }
        }

        [Test]
        public void Can_Perform_GetByQuery_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == 2);
                var result = repository.GetByQuery(query);

                // Assert
                Assert.That(result.Count(), Is.GreaterThanOrEqualTo(2)); //There should be two entities on level 2: File and Media
            }
        }

        [Test]
        public void Can_Perform_GetByQuery_On_MediaRepository_With_ContentType_Id_Filter()
        {
            // Arrange            
            var folderMediaType = ServiceContext.ContentTypeService.GetMediaType(1031);
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                for (int i = 0; i &lt; 10; i++)
                {
                    var folder = MockedMedia.CreateMediaFolder(folderMediaType, -1);
                    repository.AddOrUpdate(folder);
                }
                unitOfWork.Commit();

                var types = new[] { 1031 };
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; types.Contains(x.ContentTypeId));
                var result = repository.GetByQuery(query);

                // Assert
                Assert.That(result.Count(), Is.GreaterThanOrEqualTo(11)); 
            }
        }

        [Ignore(&quot;We could allow this to work but it requires an extra join on the query used which currently we don&#39;t absolutely need so leaving this out for now&quot;)]
        [Test]
        public void Can_Perform_GetByQuery_On_MediaRepository_With_ContentType_Alias_Filter()
        {
            // Arrange            
            var folderMediaType = ServiceContext.ContentTypeService.GetMediaType(1031);
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                for (int i = 0; i &lt; 10; i++)
                {
                    var folder = MockedMedia.CreateMediaFolder(folderMediaType, -1);
                    repository.AddOrUpdate(folder);
                }
                unitOfWork.Commit();

                var types = new[] { &quot;Folder&quot; };
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; types.Contains(x.ContentType.Alias));
                var result = repository.GetByQuery(query);

                // Assert
                Assert.That(result.Count(), Is.GreaterThanOrEqualTo(11));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_ForFirstPage_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;SortOrder&quot;, Direction.Ascending, true);

                // Assert
                Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Test Image&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_ForSecondPage_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 1, 1, out totalRecords, &quot;SortOrder&quot;, Direction.Ascending, true);

                // Assert
                Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Test File&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WithSinglePage_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 2, out totalRecords, &quot;SortOrder&quot;, Direction.Ascending, true);

                // Assert
                Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(2));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Test Image&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WithDescendingOrder_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;SortOrder&quot;, Direction.Descending, true);

                // Assert
                Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Test File&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WitAlternateOrder_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;Name&quot;, Direction.Ascending, true);

                // Assert
                Assert.That(totalRecords, Is.GreaterThanOrEqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Test File&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WithFilterMatchingSome_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;SortOrder&quot;, Direction.Ascending, true, &quot;File&quot;);

                // Assert
                Assert.That(totalRecords, Is.EqualTo(1));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Test File&quot;));
            }
        }
        
        [Test]
        public void Can_Perform_GetPagedResultsByQuery_WithFilterMatchingAll_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {
                // Act
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == 2);
                long totalRecords;
                var result = repository.GetPagedResultsByQuery(query, 0, 1, out totalRecords, &quot;SortOrder&quot;, Direction.Ascending, true, &quot;Test&quot;);

                // Assert
                Assert.That(totalRecords, Is.EqualTo(2));
                Assert.That(result.Count(), Is.EqualTo(1));
                Assert.That(result.First().Name, Is.EqualTo(&quot;Test Image&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetAll_By_Param_Ids_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                // Act
                var medias = repository.GetAll(NodeDto.NodeIdSeed + 1, NodeDto.NodeIdSeed + 2);

                // Assert
                Assert.That(medias, Is.Not.Null);
                Assert.That(medias.Any(), Is.True);
                Assert.That(medias.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_GetAll_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                // Act
                var medias = repository.GetAll();

                // Assert
                Assert.That(medias, Is.Not.Null);
                Assert.That(medias.Any(), Is.True);
                Assert.That(medias.Count(), Is.GreaterThanOrEqualTo(3));
            }
        }

        [Test]
        public void Can_Perform_Exists_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                // Act
                var exists = repository.Exists(NodeDto.NodeIdSeed + 1);
                var existsToo = repository.Exists(NodeDto.NodeIdSeed + 1);
                var doesntExists = repository.Exists(NodeDto.NodeIdSeed + 5);

                // Assert
                Assert.That(exists, Is.True);
                Assert.That(existsToo, Is.True);
                Assert.That(doesntExists, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Count_On_MediaRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            MediaTypeRepository mediaTypeRepository;
            using (var repository = CreateRepository(unitOfWork, out mediaTypeRepository))
            {

                // Act
                int level = 2;
                var query = Query&lt;IMedia&gt;.Builder.Where(x =&gt; x.Level == level);
                var result = repository.Count(query);

                // Assert
                Assert.That(result, Is.GreaterThanOrEqualTo(2));
            }
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        public void CreateTestData()
        {
            //Create and Save folder-Media -&gt; (NodeDto.NodeIdSeed)
            var folderMediaType = ServiceContext.ContentTypeService.GetMediaType(1031);
            var folder = MockedMedia.CreateMediaFolder(folderMediaType, -1);
            ServiceContext.MediaService.Save(folder, 0);

            //Create and Save image-Media -&gt; (NodeDto.NodeIdSeed + 1)
            var imageMediaType = ServiceContext.ContentTypeService.GetMediaType(1032);
            var image = MockedMedia.CreateMediaImage(imageMediaType, folder.Id);
            ServiceContext.MediaService.Save(image, 0);

            //Create and Save file-Media -&gt; (NodeDto.NodeIdSeed + 2)
            var fileMediaType = ServiceContext.ContentTypeService.GetMediaType(1033);
            var file = MockedMedia.CreateMediaFile(fileMediaType, folder.Id);
            ServiceContext.MediaService.Save(file, 0);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,37,1],[27,9,27,10,1],[28,9,28,10,1],[32,9,32,10,1],[33,13,33,31,1],[35,13,35,30,1],[36,9,36,10,1],[39,9,39,10,1],[40,13,40,115,1],[41,13,41,107,1],[42,13,42,170,1],[43,13,43,31,1],[44,9,44,10,1],[48,9,48,10,1],[49,13,49,67,1],[50,13,50,55,1],[52,20,52,90,1],[53,13,53,14,1],[55,17,55,63,1],[57,22,57,31,1],[57,33,57,40,1],[57,42,57,45,1],[58,17,58,18,1],[59,21,59,77,1],[60,21,60,51,1],[61,17,61,18,1],[62,17,62,37,1],[65,17,65,74,1],[66,17,66,114,1],[68,17,68,58,1],[68,58,68,78,1],[68,78,68,84,1],[68,17,68,84,1],[70,17,70,116,1],[71,13,71,14,1],[72,9,72,10,1],[76,9,76,10,1],[77,13,77,67,1],[78,13,78,55,1],[80,20,80,90,1],[81,13,81,14,1],[83,17,83,74,1],[85,17,85,63,1],[87,22,87,31,1],[87,33,87,40,1],[87,42,87,45,1],[88,17,88,18,1],[89,21,89,77,1],[90,21,90,51,1],[91,17,91,18,1],[92,17,92,37,1],[95,17,95,75,1],[96,17,96,84,1],[97,17,97,49,1],[98,17,98,37,1],[100,17,104,20,1],[106,17,106,58,1],[106,58,106,78,1],[106,78,106,84,1],[106,17,106,84,1],[108,17,108,116,1],[109,13,109,14,1],[110,9,110,10,1],[114,9,114,10,1],[115,13,115,67,1],[116,13,116,55,1],[118,20,118,90,1],[119,13,119,14,1],[121,17,121,63,1],[123,17,123,37,1],[124,22,124,31,1],[124,33,124,40,1],[124,42,124,45,1],[125,17,125,18,1],[126,21,126,77,1],[127,21,127,51,1],[128,21,128,33,1],[128,34,128,48,1],[129,17,129,18,1],[130,17,130,37,1],[133,17,133,58,1],[133,58,133,78,1],[133,78,133,84,1],[133,17,133,84,1],[136,17,136,101,1],[137,17,137,115,1],[139,17,139,58,1],[139,58,139,78,1],[139,78,139,84,1],[139,17,139,84,1],[141,17,141,116,1],[142,13,142,14,1],[143,9,143,10,1],[147,9,147,10,1],[148,13,148,67,1],[149,13,149,55,1],[151,20,151,90,1],[152,13,152,14,1],[154,17,154,68,1],[155,17,155,67,1],[156,17,156,69,1],[158,22,158,31,1],[158,33,158,39,1],[158,41,158,44,1],[159,17,159,18,1],[160,21,160,82,1],[161,21,161,51,1],[162,17,162,18,1],[163,22,163,31,1],[163,33,163,39,1],[163,41,163,44,1],[164,17,164,18,1],[165,21,165,79,1],[166,21,166,50,1],[167,17,167,18,1],[168,22,168,31,1],[168,33,168,39,1],[168,41,168,44,1],[169,17,169,18,1],[170,21,170,85,1],[171,21,171,52,1],[172,17,172,18,1],[173,17,173,37,1],[176,17,176,74,1],[177,17,177,114,1],[179,17,179,58,1],[179,58,179,78,1],[179,78,179,122,1],[179,17,179,122,1],[181,17,181,115,1],[182,13,182,14,1],[183,9,183,10,1],[187,9,187,10,1],[189,13,189,67,1],[190,13,190,55,1],[192,20,192,90,1],[193,13,193,14,1],[195,17,195,63,1],[196,17,196,73,1],[199,17,199,60,1],[200,17,200,47,1],[201,17,201,37,1],[203,17,203,56,1],[206,17,206,61,1],[207,17,207,57,1],[209,17,209,100,1],[210,13,210,14,1],[211,9,211,10,1],[215,9,215,10,1],[217,13,217,67,1],[218,13,218,55,1],[220,20,220,90,1],[221,13,221,14,1],[223,17,223,63,1],[224,17,224,71,1],[227,17,227,46,1],[228,17,228,37,1],[230,17,230,73,1],[231,17,231,47,1],[232,17,232,37,1],[235,17,235,56,1],[236,17,236,57,1],[237,17,237,65,1],[238,17,238,67,1],[239,17,239,75,1],[240,17,240,76,1],[241,13,241,14,1],[242,9,242,10,1],[246,9,246,10,1],[248,13,248,67,1],[249,13,249,55,1],[251,20,251,90,1],[252,13,252,14,1],[254,17,254,63,1],[255,17,255,71,1],[258,17,258,46,1],[259,17,259,37,1],[261,17,261,73,1],[262,17,262,47,1],[263,17,263,37,1],[266,17,266,56,1],[267,17,267,57,1],[268,17,268,65,1],[269,17,269,67,1],[270,17,270,75,1],[271,17,271,76,1],[272,13,272,14,1],[273,9,273,10,1],[277,9,277,10,1],[279,13,279,67,1],[280,13,280,55,1],[282,20,282,90,1],[283,13,283,14,1],[286,17,286,68,1],[287,17,287,61,1],[290,17,290,46,1],[291,13,291,14,1],[292,9,292,10,1],[296,9,296,10,1],[298,13,298,67,1],[299,13,299,55,1],[301,20,301,90,1],[302,13,302,14,1],[305,17,305,70,1],[306,17,306,52,1],[307,17,307,49,1],[308,17,308,37,1],[310,17,310,77,1],[313,17,313,72,1],[314,17,314,76,1],[315,13,315,14,1],[316,9,316,10,1],[320,9,320,10,1],[322,13,322,67,1],[323,13,323,55,1],[325,20,325,90,1],[326,13,326,14,1],[329,17,329,68,1],[330,17,330,42,1],[331,17,331,37,1],[333,17,333,70,1],[334,17,334,72,1],[337,17,337,47,1],[338,17,338,47,1],[339,13,339,14,1],[340,9,340,10,1],[344,9,344,10,1],[346,13,346,67,1],[347,13,347,55,1],[349,20,349,90,1],[350,13,350,14,1],[353,17,353,68,1],[356,17,356,75,1],[357,17,357,82,1],[358,17,358,82,1],[359,17,359,64,1],[360,17,360,67,1],[361,17,361,61,1],[362,17,362,72,1],[363,17,363,68,1],[364,17,364,55,1],[365,17,365,62,1],[366,13,366,14,1],[367,9,367,10,1],[371,9,371,10,1],[373,13,373,67,1],[374,13,374,55,1],[376,20,376,90,1],[377,13,377,14,1],[379,17,379,76,1],[380,17,380,59,1],[383,17,383,73,1],[384,13,384,14,1],[385,9,385,10,1],[389,9,389,10,1],[391,13,391,88,1],[392,13,392,67,1],[393,13,393,55,1],[395,20,395,90,1],[396,13,396,14,1],[398,22,398,31,1],[398,33,398,39,1],[398,41,398,44,1],[399,17,399,18,1],[400,21,400,85,1],[401,21,401,52,1],[402,17,402,18,1],[403,17,403,37,1],[405,17,405,44,1],[406,17,406,95,1],[407,17,407,59,1],[410,17,410,74,1],[411,13,411,14,1],[412,9,412,10,1],[417,9,417,10,0],[419,13,419,88,0],[420,13,420,67,0],[421,13,421,55,0],[423,20,423,90,0],[424,13,424,14,0],[426,22,426,31,0],[426,33,426,39,0],[426,41,426,44,0],[427,17,427,18,0],[428,21,428,85,0],[429,21,429,52,0],[430,17,430,18,0],[431,17,431,37,0],[433,17,433,48,0],[434,17,434,99,0],[435,17,435,59,0],[438,17,438,74,0],[439,13,439,14,0],[440,9,440,10,0],[444,9,444,10,1],[446,13,446,67,1],[447,13,447,55,1],[449,20,449,90,1],[450,13,450,14,1],[452,17,452,76,1],[454,17,454,135,1],[457,17,457,71,1],[458,17,458,60,1],[459,17,459,76,1],[460,13,460,14,1],[461,9,461,10,1],[465,9,465,10,1],[467,13,467,67,1],[468,13,468,55,1],[470,20,470,90,1],[471,13,471,14,1],[473,17,473,76,1],[475,17,475,135,1],[478,17,478,71,1],[479,17,479,60,1],[480,17,480,75,1],[481,13,481,14,1],[482,9,482,10,1],[486,9,486,10,1],[488,13,488,67,1],[489,13,489,55,1],[491,20,491,90,1],[492,13,492,14,1],[494,17,494,76,1],[496,17,496,135,1],[499,17,499,71,1],[500,17,500,60,1],[501,17,501,76,1],[502,13,502,14,1],[503,9,503,10,1],[507,9,507,10,1],[509,13,509,67,1],[510,13,510,55,1],[512,20,512,90,1],[513,13,513,14,1],[515,17,515,76,1],[517,17,517,136,1],[520,17,520,71,1],[521,17,521,60,1],[522,17,522,75,1],[523,13,523,14,1],[524,9,524,10,1],[528,9,528,10,1],[530,13,530,67,1],[531,13,531,55,1],[533,20,533,90,1],[534,13,534,14,1],[536,17,536,76,1],[538,17,538,130,1],[541,17,541,71,1],[542,17,542,60,1],[543,17,543,75,1],[544,13,544,14,1],[545,9,545,10,1],[549,9,549,10,1],[551,13,551,67,1],[552,13,552,55,1],[554,20,554,90,1],[555,13,555,14,1],[557,17,557,76,1],[559,17,559,143,1],[562,17,562,58,1],[563,17,563,60,1],[564,17,564,75,1],[565,13,565,14,1],[566,9,566,10,1],[570,9,570,10,1],[572,13,572,67,1],[573,13,573,55,1],[575,20,575,90,1],[576,13,576,14,1],[578,17,578,76,1],[580,17,580,143,1],[583,17,583,58,1],[584,17,584,60,1],[585,17,585,76,1],[586,13,586,14,1],[587,9,587,10,1],[591,9,591,10,1],[593,13,593,67,1],[594,13,594,55,1],[596,20,596,90,1],[597,13,597,14,1],[600,17,600,96,1],[603,17,603,50,1],[604,17,604,52,1],[605,17,605,60,1],[606,13,606,14,1],[607,9,607,10,1],[611,9,611,10,1],[613,13,613,67,1],[614,13,614,55,1],[616,20,616,90,1],[617,13,617,14,1],[620,17,620,50,1],[623,17,623,50,1],[624,17,624,52,1],[625,17,625,73,1],[626,13,626,14,1],[627,9,627,10,1],[631,9,631,10,1],[633,13,633,67,1],[634,13,634,55,1],[636,20,636,90,1],[637,13,637,14,1],[640,17,640,72,1],[641,17,641,75,1],[642,17,642,78,1],[645,17,645,46,1],[646,17,646,49,1],[647,17,647,53,1],[648,13,648,14,1],[649,9,649,10,1],[653,9,653,10,1],[655,13,655,67,1],[656,13,656,55,1],[658,20,658,90,1],[659,13,659,14,1],[662,17,662,31,1],[663,17,663,80,1],[664,17,664,54,1],[667,17,667,65,1],[668,13,668,14,1],[669,9,669,10,1],[673,9,673,10,1],[674,13,674,29,1],[675,9,675,10,1],[678,9,678,10,1],[680,13,680,88,1],[681,13,681,77,1],[682,13,682,57,1],[685,13,685,87,1],[686,13,686,81,1],[687,13,687,56,1],[690,13,690,86,1],[691,13,691,78,1],[692,13,692,55,1],[693,9,693,10,1]]);
    </script>
  </body>
</html>