<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Strategies\DataTypes\LegacyUploadFieldWorkaround.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Drawing;
using System.Globalization;
using System.Linq;
using System.Xml;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using umbraco.interfaces;
using Umbraco.Core;

namespace Umbraco.Web.Strategies.DataTypes
{
	/// &lt;summary&gt;
	/// Before Save Content/Media subscriber that checks for Upload fields and updates related fields accordingly.
	/// &lt;/summary&gt;
	/// &lt;remarks&gt;
	/// This is an intermediate fix for the legacy DataTypeUploadField and the FileHandlerData, so that properties
	/// are saved correctly when using the Upload field on a (legacy) Document or Media class.
	/// &lt;/remarks&gt;
	public class LegacyUploadFieldWorkaround : ApplicationEventHandler
	{
        protected override void ApplicationStarted(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            global::umbraco.cms.businesslogic.media.Media.BeforeSave += MediaBeforeSave;
            global::umbraco.cms.businesslogic.web.Document.BeforeSave += DocumentBeforeSave;
        }
        
		void DocumentBeforeSave(global::umbraco.cms.businesslogic.web.Document sender, global::umbraco.cms.businesslogic.SaveEventArgs e)
		{
            if (UmbracoConfig.For.UmbracoSettings().Content.ImageAutoFillProperties.Any())
			{
				var property = sender.GenericProperties.FirstOrDefault(x =&gt;x.PropertyType.DataTypeDefinition.DataType!=null &amp;&amp; x.PropertyType.DataTypeDefinition.DataType.Id == new Guid(Constants.PropertyEditors.UploadField));
				if (property == null)
					return;


				FillProperties(sender, property);
			}
		}

		void MediaBeforeSave(global::umbraco.cms.businesslogic.media.Media sender, global::umbraco.cms.businesslogic.SaveEventArgs e)
		{
            if (UmbracoConfig.For.UmbracoSettings().Content.ImageAutoFillProperties.Any())
			{
				var property = sender.GenericProperties.FirstOrDefault(x =&gt; x.PropertyType.DataTypeDefinition.DataType.Id == new Guid(Constants.PropertyEditors.UploadField));
				if (property == null)
					return;


				FillProperties(sender, property);
			}
		}

        private void FillProperties(global::umbraco.cms.businesslogic.Content content, global::umbraco.cms.businesslogic.property.Property property)
		{			
            var uploadFieldConfigNode = UmbracoConfig.For.UmbracoSettings().Content.ImageAutoFillProperties
                                                            .FirstOrDefault(x =&gt; x.Alias == property.PropertyType.Alias);

			if (uploadFieldConfigNode != null)
			{
				var fileSystem = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();
                //Ensure that the Property has a Value before continuing
                if(property.Value == null)
                    return;

				var path = fileSystem.GetRelativePath(property.Value.ToString());

				if (string.IsNullOrWhiteSpace(path) == false &amp;&amp; fileSystem.FileExists(path))
				{
					long size;
					using (var fileStream = fileSystem.OpenFile(path))
					{
						size = fileStream.Length;
					}

					var extension = fileSystem.GetExtension(path) != null
						? fileSystem.GetExtension(path).Substring(1).ToLowerInvariant()
						: &quot;&quot;;

				    var isImageType = UmbracoConfig.For.UmbracoSettings().Content.ImageFileTypes.InvariantContains(extension);
                        
					var dimensions = isImageType ? GetDimensions(path, fileSystem) : null;

					
				    if (isImageType)
				    {
                        // only add dimensions to web images
				        content.getProperty(uploadFieldConfigNode.WidthFieldAlias).Value = dimensions.Item1.ToString(CultureInfo.InvariantCulture);
				        content.getProperty(uploadFieldConfigNode.HeightFieldAlias).Value = dimensions.Item2.ToString(CultureInfo.InvariantCulture);
				    }

				    content.getProperty(uploadFieldConfigNode.LengthFieldAlias).Value = size == default(long) ? string.Empty : size.ToString(CultureInfo.InvariantCulture);
                    content.getProperty(uploadFieldConfigNode.ExtensionFieldAlias).Value = string.IsNullOrEmpty(extension) ? string.Empty : extension;

				}
			}
		}
        
		private Tuple&lt;int, int&gt; GetDimensions(string path, IFileSystem fs)
		{

			int fileWidth;
			int fileHeight;
			using (var stream = fs.OpenFile(path))
			{
				using (var image = Image.FromStream(stream))
				{
					fileWidth = image.Width;
					fileHeight = image.Height;
				}
			}

			return new Tuple&lt;int, int&gt;(fileWidth, fileHeight);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,0],[24,13,24,89,0],[25,13,25,93,0],[26,9,26,10,0],[29,3,29,4,0],[30,13,30,91,0],[31,4,31,5,0],[32,5,32,64,0],[32,64,32,212,0],[32,212,32,214,0],[32,5,32,214,0],[33,5,33,26,0],[34,6,34,13,0],[37,5,37,38,0],[38,4,38,5,0],[39,3,39,4,0],[42,3,42,4,0],[43,13,43,91,0],[44,4,44,5,0],[45,5,45,65,0],[45,65,45,161,0],[45,161,45,163,0],[45,5,45,163,0],[46,5,46,26,0],[47,6,47,13,0],[50,5,50,38,0],[51,4,51,5,0],[52,3,52,4,0],[55,3,55,4,0],[56,13,57,82,0],[57,82,57,120,0],[57,120,57,122,0],[56,13,57,122,0],[59,4,59,38,0],[60,4,60,5,0],[61,5,61,97,0],[63,17,63,43,0],[64,21,64,28,0],[66,5,66,70,0],[68,5,68,81,0],[69,5,69,6,0],[71,13,71,55,0],[72,6,72,7,0],[73,7,73,32,0],[74,6,74,7,0],[76,6,78,12,0],[80,9,80,115,0],[82,6,82,76,0],[85,9,85,25,0],[86,9,86,10,0],[88,13,88,136,0],[89,13,89,137,0],[90,9,90,10,0],[92,9,92,160,0],[93,21,93,151,0],[95,5,95,6,0],[96,4,96,5,0],[97,3,97,4,0],[100,3,100,4,0],[104,11,104,41,0],[105,4,105,5,0],[106,12,106,48,0],[107,5,107,6,0],[108,6,108,30,0],[109,6,109,32,0],[110,5,110,6,0],[111,4,111,5,0],[113,4,113,54,0],[114,3,114,4,0]]);
    </script>
  </body>
</html>