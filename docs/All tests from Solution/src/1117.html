<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\InstallStatusTracker.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Newtonsoft.Json;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Web.Install.Models;

namespace Umbraco.Web.Install
{
    /// &lt;summary&gt;
    /// An internal in-memory status tracker for the current installation
    /// &lt;/summary&gt;
    internal static class InstallStatusTracker
    {

        private static ConcurrentHashSet&lt;InstallTrackingItem&gt; _steps = new ConcurrentHashSet&lt;InstallTrackingItem&gt;();

        private static string GetFile(Guid installId)
        {
            var file = IOHelper.MapPath(&quot;~/App_Data/TEMP/Install/&quot;
                                        + &quot;install_&quot;
                                        + installId.ToString(&quot;N&quot;)
                                        + &quot;.txt&quot;);
            return file;
        }

        public static void Reset()
        {
            _steps = new ConcurrentHashSet&lt;InstallTrackingItem&gt;();
            ClearFiles();
        }

        public static void ClearFiles()
        {   
            var dir = IOHelper.MapPath(&quot;~/App_Data/TEMP/Install/&quot;);
            if (Directory.Exists(dir))
            {
                var files = Directory.GetFiles(dir);
                foreach (var f in files)
                {
                    File.Delete(f);
                }
            }
            else
            {
                Directory.CreateDirectory(dir);
            }
        }

        public static IEnumerable&lt;InstallTrackingItem&gt; InitializeFromFile(Guid installId)
        {
            //check if we have our persisted file and read it
            var file = GetFile(installId);
            if (File.Exists(file))
            {
                var deserialized = JsonConvert.DeserializeObject&lt;IEnumerable&lt;InstallTrackingItem&gt;&gt;(
                    File.ReadAllText(file));
                foreach (var item in deserialized)
                {
                    _steps.Add(item);
                }
            }
            else
            {
                throw new InvalidOperationException(&quot;Cannot initialize from file, the installation file with id &quot; + installId + &quot; does not exist&quot;);
            }
            return new List&lt;InstallTrackingItem&gt;(_steps);
        }

        public static IEnumerable&lt;InstallTrackingItem&gt; Initialize(Guid installId, IEnumerable&lt;InstallSetupStep&gt; steps)
        {
            //if there are no steps in memory
            if (_steps.Count == 0)
            {
                //check if we have our persisted file and read it
                var file = GetFile(installId);
                if (File.Exists(file))
                {
                    var deserialized = JsonConvert.DeserializeObject&lt;IEnumerable&lt;InstallTrackingItem&gt;&gt;(
                        File.ReadAllText(file));
                    foreach (var item in deserialized)
                    {
                        _steps.Add(item);
                    }
                }
                else
                {
                    ClearFiles();

                    //otherwise just create the steps in memory (brand new install)
                    foreach (var step in steps.OrderBy(x =&gt; x.ServerOrder))
                    {
                        _steps.Add(new InstallTrackingItem(step.Name, step.ServerOrder));
                    }
                    //save the file
                    var serialized = JsonConvert.SerializeObject(new List&lt;InstallTrackingItem&gt;(_steps));
                    Directory.CreateDirectory(Path.GetDirectoryName(file));
                    File.WriteAllText(file, serialized);
                }
            }
            else
            {
                //ensure that the file exists with the current install id
                var file = GetFile(installId);
                if (File.Exists(file) == false)
                {
                    ClearFiles();

                    //save the correct file
                    var serialized = JsonConvert.SerializeObject(new List&lt;InstallTrackingItem&gt;(_steps));
                    Directory.CreateDirectory(Path.GetDirectoryName(file));
                    File.WriteAllText(file, serialized);
                }
            }

            return new List&lt;InstallTrackingItem&gt;(_steps);
        }

        public static void SetComplete(Guid installId, string name, IDictionary&lt;string, object&gt; additionalData = null)
        {
            var trackingItem = _steps.Single(x =&gt; x.Name == name);
            if (additionalData != null)
            {
                trackingItem.AdditionalData = additionalData;
            }
            trackingItem.IsComplete = true;
            
            //save the file
            var file = GetFile(installId);
            var serialized = JsonConvert.SerializeObject(new List&lt;InstallTrackingItem&gt;(_steps));
            File.WriteAllText(file, serialized);
        }

        public static IEnumerable&lt;InstallTrackingItem&gt; GetStatus()
        {
            return new List&lt;InstallTrackingItem&gt;(_steps).OrderBy(x =&gt; x.ServerOrder);
        } 
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,117,0],[25,9,25,10,0],[26,13,29,51,0],[30,13,30,25,0],[31,9,31,10,0],[34,9,34,10,0],[35,13,35,67,0],[36,13,36,26,0],[37,9,37,10,0],[40,9,40,10,0],[41,13,41,68,0],[42,13,42,39,0],[43,13,43,14,0],[44,17,44,53,0],[45,17,45,24,0],[45,26,45,31,0],[45,32,45,34,0],[45,35,45,40,0],[46,17,46,18,0],[47,21,47,36,0],[48,17,48,18,0],[49,13,49,14,0],[51,13,51,14,0],[52,17,52,48,0],[53,13,53,14,0],[54,9,54,10,0],[57,9,57,10,0],[59,13,59,43,0],[60,13,60,35,0],[61,13,61,14,0],[62,17,63,45,0],[64,17,64,24,0],[64,26,64,34,0],[64,35,64,37,0],[64,38,64,50,0],[65,17,65,18,0],[66,21,66,38,0],[67,17,67,18,0],[68,13,68,14,0],[70,13,70,14,0],[71,17,71,148,0],[73,13,73,58,0],[74,9,74,10,0],[77,9,77,10,0],[79,13,79,35,0],[80,13,80,14,0],[82,17,82,47,0],[83,17,83,39,0],[84,17,84,18,0],[85,21,86,49,0],[87,21,87,28,0],[87,30,87,38,0],[87,39,87,41,0],[87,42,87,54,0],[88,21,88,22,0],[89,25,89,42,0],[90,21,90,22,0],[91,17,91,18,0],[93,17,93,18,0],[94,21,94,34,0],[97,21,97,28,0],[97,30,97,38,0],[97,39,97,41,0],[97,42,97,61,0],[97,61,97,74,0],[97,74,97,75,0],[97,42,97,75,0],[98,21,98,22,0],[99,25,99,90,0],[100,21,100,22,0],[102,21,102,105,0],[103,21,103,76,0],[104,21,104,57,0],[105,17,105,18,0],[106,13,106,14,0],[108,13,108,14,0],[110,17,110,47,0],[111,17,111,48,0],[112,17,112,18,0],[113,21,113,34,0],[116,21,116,105,0],[117,21,117,76,0],[118,21,118,57,0],[119,17,119,18,0],[120,13,120,14,0],[122,13,122,58,0],[123,9,123,10,0],[126,9,126,10,0],[127,13,127,51,0],[127,51,127,65,0],[127,65,127,67,0],[127,13,127,67,0],[128,13,128,40,0],[129,13,129,14,0],[130,17,130,62,0],[131,13,131,14,0],[132,13,132,44,0],[135,13,135,43,0],[136,13,136,97,0],[137,13,137,49,0],[138,9,138,10,0],[141,9,141,10,0],[142,13,142,71,0],[142,71,142,84,0],[142,84,142,86,0],[142,13,142,86,0],[143,9,143,10,0]]);
    </script>
  </body>
</html>