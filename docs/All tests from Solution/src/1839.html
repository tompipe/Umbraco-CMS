<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSevenTwoZero\AddMissingForeignKeyForContentType.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Data;
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSevenTwoZero
{
    [Migration(&quot;7.2.0&quot;, 1, GlobalSettings.UmbracoMigrationName)]
    public class AddMissingForeignKeyForContentType : MigrationBase
    {
        public AddMissingForeignKeyForContentType(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {

            var constraints = SqlSyntax.GetConstraintsPerColumn(Context.Database).Distinct().ToArray();

            //if the FK doesn&#39;t exist
            if (constraints.Any(x =&gt; x.Item1.InvariantEquals(&quot;cmsContent&quot;) &amp;&amp; x.Item2.InvariantEquals(&quot;contentType&quot;) &amp;&amp; x.Item3.InvariantEquals(&quot;FK_cmsContent_cmsContentType_nodeId&quot;)) == false)
            {
                //Before we can add the foreign key there cannot be any orphaned content, media, members
                var orphanedIds = Context.Database.Fetch&lt;int&gt;(&quot;SELECT contentType FROM cmsContent WHERE NOT EXISTS (SELECT cmsContentType.nodeId FROM cmsContentType WHERE cmsContentType.nodeId = cmsContent.contentType)&quot;);
                foreach (var orphanedId in orphanedIds)
                {
                    Delete.FromTable(&quot;cmsTask&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;umbracoUser2NodeNotify&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;umbracoUser2NodePermission&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;umbracoRelation&quot;).Row(new { parentId = orphanedId });
                    Delete.FromTable(&quot;umbracoRelation&quot;).Row(new { childId = orphanedId });
                    Delete.FromTable(&quot;cmsTagRelationship&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;umbracoDomains&quot;).Row(new { domainRootStructureID = orphanedId });
                    Delete.FromTable(&quot;cmsDocument&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;cmsPropertyData&quot;).Row(new { contentNodeId = orphanedId });
                    Delete.FromTable(&quot;cmsMember2MemberGroup&quot;).Row(new { Member = orphanedId });
                    Delete.FromTable(&quot;cmsMember&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;cmsPreviewXml&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;cmsContentVersion&quot;).Row(new { ContentId = orphanedId });
                    Delete.FromTable(&quot;cmsContentXml&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;cmsContent&quot;).Row(new { nodeId = orphanedId });
                    Delete.FromTable(&quot;umbracoNode&quot;).Row(new { id = orphanedId });
                }

                //Some very old schemas don&#39;t have an index on the cmsContentType.nodeId column, I&#39;m not actually sure when it was added but 
                // it is absolutely required to exist in order to add other foreign keys and much better for perf, so we&#39;ll need to check it&#39;s existence
                // this came to light from this issue: http://issues.umbraco.org/issue/U4-4133
                var dbIndexes = SqlSyntaxContext.SqlSyntaxProvider.GetDefinedIndexes(Context.Database)
                    .Select(x =&gt; new DbIndexDefinition()
                    {
                        TableName = x.Item1,
                        IndexName = x.Item2,
                        ColumnName = x.Item3,
                        IsUnique = x.Item4
                    }).ToArray();
                if (dbIndexes.Any(x =&gt; x.IndexName.InvariantEquals(&quot;IX_cmsContentType&quot;)) == false)
                {
                    Create.Index(&quot;IX_cmsContentType&quot;).OnTable(&quot;cmsContentType&quot;).OnColumn(&quot;nodeId&quot;).Ascending().WithOptions().Unique();
                }
                if (dbIndexes.Any(x =&gt; x.TableName.InvariantEquals(&quot;cmsContentType&quot;) &amp;&amp; x.ColumnName.InvariantEquals(&quot;icon&quot;)) == false)
                {
                    Create.Index(&quot;IX_cmsContentType_icon&quot;).OnTable(&quot;cmsContentType&quot;).OnColumn(&quot;icon&quot;).Ascending().WithOptions().NonClustered();
                }

                Create.ForeignKey(&quot;FK_cmsContent_cmsContentType_nodeId&quot;)
                    .FromTable(&quot;cmsContent&quot;)
                    .ForeignColumn(&quot;contentType&quot;)
                    .ToTable(&quot;cmsContentType&quot;)
                    .PrimaryColumn(&quot;nodeId&quot;)
                    .OnDelete(Rule.None)
                    .OnUpdate(Rule.None);
            }

            
        }

        public override void Down()
        {
            throw new DataLossException(&quot;Cannot downgrade from a version 7.2 database to a prior version, the database schema has already been modified&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,99,14,122,0],[15,9,15,10,0],[16,9,16,10,0],[19,9,19,10,0],[21,13,21,104,0],[24,13,24,38,0],[24,38,24,183,0],[24,183,24,194,0],[24,13,24,194,0],[25,13,25,14,0],[27,17,27,222,0],[28,17,28,24,0],[28,26,28,40,0],[28,41,28,43,0],[28,44,28,55,0],[29,17,29,18,0],[30,21,30,82,0],[31,21,31,97,0],[32,21,32,101,0],[33,21,33,92,0],[34,21,34,91,0],[35,21,35,93,0],[36,21,36,104,0],[37,21,37,86,0],[38,21,38,97,0],[39,21,39,96,0],[40,21,40,84,0],[41,21,41,88,0],[42,21,42,95,0],[43,21,43,88,0],[44,21,44,85,0],[45,21,45,82,0],[46,17,46,18,0],[51,17,52,34,0],[52,34,58,22,0],[58,22,58,34,0],[51,17,58,34,0],[59,17,59,40,0],[59,40,59,88,0],[59,88,59,99,0],[59,17,59,99,0],[60,17,60,18,0],[61,21,61,135,0],[62,17,62,18,0],[63,17,63,40,0],[63,40,63,125,0],[63,125,63,136,0],[63,17,63,136,0],[64,17,64,18,0],[65,21,65,144,0],[66,17,66,18,0],[68,17,74,42,0],[75,13,75,14,0],[78,9,78,10,0],[81,9,81,10,0],[82,13,82,155,0]]);
    </script>
  </body>
</html>