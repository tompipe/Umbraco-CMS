<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\EntityRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Factories;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence.Repositories
{
    /// &lt;summary&gt;
    /// Represents the EntityRepository used to query &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// This is limited to objects that are based in the umbracoNode-table.
    /// &lt;/remarks&gt;
    internal class EntityRepository : DisposableObject, IEntityRepository
    {
        private readonly IDatabaseUnitOfWork _work;

        public EntityRepository(IDatabaseUnitOfWork work)
		{
		    _work = work;
		}

        /// &lt;summary&gt;
        /// Returns the Unit of Work added to the repository
        /// &lt;/summary&gt;
        protected internal IDatabaseUnitOfWork UnitOfWork
        {
            get { return _work; }
        }

        /// &lt;summary&gt;
        /// Internal for testing purposes
        /// &lt;/summary&gt;
        internal Guid UnitKey
        {
            get { return (Guid)_work.Key; }
        }

        #region Query Methods

        public IUmbracoEntity GetByKey(Guid key)
        {
            var sql = GetBaseWhere(GetBase, false, false, key);
            var nodeDto = _work.Database.FirstOrDefault&lt;dynamic&gt;(sql);
            if (nodeDto == null)
                return null;

            var factory = new UmbracoEntityFactory();
            var entity = factory.BuildEntityFromDynamic(nodeDto);

            return entity;
        }

        public IUmbracoEntity GetByKey(Guid key, Guid objectTypeId)
        {
            bool isContent = objectTypeId == new Guid(Constants.ObjectTypes.Document);
            bool isMedia = objectTypeId == new Guid(Constants.ObjectTypes.Media);

            var sql = GetFullSqlForEntityType(key, isContent, isMedia, objectTypeId);

            var factory = new UmbracoEntityFactory();

            if (isMedia)
            {
                //for now treat media differently and include all property data too  
                var entities = _work.Database.Fetch&lt;dynamic, UmbracoPropertyDto, UmbracoEntity&gt;(
                    new UmbracoEntityRelator().Map, sql);

                return entities.FirstOrDefault();
            }
            else
            {

                //query = read forward data reader, do not load everything into mem
                var dtos = _work.Database.Query&lt;dynamic&gt;(sql);
                var collection = new EntityDefinitionCollection();
                foreach (var dto in dtos)
                {
                    collection.AddOrUpdate(new EntityDefinition(factory, dto, isContent, false));
                }
                var found = collection.FirstOrDefault();
                return found != null ? found.BuildFromDynamic() : null;                
            }
            
            
        }

        public virtual IUmbracoEntity Get(int id)
        {
            var sql = GetBaseWhere(GetBase, false, false, id);
            var nodeDto = _work.Database.FirstOrDefault&lt;dynamic&gt;(sql);
            if (nodeDto == null)
                return null;

            var factory = new UmbracoEntityFactory();
            var entity = factory.BuildEntityFromDynamic(nodeDto);

            return entity;
        }

        public virtual IUmbracoEntity Get(int id, Guid objectTypeId)
        {
            bool isContent = objectTypeId == new Guid(Constants.ObjectTypes.Document);
            bool isMedia = objectTypeId == new Guid(Constants.ObjectTypes.Media);

            var sql = GetFullSqlForEntityType(id, isContent, isMedia, objectTypeId);

            var factory = new UmbracoEntityFactory();

            if (isMedia)
            {
                //for now treat media differently and include all property data too  
                var entities = _work.Database.Fetch&lt;dynamic, UmbracoPropertyDto, UmbracoEntity&gt;(
                    new UmbracoEntityRelator().Map, sql);

                return entities.FirstOrDefault();
            }
            else
            {                
                //query = read forward data reader, do not load everything into mem
                var dtos = _work.Database.Query&lt;dynamic&gt;(sql);
                var collection = new EntityDefinitionCollection();
                foreach (var dto in dtos)
                {
                    collection.AddOrUpdate(new EntityDefinition(factory, dto, isContent, false));
                }
                var found = collection.FirstOrDefault();
                return found != null ? found.BuildFromDynamic() : null;
            }
        }

        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetAll(Guid objectTypeId, params int[] ids)
        {
            if (ids.Any())
            {
                return PerformGetAll(objectTypeId, sql1 =&gt; sql1.Where(&quot; umbracoNode.id in (@ids)&quot;, new {ids = ids}));
            }
            else
            {
                return PerformGetAll(objectTypeId);
            }
        }

        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetAll(Guid objectTypeId, params Guid[] keys)
        {
            if (keys.Any())
            {
                return PerformGetAll(objectTypeId, sql1 =&gt; sql1.Where(&quot; umbracoNode.uniqueID in (@keys)&quot;, new { keys = keys }));
            }
            else
            {
                return PerformGetAll(objectTypeId);
            }
        }

        private IEnumerable&lt;IUmbracoEntity&gt; PerformGetAll(Guid objectTypeId, Action&lt;Sql&gt; filter = null)
        {
            bool isContent = objectTypeId == new Guid(Constants.ObjectTypes.Document);
            bool isMedia = objectTypeId == new Guid(Constants.ObjectTypes.Media);
            var sql = GetFullSqlForEntityType(isContent, isMedia, objectTypeId, filter);

            var factory = new UmbracoEntityFactory();

            if (isMedia)
            {
                //for now treat media differently and include all property data too                
                var entities = _work.Database.Fetch&lt;dynamic, UmbracoPropertyDto, UmbracoEntity&gt;(
                    new UmbracoEntityRelator().Map, sql);
                return entities;
            }
            else
            {
                //query = read forward data reader, do not load everything into mem
                var dtos = _work.Database.Query&lt;dynamic&gt;(sql);
                var collection = new EntityDefinitionCollection();
                foreach (var dto in dtos)
                {
                    collection.AddOrUpdate(new EntityDefinition(factory, dto, isContent, false));
                }
                return collection.Select(x =&gt; x.BuildFromDynamic()).ToList();                
            }
        }


        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetByQuery(IQuery&lt;IUmbracoEntity&gt; query)
        {
            var sqlClause = GetBase(false, false, null);
            var translator = new SqlTranslator&lt;IUmbracoEntity&gt;(sqlClause, query);
            var sql = translator.Translate().Append(GetGroupBy(false, false));

            var dtos = _work.Database.Fetch&lt;dynamic&gt;(sql);

            var factory = new UmbracoEntityFactory();
            var list = dtos.Select(factory.BuildEntityFromDynamic).Cast&lt;IUmbracoEntity&gt;().ToList();

            return list;
        }

        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetByQuery(IQuery&lt;IUmbracoEntity&gt; query, Guid objectTypeId)
        {

            bool isContent = objectTypeId == new Guid(Constants.ObjectTypes.Document);
            bool isMedia = objectTypeId == new Guid(Constants.ObjectTypes.Media);

            var sqlClause = GetBaseWhere(GetBase, isContent, isMedia, null, objectTypeId);
            
            var translator = new SqlTranslator&lt;IUmbracoEntity&gt;(sqlClause, query);
            var entitySql = translator.Translate();

            var factory = new UmbracoEntityFactory();

            if (isMedia)
            {
                var wheres = query.GetWhereClauses().ToArray();

                var mediaSql = GetFullSqlForMedia(entitySql.Append(GetGroupBy(isContent, true, false)), sql =&gt;
                {
                    //adds the additional filters
                    foreach (var whereClause in wheres)
                    {
                        sql.Where(whereClause.Item1, whereClause.Item2);
                    }
                });

                //for now treat media differently and include all property data too    
                var entities = _work.Database.Fetch&lt;dynamic, UmbracoPropertyDto, UmbracoEntity&gt;(
                    new UmbracoEntityRelator().Map, mediaSql);
                return entities;
            }
            else
            {
                //use dynamic so that we can get ALL properties from the SQL so we can chuck that data into our AdditionalData
                var finalSql = entitySql.Append(GetGroupBy(isContent, false));

                //query = read forward data reader, do not load everything into mem
                var dtos = _work.Database.Query&lt;dynamic&gt;(finalSql);
                var collection = new EntityDefinitionCollection();
                foreach (var dto in dtos)
                {
                    collection.AddOrUpdate(new EntityDefinition(factory, dto, isContent, false));
                }
                return collection.Select(x =&gt; x.BuildFromDynamic()).ToList();
            }
        }

        #endregion
        

        #region Sql Statements

        protected Sql GetFullSqlForEntityType(Guid key, bool isContent, bool isMedia, Guid objectTypeId)
        {
            var entitySql = GetBaseWhere(GetBase, isContent, isMedia, objectTypeId, key);

            if (isMedia == false) return entitySql.Append(GetGroupBy(isContent, false));

            return GetFullSqlForMedia(entitySql.Append(GetGroupBy(isContent, true, false)));
        }

        protected Sql GetFullSqlForEntityType(int id, bool isContent, bool isMedia, Guid objectTypeId)
        {
            var entitySql = GetBaseWhere(GetBase, isContent, isMedia, objectTypeId, id);

            if (isMedia == false) return entitySql.Append(GetGroupBy(isContent, false));

            return GetFullSqlForMedia(entitySql.Append(GetGroupBy(isContent, true, false)));
        }

        protected Sql GetFullSqlForEntityType(bool isContent, bool isMedia, Guid objectTypeId, Action&lt;Sql&gt; filter)
        {
            var entitySql = GetBaseWhere(GetBase, isContent, isMedia, filter, objectTypeId);

            if (isMedia == false) return entitySql.Append(GetGroupBy(isContent, false));

            return GetFullSqlForMedia(entitySql.Append(GetGroupBy(isContent, true, false)), filter);
        }

        private Sql GetFullSqlForMedia(Sql entitySql, Action&lt;Sql&gt; filter = null)
        {
            //this will add any dataNvarchar property to the output which can be added to the additional properties

            var joinSql = new Sql()
                .Select(&quot;contentNodeId, versionId, dataNvarchar, dataNtext, propertyEditorAlias, alias as propertyTypeAlias&quot;)
                .From&lt;PropertyDataDto&gt;()
                .InnerJoin&lt;NodeDto&gt;()
                .On&lt;PropertyDataDto, NodeDto&gt;(dto =&gt; dto.NodeId, dto =&gt; dto.NodeId)
                .InnerJoin&lt;PropertyTypeDto&gt;()
                .On&lt;PropertyTypeDto, PropertyDataDto&gt;(dto =&gt; dto.Id, dto =&gt; dto.PropertyTypeId)
                .InnerJoin&lt;DataTypeDto&gt;()
                .On&lt;PropertyTypeDto, DataTypeDto&gt;(dto =&gt; dto.DataTypeId, dto =&gt; dto.DataTypeId)
                .Where(&quot;umbracoNode.nodeObjectType = @nodeObjectType&quot;, new {nodeObjectType = Constants.ObjectTypes.Media});

            if (filter != null)
            {
                filter(joinSql);
            }

            //We&#39;re going to create a query to query against the entity SQL 
            // because we cannot group by nText columns and we have a COUNT in the entitySql we cannot simply left join
            // the entitySql query, we have to join the wrapped query to get the ntext in the result
            
            var wrappedSql = new Sql(&quot;SELECT * FROM (&quot;)
                .Append(entitySql)
                .Append(new Sql(&quot;) tmpTbl LEFT JOIN (&quot;))
                .Append(joinSql)
                .Append(new Sql(&quot;) as property ON id = property.contentNodeId&quot;))
                .OrderBy(&quot;sortOrder, id&quot;);

            return wrappedSql;
        }

        protected virtual Sql GetBase(bool isContent, bool isMedia, Action&lt;Sql&gt; customFilter)
        {
            var columns = new List&lt;object&gt;
            {
                &quot;umbracoNode.id&quot;,
                &quot;umbracoNode.trashed&quot;,
                &quot;umbracoNode.parentID&quot;,
                &quot;umbracoNode.nodeUser&quot;,
                &quot;umbracoNode.level&quot;,
                &quot;umbracoNode.path&quot;,
                &quot;umbracoNode.sortOrder&quot;,
                &quot;umbracoNode.uniqueID&quot;,
                &quot;umbracoNode.text&quot;,
                &quot;umbracoNode.nodeObjectType&quot;,
                &quot;umbracoNode.createDate&quot;,
                &quot;COUNT(parent.parentID) as children&quot;
            };

            if (isContent || isMedia)
            {
                if (isContent)
                {
                    //only content has/needs this info
                    columns.Add(&quot;published.versionId as publishedVersion&quot;);
                    columns.Add(&quot;document.versionId as newestVersion&quot;);
                    columns.Add(&quot;contentversion.id as versionId&quot;);
                }
                
                columns.Add(&quot;contenttype.alias&quot;);
                columns.Add(&quot;contenttype.icon&quot;);
                columns.Add(&quot;contenttype.thumbnail&quot;);
                columns.Add(&quot;contenttype.isContainer&quot;);
            }

            //Creates an SQL query to return a single row for the entity

            var entitySql = new Sql()
                .Select(columns.ToArray())
                .From(&quot;umbracoNode umbracoNode&quot;);

            if (isContent || isMedia)
            {
                entitySql.InnerJoin(&quot;cmsContent content&quot;).On(&quot;content.nodeId = umbracoNode.id&quot;);

                if (isContent)
                {
                    //only content has/needs this info
                    entitySql                        
                        .InnerJoin(&quot;cmsDocument document&quot;).On(&quot;document.nodeId = umbracoNode.id&quot;)
                        .InnerJoin(&quot;cmsContentVersion contentversion&quot;).On(&quot;contentversion.VersionId = document.versionId&quot;)
                        .LeftJoin(&quot;(SELECT nodeId, versionId FROM cmsDocument WHERE published = 1) as published&quot;)
                        .On(&quot;umbracoNode.id = published.nodeId&quot;);
                }

                entitySql.LeftJoin(&quot;cmsContentType contenttype&quot;).On(&quot;contenttype.nodeId = content.contentType&quot;);
            }

            entitySql.LeftJoin(&quot;umbracoNode parent&quot;).On(&quot;parent.parentID = umbracoNode.id&quot;);

            if (customFilter != null)
            {
                customFilter(entitySql);
            }

            return entitySql;
        }

        protected virtual Sql GetBaseWhere(Func&lt;bool, bool, Action&lt;Sql&gt;, Sql&gt; baseQuery, bool isContent, bool isMedia, Action&lt;Sql&gt; filter, Guid nodeObjectType)
        {
            var sql = baseQuery(isContent, isMedia, filter)
                .Where(&quot;umbracoNode.nodeObjectType = @NodeObjectType&quot;, new { NodeObjectType = nodeObjectType });

            if (isContent)
            {
                sql.Where(&quot;document.newest = 1&quot;);
            }

            return sql;
        }

        protected virtual Sql GetBaseWhere(Func&lt;bool, bool, Action&lt;Sql&gt;, Sql&gt; baseQuery, bool isContent, bool isMedia, int id)
        {
            var sql = baseQuery(isContent, isMedia, null)
                .Where(&quot;umbracoNode.id = @Id&quot;, new { Id = id });

            if (isContent)
            {
                sql.Where(&quot;document.newest = 1&quot;);
            }

            sql.Append(GetGroupBy(isContent, isMedia));

            return sql;
        }

        protected virtual Sql GetBaseWhere(Func&lt;bool, bool, Action&lt;Sql&gt;, Sql&gt; baseQuery, bool isContent, bool isMedia, Guid key)
        {
            var sql = baseQuery(isContent, isMedia, null)
                .Where(&quot;umbracoNode.uniqueID = @UniqueID&quot;, new {UniqueID = key});

            if (isContent)
            {
                sql.Where(&quot;document.newest = 1&quot;);
            }

            sql.Append(GetGroupBy(isContent, isMedia));

            return sql;
        }

        protected virtual Sql GetBaseWhere(Func&lt;bool, bool, Action&lt;Sql&gt;, Sql&gt; baseQuery, bool isContent, bool isMedia, Guid nodeObjectType, int id)
        {
            var sql = baseQuery(isContent, isMedia, null)
                .Where(&quot;umbracoNode.id = @Id AND umbracoNode.nodeObjectType = @NodeObjectType&quot;,
                       new {Id = id, NodeObjectType = nodeObjectType});

            if (isContent)
            {
                sql.Where(&quot;document.newest = 1&quot;);
            }

            return sql;
        }

        protected virtual Sql GetBaseWhere(Func&lt;bool, bool, Action&lt;Sql&gt;, Sql&gt; baseQuery, bool isContent, bool isMedia, Guid nodeObjectType, Guid key)
        {
            var sql = baseQuery(isContent, isMedia, null)
                .Where(&quot;umbracoNode.uniqueID = @UniqueID AND umbracoNode.nodeObjectType = @NodeObjectType&quot;,
                       new { UniqueID = key, NodeObjectType = nodeObjectType });

            if (isContent)
            {
                sql.Where(&quot;document.newest = 1&quot;);
            }

            return sql;
        }

        protected virtual Sql GetGroupBy(bool isContent, bool isMedia, bool includeSort = true)
        {
            var columns = new List&lt;object&gt;
            {
                &quot;umbracoNode.id&quot;,
                &quot;umbracoNode.trashed&quot;,
                &quot;umbracoNode.parentID&quot;,
                &quot;umbracoNode.nodeUser&quot;,
                &quot;umbracoNode.level&quot;,
                &quot;umbracoNode.path&quot;,
                &quot;umbracoNode.sortOrder&quot;,
                &quot;umbracoNode.uniqueID&quot;,
                &quot;umbracoNode.text&quot;,
                &quot;umbracoNode.nodeObjectType&quot;,
                &quot;umbracoNode.createDate&quot;
            };

            if (isContent || isMedia)
            {
                if (isContent)
                {
                    columns.Add(&quot;published.versionId&quot;);
                    columns.Add(&quot;document.versionId&quot;);
                    columns.Add(&quot;contentversion.id&quot;);
                }
                columns.Add(&quot;contenttype.alias&quot;);
                columns.Add(&quot;contenttype.icon&quot;);
                columns.Add(&quot;contenttype.thumbnail&quot;);
                columns.Add(&quot;contenttype.isContainer&quot;);                
            }

            var sql = new Sql()
                .GroupBy(columns.ToArray());

            if (includeSort)
            {
                sql = sql.OrderBy(&quot;umbracoNode.sortOrder&quot;);
            }

            return sql;
        }

        #endregion

        /// &lt;summary&gt;
        /// Dispose disposable properties
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Ensure the unit of work is disposed
        /// &lt;/remarks&gt;
        protected override void DisposeResources()
        {
            UnitOfWork.DisposeIfDisposable();
        }

        #region private classes
        
        [ExplicitColumns]
        internal class UmbracoPropertyDto
        {
            [Column(&quot;propertyEditorAlias&quot;)]
            public string PropertyEditorAlias { get; set; }

            [Column(&quot;propertyTypeAlias&quot;)]
            public string PropertyAlias { get; set; }

            [Column(&quot;dataNvarchar&quot;)]
            public string NVarcharValue { get; set; }

            [Column(&quot;dataNtext&quot;)]
            public string NTextValue { get; set; }
        }

        /// &lt;summary&gt;
        /// This is a special relator in that it is not returning a DTO but a real resolved entity and that it accepts
        /// a dynamic instance.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// We&#39;re doing this because when we query the db, we want to use dynamic so that it returns all available fields not just the ones
        ///     defined on the entity so we can them to additional data
        /// &lt;/remarks&gt;
        internal class UmbracoEntityRelator
        {
            internal UmbracoEntity Current;
            private readonly UmbracoEntityFactory _factory = new UmbracoEntityFactory();

            internal UmbracoEntity Map(dynamic a, UmbracoPropertyDto p)
            {
                // Terminating call.  Since we can return null from this function
                // we need to be ready for PetaPoco to callback later with null
                // parameters
                if (a == null)
                    return Current;

                // Is this the same UmbracoEntity as the current one we&#39;re processing
                if (Current != null &amp;&amp; Current.Key == a.uniqueID)
                {
                    if (p != null &amp;&amp; p.PropertyAlias.IsNullOrWhiteSpace() == false)
                    {
                        // Add this UmbracoProperty to the current additional data
                        Current.AdditionalData[p.PropertyAlias] = new UmbracoEntity.EntityProperty
                        {
                            PropertyEditorAlias = p.PropertyEditorAlias,
                            Value = p.NTextValue.IsNullOrWhiteSpace()
                                ? p.NVarcharValue
                                : p.NTextValue.ConvertToJsonIfPossible()
                        };    
                    }

                    // Return null to indicate we&#39;re not done with this UmbracoEntity yet
                    return null;
                }

                // This is a different UmbracoEntity to the current one, or this is the 
                // first time through and we don&#39;t have a Tab yet

                // Save the current UmbracoEntityDto
                var prev = Current;

                // Setup the new current UmbracoEntity
                
                Current = _factory.BuildEntityFromDynamic(a);

                if (p != null &amp;&amp; p.PropertyAlias.IsNullOrWhiteSpace() == false)
                {
                    //add the property/create the prop list if null
                    Current.AdditionalData[p.PropertyAlias] = new UmbracoEntity.EntityProperty
                    {
                        PropertyEditorAlias = p.PropertyEditorAlias,
                        Value = p.NTextValue.IsNullOrWhiteSpace()
                            ? p.NVarcharValue
                            : p.NTextValue.ConvertToJsonIfPossible()
                    };
                }

                // Return the now populated previous UmbracoEntity (or null if first time through)
                return prev;
            }
        }

        private class EntityDefinitionCollection : KeyedCollection&lt;int, EntityDefinition&gt;
        {
            protected override int GetKeyForItem(EntityDefinition item)
            {
                return item.Id;
            }

            /// &lt;summary&gt;
            /// if this key already exists if it does then we need to check
            /// if the existing item is &#39;older&#39; than the new item and if that is the case we&#39;ll replace the older one
            /// &lt;/summary&gt;
            /// &lt;param name=&quot;item&quot;&gt;&lt;/param&gt;
            /// &lt;returns&gt;&lt;/returns&gt;
            public bool AddOrUpdate(EntityDefinition item)
            {
                if (Dictionary == null)
                {
                    base.Add(item);
                    return true;
                }

                var key = GetKeyForItem(item);
                EntityDefinition found;
                if (TryGetValue(key, out found))
                {
                    //it already exists and it&#39;s older so we need to replace it
                    if (item.VersionId &gt; found.VersionId)
                    {
                        var currIndex = Items.IndexOf(found);
                        if (currIndex == -1)
                            throw new IndexOutOfRangeException(&quot;Could not find the item in the list: &quot; + found.Id);

                        //replace the current one with the newer one
                        SetItem(currIndex, item);
                        return true;
                    }
                    //could not add or update
                    return false;
                }

                base.Add(item);
                return true;
            }

            private bool TryGetValue(int key, out EntityDefinition val)
            {
                if (Dictionary == null)
                {
                    val = null;
                    return false;
                }
                return Dictionary.TryGetValue(key, out val);
            }
        }

        private class EntityDefinition
        {
            private readonly UmbracoEntityFactory _factory;
            private readonly dynamic _entity;
            private readonly bool _isContent;
            private readonly bool _isMedia;

            public EntityDefinition(UmbracoEntityFactory factory, dynamic entity, bool isContent, bool isMedia)
            {
                _factory = factory;
                _entity = entity;
                _isContent = isContent;
                _isMedia = isMedia;
            }

            public IUmbracoEntity BuildFromDynamic()
            {
                return _factory.BuildEntityFromDynamic(_entity);
            }

            public int Id
            {
                get { return _entity.id; }
            }

            public int VersionId
            {
                get
                {
                    if (_isContent || _isMedia)
                    {
                        return _entity.versionId;
                    }
                    return _entity.id;
                }
            }
        }
        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,58,1],[25,3,25,4,1],[26,7,26,20,1],[27,3,27,4,1],[34,17,34,18,1],[34,19,34,32,1],[34,33,34,34,1],[42,17,42,18,0],[42,19,42,42,0],[42,43,42,44,0],[48,9,48,10,1],[49,13,49,64,1],[50,13,50,71,1],[51,13,51,33,1],[52,17,52,29,0],[54,13,54,54,1],[55,13,55,66,1],[57,13,57,27,1],[58,9,58,10,1],[61,9,61,10,1],[62,13,62,87,1],[63,13,63,82,1],[65,13,65,86,1],[67,13,67,54,1],[69,13,69,25,1],[70,13,70,14,0],[72,17,73,58,0],[75,17,75,50,0],[78,13,78,14,1],[81,17,81,63,1],[82,17,82,67,1],[83,17,83,24,1],[83,26,83,33,1],[83,34,83,36,1],[83,37,83,41,1],[84,17,84,18,1],[85,21,85,98,1],[86,17,86,18,1],[87,17,87,57,1],[88,17,88,72,1],[92,9,92,10,1],[95,9,95,10,1],[96,13,96,63,1],[97,13,97,71,1],[98,13,98,33,1],[99,17,99,29,0],[101,13,101,54,1],[102,13,102,66,1],[104,13,104,27,1],[105,9,105,10,1],[108,9,108,10,1],[109,13,109,87,1],[110,13,110,82,1],[112,13,112,85,1],[114,13,114,54,1],[116,13,116,25,1],[117,13,117,14,0],[119,17,120,58,0],[122,17,122,50,0],[125,13,125,14,1],[127,17,127,63,1],[128,17,128,67,1],[129,17,129,24,1],[129,26,129,33,1],[129,34,129,36,1],[129,37,129,41,1],[130,17,130,18,1],[131,21,131,98,1],[132,17,132,18,1],[133,17,133,57,1],[134,17,134,72,1],[136,9,136,10,1],[139,9,139,10,1],[140,13,140,27,1],[141,13,141,14,1],[142,17,142,60,1],[142,60,142,116,1],[142,116,142,118,1],[142,17,142,118,1],[145,13,145,14,1],[146,17,146,52,1],[148,9,148,10,1],[151,9,151,10,1],[152,13,152,28,1],[153,13,153,14,1],[154,17,154,60,1],[154,60,154,127,1],[154,127,154,129,1],[154,17,154,129,1],[157,13,157,14,0],[158,17,158,52,0],[160,9,160,10,1],[163,9,163,10,1],[164,13,164,87,1],[165,13,165,82,1],[166,13,166,89,1],[168,13,168,54,1],[170,13,170,25,1],[171,13,171,14,1],[173,17,174,58,1],[175,17,175,33,1],[178,13,178,14,1],[180,17,180,63,1],[181,17,181,67,1],[182,17,182,24,1],[182,26,182,33,1],[182,34,182,36,1],[182,37,182,41,1],[183,17,183,18,1],[184,21,184,98,1],[185,17,185,18,1],[186,17,186,47,1],[186,47,186,67,1],[186,67,186,78,1],[186,17,186,78,1],[188,9,188,10,1],[192,9,192,10,1],[193,13,193,57,1],[194,13,194,82,1],[195,13,195,79,1],[197,13,197,59,1],[199,13,199,54,1],[200,13,200,100,1],[202,13,202,25,1],[203,9,203,10,1],[206,9,206,10,1],[208,13,208,87,1],[209,13,209,82,1],[211,13,211,91,1],[213,13,213,82,1],[214,13,214,52,1],[216,13,216,54,1],[218,13,218,25,1],[219,13,219,14,0],[220,17,220,64,0],[222,17,223,17,0],[223,17,223,18,0],[223,18,225,21,0],[225,21,225,28,0],[225,28,225,30,0],[225,30,225,45,0],[225,45,225,46,0],[225,46,225,48,0],[225,48,225,49,0],[225,49,225,55,0],[225,55,226,21,0],[226,21,226,22,0],[226,22,227,25,0],[227,25,227,73,0],[227,73,228,21,0],[228,21,228,22,0],[228,22,229,17,0],[229,17,229,18,0],[229,18,229,20,0],[222,17,229,20,0],[232,17,233,63,0],[234,17,234,33,0],[237,13,237,14,1],[239,17,239,79,1],[242,17,242,68,1],[243,17,243,67,1],[244,17,244,24,1],[244,26,244,33,1],[244,34,244,36,1],[244,37,244,41,1],[245,17,245,18,1],[246,21,246,98,1],[247,17,247,18,1],[248,17,248,47,1],[248,47,248,67,1],[248,67,248,78,1],[248,17,248,78,1],[250,9,250,10,1],[258,9,258,10,1],[259,13,259,90,1],[261,13,261,34,1],[261,35,261,89,1],[263,13,263,93,0],[264,9,264,10,1],[267,9,267,10,1],[268,13,268,89,1],[270,13,270,34,1],[270,35,270,89,1],[272,13,272,93,0],[273,9,273,10,1],[276,9,276,10,1],[277,13,277,93,1],[279,13,279,34,1],[279,35,279,89,1],[281,13,281,101,1],[282,9,282,10,1],[285,9,285,10,1],[288,13,297,124,1],[299,13,299,32,1],[300,13,300,14,0],[301,17,301,33,0],[302,13,302,14,0],[308,13,313,43,1],[315,13,315,31,1],[316,9,316,10,1],[319,9,319,10,1],[320,13,334,15,1],[336,13,336,38,1],[337,13,337,14,1],[338,17,338,31,1],[339,17,339,18,1],[341,21,341,76,1],[342,21,342,72,1],[343,21,343,67,1],[344,17,344,18,1],[346,17,346,50,1],[347,17,347,49,1],[348,17,348,54,1],[349,17,349,56,1],[350,13,350,14,1],[354,13,356,50,1],[358,13,358,38,1],[359,13,359,14,1],[360,17,360,97,1],[362,17,362,31,1],[363,17,363,18,1],[365,21,369,66,1],[370,17,370,18,1],[372,17,372,113,1],[373,13,373,14,1],[375,13,375,93,1],[377,13,377,38,1],[378,13,378,14,1],[379,17,379,41,1],[380,13,380,14,1],[382,13,382,30,1],[383,9,383,10,1],[386,9,386,10,1],[387,13,388,113,1],[390,13,390,27,1],[391,13,391,14,1],[392,17,392,50,1],[393,13,393,14,1],[395,13,395,24,1],[396,9,396,10,1],[399,9,399,10,1],[400,13,401,65,1],[403,13,403,27,1],[404,13,404,14,0],[405,17,405,50,0],[406,13,406,14,0],[408,13,408,56,1],[410,13,410,24,1],[411,9,411,10,1],[414,9,414,10,1],[415,13,416,82,1],[418,13,418,27,1],[419,13,419,14,0],[420,17,420,50,0],[421,13,421,14,0],[423,13,423,56,1],[425,13,425,24,1],[426,9,426,10,1],[429,9,429,10,1],[430,13,432,72,1],[434,13,434,27,1],[435,13,435,14,1],[436,17,436,50,1],[437,13,437,14,1],[439,13,439,24,1],[440,9,440,10,1],[443,9,443,10,1],[444,13,446,81,1],[448,13,448,27,1],[449,13,449,14,1],[450,17,450,50,1],[451,13,451,14,1],[453,13,453,24,1],[454,9,454,10,1],[457,9,457,10,1],[458,13,471,15,1],[473,13,473,38,1],[474,13,474,14,1],[475,17,475,31,1],[476,17,476,18,1],[477,21,477,56,1],[478,21,478,55,1],[479,21,479,54,1],[480,17,480,18,1],[481,17,481,50,1],[482,17,482,49,1],[483,17,483,54,1],[484,17,484,56,1],[485,13,485,14,1],[487,13,488,45,1],[490,13,490,29,1],[491,13,491,14,1],[492,17,492,60,1],[493,13,493,14,1],[495,13,495,24,1],[496,9,496,10,1],[507,9,507,10,1],[508,13,508,46,1],[509,9,509,10,1],[517,49,517,53,1],[517,54,517,58,1],[520,43,520,47,1],[520,48,520,52,1],[523,43,523,47,1],[523,48,523,52,1],[526,40,526,44,1],[526,45,526,49,1],[540,13,540,89,1],[543,13,543,14,1],[547,17,547,31,1],[548,21,548,36,1],[551,17,551,66,1],[552,17,552,18,1],[553,21,553,84,1],[554,21,554,22,1],[556,25,562,27,1],[563,21,563,22,1],[566,21,566,33,1],[573,17,573,36,1],[577,17,577,62,1],[579,17,579,80,1],[580,17,580,18,1],[582,21,588,23,1],[589,17,589,18,1],[592,17,592,29,1],[593,13,593,14,1],[599,13,599,14,1],[600,17,600,32,1],[601,13,601,14,1],[610,13,610,14,1],[611,17,611,40,1],[612,17,612,18,1],[613,21,613,36,1],[614,21,614,33,1],[617,17,617,47,1],[619,17,619,49,1],[620,17,620,18,1],[622,21,622,58,1],[623,21,623,22,1],[624,25,624,62,1],[625,25,625,45,1],[626,29,626,116,0],[629,25,629,50,1],[630,25,630,37,1],[633,21,633,34,1],[636,17,636,32,1],[637,17,637,29,1],[638,13,638,14,1],[641,13,641,14,1],[642,17,642,40,1],[643,17,643,18,0],[644,21,644,32,0],[645,21,645,34,0],[647,17,647,61,1],[648,13,648,14,1],[658,13,658,112,1],[659,13,659,14,1],[660,17,660,36,1],[661,17,661,34,1],[662,17,662,40,1],[663,17,663,36,1],[664,13,664,14,1],[667,13,667,14,1],[668,17,668,65,1],[669,13,669,14,1],[673,21,673,22,1],[673,23,673,41,1],[673,42,673,43,1],[679,17,679,18,1],[680,21,680,48,1],[681,21,681,22,1],[682,25,682,50,1],[684,21,684,39,0],[685,17,685,18,1]]);
    </script>
  </body>
</html>