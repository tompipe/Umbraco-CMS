<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\HealthCheck\Checks\Config\ConfigurationService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Xml;
using Umbraco.Core.Logging;
using Umbraco.Core.Services;

namespace Umbraco.Web.HealthCheck.Checks.Config
{
    //TODO: Add config transform for when config with specified XPath is not found

    public class ConfigurationService
    {
        private readonly string _configFilePath;
        private readonly string _xPath;
        private readonly ILocalizedTextService _textService;

        /// &lt;param name=&quot;configFilePath&quot;&gt;The absolute file location of the configuration file&lt;/param&gt;
        /// &lt;param name=&quot;xPath&quot;&gt;The XPath to select the value&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public ConfigurationService(string configFilePath, string xPath)
        {
            _configFilePath = configFilePath;
            _xPath = xPath;
            _textService = UmbracoContext.Current.Application.Services.TextService;
        }

        /// &lt;summary&gt;
        /// Gets a value from a given configuration file with the given XPath  
        /// &lt;/summary&gt;
        public ConfigurationServiceResult GetConfigurationValue()
        {
            try
            {
                if (File.Exists(_configFilePath) == false)
                    return new ConfigurationServiceResult
                    {
                        Success = false,
                        Result = _textService.Localize(&quot;healthcheck/configurationServiceFileNotFound&quot;, new[] { _configFilePath })
                    };

                var xmlDocument = new XmlDocument();
                xmlDocument.Load(_configFilePath);

                var xmlNode = xmlDocument.SelectSingleNode(_xPath);
                if (xmlNode == null)
                    return new ConfigurationServiceResult
                    {
                        Success = false,
                        Result = _textService.Localize(&quot;healthcheck/configurationServiceNodeNotFound&quot;, new[] { _xPath, _configFilePath })
                    };

                return new ConfigurationServiceResult
                {
                    Success = true,
                    Result = string.Format(xmlNode.Value ?? xmlNode.InnerText)
                };
            }
            catch (Exception exception)
            {
                LogHelper.Error&lt;ConfigurationService&gt;(&quot;Error trying to get configuration value&quot;, exception);
                return new ConfigurationServiceResult
                {
                    Success = false,
                    Result = _textService.Localize(&quot;healthcheck/configurationServiceError&quot;, new[] { exception.Message })
                };
            }
        }

        /// &lt;summary&gt;
        /// Updates a value in a given configuration file with the given XPath  
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;value&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public ConfigurationServiceResult UpdateConfigFile(string value)
        {
            try
            {
                if (File.Exists(_configFilePath) == false)
                    return new ConfigurationServiceResult
                    {
                        Success = false,
                        Result = _textService.Localize(&quot;healthcheck/configurationServiceFileNotFound&quot;, new[] { _configFilePath })
                    };

                var xmlDocument = new XmlDocument { PreserveWhitespace = true };
                xmlDocument.Load(_configFilePath);

                var node = xmlDocument.SelectSingleNode(_xPath);
                if (node == null)
                    return new ConfigurationServiceResult
                    {
                        Success = false,
                        Result = _textService.Localize(&quot;healthcheck/configurationServiceNodeNotFound&quot;, new[] { _xPath, _configFilePath })
                    };

                if (node.NodeType == XmlNodeType.Element)
                    node.InnerText = value;
                else
                    node.Value = value;

                xmlDocument.Save(_configFilePath);
                return new ConfigurationServiceResult { Success = true };
            }
            catch (Exception exception)
            {
                LogHelper.Error&lt;ConfigurationService&gt;(&quot;Error trying to update configuration&quot;, exception);
                return new ConfigurationServiceResult
                {
                    Success = false,
                    Result = _textService.Localize(&quot;healthcheck/configurationServiceError&quot;, new[] { exception.Message })
                };
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,73,0],[21,9,21,10,0],[22,13,22,46,0],[23,13,23,28,0],[24,13,24,84,0],[25,9,25,10,0],[31,9,31,10,0],[33,13,33,14,0],[34,17,34,59,0],[35,21,39,23,0],[41,17,41,53,0],[42,17,42,51,0],[44,17,44,68,0],[45,17,45,37,0],[46,21,50,23,0],[52,17,56,19,0],[58,13,58,40,0],[59,13,59,14,0],[60,17,60,109,0],[61,17,65,19,0],[67,9,67,10,0],[75,9,75,10,0],[77,13,77,14,0],[78,17,78,59,0],[79,21,83,23,0],[85,17,85,81,0],[86,17,86,51,0],[88,17,88,65,0],[89,17,89,34,0],[90,21,94,23,0],[96,17,96,58,0],[97,21,97,44,0],[99,21,99,40,0],[101,17,101,51,0],[102,17,102,74,0],[104,13,104,40,0],[105,13,105,14,0],[106,17,106,106,0],[107,17,111,19,0],[113,9,113,10,0]]);
    </script>
  </body>
</html>