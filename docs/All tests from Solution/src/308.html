<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Routing\uQueryGetNodeIdByUrlTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Moq;
using NUnit.Framework;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Stubs;
using Umbraco.Web.Routing;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.template;

namespace Umbraco.Tests.Routing
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerFixture)]
	[TestFixture]
	public class uQueryGetNodeIdByUrlTests : BaseRoutingTest
	{

        private IUmbracoSettingsSection _umbracoSettings;

		public override void Initialize()
		{
			base.Initialize();

            //generate new mock settings and assign so we can configure in individual tests
            _umbracoSettings = SettingsForTests.GenerateMockSettings();
            SettingsForTests.ConfigureSettings(_umbracoSettings);

			var url = &quot;/test&quot;;
			
			var lookup = new Umbraco.Web.Routing.ContentFinderByNiceUrl();
			var lookups = new Umbraco.Web.Routing.IContentFinder[] { lookup };

			var t = Template.MakeNew(&quot;test&quot;, new User(0));

			var umbracoContext = GetUmbracoContext(url, t.Id);
            var urlProvider = new UrlProvider(umbracoContext, _umbracoSettings.WebRouting, new IUrlProvider[] { new DefaultUrlProvider() });
			var routingContext = new RoutingContext(
				umbracoContext,
				lookups,
				new FakeLastChanceFinder(),
                urlProvider);

			//assign the routing context back to the umbraco context
			umbracoContext.RoutingContext = routingContext;

			////assign the routing context back to the umbraco context
			//umbracoContext.RoutingContext = routingContext;
			Umbraco.Web.UmbracoContext.Current = routingContext.UmbracoContext;

            
		}

        public override void TearDown()
        {
            Umbraco.Web.UmbracoContext.Current = null;
            base.TearDown();
        }

		[TestCase(1046, &quot;/home&quot;)]
		[TestCase(1173, &quot;/home/sub1&quot;)]
		[TestCase(1174, &quot;/home/sub1/sub2&quot;)]
		[TestCase(1176, &quot;/home/sub1/sub-3&quot;)]
		[TestCase(1177, &quot;/home/sub1/custom-sub-1&quot;)]
		[TestCase(1178, &quot;/home/sub1/custom-sub-2&quot;)]
		[TestCase(1175, &quot;/home/sub-2&quot;)]
		[TestCase(1172, &quot;/test-page&quot;)]

		public void GetNodeIdByUrl_Not_Hiding_Top_Level_Absolute(int nodeId, string url)
		{
		    SettingsForTests.UseDirectoryUrls = true;
		    SettingsForTests.HideTopLevelNodeFromPath = false;

            var requestMock = Mock.Get(_umbracoSettings.RequestHandler);
            requestMock.Setup(x =&gt; x.UseDomainPrefixes).Returns(false);
		    
			Assert.AreEqual(nodeId, global::umbraco.uQuery.GetNodeIdByUrl(&quot;http://example.com&quot; + url));
		}

		[TestCase(1046, &quot;/home&quot;)]
		[TestCase(1173, &quot;/home/sub1&quot;)]
		[TestCase(1174, &quot;/home/sub1/sub2&quot;)]
		[TestCase(1176, &quot;/home/sub1/sub-3&quot;)]
		[TestCase(1177, &quot;/home/sub1/custom-sub-1&quot;)]
		[TestCase(1178, &quot;/home/sub1/custom-sub-2&quot;)]
		[TestCase(1175, &quot;/home/sub-2&quot;)]
		[TestCase(1172, &quot;/test-page&quot;)]

		public void GetNodeIdByUrl_Not_Hiding_Top_Level_Relative(int nodeId, string url)
		{
            SettingsForTests.UseDirectoryUrls = true;
            SettingsForTests.HideTopLevelNodeFromPath = false;

            var requestMock = Mock.Get(_umbracoSettings.RequestHandler);
            requestMock.Setup(x =&gt; x.UseDomainPrefixes).Returns(false);
            
			Assert.AreEqual(nodeId, global::umbraco.uQuery.GetNodeIdByUrl(url));
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,3,20,4,1],[21,4,21,22,1],[24,13,24,72,1],[25,13,25,66,1],[27,4,27,22,1],[29,4,29,66,1],[30,4,30,70,1],[32,4,32,50,1],[34,4,34,54,1],[35,13,35,141,1],[36,4,40,30,1],[43,4,43,51,1],[47,4,47,71,1],[50,3,50,4,1],[53,9,53,10,1],[54,13,54,55,1],[55,13,55,29,1],[56,9,56,10,1],[68,3,68,4,1],[69,7,69,48,1],[70,7,70,57,1],[72,13,72,73,1],[73,13,73,72,1],[75,4,75,95,1],[76,3,76,4,1],[88,3,88,4,1],[89,13,89,54,1],[90,13,90,63,1],[92,13,92,73,1],[93,13,93,72,1],[95,4,95,72,1],[96,3,96,4,1]]);
    </script>
  </body>
</html>