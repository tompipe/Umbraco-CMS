<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Migrations\TargetVersionSixthMigrationsTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data.SqlServerCe;
using System.Diagnostics;
using System.Linq;
using System.Text.RegularExpressions;
using Moq;
using NUnit.Framework;
using Semver;
using SQLCE4Umbraco;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSix;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers;
using GlobalSettings = Umbraco.Core.Configuration.GlobalSettings;

namespace Umbraco.Tests.Migrations
{
    [DatabaseTestBehavior(DatabaseBehavior.EmptyDbFilePerTest)]
    [TestFixture]
    public class TargetVersionSixthMigrationsTest : BaseDatabaseFactoryTest
    {
        /// &lt;summary&gt;Regular expression that finds multiline block comments.&lt;/summary&gt;
        private static readonly Regex FindComments = new Regex(@&quot;\/\*.*?\*\/&quot;, RegexOptions.Singleline | RegexOptions.Compiled);

        /// &lt;summary&gt;
        /// sets up resolvers before resolution is frozen
        /// &lt;/summary&gt;
        protected override void FreezeResolution()
        {
            MigrationResolver.Current = new MigrationResolver(
                ProfilingLogger.Logger,
                () =&gt; new List&lt;Type&gt;
				{
					typeof (Core.Persistence.Migrations.Upgrades.TargetVersionFourNineZero.RemoveUmbracoAppConstraints),
					typeof (DeleteAppTables),
					typeof (EnsureAppsTreesUpdated),
					typeof (MoveMasterContentTypeData),
					typeof (NewCmsContentType2ContentTypeTable),
					typeof (RemoveMasterContentTypeColumn),
					typeof (RenameCmsTabTable),
					typeof (RenameTabIdColumn),
					typeof (UpdateCmsContentTypeAllowedContentTypeTable),
					typeof (UpdateCmsContentTypeTable),
					typeof (UpdateCmsContentVersionTable),
					typeof (UpdateCmsPropertyTypeGroupTable)
				}.OrderByDescending(x =&gt; x.Name));

            base.FreezeResolution();
        }

        [Test]
        public void Can_Find_Targetted_Migrations()
        {
            var db = GetConfiguredDatabase();

            //Create db schema and data from old Total.sql file for Sql Ce
            string statements = GetDatabaseSpecificSqlScript();
            // replace block comments by whitespace
            statements = FindComments.Replace(statements, &quot; &quot;);
            // execute all non-empty statements
            foreach (string statement in statements.Split(&quot;;&quot;.ToCharArray()))
            {
                string rawStatement = statement.Replace(&quot;GO&quot;, &quot;&quot;).Trim();
                if (rawStatement.Length &gt; 0)
                    db.Execute(new Sql(rawStatement));
            }

            var configuredVersion = new SemVersion(4, 8, 0);
            var targetVersion = new SemVersion(6, 0, 0);
            var foundMigrations = MigrationResolver.Current.Migrations;

            var migrationRunner = new MigrationRunner(
                Mock.Of&lt;IMigrationEntryService&gt;(),
                Logger, configuredVersion, targetVersion, GlobalSettings.UmbracoMigrationName);

            var migrations = migrationRunner.OrderedUpgradeMigrations(foundMigrations).ToList();

            var context = new MigrationContext(DatabaseProviders.SqlServerCE, db, Logger);
            foreach (var migration1 in migrations)
            {
                var migration = (MigrationBase) migration1;
                migration.GetUpExpressions(context);
            }

            foreach (var expression in context.Expressions)
            {
                Debug.Print(expression.ToString());
            }

            Assert.That(migrations.Count(), Is.EqualTo(12));
        }

        public string Path { get; set; }

        public UmbracoDatabase GetConfiguredDatabase()
        {
            return new UmbracoDatabase(&quot;Datasource=|DataDirectory|UmbracoPetaPocoTests.sdf;Flush Interval=1;&quot;, Constants.DatabaseProviders.SqlCe, Mock.Of&lt;ILogger&gt;());
        }


        public string GetDatabaseSpecificSqlScript()
        {
            return SqlScripts.SqlResources.SqlCeTotal_480;
        } 
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,29,129,1],[35,9,35,10,1],[36,13,38,23,1],[38,23,52,30,1],[52,30,52,36,1],[52,36,52,37,1],[38,23,52,37,1],[52,37,52,39,1],[36,13,52,39,1],[54,13,54,37,1],[55,9,55,10,1],[59,9,59,10,1],[60,13,60,46,1],[63,13,63,64,1],[65,13,65,64,1],[67,13,67,20,1],[67,22,67,38,1],[67,39,67,41,1],[67,42,67,77,1],[68,13,68,14,1],[69,17,69,74,1],[70,17,70,45,1],[71,21,71,55,1],[72,13,72,14,1],[74,13,74,61,1],[75,13,75,57,1],[76,13,76,72,1],[78,13,80,96,1],[82,13,82,97,1],[84,13,84,91,1],[85,13,85,20,1],[85,22,85,36,1],[85,37,85,39,1],[85,40,85,50,1],[86,13,86,14,1],[87,17,87,60,1],[88,17,88,53,1],[89,13,89,14,1],[91,13,91,20,1],[91,22,91,36,1],[91,37,91,39,1],[91,40,91,59,1],[92,13,92,14,1],[93,17,93,52,1],[94,13,94,14,1],[96,13,96,61,1],[97,9,97,10,1],[99,30,99,34,0],[99,35,99,39,0],[102,9,102,10,1],[103,13,103,167,1],[104,9,104,10,1],[108,9,108,10,1],[109,13,109,59,1],[110,9,110,10,1]]);
    </script>
  </body>
</html>