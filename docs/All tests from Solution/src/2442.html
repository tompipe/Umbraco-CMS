<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\macro\MacroEngineFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using Umbraco.Core;
using umbraco.BusinessLogic.Utils;
using umbraco.interfaces;

namespace umbraco.cms.businesslogic.macro
{

	//TODO: This class needs to be changed to use the new MultipleResolverBase, doing this will require migrating and cleaning up
	// a bunch of types so I have left it existing here under legacy code for now. The IMacroEngine interface also requires fixing
	// considering the new macro types of SurfaceControllers.

    public class MacroEngineFactory
    {
        private static readonly List&lt;IMacroEngine&gt; AllEngines = new List&lt;IMacroEngine&gt;();
    	private static readonly ReaderWriterLockSlim Lock = new ReaderWriterLockSlim();
    	private static volatile bool _isInitialized = false;

        public MacroEngineFactory()
        {
			EnsureInitialize();
        }

		internal static void EnsureInitialize()
		{
			using (var lck = new UpgradeableReadLock(Lock))
			{
                if (_isInitialized)
                    return;

                lck.UpgradeToWriteLock();

				AllEngines.Clear();

				AllEngines.AddRange(
					PluginManager.Current.CreateInstances&lt;IMacroEngine&gt;(
						PluginManager.Current.ResolveMacroEngines()));
				
				_isInitialized = true;
			}
		}

		[Obsolete(&quot;Use EnsureInitialize method instead&quot;)]
        protected static void Initialize()
        {
        	EnsureInitialize();
        }

		/// &lt;summary&gt;
		/// Returns a collectino of MacroEngineLanguage objects, each of which describes a file extension and an associated macro engine
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		/// &lt;remarks&gt;
		/// Until the macro engines are rewritten, this method explicitly ignores the PartialViewMacroEngine because this method 
		/// is essentially just used for any macro engine that stores it&#39;s files in the ~/macroScripts folder where file extensions
		/// cannot overlap.
		/// &lt;/remarks&gt;
		[Obsolete(&quot;This method is not used and will be removed from the codebase in the future&quot;)]
        public static IEnumerable&lt;MacroEngineLanguage&gt; GetSupportedLanguages() 
		{
            var languages = new List&lt;MacroEngineLanguage&gt;();
            foreach(var engine in GetAll()) 
			{
                foreach (string lang in engine.SupportedExtensions)
                {
					if (languages.Find(t =&gt; t.Extension == lang) == null)
					{
						languages.Add(new MacroEngineLanguage(lang, engine.Name));
					}
                }
            }
            return languages;
        }

		/// &lt;summary&gt;
		/// Returns a collectino of MacroEngineLanguage objects, each of which describes a file extension and an associated macro engine that
		/// supports file extension lookups.
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;		
		/// &lt;remarks&gt;
		/// The PartialViewMacroEngine will never be returned in these results because it does not support searching by file extensions. See
		/// the notes in the PartialViewMacroEngine regarding this.
		/// &lt;/remarks&gt;
        public static IEnumerable&lt;MacroEngineLanguage&gt; GetSupportedUILanguages()
		{
			var languages = new List&lt;MacroEngineLanguage&gt;();
			foreach (var engine in GetAll())
			{
				foreach (string lang in engine.SupportedUIExtensions)
				{
					if (languages.All(t =&gt; t.Extension != lang))
					{
						languages.Add(new MacroEngineLanguage(lang, engine.Name));
					}
				}
			}
			return languages.OrderBy(s =&gt; s.Extension);
		}		

        public static List&lt;IMacroEngine&gt; GetAll()
        {
			EnsureInitialize();            
            return AllEngines;
        }

        public static IMacroEngine GetEngine(string name)
        {
        	EnsureInitialize();
        	var engine = AllEngines.FirstOrDefault(x =&gt; x.Name == name);
        	return engine;            
        }

        public static IMacroEngine GetByFilename(string filename)
        {
            if (filename.Contains(&quot;.&quot;))
            {
                string extension = filename.Substring(filename.LastIndexOf(&quot;.&quot;) + 1);
                return GetByExtension(extension);
            }

            throw new MacroEngineException(string.Format(&quot;No MacroEngine matches the file with extension &#39;{0}&#39;&quot;, filename));
        }

        public static IMacroEngine GetByExtension(string extension)
        {
            var engine = GetAll().Find(t =&gt; t.SupportedExtensions.Contains(extension));
            if (engine != null)
            {
                return engine;
            }

            throw new MacroEngineException(string.Format(&quot;No MacroEngine found for extension &#39;{0}&#39;&quot;, extension));
        }
    }

    public class MacroEngineException : Exception
    {
        public MacroEngineException() : base() { }

        public MacroEngineException(string msg)
            : base(msg)
        {

        }
    }

    public class MacroEngineLanguage
    {
        public string Extension { get; set; }
        public string EngineName { get; set; }
        public MacroEngineLanguage()
        {
            
        }

        public MacroEngineLanguage(string extension, string engineName)
        {
            Extension = extension;
            EngineName = engineName;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,90,1],[21,6,21,85,1],[22,6,22,58,1],[24,9,24,36,0],[25,9,25,10,0],[26,4,26,23,0],[27,9,27,10,0],[30,3,30,4,1],[31,11,31,50,1],[32,4,32,5,1],[33,17,33,36,1],[34,21,34,28,1],[36,17,36,42,1],[38,5,38,24,1],[40,5,42,53,1],[44,5,44,27,1],[45,4,45,5,1],[46,3,46,4,1],[50,9,50,10,0],[51,10,51,29,0],[52,9,52,10,0],[65,3,65,4,0],[66,13,66,61,0],[67,13,67,20,0],[67,21,67,31,0],[67,32,67,34,0],[67,35,67,43,0],[68,4,68,5,0],[69,17,69,24,0],[69,26,69,37,0],[69,38,69,40,0],[69,41,69,67,0],[70,17,70,18,0],[71,6,71,30,0],[71,30,71,49,0],[71,49,71,59,0],[71,6,71,59,0],[72,6,72,7,0],[73,7,73,65,0],[74,6,74,7,0],[75,17,75,18,0],[76,13,76,14,0],[77,13,77,30,0],[78,9,78,10,0],[90,3,90,4,0],[91,4,91,52,0],[92,4,92,11,0],[92,13,92,23,0],[92,24,92,26,0],[92,27,92,35,0],[93,4,93,5,0],[94,5,94,12,0],[94,14,94,25,0],[94,26,94,28,0],[94,29,94,57,0],[95,5,95,6,0],[96,6,96,29,0],[96,29,96,48,0],[96,48,96,50,0],[96,6,96,50,0],[97,6,97,7,0],[98,7,98,65,0],[99,6,99,7,0],[100,5,100,6,0],[101,4,101,5,0],[102,4,102,34,0],[102,34,102,45,0],[102,45,102,47,0],[102,4,102,47,0],[103,3,103,4,0],[106,9,106,10,1],[107,4,107,23,1],[108,13,108,31,1],[109,9,109,10,1],[112,9,112,10,1],[113,10,113,29,1],[114,10,114,54,1],[114,54,114,68,1],[114,68,114,70,1],[114,10,114,70,1],[115,10,115,24,1],[116,9,116,10,1],[119,9,119,10,1],[120,13,120,40,1],[121,13,121,14,1],[122,17,122,86,1],[123,17,123,50,1],[126,13,126,125,0],[127,9,127,10,1],[130,9,130,10,1],[131,13,131,45,1],[131,45,131,86,1],[131,86,131,88,1],[131,13,131,88,1],[132,13,132,32,1],[133,13,133,14,1],[134,17,134,31,1],[137,13,137,114,1],[138,9,138,10,1],[143,41,143,47,0],[143,48,143,49,0],[143,50,143,51,0],[146,15,146,24,1],[147,9,147,10,1],[149,9,149,10,1],[154,35,154,39,0],[154,40,154,44,0],[155,36,155,40,0],[155,41,155,45,0],[156,9,156,37,0],[157,9,157,10,0],[159,9,159,10,0],[161,9,161,72,0],[162,9,162,10,0],[163,13,163,35,0],[164,13,164,37,0],[165,9,165,10,0]]);
    </script>
  </body>
</html>