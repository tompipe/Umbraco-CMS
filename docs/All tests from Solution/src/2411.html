<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\Property\Property.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Reflection.Emit;
using System.Runtime.CompilerServices;
using System.Web.UI;
using System.Xml;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Persistence;
using Umbraco.Core.Services;
using umbraco.DataLayer;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.datatype;
using umbraco.cms.businesslogic.propertytype;
using umbraco.interfaces;

namespace umbraco.cms.businesslogic.property
{
    /// &lt;summary&gt;
    /// Property class encapsulates property factory, ensuring that the work
    /// with umbraco generic properties stays nice and easy..
    /// &lt;/summary&gt;
    public class Property
    {
        private Umbraco.Core.Models.PropertyType _propertyType;
        private Umbraco.Core.Models.Property _property;
        private PropertyType _pt;
        private interfaces.IData _data;
        private int _id;

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        protected static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        internal static Database Database
        {
            get { return ApplicationContext.Current.DatabaseContext.Database; }
        }

        public Property(int Id, propertytype.PropertyType pt)
        {

            _pt = pt;
            _id = Id;
            if (_pt.DataTypeDefinition.DataType == null)
                throw new Exception(string.Format(&quot;Could not load datatype &#39;{0}&#39;&quot;, _pt.DataTypeDefinition.Text));
            _data = _pt.DataTypeDefinition.DataType.Data;
            _data.PropertyId = Id;
        }

        public Property(int Id)
        {
            _id = Id;
            using (var sqlHelper = Application.SqlHelper)
            {
                _pt = PropertyType.GetPropertyType(
                    sqlHelper.ExecuteScalar&lt;int&gt;(&quot;select propertytypeid from cmsPropertyData where id = @id&quot;,
                        sqlHelper.CreateParameter(&quot;@id&quot;, Id)));
                if (_pt.DataTypeDefinition.DataType == null)
                    throw new Exception(string.Format(&quot;Could not load datatype &#39;{0}&#39;&quot;, _pt.DataTypeDefinition.Text));
                _data = _pt.DataTypeDefinition.DataType.Data;
                _data.PropertyId = Id;
            }
        }

        internal Property(Umbraco.Core.Models.Property property)
        {
            _id = property.Id;
            _property = property;
            _propertyType = property.PropertyType;

            //Just to ensure that there is a PropertyType available
            _pt = PropertyType.GetPropertyType(property.PropertyTypeId);

            //ensure we have data property editor set
            if (_pt.DataTypeDefinition.DataType != null)
            {
                _data = _pt.DataTypeDefinition.DataType.Data;
            }
            else
            {
                //send back null we will handle it in ContentControl AddControlNew 
                //and display to use message from the dictionary errors section 
                _data= new DefaultData(null);
            }
            
            _data.PropertyId = Id;

            //set the value so it doesn&#39;t need to go to the database
            var dvs = _data as IDataValueSetter;
            if (dvs != null)
            {
                dvs.SetValue(property.Value, property.PropertyType.DataTypeDatabaseType.ToString());
            }
            
        }

        public Guid VersionId
        {
            get
            {
                using (var sqlHelper = Application.SqlHelper)
                using (IRecordsReader dr = sqlHelper.ExecuteReader(&quot;SELECT versionId FROM cmsPropertyData WHERE id = &quot; + _id.ToString()))
                {
                    dr.Read();
                    return dr.GetGuid(&quot;versionId&quot;);
                }
            }
        }

        public int Id
        {
            get { return _id; }
        }

        public propertytype.PropertyType PropertyType
        {
            get
            {
                /*if (_propertyType != null)
                    return new PropertyType(_propertyType);*/

                return _pt;
            }
        }

        public object Value
        {
            get
            {
                return _data.Value;
            }
            set
            {
                _data.Value = value;
            }
        }

        public void delete()
        {
            using (var sqlHelper = Application.SqlHelper)
            {
                int contentId = sqlHelper.ExecuteScalar&lt;int&gt;(&quot;Select contentNodeId from cmsPropertyData where Id = &quot; + _id);

                sqlHelper.ExecuteNonQuery(&quot;Delete from cmsPropertyData where PropertyTypeId =&quot; + _pt.Id + &quot; And contentNodeId = &quot; + contentId);

                _data.Delete();
            }
        }

        public XmlNode ToXml(XmlDocument xd)
        {
            var serializer = new EntityXmlSerializer();
            var xml = serializer.Serialize(ApplicationContext.Current.Services.DataTypeService, this._property);
            return xml.GetXmlNode(xd);
        }

        [MethodImpl(MethodImplOptions.Synchronized)]
        public static Property MakeNew(PropertyType pt, Content c, Guid versionId)
        {
            int newPropertyId = 0;
            // The method is synchronized
            using (var sqlHelper = Application.SqlHelper)
            {
                sqlHelper.ExecuteNonQuery(
                    &quot;INSERT INTO cmsPropertyData (contentNodeId, versionId, propertyTypeId) VALUES(@contentNodeId, @versionId, @propertyTypeId)&quot;,
                    sqlHelper.CreateParameter(&quot;@contentNodeId&quot;, c.Id),
                    sqlHelper.CreateParameter(&quot;@versionId&quot;, versionId),
                    sqlHelper.CreateParameter(&quot;@propertyTypeId&quot;, pt.Id));
                newPropertyId = sqlHelper.ExecuteScalar&lt;int&gt;(&quot;SELECT MAX(id) FROM cmsPropertyData&quot;);
                interfaces.IData d = pt.DataTypeDefinition.DataType.Data;
                d.MakeNew(newPropertyId);
                return new Property(newPropertyId, pt);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[36,17,36,18,0],[36,19,36,48,0],[36,49,36,50,0],[41,17,41,18,0],[41,19,41,78,0],[41,79,41,80,0],[44,9,44,62,0],[45,9,45,10,0],[47,13,47,22,0],[48,13,48,22,0],[49,13,49,57,0],[50,17,50,114,0],[51,13,51,58,0],[52,13,52,35,0],[53,9,53,10,0],[55,9,55,32,0],[56,9,56,10,0],[57,13,57,22,0],[58,20,58,57,0],[59,13,59,14,0],[60,17,62,64,0],[63,17,63,61,0],[64,21,64,118,0],[65,17,65,62,0],[66,17,66,39,0],[67,13,67,14,0],[68,9,68,10,0],[70,9,70,65,0],[71,9,71,10,0],[72,13,72,31,0],[73,13,73,34,0],[74,13,74,51,0],[77,13,77,73,0],[80,13,80,57,0],[81,13,81,14,0],[82,17,82,62,0],[83,13,83,14,0],[85,13,85,14,0],[88,17,88,46,0],[89,13,89,14,0],[91,13,91,35,0],[94,13,94,49,0],[95,13,95,29,0],[96,13,96,14,0],[97,17,97,101,0],[98,13,98,14,0],[100,9,100,10,0],[105,13,105,14,0],[106,24,106,61,0],[107,24,107,137,0],[108,17,108,18,0],[109,21,109,31,0],[110,21,110,52,0],[112,13,112,14,0],[117,17,117,18,0],[117,19,117,30,0],[117,31,117,32,0],[123,13,123,14,0],[127,17,127,28,0],[128,13,128,14,0],[134,13,134,14,0],[135,17,135,36,0],[136,13,136,14,0],[138,13,138,14,0],[139,17,139,37,0],[140,13,140,14,0],[144,9,144,10,0],[145,20,145,57,0],[146,13,146,14,0],[147,17,147,125,0],[149,17,149,144,0],[151,17,151,32,0],[152,13,152,14,0],[153,9,153,10,0],[156,9,156,10,0],[157,13,157,56,0],[158,13,158,113,0],[159,13,159,39,0],[160,9,160,10,0],[164,9,164,10,0],[165,13,165,35,0],[167,20,167,57,0],[168,13,168,14,0],[169,17,173,74,0],[174,17,174,101,0],[175,17,175,74,0],[176,17,176,42,0],[177,17,177,56,0],[179,9,179,10,0]]);
    </script>
  </body>
</html>