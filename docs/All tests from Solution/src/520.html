<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\editMacro.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;

using System.Reflection;
using System.Text;
using System.IO;
using Umbraco.Core.IO;
using Umbraco.Web;
using umbraco.DataLayer;


namespace umbraco.dialogs
{
	/// &lt;summary&gt;
	/// Summary description for insertMacro.
	/// &lt;/summary&gt;
	public partial class editMacro : BasePages.UmbracoEnsuredPage
	{
		protected Button Button1;

		protected cms.businesslogic.macro.Macro MacroObject { get; private set; }

		public string _macroAlias = &quot;&quot;;

		protected void renderProperties(object sender, EventArgs e)
		{
			if (umb_macroAlias.SelectedValue != &quot;&quot;)
			{
				AskForProperties(umb_macroAlias.SelectedValue);
			}
			else
			{
				pl_insert.Visible = true;
				pl_edit.Visible = false;
			}
		}

		private void AskForProperties(string alias)
		{
			pl_edit.Visible = true;
			pl_insert.Visible = false;

			MacroObject = cms.businesslogic.macro.Macro.GetByAlias(alias);

			_macroAlias = MacroObject.Alias;


			//If no properties, we will exit now...
			if (MacroObject.Properties.Length == 0)
			{
				//var noProps = new Literal();
				//noProps.Text = &quot;&lt;script type=&#39;text/javascript&#39;&gt;Umbraco.Dialogs.EditMacro.getInstance().updateMacro()&lt;/script&gt;&quot;;
				//macroProperties.Controls.Add(noProps);
			}
			else
			{
				//if we have properties, we&#39;ll render the controls for them...
				foreach (cms.businesslogic.macro.MacroProperty mp in MacroObject.Properties)
				{
					var macroAssembly = mp.Type.Assembly;
					var macroType = mp.Type.Type;
					try
					{

						Assembly assembly = Assembly.LoadFrom(IOHelper.MapPath(SystemDirectories.Bin + &quot;/&quot; + macroAssembly + &quot;.dll&quot;));

						Type type = assembly.GetType(macroAssembly + &quot;.&quot; + macroType);
						var typeInstance = Activator.CreateInstance(type) as interfaces.IMacroGuiRendering;
						if (typeInstance != null)
						{
							var control = Activator.CreateInstance(type) as Control;
							control.ID = mp.Alias;

							if (!IsPostBack)
							{
								if (Request[&quot;umb_&quot; + mp.Alias] != null)
								{
									if (Request[&quot;umb_&quot; + mp.Alias] != &quot;&quot;)
									{
										type.GetProperty(&quot;Value&quot;).SetValue(control, Convert.ChangeType(Request[&quot;umb_&quot; + mp.Alias], type.GetProperty(&quot;Value&quot;).PropertyType), null);
									}
								}
							}

							// register alias
							var pp = new umbraco.uicontrols.PropertyPanel();
							pp.Text = mp.Name;
							pp.Controls.Add(control);
							macroProperties.Controls.Add(pp);

							pp.Controls.Add(new LiteralControl(&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;Umbraco.Dialogs.EditMacro.getInstance().registerAlias(&#39;&quot; + control.ClientID + &quot;&#39;,&#39;&quot; + mp.Alias + &quot;&#39;); &lt;/script&gt;\n&quot;));



						}
						else
						{
							Trace.Warn(&quot;umbEditContent&quot;, &quot;Type doesn&#39;t exist or is not umbraco.interfaces.DataFieldI (&#39;&quot; + macroAssembly + &quot;.&quot; + macroType + &quot;&#39;)&quot;);
						}

					}
					catch (Exception fieldException)
					{
						Trace.Warn(&quot;umbEditContent&quot;, &quot;Error creating type &#39;&quot; + macroAssembly + &quot;.&quot; + macroType + &quot;&#39;&quot;, fieldException);
					}
				}
			}
		}
		protected void Page_Load(object sender, System.EventArgs e)
		{

			if (!Page.IsPostBack)
			{
				if (!string.IsNullOrEmpty(Request[&quot;alias&quot;]))
				{
					AskForProperties(Request[&quot;alias&quot;]);
				}
				else
				{
				    string query;
				    if (Request.GetItemAsString(&quot;editor&quot;) != &quot;&quot;)
				        query = &quot;select macroAlias, macroName from cmsMacro where macroUseInEditor = 1 order by macroName&quot;;
				    else
				        query = &quot;select macroAlias, macroName from cmsMacro order by macroName&quot;;

                    using (var sqlHelper = BusinessLogic.Application.SqlHelper)
                    {
                        using (IRecordsReader macroRenderings = sqlHelper.ExecuteReader(query))
                        {
                            umb_macroAlias.DataSource = macroRenderings;
                            umb_macroAlias.DataValueField = &quot;macroAlias&quot;;
                            umb_macroAlias.DataTextField = &quot;macroName&quot;;
                            umb_macroAlias.DataBind();
                        }
                    }
				}
			}

		}		

		/// &lt;summary&gt;
		/// pl_edit control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.Panel pl_edit;

		/// &lt;summary&gt;
		/// pane_edit control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.Pane pane_edit;

		/// &lt;summary&gt;
		/// macroProperties control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.PlaceHolder macroProperties;

		/// &lt;summary&gt;
		/// pl_insert control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.Panel pl_insert;

		/// &lt;summary&gt;
		/// pane_insert control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.Pane pane_insert;

		/// &lt;summary&gt;
		/// pp_chooseMacro control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::umbraco.uicontrols.PropertyPanel pp_chooseMacro;

		/// &lt;summary&gt;
		/// umb_macroAlias control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.ListBox umb_macroAlias;

		/// &lt;summary&gt;
		/// bt_insert control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.Button bt_insert;

		/// &lt;summary&gt;
		/// renderHolder control.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Auto-generated field.
		/// To modify move field declaration from designer file to code-behind file.
		/// &lt;/remarks&gt;
		protected global::System.Web.UI.WebControls.PlaceHolder renderHolder;


	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,57,29,61,0],[29,62,29,74,0],[31,3,31,34,0],[34,3,34,4,0],[35,4,35,43,0],[36,4,36,5,0],[37,5,37,52,0],[38,4,38,5,0],[40,4,40,5,0],[41,5,41,30,0],[42,5,42,29,0],[43,4,43,5,0],[44,3,44,4,0],[47,3,47,4,0],[48,4,48,27,0],[49,4,49,30,0],[51,4,51,66,0],[53,4,53,36,0],[57,4,57,43,0],[58,4,58,5,0],[62,4,62,5,0],[64,4,64,5,0],[66,5,66,12,0],[66,14,66,54,0],[66,55,66,57,0],[66,58,66,80,0],[67,5,67,6,0],[68,6,68,43,0],[69,6,69,35,0],[71,6,71,7,0],[73,7,73,117,0],[75,7,75,69,0],[76,7,76,90,0],[77,7,77,32,0],[78,7,78,8,0],[79,8,79,64,0],[80,8,80,30,0],[82,8,82,24,0],[83,8,83,9,0],[84,9,84,48,0],[85,9,85,10,0],[86,10,86,47,0],[87,10,87,11,0],[88,11,88,149,0],[89,10,89,11,0],[90,9,90,10,0],[91,8,91,9,0],[94,8,94,56,0],[95,8,95,26,0],[96,8,96,33,0],[97,8,97,41,0],[99,8,99,194,0],[103,7,103,8,0],[105,7,105,8,0],[106,8,106,143,0],[107,7,107,8,0],[109,6,109,7,0],[110,6,110,38,0],[111,6,111,7,0],[112,7,112,117,0],[113,6,113,7,0],[114,5,114,6,0],[115,4,115,5,0],[116,3,116,4,0],[118,3,118,4,0],[120,4,120,25,0],[121,4,121,5,0],[122,5,122,49,0],[123,5,123,6,0],[124,6,124,41,0],[125,5,125,6,0],[127,5,127,6,0],[129,9,129,53,0],[130,13,130,112,0],[132,13,132,85,0],[134,28,134,79,0],[135,21,135,22,0],[136,32,136,95,0],[137,25,137,26,0],[138,29,138,73,0],[139,29,139,74,0],[140,29,140,72,0],[141,29,141,55,0],[142,25,142,26,0],[143,21,143,22,0],[144,5,144,6,0],[145,4,145,5,0],[147,3,147,4,0]]);
    </script>
  </body>
</html>