<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\MultiNodeTreePicker\MNTP_PrevalueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using ClientDependency.Core;
using umbraco.cms.businesslogic.datatype;
using umbraco.interfaces;
using umbraco.uicontrols.TreePicker;
using Constants = Umbraco.Core.Constants;

namespace umbraco.editorControls.MultiNodeTreePicker
{
    /// &lt;summary&gt;
    /// The pre-value editor for the multi node tree picker.
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class MNTP_PrevalueEditor : Control, IDataPrevalue
    {
        private readonly umbraco.cms.businesslogic.datatype.BaseDataType m_DataType;
        private static readonly object Locker = new object();
        private SortedList m_PreValues = null;

        #region Public properties

        /// &lt;summary&gt;
        /// The chosen tree type to render
        /// &lt;/summary&gt;
        public string SelectedTreeType
        {
            get
            {
                return GetPreValue(PropertyIndex.TreeType, x =&gt; x.Value, Constants.Applications.Content);
            }
        }

        /// &lt;summary&gt;
        /// An xpath filter to disable nodes to be selectable
        /// &lt;/summary&gt;
        public string XPathFilter
        {
            get
            {
                return GetPreValue(PropertyIndex.XPathFilter, x =&gt; x.Value, string.Empty);
            }
        }

        /// &lt;summary&gt;
        /// The number of nodes this picker will support picking
        /// &lt;/summary&gt;
        public int MaxNodeCount
        {
            get
            {
                return GetPreValue(PropertyIndex.MaxNodeCount, x =&gt;
                {
                    var max = -1;
                    return int.TryParse(x.Value, out max) ? max : -1;
                }, -1);
            }
        }

        /// &lt;summary&gt;
        /// The minimum number of nodes this picker will support picking
        /// &lt;/summary&gt;
        public int MinNodeCount
        {
            get
            {
                return GetPreValue(PropertyIndex.MinNodeCount, x =&gt;
                {
                    var min = 0;
                    return int.TryParse(x.Value, out min) ? min : 0;
                }, 0);
            }
        }

        /// &lt;summary&gt;
        /// A boolean value indicating whether or not to show the informational tool tips 
        /// &lt;/summary&gt;
        public bool ShowToolTip
        {
            get
            {
                return GetPreValue(PropertyIndex.ShowToolTip, x =&gt;
                {
                    var show = true;
                    return bool.TryParse(x.Value, out show) ? show : true;
                }, true);

            }
        }

        /// &lt;summary&gt;
        /// Value to check if the data should be stored as CSV or XML
        /// &lt;/summary&gt;
        public bool StoreAsCommaDelimited
        {
            get
            {
                return GetPreValue(PropertyIndex.StoreAsCommaDelimited, x =&gt;
                {
                    var asComma = 0;
                    return int.TryParse(x.Value, out asComma) ? asComma == 1 : false;
                }, false);

            }
        }

        /// &lt;summary&gt;
        /// The XPath expression used when the node type selection is Xpath
        /// &lt;/summary&gt;
        public string StartNodeXPathExpression
        {
            get
            {
                return GetPreValue(PropertyIndex.StartNodeXPathExpression, x =&gt; x.Value, string.Empty);
            }
        }

        /// &lt;summary&gt;
        /// The type of xpath expression used for the xpathexpressiontext if using an xpath node selection
        /// &lt;/summary&gt;
        public XPathExpressionType StartNodeXPathExpressionType
        {
            get
            {
                return GetPreValue(PropertyIndex.StartNodeXPathExpressionType,
                    x =&gt; (XPathExpressionType)Enum.ToObject(typeof(XPathExpressionType), int.Parse(x.Value)),
                    XPathExpressionType.Global);
            }
        }

        /// &lt;summary&gt;
        /// The type of selection type to use for the start node
        /// &lt;/summary&gt;
        public NodeSelectionType StartNodeSelectionType
        {
            get
            {
                return GetPreValue(PropertyIndex.StartNodeSelectionType,
                    x =&gt; (NodeSelectionType)Enum.ToObject(typeof(NodeSelectionType), int.Parse(x.Value)),
                    NodeSelectionType.Picker);
            }
        }

        /// &lt;summary&gt;
        /// The type of xpath filter applied
        /// &lt;/summary&gt;
        public XPathFilterType XPathFilterMatchType
        {
            get
            {
                return GetPreValue(PropertyIndex.XPathFilterType,
                    x =&gt; (XPathFilterType)Enum.ToObject(typeof(XPathFilterType), int.Parse(x.Value)),
                    XPathFilterType.Disable);
            }
        }

        /// &lt;summary&gt;
        /// The start node id used when the node selection is a picker
        /// &lt;/summary&gt;
        public int StartNodeId
        {
            get
            {
                return GetPreValue(PropertyIndex.StartNodeId, x =&gt;
                {
                    var max = 0;
                    return int.TryParse(x.Value, out max) ? max : uQuery.RootNodeId;
                }, uQuery.RootNodeId);
            }
        }

        /// &lt;summary&gt;
        /// A boolean value indicating whether or not to show the thumbnails for media 
        /// &lt;/summary&gt;
        public bool ShowThumbnailsForMedia
        {
            get
            {
                return GetPreValue(PropertyIndex.ShowThumbnails, x =&gt;
                {
                    var show = true;
                    bool.TryParse(x.Value, out show);
                    return show;
                }, true);
            }
        }

        ///&lt;summary&gt;
        /// Returns the control height in pixels
        ///&lt;/summary&gt;
        public int ControlHeight
        {
            get
            {
                return GetPreValue(PropertyIndex.ControlHeight, x =&gt;
                {
                    var max = 0;
                    return int.TryParse(x.Value, out max) ? max : 200;
                }, 200);
            }
        }

        #endregion

        #region Protected properties

        /// &lt;summary&gt;
        /// The control height text box
        /// &lt;/summary&gt;
        protected TextBox ControlHeightTextBox;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected RadioButtonList StartNodeSelectionTypeRadioButtons;

        /// &lt;summary&gt;
        /// The start node id content picker
        /// &lt;/summary&gt;
        protected SimpleContentPicker StartContentNodeIdPicker;

        /// &lt;summary&gt;
        /// The start node id media picker
        /// &lt;/summary&gt;
        protected SimpleMediaPicker StartMediaNodeIdPicker;

        /// &lt;summary&gt;
        /// XPath expression type radio button list
        /// &lt;/summary&gt;
        protected RadioButtonList StartNodeXPathExpressionTypeRadioButtons;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected TextBox StartNodeXPathExpressionTextBox;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected CheckBox ShowThumbnailsForMediaCheckBox;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected DropDownList TreeTypeDropDown;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected TextBox XPathFilterTextBox;

        /// &lt;summary&gt;
        /// Text box for maximum amount of items
        /// &lt;/summary&gt;
        protected TextBox MaxItemsTextBox;

        /// &lt;summary&gt;
        /// Text box for minimum amount of items
        /// &lt;/summary&gt;
        protected TextBox MinItemsTextBox;

        /// &lt;summary&gt;
        /// Minimum items validator
        /// &lt;/summary&gt;
        protected RegularExpressionValidator NumbersMinItemsValidator;

        /// &lt;summary&gt;
        /// Validator for validating relative xpath expressions
        /// &lt;/summary&gt;
        protected CustomValidator RelativeXpathValidator;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected RegularExpressionValidator NumbersMaxItemsValidator;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected RegularExpressionValidator ControlHeightValidatator;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected CheckBox ShowItemInfoTooltipCheckBox;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected RadioButtonList StoreAsCommaDelimitedRadioButtons;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        protected RadioButtonList XPathFilterTypeRadioButtons;

        #endregion

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;MNTP_PrevalueEditor&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataType&quot;&gt;Type of the data.&lt;/param&gt;
        public MNTP_PrevalueEditor(umbraco.cms.businesslogic.datatype.BaseDataType dataType)
        {
            this.m_DataType = dataType;
        }

        /// &lt;summary&gt;
        /// Override on init to ensure child controls
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;An &lt;see cref=&quot;T:System.EventArgs&quot;/&gt; object that contains the event data.&lt;/param&gt;
        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);
            this.EnsureChildControls();

            this.RegisterEmbeddedClientResource(&quot;umbraco.editorControls.PrevalueEditor.css&quot;, ClientDependencyType.Css);
        }

        /// &lt;summary&gt;
        /// Ensures the css to render this control is included.
        /// Binds the saved value to the drop down.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            //add the css required
            //// this.AddCssMNTPClientDependencies();

            //let view state handle the rest
            if (!Page.IsPostBack)
            {
                TreeTypeDropDown.SelectedValue = SelectedTreeType;
                XPathFilterTextBox.Text = XPathFilter;
                MaxItemsTextBox.Text = MaxNodeCount.ToString();
                ShowItemInfoTooltipCheckBox.Checked = ShowToolTip;
                StoreAsCommaDelimitedRadioButtons.SelectedIndex = StoreAsCommaDelimited ? 1 : 0;
                XPathFilterTypeRadioButtons.SelectedIndex = XPathFilterMatchType == XPathFilterType.Disable ? 0 : 1;
                ShowThumbnailsForMediaCheckBox.Checked = ShowThumbnailsForMedia;

                StartNodeXPathExpressionTextBox.Text = StartNodeXPathExpression;
                StartNodeXPathExpressionTypeRadioButtons.SelectedIndex = StartNodeXPathExpressionType == XPathExpressionType.Global ? 0 : 1;
                StartNodeSelectionTypeRadioButtons.SelectedIndex = StartNodeSelectionType == NodeSelectionType.Picker ? 0 : 1;

                switch (SelectedTreeType.ToLower())
                {
                    case Constants.Applications.Content:
                        StartContentNodeIdPicker.Value = StartNodeId.ToString();
                        break;
                    case Constants.Applications.Media:
                    default:
                        StartMediaNodeIdPicker.Value = StartNodeId.ToString();
                        break;
                }

                ControlHeightTextBox.Text = ControlHeight.ToString();
                MinItemsTextBox.Text = MinNodeCount.ToString();
            }


        }

        /// &lt;summary&gt;
        /// Creates child controls for this control
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            base.CreateChildControls();


            TreeTypeDropDown = new DropDownList { ID = &quot;TreeTypeList&quot; };
            TreeTypeDropDown.Items.Add(new ListItem(&quot;Content&quot;, Constants.Applications.Content));
            TreeTypeDropDown.Items.Add(new ListItem(&quot;Media&quot;, Constants.Applications.Media));
            TreeTypeDropDown.AutoPostBack = true;
            AddPreValueRow(MNTPResources.Lbl_SelectTreeType, &quot;&quot;, TreeTypeDropDown);


            StartNodeSelectionTypeRadioButtons = new RadioButtonList { ID = &quot;NodeSelectionTypeRadioButtons&quot; };
            StartNodeSelectionTypeRadioButtons.Items.Add(MNTPResources.Item_NodeSelectionType_Picker);
            StartNodeSelectionTypeRadioButtons.Items.Add(new ListItem(MNTPResources.Item_NodeSelectionType_XPath, MNTPResources.Item_NodeSelectionType_XPath.Replace(&quot; &quot;, &quot;&quot;)));
            StartNodeSelectionTypeRadioButtons.RepeatDirection = RepeatDirection.Horizontal;
            StartNodeSelectionTypeRadioButtons.AutoPostBack = true;
            AddPreValueRow(MNTPResources.Lbl_NodeSelectionType, MNTPResources.Desc_NodeSelectionType, StartNodeSelectionTypeRadioButtons);


            StartContentNodeIdPicker = new SimpleContentPicker { ID = &quot;StartNodeIdTextBox&quot; };
            AddPreValueRow(MNTPResources.Lbl_StartNodeId, MNTPResources.Desc_StartNodeId, StartContentNodeIdPicker);

            StartMediaNodeIdPicker = new SimpleMediaPicker { ID = &quot;StartMediaNodeIdPicker&quot; };
            AddPreValueRow(MNTPResources.Lbl_StartNodeId, MNTPResources.Desc_StartNodeId, StartMediaNodeIdPicker);


            ShowThumbnailsForMediaCheckBox = new CheckBox { ID = &quot;ShowThumbnailsForMedia&quot; };
            AddPreValueRow(MNTPResources.Lbl_ShowThumbnails, MNTPResources.Desc_ShowThumbnails, ShowThumbnailsForMediaCheckBox);

            StartNodeXPathExpressionTypeRadioButtons = new RadioButtonList { ID = &quot;XPathExpressionTypeRadioButtons&quot; };
            StartNodeXPathExpressionTypeRadioButtons.Items.Add(MNTPResources.Item_XPathExpressionType_Global);
            StartNodeXPathExpressionTypeRadioButtons.Items.Add(new ListItem(MNTPResources.Item_XPathExpressionType_CurrentNode, MNTPResources.Item_XPathExpressionType_CurrentNode.Replace(&quot; &quot;, &quot;&quot;)));
            StartNodeXPathExpressionTypeRadioButtons.RepeatDirection = RepeatDirection.Horizontal;
            AddPreValueRow(MNTPResources.Lbl_XPathExpressionType, MNTPResources.Desc_XPathExpressionType, StartNodeXPathExpressionTypeRadioButtons);

            StartNodeXPathExpressionTextBox = new TextBox { ID = &quot;XPathExpressionTextBox&quot;, Width = Unit.Pixel(400) };
            RelativeXpathValidator = new CustomValidator()
                                         {
                                             ID = &quot;RelativeXpathValidator&quot;,
                                             ControlToValidate = &quot;XPathExpressionTextBox&quot;,
                                             ErrorMessage = MNTPResources.Val_RelativeXpath,
                                             CssClass = &quot;validator&quot;
                                         };
            RelativeXpathValidator.ServerValidate += new ServerValidateEventHandler(RelativeXpathValidator_ServerValidate);
            AddPreValueRow(MNTPResources.Lbl_XPathExpression, MNTPResources.Desc_XPathExpression, StartNodeXPathExpressionTextBox, RelativeXpathValidator);

            XPathFilterTypeRadioButtons = new RadioButtonList { ID = &quot;XPathMatchTypeRadioButtons&quot; };
            XPathFilterTypeRadioButtons.Items.Add(MNTPResources.Item_XPathMatchType_Disable);
            XPathFilterTypeRadioButtons.Items.Add(MNTPResources.Item_XPathMatchType_Enable);
            XPathFilterTypeRadioButtons.RepeatDirection = RepeatDirection.Horizontal;
            AddPreValueRow(MNTPResources.Lbl_XPathFilterType, MNTPResources.Desc_XPathFilterType, XPathFilterTypeRadioButtons);

            XPathFilterTextBox = new TextBox { ID = &quot;XPathFilter&quot;, Width = Unit.Pixel(400) };
            AddPreValueRow(MNTPResources.Lbl_XPathFilter, MNTPResources.Desc_XPathFilter, XPathFilterTextBox);

            MaxItemsTextBox = new TextBox { ID = &quot;MaxItemsCount&quot;, Width = Unit.Pixel(50) };
            NumbersMaxItemsValidator = new RegularExpressionValidator
                {
                    ID = &quot;NumbersMaxItemsValidator&quot;,
                    ControlToValidate = &quot;MaxItemsCount&quot;,
                    CssClass = &quot;validator&quot;,
                    ErrorMessage = MNTPResources.Val_MaxItemsMsg,
                    ValidationExpression = @&quot;^-{0,1}\d*\.{0,1}\d+$&quot;
                };
            AddPreValueRow(MNTPResources.Lbl_MaxItemsAllowed, MNTPResources.Desc_MaxItemsAllowed, MaxItemsTextBox, NumbersMaxItemsValidator);

            MinItemsTextBox = new TextBox { ID = &quot;MinItemsCount&quot;, Width = Unit.Pixel(50) };
            NumbersMinItemsValidator = new RegularExpressionValidator
            {
                ID = &quot;NumbersMinItemsValidator&quot;,
                ControlToValidate = &quot;MinItemsCount&quot;,
                CssClass = &quot;validator&quot;,
                ErrorMessage = MNTPResources.Val_MinItemsMsg,
                ValidationExpression = @&quot;^\d{1,3}$&quot;
            };
            AddPreValueRow(MNTPResources.Lbl_MinItemsAllowed, MNTPResources.Desc_MinItemsAllowed, MinItemsTextBox, NumbersMinItemsValidator);

            ShowItemInfoTooltipCheckBox = new CheckBox { ID = &quot;ShowItemInfoTooltipCheckBox&quot; };
            AddPreValueRow(MNTPResources.Lbl_ShowItemInfoTooltipCheckBox, MNTPResources.Desc_ShowTooltips, ShowItemInfoTooltipCheckBox);

            StoreAsCommaDelimitedRadioButtons = new RadioButtonList { ID = &quot;StoreAsCommaDelimitedRadioButtons&quot; };
            StoreAsCommaDelimitedRadioButtons.Items.Add(&quot;XML&quot;);
            StoreAsCommaDelimitedRadioButtons.Items.Add(&quot;CSV&quot;);
            StoreAsCommaDelimitedRadioButtons.RepeatDirection = RepeatDirection.Horizontal;
            AddPreValueRow(MNTPResources.Lbl_StoreAsComma, MNTPResources.Desc_StoreAsComma, StoreAsCommaDelimitedRadioButtons);

            ControlHeightTextBox = new TextBox() { ID = &quot;ControlHeightTextBox&quot;, Width = Unit.Pixel(50) };
            ControlHeightValidatator = new RegularExpressionValidator
                {
                    ID = &quot;ControlHeightValidator&quot;,
                    ControlToValidate = &quot;ControlHeightTextBox&quot;,
                    CssClass = &quot;validator&quot;,
                    ErrorMessage = MNTPResources.Val_ControlHeightMsg,
                    ValidationExpression = @&quot;^\d{1,3}$&quot;
                };
            AddPreValueRow(MNTPResources.Lbl_ControlHeight, &quot;&quot;, ControlHeightTextBox, ControlHeightValidatator);
        }

        void RelativeXpathValidator_ServerValidate(object source, ServerValidateEventArgs args)
        {
            args.IsValid = true;
            if (TreeTypeDropDown.SelectedIndex == 0 &amp;&amp; StartNodeXPathExpressionTypeRadioButtons.SelectedIndex == 1 &amp;&amp; StartNodeXPathExpressionTextBox.Text.StartsWith(&quot;/&quot;))
            {
                args.IsValid = false;
            }
        }

        /// &lt;summary&gt;
        /// Helper method to add a server side pre value row
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;lbl&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;description&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;ctl&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// Using server side syntax because of the post backs and because i don&#39;t want to manage the view state manually
        /// &lt;/remarks&gt;
        private void AddPreValueRow(string lbl, string description, params Control[] ctl)
        {
            var div = new HtmlGenericControl(&quot;div&quot;);
            div.Attributes.Add(&quot;class&quot;, &quot;row clearfix&quot;);
            var label = new HtmlGenericControl(&quot;div&quot;);
            label.Attributes.Add(&quot;class&quot;, &quot;label&quot;);
            var span = new HtmlGenericControl(&quot;span&quot;);
            span.InnerText = lbl;
            label.Controls.Add(span);
            var field = new HtmlGenericControl(&quot;div&quot;);
            field.Attributes.Add(&quot;class&quot;, &quot;field&quot;);
            foreach (var c in ctl)
            {
                field.Controls.Add(c);
            }
            div.Controls.Add(label);
            div.Controls.Add(field);

            if (!string.IsNullOrEmpty(description))
            {
                var desc = new HtmlGenericControl(&quot;div&quot;);
                var descSpan = new HtmlGenericControl(&quot;span&quot;);
                descSpan.InnerHtml = description;
                desc.Attributes.Add(&quot;class&quot;, &quot;description&quot;);
                desc.Controls.Add(descSpan);
                div.Controls.Add(desc);
            }

            this.Controls.Add(div);
        }

        /// &lt;summary&gt;
        /// Hides/Shows controls based on the selection of other controls
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            //we can only show the node selection type based on content
            if (TreeTypeDropDown.SelectedIndex == 0)
            {
                this.StartNodeSelectionTypeRadioButtons.Parent.Parent.Visible = true;
            }
            else
            {
                this.StartNodeSelectionTypeRadioButtons.Parent.Parent.Visible = false;
            }

            //if media is selected, or the node type selection is a picker type
            if (TreeTypeDropDown.SelectedIndex == 1 || StartNodeSelectionTypeRadioButtons.SelectedIndex == 0)
            {
                StartNodeXPathExpressionTypeRadioButtons.Parent.Parent.Visible = false;
                StartNodeXPathExpressionTextBox.Parent.Parent.Visible = false;

                switch (TreeTypeDropDown.SelectedIndex)
                {
                    case 0:
                        //content selected
                        StartContentNodeIdPicker.Parent.Parent.Visible = true;

                        StartMediaNodeIdPicker.Parent.Parent.Visible = false;
                        ShowThumbnailsForMediaCheckBox.Parent.Parent.Visible = false;
                        break;
                    case 1:
                    default:
                        //media selected:
                        StartContentNodeIdPicker.Parent.Parent.Visible = false;

                        StartMediaNodeIdPicker.Parent.Parent.Visible = true;
                        ShowThumbnailsForMediaCheckBox.Parent.Parent.Visible = true;
                        break;
                }

            }
            else
            {
                //since it&#39;s an xpath expression, not node picker, hide all node pickers
                StartContentNodeIdPicker.Parent.Parent.Visible = false;
                StartMediaNodeIdPicker.Parent.Parent.Visible = false;
                ShowThumbnailsForMediaCheckBox.Parent.Parent.Visible = false;

                StartNodeXPathExpressionTypeRadioButtons.Parent.Parent.Visible = true;
                StartNodeXPathExpressionTextBox.Parent.Parent.Visible = true;
            }
        }

        /// &lt;summary&gt;
        /// render our own custom markup
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;writer&quot;&gt;The &lt;see cref=&quot;T:System.Web.UI.HtmlTextWriter&quot;/&gt; object that receives the server control content.&lt;/param&gt;
        protected override void Render(HtmlTextWriter writer)
        {
            writer.AddAttribute(HtmlTextWriterAttribute.Class, &quot;PrevalueEditor&quot;);
            writer.RenderBeginTag(HtmlTextWriterTag.Div); //start &#39;PrevalueEditor&#39;

            base.Render(writer);

            writer.RenderEndTag(); //end &#39;PrevalueEditor&#39;

        }

        /// &lt;summary&gt;
        /// Lazy loads the prevalues for this data type
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private SortedList GetPreValues()
        {
            if (m_PreValues == null)
            {
                m_PreValues = PreValues.GetPreValues(m_DataType.DataTypeDefinitionId);
            }
            return m_PreValues;
        }

        #region IDataPrevalue Members

        ///&lt;summary&gt;
        /// returns this as it&#39;s own editor
        ///&lt;/summary&gt;
        public Control Editor
        {
            get { return this; }
        }

        /// &lt;summary&gt;
        /// Saves data to Umbraco
        /// &lt;/summary&gt;
        public void Save()
        {
            if (!Page.IsValid) { return; }

            //it will always be text since people may save a huge amount of selected nodes and serializing to xml could be large.
            m_DataType.DBType = umbraco.cms.businesslogic.datatype.DBTypes.Ntext;

            //need to lock this operation since multiple inserts are happening and if 2 threads reach here at the same time, there 
            //could be issues.
            lock (Locker)
            {
                var vals = GetPreValues();

                //store the tree type
                SavePreValue(PropertyIndex.TreeType, TreeTypeDropDown.SelectedValue, vals);

                //store the xpath
                SavePreValue(PropertyIndex.XPathFilter, XPathFilterTextBox.Text, vals);

                //store the max node count
                SavePreValue(PropertyIndex.MaxNodeCount, string.IsNullOrEmpty(MaxItemsTextBox.Text) ? &quot;-1&quot; : MaxItemsTextBox.Text, vals);

                //store the &#39;show tooltips&#39;
                SavePreValue(PropertyIndex.ShowToolTip, ShowItemInfoTooltipCheckBox.Checked.ToString(), vals);

                //store the &#39;as comma&#39;
                SavePreValue(PropertyIndex.StoreAsCommaDelimited, StoreAsCommaDelimitedRadioButtons.SelectedIndex.ToString(), vals);

                //the xpath filter type
                SavePreValue(PropertyIndex.XPathFilterType, XPathFilterTypeRadioButtons.SelectedIndex.ToString(), vals);

                //based on the media type selected, we need to get the correct start node id
                //from the correct control.
                var startNodeId = -1;
                switch (TreeTypeDropDown.SelectedIndex)
                {
                    case 0:
                        int.TryParse(StartContentNodeIdPicker.Value, out startNodeId);
                        break;
                    case 1:
                    default:
                        int.TryParse(StartMediaNodeIdPicker.Value, out startNodeId);
                        break;
                }

                //store the start node id
                SavePreValue(PropertyIndex.StartNodeId, startNodeId.ToString(), vals);

                //store the &#39;show thumbnails&#39;
                SavePreValue(PropertyIndex.ShowThumbnails, ShowThumbnailsForMediaCheckBox.Checked.ToString(), vals);

                //store the &#39;node selection type&#39;
                SavePreValue(PropertyIndex.StartNodeSelectionType, StartNodeSelectionTypeRadioButtons.SelectedIndex.ToString(), vals);

                //store the &#39;xpath expression type&#39;
                SavePreValue(PropertyIndex.StartNodeXPathExpressionType, StartNodeXPathExpressionTypeRadioButtons.SelectedIndex.ToString(), vals);

                //save the &#39;xpath expression&#39;
                SavePreValue(PropertyIndex.StartNodeXPathExpression, StartNodeXPathExpressionTextBox.Text, vals);

                //save the control height
                SavePreValue(PropertyIndex.ControlHeight, ControlHeightTextBox.Text, vals);

                //save the min amount
                SavePreValue(PropertyIndex.MinNodeCount, MinItemsTextBox.Text, vals);
            }

            //once everything is saved, clear the cookie vals
            MNTP_DataType.ClearCookiePersistence();

        }

        /// &lt;summary&gt;
        /// Used to determine the index number of where the property is saved in the pre values repository
        /// &lt;/summary&gt;
        private enum PropertyIndex
        {
            TreeType,
            XPathFilter,
            MaxNodeCount,
            ShowToolTip,
            StoreAsCommaDelimited,
            XPathFilterType,
            StartNodeId,
            ShowThumbnails,
            StartNodeSelectionType,
            StartNodeXPathExpressionType,
            StartNodeXPathExpression,
            ControlHeight,
            MinNodeCount
        }

        /// &lt;summary&gt;
        /// Helper method to save/create pre value values in the db
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;propIndex&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;currentVals&quot;&gt;&lt;/param&gt;
        private void SavePreValue(PropertyIndex propIndex, string value, SortedList currentVals)
        {
            var index = (int)propIndex;
            if (currentVals.Count &gt;= ((int)propIndex + 1))
            {
                //update
                ((PreValue)currentVals[index]).Value = value;
                ((PreValue)currentVals[index]).Save();
            }
            else
            {
                //insert
                PreValue.MakeNew(m_DataType.DataTypeDefinitionId, value);
            }
        }

        ///&lt;summary&gt;
        /// Generic method to return a strongly typed object from the pre value bucket
        ///&lt;/summary&gt;
        ///&lt;param name=&quot;index&quot;&gt;&lt;/param&gt;
        ///&lt;param name=&quot;output&quot;&gt;&lt;/param&gt;
        ///&lt;param name=&quot;defaultVal&quot;&gt;&lt;/param&gt;
        ///&lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        ///&lt;returns&gt;&lt;/returns&gt;
        private T GetPreValue&lt;T&gt;(PropertyIndex index, Func&lt;PreValue, T&gt; output, T defaultVal)
        {
            var vals = GetPreValues();
            return vals.Count &gt;= (int)index + 1 ? output((PreValue)vals[(int)index]) : defaultVal;
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,62,0],[22,9,22,47,0],[32,13,32,14,0],[33,17,33,65,0],[33,65,33,72,0],[33,72,33,106,0],[33,17,33,106,0],[34,13,34,14,0],[43,13,43,14,0],[44,17,44,68,0],[44,68,44,75,0],[44,75,44,91,0],[44,17,44,91,0],[45,13,45,14,0],[54,13,54,14,0],[55,17,56,17,0],[56,17,56,18,0],[56,18,57,21,0],[57,21,57,34,0],[57,34,58,21,0],[58,21,58,70,0],[58,70,59,17,0],[59,17,59,18,0],[59,18,59,24,0],[55,17,59,24,0],[60,13,60,14,0],[69,13,69,14,0],[70,17,71,17,0],[71,17,71,18,0],[71,18,72,21,0],[72,21,72,33,0],[72,33,73,21,0],[73,21,73,69,0],[73,69,74,17,0],[74,17,74,18,0],[74,18,74,23,0],[70,17,74,23,0],[75,13,75,14,0],[84,13,84,14,0],[85,17,86,17,0],[86,17,86,18,0],[86,18,87,21,0],[87,21,87,37,0],[87,37,88,21,0],[88,21,88,75,0],[88,75,89,17,0],[89,17,89,18,0],[89,18,89,26,0],[85,17,89,26,0],[91,13,91,14,0],[100,13,100,14,0],[101,17,102,17,0],[102,17,102,18,0],[102,18,103,21,0],[103,21,103,37,0],[103,37,104,21,0],[104,21,104,86,0],[104,86,105,17,0],[105,17,105,18,0],[105,18,105,27,0],[101,17,105,27,0],[107,13,107,14,0],[116,13,116,14,0],[117,17,117,81,0],[117,81,117,88,0],[117,88,117,104,0],[117,17,117,104,0],[118,13,118,14,0],[127,13,127,14,0],[128,17,129,26,0],[129,26,129,109,0],[129,109,130,49,0],[128,17,130,49,0],[131,13,131,14,0],[140,13,140,14,0],[141,17,142,26,0],[142,26,142,105,0],[142,105,143,47,0],[141,17,143,47,0],[144,13,144,14,0],[153,13,153,14,0],[154,17,155,26,0],[155,26,155,101,0],[155,101,156,46,0],[154,17,156,46,0],[157,13,157,14,0],[166,13,166,14,0],[167,17,168,17,0],[168,17,168,18,0],[168,18,169,21,0],[169,21,169,33,0],[169,33,170,21,0],[170,21,170,85,0],[170,85,171,17,0],[171,17,171,18,0],[171,18,171,39,0],[167,17,171,39,0],[172,13,172,14,0],[181,13,181,14,0],[182,17,183,17,0],[183,17,183,18,0],[183,18,184,21,0],[184,21,184,37,0],[184,37,185,21,0],[185,21,185,54,0],[185,54,186,21,0],[186,21,186,33,0],[186,33,187,17,0],[187,17,187,18,0],[187,18,187,26,0],[182,17,187,26,0],[188,13,188,14,0],[197,13,197,14,0],[198,17,199,17,0],[199,17,199,18,0],[199,18,200,21,0],[200,21,200,33,0],[200,33,201,21,0],[201,21,201,71,0],[201,71,202,17,0],[202,17,202,18,0],[202,18,202,25,0],[198,17,202,25,0],[203,13,203,14,0],[306,9,306,93,0],[307,9,307,10,0],[308,13,308,40,0],[309,9,309,10,0],[316,9,316,10,0],[317,13,317,28,0],[318,13,318,40,0],[320,13,320,120,0],[321,9,321,10,0],[329,9,329,10,0],[330,13,330,28,0],[336,13,336,34,0],[337,13,337,14,0],[338,17,338,67,0],[339,17,339,55,0],[340,17,340,64,0],[341,17,341,67,0],[342,17,342,97,0],[343,17,343,117,0],[344,17,344,81,0],[346,17,346,81,0],[347,17,347,141,0],[348,17,348,127,0],[350,17,350,52,0],[353,25,353,81,0],[354,25,354,31,0],[357,25,357,79,0],[358,25,358,31,0],[361,17,361,70,0],[362,17,362,64,0],[363,13,363,14,0],[366,9,366,10,0],[372,9,372,10,0],[373,13,373,40,0],[376,13,376,73,0],[377,13,377,97,0],[378,13,378,93,0],[379,13,379,50,0],[380,13,380,84,0],[383,13,383,111,0],[384,13,384,103,0],[385,13,385,177,0],[386,13,386,93,0],[387,13,387,68,0],[388,13,388,139,0],[391,13,391,94,0],[392,13,392,117,0],[394,13,394,94,0],[395,13,395,115,0],[398,13,398,93,0],[399,13,399,129,0],[401,13,401,119,0],[402,13,402,111,0],[403,13,403,199,0],[404,13,404,99,0],[405,13,405,149,0],[407,13,407,118,0],[408,13,414,44,0],[415,13,415,124,0],[416,13,416,156,0],[418,13,418,101,0],[419,13,419,94,0],[420,13,420,93,0],[421,13,421,86,0],[422,13,422,128,0],[424,13,424,94,0],[425,13,425,111,0],[427,13,427,92,0],[428,13,435,19,0],[436,13,436,142,0],[438,13,438,92,0],[439,13,446,15,0],[447,13,447,142,0],[449,13,449,95,0],[450,13,450,137,0],[452,13,452,114,0],[453,13,453,64,0],[454,13,454,64,0],[455,13,455,92,0],[456,13,456,128,0],[458,13,458,106,0],[459,13,466,19,0],[467,13,467,113,0],[468,9,468,10,0],[471,9,471,10,0],[472,13,472,33,0],[473,13,473,172,0],[474,13,474,14,0],[475,17,475,38,0],[476,13,476,14,0],[477,9,477,10,0],[489,9,489,10,0],[490,13,490,53,0],[491,13,491,57,0],[492,13,492,55,0],[493,13,493,52,0],[494,13,494,55,0],[495,13,495,34,0],[496,13,496,38,0],[497,13,497,55,0],[498,13,498,52,0],[499,13,499,20,0],[499,22,499,27,0],[499,28,499,30,0],[499,31,499,34,0],[500,13,500,14,0],[501,17,501,39,0],[502,13,502,14,0],[503,13,503,37,0],[504,13,504,37,0],[506,13,506,52,0],[507,13,507,14,0],[508,17,508,58,0],[509,17,509,63,0],[510,17,510,50,0],[511,17,511,61,0],[512,17,512,45,0],[513,17,513,40,0],[514,13,514,14,0],[516,13,516,36,0],[517,9,517,10,0],[524,9,524,10,0],[525,13,525,33,0],[528,13,528,53,0],[529,13,529,14,0],[530,17,530,86,0],[531,13,531,14,0],[533,13,533,14,0],[534,17,534,87,0],[535,13,535,14,0],[538,13,538,110,0],[539,13,539,14,0],[540,17,540,88,0],[541,17,541,79,0],[543,17,543,56,0],[547,25,547,79,0],[549,25,549,78,0],[550,25,550,86,0],[551,25,551,31,0],[555,25,555,80,0],[557,25,557,77,0],[558,25,558,85,0],[559,25,559,31,0],[562,13,562,14,0],[564,13,564,14,0],[566,17,566,72,0],[567,17,567,70,0],[568,17,568,78,0],[570,17,570,87,0],[571,17,571,78,0],[572,13,572,14,0],[573,9,573,10,0],[580,9,580,10,0],[581,13,581,82,0],[582,13,582,58,0],[584,13,584,33,0],[586,13,586,35,0],[588,9,588,10,0],[595,9,595,10,0],[596,13,596,37,0],[597,13,597,14,0],[598,17,598,87,0],[599,13,599,14,0],[600,13,600,32,0],[601,9,601,10,0],[610,17,610,18,0],[610,19,610,31,0],[610,32,610,33,0],[617,9,617,10,0],[618,13,618,31,0],[618,32,618,33,0],[618,34,618,41,0],[621,13,621,82,0],[625,13,625,26,0],[626,13,626,14,0],[627,17,627,43,0],[630,17,630,92,0],[633,17,633,88,0],[636,17,636,138,0],[639,17,639,111,0],[642,17,642,133,0],[645,17,645,121,0],[649,17,649,38,0],[650,17,650,56,0],[653,25,653,87,0],[654,25,654,31,0],[657,25,657,85,0],[658,25,658,31,0],[662,17,662,87,0],[665,17,665,117,0],[668,17,668,135,0],[671,17,671,147,0],[674,17,674,114,0],[677,17,677,92,0],[680,17,680,86,0],[681,13,681,14,0],[684,13,684,52,0],[686,9,686,10,0],[715,9,715,10,0],[716,13,716,40,0],[717,13,717,59,0],[718,13,718,14,0],[720,17,720,62,0],[721,17,721,55,0],[722,13,722,14,0],[724,13,724,14,0],[726,17,726,74,0],[727,13,727,14,0],[728,9,728,10,0],[739,9,739,10,0],[740,13,740,39,0],[741,13,741,99,0],[742,9,742,10,0]]);
    </script>
  </body>
</html>