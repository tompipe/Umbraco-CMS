<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\Default.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Threading;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using System.Web.UI;
using System.IO;
using System.Xml;
using System.Text.RegularExpressions;
using StackExchange.Profiling;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Profiling;
using Umbraco.Web;
using Umbraco.Web.Routing;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Web.Templates;
using umbraco.cms.businesslogic.web;
using umbraco.cms.businesslogic;

namespace umbraco
{
    /// &lt;summary&gt;
    /// The codebehind class for the main default.aspx page that does the webforms rendering in Umbraco
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// We would move this to the UI project but there is a public API property and some protected properties which people may be using so 
    /// we cannot move it.
    /// &lt;/remarks&gt;
    public class UmbracoDefault : Page
    {
        /// &lt;summary&gt;
        /// Simply used to clear temp data
        /// &lt;/summary&gt;
        private class TempDataController : Controller
        {
        }

        private page _upage;
        private PublishedContentRequest _docRequest;
        bool _validateRequest = true;

        /// &lt;summary&gt;
        /// To turn off request validation set this to false before the PageLoad event. This equivalent to the validateRequest page directive
        /// and has nothing to do with &quot;normal&quot; validation controls. Default value is true.
        /// &lt;/summary&gt;
        public bool ValidateRequest
        {
            get { return _validateRequest; }
            set { _validateRequest = value; }
        }

        protected override void OnPreInit(EventArgs e)
        {
            base.OnPreInit(e);
            using (DisposableTimer.DebugDuration&lt;UmbracoDefault&gt;(&quot;PreInit&quot;))
            {

                // handle the infamous umbDebugShowTrace, etc
                Page.Trace.IsEnabled &amp;= GlobalSettings.DebugMode &amp;&amp; string.IsNullOrWhiteSpace(Request[&quot;umbDebugShowTrace&quot;]) == false;

                // get the document request and the page
                _docRequest = UmbracoContext.Current.PublishedContentRequest;
                _upage = _docRequest.UmbracoPage;

                //we need to check this for backwards compatibility in case people still arent&#39; using master pages
                if (UmbracoConfig.For.UmbracoSettings().Templates.UseAspNetMasterPages)
                {
                    var args = new RequestInitEventArgs()
                    {
                        Page = _upage,
                        PageId = _upage.PageID,
                        Context = Context
                    };
                    FireBeforeRequestInit(args);

                    //if we are cancelling then return and don&#39;t proceed
                    if (args.Cancel) return;

                    this.MasterPageFile = template.GetMasterPageName(_upage.Template);

                    // reset the friendly path so it&#39;s used by forms, etc.			
                    Context.RewritePath(UmbracoContext.Current.OriginalRequestUrl.PathAndQuery);

                    //fire the init finished event
                    FireAfterRequestInit(args);
                }
            }
        }

        protected override void OnInit(EventArgs e)
        {
            using (DisposableTimer.DebugDuration&lt;UmbracoDefault&gt;(&quot;Init&quot;))
            {
                base.OnInit(e);

                //This is a special case for webforms since in some cases we may be POSTing to an MVC controller, adding TempData there and then redirecting
                // to a webforms handler. In that case we need to manually clear out the tempdata ourselves since this is normally the function of the base
                // MVC controller instance and since that is not executing, we&#39;ll deal with that here.
                //Unfortunately for us though, we can never know which TempDataProvider was used for the previous controller, by default it is the sessionstateprovider
                // but since the tempdataprovider is not a global mvc thing, it is only a per-controller thing, we can only just assume it will be the sessionstateprovider
                var provider = new SessionStateTempDataProvider();
                //We create a custom controller context, the only thing that is referenced from this controller context in the sessionstateprovider is the HttpContext.Session
                // so we just need to ensure that is set
                var ctx = new ControllerContext(new HttpContextWrapper(Context), new RouteData(), new TempDataController());
                provider.LoadTempData(ctx);

                //This is only here for legacy if people arent&#39; using master pages... 
                //TODO: We need to test that this still works!! Or do we ??
                if (!UmbracoConfig.For.UmbracoSettings().Templates.UseAspNetMasterPages)
                {
                    var args = new RequestInitEventArgs()
                                   {
                                       Page = _upage,
                                       PageId = _upage.PageID,
                                       Context = Context
                                   };
                    FireBeforeRequestInit(args);

                    //if we are cancelling then return and don&#39;t proceed
                    if (args.Cancel) return;

                    var pageHolder = new umbraco.layoutControls.umbracoPageHolder
                                         {
                                             ID = &quot;umbPageHolder&quot;
                                         };
                    Page.Controls.Add(pageHolder);
                    _upage.RenderPage(_upage.Template);
                    var umbPageHolder = (layoutControls.umbracoPageHolder)Page.FindControl(&quot;umbPageHolder&quot;);
                    umbPageHolder.Populate(_upage);

                    //fire the init finished event
                    FireAfterRequestInit(args);
                }
            }
        }

        protected override void OnLoad(EventArgs e)
        {
            using (DisposableTimer.DebugDuration&lt;UmbracoDefault&gt;(&quot;Load&quot;))
            {
                base.OnLoad(e);
                
                if (ValidateRequest)
                    Request.ValidateInput();
            }
        }

        protected override void Render(HtmlTextWriter writer)
        {
            using (DisposableTimer.DebugDuration&lt;UmbracoDefault&gt;(&quot;Render&quot;))
            {

                // do the original rendering
                TextWriter sw = new StringWriter();
                base.Render(new HtmlTextWriter(sw));
                string text = sw.ToString();

                // filter / parse internal links - although this should be done elsewhere!
                text = TemplateUtilities.ParseInternalLinks(text);

                // filter / add preview banner
                if (UmbracoContext.Current.InPreviewMode)
                {
                    LogHelper.Debug&lt;UmbracoDefault&gt;(&quot;Umbraco is running in preview mode.&quot;, true);

                    if (Response.ContentType.InvariantEquals(&quot;text/html&quot;)) // ASP.NET default value
                    {
                        int pos = text.ToLower().IndexOf(&quot;&lt;/body&gt;&quot;);
                        if (pos &gt; -1)
                        {
                            string htmlBadge =
                                String.Format(UmbracoConfig.For.UmbracoSettings().Content.PreviewBadge,
                                              IOHelper.ResolveUrl(SystemDirectories.Umbraco),
                                              IOHelper.ResolveUrl(SystemDirectories.UmbracoClient),
                                              Server.UrlEncode(UmbracoContext.Current.HttpContext.Request.Path));

                            text = text.Substring(0, pos) + htmlBadge + text.Substring(pos, text.Length - pos);
                        }
                    }
                }

                // render
                writer.Write(text);
            }
        }

        /// &lt;summary&gt;
        /// The preinit event handler
        /// &lt;/summary&gt;
        public delegate void RequestInitEventHandler(object sender, RequestInitEventArgs e);
        /// &lt;summary&gt;
        /// occurs before the umbraco page is initialized for rendering.
        /// &lt;/summary&gt;
        public static event RequestInitEventHandler BeforeRequestInit;
        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;BeforeRequestInit&quot;/&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;System.EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        protected internal virtual void FireBeforeRequestInit(RequestInitEventArgs e)
        {
            if (BeforeRequestInit != null)
                BeforeRequestInit(this, e);
        }

        /// &lt;summary&gt;
        /// Occurs when [after save].
        /// &lt;/summary&gt;
        public static event RequestInitEventHandler AfterRequestInit;
        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;AfterRequestInit&quot;/&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;System.EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        protected virtual void FireAfterRequestInit(RequestInitEventArgs e)
        {
            if (AfterRequestInit != null)
                AfterRequestInit(this, e);

        }
    }

    public class RequestInitEventArgs : System.ComponentModel.CancelEventArgs
    {
        public page Page { get; internal set; }
        public HttpContext Context { get; internal set; }
        public string Url { get; internal set; }
        public int PageId { get; internal set; }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[42,9,42,38,0],[50,17,50,18,0],[50,19,50,43,0],[50,44,50,45,0],[51,17,51,18,0],[51,19,51,44,0],[51,45,51,46,0],[55,9,55,10,0],[56,13,56,31,0],[57,13,57,77,0],[58,13,58,14,0],[61,17,61,134,0],[64,17,64,78,0],[65,17,65,50,0],[68,17,68,88,0],[69,17,69,18,0],[70,21,75,23,0],[76,21,76,49,0],[79,21,79,37,0],[79,38,79,45,0],[81,21,81,87,0],[84,21,84,97,0],[87,21,87,48,0],[88,17,88,18,0],[89,13,89,14,0],[90,9,90,10,0],[93,9,93,10,0],[94,13,94,74,0],[95,13,95,14,0],[96,17,96,32,0],[103,17,103,67,0],[106,17,106,125,0],[107,17,107,44,0],[111,17,111,89,0],[112,17,112,18,0],[113,21,118,38,0],[119,21,119,49,0],[122,21,122,37,0],[122,38,122,45,0],[124,21,127,44,0],[128,21,128,51,0],[129,21,129,56,0],[130,21,130,109,0],[131,21,131,52,0],[134,21,134,48,0],[135,17,135,18,0],[136,13,136,14,0],[137,9,137,10,0],[140,9,140,10,0],[141,13,141,74,0],[142,13,142,14,0],[143,17,143,32,0],[145,17,145,37,0],[146,21,146,45,0],[147,13,147,14,0],[148,9,148,10,0],[151,9,151,10,0],[152,13,152,76,0],[153,13,153,14,0],[156,17,156,52,0],[157,17,157,53,0],[158,17,158,45,0],[161,17,161,67,0],[164,17,164,58,0],[165,17,165,18,0],[166,21,166,98,0],[168,21,168,75,0],[169,21,169,22,0],[170,25,170,69,0],[171,25,171,38,0],[172,25,172,26,0],[173,29,177,114,0],[179,29,179,112,0],[180,25,180,26,0],[181,21,181,22,0],[182,17,182,18,0],[185,17,185,36,0],[186,13,186,14,0],[187,9,187,10,0],[202,9,202,10,0],[203,13,203,43,0],[204,17,204,44,0],[205,9,205,10,0],[216,9,216,10,0],[217,13,217,42,0],[218,17,218,43,0],[220,9,220,10,0],[225,28,225,32,0],[225,33,225,46,0],[226,38,226,42,0],[226,43,226,56,0],[227,29,227,33,0],[227,34,227,47,0],[228,29,228,33,0],[228,34,228,47,0]]);
    </script>
  </body>
</html>