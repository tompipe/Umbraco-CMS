<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\member\MemberGroup.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Linq;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.Querying;
using umbraco.DataLayer;
using System.Collections;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.web;
using Umbraco.Core;

namespace umbraco.cms.businesslogic.member
{
	/// &lt;summary&gt;
	/// Membergroups are used for grouping Umbraco Members
	/// 
	/// A Member can exist in multiple groups.
	/// 
	/// It&#39;s possible to protect webpages/documents by membergroup.
	/// &lt;/summary&gt;
	public class MemberGroup : CMSNode
	{
        private static readonly Guid MemberGroupObjectType = new Guid(Constants.ObjectTypes.MemberGroup);

	    private IMemberGroup _memberGroupItem;

        internal MemberGroup(IMemberGroup memberGroup)
            : base(memberGroup)
        {
            _memberGroupItem = memberGroup;
        }

		/// &lt;summary&gt;
		/// Initialize a new object of the MemberGroup class
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;id&quot;&gt;Membergroup id&lt;/param&gt;
		public MemberGroup(int id): base(id)
		{

		}

		/// &lt;summary&gt;
		/// Initialize a new object of the MemberGroup class
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;id&quot;&gt;Membergroup id&lt;/param&gt;
		public MemberGroup(Guid id) : base(id)
		{
			
		}

        public override string Text
        {
            get
            {
                return _memberGroupItem.Name;
            }
            set
            {
                _memberGroupItem.Name = value;
            }
        }

        /// &lt;summary&gt;
        /// Deltes the current membergroup
        /// &lt;/summary&gt;
        [Obsolete(&quot;Use System.Web.Security.Role.DeleteRole&quot;)]
        public override void delete()
        {
            var e = new DeleteEventArgs();
            FireBeforeDelete(e);
            if (e.Cancel) return;

            if (_memberGroupItem != null)
            {
                ApplicationContext.Current.Services.MemberGroupService.Delete(_memberGroupItem);
            }
            else
            {
                var memberGroup = ApplicationContext.Current.Services.MemberGroupService.GetById(Id);
                ApplicationContext.Current.Services.MemberGroupService.Delete(memberGroup);
            }
            
            // Delete all content and cmsnode specific data!
            base.delete();
            FireAfterDelete(e);
        }


        /// &lt;summary&gt;
        /// Used to persist object changes to the database. In Version3.0 it&#39;s just a stub for future compatibility
        /// &lt;/summary&gt;
        public override void Save()
        {
            var e = new SaveEventArgs();
            FireBeforeSave(e);
            if (e.Cancel) return;

            ApplicationContext.Current.Services.MemberGroupService.Save(_memberGroupItem);

            FireAfterSave(e);
        }

		/// &lt;summary&gt;
		/// Retrieve a list of all existing MemberGroups
		/// &lt;/summary&gt;
		[Obsolete(&quot;Use System.Web.Security.Role.GetAllRoles&quot;)]
        public static MemberGroup[] GetAll 
		{
			get
			{
			    var result = ApplicationContext.Current.Services.MemberGroupService.GetAll();
			    return result.Select(x =&gt; new MemberGroup(x)).ToArray();
			}
		}

	    public int[] GetMembersAsIds()
	    {
            var result = ApplicationContext.Current.Services.MemberService.GetMembersInRole(_memberGroupItem.Name);
	        return result.Select(x =&gt; x.Id).ToArray();
	    }

	    [Obsolete(&quot;Use System.Web.Security.Roles.FindUsersInRole&quot;)]
	    public Member[] GetMembers()
	    {
	        var result = ApplicationContext.Current.Services.MemberService.GetMembersInRole(_memberGroupItem.Name);
            return result.Select(x =&gt; new Member(x)).ToArray();
	    }

	    public Member[] GetMembers(string usernameToMatch)
	    {

	        var result = ApplicationContext.Current.Services.MemberService.FindMembersInRole(
	            _memberGroupItem.Name, usernameToMatch, StringPropertyMatchType.StartsWith);

	        return result.Select(x =&gt; new Member(x)).ToArray();
	    }

	    public bool HasMember(int memberId)
	    {
            using (var sqlHelper = Application.SqlHelper)
                return sqlHelper.ExecuteScalar&lt;int&gt;(&quot;select count(member) from cmsMember2MemberGroup where member = @member and memberGroup = @memberGroup&quot;,
	            sqlHelper.CreateParameter(&quot;@member&quot;, memberId),
	            sqlHelper.CreateParameter(&quot;@memberGroup&quot;, Id)) &gt; 0;
	    }

	    /// &lt;summary&gt;
		/// Get a membergroup by it&#39;s name
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;name&quot;&gt;Name of the membergroup&lt;/param&gt;
		/// &lt;returns&gt;If a MemberGroup with the given name exists, it will return this, else: null&lt;/returns&gt;
        public static MemberGroup GetByName(string name)
	    {
	        var found = ApplicationContext.Current.Services.MemberGroupService.GetByName(name);
	        if (found == null) return null;
            return new MemberGroup(found);
	    }


		/// &lt;summary&gt;
		/// Create a new MemberGroup
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;Name&quot;&gt;The name of the MemberGroup&lt;/param&gt;
		/// &lt;param name=&quot;u&quot;&gt;The creator of the MemberGroup&lt;/param&gt;
		/// &lt;returns&gt;The new MemberGroup&lt;/returns&gt;
		public static MemberGroup MakeNew(string Name, BusinessLogic.User u) 
		{
		    var group = new global::Umbraco.Core.Models.MemberGroup {Name = Name};
		    ApplicationContext.Current.Services.MemberGroupService.Save(group);

            var mg = new MemberGroup(group);
            var e = new NewEventArgs();
            mg.OnNew(e);
            return mg;
		}

	    protected override void setupNode()
	    {
            if (Id == -1)
            {
                base.setupNode();
                return;
            }

            var group = ApplicationContext.Current.Services.MemberGroupService.GetById(Id);

            if (group == null)
                throw new ArgumentException(string.Format(&quot;No Member exists with id &#39;{0}&#39;&quot;, Id));

            SetupNode(group);
        }

        private void SetupNode(IMemberGroup group)
        {
            _memberGroupItem = group;            

            //Setting private properties 
            base.PopulateCMSNodeFromUmbracoEntity(_memberGroupItem, MemberGroupObjectType);
        }

	    //EVENTS
        /// &lt;summary&gt;
        /// The save event handler
        /// &lt;/summary&gt;
        public delegate void SaveEventHandler(MemberGroup sender, SaveEventArgs e);
        /// &lt;summary&gt;
        /// The new event handler
        /// &lt;/summary&gt;
        public delegate void NewEventHandler(MemberGroup sender, NewEventArgs e);
        /// &lt;summary&gt;
        /// The delete event handler
        /// &lt;/summary&gt;
        public delegate void DeleteEventHandler(MemberGroup sender, DeleteEventArgs e);


        /// &lt;summary&gt;
        /// Occurs when a language is saved.
        /// &lt;/summary&gt;
        public new static event SaveEventHandler BeforeSave;
        protected virtual void FireBeforeSave(SaveEventArgs e) {
            if (BeforeSave != null)
                BeforeSave(this, e);
        }

        public new static event SaveEventHandler AfterSave;
        protected new virtual void FireAfterSave(SaveEventArgs e) {
            if (AfterSave != null)
                AfterSave(this, e);
        }

        public static event NewEventHandler New;
        protected virtual void OnNew(NewEventArgs e) {
            if (New != null)
                New(this, e);
        }

        public static event DeleteEventHandler BeforeDelete;
        protected virtual void FireBeforeDelete(DeleteEventArgs e) {
            if (BeforeDelete != null)
                BeforeDelete(this, e);
        }

        public static event DeleteEventHandler AfterDelete;
        protected virtual void FireAfterDelete(DeleteEventArgs e) {
            if (AfterDelete != null)
                AfterDelete(this, e);
        }
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,106,0],[28,15,28,32,0],[29,9,29,10,0],[30,13,30,44,0],[31,9,31,10,0],[37,31,37,39,0],[38,3,38,4,0],[40,3,40,4,0],[46,33,46,41,0],[47,3,47,4,0],[49,3,49,4,0],[54,13,54,14,0],[55,17,55,46,0],[56,13,56,14,0],[58,13,58,14,0],[59,17,59,47,0],[60,13,60,14,0],[68,9,68,10,0],[69,13,69,43,0],[70,13,70,33,0],[71,13,71,26,0],[71,27,71,34,0],[73,13,73,42,0],[74,13,74,14,0],[75,17,75,97,0],[76,13,76,14,0],[78,13,78,14,0],[79,17,79,102,0],[80,17,80,92,0],[81,13,81,14,0],[84,13,84,27,0],[85,13,85,32,0],[86,9,86,10,0],[93,9,93,10,0],[94,13,94,41,0],[95,13,95,31,0],[96,13,96,26,0],[96,27,96,34,0],[98,13,98,91,0],[100,13,100,30,0],[101,9,101,10,0],[110,4,110,5,0],[111,8,111,85,0],[112,8,112,34,0],[112,34,112,52,0],[112,52,112,64,0],[112,8,112,64,0],[113,4,113,5,0],[117,6,117,7,0],[118,13,118,116,0],[119,10,119,36,0],[119,36,119,40,0],[119,40,119,52,0],[119,10,119,52,0],[120,6,120,7,0],[124,6,124,7,0],[125,10,125,113,0],[126,13,126,39,0],[126,39,126,52,0],[126,52,126,64,0],[126,13,126,64,0],[127,6,127,7,0],[130,6,130,7,0],[132,10,133,90,0],[135,10,135,36,0],[135,36,135,49,0],[135,49,135,61,0],[135,10,135,61,0],[136,6,136,7,0],[139,6,139,7,0],[140,20,140,57,0],[141,17,143,65,0],[144,6,144,7,0],[152,6,152,7,0],[153,10,153,93,0],[154,10,154,28,0],[154,29,154,41,0],[155,13,155,43,0],[156,6,156,7,0],[166,3,166,4,0],[167,7,167,77,0],[168,7,168,74,0],[170,13,170,45,0],[171,13,171,40,0],[172,13,172,25,0],[173,13,173,23,0],[174,3,174,4,0],[177,6,177,7,0],[178,13,178,26,0],[179,13,179,14,0],[180,17,180,34,0],[181,17,181,24,0],[184,13,184,92,0],[186,13,186,31,0],[187,17,187,98,0],[189,13,189,30,0],[190,9,190,10,0],[193,9,193,10,0],[194,13,194,38,0],[197,13,197,92,0],[198,9,198,10,0],[219,64,219,65,0],[220,13,220,36,0],[221,17,221,37,0],[222,9,222,10,0],[225,67,225,68,0],[226,13,226,35,0],[227,17,227,36,0],[228,9,228,10,0],[231,54,231,55,0],[232,13,232,29,0],[233,17,233,30,0],[234,9,234,10,0],[237,68,237,69,0],[238,13,238,38,0],[239,17,239,39,0],[240,9,240,10,0],[243,67,243,68,0],[244,13,244,37,0],[245,17,245,38,0],[246,9,246,10,0]]);
    </script>
  </body>
</html>