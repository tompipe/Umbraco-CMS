<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\ContentTypeFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Models.Rdbms;

namespace Umbraco.Core.Persistence.Factories
{
    // factory for
    // IContentType (document types)
    // IMediaType (media types)
    // IMemberType (member types)
    //
    internal class ContentTypeFactory 
    {
        #region IContentType

        public IContentType BuildContentTypeEntity(ContentTypeDto dto)
        {
            var contentType = new ContentType(dto.NodeDto.ParentId);

            try
            {
                contentType.DisableChangeTracking();

                BuildCommonEntity(contentType, dto);

                //on initial construction we don&#39;t want to have dirty properties tracked
                // http://issues.umbraco.org/issue/U4-1946
                contentType.ResetDirtyProperties(false);
                return contentType;
            }
            finally
            {
                contentType.EnableChangeTracking();
            }
        }

        #endregion

        #region IMediaType

        public IMediaType BuildMediaTypeEntity(ContentTypeDto dto)
        {
            var contentType = new MediaType(dto.NodeDto.ParentId);
            try
            {
                contentType.DisableChangeTracking();

                BuildCommonEntity(contentType, dto);

                //on initial construction we don&#39;t want to have dirty properties tracked
                // http://issues.umbraco.org/issue/U4-1946
                contentType.ResetDirtyProperties(false);
            }
            finally
            {
                contentType.EnableChangeTracking();
            }

            return contentType;
        }

        #endregion

        #region IMemberType

        public IMemberType BuildMemberTypeEntity(ContentTypeDto dto)
        {
            throw new NotImplementedException();
        }

        public IEnumerable&lt;MemberTypeDto&gt; BuildMemberTypeDtos(IMemberType entity)
        {
            var memberType = entity as MemberType;
            if (memberType == null || memberType.PropertyTypes.Any() == false)
                return Enumerable.Empty&lt;MemberTypeDto&gt;();

            var dtos = memberType.PropertyTypes.Select(x =&gt; new MemberTypeDto
            {
                NodeId = entity.Id,
                PropertyTypeId = x.Id,
                CanEdit = memberType.MemberCanEditProperty(x.Alias),
                ViewOnProfile = memberType.MemberCanViewProperty(x.Alias)
            }).ToList();
            return dtos;
        }

        #endregion

        #region Common

        private static void BuildCommonEntity(ContentTypeBase entity, ContentTypeDto dto)
        {
            entity.Id = dto.NodeDto.NodeId;
            entity.Key = dto.NodeDto.UniqueId;
            entity.Alias = dto.Alias;
            entity.Name = dto.NodeDto.Text;
            entity.Icon = dto.Icon;
            entity.Thumbnail = dto.Thumbnail;
            entity.SortOrder = dto.NodeDto.SortOrder;
            entity.Description = dto.Description;
            entity.CreateDate = dto.NodeDto.CreateDate;
            entity.Path = dto.NodeDto.Path;
            entity.Level = dto.NodeDto.Level;
            entity.CreatorId = dto.NodeDto.UserId.Value;
            entity.AllowedAsRoot = dto.AllowAtRoot;
            entity.IsContainer = dto.IsContainer;
            entity.Trashed = dto.NodeDto.Trashed;
        }

        public ContentTypeDto BuildContentTypeDto(IContentTypeBase entity)
        {
            Guid nodeObjectType;
            if (entity is IContentType)
                nodeObjectType = Constants.ObjectTypes.DocumentTypeGuid;
            else if (entity is IMediaType)
                nodeObjectType = Constants.ObjectTypes.MediaTypeGuid;
            else if (entity is IMemberType)
                nodeObjectType = Constants.ObjectTypes.MemberTypeGuid;
            else
                throw new Exception(&quot;Invalid entity.&quot;);

            var contentTypeDto = new ContentTypeDto
            {
                Alias = entity.Alias,
                Description = entity.Description,
                Icon = entity.Icon,
                Thumbnail = entity.Thumbnail,
                NodeId = entity.Id,
                AllowAtRoot = entity.AllowedAsRoot,
                IsContainer = entity.IsContainer,
                NodeDto = BuildNodeDto(entity, nodeObjectType)
            };
            return contentTypeDto;
        }

        private static NodeDto BuildNodeDto(IUmbracoEntity entity, Guid nodeObjectType)
        {
            var nodeDto = new NodeDto
            {
                CreateDate = entity.CreateDate,
                NodeId = entity.Id,
                Level = short.Parse(entity.Level.ToString(CultureInfo.InvariantCulture)),
                NodeObjectType = nodeObjectType,
                ParentId = entity.ParentId,
                Path = entity.Path,
                SortOrder = entity.SortOrder,
                Text = entity.Name,
                Trashed = false,
                UniqueId = entity.Key,
                UserId = entity.CreatorId
            };
            return nodeDto;
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,69,1],[26,13,26,14,1],[27,17,27,53,1],[29,17,29,53,1],[33,17,33,57,1],[34,17,34,36,1],[37,13,37,14,1],[38,17,38,52,1],[39,13,39,14,1],[40,9,40,10,1],[47,9,47,10,1],[48,13,48,67,1],[50,13,50,14,1],[51,17,51,53,1],[53,17,53,53,1],[57,17,57,57,1],[58,13,58,14,1],[60,13,60,14,1],[61,17,61,52,1],[62,13,62,14,1],[64,13,64,32,1],[65,9,65,10,1],[72,9,72,10,0],[73,13,73,49,0],[77,9,77,10,1],[78,13,78,51,1],[79,13,79,79,1],[80,17,80,58,0],[82,13,82,61,1],[82,61,88,14,1],[88,14,88,25,1],[82,13,88,25,1],[89,13,89,25,1],[90,9,90,10,1],[97,9,97,10,1],[98,13,98,44,1],[99,13,99,47,1],[100,13,100,38,1],[101,13,101,44,1],[102,13,102,36,1],[103,13,103,46,1],[104,13,104,54,1],[105,13,105,50,1],[106,13,106,56,1],[107,13,107,44,1],[108,13,108,46,1],[109,13,109,57,1],[110,13,110,52,1],[111,13,111,50,1],[112,13,112,50,1],[113,9,113,10,1],[116,9,116,10,1],[118,13,118,40,1],[119,17,119,73,1],[120,18,120,43,1],[121,17,121,70,1],[122,18,122,44,1],[123,17,123,71,1],[125,17,125,56,0],[127,13,137,15,1],[138,13,138,35,1],[139,9,139,10,1],[142,9,142,10,1],[143,13,156,15,1],[157,13,157,28,1],[158,9,158,10,1]]);
    </script>
  </body>
</html>