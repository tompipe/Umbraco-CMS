<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\PetaPocoSqlExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Linq;
using System.Linq.Expressions;
using System.Reflection;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence
{
    /// &lt;summary&gt;
    /// Extension methods adding strong types to PetaPoco&#39;s Sql Builder
    /// &lt;/summary&gt;
    public static class PetaPocoSqlExtensions
    {
        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql From&lt;T&gt;(this Sql sql)
        {
            return From&lt;T&gt;(sql, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql From&lt;T&gt;(this Sql sql, ISqlSyntaxProvider sqlSyntax)
        {
            var type = typeof(T);
            var tableName = type.GetTableName();

            return sql.From(sqlSyntax.GetQuotedTableName(tableName));
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql Where&lt;T&gt;(this Sql sql, Expression&lt;Func&lt;T, bool&gt;&gt; predicate)
        {
            var expresionist = new PocoToSqlExpressionVisitor&lt;T&gt;();
            var whereExpression = expresionist.Visit(predicate);
            return sql.Where(whereExpression, expresionist.GetSqlParameters());
        }

        public static Sql Where&lt;T&gt;(this Sql sql, Expression&lt;Func&lt;T, bool&gt;&gt; predicate, ISqlSyntaxProvider sqlSyntax)
        {
            var expresionist = new PocoToSqlExpressionVisitor&lt;T&gt;(sqlSyntax);
            var whereExpression = expresionist.Visit(predicate);
            return sql.Where(whereExpression, expresionist.GetSqlParameters());
        }

        private static string GetFieldName&lt;T&gt;(Expression&lt;Func&lt;T, object&gt;&gt; fieldSelector, ISqlSyntaxProvider sqlSyntax)
        {
            var field = ExpressionHelper.FindProperty(fieldSelector) as PropertyInfo;
            var fieldName = field.GetColumnName();

            var type = typeof(T);
            var tableName = type.GetTableName();

            return sqlSyntax.GetQuotedTableName(tableName) + &quot;.&quot; + sqlSyntax.GetQuotedColumnName(fieldName);
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql WhereIn&lt;T&gt;(this Sql sql, Expression&lt;Func&lt;T, object&gt;&gt; fieldSelector, IEnumerable values)
        {
            return sql.WhereIn(fieldSelector, values, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql WhereIn&lt;T&gt;(this Sql sql, Expression&lt;Func&lt;T, object&gt;&gt; fieldSelector, IEnumerable values, ISqlSyntaxProvider sqlSyntax)
        {
            var fieldName = GetFieldName(fieldSelector, sqlSyntax);
            return sql.Where(fieldName + &quot; IN (@values)&quot;, new { values });
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql OrderBy&lt;TColumn&gt;(this Sql sql, Expression&lt;Func&lt;TColumn, object&gt;&gt; columnMember)
        {
            return OrderBy&lt;TColumn&gt;(sql, columnMember, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql OrderBy&lt;TColumn&gt;(this Sql sql, Expression&lt;Func&lt;TColumn, object&gt;&gt; columnMember, ISqlSyntaxProvider sqlSyntax)
        {
            var syntax = &quot;(&quot; + GetFieldName(columnMember, sqlSyntax) + &quot;)&quot;;
            return sql.OrderBy(syntax);
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql OrderByDescending&lt;TColumn&gt;(this Sql sql, Expression&lt;Func&lt;TColumn, object&gt;&gt; columnMember)
        {
            return OrderByDescending&lt;TColumn&gt;(sql, columnMember, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql OrderByDescending&lt;TColumn&gt;(this Sql sql, Expression&lt;Func&lt;TColumn, object&gt;&gt; columnMember, ISqlSyntaxProvider sqlSyntax)
        {
            var column = ExpressionHelper.FindProperty(columnMember) as PropertyInfo;
            var columnName = column.GetColumnName();

            var type = typeof(TColumn);
            var tableName = type.GetTableName();

            //need to ensure the order by is in brackets, see: https://github.com/toptensoftware/PetaPoco/issues/177
            var syntax = string.Format(&quot;({0}.{1}) DESC&quot;,
                sqlSyntax.GetQuotedTableName(tableName),
                sqlSyntax.GetQuotedColumnName(columnName));

            return sql.OrderBy(syntax);
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql GroupBy&lt;TColumn&gt;(this Sql sql, Expression&lt;Func&lt;TColumn, object&gt;&gt; columnMember)
        {
            return GroupBy&lt;TColumn&gt;(sql, columnMember, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql GroupBy&lt;TColumn&gt;(this Sql sql, Expression&lt;Func&lt;TColumn, object&gt;&gt; columnMember, ISqlSyntaxProvider sqlProvider)
        {
            var column = ExpressionHelper.FindProperty(columnMember) as PropertyInfo;
            var columnName = column.GetColumnName();

            return sql.GroupBy(sqlProvider.GetQuotedColumnName(columnName));
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql.SqlJoinClause InnerJoin&lt;T&gt;(this Sql sql)
        {
            return InnerJoin&lt;T&gt;(sql, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql.SqlJoinClause InnerJoin&lt;T&gt;(this Sql sql, ISqlSyntaxProvider sqlSyntax)
        {
            var type = typeof(T);
            var tableName = type.GetTableName();

            return sql.InnerJoin(sqlSyntax.GetQuotedTableName(tableName));
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql.SqlJoinClause LeftJoin&lt;T&gt;(this Sql sql)
        {
            return LeftJoin&lt;T&gt;(sql, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql.SqlJoinClause LeftJoin&lt;T&gt;(this Sql sql, ISqlSyntaxProvider sqlSyntax)
        {
            var type = typeof(T);
            var tableName = type.GetTableName();

            return sql.LeftJoin(sqlSyntax.GetQuotedTableName(tableName));
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql.SqlJoinClause LeftOuterJoin&lt;T&gt;(this Sql sql)
        {
            return LeftOuterJoin&lt;T&gt;(sql, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql.SqlJoinClause LeftOuterJoin&lt;T&gt;(this Sql sql, ISqlSyntaxProvider sqlSyntax)
        {
            var type = typeof(T);
            var tableName = type.GetTableName();

            return sql.LeftOuterJoin(sqlSyntax.GetQuotedTableName(tableName));
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql.SqlJoinClause RightJoin&lt;T&gt;(this Sql sql)
        {
            return RightJoin&lt;T&gt;(sql, SqlSyntaxContext.SqlSyntaxProvider);
        }

        public static Sql.SqlJoinClause RightJoin&lt;T&gt;(this Sql sql, ISqlSyntaxProvider sqlSyntax)
        {
            var type = typeof(T);
            var tableName = type.GetTableName();

            return sql.RightJoin(sqlSyntax.GetQuotedTableName(tableName));
        }

        [Obsolete(&quot;Use the overload specifying ISqlSyntaxProvider instead&quot;)]
        public static Sql On&lt;TLeft, TRight&gt;(this Sql.SqlJoinClause sql, Expression&lt;Func&lt;TLeft, object&gt;&gt; leftMember,
                                            Expression&lt;Func&lt;TRight, object&gt;&gt; rightMember, params object[] args)
        {
            return On&lt;TLeft, TRight&gt;(sql, SqlSyntaxContext.SqlSyntaxProvider, leftMember, rightMember, args);
        }

        public static Sql On&lt;TLeft, TRight&gt;(this Sql.SqlJoinClause sql, ISqlSyntaxProvider sqlSyntax, Expression&lt;Func&lt;TLeft, object&gt;&gt; leftMember,
                                           Expression&lt;Func&lt;TRight, object&gt;&gt; rightMember, params object[] args)
        {
            var leftType = typeof(TLeft);
            var rightType = typeof(TRight);
            var leftTableName = leftType.GetTableName();
            var rightTableName = rightType.GetTableName();

            var leftColumn = ExpressionHelper.FindProperty(leftMember) as PropertyInfo;
            var rightColumn = ExpressionHelper.FindProperty(rightMember) as PropertyInfo;

            var leftColumnName = leftColumn.GetColumnName();
            var rightColumnName = rightColumn.GetColumnName();

            string onClause = string.Format(&quot;{0}.{1} = {2}.{3}&quot;,
                sqlSyntax.GetQuotedTableName(leftTableName),
                sqlSyntax.GetQuotedColumnName(leftColumnName),
                sqlSyntax.GetQuotedTableName(rightTableName),
                sqlSyntax.GetQuotedColumnName(rightColumnName));
            return sql.On(onClause);
        }

        public static Sql OrderByDescending(this Sql sql, params object[] columns)
        {
            return sql.Append(new Sql(&quot;ORDER BY &quot; + String.Join(&quot;, &quot;, (from x in columns select x + &quot; DESC&quot;).ToArray())));
        }

        private static string GetTableName(this Type type)
        {
            // todo: returning string.Empty for now
            // BUT the code bits that calls this method cannot deal with string.Empty so we
            // should either throw, or fix these code bits...
            var attr = type.FirstAttribute&lt;TableNameAttribute&gt;();
            return attr == null || string.IsNullOrWhiteSpace(attr.Value) ? string.Empty : attr.Value;
        }

        private static string GetColumnName(this PropertyInfo column)
        {
            var attr = column.FirstAttribute&lt;ColumnAttribute&gt;();
            return attr == null || string.IsNullOrWhiteSpace(attr.Name) ? column.Name : attr.Name;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,10,1],[19,13,19,69,1],[20,9,20,10,1],[23,9,23,10,1],[24,13,24,34,1],[25,13,25,49,1],[27,13,27,70,1],[28,9,28,10,1],[32,9,32,10,1],[33,13,33,68,1],[34,13,34,65,1],[35,13,35,80,1],[36,9,36,10,1],[39,9,39,10,1],[40,13,40,77,1],[41,13,41,65,1],[42,13,42,80,1],[43,9,43,10,1],[46,9,46,10,1],[47,13,47,86,1],[48,13,48,51,1],[50,13,50,34,1],[51,13,51,49,1],[53,13,53,109,1],[54,9,54,10,1],[58,9,58,10,1],[59,13,59,91,1],[60,9,60,10,1],[63,9,63,10,1],[64,13,64,68,1],[65,13,65,75,1],[66,9,66,10,1],[70,9,70,10,1],[71,13,71,92,1],[72,9,72,10,1],[75,9,75,10,1],[76,13,76,76,1],[77,13,77,40,1],[78,9,78,10,1],[82,9,82,10,1],[83,13,83,102,1],[84,9,84,10,1],[87,9,87,10,1],[88,13,88,86,1],[89,13,89,53,1],[91,13,91,40,1],[92,13,92,49,1],[95,13,97,60,1],[99,13,99,40,1],[100,9,100,10,1],[104,9,104,10,1],[105,13,105,92,1],[106,9,106,10,1],[109,9,109,10,1],[110,13,110,86,1],[111,13,111,53,1],[113,13,113,77,1],[114,9,114,10,1],[118,9,118,10,1],[119,13,119,74,1],[120,9,120,10,1],[123,9,123,10,1],[124,13,124,34,1],[125,13,125,49,1],[127,13,127,75,1],[128,9,128,10,1],[132,9,132,10,1],[133,13,133,73,1],[134,9,134,10,1],[137,9,137,10,1],[138,13,138,34,1],[139,13,139,49,1],[141,13,141,74,1],[142,9,142,10,1],[146,9,146,10,0],[147,13,147,78,0],[148,9,148,10,0],[151,9,151,10,0],[152,13,152,34,0],[153,13,153,49,0],[155,13,155,79,0],[156,9,156,10,0],[160,9,160,10,1],[161,13,161,74,1],[162,9,162,10,1],[165,9,165,10,1],[166,13,166,34,1],[167,13,167,49,1],[169,13,169,75,1],[170,9,170,10,1],[175,9,175,10,1],[176,13,176,110,1],[177,9,177,10,1],[181,9,181,10,1],[182,13,182,42,1],[183,13,183,44,1],[184,13,184,57,1],[185,13,185,59,1],[187,13,187,88,1],[188,13,188,90,1],[190,13,190,61,1],[191,13,191,63,1],[193,13,197,65,1],[198,13,198,37,1],[199,9,199,10,1],[202,9,202,10,1],[203,13,203,97,1],[203,97,203,108,1],[203,108,203,123,1],[203,13,203,123,1],[204,9,204,10,1],[207,9,207,10,1],[211,13,211,66,1],[212,13,212,102,1],[213,9,213,10,1],[216,9,216,10,1],[217,13,217,65,1],[218,13,218,99,1],[219,9,219,10,1]]);
    </script>
  </body>
</html>