<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\tinymce\tinyMCEPreValueConfigurator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Text;
using System.Collections;
using System.Web.UI;
using System.Web.UI.WebControls;

using umbraco.BusinessLogic;
using umbraco.DataLayer;

namespace umbraco.editorControls.tinymce
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class tinyMCEPreValueConfigurator : System.Web.UI.WebControls.PlaceHolder, interfaces.IDataPrevalue
    {
        // UI controls
        private CheckBoxList _editorButtons;
        private CheckBox _enableRightClick;
        private DropDownList _dropdownlist;
        private CheckBoxList _advancedUsersList;
        private CheckBoxList _stylesheetList;
        private TextBox _width = new TextBox();
        private TextBox _height = new TextBox();
        private TextBox _maxImageWidth = new TextBox();
        private CheckBox _fullWidth = new CheckBox();
        private CheckBox _showLabel = new CheckBox();
        private RegularExpressionValidator _widthValidator = new RegularExpressionValidator();
        private RegularExpressionValidator _heightValidator = new RegularExpressionValidator();
        private RegularExpressionValidator _maxImageWidthValidator = new RegularExpressionValidator();

        // referenced datatype
        private cms.businesslogic.datatype.BaseDataType _datatype;
        private string _selectedButtons = &quot;&quot;;
        private string _advancedUsers = &quot;&quot;;
        private string _stylesheets = &quot;&quot;;

        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        public static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }


        public tinyMCEPreValueConfigurator(cms.businesslogic.datatype.BaseDataType DataType)
        {
            // state it knows its datatypedefinitionid
            _datatype = DataType;
            setupChildControls();
        }

        private void setupChildControls()
        {
            _dropdownlist = new DropDownList();
            _dropdownlist.ID = &quot;dbtype&quot;;
            _dropdownlist.Items.Add(DBTypes.Date.ToString());
            _dropdownlist.Items.Add(DBTypes.Integer.ToString());
            _dropdownlist.Items.Add(DBTypes.Ntext.ToString());
            _dropdownlist.Items.Add(DBTypes.Nvarchar.ToString());

            _editorButtons = new CheckBoxList();
            _editorButtons.ID = &quot;editorButtons&quot;;
            _editorButtons.RepeatColumns = 4;
            _editorButtons.CellPadding = 3;

            _enableRightClick = new CheckBox();
            _enableRightClick.ID = &quot;enableRightClick&quot;;

            _advancedUsersList = new CheckBoxList();
            _advancedUsersList.ID = &quot;advancedUsersList&quot;;

            _stylesheetList = new CheckBoxList();
            _stylesheetList.ID = &quot;stylesheetList&quot;;

            _showLabel = new CheckBox();
            _showLabel.ID = &quot;showLabel&quot;;

            _maxImageWidth = new TextBox();
            _maxImageWidth.ID = &quot;maxImageWidth&quot;;

            // put the childcontrols in context - ensuring that
            // the viewstate is persisted etc.
            Controls.Add(_dropdownlist);
            Controls.Add(_enableRightClick);
            Controls.Add(_editorButtons);
            Controls.Add(_advancedUsersList);
            Controls.Add(_stylesheetList);
            Controls.Add(_width);
            Controls.Add(_widthValidator);
            Controls.Add(_height);
            Controls.Add(_heightValidator);
            Controls.Add(_showLabel);
            Controls.Add(_maxImageWidth);
            Controls.Add(_maxImageWidthValidator);
            //            Controls.Add(_fullWidth);

        }

        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
            // add ids to controls
            _width.ID = &quot;width&quot;;
            _height.ID = &quot;height&quot;;


            // initialize validators
            _widthValidator.ValidationExpression = &quot;0*[1-9][0-9]*&quot;;
            _widthValidator.ErrorMessage = ui.Text(&quot;errorHandling&quot;, &quot;errorIntegerWithoutTab&quot;, ui.Text(&quot;width&quot;), new BasePages.BasePage().getUser());
            _widthValidator.Display = ValidatorDisplay.Dynamic;
            _widthValidator.ControlToValidate = _width.ID;
            _heightValidator.ValidationExpression = &quot;0*[1-9][0-9]*&quot;;
            _heightValidator.ErrorMessage = ui.Text(&quot;errorHandling&quot;, &quot;errorIntegerWithoutTab&quot;, ui.Text(&quot;height&quot;), new BasePages.BasePage().getUser());
            _heightValidator.ControlToValidate = _height.ID;
            _heightValidator.Display = ValidatorDisplay.Dynamic;
            _maxImageWidthValidator.ValidationExpression = &quot;0*[1-9][0-9]*&quot;;
            _maxImageWidthValidator.ErrorMessage = ui.Text(&quot;errorHandling&quot;, &quot;errorIntegerWithoutTab&quot;, &quot;&#39;&quot; + ui.Text(&quot;rteMaximumDefaultImgSize&quot;) + &quot;&#39;&quot;, new BasePages.BasePage().getUser());
            _maxImageWidthValidator.ControlToValidate = _maxImageWidth.ID;
            _maxImageWidthValidator.Display = ValidatorDisplay.Dynamic;

            if (!Page.IsPostBack)
            {
                if (Configuration != null)
                {
                    string[] config = Configuration.Split(&quot;|&quot;.ToCharArray());
                    if (config.Length &gt; 0)
                    {
                        _selectedButtons = config[0];

                        if (config.Length &gt; 1)
                            if (config[1] == &quot;1&quot;)
                                _enableRightClick.Checked = true;

                        if (config.Length &gt; 2)
                            _advancedUsers = config[2];

                        if (config.Length &gt; 4 &amp;&amp; config[4].Split(&#39;,&#39;).Length &gt; 1)
                        {
                            //                        if (config[3] == &quot;1&quot;)
                            //                            _fullWidth.Checked = true;
                            //                        else
                            //                        {
                            _width.Text = config[4].Split(&#39;,&#39;)[0];
                            _height.Text = config[4].Split(&#39;,&#39;)[1];
                            //                        }
                        }

                        // if width and height are empty or lower than 0 then set default sizes:
                        int tempWidth, tempHeight;
                        int.TryParse(_width.Text, out tempWidth);
                        int.TryParse(_height.Text, out tempHeight);
                        if (_width.Text.Trim() == &quot;&quot; || tempWidth &lt; 1)
                            _width.Text = &quot;500&quot;;
                        if (_height.Text.Trim() == &quot;&quot; || tempHeight &lt; 1)
                            _height.Text = &quot;400&quot;;

                        if (config.Length &gt; 5)
                            _stylesheets = config[5];
                        if (config.Length &gt; 6 &amp;&amp; config[6] != &quot;&quot;)
                            _showLabel.Checked = bool.Parse(config[6]);

                        if (config.Length &gt; 7 &amp;&amp; config[7] != &quot;&quot;)
                            _maxImageWidth.Text = config[7];
                        else
                            _maxImageWidth.Text = &quot;500&quot;;
                    }

                    // add editor buttons
                    IDictionaryEnumerator ide = tinyMCEConfiguration.SortedCommands.GetEnumerator();
                    while (ide.MoveNext())
                    {
                        tinyMCECommand cmd = (tinyMCECommand)ide.Value;
                        ListItem li =
                            new ListItem(
                                string.Format(&quot;&lt;img src=\&quot;{0}\&quot; class=\&quot;tinymceIcon\&quot; alt=\&quot;{1}\&quot; /&gt;&amp;nbsp;&quot;, cmd.Icon,
                                              cmd.Alias), cmd.Alias);
                        if (_selectedButtons.IndexOf(cmd.Alias) &gt; -1)
                            li.Selected = true;

                        _editorButtons.Items.Add(li);
                    }

                    // add users
                    foreach (BusinessLogic.UserType ut in BusinessLogic.UserType.getAll)
                    {
                        ListItem li = new ListItem(ut.Name, ut.Id.ToString());
                        if ((&quot;,&quot; + _advancedUsers + &quot;,&quot;).IndexOf(&quot;,&quot; + ut.Id.ToString() + &quot;,&quot;) &gt; -1)
                            li.Selected = true;

                        _advancedUsersList.Items.Add(li);
                    }

                    // add stylesheets
                    foreach (cms.businesslogic.web.StyleSheet st in cms.businesslogic.web.StyleSheet.GetAll())
                    {
                        ListItem li = new ListItem(st.Text, st.Id.ToString());
                        if ((&quot;,&quot; + _stylesheets + &quot;,&quot;).IndexOf(&quot;,&quot; + st.Id.ToString() + &quot;,&quot;) &gt; -1)
                            li.Selected = true;

                        _stylesheetList.Items.Add(li);
                    }
                }

                // Mark the current db type
                _dropdownlist.SelectedValue = _datatype.DBType.ToString();

            }
        }

        public Control Editor
        {
            get
            {
                return this;
            }
        }

        public virtual void Save()
        {
            _datatype.DBType = (cms.businesslogic.datatype.DBTypes)Enum.Parse(typeof(cms.businesslogic.datatype.DBTypes), _dropdownlist.SelectedValue, true);

            // Generate data-string
            string data = &quot;,&quot;;

            foreach (ListItem li in _editorButtons.Items)
                if (li.Selected)
                    data += li.Value + &quot;,&quot;;

            data += &quot;|&quot;;

            if (_enableRightClick.Checked)
                data += &quot;1&quot;;
            else
                data += &quot;0&quot;;

            data += &quot;|&quot;;

            foreach (ListItem li in _advancedUsersList.Items)
                if (li.Selected)
                    data += li.Value + &quot;,&quot;;

            data += &quot;|&quot;;

            data += &quot;0|&quot;;

            data += _width.Text + &quot;,&quot; + _height.Text + &quot;|&quot;;

            foreach (ListItem li in _stylesheetList.Items)
                if (li.Selected)
                    data += li.Value + &quot;,&quot;;

            data += &quot;|&quot;;
            data += _showLabel.Checked.ToString() + &quot;|&quot;;
            data += _maxImageWidth.Text + &quot;|&quot;;

            using (var sqlHelper = Application.SqlHelper)
            {
                // If the add new prevalue textbox is filled out - add the value to the collection.
                IParameter[] SqlParams = new IParameter[] {
                                                sqlHelper.CreateParameter(&quot;@value&quot;,data),
                                                sqlHelper.CreateParameter(&quot;@dtdefid&quot;,_datatype.DataTypeDefinitionId)};
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsDataTypePreValues where datatypenodeid = @dtdefid&quot;, SqlParams);
                // we need to populate the parameters again due to an issue with SQL CE
                SqlParams = new IParameter[] {
                                                sqlHelper.CreateParameter(&quot;@value&quot;,data),
                                                sqlHelper.CreateParameter(&quot;@dtdefid&quot;,_datatype.DataTypeDefinitionId)};
                sqlHelper.ExecuteNonQuery(&quot;insert into cmsDataTypePreValues (datatypenodeid,[value],sortorder,alias) values (@dtdefid,@value,0,&#39;&#39;)&quot;, SqlParams);
            }
		}

        protected override void Render(HtmlTextWriter writer)
        {
            writer.WriteLine(&quot;&lt;table&gt;&quot;);
            writer.WriteLine(&quot;&lt;tr&gt;&lt;th&gt;&quot; + ui.Text(&quot;editdatatype&quot;, &quot;dataBaseDatatype&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot;);
            _dropdownlist.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;&quot; + ui.Text(&quot;editdatatype&quot;, &quot;rteButtons&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot;);
            _editorButtons.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;&quot; + ui.Text(&quot;editdatatype&quot;, &quot;rteRelatedStylesheets&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot;);
            _stylesheetList.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;&quot; + ui.Text(&quot;editdatatype&quot;, &quot;rteEnableContextMenu&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot;);
            _enableRightClick.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;&quot; + ui.Text(&quot;editdatatype&quot;, &quot;rteEnableAdvancedSettings&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot;);
            _advancedUsersList.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;&quot;);
            //&quot;Size:&lt;/th&gt;&lt;td&gt;Maximum width and height: &quot;);
            //            _fullWidth.RenderControl(writer);

            writer.Write(ui.Text(&quot;editdatatype&quot;, &quot;rteWidthAndHeight&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot;);
            _width.RenderControl(writer);
            _widthValidator.RenderControl(writer);
            writer.Write(&quot; x &quot;);
            _height.RenderControl(writer);
            _heightValidator.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;&quot;);
            writer.Write(ui.Text(&quot;editdatatype&quot;, &quot;rteMaximumDefaultImgSize&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot;);
            _maxImageWidth.RenderControl(writer);
            _maxImageWidthValidator.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;tr&gt;&lt;th&gt;&quot; + ui.Text(&quot;editdatatype&quot;, &quot;rteShowLabel&quot;) + &quot;:&lt;/th&gt;&lt;td&gt;&quot;);
            _showLabel.RenderControl(writer);
            writer.Write(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
            writer.Write(&quot;&lt;/table&gt;&quot;);
        }

        public string Configuration
        {
            get
            {
                try
                {
                    using (var sqlHelper = Application.SqlHelper)
                        return sqlHelper.ExecuteScalar&lt;string&gt;(&quot;select value from cmsDataTypePreValues where datatypenodeid = @datatypenodeid&quot;, sqlHelper.CreateParameter(&quot;@datatypenodeid&quot;, _datatype.DataTypeDefinitionId));
                }
                catch
                {
                    return &quot;&quot;;
                }
            }
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,48,0],[23,9,23,49,0],[24,9,24,56,0],[25,9,25,54,0],[26,9,26,54,0],[27,9,27,95,0],[28,9,28,96,0],[29,9,29,103,0],[33,9,33,46,0],[34,9,34,44,0],[35,9,35,42,0],[43,17,43,18,0],[43,19,43,48,0],[43,49,43,50,0],[47,9,47,93,0],[48,9,48,10,0],[50,13,50,34,0],[51,13,51,34,0],[52,9,52,10,0],[55,9,55,10,0],[56,13,56,48,0],[57,13,57,41,0],[58,13,58,62,0],[59,13,59,65,0],[60,13,60,63,0],[61,13,61,66,0],[63,13,63,49,0],[64,13,64,49,0],[65,13,65,46,0],[66,13,66,44,0],[68,13,68,48,0],[69,13,69,55,0],[71,13,71,53,0],[72,13,72,57,0],[74,13,74,50,0],[75,13,75,51,0],[77,13,77,41,0],[78,13,78,41,0],[80,13,80,44,0],[81,13,81,49,0],[85,13,85,41,0],[86,13,86,45,0],[87,13,87,42,0],[88,13,88,46,0],[89,13,89,43,0],[90,13,90,34,0],[91,13,91,43,0],[92,13,92,35,0],[93,13,93,44,0],[94,13,94,38,0],[95,13,95,42,0],[96,13,96,51,0],[99,9,99,10,0],[102,9,102,10,0],[103,13,103,28,0],[105,13,105,33,0],[106,13,106,35,0],[110,13,110,68,0],[111,13,111,149,0],[112,13,112,64,0],[113,13,113,59,0],[114,13,114,69,0],[115,13,115,151,0],[116,13,116,61,0],[117,13,117,65,0],[118,13,118,76,0],[119,13,119,188,0],[120,13,120,75,0],[121,13,121,72,0],[123,13,123,34,0],[124,13,124,14,0],[125,17,125,43,0],[126,17,126,18,0],[127,21,127,78,0],[128,21,128,43,0],[129,21,129,22,0],[130,25,130,54,0],[132,25,132,47,0],[133,29,133,50,0],[134,33,134,66,0],[136,25,136,47,0],[137,29,137,56,0],[139,25,139,82,0],[140,25,140,26,0],[145,29,145,67,0],[146,29,146,68,0],[148,25,148,26,0],[152,25,152,66,0],[153,25,153,68,0],[154,25,154,71,0],[155,29,155,49,0],[156,25,156,73,0],[157,29,157,50,0],[159,25,159,47,0],[160,29,160,54,0],[161,25,161,66,0],[162,29,162,72,0],[164,25,164,66,0],[165,29,165,61,0],[167,29,167,57,0],[168,21,168,22,0],[171,21,171,101,0],[172,21,172,43,0],[173,21,173,22,0],[174,25,174,72,0],[175,25,178,70,0],[179,25,179,70,0],[180,29,180,48,0],[182,25,182,54,0],[183,21,183,22,0],[186,21,186,28,0],[186,30,186,55,0],[186,56,186,58,0],[186,59,186,88,0],[187,21,187,22,0],[188,25,188,79,0],[189,25,189,101,0],[190,29,190,48,0],[192,25,192,58,0],[193,21,193,22,0],[196,21,196,28,0],[196,30,196,65,0],[196,66,196,68,0],[196,69,196,110,0],[197,21,197,22,0],[198,25,198,79,0],[199,25,199,99,0],[200,29,200,48,0],[202,25,202,55,0],[203,21,203,22,0],[204,17,204,18,0],[207,17,207,75,0],[209,13,209,14,0],[210,9,210,10,0],[215,13,215,14,0],[216,17,216,29,0],[217,13,217,14,0],[221,9,221,10,0],[222,13,222,158,0],[225,13,225,31,0],[227,13,227,20,0],[227,22,227,33,0],[227,34,227,36,0],[227,37,227,57,0],[228,17,228,33,0],[229,21,229,44,0],[231,13,231,25,0],[233,13,233,43,0],[234,17,234,29,0],[236,17,236,29,0],[238,13,238,25,0],[240,13,240,20,0],[240,22,240,33,0],[240,34,240,36,0],[240,37,240,61,0],[241,17,241,33,0],[242,21,242,44,0],[244,13,244,25,0],[246,13,246,26,0],[248,13,248,60,0],[250,13,250,20,0],[250,22,250,33,0],[250,34,250,36,0],[250,37,250,58,0],[251,17,251,33,0],[252,21,252,44,0],[254,13,254,25,0],[255,13,255,57,0],[256,13,256,47,0],[258,20,258,57,0],[259,13,259,14,0],[261,17,263,119,0],[264,17,264,122,0],[266,17,268,119,0],[269,17,269,161,0],[270,13,270,14,0],[271,3,271,4,0],[274,9,274,10,0],[275,13,275,41,0],[276,13,276,103,0],[277,13,277,49,0],[278,13,278,40,0],[279,13,279,93,0],[280,13,280,50,0],[281,13,281,40,0],[282,13,282,104,0],[283,13,283,51,0],[284,13,284,40,0],[285,13,285,103,0],[286,13,286,53,0],[287,13,287,40,0],[288,13,288,108,0],[289,13,289,54,0],[290,13,290,40,0],[291,13,291,38,0],[295,13,295,87,0],[296,13,296,42,0],[297,13,297,51,0],[298,13,298,33,0],[299,13,299,43,0],[300,13,300,52,0],[301,13,301,40,0],[302,13,302,38,0],[303,13,303,94,0],[304,13,304,50,0],[305,13,305,59,0],[306,13,306,40,0],[307,13,307,95,0],[308,13,308,46,0],[309,13,309,40,0],[310,13,310,38,0],[311,9,311,10,0],[316,13,316,14,0],[318,17,318,18,0],[319,28,319,65,0],[320,25,320,223,0],[322,17,322,22,0],[323,17,323,18,0],[324,21,324,31,0],[326,13,326,14,0]]);
    </script>
  </body>
</html>