<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Models\Mapping\TabsAndPropertiesResolver.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using AutoMapper;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using umbraco;

namespace Umbraco.Web.Models.Mapping
{
    /// &lt;summary&gt;
    /// Creates the tabs collection with properties assigned for display models
    /// &lt;/summary&gt;
    internal class TabsAndPropertiesResolver : ValueResolver&lt;IContentBase, IEnumerable&lt;Tab&lt;ContentPropertyDisplay&gt;&gt;&gt;
    {
        private readonly ILocalizedTextService _localizedTextService;
        protected IEnumerable&lt;string&gt; IgnoreProperties { get; set; }

        public TabsAndPropertiesResolver(ILocalizedTextService localizedTextService)
        {
            if (localizedTextService == null) throw new ArgumentNullException(&quot;localizedTextService&quot;);
            _localizedTextService = localizedTextService;
            IgnoreProperties = new List&lt;string&gt;();
        }

        public TabsAndPropertiesResolver(ILocalizedTextService localizedTextService, IEnumerable&lt;string&gt; ignoreProperties)
            : this(localizedTextService)
        {         
            if (ignoreProperties == null) throw new ArgumentNullException(&quot;ignoreProperties&quot;);
            IgnoreProperties = ignoreProperties;
        }

        /// &lt;summary&gt;
        /// Maps properties on to the generic properties tab
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;content&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;display&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;localizedTextService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;customProperties&quot;&gt;
        /// Any additional custom properties to assign to the generic properties tab. 
        /// &lt;/param&gt;
        /// &lt;param name=&quot;onGenericPropertiesMapped&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// The generic properties tab is mapped during AfterMap and is responsible for 
        /// setting up the properties such as Created date, updated date, template selected, etc...
        /// &lt;/remarks&gt;
        public static void MapGenericProperties&lt;TPersisted&gt;(
            TPersisted content,
            ContentItemDisplayBase&lt;ContentPropertyDisplay, TPersisted&gt; display,
            ILocalizedTextService localizedTextService,
            IEnumerable&lt;ContentPropertyDisplay&gt; customProperties = null,
            Action&lt;List&lt;ContentPropertyDisplay&gt;&gt; onGenericPropertiesMapped = null)
            where TPersisted : IContentBase
        {
            var genericProps = display.Tabs.Single(x =&gt; x.Id == 0);

            //store the current props to append to the newly inserted ones
            var currProps = genericProps.Properties.ToArray();

            var labelEditor = PropertyEditorResolver.Current.GetByAlias(Constants.PropertyEditors.NoEditAlias).ValueEditor.View;

            var contentProps = new List&lt;ContentPropertyDisplay&gt;
            {
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}id&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = &quot;Id&quot;,
                    Value = Convert.ToInt32(display.Id).ToInvariantString() + &quot;&lt;br/&gt;&lt;small class=&#39;muted&#39;&gt;&quot; + display.Key + &quot;&lt;/small&gt;&quot;,
                    View = labelEditor
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}creator&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedTextService.Localize(&quot;content/createBy&quot;),
                    Description = localizedTextService.Localize(&quot;content/createByDesc&quot;),
                    Value = display.Owner.Name,
                    View = labelEditor
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}createdate&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedTextService.Localize(&quot;content/createDate&quot;),
                    Description = localizedTextService.Localize(&quot;content/createDateDesc&quot;),
                    Value = display.CreateDate.ToIsoString(),
                    View = labelEditor
                },
                new ContentPropertyDisplay
                {
                    Alias = string.Format(&quot;{0}updatedate&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                    Label = localizedTextService.Localize(&quot;content/updateDate&quot;),
                    Description = localizedTextService.Localize(&quot;content/updateDateDesc&quot;),
                    Value = display.UpdateDate.ToIsoString(),
                    View = labelEditor
                }
            };

            if (customProperties != null)
            {
                //add the custom ones
                contentProps.AddRange(customProperties);
            }

            //now add the user props
            contentProps.AddRange(currProps);

            //callback
            if (onGenericPropertiesMapped != null)
            {
                onGenericPropertiesMapped(contentProps);
            }

            //re-assign
            genericProps.Properties = contentProps;
        }

        /// &lt;summary&gt;
        /// Adds the container (listview) tab to the document
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;TPersisted&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;display&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;entityType&quot;&gt;This must be either &#39;content&#39; or &#39;media&#39;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeService&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;localizedTextService&quot;&gt;&lt;/param&gt;
        internal static void AddListView&lt;TPersisted&gt;(TabbedContentItem&lt;ContentPropertyDisplay, TPersisted&gt; display, string entityType, IDataTypeService dataTypeService, ILocalizedTextService localizedTextService)
             where TPersisted : IContentBase
        {
            int dtdId;
            var customDtdName = Constants.Conventions.DataTypes.ListViewPrefix + display.ContentTypeAlias;
            switch (entityType)
            {
                case &quot;content&quot;:
                    dtdId = Constants.System.DefaultContentListViewDataTypeId;
                    
                    break;
                case &quot;media&quot;:
                    dtdId = Constants.System.DefaultMediaListViewDataTypeId;
                    break;
                case &quot;member&quot;:
                    dtdId = Constants.System.DefaultMembersListViewDataTypeId;
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;entityType does not match a required value&quot;);
            }

            //first try to get the custom one if there is one
            var dt = dataTypeService.GetDataTypeDefinitionByName(customDtdName) 
                ?? dataTypeService.GetDataTypeDefinitionById(dtdId);

            if (dt == null)
            {
                throw new InvalidOperationException(&quot;No list view data type was found for this document type, ensure that the default list view data types exists and/or that your custom list view data type exists&quot;);
            }

            var preVals = dataTypeService.GetPreValuesCollectionByDataTypeId(dt.Id);

            var editor = PropertyEditorResolver.Current.GetByAlias(dt.PropertyEditorAlias);
            if (editor == null)
            {
                throw new NullReferenceException(&quot;The property editor with alias &quot; + dt.PropertyEditorAlias + &quot; does not exist&quot;);
            }

            var listViewTab = new Tab&lt;ContentPropertyDisplay&gt;();
            listViewTab.Alias = Constants.Conventions.PropertyGroups.ListViewGroupName;
            listViewTab.Label = localizedTextService.Localize(&quot;content/childItems&quot;);
            listViewTab.Id = 25;
            listViewTab.IsActive = true;

            var listViewConfig = editor.PreValueEditor.ConvertDbToEditor(editor.DefaultPreValues, preVals);
            //add the entity type to the config
            listViewConfig[&quot;entityType&quot;] = entityType;

            var listViewProperties = new List&lt;ContentPropertyDisplay&gt;();
            listViewProperties.Add(new ContentPropertyDisplay
            {
                Alias = string.Format(&quot;{0}containerView&quot;, Constants.PropertyEditors.InternalGenericPropertiesPrefix),
                Label = &quot;&quot;,
                Value = null,
                View = editor.ValueEditor.View,
                HideLabel = true,
                Config = listViewConfig
            });
            listViewTab.Properties = listViewProperties;

            SetChildItemsTabPosition(display, listViewConfig, listViewTab);
        }

        private static void SetChildItemsTabPosition&lt;TPersisted&gt;(TabbedContentItem&lt;ContentPropertyDisplay, TPersisted&gt; display, 
                IDictionary&lt;string, object&gt; listViewConfig,
                Tab&lt;ContentPropertyDisplay&gt; listViewTab) 
            where TPersisted : IContentBase
        {
            // Find position of tab from config
            var tabIndexForChildItems = 0;
            if (listViewConfig[&quot;displayAtTabNumber&quot;] != null &amp;&amp; int.TryParse((string)listViewConfig[&quot;displayAtTabNumber&quot;], out tabIndexForChildItems))
            {
                // Tab position is recorded 1-based but we insert into collection 0-based
                tabIndexForChildItems--;

                // Ensure within bounds
                if (tabIndexForChildItems &lt; 0)
                {
                    tabIndexForChildItems = 0;
                }

                if (tabIndexForChildItems &gt; display.Tabs.Count())
                {
                    tabIndexForChildItems = display.Tabs.Count();
                }
            }

            // Recreate tab list with child items tab at configured position
            var tabs = new List&lt;Tab&lt;ContentPropertyDisplay&gt;&gt;();
            tabs.AddRange(display.Tabs);
            tabs.Insert(tabIndexForChildItems, listViewTab);
            display.Tabs = tabs;
        }

        protected override IEnumerable&lt;Tab&lt;ContentPropertyDisplay&gt;&gt; ResolveCore(IContentBase content)
        {
            var tabs = new List&lt;Tab&lt;ContentPropertyDisplay&gt;&gt;();

            // add the tabs, for properties that belong to a tab
            // need to aggregate the tabs, as content.PropertyGroups contains all the composition tabs,
            // and there might be duplicates (content does not work like contentType and there is no 
            // content.CompositionPropertyGroups).
            var groupsGroupsByName = content.PropertyGroups.OrderBy(x =&gt; x.SortOrder).GroupBy(x =&gt; x.Name);
            foreach (var groupsByName in groupsGroupsByName)
            {
                var properties = new List&lt;Property&gt;();
                
                // merge properties for groups with the same name
                foreach (var group in groupsByName)
                {
                    var groupProperties = content.GetPropertiesForGroup(group)
                        .Where(x =&gt; IgnoreProperties.Contains(x.Alias) == false); // skip ignored

                    properties.AddRange(groupProperties);
                }

                if (properties.Count == 0)
                    continue;

                // Sort properties so items from different compositions appear in correct order (see U4-9298). Map sorted properties.
                var mappedProperties = Mapper.Map&lt;IEnumerable&lt;Property&gt;, IEnumerable&lt;ContentPropertyDisplay&gt;&gt;(properties.OrderBy(prop =&gt; prop.PropertyType.SortOrder));

                TranslateProperties(mappedProperties);

                // add the tab
                // we need to pick an identifier... there is no &quot;right&quot; way...
                var g = groupsByName.FirstOrDefault(x =&gt; x.Id == content.ContentTypeId) // try local
                    ?? groupsByName.First(); // else pick one randomly
                var groupId = g.Id;
                var groupName = groupsByName.Key;
                tabs.Add(new Tab&lt;ContentPropertyDisplay&gt;
                {
                    Id = groupId,
                    Alias = groupName,
                    Label = _localizedTextService.UmbracoDictionaryTranslate(groupName),
                    Properties = mappedProperties,
                    IsActive = false
                });
            }

            // add the generic properties tab, for properties that don&#39;t belong to a tab
            // get the properties, map and translate them, then add the tab
            var noGroupProperties = content.GetNonGroupedProperties()
                .Where(x =&gt; IgnoreProperties.Contains(x.Alias) == false); // skip ignored
            var genericproperties = Mapper.Map&lt;IEnumerable&lt;Property&gt;, IEnumerable&lt;ContentPropertyDisplay&gt;&gt;(noGroupProperties).ToList();
            TranslateProperties(genericproperties);

            tabs.Add(new Tab&lt;ContentPropertyDisplay&gt;
            {
                Id = 0,
                    Label = _localizedTextService.Localize(&quot;general/properties&quot;),
                Alias = &quot;Generic properties&quot;,
                Properties = genericproperties
            });

            // activate the first tab
            tabs.First().IsActive = true;

            return tabs;
        }

        private void TranslateProperties(IEnumerable&lt;ContentPropertyDisplay&gt; properties)
        {
            // Not sure whether it&#39;s a good idea to add this to the ContentPropertyDisplay mapper
            foreach (var prop in properties)
            {
                prop.Label = _localizedTextService.UmbracoDictionaryTranslate(prop.Label);
                prop.Description = _localizedTextService.UmbracoDictionaryTranslate(prop.Description);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,58,20,62,1],[20,63,20,67,1],[22,9,22,85,1],[23,9,23,10,1],[24,13,24,46,1],[24,47,24,103,0],[25,13,25,58,1],[26,13,26,51,1],[27,9,27,10,1],[30,15,30,41,0],[31,9,31,10,0],[32,13,32,42,0],[32,43,32,95,0],[33,13,33,49,0],[34,9,34,10,0],[57,9,57,10,1],[58,13,58,57,1],[58,57,58,66,1],[58,66,58,68,1],[58,13,58,68,1],[61,13,61,63,1],[63,13,63,129,1],[65,13,98,15,1],[100,13,100,42,1],[101,13,101,14,1],[103,17,103,57,1],[104,13,104,14,1],[107,13,107,46,1],[110,13,110,51,1],[111,13,111,14,1],[112,17,112,57,1],[113,13,113,14,1],[116,13,116,52,1],[117,9,117,10,1],[129,9,129,10,0],[131,13,131,107,0],[132,13,132,32,0],[135,21,135,79,0],[137,21,137,27,0],[139,21,139,77,0],[140,21,140,27,0],[142,21,142,79,0],[143,21,143,27,0],[145,21,145,105,0],[149,13,150,69,0],[152,13,152,28,0],[153,13,153,14,0],[154,17,154,216,0],[157,13,157,85,0],[159,13,159,92,0],[160,13,160,32,0],[161,13,161,14,0],[162,17,162,130,0],[165,13,165,65,0],[166,13,166,88,0],[167,13,167,85,0],[168,13,168,33,0],[169,13,169,41,0],[171,13,171,108,0],[173,13,173,55,0],[175,13,175,73,0],[176,13,184,16,0],[185,13,185,57,0],[187,13,187,76,0],[188,9,188,10,0],[194,9,194,10,0],[196,13,196,43,0],[197,13,197,151,0],[198,13,198,14,0],[200,17,200,41,0],[203,17,203,47,0],[204,17,204,18,0],[205,21,205,47,0],[206,17,206,18,0],[208,17,208,66,0],[209,17,209,18,0],[210,21,210,66,0],[211,17,211,18,0],[212,13,212,14,0],[215,13,215,64,0],[216,13,216,41,0],[217,13,217,61,0],[218,13,218,33,0],[219,9,219,10,0],[222,9,222,10,1],[223,13,223,64,1],[229,13,229,74,1],[229,74,229,85,1],[229,85,229,100,1],[229,100,229,106,1],[229,106,229,108,1],[229,13,229,108,1],[230,13,230,20,1],[230,22,230,38,1],[230,39,230,41,1],[230,42,230,60,1],[231,13,231,14,1],[232,17,232,55,1],[235,17,235,24,1],[235,26,235,35,1],[235,36,235,38,1],[235,39,235,51,1],[236,17,236,18,1],[237,21,238,37,1],[238,37,238,80,1],[238,80,238,82,1],[237,21,238,82,1],[240,21,240,58,1],[241,17,241,18,1],[243,17,243,43,1],[244,21,244,30,0],[247,17,247,138,1],[247,138,247,165,1],[247,165,247,168,1],[247,17,247,168,1],[249,17,249,55,1],[253,17,253,58,1],[253,58,253,87,1],[253,87,254,45,1],[253,17,254,45,1],[255,17,255,36,1],[256,17,256,50,1],[257,17,264,20,1],[265,13,265,14,1],[269,13,270,29,1],[270,29,270,72,1],[270,72,270,74,1],[269,13,270,74,1],[271,13,271,136,1],[272,13,272,52,1],[274,13,280,16,1],[283,13,283,42,1],[285,13,285,25,1],[286,9,286,10,1],[289,9,289,10,1],[291,13,291,20,1],[291,22,291,30,1],[291,31,291,33,1],[291,34,291,44,1],[292,13,292,14,1],[293,17,293,91,1],[294,17,294,103,1],[295,13,295,14,1],[296,9,296,10,1]]);
    </script>
  </body>
</html>