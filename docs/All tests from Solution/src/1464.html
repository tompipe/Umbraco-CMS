<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Strategies\RelateOnTrashHandler.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Umbraco.Core.Auditing;
using Umbraco.Core.Events;
using Umbraco.Core.Models;
using Umbraco.Core.Services;

namespace Umbraco.Core.Strategies
{
    public sealed class RelateOnTrashHandler : ApplicationEventHandler
    {
        protected override void ApplicationStarted(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            ContentService.Moved += ContentService_Moved;
            ContentService.Trashed += ContentService_Trashed;
        }

        private void ContentService_Moved(IContentService sender, MoveEventArgs&lt;IContent&gt; e)
        {
            foreach (var item in e.MoveInfoCollection.Where(x =&gt; x.OriginalPath.Contains(Constants.System.RecycleBinContent.ToInvariantString())))
            {
                var relationService = ApplicationContext.Current.Services.RelationService;
                var relationTypeAlias = Constants.Conventions.RelationTypes.RelateParentDocumentOnDeleteAlias;
                var relations = relationService.GetByChildId(item.Entity.Id);

                foreach (var relation in relations.Where(x =&gt; x.RelationType.Alias.InvariantEquals(relationTypeAlias)))
                {
                    relationService.Delete(relation);
                }
            }
        }

        private void ContentService_Trashed(IContentService sender, MoveEventArgs&lt;IContent&gt; e)
        {
            var relationService = ApplicationContext.Current.Services.RelationService;
            var relationTypeAlias = Constants.Conventions.RelationTypes.RelateParentDocumentOnDeleteAlias;
            var relationType = relationService.GetRelationTypeByAlias(relationTypeAlias);

            // check that the relation-type exists, if not, then recreate it
            if (relationType == null)
            {
                var documentObjectType = new Guid(Constants.ObjectTypes.Document);
                var relationTypeName = Constants.Conventions.RelationTypes.RelateParentDocumentOnDeleteName;

                relationType = new RelationType(documentObjectType, documentObjectType, relationTypeAlias, relationTypeName);
                relationService.Save(relationType);
            }

            foreach (var item in e.MoveInfoCollection)
            {
                var originalPath = item.OriginalPath.ToDelimitedList();
                var originalParentId = originalPath.Count &gt; 2
                    ? int.Parse(originalPath[originalPath.Count - 2])
                    : Constants.System.Root;

                // Add a relation for the item being deleted, so that we can know the original parent for if we need to restore later
                var relation = new Relation(originalParentId, item.Entity.Id, relationType);
                relationService.Save(relation);

                ApplicationContext.Current.Services.AuditService.Add(AuditType.Delete,
                    string.Format(&quot;Trashed content with Id: &#39;{0}&#39; related to original parent content with Id: &#39;{1}&#39;&quot;, item.Entity.Id, originalParentId),
                    item.Entity.WriterId,
                    item.Entity.Id);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,10,0],[14,13,14,58,0],[15,13,15,62,0],[16,9,16,10,0],[19,9,19,10,0],[20,13,20,20,0],[20,22,20,30,0],[20,31,20,33,0],[20,34,20,66,0],[20,66,20,145,0],[20,145,20,146,0],[20,34,20,146,0],[21,13,21,14,0],[22,17,22,91,0],[23,17,23,111,0],[24,17,24,78,0],[26,17,26,24,0],[26,26,26,38,0],[26,39,26,41,0],[26,42,26,63,0],[26,63,26,118,0],[26,118,26,119,0],[26,42,26,119,0],[27,17,27,18,0],[28,21,28,54,0],[29,17,29,18,0],[30,13,30,14,0],[31,9,31,10,0],[34,9,34,10,0],[35,13,35,87,0],[36,13,36,107,0],[37,13,37,90,0],[40,13,40,38,0],[41,13,41,14,0],[42,17,42,83,0],[43,17,43,109,0],[45,17,45,126,0],[46,17,46,52,0],[47,13,47,14,0],[49,13,49,20,0],[49,22,49,30,0],[49,31,49,33,0],[49,34,49,54,0],[50,13,50,14,0],[51,17,51,72,0],[52,17,54,45,0],[57,17,57,93,0],[58,17,58,48,0],[60,17,63,37,0],[64,13,64,14,0],[65,9,65,10,0]]);
    </script>
  </body>
</html>