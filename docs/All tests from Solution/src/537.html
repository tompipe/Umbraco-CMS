<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\UmbracoContext.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web;
using Umbraco.Core.Configuration;
using umbraco.BasePages;
using umbraco.cms.businesslogic.web;
using umbraco.BusinessLogic;
using System.Xml;
using umbraco.presentation.preview;
using Examine.Providers;
using Examine;
using Umbraco.Core;

namespace umbraco.presentation
{
    /// &lt;summary&gt;
    /// Class that encapsulates Umbraco information of a specific HTTP request.
    /// &lt;/summary&gt;
    [Obsolete(&quot;Use Umbraco.Web.UmbracoContext instead&quot;)]
    public class UmbracoContext
    {
        private UmbracoServerUtility _server;
        private UmbracoRequest _request;
        private UmbracoResponse _response;
        private readonly HttpContextBase _httpContext;
        private PreviewContent _previewContent;

        /// &lt;summary&gt;
        /// Creates a new Umbraco context.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;httpContext&quot;&gt;&lt;/param&gt;
        public UmbracoContext(HttpContextBase httpContext)
        {
            _httpContext = httpContext;
        }

        /// &lt;summary&gt;
        /// Creates a new Umbraco context.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;httpContext&quot;&gt;The HTTP context on which the Umbraco context operates.&lt;/param&gt;
        [Obsolete(&quot;Use the contructor accepting an HttpContextBase object instead&quot;)]
        public UmbracoContext(HttpContext httpContext)
        {
            _httpContext = new HttpContextWrapper(httpContext);
        }

        /// &lt;summary&gt;
        /// Gets the current Umbraco Context.
        /// &lt;/summary&gt;
        public static UmbracoContext Current
        {
            get
            {
                if (HttpContext.Current != null)
                    return (UmbracoContext)HttpContext.Current.Items[&quot;UmbracoContext&quot;];

                return null;
            }

            internal set
            {
                if (Current != null)
                    throw new ApplicationException(&quot;The current httpContext can only be set once during a request.&quot;);

                HttpContext.Current.Items[&quot;UmbracoContext&quot;] = value;
            }
        }

        /// &lt;summary&gt;
        /// Gets the current page ID, or &lt;c&gt;null&lt;/c&gt; if no page ID is available (e.g. a custom page).
        /// &lt;/summary&gt;
        public virtual int? PageId { get { return Umbraco.Web.UmbracoContext.Current.PageId; } }

        /// &lt;summary&gt;
        /// Gets the current logged in Umbraco user (editor).
        /// &lt;/summary&gt;
        /// &lt;value&gt;The Umbraco user object or null&lt;/value&gt;
        public virtual User UmbracoUser { get { return Umbraco.Web.UmbracoContext.Current.UmbracoUser; } }

        /// &lt;summary&gt;
        /// Determines whether the current user is in a preview mode and browsing the site (ie. not in the admin UI)
        /// &lt;/summary&gt;
        public virtual bool InPreviewMode { get { return Umbraco.Web.UmbracoContext.Current.InPreviewMode; } }

        public XmlDocument GetXml()
        {
            var umbracoContext = Umbraco.Web.UmbracoContext.Current;
            var cache = umbracoContext.ContentCache.InnerCache as Umbraco.Web.PublishedCache.XmlPublishedCache.PublishedContentCache;
            if (cache == null)
                throw new InvalidOperationException(&quot;Unsupported IPublishedContentCache, only the Xml one is supported.&quot;);

            return cache.GetXml(umbracoContext, umbracoContext.InPreviewMode);
        }

        /// &lt;summary&gt;
        /// Determines whether the current user has the specified permission on the current page.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;permissionToken&quot;&gt;The permission token.&lt;/param&gt;
        /// &lt;returns&gt;
        /// 	&lt;c&gt;true&lt;/c&gt; if the user has permission; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/returns&gt;
        public virtual bool HasPermission(char permissionToken)
        {
            int? pageId = UmbracoContext.Current.PageId;
            return pageId.HasValue
                    &amp;&amp; UmbracoEnsuredPage.CurrentUser != null
                    &amp;&amp; UmbracoEnsuredPage.CurrentUser.GetPermissions(new Document(pageId.Value).Path)
                        .Contains(permissionToken.ToString());
        }

        public virtual bool NewSchemaMode
        {
            get
            {
                return !UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema;
            }
        }
        
        /// &lt;summary&gt;
        /// Gets the response for the current context
        /// &lt;/summary&gt;
        /// &lt;value&gt;The response.&lt;/value&gt;
        public virtual UmbracoResponse Response
        {
            get
            {
                if (_response == null)
                {
                    _response = new UmbracoResponse(this._httpContext.Response);
                }
                return _response;
            }
        }

        public virtual TraceContext Trace
        {
            get
            {
                return this._httpContext.Trace;
            }
        }

        /// &lt;summary&gt;
        /// Gets the request for the current context
        /// &lt;/summary&gt;
        /// &lt;value&gt;The request.&lt;/value&gt;
        public virtual UmbracoRequest Request
        {
            get
            {
                if (_request == null)
                {
                    _request = new UmbracoRequest(this._httpContext.Request);
                }
                return _request;
            }
        }

        /// &lt;summary&gt;
        /// Gets the base URL for the website
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public virtual string GetBaseUrl()
        {
            return this.Request.Url.GetLeftPart(UriPartial.Authority);
        }

        public virtual UmbracoServerUtility Server
        {
            get
            {
                if (_server == null)
                {
                    _server = new UmbracoServerUtility(this._httpContext.Server);
                }
                return _server;
            }
        }

        /// &lt;summary&gt;
        /// Gets the internal search provider from Examine.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The internal search provider.&lt;/value&gt;
        public virtual BaseSearchProvider InternalSearchProvider
        {
            get
            {
                return ExamineManager.Instance.SearchProviderCollection[Constants.Examine.InternalSearcher];
            }
        }

        /// &lt;summary&gt;
        /// Gets the internal member search provider from Examine.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The internal search provider.&lt;/value&gt;
        public virtual BaseSearchProvider InternalMemberSearchProvider
        {
            get
            {
                return ExamineManager.Instance.SearchProviderCollection[Constants.Examine.InternalMemberSearcher];
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,59,0],[32,9,32,10,0],[33,13,33,40,0],[34,9,34,10,0],[41,9,41,55,0],[42,9,42,10,0],[43,13,43,64,0],[44,9,44,10,0],[52,13,52,14,0],[53,17,53,49,0],[54,21,54,88,0],[56,17,56,29,0],[57,13,57,14,0],[60,13,60,14,0],[61,17,61,37,0],[62,21,62,118,0],[64,17,64,69,0],[65,13,65,14,0],[71,42,71,43,0],[71,44,71,93,0],[71,94,71,95,0],[77,47,77,48,0],[77,49,77,103,0],[77,104,77,105,0],[82,49,82,50,0],[82,51,82,107,0],[82,108,82,109,0],[85,9,85,10,0],[86,13,86,69,0],[87,13,87,134,0],[88,13,88,31,0],[89,17,89,123,0],[91,13,91,79,0],[92,9,92,10,0],[102,9,102,10,0],[103,13,103,57,0],[104,13,107,63,0],[108,9,108,10,0],[113,13,113,14,0],[114,17,114,88,0],[115,13,115,14,0],[125,13,125,14,0],[126,17,126,39,0],[127,17,127,18,0],[128,21,128,81,0],[129,17,129,18,0],[130,17,130,34,0],[131,13,131,14,0],[137,13,137,14,0],[138,17,138,48,0],[139,13,139,14,0],[149,13,149,14,0],[150,17,150,38,0],[151,17,151,18,0],[152,21,152,78,0],[153,17,153,18,0],[154,17,154,33,0],[155,13,155,14,0],[163,9,163,10,0],[164,13,164,71,0],[165,9,165,10,0],[170,13,170,14,0],[171,17,171,37,0],[172,17,172,18,0],[173,21,173,82,0],[174,17,174,18,0],[175,17,175,32,0],[176,13,176,14,0],[186,13,186,14,0],[187,17,187,109,0],[188,13,188,14,0],[198,13,198,14,0],[199,17,199,115,0],[200,13,200,14,0]]);
    </script>
  </body>
</html>