<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Logging\RingBufferTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Threading;
using System.Threading.Tasks;
using NUnit.Framework;
using Umbraco.Core.Logging;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Logging
{
    /// &lt;summary&gt;
    /// Borrowed from https://github.com/cjbhaines/Log4Net.Async - will reference Nuget packages directly in v8
    /// &lt;/summary&gt;
    [TestFixture]
    public class RingBufferTest
    {
        [Test]
        public void PerfTest()
        {
            RingBuffer&lt;string&gt; ringBuffer = new RingBuffer&lt;string&gt;(1000);
            Stopwatch ringWatch = new Stopwatch();
            ringWatch.Start();
            for (int i = 0; i &lt; 1000000; i++)
            {
                ringBuffer.Enqueue(&quot;StringOfFun&quot;);
            }
            ringWatch.Stop();

            Assert.That(ringWatch.ElapsedMilliseconds, Is.LessThan(150));
        }

        [Test]
        public void PerfTestThreads()
        {
            RingBuffer&lt;string&gt; ringBuffer = new RingBuffer&lt;string&gt;(1000);

            Stopwatch ringWatch = new Stopwatch();
            List&lt;Task&gt; ringTasks = new List&lt;Task&gt;();
            CancellationTokenSource cancelationTokenSource = new CancellationTokenSource();
            CancellationToken cancelationToken = cancelationTokenSource.Token;
            for (int t = 0; t &lt; 10; t++)
            {
                ringTasks.Add(new Task(() =&gt;
                {
                    for (int i = 0; i &lt; 1000000; i++)
                    {
                        ringBuffer.Enqueue(&quot;StringOfFun&quot;);
                    }
                }, cancelationToken));
            }
            ringWatch.Start();
            ringTasks.ForEach(t =&gt; t.Start());
            var allTasks = ringTasks.ToArray();
            Task.WaitAny(allTasks);
            ringWatch.Stop();
            //Cancel tasks to avoid System.AppDominUnloadException which is caused when the domain is unloaded
            //and threads created in the domain are not stopped.
            //Do this before assertions because they may throw an exception causing the thread cancellation to not happen.
            cancelationTokenSource.Cancel();
            try
            {
                Task.WaitAll(allTasks);
            }
            catch (AggregateException)
            {
                //Don&#39;t care about cancellation Exceptions.
            }
            //Tolerance at 500 was too low
            ringTasks.ForEach(t =&gt; t.Dispose());
            Assert.That(ringWatch.ElapsedMilliseconds, Is.LessThan(1000));
        }

        [Test]
        public void PerfTestThreadsWithDequeues()
        {
            RingBuffer&lt;string&gt; ringBuffer = new RingBuffer&lt;string&gt;(1000);

            Stopwatch ringWatch = new Stopwatch();
            List&lt;Task&gt; ringTasks = new List&lt;Task&gt;();
            CancellationTokenSource cancelationTokenSource = new CancellationTokenSource();
            CancellationToken cancelationToken = cancelationTokenSource.Token;
            for (int t = 0; t &lt; 10; t++)
            {
                ringTasks.Add(new Task(() =&gt;
                {
                    for (int i = 0; i &lt; 1000000; i++)
                    {
                        ringBuffer.Enqueue(&quot;StringOfFun&quot;);
                    }
                }, cancelationToken));
            }
            for (int t = 0; t &lt; 10; t++)
            {
                ringTasks.Add(new Task(() =&gt;
                {
                    for (int i = 0; i &lt; 1000000; i++)
                    {
                        string foo;
                        ringBuffer.TryDequeue(out foo);
                    }
                }));
            }
            ringWatch.Start();
            ringTasks.ForEach(t =&gt; t.Start());
            var allTasks = ringTasks.ToArray();
            Task.WaitAny(allTasks);
            ringWatch.Stop();
            //Cancel tasks to avoid System.AppDominUnloadException which is caused when the domain is unloaded
            //and threads created in the domain are not stopped.
            //Do this before assertions because they may throw an exception causing the thread cancellation to not happen.
            cancelationTokenSource.Cancel();
            try
            {
                Task.WaitAll(allTasks);
            }
            catch (AggregateException)
            {
                //Don&#39;t care about cancellation Exceptions.
            }
            ringTasks.ForEach(t =&gt; t.Dispose());
            Assert.That(ringWatch.ElapsedMilliseconds, Is.LessThan(800));
        }

        [Test]
        public void WhenRingSizeLimitIsHit_ItemsAreDequeued()
        {
            // Arrange
            const int limit = 2;
            object object1 = &quot;one&quot;;
            object object2 = &quot;two&quot;;
            object object3 = &quot;three&quot;;
            RingBuffer&lt;object&gt; queue = new RingBuffer&lt;object&gt;(limit);

            // Act
            queue.Enqueue(object1);
            queue.Enqueue(object2);
            queue.Enqueue(object3);

            // Assert
            object value;
            queue.TryDequeue(out value);
            Assert.That(value, Is.EqualTo(object2));
            queue.TryDequeue(out value);
            Assert.That(value, Is.EqualTo(object3));
            queue.TryDequeue(out value);
            Assert.That(value, Is.Null);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,74,1],[22,13,22,51,1],[23,13,23,31,1],[24,18,24,27,1],[24,29,24,40,1],[24,42,24,45,1],[25,13,25,14,1],[26,17,26,51,1],[27,13,27,14,1],[28,13,28,30,1],[30,13,30,74,1],[31,9,31,10,0],[35,9,35,10,1],[36,13,36,74,1],[38,13,38,51,1],[39,13,39,53,1],[40,13,40,92,1],[41,13,41,79,1],[42,18,42,27,1],[42,29,42,35,1],[42,37,42,40,1],[43,13,43,14,1],[44,17,45,17,1],[45,17,45,18,1],[45,18,46,26,1],[46,26,46,35,1],[46,35,46,37,1],[46,37,46,48,1],[46,48,46,50,1],[46,50,46,53,1],[46,53,47,21,1],[47,21,47,22,1],[47,22,48,25,1],[48,25,48,59,1],[48,59,49,21,1],[49,21,49,22,1],[49,22,50,17,1],[50,17,50,18,1],[50,18,50,39,1],[44,17,50,39,1],[51,13,51,14,1],[52,13,52,31,1],[53,13,53,36,1],[53,36,53,45,1],[53,45,53,47,1],[53,13,53,47,1],[54,13,54,48,1],[55,13,55,36,1],[56,13,56,30,1],[60,13,60,45,1],[62,13,62,14,1],[63,17,63,40,1],[64,13,64,14,1],[65,13,65,39,0],[66,13,66,14,0],[68,13,68,14,0],[70,13,70,36,1],[70,36,70,47,1],[70,47,70,49,1],[70,13,70,49,1],[71,13,71,75,1],[72,9,72,10,0],[76,9,76,10,1],[77,13,77,74,1],[79,13,79,51,1],[80,13,80,53,1],[81,13,81,92,1],[82,13,82,79,1],[83,18,83,27,1],[83,29,83,35,1],[83,37,83,40,1],[84,13,84,14,1],[85,17,86,17,1],[86,17,86,18,1],[86,18,87,26,1],[87,26,87,35,1],[87,35,87,37,1],[87,37,87,48,1],[87,48,87,50,1],[87,50,87,53,1],[87,53,88,21,1],[88,21,88,22,1],[88,22,89,25,1],[89,25,89,59,1],[89,59,90,21,1],[90,21,90,22,1],[90,22,91,17,1],[91,17,91,18,1],[91,18,91,39,1],[85,17,91,39,1],[92,13,92,14,1],[93,18,93,27,1],[93,29,93,35,1],[93,37,93,40,1],[94,13,94,14,1],[95,17,96,17,1],[96,17,96,18,1],[96,18,97,26,1],[97,26,97,35,1],[97,35,97,37,1],[97,37,97,48,1],[97,48,97,50,1],[97,50,97,53,1],[97,53,98,21,1],[98,21,98,22,1],[98,22,100,25,1],[100,25,100,56,1],[100,56,101,21,1],[101,21,101,22,1],[101,22,102,17,1],[102,17,102,18,1],[102,18,102,21,1],[95,17,102,21,1],[103,13,103,14,1],[104,13,104,31,1],[105,13,105,36,1],[105,36,105,45,1],[105,45,105,47,1],[105,13,105,47,1],[106,13,106,48,1],[107,13,107,36,1],[108,13,108,30,1],[112,13,112,45,1],[114,13,114,14,1],[115,17,115,40,1],[116,13,116,14,1],[117,13,117,39,0],[118,13,118,14,0],[120,13,120,14,0],[121,13,121,36,1],[121,36,121,47,1],[121,47,121,49,1],[121,13,121,49,1],[122,13,122,74,1],[123,9,123,10,0],[127,9,127,10,1],[130,13,130,36,1],[131,13,131,36,1],[132,13,132,38,1],[133,13,133,70,1],[136,13,136,36,1],[137,13,137,36,1],[138,13,138,36,1],[142,13,142,41,1],[143,13,143,53,1],[144,13,144,41,1],[145,13,145,53,1],[146,13,146,41,1],[147,13,147,41,1],[148,9,148,10,1]]);
    </script>
  </body>
</html>