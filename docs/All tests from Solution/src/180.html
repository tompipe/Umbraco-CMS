<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\EntityServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Services
{
    /// &lt;summary&gt;
    /// Tests covering the EntityService
    /// &lt;/summary&gt;
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerFixture)]
    [TestFixture, RequiresSTA]
    public class EntityServiceTests : BaseServiceTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }
        
        [Test]
        public void EntityService_Can_Find_All_Content_By_UmbracoObjectTypes()
        {
            var service = ServiceContext.EntityService;

            var entities = service.GetAll(UmbracoObjectTypes.Document).ToArray();

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(4));
            Assert.That(entities.Any(x =&gt; x.Trashed), Is.True);
        }

        [Test]
        public void EntityService_Can_Find_All_Content_By_UmbracoObjectType_Id()
        {
            var service = ServiceContext.EntityService;

            var objectTypeId = new Guid(Constants.ObjectTypes.Document);
            var entities = service.GetAll(objectTypeId).ToArray();

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(4));
            Assert.That(entities.Any(x =&gt; x.Trashed), Is.True);
        }

        [Test]
        public void EntityService_Can_Find_All_Content_By_Type()
        {
            var service = ServiceContext.EntityService;

            var entities = service.GetAll&lt;IContent&gt;().ToArray();

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(4));
            Assert.That(entities.Any(x =&gt; x.Trashed), Is.True);
        }

        [Test]
        public void EntityService_Can_Get_Child_Content_By_ParentId_And_UmbracoObjectType()
        {
            var service = ServiceContext.EntityService;

            var entities = service.GetChildren(-1, UmbracoObjectTypes.Document).ToArray();

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(1));
            Assert.That(entities.Any(x =&gt; x.Trashed), Is.False);
        }

        [Test]
        public void EntityService_Can_Get_Children_By_ParentId()
        {
            var service = ServiceContext.EntityService;

            var entities = service.GetChildren(folderId);

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(3));
            Assert.That(entities.Any(x =&gt; x.Trashed), Is.False);
        }

        [Test]
        public void EntityService_Can_Get_Descendants_By_ParentId()
        {
            var service = ServiceContext.EntityService;

            var entities = service.GetDescendents(folderId);

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(4));
            Assert.That(entities.Any(x =&gt; x.Trashed), Is.False);
        }

        [Test]
        public void EntityService_Throws_When_Getting_All_With_Invalid_Type()
        {
            var service = ServiceContext.EntityService;
            var objectTypeId = new Guid(Constants.ObjectTypes.ContentItem);

            Assert.Throws&lt;NotSupportedException&gt;(() =&gt; service.GetAll&lt;IContentBase&gt;());
            Assert.Throws&lt;NullReferenceException&gt;(() =&gt; service.GetAll(UmbracoObjectTypes.ContentItem));
            Assert.Throws&lt;NullReferenceException&gt;(() =&gt; service.GetAll(objectTypeId));
        }

        [Test]
        public void EntityService_Can_Find_All_ContentTypes_By_UmbracoObjectTypes()
        {
            var service = ServiceContext.EntityService;

            var entities = service.GetAll(UmbracoObjectTypes.DocumentType).ToArray();

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(1));
        }

        [Test]
        public void EntityService_Can_Find_All_ContentTypes_By_UmbracoObjectType_Id()
        {
            var service = ServiceContext.EntityService;

            var objectTypeId = new Guid(Constants.ObjectTypes.DocumentType);
            var entities = service.GetAll(objectTypeId).ToArray();

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(1));
        }

        [Test]
        public void EntityService_Can_Find_All_ContentTypes_By_Type()
        {
            var service = ServiceContext.EntityService;

            var entities = service.GetAll&lt;IContentType&gt;().ToArray();

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(1));
        }

        [Test]
        public void EntityService_Can_Find_All_Media_By_UmbracoObjectTypes()
        {
            var service = ServiceContext.EntityService;

            var entities = service.GetAll(UmbracoObjectTypes.Media).ToArray();

            Assert.That(entities.Any(), Is.True);
            Assert.That(entities.Count(), Is.EqualTo(5));

            Assert.That(
                entities.Any(
                    x =&gt;
                    x.AdditionalData.Any(y =&gt; y.Value is UmbracoEntity.EntityProperty 
                        &amp;&amp; ((UmbracoEntity.EntityProperty)y.Value).PropertyEditorAlias == Constants.PropertyEditors.UploadFieldAlias)), Is.True);
        }

        [Test]
        public void EntityService_Can_Get_ObjectType()
        {
            var service = ServiceContext.EntityService;
            var mediaObjectType = service.GetObjectType(1031);

            Assert.NotNull(mediaObjectType);
            Assert.AreEqual(mediaObjectType, UmbracoObjectTypes.MediaType);
        }

        private static bool _isSetup = false;

        private int folderId;

        public override void CreateTestData()
        {
            if (_isSetup == false)
            {
                _isSetup = true;

                base.CreateTestData();

                //Create and Save folder-Media -&gt; 1050
                var folderMediaType = ServiceContext.ContentTypeService.GetMediaType(1031);
                var folder = MockedMedia.CreateMediaFolder(folderMediaType, -1);                
                ServiceContext.MediaService.Save(folder, 0);
                folderId = folder.Id;

                //Create and Save image-Media -&gt; 1051
                var imageMediaType = ServiceContext.ContentTypeService.GetMediaType(1032);
                var image = MockedMedia.CreateMediaImage(imageMediaType, folder.Id);
                ServiceContext.MediaService.Save(image, 0);

                //Create and Save file-Media -&gt; 1052
                var fileMediaType = ServiceContext.ContentTypeService.GetMediaType(1033);
                var file = MockedMedia.CreateMediaFile(fileMediaType, folder.Id);
                ServiceContext.MediaService.Save(file, 0);

                var subfolder = MockedMedia.CreateMediaFolder(folderMediaType, folder.Id);
                ServiceContext.MediaService.Save(subfolder, 0);
                var subfolder2 = MockedMedia.CreateMediaFolder(folderMediaType, subfolder.Id);
                ServiceContext.MediaService.Save(subfolder2, 0);
                
            }
            
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,31,1],[22,9,22,10,1],[26,9,26,10,1],[27,13,27,29,1],[28,9,28,10,1],[32,9,32,10,1],[33,13,33,56,1],[35,13,35,82,1],[37,13,37,50,1],[38,13,38,58,1],[39,13,39,43,1],[39,43,39,52,1],[39,52,39,64,1],[39,13,39,64,1],[40,9,40,10,1],[44,9,44,10,1],[45,13,45,56,1],[47,13,47,73,1],[48,13,48,67,1],[50,13,50,50,1],[51,13,51,58,1],[52,13,52,43,1],[52,43,52,52,1],[52,52,52,64,1],[52,13,52,64,1],[53,9,53,10,1],[57,9,57,10,1],[58,13,58,56,1],[60,13,60,65,1],[62,13,62,50,1],[63,13,63,58,1],[64,13,64,43,1],[64,43,64,52,1],[64,52,64,64,1],[64,13,64,64,1],[65,9,65,10,1],[69,9,69,10,1],[70,13,70,56,1],[72,13,72,91,1],[74,13,74,50,1],[75,13,75,58,1],[76,13,76,43,1],[76,43,76,52,1],[76,52,76,65,1],[76,13,76,65,1],[77,9,77,10,1],[81,9,81,10,1],[82,13,82,56,1],[84,13,84,58,1],[86,13,86,50,1],[87,13,87,58,1],[88,13,88,43,1],[88,43,88,52,1],[88,52,88,65,1],[88,13,88,65,1],[89,9,89,10,1],[93,9,93,10,1],[94,13,94,56,1],[96,13,96,61,1],[98,13,98,50,1],[99,13,99,58,1],[100,13,100,43,1],[100,43,100,52,1],[100,52,100,65,1],[100,13,100,65,1],[101,9,101,10,1],[105,9,105,10,1],[106,13,106,56,1],[107,13,107,76,1],[109,13,109,56,1],[109,56,109,86,1],[109,86,109,88,1],[109,13,109,88,1],[110,13,110,57,1],[110,57,110,103,1],[110,103,110,105,1],[110,13,110,105,1],[111,13,111,57,1],[111,57,111,85,1],[111,85,111,87,1],[111,13,111,87,1],[112,9,112,10,1],[116,9,116,10,1],[117,13,117,56,1],[119,13,119,86,1],[121,13,121,50,1],[122,13,122,58,1],[123,9,123,10,1],[127,9,127,10,1],[128,13,128,56,1],[130,13,130,77,1],[131,13,131,67,1],[133,13,133,50,1],[134,13,134,58,1],[135,9,135,10,1],[139,9,139,10,1],[140,13,140,56,1],[142,13,142,69,1],[144,13,144,50,1],[145,13,145,58,1],[146,9,146,10,1],[150,9,150,10,1],[151,13,151,56,1],[153,13,153,79,1],[155,13,155,50,1],[156,13,156,58,1],[158,13,161,21,1],[161,21,161,47,1],[161,47,162,133,1],[162,133,162,134,1],[161,21,162,134,1],[162,134,162,146,1],[158,13,162,146,1],[163,9,163,10,1],[167,9,167,10,1],[168,13,168,56,1],[169,13,169,63,1],[171,13,171,45,1],[172,13,172,76,1],[173,9,173,10,1],[175,9,175,46,1],[180,9,180,10,1],[181,13,181,35,1],[182,13,182,14,1],[183,17,183,33,1],[185,17,185,39,1],[188,17,188,92,1],[189,17,189,81,1],[190,17,190,61,1],[191,17,191,38,1],[194,17,194,91,1],[195,17,195,85,1],[196,17,196,60,1],[199,17,199,90,1],[200,17,200,82,1],[201,17,201,59,1],[203,17,203,91,1],[204,17,204,64,1],[205,17,205,95,1],[206,17,206,65,1],[208,13,208,14,1],[210,9,210,10,1]]);
    </script>
  </body>
</html>