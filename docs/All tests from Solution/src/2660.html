<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\tags\DataEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Linq;
using System.Web.UI;
using System.Web.UI.WebControls;
using ClientDependency.Core.Controls;
using ClientDependency.Core;
using umbraco.interfaces;

namespace umbraco.editorControls.tags
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class DataEditor : TextBox, IDataEditor, IUseTags
    {
        #region IDataEditor Members

        private readonly cms.businesslogic.datatype.DefaultData _data;
        readonly string _group = &quot;&quot;;

        public DataEditor(IData Data, SortedList Prevalues)
        {
            _data = (cms.businesslogic.datatype.DefaultData)Data;

            if (Prevalues[&quot;group&quot;] != null)
                _group = Prevalues[&quot;group&quot;].ToString();
        }

        public Control Editor { get { return this; } }

        public void Save()
        {
            int nodeId = _data.NodeId;

            //first clear out all items associated with this ID...
            cms.businesslogic.Tags.Tag.RemoveTagsFromNode(nodeId, _group);

            UpdateOrAddTags(nodeId);

            //and just in case, we&#39;ll save the tags as plain text on the node itself... 
            _data.Value = this.Text;
        }

     
        public bool ShowLabel
        {
            get { return true; }
        }

        public bool TreatAsRichTextEditor
        {
            get { return false; }
        }


        [Obsolete(&quot;use the umbraco.cms.businesslogic.Tags.Tag class instead&quot;)]
        public int getTagId(string tag, string group)
        {
            return cms.businesslogic.Tags.Tag.GetTagId(tag, group);
        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            // register all dependencies - only registered once
            ClientDependencyLoader.Instance.RegisterDependency(&quot;css/umbracoGui.css&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Css);
            ClientDependencyLoader.Instance.RegisterDependency(&quot;tags/css/jquery.tagsinput.css&quot;, &quot;UmbracoClient&quot;, ClientDependencyType.Css);
            ClientDependencyLoader.Instance.RegisterDependency(&quot;tags/js/jquery.tagsinput.min.js&quot;, &quot;UmbracoClient&quot;, ClientDependencyType.Javascript);

            var pageId = GetPageId();
            if (!Page.IsPostBack &amp;&amp; !String.IsNullOrEmpty(pageId) &amp;&amp; string.IsNullOrWhiteSpace(this.Text))
            {
                var tags = cms.businesslogic.Tags.Tag.GetTags(int.Parse(pageId), _group);
                this.Text = string.Join(&quot;,&quot;, tags.Select(x =&gt; x.TagCaption));
            }

            var tagsAutoCompleteScript = TagsAutocompleteScript(pageId);
            var tagsAutoCompleteInitScript = string.Format(&quot;jQuery(document).ready(function(){{{0}}});&quot;, tagsAutoCompleteScript);

            // register it as a startup script
            Page.ClientScript.RegisterStartupScript(GetType(), ClientID + &quot;_tagsinit&quot;, tagsAutoCompleteInitScript, true);
        }

        private string TagsAutocompleteScript(string pageId)
        {
            var tagsAutoCompleteScript = string.Format(&quot;jQuery(&#39;#{0}&#39;).tagsInput({{ width: &#39;400px&#39;, defaultText: &#39;Add a tag&#39;, minChars: 2, autocomplete_url: &#39;{1}/webservices/TagsAutoCompleteHandler.ashx?group={2}&amp;id={3}&amp;rnd={4}&amp;format=json&#39; }});&quot;, 
                this.ClientID, 
                Umbraco.Core.IO.IOHelper.ResolveUrl(Umbraco.Core.IO.SystemDirectories.Umbraco), 
                _group, 
                pageId, 
                DateTime.Now.Ticks);

            return tagsAutoCompleteScript;
        }

        private static string GetPageId()
        {
            var pageId = Umbraco.Web.UmbracoContext.Current.HttpContext.Request[&quot;id&quot;];
            if (string.IsNullOrEmpty(pageId))
            {
                // we need an empty try/catch as Node.GetCurrent() will throw an exception if we&#39;re outside of Umbraco Context
                try
                {
                    var currentNode = NodeFactory.Node.GetCurrent();
                    if (currentNode != null)
                    {
                        pageId = currentNode.Id.ToString();
                    }
                }
                catch
                {
                }
            }
            if (pageId != null) pageId = pageId.Trim();
            return pageId;
        }

        private void UpdateOrAddTags(int nodeId)
        {
            var items = this.Text.Trim().Split(&#39;,&#39;);
            foreach (var item in items)
            {
                var tagName = item.Trim();
                if (string.IsNullOrEmpty(tagName))
                    continue;

                var tagId = cms.businesslogic.Tags.Tag.GetTagId(tagName, _group);
                if (tagId == 0)
                    tagId = cms.businesslogic.Tags.Tag.AddTag(tagName, _group);

                if (tagId &gt; 0)
                {
                    cms.businesslogic.Tags.Tag.AssociateTagToNode(nodeId, tagId);
                }
            }
        }

        #endregion

        #region IUseTags Members

        public string Group
        {
            get { return _group; }
        }

        public void RemoveTag(int nodeId, string tag)
        {
            cms.businesslogic.Tags.Tag.RemoveTagFromNode(nodeId, tag, _group);
        }

        public System.Collections.Generic.List&lt;ITag&gt; GetTagsFromNode(int nodeId)
        {
            return cms.businesslogic.Tags.Tag.GetTags(nodeId).Cast&lt;ITag&gt;().ToList();
        }

        public System.Collections.Generic.List&lt;ITag&gt; GetAllTags()
        {
            return cms.businesslogic.Tags.Tag.GetTags(_group).Cast&lt;ITag&gt;().ToList();
        }

        public void AddTag(string tag)
        {
            cms.businesslogic.Tags.Tag.AddTag(tag, _group);
        }

        public void AddTagToNode(int nodeId, string tag)
        {
            cms.businesslogic.Tags.Tag.AddTagsToNode(nodeId, tag, _group);
        }

        public void RemoveTagsFromNode(int nodeId)
        {
            foreach (var tag in cms.businesslogic.Tags.Tag.GetTags(nodeId).Cast&lt;ITag&gt;().ToList())
                cms.businesslogic.Tags.Tag.RemoveTagFromNode(nodeId, tag.TagCaption, tag.Group);
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,37,0],[20,9,20,60,0],[21,9,21,10,0],[22,13,22,66,0],[24,13,24,44,0],[25,17,25,56,0],[26,9,26,10,0],[28,37,28,38,0],[28,39,28,51,0],[28,52,28,53,0],[31,9,31,10,0],[32,13,32,39,0],[35,13,35,75,0],[37,13,37,37,0],[40,13,40,37,0],[41,9,41,10,0],[46,17,46,18,0],[46,19,46,31,0],[46,32,46,33,0],[51,17,51,18,0],[51,19,51,32,0],[51,33,51,34,0],[57,9,57,10,0],[58,13,58,68,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,28,0],[66,13,66,127,0],[67,13,67,140,0],[68,13,68,149,0],[70,13,70,38,0],[71,13,71,107,0],[72,13,72,14,0],[73,17,73,90,0],[74,17,74,63,0],[74,63,74,75,0],[74,75,74,78,0],[74,17,74,78,0],[75,13,75,14,0],[77,13,77,73,0],[78,13,78,130,0],[81,13,81,122,0],[82,9,82,10,0],[85,9,85,10,0],[86,13,91,37,0],[93,13,93,43,0],[94,9,94,10,0],[97,9,97,10,0],[98,13,98,87,0],[99,13,99,46,0],[100,13,100,14,0],[103,17,103,18,0],[104,21,104,69,0],[105,21,105,45,0],[106,21,106,22,0],[107,25,107,60,0],[108,21,108,22,0],[109,17,109,18,0],[110,17,110,22,0],[111,17,111,18,0],[112,17,112,18,0],[113,13,113,14,0],[114,13,114,32,0],[114,33,114,56,0],[115,13,115,27,0],[116,9,116,10,0],[119,9,119,10,0],[120,13,120,53,0],[121,13,121,20,0],[121,22,121,30,0],[121,31,121,33,0],[121,34,121,39,0],[122,13,122,14,0],[123,17,123,43,0],[124,17,124,51,0],[125,21,125,30,0],[127,17,127,82,0],[128,17,128,32,0],[129,21,129,80,0],[131,17,131,31,0],[132,17,132,18,0],[133,21,133,82,0],[134,17,134,18,0],[135,13,135,14,0],[136,9,136,10,0],[144,17,144,18,0],[144,19,144,33,0],[144,34,144,35,0],[148,9,148,10,0],[149,13,149,79,0],[150,9,150,10,0],[153,9,153,10,0],[154,13,154,85,0],[155,9,155,10,0],[158,9,158,10,0],[159,13,159,85,0],[160,9,160,10,0],[163,9,163,10,0],[164,13,164,60,0],[165,9,165,10,0],[168,9,168,10,0],[169,13,169,75,0],[170,9,170,10,0],[173,9,173,10,0],[174,13,174,20,0],[174,22,174,29,0],[174,30,174,32,0],[174,33,174,97,0],[175,17,175,97,0],[176,9,176,10,0]]);
    </script>
  </body>
</html>