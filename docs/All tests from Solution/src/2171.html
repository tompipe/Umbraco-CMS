<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Dynamics\ClassFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Reflection;
using System.Reflection.Emit;
using System.Threading;

namespace Umbraco.Core.Dynamics
{
	internal class ClassFactory
	{
		public static readonly ClassFactory Instance = new ClassFactory();

		static ClassFactory() { }  // Trigger lazy initialization of static fields

		ModuleBuilder module;
		Dictionary&lt;Signature, Type&gt; classes;
		int classCount;
		ReaderWriterLock rwLock;

		protected ClassFactory()
		{
			AssemblyName name = new AssemblyName(&quot;DynamicClasses&quot;);
			AssemblyBuilder assembly = AppDomain.CurrentDomain.DefineDynamicAssembly(name, AssemblyBuilderAccess.Run);
#if ENABLE_LINQ_PARTIAL_TRUST
            new ReflectionPermission(PermissionState.Unrestricted).Assert();
#endif
			try
			{
				module = assembly.DefineDynamicModule(&quot;Module&quot;);
			}
			finally
			{
#if ENABLE_LINQ_PARTIAL_TRUST
                PermissionSet.RevertAssert();
#endif
			}
			classes = new Dictionary&lt;Signature, Type&gt;();
			rwLock = new ReaderWriterLock();
		}

		public Type GetDynamicClass(IEnumerable&lt;DynamicProperty&gt; properties)
		{
			rwLock.AcquireReaderLock(Timeout.Infinite);
			try
			{
				Signature signature = new Signature(properties);
				Type type;
				if (!classes.TryGetValue(signature, out type))
				{
					type = CreateDynamicClass(signature.Properties);
					classes.Add(signature, type);
				}
				return type;
			}
			finally
			{
				rwLock.ReleaseReaderLock();
			}
		}

		Type CreateDynamicClass(DynamicProperty[] properties)
		{
			LockCookie cookie = rwLock.UpgradeToWriterLock(Timeout.Infinite);
			try
			{
				string typeName = &quot;DynamicClass&quot; + (classCount + 1);
#if ENABLE_LINQ_PARTIAL_TRUST
                new ReflectionPermission(PermissionState.Unrestricted).Assert();
#endif
				try
				{
					TypeBuilder tb = this.module.DefineType(typeName, TypeAttributes.Class |
					                                                  TypeAttributes.Public, typeof(DynamicClass));
					FieldInfo[] fields = GenerateProperties(tb, properties);
					GenerateEquals(tb, fields);
					GenerateGetHashCode(tb, fields);
					Type result = tb.CreateType();
					classCount++;
					return result;
				}
				finally
				{
#if ENABLE_LINQ_PARTIAL_TRUST
                    PermissionSet.RevertAssert();
#endif
				}
			}
			finally
			{
				rwLock.DowngradeFromWriterLock(ref cookie);
			}
		}

		FieldInfo[] GenerateProperties(TypeBuilder tb, DynamicProperty[] properties)
		{
			FieldInfo[] fields = new FieldBuilder[properties.Length];
			for (int i = 0; i &lt; properties.Length; i++)
			{
				DynamicProperty dp = properties[i];
				FieldBuilder fb = tb.DefineField(&quot;_&quot; + dp.Name, dp.Type, FieldAttributes.Private);
				PropertyBuilder pb = tb.DefineProperty(dp.Name, PropertyAttributes.HasDefault, dp.Type, null);
				MethodBuilder mbGet = tb.DefineMethod(&quot;get_&quot; + dp.Name,
				                                      MethodAttributes.Public | MethodAttributes.SpecialName | MethodAttributes.HideBySig,
				                                      dp.Type, Type.EmptyTypes);
				ILGenerator genGet = mbGet.GetILGenerator();
				genGet.Emit(OpCodes.Ldarg_0);
				genGet.Emit(OpCodes.Ldfld, fb);
				genGet.Emit(OpCodes.Ret);
				MethodBuilder mbSet = tb.DefineMethod(&quot;set_&quot; + dp.Name,
				                                      MethodAttributes.Public | MethodAttributes.SpecialName | MethodAttributes.HideBySig,
				                                      null, new Type[] { dp.Type });
				ILGenerator genSet = mbSet.GetILGenerator();
				genSet.Emit(OpCodes.Ldarg_0);
				genSet.Emit(OpCodes.Ldarg_1);
				genSet.Emit(OpCodes.Stfld, fb);
				genSet.Emit(OpCodes.Ret);
				pb.SetGetMethod(mbGet);
				pb.SetSetMethod(mbSet);
				fields[i] = fb;
			}
			return fields;
		}

		void GenerateEquals(TypeBuilder tb, FieldInfo[] fields)
		{
			MethodBuilder mb = tb.DefineMethod(&quot;Equals&quot;,
			                                   MethodAttributes.Public | MethodAttributes.ReuseSlot |
			                                   MethodAttributes.Virtual | MethodAttributes.HideBySig,
			                                   typeof(bool), new Type[] { typeof(object) });
			ILGenerator gen = mb.GetILGenerator();
			LocalBuilder other = gen.DeclareLocal(tb);
			Label next = gen.DefineLabel();
			gen.Emit(OpCodes.Ldarg_1);
			gen.Emit(OpCodes.Isinst, tb);
			gen.Emit(OpCodes.Stloc, other);
			gen.Emit(OpCodes.Ldloc, other);
			gen.Emit(OpCodes.Brtrue_S, next);
			gen.Emit(OpCodes.Ldc_I4_0);
			gen.Emit(OpCodes.Ret);
			gen.MarkLabel(next);
			foreach (FieldInfo field in fields)
			{
				Type ft = field.FieldType;
				Type ct = typeof(EqualityComparer&lt;&gt;).MakeGenericType(ft);
				next = gen.DefineLabel();
				gen.EmitCall(OpCodes.Call, ct.GetMethod(&quot;get_Default&quot;), null);
				gen.Emit(OpCodes.Ldarg_0);
				gen.Emit(OpCodes.Ldfld, field);
				gen.Emit(OpCodes.Ldloc, other);
				gen.Emit(OpCodes.Ldfld, field);
				gen.EmitCall(OpCodes.Callvirt, ct.GetMethod(&quot;Equals&quot;, new Type[] { ft, ft }), null);
				gen.Emit(OpCodes.Brtrue_S, next);
				gen.Emit(OpCodes.Ldc_I4_0);
				gen.Emit(OpCodes.Ret);
				gen.MarkLabel(next);
			}
			gen.Emit(OpCodes.Ldc_I4_1);
			gen.Emit(OpCodes.Ret);
		}

		void GenerateGetHashCode(TypeBuilder tb, FieldInfo[] fields)
		{
			MethodBuilder mb = tb.DefineMethod(&quot;GetHashCode&quot;,
			                                   MethodAttributes.Public | MethodAttributes.ReuseSlot |
			                                   MethodAttributes.Virtual | MethodAttributes.HideBySig,
			                                   typeof(int), Type.EmptyTypes);
			ILGenerator gen = mb.GetILGenerator();
			gen.Emit(OpCodes.Ldc_I4_0);
			foreach (FieldInfo field in fields)
			{
				Type ft = field.FieldType;
				Type ct = typeof(EqualityComparer&lt;&gt;).MakeGenericType(ft);
				gen.EmitCall(OpCodes.Call, ct.GetMethod(&quot;get_Default&quot;), null);
				gen.Emit(OpCodes.Ldarg_0);
				gen.Emit(OpCodes.Ldfld, field);
				gen.EmitCall(OpCodes.Callvirt, ct.GetMethod(&quot;GetHashCode&quot;, new Type[] { ft }), null);
				gen.Emit(OpCodes.Xor);
			}
			gen.Emit(OpCodes.Ret);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[11,3,11,69,0],[13,25,13,26,0],[13,27,13,28,0],[20,3,20,27,0],[21,3,21,4,0],[22,4,22,59,0],[23,4,23,110,0],[28,4,28,5,0],[29,5,29,53,0],[30,4,30,5,0],[32,4,32,5,0],[36,4,36,5,0],[37,4,37,48,0],[38,4,38,36,0],[39,3,39,4,0],[42,3,42,4,0],[43,4,43,47,0],[45,4,45,5,0],[46,5,46,53,0],[48,5,48,51,0],[49,5,49,6,0],[50,6,50,54,0],[51,6,51,35,0],[52,5,52,6,0],[53,5,53,17,0],[56,4,56,5,0],[57,5,57,32,0],[58,4,58,5,0],[59,3,59,4,0],[62,3,62,4,0],[63,4,63,69,0],[65,4,65,5,0],[66,5,66,57,0],[71,5,71,6,0],[72,6,73,101,0],[74,6,74,62,0],[75,6,75,33,0],[76,6,76,38,0],[77,6,77,36,0],[78,6,78,19,0],[79,6,79,20,0],[82,5,82,6,0],[86,5,86,6,0],[89,4,89,5,0],[90,5,90,48,0],[91,4,91,5,0],[92,3,92,4,0],[95,3,95,4,0],[96,4,96,61,0],[97,9,97,18,0],[97,20,97,41,0],[97,43,97,46,0],[98,4,98,5,0],[99,5,99,40,0],[100,5,100,87,0],[101,5,101,99,0],[102,5,104,69,0],[105,5,105,49,0],[106,5,106,34,0],[107,5,107,36,0],[108,5,108,30,0],[109,5,111,73,0],[112,5,112,49,0],[113,5,113,34,0],[114,5,114,34,0],[115,5,115,36,0],[116,5,116,30,0],[117,5,117,28,0],[118,5,118,28,0],[119,5,119,20,0],[120,4,120,5,0],[121,4,121,18,0],[122,3,122,4,0],[125,3,125,4,0],[126,4,129,84,0],[130,4,130,42,0],[131,4,131,46,0],[132,4,132,35,0],[133,4,133,30,0],[134,4,134,33,0],[135,4,135,35,0],[136,4,136,35,0],[137,4,137,37,0],[138,4,138,31,0],[139,4,139,26,0],[140,4,140,24,0],[141,4,141,11,0],[141,13,141,28,0],[141,29,141,31,0],[141,32,141,38,0],[142,4,142,5,0],[143,5,143,31,0],[144,5,144,62,0],[145,5,145,30,0],[146,5,146,67,0],[147,5,147,31,0],[148,5,148,36,0],[149,5,149,36,0],[150,5,150,36,0],[151,5,151,89,0],[152,5,152,38,0],[153,5,153,32,0],[154,5,154,27,0],[155,5,155,25,0],[156,4,156,5,0],[157,4,157,31,0],[158,4,158,26,0],[159,3,159,4,0],[162,3,162,4,0],[163,4,166,69,0],[167,4,167,42,0],[168,4,168,31,0],[169,4,169,11,0],[169,13,169,28,0],[169,29,169,31,0],[169,32,169,38,0],[170,4,170,5,0],[171,5,171,31,0],[172,5,172,62,0],[173,5,173,67,0],[174,5,174,31,0],[175,5,175,36,0],[176,5,176,90,0],[177,5,177,27,0],[178,4,178,5,0],[179,4,179,26,0],[180,3,180,4,0]]);
    </script>
  </body>
</html>