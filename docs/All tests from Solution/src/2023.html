<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\PropertyCollection.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Collections.Specialized;
using System.Linq;
using System.Runtime.Serialization;
using System.Threading;
using Umbraco.Core.Models.EntityBase;

namespace Umbraco.Core.Models
{
    /// &lt;summary&gt;
    /// Represents a Collection of &lt;see cref=&quot;Property&quot;/&gt; objects
    /// &lt;/summary&gt;
    [Serializable]
    [DataContract(IsReference = true)]
    public class PropertyCollection : KeyedCollection&lt;string, Property&gt;, INotifyCollectionChanged, IDeepCloneable
    {
        private readonly object _addLocker = new object();
        internal Action OnAdd;
        internal Func&lt;Property, bool&gt; ValidateAdd { get; set; }

        internal PropertyCollection()
            : base(StringComparer.InvariantCultureIgnoreCase)
        {
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;PropertyCollection&quot;/&gt; class with a delegate responsible for validating the addition of &lt;see cref=&quot;Property&quot;/&gt; instances.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;validationCallback&quot;&gt;The validation callback.&lt;/param&gt;
        /// &lt;remarks&gt;&lt;/remarks&gt;
        internal PropertyCollection(Func&lt;Property, bool&gt; validationCallback)
            : this()
        {
            ValidateAdd = validationCallback;
        }

        public PropertyCollection(IEnumerable&lt;Property&gt; properties)
            : this()
        {
            Reset(properties);
        }

        /// &lt;summary&gt;
        /// Resets the collection to only contain the &lt;see cref=&quot;Property&quot;/&gt; instances referenced in the &lt;paramref name=&quot;properties&quot;/&gt; parameter, whilst maintaining
        /// any validation delegates such as &lt;see cref=&quot;ValidateAdd&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;properties&quot;&gt;The properties.&lt;/param&gt;
        /// &lt;remarks&gt;&lt;/remarks&gt;
        internal void Reset(IEnumerable&lt;Property&gt; properties)
        {
            Clear();
            properties.ForEach(Add);
            OnCollectionChanged(new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Reset));
        }

        protected override void SetItem(int index, Property item)
        {
            base.SetItem(index, item);
            OnCollectionChanged(new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Add, item, index));
        }

        protected override void RemoveItem(int index)
        {
            var removed = this[index];
            base.RemoveItem(index);
            OnCollectionChanged(new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Remove, removed));
        }

        protected override void InsertItem(int index, Property item)
        {
            base.InsertItem(index, item);
            OnCollectionChanged(new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Add, item));
        }

        protected override void ClearItems()
        {
            base.ClearItems();
            OnCollectionChanged(new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Reset));
        }

        internal new void Add(Property item)
        {
            lock (_addLocker)
            {
                var key = GetKeyForItem(item);
                if (key != null)
                {
                    var exists = this.Contains(key);
                    if (exists)
                    {
                        //NOTE: Consider checking type before value is set: item.PropertyType.DataTypeId == property.PropertyType.DataTypeId
                        //Transfer the existing value to the new property
                        var property = this[key];
                        if (item.Value == null &amp;&amp; property.Value != null)
                        {
                            item.Value = property.Value;
                        }

                        SetItem(IndexOfKey(key), item);
                        return;
                    }
                }
                base.Add(item);
                OnAdd.IfNotNull(x =&gt; x.Invoke());//Could this not be replaced by a Mandate/Contract for ensuring item is not null

                OnCollectionChanged(new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Add, item));
            }
        }

        /// &lt;summary&gt;
        /// Determines whether this collection contains a &lt;see cref=&quot;Property&quot;/&gt; whose alias matches the specified PropertyType.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;propertyTypeAlias&quot;&gt;Alias of the PropertyType.&lt;/param&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if the collection contains the specified alias; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/returns&gt;
        /// &lt;remarks&gt;&lt;/remarks&gt;
        public new bool Contains(string propertyTypeAlias)
        {
            return base.Contains(propertyTypeAlias);
        }

        public int IndexOfKey(string key)
        {
            for (var i = 0; i &lt; this.Count; i++)
            {
                if (this[i].Alias.InvariantEquals(key))
                {
                    return i;
                }
            }
            return -1;
        }

        protected override string GetKeyForItem(Property item)
        {
            return item.Alias;
        }

        /// &lt;summary&gt;
        /// Gets the element with the specified PropertyType.
        /// &lt;/summary&gt;
        /// 
        /// &lt;returns&gt;
        /// The element with the specified PropertyType. If an element with the specified PropertyType is not found, an exception is thrown.
        /// &lt;/returns&gt;
        /// &lt;param name=&quot;propertyType&quot;&gt;The PropertyType of the element to get.&lt;/param&gt;&lt;exception cref=&quot;T:System.ArgumentNullException&quot;&gt;&lt;paramref name=&quot;propertyType&quot;/&gt; is null.&lt;/exception&gt;&lt;exception cref=&quot;T:System.Collections.Generic.KeyNotFoundException&quot;&gt;An element with the specified key does not exist in the collection.&lt;/exception&gt;
        internal Property this[PropertyType propertyType]
        {
            get
            {
                return this.FirstOrDefault(x =&gt; x.Alias.InvariantEquals(propertyType.Alias));
            }
        }

        public event NotifyCollectionChangedEventHandler CollectionChanged;

        protected virtual void OnCollectionChanged(NotifyCollectionChangedEventArgs args)
        {
            if (CollectionChanged != null)
            {
                CollectionChanged(this, args);
            }
        }

        /// &lt;summary&gt;
        /// Ensures that the collection contains Properties for the passed in PropertyTypes
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;propertyTypes&quot;&gt;List of PropertyType&lt;/param&gt;
        protected internal void EnsurePropertyTypes(IEnumerable&lt;PropertyType&gt; propertyTypes)
        {
            if (/*!this.Any() &amp;&amp;*/ propertyTypes != null)
            {
                foreach (var propertyType in propertyTypes)
                {
                    Add(new Property(propertyType));
                }
            }
        }

        /// &lt;summary&gt;
        /// Ensures that the collection is cleared from PropertyTypes not in the list of passed in PropertyTypes
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;propertyTypes&quot;&gt;List of PropertyType&lt;/param&gt;
        protected internal void EnsureCleanPropertyTypes(IEnumerable&lt;PropertyType&gt; propertyTypes)
        {
            if (propertyTypes != null)
            {
                //Remove PropertyTypes that doesn&#39;t exist in the list of new PropertyTypes
                var aliases = this.Select(p =&gt; p.Alias).Except(propertyTypes.Select(x =&gt; x.Alias)).ToList();
                foreach (var alias in aliases)
                {
                    Remove(alias);
                }

                //Add new PropertyTypes from the list of passed in PropertyTypes
                foreach (var propertyType in propertyTypes)
                {
                    Add(new Property(propertyType));
                }
            }
        }

        /// &lt;summary&gt;
        /// Create a deep clone of this property collection
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public object DeepClone()
        {
            var newList = new PropertyCollection();
            foreach (var p in this)
            {
                newList.Add((Property)p.DeepClone());
            }
            return newList;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,59,1],[21,53,21,57,0],[21,58,21,62,0],[24,15,24,62,1],[25,9,25,10,1],[26,9,26,10,1],[34,15,34,21,0],[35,9,35,10,0],[36,13,36,46,0],[37,9,37,10,0],[40,15,40,21,1],[41,9,41,10,1],[42,13,42,31,1],[43,9,43,10,1],[52,9,52,10,1],[53,13,53,21,1],[54,13,54,37,1],[55,13,55,108,1],[56,9,56,10,1],[59,9,59,10,1],[60,13,60,39,1],[61,13,61,119,1],[62,9,62,10,1],[65,9,65,10,1],[66,13,66,39,1],[67,13,67,36,1],[68,13,68,118,1],[69,9,69,10,1],[72,9,72,10,1],[73,13,73,42,1],[74,13,74,112,1],[75,9,75,10,1],[78,9,78,10,1],[79,13,79,31,1],[80,13,80,108,1],[81,9,81,10,1],[84,9,84,10,1],[85,13,85,30,1],[86,13,86,14,1],[87,17,87,47,1],[88,17,88,33,1],[89,17,89,18,1],[90,21,90,53,1],[91,21,91,32,1],[92,21,92,22,1],[95,25,95,50,1],[96,25,96,74,1],[97,25,97,26,1],[98,29,98,57,1],[99,25,99,26,1],[101,25,101,56,1],[102,25,102,32,1],[104,17,104,18,1],[105,17,105,32,1],[106,17,106,38,1],[106,38,106,48,0],[106,48,106,50,1],[106,17,106,50,1],[108,17,108,116,1],[109,13,109,14,1],[110,9,110,10,1],[119,9,119,10,1],[120,13,120,53,1],[121,9,121,10,1],[124,9,124,10,1],[125,18,125,27,1],[125,29,125,43,1],[125,45,125,48,1],[126,13,126,14,1],[127,17,127,56,1],[128,17,128,18,1],[129,21,129,30,1],[131,13,131,14,1],[132,13,132,23,0],[133,9,133,10,1],[136,9,136,10,1],[137,13,137,31,1],[138,9,138,10,1],[151,13,151,14,0],[152,17,152,49,0],[152,49,152,92,0],[152,92,152,94,0],[152,17,152,94,0],[153,13,153,14,0],[159,9,159,10,1],[160,13,160,43,1],[161,13,161,14,1],[162,17,162,47,1],[163,13,163,14,1],[164,9,164,10,1],[171,9,171,10,1],[172,13,172,58,1],[173,13,173,14,1],[174,17,174,24,1],[174,26,174,42,1],[174,43,174,45,1],[174,46,174,59,1],[175,17,175,18,1],[176,21,176,53,1],[177,17,177,18,1],[178,13,178,14,1],[179,9,179,10,1],[186,9,186,10,1],[187,13,187,39,1],[188,13,188,14,1],[190,17,190,48,1],[190,48,190,55,1],[190,55,190,90,1],[190,90,190,97,1],[190,97,190,109,1],[190,17,190,109,1],[191,17,191,24,1],[191,26,191,35,1],[191,36,191,38,1],[191,39,191,46,1],[192,17,192,18,1],[193,21,193,35,1],[194,17,194,18,1],[197,17,197,24,1],[197,26,197,42,1],[197,43,197,45,1],[197,46,197,59,1],[198,17,198,18,1],[199,21,199,53,1],[200,17,200,18,1],[201,13,201,14,1],[202,9,202,10,1],[209,9,209,10,1],[210,13,210,52,1],[211,13,211,20,1],[211,22,211,27,1],[211,28,211,30,1],[211,31,211,35,1],[212,13,212,14,1],[213,17,213,54,1],[214,13,214,14,1],[215,13,215,28,1],[216,9,216,10,1]]);
    </script>
  </body>
</html>