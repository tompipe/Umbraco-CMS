<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\PluginViewEngine.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.IO;
using System.Linq;
using System.Web.Mvc;
using Lucene.Net.Util;
using Umbraco.Core.IO;

namespace Umbraco.Web.Mvc
{
    /// &lt;summary&gt;
	/// A view engine to look into the App_Plugins folder for views for packaged controllers
	/// &lt;/summary&gt;
    public class PluginViewEngine : RazorViewEngine
	{
		
		/// &lt;summary&gt;
		/// Constructor
		/// &lt;/summary&gt;
		public PluginViewEngine()
		{
			SetViewLocations();
		}

		private void SetViewLocations()
		{
			//these are the originals:

			//base.AreaViewLocationFormats = new string[] { &quot;~/Areas/{2}/Views/{1}/{0}.cshtml&quot;, &quot;~/Areas/{2}/Views/{1}/{0}.vbhtml&quot;, &quot;~/Areas/{2}/Views/Shared/{0}.cshtml&quot;, &quot;~/Areas/{2}/Views/Shared/{0}.vbhtml&quot; };
			//base.AreaMasterLocationFormats = new string[] { &quot;~/Areas/{2}/Views/{1}/{0}.cshtml&quot;, &quot;~/Areas/{2}/Views/{1}/{0}.vbhtml&quot;, &quot;~/Areas/{2}/Views/Shared/{0}.cshtml&quot;, &quot;~/Areas/{2}/Views/Shared/{0}.vbhtml&quot; };
			//base.AreaPartialViewLocationFormats = new string[] { &quot;~/Areas/{2}/Views/{1}/{0}.cshtml&quot;, &quot;~/Areas/{2}/Views/{1}/{0}.vbhtml&quot;, &quot;~/Areas/{2}/Views/Shared/{0}.cshtml&quot;, &quot;~/Areas/{2}/Views/Shared/{0}.vbhtml&quot; };
			//base.ViewLocationFormats = new string[] { &quot;~/Views/{1}/{0}.cshtml&quot;, &quot;~/Views/{1}/{0}.vbhtml&quot;, &quot;~/Views/Shared/{0}.cshtml&quot;, &quot;~/Views/Shared/{0}.vbhtml&quot; };
			//base.MasterLocationFormats = new string[] { &quot;~/Views/{1}/{0}.cshtml&quot;, &quot;~/Views/{1}/{0}.vbhtml&quot;, &quot;~/Views/Shared/{0}.cshtml&quot;, &quot;~/Views/Shared/{0}.vbhtml&quot; };
			//base.PartialViewLocationFormats = new string[] { &quot;~/Views/{1}/{0}.cshtml&quot;, &quot;~/Views/{1}/{0}.vbhtml&quot;, &quot;~/Views/Shared/{0}.cshtml&quot;, &quot;~/Views/Shared/{0}.vbhtml&quot; };
			//base.FileExtensions = new string[] { &quot;cshtml&quot;, &quot;vbhtml&quot; };

			var viewLocationsArray = new[]
				{
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/{1}/{0}.cshtml&quot;),
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/{1}/{0}.vbhtml&quot;)                    
				};

			//set all of the area view locations to the plugin folder
			AreaViewLocationFormats = viewLocationsArray
				.Concat(new[]
					{
						string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/Shared/{0}.cshtml&quot;),
						string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/Shared/{0}.vbhtml&quot;)                        
					})
				.ToArray();

            AreaMasterLocationFormats = viewLocationsArray;

            AreaPartialViewLocationFormats = new[]
				{
					//will be used when we have partial view and child action macros
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/Partials/{0}.cshtml&quot;),
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/Partials/{0}.vbhtml&quot;),
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/MacroPartials/{0}.cshtml&quot;),
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/MacroPartials/{0}.vbhtml&quot;),                    
					//for partials                    
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/{1}/{0}.cshtml&quot;),
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/{1}/{0}.vbhtml&quot;),
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/Shared/{0}.cshtml&quot;),
					string.Concat(SystemDirectories.AppPlugins, &quot;/{2}/Views/Shared/{0}.vbhtml&quot;)
				};

		}

		/// &lt;summary&gt;
		/// Ensures that the correct web.config for razor exists in the /Views folder.
		/// &lt;/summary&gt;
		private void EnsureFolderAndWebConfig(ViewEngineResult result)
		{
			if (result.View == null) return;
			var razorResult = result.View as RazorView;
			if (razorResult == null) return;

			var folder = Path.GetDirectoryName(IOHelper.MapPath(razorResult.ViewPath));
			//now we need to get the /View/ folder
			var viewFolder = folder.Substring(0, folder.LastIndexOf(&quot;\\Views\\&quot;)) + &quot;\\Views&quot;;

			//ensure the web.config file is in the ~/Views folder
			Directory.CreateDirectory(viewFolder);
			if (!File.Exists(Path.Combine(viewFolder, &quot;web.config&quot;)))
			{
				using (var writer = File.CreateText(Path.Combine(viewFolder, &quot;web.config&quot;)))
				{
                    writer.Write(Strings.WebConfigTemplate);
				}
			}
		}

		public override ViewEngineResult FindView(ControllerContext controllerContext, string viewName, string masterName, bool useCache)
		{			
			var result = base.FindView(controllerContext, viewName, masterName, useCache);
			EnsureFolderAndWebConfig(result);
			return result;
		}

		public override ViewEngineResult FindPartialView(ControllerContext controllerContext, string partialViewName, bool useCache)
		{			
			var result = base.FindPartialView(controllerContext, partialViewName, useCache);
			EnsureFolderAndWebConfig(result);
			return result;
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,3,18,28,1],[19,3,19,4,1],[20,4,20,23,1],[21,3,21,4,1],[24,3,24,4,1],[35,4,39,7,1],[42,4,48,16,1],[50,13,50,60,1],[52,13,64,7,1],[66,3,66,4,1],[72,3,72,4,0],[73,4,73,28,0],[73,29,73,36,0],[74,4,74,47,0],[75,4,75,28,0],[75,29,75,36,0],[77,4,77,79,0],[79,4,79,86,0],[82,4,82,42,0],[83,4,83,61,0],[84,4,84,5,0],[85,12,85,80,0],[86,5,86,6,0],[87,21,87,61,0],[88,5,88,6,0],[89,4,89,5,0],[90,3,90,4,0],[93,3,93,4,0],[94,4,94,82,0],[95,4,95,37,0],[96,4,96,18,0],[97,3,97,4,0],[100,3,100,4,0],[101,4,101,84,0],[102,4,102,37,0],[103,4,103,18,0],[104,3,104,4,0]]);
    </script>
  </body>
</html>