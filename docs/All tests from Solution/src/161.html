<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\PublicAccessServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Services
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, RequiresSTA]
    public class PublicAccessServiceTests : BaseServiceTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        [Test]
        public void Can_Add_New_Entry()
        {
            // Arrange
            var contentService = ServiceContext.ContentService;
            var contentTypeService = ServiceContext.ContentTypeService;
            var ct = MockedContentTypes.CreateSimpleContentType(&quot;blah&quot;, &quot;Blah&quot;);
            contentTypeService.Save(ct);
            var c = MockedContent.CreateSimpleContent(ct, &quot;Test&quot;, -1);
            contentService.Save(c);
            var publicAccessService = ServiceContext.PublicAccessService;


            // Act
            var entry = new PublicAccessEntry(c, c, c, new[]
           {
                new PublicAccessRule()
                {
                    RuleType = &quot;TestType&quot;,
                    RuleValue = &quot;TestVal&quot;
                },
            });
            var result = publicAccessService.Save(entry);

            // Assert
            Assert.IsTrue(result.Success);
            Assert.AreEqual(OperationStatusType.Success, result.Result.StatusType);
            Assert.IsTrue(entry.HasIdentity);
            Assert.AreNotEqual(entry.Key, Guid.Empty);
            Assert.AreEqual(c.Id, entry.LoginNodeId);
            Assert.AreEqual(c.Id, entry.NoAccessNodeId);
            Assert.AreEqual(c.Id, entry.ProtectedNodeId);
        }

        [Test]
        public void Can_Add_Rule()
        {
            // Arrange
            var contentService = ServiceContext.ContentService;
            var contentTypeService = ServiceContext.ContentTypeService;
            var ct = MockedContentTypes.CreateSimpleContentType(&quot;blah&quot;, &quot;Blah&quot;);
            contentTypeService.Save(ct);
            var c = MockedContent.CreateSimpleContent(ct, &quot;Test&quot;, -1);
            contentService.Save(c);
            var publicAccessService = ServiceContext.PublicAccessService;
            var entry = new PublicAccessEntry(c, c, c, new[]
           {
                new PublicAccessRule()
                {
                    RuleType = &quot;TestType&quot;,
                    RuleValue = &quot;TestVal&quot;
                },
            });
            publicAccessService.Save(entry);

            // Act
            var updated = publicAccessService.AddRule(c, &quot;TestType2&quot;, &quot;AnotherVal&quot;);
            //re-get
            entry = publicAccessService.GetEntryForContent(c);

            // Assert           
            Assert.IsTrue(updated.Success);
            Assert.AreEqual(OperationStatusType.Success, updated.Result.StatusType);
            Assert.AreEqual(2, entry.Rules.Count());
        }

        [Test]
        public void Can_Add_Multiple_Value_For_Same_Rule_Type()
        {
            // Arrange
            var contentService = ServiceContext.ContentService;
            var contentTypeService = ServiceContext.ContentTypeService;
            var ct = MockedContentTypes.CreateSimpleContentType(&quot;blah&quot;, &quot;Blah&quot;);
            contentTypeService.Save(ct);
            var c = MockedContent.CreateSimpleContent(ct, &quot;Test&quot;, -1);
            contentService.Save(c);
            var publicAccessService = ServiceContext.PublicAccessService;
            var entry = new PublicAccessEntry(c, c, c, new[]
           {
                new PublicAccessRule()
                {
                    RuleType = &quot;TestType&quot;,
                    RuleValue = &quot;TestVal&quot;
                },
            });
            publicAccessService.Save(entry);

            // Act
            var updated1 = publicAccessService.AddRule(c, &quot;TestType&quot;, &quot;AnotherVal1&quot;);
            var updated2 = publicAccessService.AddRule(c, &quot;TestType&quot;, &quot;AnotherVal2&quot;);

            //re-get
            entry = publicAccessService.GetEntryForContent(c);

            // Assert           
            Assert.IsTrue(updated1.Success);
            Assert.IsTrue(updated2.Success);
            Assert.AreEqual(OperationStatusType.Success, updated1.Result.StatusType);
            Assert.AreEqual(OperationStatusType.Success, updated2.Result.StatusType);
            Assert.AreEqual(3, entry.Rules.Count());
        }

        [Test]
        public void Can_Remove_Rule()
        {
            // Arrange
            var contentService = ServiceContext.ContentService;
            var contentTypeService = ServiceContext.ContentTypeService;
            var ct = MockedContentTypes.CreateSimpleContentType(&quot;blah&quot;, &quot;Blah&quot;);
            contentTypeService.Save(ct);
            var c = MockedContent.CreateSimpleContent(ct, &quot;Test&quot;, -1);
            contentService.Save(c);
            var publicAccessService = ServiceContext.PublicAccessService;
            var entry = new PublicAccessEntry(c, c, c, new[]
           {
                new PublicAccessRule()
                {
                    RuleType = &quot;TestType&quot;,
                    RuleValue = &quot;TestValue1&quot;
                },
                new PublicAccessRule()
                {
                    RuleType = &quot;TestType&quot;,
                    RuleValue = &quot;TestValue2&quot;
                },
            });
            publicAccessService.Save(entry);            

            // Act
            var removed = publicAccessService.RemoveRule(c, &quot;TestType&quot;, &quot;TestValue1&quot;);
            //re-get
            entry = publicAccessService.GetEntryForContent(c);

            // Assert           
            Assert.IsTrue(removed.Success);
            Assert.AreEqual(OperationStatusType.Success, removed.Result.StatusType);
            Assert.AreEqual(1, entry.Rules.Count());
            Assert.AreEqual(&quot;TestValue2&quot;, entry.Rules.ElementAt(0).RuleValue);
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,10,1],[18,13,18,31,1],[19,9,19,10,1],[23,9,23,10,1],[24,13,24,29,1],[25,9,25,10,1],[29,9,29,10,1],[31,13,31,64,1],[32,13,32,72,1],[33,13,33,81,1],[34,13,34,41,1],[35,13,35,71,1],[36,13,36,36,1],[37,13,37,74,1],[41,13,48,16,1],[49,13,49,58,1],[52,13,52,43,1],[53,13,53,84,1],[54,13,54,46,1],[55,13,55,55,1],[56,13,56,54,1],[57,13,57,57,1],[58,13,58,58,1],[59,9,59,10,1],[63,9,63,10,1],[65,13,65,64,1],[66,13,66,72,1],[67,13,67,81,1],[68,13,68,41,1],[69,13,69,71,1],[70,13,70,36,1],[71,13,71,74,1],[72,13,79,16,1],[80,13,80,45,1],[83,13,83,85,1],[85,13,85,63,1],[88,13,88,44,1],[89,13,89,85,1],[90,13,90,53,1],[91,9,91,10,1],[95,9,95,10,1],[97,13,97,64,1],[98,13,98,72,1],[99,13,99,81,1],[100,13,100,41,1],[101,13,101,71,1],[102,13,102,36,1],[103,13,103,74,1],[104,13,111,16,1],[112,13,112,45,1],[115,13,115,86,1],[116,13,116,86,1],[119,13,119,63,1],[122,13,122,45,1],[123,13,123,45,1],[124,13,124,86,1],[125,13,125,86,1],[126,13,126,53,1],[127,9,127,10,1],[131,9,131,10,1],[133,13,133,64,1],[134,13,134,72,1],[135,13,135,81,1],[136,13,136,41,1],[137,13,137,71,1],[138,13,138,36,1],[139,13,139,74,1],[140,13,152,16,1],[153,13,153,45,1],[156,13,156,87,1],[158,13,158,63,1],[161,13,161,44,1],[162,13,162,85,1],[163,13,163,53,1],[164,13,164,79,1],[165,9,165,10,1]]);
    </script>
  </body>
</html>