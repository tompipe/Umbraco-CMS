<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Services\FileService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.IO;
using System.Linq;
using System.Runtime.Remoting.Messaging;
using System.Text.RegularExpressions;
using System.Web;
using Umbraco.Core.Auditing;
using Umbraco.Core.Configuration;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Events;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Services
{
    /// &lt;summary&gt;
    /// Represents the File Service, which is an easy access to operations involving &lt;see cref=&quot;IFile&quot;/&gt; objects like Scripts, Stylesheets and Templates
    /// &lt;/summary&gt;
    public class FileService : RepositoryService, IFileService
    {
        private readonly IUnitOfWorkProvider _fileUowProvider;

        private const string PartialViewHeader = &quot;@inherits Umbraco.Web.Mvc.UmbracoTemplatePage&quot;;
        private const string PartialViewMacroHeader = &quot;@inherits Umbraco.Web.Macros.PartialViewMacroPage&quot;;

        public FileService(
            IUnitOfWorkProvider fileProvider, 
            IDatabaseUnitOfWorkProvider dataProvider, 
            RepositoryFactory repositoryFactory,
            ILogger logger,
            IEventMessagesFactory eventMessagesFactory)
            : base(dataProvider, repositoryFactory, logger, eventMessagesFactory)
        {
            _fileUowProvider = fileProvider;         
        }


        #region Stylesheets

        /// &lt;summary&gt;
        /// Gets a list of all &lt;see cref=&quot;Stylesheet&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Stylesheet&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;Stylesheet&gt; GetStylesheets(params string[] names)
        {
            using (var repository = RepositoryFactory.CreateStylesheetRepository(_fileUowProvider.GetUnitOfWork(), UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(names);
            }
        }

        /// &lt;summary&gt;
        /// Gets a &lt;see cref=&quot;Stylesheet&quot;/&gt; object by its name
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;Name of the stylesheet incl. extension&lt;/param&gt;
        /// &lt;returns&gt;A &lt;see cref=&quot;Stylesheet&quot;/&gt; object&lt;/returns&gt;
        public Stylesheet GetStylesheetByName(string name)
        {
            using (var repository = RepositoryFactory.CreateStylesheetRepository(_fileUowProvider.GetUnitOfWork(), UowProvider.GetUnitOfWork()))
            {
                return repository.Get(name);
            }
        }

        /// &lt;summary&gt;
        /// Saves a &lt;see cref=&quot;Stylesheet&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stylesheet&quot;&gt;&lt;see cref=&quot;Stylesheet&quot;/&gt; to save&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        public void SaveStylesheet(Stylesheet stylesheet, int userId = 0)
        {
            if (SavingStylesheet.IsRaisedEventCancelled(new SaveEventArgs&lt;Stylesheet&gt;(stylesheet), this))
                return;

            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateStylesheetRepository(uow, UowProvider.GetUnitOfWork()))
            {
                repository.AddOrUpdate(stylesheet);
                uow.Commit();

                SavedStylesheet.RaiseEvent(new SaveEventArgs&lt;Stylesheet&gt;(stylesheet, false), this);
            }

            Audit(AuditType.Save, string.Format(&quot;Save Stylesheet performed by user&quot;), userId, -1);
        }

        /// &lt;summary&gt;
        /// Deletes a stylesheet by its name
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;path&quot;&gt;Name incl. extension of the Stylesheet to delete&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        public void DeleteStylesheet(string path, int userId = 0)
        {
            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateStylesheetRepository(uow, UowProvider.GetUnitOfWork()))
            {
                var stylesheet = repository.Get(path);
                if (stylesheet == null) return;

                if (DeletingStylesheet.IsRaisedEventCancelled(new DeleteEventArgs&lt;Stylesheet&gt;(stylesheet), this))
                    return;

                repository.Delete(stylesheet);
                uow.Commit();

                DeletedStylesheet.RaiseEvent(new DeleteEventArgs&lt;Stylesheet&gt;(stylesheet, false), this);

                Audit(AuditType.Delete, string.Format(&quot;Delete Stylesheet performed by user&quot;), userId, -1);
            }
        }

        /// &lt;summary&gt;
        /// Validates a &lt;see cref=&quot;Stylesheet&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stylesheet&quot;&gt;&lt;see cref=&quot;Stylesheet&quot;/&gt; to validate&lt;/param&gt;
        /// &lt;returns&gt;True if Stylesheet is valid, otherwise false&lt;/returns&gt;
        public bool ValidateStylesheet(Stylesheet stylesheet)
        {

            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateStylesheetRepository(uow, UowProvider.GetUnitOfWork()))
            {
                return repository.ValidateStylesheet(stylesheet);
            }
        }

        #endregion

        #region Scripts
        /// &lt;summary&gt;
        /// Gets a list of all &lt;see cref=&quot;Script&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;Script&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;Script&gt; GetScripts(params string[] names)
        {
            using (var repository = RepositoryFactory.CreateScriptRepository(_fileUowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(names);
            }
        }

        /// &lt;summary&gt;
        /// Gets a &lt;see cref=&quot;Script&quot;/&gt; object by its name
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;Name of the script incl. extension&lt;/param&gt;
        /// &lt;returns&gt;A &lt;see cref=&quot;Script&quot;/&gt; object&lt;/returns&gt;
        public Script GetScriptByName(string name)
        {
            using (var repository = RepositoryFactory.CreateScriptRepository(_fileUowProvider.GetUnitOfWork()))
            {
                return repository.Get(name);
            }
        }

        /// &lt;summary&gt;
        /// Saves a &lt;see cref=&quot;Script&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;script&quot;&gt;&lt;see cref=&quot;Script&quot;/&gt; to save&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        public void SaveScript(Script script, int userId = 0)
        {
            if (SavingScript.IsRaisedEventCancelled(new SaveEventArgs&lt;Script&gt;(script), this))
                return;

            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateScriptRepository(uow))
            {
                repository.AddOrUpdate(script);
                uow.Commit();

                SavedScript.RaiseEvent(new SaveEventArgs&lt;Script&gt;(script, false), this);
            }

            Audit(AuditType.Save, string.Format(&quot;Save Script performed by user&quot;), userId, -1);
        }

        /// &lt;summary&gt;
        /// Deletes a script by its name
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;path&quot;&gt;Name incl. extension of the Script to delete&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        public void DeleteScript(string path, int userId = 0)
        {
            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateScriptRepository(uow))
            {
                var script = repository.Get(path);
                if (script == null) return;

                if (DeletingScript.IsRaisedEventCancelled(new DeleteEventArgs&lt;Script&gt;(script), this))
                    return; ;

                repository.Delete(script);
                uow.Commit();

                DeletedScript.RaiseEvent(new DeleteEventArgs&lt;Script&gt;(script, false), this);

                Audit(AuditType.Delete, string.Format(&quot;Delete Script performed by user&quot;), userId, -1);
            }
        }

        /// &lt;summary&gt;
        /// Validates a &lt;see cref=&quot;Script&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;script&quot;&gt;&lt;see cref=&quot;Script&quot;/&gt; to validate&lt;/param&gt;
        /// &lt;returns&gt;True if Script is valid, otherwise false&lt;/returns&gt;
        public bool ValidateScript(Script script)
        {
            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateScriptRepository(uow))
            {
                return repository.ValidateScript(script);
            }
        }

        public void CreateScriptFolder(string folderPath)
        {
            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateScriptRepository(uow))
            {
                ((ScriptRepository)repository).AddFolder(folderPath);
                uow.Commit();
            }
        }

        public void DeleteScriptFolder(string folderPath)
        {
            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateScriptRepository(uow))
            {
                ((ScriptRepository)repository).DeleteFolder(folderPath);
                uow.Commit();
            }
        }

        #endregion

        #region Templates

        /// &lt;summary&gt;
        /// Creates a template for a content type
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentTypeAlias&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;contentTypeName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;
        /// The template created
        /// &lt;/returns&gt;
        public Attempt&lt;OperationStatus&lt;ITemplate, OperationStatusType&gt;&gt; CreateTemplateForContentType(string contentTypeAlias, string contentTypeName, int userId = 0)
        {
            var template = new Template(contentTypeName,
                //NOTE: We are NOT passing in the content type alias here, we want to use it&#39;s name since we don&#39;t
                // want to save template file names as camelCase, the Template ctor will clean the alias as
                // `alias.ToCleanString(CleanStringType.UnderscoreAlias)` which has been the default.
                // This fixes: http://issues.umbraco.org/issue/U4-7953
                contentTypeName);

            var evtMsgs = EventMessagesFactory.Get();

            //NOTE: This isn&#39;t pretty but we need to maintain backwards compatibility so we cannot change
            // the event args here. The other option is to create a different event with different event
            // args specifically for this method... which also isn&#39;t pretty. So for now, we&#39;ll use this
            // dictionary approach to store &#39;additional data&#39; in.
            var additionalData = new Dictionary&lt;string, object&gt;
            {
                {&quot;CreateTemplateForContentType&quot;, true},
                {&quot;ContentTypeAlias&quot;, contentTypeAlias},
            };
            if (SavingTemplate.IsRaisedEventCancelled(
                  new SaveEventArgs&lt;ITemplate&gt;(template, true, evtMsgs, additionalData),
                  this))
            {
                return Attempt.Fail(new OperationStatus&lt;ITemplate, OperationStatusType&gt;(template, OperationStatusType.FailedCancelledByEvent, evtMsgs));
            }

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateTemplateRepository(uow))
            {
                repository.AddOrUpdate(template);
                uow.Commit();

                SavedTemplate.RaiseEvent(new SaveEventArgs&lt;ITemplate&gt;(template, false, evtMsgs), this);
            }

            Audit(AuditType.Save, string.Format(&quot;Save Template performed by user&quot;), userId, template.Id);

            return Attempt.Succeed(new OperationStatus&lt;ITemplate, OperationStatusType&gt;(template, OperationStatusType.Success, evtMsgs));
        }

        public ITemplate CreateTemplateWithIdentity(string name, string content, ITemplate masterTemplate = null, int userId = 0)
        {
            var template = new Template(name, name)
            {
                Content = content
            };
            if (masterTemplate != null)
            {
                template.SetMasterTemplate(masterTemplate);
            }
            SaveTemplate(template, userId);
            return template;
        }

        /// &lt;summary&gt;
        /// Gets a list of all &lt;see cref=&quot;ITemplate&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;ITemplate&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;ITemplate&gt; GetTemplates(params string[] aliases)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(aliases).OrderBy(x =&gt; x.Name);
            }
        }

        /// &lt;summary&gt;
        /// Gets a list of all &lt;see cref=&quot;ITemplate&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;ITemplate&quot;/&gt; objects&lt;/returns&gt;
        public IEnumerable&lt;ITemplate&gt; GetTemplates(int masterTemplateId)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetChildren(masterTemplateId).OrderBy(x =&gt; x.Name);
            }
        }

        /// &lt;summary&gt;
        /// Gets a &lt;see cref=&quot;ITemplate&quot;/&gt; object by its alias.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;The alias of the template.&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;ITemplate&quot;/&gt; object matching the alias, or null.&lt;/returns&gt;
        public ITemplate GetTemplate(string alias)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(alias);
            }
        }

        /// &lt;summary&gt;
        /// Gets a &lt;see cref=&quot;ITemplate&quot;/&gt; object by its identifier.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The identifer of the template.&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;ITemplate&quot;/&gt; object matching the identifier, or null.&lt;/returns&gt;
        public ITemplate GetTemplate(int id)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(id);
            }
        }

        /// &lt;summary&gt;
        /// Gets a &lt;see cref=&quot;ITemplate&quot;/&gt; object by its guid identifier.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;The guid identifier of the template.&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;ITemplate&quot;/&gt; object matching the identifier, or null.&lt;/returns&gt;
        public ITemplate GetTemplate(Guid id)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                var query = Query&lt;ITemplate&gt;.Builder.Where(x =&gt; x.Key == id);
                return repository.GetByQuery(query).SingleOrDefault();
            }
        }

        public IEnumerable&lt;ITemplate&gt; GetTemplateDescendants(string alias)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetDescendants(alias);
            }
        }

        /// &lt;summary&gt;
        /// Gets the template descendants
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;masterTemplateId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;ITemplate&gt; GetTemplateDescendants(int masterTemplateId)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetDescendants(masterTemplateId);
            }
        }

        /// &lt;summary&gt;
        /// Gets the template children
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;ITemplate&gt; GetTemplateChildren(string alias)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetChildren(alias);
            }
        }

        /// &lt;summary&gt;
        /// Gets the template children
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;masterTemplateId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;ITemplate&gt; GetTemplateChildren(int masterTemplateId)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetChildren(masterTemplateId);
            }
        }

        /// &lt;summary&gt;
        /// Returns a template as a template node which can be traversed (parent, children)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use GetDescendants instead&quot;)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public TemplateNode GetTemplateNode(string alias)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetTemplateNode(alias);
            }
        }

        /// &lt;summary&gt;
        /// Given a template node in a tree, this will find the template node with the given alias if it is found in the hierarchy, otherwise null
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;anyNode&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [Obsolete(&quot;Use GetDescendants instead&quot;)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public TemplateNode FindTemplateInTree(TemplateNode anyNode, string alias)
        {
            using (var repository = RepositoryFactory.CreateTemplateRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.FindTemplateInTree(anyNode, alias);
            }
        }

        /// &lt;summary&gt;
        /// Saves a &lt;see cref=&quot;Template&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;template&quot;&gt;&lt;see cref=&quot;Template&quot;/&gt; to save&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        public void SaveTemplate(ITemplate template, int userId = 0)
        {
            if (SavingTemplate.IsRaisedEventCancelled(new SaveEventArgs&lt;ITemplate&gt;(template), this))
                return;

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateTemplateRepository(uow))
            {
                repository.AddOrUpdate(template);
                uow.Commit();

                SavedTemplate.RaiseEvent(new SaveEventArgs&lt;ITemplate&gt;(template, false), this);
            }

            Audit(AuditType.Save, string.Format(&quot;Save Template performed by user&quot;), userId, template.Id);
        }

        /// &lt;summary&gt;
        /// Saves a collection of &lt;see cref=&quot;Template&quot;/&gt; objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;templates&quot;&gt;List of &lt;see cref=&quot;Template&quot;/&gt; to save&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;Optional id of the user&lt;/param&gt;
        public void SaveTemplate(IEnumerable&lt;ITemplate&gt; templates, int userId = 0)
        {
            if (SavingTemplate.IsRaisedEventCancelled(new SaveEventArgs&lt;ITemplate&gt;(templates), this))
                return;

            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateTemplateRepository(uow))
            {
                foreach (var template in templates)
                {
                    repository.AddOrUpdate(template);
                }
                uow.Commit();

                SavedTemplate.RaiseEvent(new SaveEventArgs&lt;ITemplate&gt;(templates, false), this);
            }

            Audit(AuditType.Save, string.Format(&quot;Save Template performed by user&quot;), userId, -1);
        }

        /// &lt;summary&gt;
        /// This checks what the default rendering engine is set in config but then also ensures that there isn&#39;t already 
        /// a template that exists in the opposite rendering engine&#39;s template folder, then returns the appropriate 
        /// rendering engine to use.
        /// &lt;/summary&gt; 
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// The reason this is required is because for example, if you have a master page file already existing under ~/masterpages/Blah.aspx
        /// and then you go to create a template in the tree called Blah and the default rendering engine is MVC, it will create a Blah.cshtml 
        /// empty template in ~/Views. This means every page that is using Blah will go to MVC and render an empty page. 
        /// This is mostly related to installing packages since packages install file templates to the file system and then create the 
        /// templates in business logic. Without this, it could cause the wrong rendering engine to be used for a package.
        /// &lt;/remarks&gt;
        public RenderingEngine DetermineTemplateRenderingEngine(ITemplate template)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateTemplateRepository(uow))
            {
                return repository.DetermineTemplateRenderingEngine(template);
            }
        }

        /// &lt;summary&gt;
        /// Deletes a template by its alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;Alias of the &lt;see cref=&quot;ITemplate&quot;/&gt; to delete&lt;/param&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        public void DeleteTemplate(string alias, int userId = 0)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateTemplateRepository(uow))
            {
                var template = repository.Get(alias);
                if (template == null) return;

                if (DeletingTemplate.IsRaisedEventCancelled(new DeleteEventArgs&lt;ITemplate&gt;(template), this))
                    return;

                repository.Delete(template);
                uow.Commit();

                DeletedTemplate.RaiseEvent(new DeleteEventArgs&lt;ITemplate&gt;(template, false), this);

                Audit(AuditType.Delete, string.Format(&quot;Delete Template performed by user&quot;), userId, template.Id);
            }
        }

        /// &lt;summary&gt;
        /// Validates a &lt;see cref=&quot;ITemplate&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;template&quot;&gt;&lt;see cref=&quot;ITemplate&quot;/&gt; to validate&lt;/param&gt;
        /// &lt;returns&gt;True if Script is valid, otherwise false&lt;/returns&gt;
        public bool ValidateTemplate(ITemplate template)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreateTemplateRepository(uow))
            {
                return repository.ValidateTemplate(template);
            }
        }

        #endregion

        #region Partial Views

        public IEnumerable&lt;string&gt; GetPartialViewSnippetNames(params string[] filterNames)
        {
            var snippetPath = IOHelper.MapPath(string.Format(&quot;{0}/PartialViewMacros/Templates/&quot;, SystemDirectories.Umbraco));
            var files = Directory.GetFiles(snippetPath, &quot;*.cshtml&quot;)
                .Select(Path.GetFileNameWithoutExtension)
                .Except(filterNames, StringComparer.InvariantCultureIgnoreCase)
                .ToArray();

            //Ensure the ones that are called &#39;Empty&#39; are at the top
            var empty = files.Where(x =&gt; Path.GetFileName(x).InvariantStartsWith(&quot;Empty&quot;))
                .OrderBy(x =&gt; x.Length)
                .ToArray();

            return empty.Union(files.Except(empty));
        } 

        public void DeletePartialViewFolder(string folderPath)
        {
            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreatePartialViewRepository(uow))
            {
                ((PartialViewRepository)repository).DeleteFolder(folderPath);
                uow.Commit();
            }
        }

        public void DeletePartialViewMacroFolder(string folderPath)
        {
            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreatePartialViewMacroRepository(uow))
            {
                ((PartialViewMacroRepository)repository).DeleteFolder(folderPath);
                uow.Commit();
            }
        }

        public IPartialView GetPartialView(string path)
        {
            using (var repository = RepositoryFactory.CreatePartialViewRepository(_fileUowProvider.GetUnitOfWork()))
            {
                return repository.Get(path);
            }
        }

        public IPartialView GetPartialViewMacro(string path)
        {
            using (var repository = RepositoryFactory.CreatePartialViewMacroRepository(_fileUowProvider.GetUnitOfWork()))
            {
                return repository.Get(path);
            }
        }

        public Attempt&lt;IPartialView&gt; CreatePartialView(IPartialView partialView, string snippetName = null, int userId = 0)
        {
            return CreatePartialViewMacro(partialView, PartialViewType.PartialView, snippetName, userId);
        }

        public Attempt&lt;IPartialView&gt; CreatePartialViewMacro(IPartialView partialView, string snippetName = null, int userId = 0)
        {
            return CreatePartialViewMacro(partialView, PartialViewType.PartialViewMacro, snippetName, userId);
        }

        private Attempt&lt;IPartialView&gt; CreatePartialViewMacro(IPartialView partialView, PartialViewType partialViewType, string snippetName = null, int userId = 0)
        {
            if (CreatingPartialView.IsRaisedEventCancelled(new NewEventArgs&lt;IPartialView&gt;(partialView, true, partialView.Alias, -1), this))
                return Attempt&lt;IPartialView&gt;.Fail();

            string partialViewHeader;
            switch (partialViewType)
            {
                case PartialViewType.PartialView:
                    partialViewHeader = PartialViewHeader;
                    break;
                case PartialViewType.PartialViewMacro:
                    partialViewHeader = PartialViewMacroHeader;
                    break;
                default:
                    throw new ArgumentOutOfRangeException(&quot;partialViewType&quot;);
            }

            if (snippetName.IsNullOrWhiteSpace() == false)
            {
                //create the file
                var snippetPathAttempt = TryGetSnippetPath(snippetName);
                if (snippetPathAttempt.Success == false)
                {
                    throw new InvalidOperationException(&quot;Could not load snippet with name &quot; + snippetName);
                }

                using (var snippetFile = new StreamReader(System.IO.File.OpenRead(snippetPathAttempt.Result)))
                {
                    var snippetContent = snippetFile.ReadToEnd().Trim();

                    //strip the @inherits if it&#39;s there
                    snippetContent = StripPartialViewHeader(snippetContent);
                    
                    var content = string.Format(&quot;{0}{1}{2}&quot;,
                        partialViewHeader, 
                        Environment.NewLine, snippetContent);
                    partialView.Content = content;
                }
            }

            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = GetPartialViewRepository(partialViewType, uow))
            {
                repository.AddOrUpdate(partialView);
                uow.Commit();

                CreatedPartialView.RaiseEvent(new NewEventArgs&lt;IPartialView&gt;(partialView, false, partialView.Alias, -1), this);
            }

            Audit(AuditType.Save, string.Format(&quot;Save {0} performed by user&quot;, partialViewType), userId, -1);

            return Attempt&lt;IPartialView&gt;.Succeed(partialView);
        }

        public bool DeletePartialView(string path, int userId = 0)
        {
            return DeletePartialViewMacro(path, PartialViewType.PartialView, userId);
        }

        public bool DeletePartialViewMacro(string path, int userId = 0)
        {
            return DeletePartialViewMacro(path, PartialViewType.PartialViewMacro, userId);
        }

        private bool DeletePartialViewMacro(string path, PartialViewType partialViewType, int userId = 0)
        {
            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = GetPartialViewRepository(partialViewType, uow))
            {
                var partialView = repository.Get(path);
                if (partialView == null)
                    return true;

                if (DeletingPartialView.IsRaisedEventCancelled(new DeleteEventArgs&lt;IPartialView&gt;(partialView), this))
                    return false;

                repository.Delete(partialView);
                uow.Commit();

                DeletedPartialView.RaiseEvent(new DeleteEventArgs&lt;IPartialView&gt;(partialView, false), this);

                Audit(AuditType.Delete, string.Format(&quot;Delete {0} performed by user&quot;, partialViewType), userId, -1);
            }

            return true;

        }

        public Attempt&lt;IPartialView&gt; SavePartialView(IPartialView partialView, int userId = 0)
        {
            return SavePartialView(partialView, PartialViewType.PartialView, userId);
        }

        public Attempt&lt;IPartialView&gt; SavePartialViewMacro(IPartialView partialView, int userId = 0)
        {
            return SavePartialView(partialView, PartialViewType.PartialViewMacro, userId);
        }

        private Attempt&lt;IPartialView&gt; SavePartialView(IPartialView partialView, PartialViewType partialViewType, int userId = 0)
        {
            if (SavingPartialView.IsRaisedEventCancelled(new SaveEventArgs&lt;IPartialView&gt;(partialView), this))
                return Attempt&lt;IPartialView&gt;.Fail();

            var uow = _fileUowProvider.GetUnitOfWork();
            using (var repository = GetPartialViewRepository(partialViewType, uow))
            {
                repository.AddOrUpdate(partialView);
                uow.Commit();
            }

            Audit(AuditType.Save, string.Format(&quot;Save {0} performed by user&quot;, partialViewType), userId, -1);

            SavedPartialView.RaiseEvent(new SaveEventArgs&lt;IPartialView&gt;(partialView, false), this);

            return Attempt.Succeed(partialView);
        }

        public bool ValidatePartialView(PartialView partialView)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreatePartialViewRepository(uow))
            {
                return repository.ValidatePartialView(partialView);
            }
        }

        public bool ValidatePartialViewMacro(PartialView partialView)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var repository = RepositoryFactory.CreatePartialViewMacroRepository(uow))
            {
                return repository.ValidatePartialView(partialView);
            }
        }

        internal string StripPartialViewHeader(string contents)
        {
            var headerMatch = new Regex(&quot;^@inherits\\s+?.*$&quot;, RegexOptions.Multiline);
            return headerMatch.Replace(contents, string.Empty);
        }

        internal Attempt&lt;string&gt; TryGetSnippetPath(string fileName)
        {
            if (fileName.EndsWith(&quot;.cshtml&quot;) == false)
            {
                fileName += &quot;.cshtml&quot;;
            }

            var snippetPath = IOHelper.MapPath(string.Format(&quot;{0}/PartialViewMacros/Templates/{1}&quot;, SystemDirectories.Umbraco, fileName));
            return System.IO.File.Exists(snippetPath)
                ? Attempt&lt;string&gt;.Succeed(snippetPath)
                : Attempt&lt;string&gt;.Fail();
        }

        private IPartialViewRepository GetPartialViewRepository(PartialViewType partialViewType, IUnitOfWork uow)
        {
            switch (partialViewType)
            {
                case PartialViewType.PartialView:
                    return RepositoryFactory.CreatePartialViewRepository(uow);
                case PartialViewType.PartialViewMacro:
                    return RepositoryFactory.CreatePartialViewMacroRepository(uow);
            }
            throw new ArgumentOutOfRangeException(&quot;partialViewType&quot;);
        }

        #endregion

        private void Audit(AuditType type, string message, int userId, int objectId)
        {
            var uow = UowProvider.GetUnitOfWork();
            using (var auditRepo = RepositoryFactory.CreateAuditRepository(uow))
            {
                auditRepo.AddOrUpdate(new AuditItem(objectId, message, type, userId));
                uow.Commit();
            }
        }

        //TODO Method to change name and/or alias of view/masterpage template

        #region Event Handlers
        /// &lt;summary&gt;
        /// Occurs before Delete
        /// &lt;/summary&gt;        
        public static event TypedEventHandler&lt;IFileService, DeleteEventArgs&lt;ITemplate&gt;&gt; DeletingTemplate;

        /// &lt;summary&gt;
        /// Occurs after Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, DeleteEventArgs&lt;ITemplate&gt;&gt; DeletedTemplate;

        /// &lt;summary&gt;
        /// Occurs before Delete
        /// &lt;/summary&gt;        
        public static event TypedEventHandler&lt;IFileService, DeleteEventArgs&lt;Script&gt;&gt; DeletingScript;

        /// &lt;summary&gt;
        /// Occurs after Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, DeleteEventArgs&lt;Script&gt;&gt; DeletedScript;

        /// &lt;summary&gt;
        /// Occurs before Delete
        /// &lt;/summary&gt;        
        public static event TypedEventHandler&lt;IFileService, DeleteEventArgs&lt;Stylesheet&gt;&gt; DeletingStylesheet;

        /// &lt;summary&gt;
        /// Occurs after Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, DeleteEventArgs&lt;Stylesheet&gt;&gt; DeletedStylesheet;

        /// &lt;summary&gt;
        /// Occurs before Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, SaveEventArgs&lt;ITemplate&gt;&gt; SavingTemplate;

        /// &lt;summary&gt;
        /// Occurs after Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, SaveEventArgs&lt;ITemplate&gt;&gt; SavedTemplate;

        /// &lt;summary&gt;
        /// Occurs before Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, SaveEventArgs&lt;Script&gt;&gt; SavingScript;

        /// &lt;summary&gt;
        /// Occurs after Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, SaveEventArgs&lt;Script&gt;&gt; SavedScript;

        /// &lt;summary&gt;
        /// Occurs before Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, SaveEventArgs&lt;Stylesheet&gt;&gt; SavingStylesheet;

        /// &lt;summary&gt;
        /// Occurs after Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, SaveEventArgs&lt;Stylesheet&gt;&gt; SavedStylesheet;

        /// &lt;summary&gt;
        /// Occurs before Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, SaveEventArgs&lt;IPartialView&gt;&gt; SavingPartialView;

        /// &lt;summary&gt;
        /// Occurs after Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, SaveEventArgs&lt;IPartialView&gt;&gt; SavedPartialView;
        
        /// &lt;summary&gt;
        /// Occurs before Create
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, NewEventArgs&lt;IPartialView&gt;&gt; CreatingPartialView;

        /// &lt;summary&gt;
        /// Occurs after Create
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, NewEventArgs&lt;IPartialView&gt;&gt; CreatedPartialView;

        /// &lt;summary&gt;
        /// Occurs before Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, DeleteEventArgs&lt;IPartialView&gt;&gt; DeletingPartialView;

        /// &lt;summary&gt;
        /// Occurs after Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IFileService, DeleteEventArgs&lt;IPartialView&gt;&gt; DeletedPartialView;

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[39,15,39,82,1],[40,9,40,10,1],[41,13,41,45,1],[42,9,42,10,1],[52,9,52,10,0],[53,20,53,144,0],[54,13,54,14,0],[55,17,55,49,0],[57,9,57,10,0],[65,9,65,10,0],[66,20,66,144,0],[67,13,67,14,0],[68,17,68,45,0],[70,9,70,10,0],[78,9,78,10,0],[79,13,79,106,0],[80,17,80,24,0],[82,13,82,56,0],[83,20,83,115,0],[84,13,84,14,0],[85,17,85,52,0],[86,17,86,30,0],[88,17,88,100,0],[89,13,89,14,0],[91,13,91,99,0],[92,9,92,10,0],[100,9,100,10,0],[101,13,101,56,0],[102,20,102,115,0],[103,13,103,14,0],[104,17,104,55,0],[105,17,105,40,0],[105,41,105,48,0],[107,17,107,114,0],[108,21,108,28,0],[110,17,110,47,0],[111,17,111,30,0],[113,17,113,104,0],[115,17,115,107,0],[116,13,116,14,0],[117,9,117,10,0],[125,9,125,10,0],[127,13,127,56,0],[128,20,128,115,0],[129,13,129,14,0],[130,17,130,66,0],[132,9,132,10,0],[142,9,142,10,0],[143,20,143,111,0],[144,13,144,14,0],[145,17,145,49,0],[147,9,147,10,0],[155,9,155,10,0],[156,20,156,111,0],[157,13,157,14,0],[158,17,158,45,0],[160,9,160,10,0],[168,9,168,10,0],[169,13,169,94,0],[170,17,170,24,0],[172,13,172,56,0],[173,20,173,82,0],[174,13,174,14,0],[175,17,175,48,0],[176,17,176,30,0],[178,17,178,88,0],[179,13,179,14,0],[181,13,181,95,0],[182,9,182,10,0],[190,9,190,10,0],[191,13,191,56,0],[192,20,192,82,0],[193,13,193,14,0],[194,17,194,51,0],[195,17,195,36,0],[195,37,195,44,0],[197,17,197,102,0],[198,21,198,28,0],[198,29,198,30,0],[200,17,200,43,0],[201,17,201,30,0],[203,17,203,92,0],[205,17,205,103,0],[206,13,206,14,0],[207,9,207,10,0],[215,9,215,10,0],[216,13,216,56,0],[217,20,217,82,0],[218,13,218,14,0],[219,17,219,58,0],[221,9,221,10,0],[224,9,224,10,0],[225,13,225,56,0],[226,20,226,82,0],[227,13,227,14,0],[228,17,228,70,0],[229,17,229,30,0],[230,13,230,14,0],[231,9,231,10,0],[234,9,234,10,0],[235,13,235,56,0],[236,20,236,82,0],[237,13,237,14,0],[238,17,238,73,0],[239,17,239,30,0],[240,13,240,14,0],[241,9,241,10,0],[257,9,257,10,0],[258,13,263,34,0],[265,13,265,54,0],[271,13,275,15,0],[276,13,278,25,0],[279,13,279,14,0],[280,17,280,153,0],[283,13,283,51,0],[284,20,284,84,0],[285,13,285,14,0],[286,17,286,50,0],[287,17,287,30,0],[289,17,289,104,0],[290,13,290,14,0],[292,13,292,106,0],[294,13,294,137,0],[295,9,295,10,0],[298,9,298,10,1],[299,13,302,15,1],[303,13,303,40,1],[304,13,304,14,1],[305,17,305,60,1],[306,13,306,14,1],[307,13,307,44,1],[308,13,308,29,1],[309,9,309,10,1],[316,9,316,10,1],[317,20,317,108,1],[318,13,318,14,1],[319,17,319,64,1],[319,64,319,70,1],[319,70,319,72,1],[319,17,319,72,1],[321,9,321,10,1],[328,9,328,10,1],[329,20,329,108,1],[330,13,330,14,1],[331,17,331,78,1],[331,78,331,84,1],[331,84,331,86,1],[331,17,331,86,1],[333,9,333,10,1],[341,9,341,10,1],[342,20,342,108,1],[343,13,343,14,1],[344,17,344,46,1],[346,9,346,10,1],[354,9,354,10,1],[355,20,355,108,1],[356,13,356,14,1],[357,17,357,43,1],[359,9,359,10,1],[367,9,367,10,0],[368,20,368,108,0],[369,13,369,14,0],[370,17,370,78,0],[371,17,371,71,0],[373,9,373,10,0],[376,9,376,10,0],[377,20,377,108,0],[378,13,378,14,0],[379,17,379,57,0],[381,9,381,10,0],[389,9,389,10,0],[390,20,390,108,0],[391,13,391,14,0],[392,17,392,68,0],[394,9,394,10,0],[402,9,402,10,0],[403,20,403,108,0],[404,13,404,14,0],[405,17,405,54,0],[407,9,407,10,0],[415,9,415,10,0],[416,20,416,108,0],[417,13,417,14,0],[418,17,418,65,0],[420,9,420,10,0],[430,9,430,10,0],[431,20,431,108,0],[432,13,432,14,0],[433,17,433,58,0],[435,9,435,10,0],[446,9,446,10,0],[447,20,447,108,0],[448,13,448,14,0],[449,17,449,70,0],[451,9,451,10,0],[459,9,459,10,1],[460,13,460,101,1],[461,17,461,24,0],[463,13,463,51,1],[464,20,464,84,1],[465,13,465,14,1],[466,17,466,50,1],[467,17,467,30,1],[469,17,469,95,1],[470,13,470,14,1],[472,13,472,106,1],[473,9,473,10,1],[481,9,481,10,1],[482,13,482,102,1],[483,17,483,24,0],[485,13,485,51,1],[486,20,486,84,1],[487,13,487,14,1],[488,17,488,24,1],[488,26,488,38,1],[488,39,488,41,1],[488,42,488,51,1],[489,17,489,18,1],[490,21,490,54,1],[491,17,491,18,1],[492,17,492,30,1],[494,17,494,96,1],[495,13,495,14,1],[497,13,497,97,1],[498,9,498,10,1],[514,9,514,10,0],[515,13,515,51,0],[516,20,516,84,0],[517,13,517,14,0],[518,17,518,78,0],[520,9,520,10,0],[528,9,528,10,0],[529,13,529,51,0],[530,20,530,84,0],[531,13,531,14,0],[532,17,532,54,0],[533,17,533,38,0],[533,39,533,46,0],[535,17,535,109,0],[536,21,536,28,0],[538,17,538,45,0],[539,17,539,30,0],[541,17,541,99,0],[543,17,543,114,0],[544,13,544,14,0],[545,9,545,10,0],[553,9,553,10,0],[554,13,554,51,0],[555,20,555,84,0],[556,13,556,14,0],[557,17,557,62,0],[559,9,559,10,0],[566,9,566,10,0],[567,13,567,126,0],[568,13,571,28,0],[574,13,574,42,0],[574,42,574,90,0],[574,90,575,31,0],[575,31,575,39,0],[575,39,576,28,0],[574,13,576,28,0],[578,13,578,53,0],[579,9,579,10,0],[582,9,582,10,0],[583,13,583,56,0],[584,20,584,87,0],[585,13,585,14,0],[586,17,586,78,0],[587,17,587,30,0],[588,13,588,14,0],[589,9,589,10,0],[592,9,592,10,0],[593,13,593,56,0],[594,20,594,92,0],[595,13,595,14,0],[596,17,596,83,0],[597,17,597,30,0],[598,13,598,14,0],[599,9,599,10,0],[602,9,602,10,0],[603,20,603,116,0],[604,13,604,14,0],[605,17,605,45,0],[607,9,607,10,0],[610,9,610,10,0],[611,20,611,121,0],[612,13,612,14,0],[613,17,613,45,0],[615,9,615,10,0],[618,9,618,10,0],[619,13,619,106,0],[620,9,620,10,0],[623,9,623,10,0],[624,13,624,111,0],[625,9,625,10,0],[628,9,628,10,0],[629,13,629,140,0],[630,17,630,53,0],[633,13,633,37,0],[636,21,636,59,0],[637,21,637,27,0],[639,21,639,64,0],[640,21,640,27,0],[642,21,642,78,0],[645,13,645,59,0],[646,13,646,14,0],[648,17,648,73,0],[649,17,649,57,0],[650,17,650,18,0],[651,21,651,108,0],[654,24,654,110,0],[655,17,655,18,0],[656,21,656,73,0],[659,21,659,77,0],[661,21,663,62,0],[664,21,664,51,0],[665,17,665,18,0],[666,13,666,14,0],[668,13,668,56,0],[669,20,669,83,0],[670,13,670,14,0],[671,17,671,53,0],[672,17,672,30,0],[674,17,674,128,0],[675,13,675,14,0],[677,13,677,109,0],[679,13,679,63,0],[680,9,680,10,0],[683,9,683,10,0],[684,13,684,86,0],[685,9,685,10,0],[688,9,688,10,0],[689,13,689,91,0],[690,9,690,10,0],[693,9,693,10,0],[694,13,694,56,0],[695,20,695,83,0],[696,13,696,14,0],[697,17,697,56,0],[698,17,698,41,0],[699,21,699,33,0],[701,17,701,118,0],[702,21,702,34,0],[704,17,704,48,0],[705,17,705,30,0],[707,17,707,108,0],[709,17,709,117,0],[710,13,710,14,0],[712,13,712,25,0],[714,9,714,10,0],[717,9,717,10,0],[718,13,718,86,0],[719,9,719,10,0],[722,9,722,10,0],[723,13,723,91,0],[724,9,724,10,0],[727,9,727,10,0],[728,13,728,110,0],[729,17,729,53,0],[731,13,731,56,0],[732,20,732,83,0],[733,13,733,14,0],[734,17,734,53,0],[735,17,735,30,0],[736,13,736,14,0],[738,13,738,109,0],[740,13,740,100,0],[742,13,742,49,0],[743,9,743,10,0],[746,9,746,10,0],[747,13,747,51,0],[748,20,748,87,0],[749,13,749,14,0],[750,17,750,68,0],[752,9,752,10,0],[755,9,755,10,0],[756,13,756,51,0],[757,20,757,92,0],[758,13,758,14,0],[759,17,759,68,0],[761,9,761,10,0],[764,9,764,10,0],[765,13,765,87,0],[766,13,766,64,0],[767,9,767,10,0],[770,9,770,10,0],[771,13,771,55,0],[772,13,772,14,0],[773,17,773,39,0],[774,13,774,14,0],[776,13,776,139,0],[777,13,779,42,0],[780,9,780,10,0],[783,9,783,10,0],[784,13,784,37,0],[787,21,787,79,0],[789,21,789,84,0],[791,13,791,70,0],[792,9,792,10,0],[797,9,797,10,1],[798,13,798,51,1],[799,20,799,80,1],[800,13,800,14,1],[801,17,801,87,1],[802,17,802,30,1],[803,13,803,14,1],[804,9,804,10,1]]);
    </script>
  </body>
</html>