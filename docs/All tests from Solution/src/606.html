<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\sendToTranslation.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;

using umbraco.cms.businesslogic.web;
using umbraco.cms.businesslogic;
using umbraco.BusinessLogic;
using umbraco.BasePages;

namespace umbraco.presentation.dialogs
{
    public partial class sendToTranslation : UmbracoEnsuredPage
    {
        private CMSNode _currentPage;

        public sendToTranslation()
        {
            CurrentApp = DefaultApps.content.ToString();
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            _currentPage = new CMSNode(int.Parse(helper.Request(&quot;id&quot;)));

            pp_translator.Text = ui.Text(&quot;translation&quot;,&quot;translator&quot;, this.getUser());
            pp_language.Text = ui.Text(&quot;translation&quot;, &quot;translateTo&quot;, this.getUser());
            pp_includeSubs.Text = ui.Text(&quot;translation&quot;,&quot;includeSubpages&quot;, this.getUser());
            pp_comment.Text = ui.Text(&quot;comment&quot;, this.getUser());
            pane_form.Text = ui.Text(&quot;translation&quot;, &quot;sendToTranslate&quot;, _currentPage.Text, base.getUser());
            

            if (!IsPostBack)
            {
                // default language
                var selectedLanguage = 0;

                var domains = library.GetCurrentDomains(_currentPage.Id);
                if (domains != null)
                {
                    selectedLanguage = domains[0].Language.id;
                    defaultLanguage.Text = ui.Text(&quot;defaultLanguageIs&quot;, base.getUser()) + &quot; &quot; + domains[0].Language.FriendlyName;
                }
                else
                {
                    defaultLanguage.Text = ui.Text(&quot;defaultLanguageIsNotAssigned&quot;, base.getUser());
                }
                
                // languages
                language.Items.Add(new ListItem(ui.Text(&quot;general&quot;, &quot;choose&quot;, base.getUser()), &quot;&quot;));
                foreach (var l in cms.businesslogic.language.Language.getAll)
                {
                    var li = new ListItem();
                    li.Text = l.FriendlyName;
                    li.Value = l.id.ToString();
                    if (selectedLanguage == l.id)
                        li.Selected = true;
                    language.Items.Add(li);
                }

                // Subpages
                if (_currentPage.Children.Length == 0)
                    includeSubpages.Enabled = false;

                // Translators
                foreach (var u in BusinessLogic.User.getAll())
                    if (u.UserType.Alias.ToLower() == &quot;translator&quot; || UserHasTranslatePermission(u, _currentPage))
                        translator.Items.Add(new ListItem(u.Name, u.Id.ToString()));

                if (translator.Items.Count == 0) {
                    feedback.Text = ui.Text(&quot;translation&quot;, &quot;noTranslators&quot;);
                    feedback.type = uicontrols.Feedback.feedbacktype.error;
                    doTranslation.Enabled = false;
                }

                // send button
                doTranslation.Text = ui.Text(&quot;general&quot;, &quot;ok&quot;, base.getUser());
            }
        }

        private bool UserHasTranslatePermission(BusinessLogic.User u, CMSNode node)
        {
            //the permissions column in umbracoUserType is legacy and needs to be rewritten but for now this is the only way to test 
            return u.GetPermissions(node.Path).Contains(&quot;4&quot;);
        }

        protected void doTranslation_Click(object sender, EventArgs e)
        {
            int languageId;
            if (int.TryParse(language.SelectedValue, out languageId))
            {
                cms.businesslogic.translation.Translation.MakeNew(
                    _currentPage,
                    getUser(),
                    BusinessLogic.User.GetUser(int.Parse(translator.SelectedValue)),
                    new cms.businesslogic.language.Language(languageId),
                    comment.Text, includeSubpages.Checked,
                    true);

                pane_form.Visible = false;
                pl_buttons.Visible = false;

                feedback.Text = ui.Text(&quot;translation&quot;, &quot;pageHasBeenSendToTranslation&quot;, _currentPage.Text, base.getUser()) +
                    &quot;&lt;/p&gt;&lt;p&gt;&lt;a href=\&quot;#\&quot; onclick=\&quot;&quot; + ClientTools.Scripts.CloseModalWindow() + &quot;\&quot;&gt;&quot; +
                    ui.Text(&quot;defaultdialogs&quot;, &quot;closeThisWindow&quot;) + &quot;&lt;/a&gt;&lt;/p&gt;&quot;;
                feedback.type = uicontrols.Feedback.feedbacktype.success;
            }
            else
            {
                feedback.Text = ui.Text(&quot;translation&quot;, &quot;noLanguageSelected&quot;);
                feedback.type = uicontrols.Feedback.feedbacktype.error;
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,35,0],[24,9,24,10,0],[25,13,25,57,0],[26,9,26,10,0],[29,9,29,10,0],[30,13,30,73,0],[32,13,32,86,0],[33,13,33,86,0],[34,13,34,92,0],[35,13,35,66,0],[36,13,36,107,0],[39,13,39,29,0],[40,13,40,14,0],[42,17,42,42,0],[44,17,44,74,0],[45,17,45,37,0],[46,17,46,18,0],[47,21,47,63,0],[48,21,48,130,0],[49,17,49,18,0],[51,17,51,18,0],[52,21,52,100,0],[53,17,53,18,0],[56,17,56,100,0],[57,17,57,24,0],[57,26,57,31,0],[57,32,57,34,0],[57,35,57,77,0],[58,17,58,18,0],[59,21,59,45,0],[60,21,60,46,0],[61,21,61,48,0],[62,21,62,50,0],[63,25,63,44,0],[64,21,64,44,0],[65,17,65,18,0],[68,17,68,55,0],[69,21,69,53,0],[72,17,72,24,0],[72,26,72,31,0],[72,32,72,34,0],[72,35,72,62,0],[73,21,73,115,0],[74,25,74,85,0],[76,17,76,49,0],[76,50,76,51,0],[77,21,77,77,0],[78,21,78,76,0],[79,21,79,51,0],[80,17,80,18,0],[83,17,83,79,0],[84,13,84,14,0],[85,9,85,10,0],[88,9,88,10,0],[90,13,90,62,0],[91,9,91,10,0],[94,9,94,10,0],[96,13,96,70,0],[97,13,97,14,0],[98,17,104,27,0],[106,17,106,43,0],[107,17,107,44,0],[109,17,111,79,0],[112,17,112,74,0],[113,13,113,14,0],[115,13,115,14,0],[116,17,116,78,0],[117,17,117,72,0],[118,13,118,14,0],[119,9,119,10,0]]);
    </script>
  </body>
</html>