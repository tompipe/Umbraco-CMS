<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Strategies\Migrations\RebuildXmlCachesAfterUpgrade.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using umbraco;
using Umbraco.Core;
using Umbraco.Core.Events;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Services;
using GlobalSettings = Umbraco.Core.Configuration.GlobalSettings;

namespace Umbraco.Web.Strategies.Migrations
{
    /// &lt;summary&gt;
    /// Rebuilds the Xml caches after upgrading.
    /// This will execute after upgrading to rebuild the xml cache
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// &lt;para&gt;This cannot execute as part of a DB migration since it needs access to services and repositories.&lt;/para&gt;
    /// &lt;para&gt;Executes for:
    /// - Media Xml : if current is less than, or equal to, 7.0.0 (superceeded by the next rule)
    /// - Media &amp; Content Xml : if current is less than, or equal to, 7.3.0 - because 7.3.0 adds .Key to cached items
    /// &lt;/para&gt;
    /// &lt;/remarks&gt;
    public class RebuildXmlCachesAfterUpgrade : MigrationStartupHander
    {
        protected override void AfterMigration(MigrationRunner sender, MigrationEventArgs e)
        {
            if (e.ProductName != GlobalSettings.UmbracoMigrationName) return;

            var v730 = new Semver.SemVersion(new Version(7, 3, 0));

            var doMedia = e.ConfiguredSemVersion &lt; v730;
            var doContent = e.ConfiguredSemVersion &lt; v730;

            if (doMedia)
            {
                var mediaService = (MediaService) ApplicationContext.Current.Services.MediaService;
                mediaService.RebuildXmlStructures();

                // note: not re-indexing medias?
            }

            if (doContent)
            {
                // rebuild Xml in database
                var contentService = (ContentService) ApplicationContext.Current.Services.ContentService;
                contentService.RebuildXmlStructures();

                // refresh the Xml cache
                content.Instance.RefreshContentFromDatabase();
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,0],[26,13,26,70,0],[26,71,26,78,0],[28,13,28,68,0],[30,13,30,57,0],[31,13,31,59,0],[33,13,33,25,0],[34,13,34,14,0],[35,17,35,100,0],[36,17,36,53,0],[39,13,39,14,0],[41,13,41,27,0],[42,13,42,14,0],[44,17,44,106,0],[45,17,45,55,0],[48,17,48,63,0],[49,13,49,14,0],[50,9,50,10,0]]);
    </script>
  </body>
</html>