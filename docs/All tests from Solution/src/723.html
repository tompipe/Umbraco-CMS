<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\HtmlHelperRenderExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Text;
using System.Web;
using System.Web.Mvc;
using System.Web.Mvc.Html;
using System.Web.Routing;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Dynamics;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Profiling;
using Umbraco.Web.Models;
using Umbraco.Web.Mvc;
using Constants = Umbraco.Core.Constants;
using Member = umbraco.cms.businesslogic.member.Member;

namespace Umbraco.Web
{
    /// &lt;summary&gt;
	/// HtmlHelper extensions for use in templates
	/// &lt;/summary&gt;
	public static class HtmlHelperRenderExtensions
	{
        /// &lt;summary&gt;
        /// Renders the markup for the profiler
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;helper&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IHtmlString RenderProfiler(this HtmlHelper helper)
        {
            return new HtmlString(ProfilerResolver.Current.Profiler.Render());
        }

        /// &lt;summary&gt;
        /// Renders a partial view that is found in the specified area
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;helper&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;partial&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;model&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;viewData&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcHtmlString AreaPartial(this HtmlHelper helper, string partial, string area, object model = null, ViewDataDictionary viewData = null)
        {
            var originalArea = helper.ViewContext.RouteData.DataTokens[&quot;area&quot;];
            helper.ViewContext.RouteData.DataTokens[&quot;area&quot;] = area;	        
            var result = helper.Partial(partial, model, viewData);
            helper.ViewContext.RouteData.DataTokens[&quot;area&quot;] = originalArea;
            return result;
        }

	    /// &lt;summary&gt;
        /// Will render the preview badge when in preview mode which is not required ever unless the MVC page you are
        /// using does not inherit from UmbracoTemplatePage
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;helper&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// See: http://issues.umbraco.org/issue/U4-1614
        /// &lt;/remarks&gt;
        public static MvcHtmlString PreviewBadge(this HtmlHelper helper)
        {
            if (UmbracoContext.Current.InPreviewMode)
            {
                var htmlBadge =
                    String.Format(UmbracoConfig.For.UmbracoSettings().Content.PreviewBadge,
                                  IOHelper.ResolveUrl(SystemDirectories.Umbraco),
                                  IOHelper.ResolveUrl(SystemDirectories.UmbracoClient),
                                  UmbracoContext.Current.HttpContext.Server.UrlEncode(UmbracoContext.Current.HttpContext.Request.Path));
                return new MvcHtmlString(htmlBadge);
            }
            return new MvcHtmlString(&quot;&quot;);

        }

		public static IHtmlString CachedPartial(
			this HtmlHelper htmlHelper, 
			string partialViewName, 
			object model, 
			int cachedSeconds,
			bool cacheByPage = false,
			bool cacheByMember = false,
			ViewDataDictionary viewData = null,
			Func&lt;object, ViewDataDictionary, string&gt; contextualKeyBuilder = null)
		{
			var cacheKey = new StringBuilder(partialViewName);
			if (cacheByPage)
			{
				if (UmbracoContext.Current == null)
				{
					throw new InvalidOperationException(&quot;Cannot cache by page if the UmbracoContext has not been initialized, this parameter can only be used in the context of an Umbraco request&quot;);
				}
				cacheKey.AppendFormat(&quot;{0}-&quot;, UmbracoContext.Current.PageId);
			}
			if (cacheByMember)
			{
				var currentMember = Member.GetCurrentMember();
				cacheKey.AppendFormat(&quot;m{0}-&quot;, currentMember == null ? 0 : currentMember.Id);
			}
			if (contextualKeyBuilder != null)
		    {
		        var contextualKey = contextualKeyBuilder(model, viewData);
                cacheKey.AppendFormat(&quot;c{0}-&quot;, contextualKey);
		    }
			return ApplicationContext.Current.ApplicationCache.CachedPartialView(htmlHelper, partialViewName, model, cachedSeconds, cacheKey.ToString(), viewData);
		}

		public static MvcHtmlString EditorFor&lt;T&gt;(this HtmlHelper htmlHelper, string templateName = &quot;&quot;, string htmlFieldName = &quot;&quot;, object additionalViewData = null)
			where T : new()
		{
			var model = new T();
			var typedHelper = new HtmlHelper&lt;T&gt;(
				htmlHelper.ViewContext.CopyWithModel(model),
				htmlHelper.ViewDataContainer.CopyWithModel(model));

			return typedHelper.EditorFor(x =&gt; model, templateName, htmlFieldName, additionalViewData);
		}

		/// &lt;summary&gt;
		/// A validation summary that lets you pass in a prefix so that the summary only displays for elements 
		/// containing the prefix. This allows you to have more than on validation summary on a page.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;htmlHelper&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;prefix&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;excludePropertyErrors&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;message&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcHtmlString ValidationSummary(this HtmlHelper htmlHelper,
		                                              string prefix = &quot;&quot;,
		                                              bool excludePropertyErrors = false,
		                                              string message = &quot;&quot;,
		                                              IDictionary&lt;string, object&gt; htmlAttributes = null)
		{
			if (prefix.IsNullOrWhiteSpace())
			{
				return htmlHelper.ValidationSummary(excludePropertyErrors, message, htmlAttributes);
			}

			//if there&#39;s a prefix applied, we need to create a new html helper with a filtered ModelState collection so that it only looks for 
			//specific model state with the prefix.
			var filteredHtmlHelper = new HtmlHelper(htmlHelper.ViewContext, htmlHelper.ViewDataContainer.FilterContainer(prefix));
			return filteredHtmlHelper.ValidationSummary(excludePropertyErrors, message, htmlAttributes);
		}

	    /// &lt;summary&gt;
	    /// Returns the result of a child action of a strongly typed SurfaceController
	    /// &lt;/summary&gt;
	    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
	    /// &lt;param name=&quot;htmlHelper&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;actionName&quot;&gt;&lt;/param&gt;
	    /// &lt;returns&gt;&lt;/returns&gt;
	    public static IHtmlString Action&lt;T&gt;(this HtmlHelper htmlHelper, string actionName)
            where T : SurfaceController
        {
            return htmlHelper.Action(actionName, typeof(T));
        }

        /// &lt;summary&gt;
        /// Returns the result of a child action of a SurfaceController
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;htmlHelper&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;actionName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;surfaceType&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IHtmlString Action(this HtmlHelper htmlHelper, string actionName, Type surfaceType)
        {
            Mandate.ParameterNotNull(surfaceType, &quot;surfaceType&quot;);
            Mandate.ParameterNotNullOrEmpty(actionName, &quot;actionName&quot;);

            var routeVals = new RouteValueDictionary(new {area = &quot;&quot;});

            var surfaceController = SurfaceControllerResolver.Current.RegisteredSurfaceControllers
                .SingleOrDefault(x =&gt; x == surfaceType);
            if (surfaceController == null)
                throw new InvalidOperationException(&quot;Could not find the surface controller of type &quot; + surfaceType.FullName);
            var metaData = PluginController.GetMetadata(surfaceController);
            if (!metaData.AreaName.IsNullOrWhiteSpace())
            {
                //set the area to the plugin area
                if (routeVals.ContainsKey(&quot;area&quot;))
                {
                    routeVals[&quot;area&quot;] = metaData.AreaName;
                }
                else
                {
                    routeVals.Add(&quot;area&quot;, metaData.AreaName);    
                }
            }

            return htmlHelper.Action(actionName, metaData.ControllerName, routeVals);
        }

        #region GetCropUrl

        [Obsolete(&quot;Use the UrlHelper.GetCropUrl extension instead&quot;)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public static IHtmlString GetCropUrl(this HtmlHelper htmlHelper, IPublishedContent mediaItem, string cropAlias)
        {
            return new HtmlString(mediaItem.GetCropUrl(cropAlias: cropAlias, useCropDimensions: true));
        }

        [Obsolete(&quot;Use the UrlHelper.GetCropUrl extension instead&quot;)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public static IHtmlString GetCropUrl(this HtmlHelper htmlHelper, IPublishedContent mediaItem, string propertyAlias, string cropAlias)
        {
            return new HtmlString(mediaItem.GetCropUrl(propertyAlias: propertyAlias, cropAlias: cropAlias, useCropDimensions: true));
        }

        [Obsolete(&quot;Use the UrlHelper.GetCropUrl extension instead&quot;)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public static IHtmlString GetCropUrl(this HtmlHelper htmlHelper,
            IPublishedContent mediaItem,
            int? width = null,
            int? height = null,
            string propertyAlias = Constants.Conventions.Media.File,
            string cropAlias = null,
            int? quality = null,
            ImageCropMode? imageCropMode = null,
            ImageCropAnchor? imageCropAnchor = null,
            bool preferFocalPoint = false,
            bool useCropDimensions = false,
            bool cacheBuster = true,
            string furtherOptions = null,
            ImageCropRatioMode? ratioMode = null,
            bool upScale = true)
        {
            return
                new HtmlString(mediaItem.GetCropUrl(width, height, propertyAlias, cropAlias, quality, imageCropMode,
                    imageCropAnchor, preferFocalPoint, useCropDimensions, cacheBuster, furtherOptions, ratioMode,
                    upScale));
        }

        [Obsolete(&quot;Use the UrlHelper.GetCropUrl extension instead&quot;)]
        [EditorBrowsable(EditorBrowsableState.Never)]
        public static IHtmlString GetCropUrl(this HtmlHelper htmlHelper,
            string imageUrl,
            int? width = null,
            int? height = null,
            string imageCropperValue = null,
            string cropAlias = null,
            int? quality = null,
            ImageCropMode? imageCropMode = null,
            ImageCropAnchor? imageCropAnchor = null,
            bool preferFocalPoint = false,
            bool useCropDimensions = false,
            string cacheBusterValue = null,
            string furtherOptions = null,
            ImageCropRatioMode? ratioMode = null,
            bool upScale = true)
        {
            return
                new HtmlString(imageUrl.GetCropUrl(width, height, imageCropperValue, cropAlias, quality, imageCropMode,
                    imageCropAnchor, preferFocalPoint, useCropDimensions, cacheBusterValue, furtherOptions, ratioMode,
                    upScale));
        }

        #endregion

        #region BeginUmbracoForm

        /// &lt;summary&gt;
        /// Used for rendering out the Form for BeginUmbracoForm
        /// &lt;/summary&gt;
        internal class UmbracoForm : MvcForm
		{
		    /// &lt;summary&gt;
		    /// Creates an UmbracoForm
		    /// &lt;/summary&gt;
		    /// &lt;param name=&quot;viewContext&quot;&gt;&lt;/param&gt;
		    /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
		    /// &lt;param name=&quot;controllerAction&quot;&gt;&lt;/param&gt;
		    /// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;
		    /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
		    /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		    public UmbracoForm(
				ViewContext viewContext,
				string controllerName,
				string controllerAction,
				string area,
                FormMethod method,
				object additionalRouteVals = null)
				: base(viewContext)
			{
		        _viewContext = viewContext;
		        _method = method;
                _encryptedString = UmbracoHelper.CreateEncryptedRouteString(controllerName, controllerAction, area, additionalRouteVals);
			}

		    private readonly ViewContext _viewContext;
		    private readonly FormMethod _method;
			private bool _disposed;
			private readonly string _encryptedString;

			protected override void Dispose(bool disposing)
			{
				if (this._disposed)
					return;
				this._disposed = true;

                //write out the hidden surface form routes
                _viewContext.Writer.Write(&quot;&lt;input name=&#39;ufprt&#39; type=&#39;hidden&#39; value=&#39;&quot; + _encryptedString + &quot;&#39; /&gt;&quot;);

				base.Dispose(disposing);
			}
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline against a locally declared controller
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName, FormMethod method)
        {
            return html.BeginUmbracoForm(action, controllerName, null, new Dictionary&lt;string, object&gt;(), method);
        }

		/// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline against a locally declared controller
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName)
		{
			return html.BeginUmbracoForm(action, controllerName, null, new Dictionary&lt;string, object&gt;());
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline against a locally declared controller
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName, object additionalRouteVals, FormMethod method)
        {
            return html.BeginUmbracoForm(action, controllerName, additionalRouteVals, new Dictionary&lt;string, object&gt;(), method);
        }

		/// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline against a locally declared controller
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName, object additionalRouteVals)
		{
			return html.BeginUmbracoForm(action, controllerName, additionalRouteVals, new Dictionary&lt;string, object&gt;());
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline against a locally declared controller
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName,
                                               object additionalRouteVals,
                                               object htmlAttributes,
                                               FormMethod method)
        {
            return html.BeginUmbracoForm(action, controllerName, additionalRouteVals, HtmlHelper.AnonymousObjectToHtmlAttributes(htmlAttributes), method);
        }

        /// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline against a locally declared controller
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName,
											   object additionalRouteVals,
											   object htmlAttributes)
		{
            return html.BeginUmbracoForm(action, controllerName, additionalRouteVals, HtmlHelper.AnonymousObjectToHtmlAttributes(htmlAttributes));
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline against a locally declared controller
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName,
                                               object additionalRouteVals,
                                               IDictionary&lt;string, object&gt; htmlAttributes,
                                               FormMethod method)
        {
            Mandate.ParameterNotNullOrEmpty(action, &quot;action&quot;);
            Mandate.ParameterNotNullOrEmpty(controllerName, &quot;controllerName&quot;);

            return html.BeginUmbracoForm(action, controllerName, &quot;&quot;, additionalRouteVals, htmlAttributes, method);
        }

        /// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline against a locally declared controller
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName,
											   object additionalRouteVals,
											   IDictionary&lt;string, object&gt; htmlAttributes)
		{
			Mandate.ParameterNotNullOrEmpty(action, &quot;action&quot;);
			Mandate.ParameterNotNullOrEmpty(controllerName, &quot;controllerName&quot;);

			return html.BeginUmbracoForm(action, controllerName, &quot;&quot;, additionalRouteVals, htmlAttributes);
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;surfaceType&quot;&gt;The surface controller to route to&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, Type surfaceType, FormMethod method)
        {
            return html.BeginUmbracoForm(action, surfaceType, null, new Dictionary&lt;string, object&gt;(), method);
        }

		/// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;surfaceType&quot;&gt;The surface controller to route to&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, Type surfaceType)
		{
			return html.BeginUmbracoForm(action, surfaceType, null, new Dictionary&lt;string, object&gt;());
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm&lt;T&gt;(this HtmlHelper html, string action, FormMethod method)
            where T : SurfaceController
        {
            return html.BeginUmbracoForm(action, typeof(T), method);
        }

		/// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm&lt;T&gt;(this HtmlHelper html, string action)
			where T : SurfaceController
		{
			return html.BeginUmbracoForm(action, typeof(T));
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;surfaceType&quot;&gt;The surface controller to route to&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, Type surfaceType,
                                               object additionalRouteVals, FormMethod method)
        {
            return html.BeginUmbracoForm(action, surfaceType, additionalRouteVals, new Dictionary&lt;string, object&gt;(), method);
        }

		/// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;surfaceType&quot;&gt;The surface controller to route to&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, Type surfaceType,
											   object additionalRouteVals)
		{
			return html.BeginUmbracoForm(action, surfaceType, additionalRouteVals, new Dictionary&lt;string, object&gt;());
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm&lt;T&gt;(this HtmlHelper html, string action, object additionalRouteVals, FormMethod method)
            where T : SurfaceController
        {
            return html.BeginUmbracoForm(action, typeof(T), additionalRouteVals, method);
        }

		/// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm&lt;T&gt;(this HtmlHelper html, string action, object additionalRouteVals)
			where T : SurfaceController
		{
			return html.BeginUmbracoForm(action, typeof(T), additionalRouteVals);
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;surfaceType&quot;&gt;The surface controller to route to&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, Type surfaceType,
                                               object additionalRouteVals,
                                               object htmlAttributes,
                                               FormMethod method)
        {
            return html.BeginUmbracoForm(action, surfaceType, additionalRouteVals, HtmlHelper.AnonymousObjectToHtmlAttributes(htmlAttributes), method);
        }

        /// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;surfaceType&quot;&gt;The surface controller to route to&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, Type surfaceType,
											   object additionalRouteVals,
											   object htmlAttributes)
		{
            return html.BeginUmbracoForm(action, surfaceType, additionalRouteVals, HtmlHelper.AnonymousObjectToHtmlAttributes(htmlAttributes));
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm&lt;T&gt;(this HtmlHelper html, string action,
                                                  object additionalRouteVals,
                                                  object htmlAttributes,
                                                  FormMethod method)
            where T : SurfaceController
        {
            return html.BeginUmbracoForm(action, typeof(T), additionalRouteVals, htmlAttributes, method);
        }

        /// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm&lt;T&gt;(this HtmlHelper html, string action,
											   object additionalRouteVals,
											   object htmlAttributes)
			where T : SurfaceController
		{
			return html.BeginUmbracoForm(action, typeof(T), additionalRouteVals, htmlAttributes);
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;surfaceType&quot;&gt;The surface controller to route to&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, Type surfaceType,
                                               object additionalRouteVals,
                                               IDictionary&lt;string, object&gt; htmlAttributes,
                                               FormMethod method)
        {
            Mandate.ParameterNotNullOrEmpty(action, &quot;action&quot;);
            Mandate.ParameterNotNull(surfaceType, &quot;surfaceType&quot;);

            var area = &quot;&quot;;

            var surfaceController = SurfaceControllerResolver.Current.RegisteredSurfaceControllers
                                                             .SingleOrDefault(x =&gt; x == surfaceType);
            if (surfaceController == null)
                throw new InvalidOperationException(&quot;Could not find the surface controller of type &quot; + surfaceType.FullName);
            var metaData = PluginController.GetMetadata(surfaceController);
            if (metaData.AreaName.IsNullOrWhiteSpace() == false)
            {
                //set the area to the plugin area
                area = metaData.AreaName;
            }
            return html.BeginUmbracoForm(action, metaData.ControllerName, area, additionalRouteVals, htmlAttributes, method);
        }

        /// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;surfaceType&quot;&gt;The surface controller to route to&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, Type surfaceType,
											   object additionalRouteVals,
											   IDictionary&lt;string, object&gt; htmlAttributes)
        {
            return html.BeginUmbracoForm(action, surfaceType, additionalRouteVals, htmlAttributes, FormMethod.Post);
        }

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm&lt;T&gt;(this HtmlHelper html, string action,
                                                  object additionalRouteVals,
                                                  IDictionary&lt;string, object&gt; htmlAttributes,
                                                  FormMethod method)
            where T : SurfaceController
        {
            return html.BeginUmbracoForm(action, typeof(T), additionalRouteVals, htmlAttributes, method);
        }

        /// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm&lt;T&gt;(this HtmlHelper html, string action,
											   object additionalRouteVals,
											   IDictionary&lt;string, object&gt; htmlAttributes)
			where T : SurfaceController
		{
			return html.BeginUmbracoForm(action, typeof(T), additionalRouteVals, htmlAttributes);
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName, string area, FormMethod method)
        {
            return html.BeginUmbracoForm(action, controllerName, area, null, new Dictionary&lt;string, object&gt;(), method);
        }

		/// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName, string area)
		{
			return html.BeginUmbracoForm(action, controllerName, area, null, new Dictionary&lt;string, object&gt;());
		}

        /// &lt;summary&gt;
        /// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName, string area,
                                               object additionalRouteVals,
                                               IDictionary&lt;string, object&gt; htmlAttributes,
                                               FormMethod method)
        {
            Mandate.ParameterNotNullOrEmpty(action, &quot;action&quot;);
            Mandate.ParameterNotNullOrEmpty(controllerName, &quot;controllerName&quot;);

            var formAction = UmbracoContext.Current.OriginalRequestUrl.PathAndQuery;
            return html.RenderForm(formAction, method, htmlAttributes, controllerName, action, area, additionalRouteVals);
        }

        /// &lt;summary&gt;
		/// Helper method to create a new form to execute in the Umbraco request pipeline to a surface controller plugin
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;controllerName&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static MvcForm BeginUmbracoForm(this HtmlHelper html, string action, string controllerName, string area,
											   object additionalRouteVals,
											   IDictionary&lt;string, object&gt; htmlAttributes)
        {
            return html.BeginUmbracoForm(action, controllerName, area, additionalRouteVals, htmlAttributes, FormMethod.Post);
        }

		/// &lt;summary&gt;
		/// This renders out the form for us
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;htmlHelper&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;formAction&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;htmlAttributes&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;surfaceController&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;surfaceAction&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;area&quot;&gt;&lt;/param&gt;		
		/// &lt;param name=&quot;additionalRouteVals&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		/// &lt;remarks&gt;
		/// This code is pretty much the same as the underlying MVC code that writes out the form
		/// &lt;/remarks&gt;
		private static MvcForm RenderForm(this HtmlHelper htmlHelper,
										  string formAction,
										  FormMethod method,
										  IDictionary&lt;string, object&gt; htmlAttributes,
										  string surfaceController,
										  string surfaceAction,
										  string area,
										  object additionalRouteVals = null)
		{

			//ensure that the multipart/form-data is added to the html attributes
			if (htmlAttributes.ContainsKey(&quot;enctype&quot;) == false)
			{
				htmlAttributes.Add(&quot;enctype&quot;, &quot;multipart/form-data&quot;);
			}

			var tagBuilder = new TagBuilder(&quot;form&quot;);
			tagBuilder.MergeAttributes(htmlAttributes);
			// action is implicitly generated, so htmlAttributes take precedence.
			tagBuilder.MergeAttribute(&quot;action&quot;, formAction);
			// method is an explicit parameter, so it takes precedence over the htmlAttributes. 
			tagBuilder.MergeAttribute(&quot;method&quot;, HtmlHelper.GetFormMethodString(method), true);
			var traditionalJavascriptEnabled = htmlHelper.ViewContext.ClientValidationEnabled &amp;&amp; htmlHelper.ViewContext.UnobtrusiveJavaScriptEnabled == false;
			if (traditionalJavascriptEnabled)
			{
				// forms must have an ID for client validation
				tagBuilder.GenerateId(&quot;form&quot; + Guid.NewGuid().ToString(&quot;N&quot;));
			}
			htmlHelper.ViewContext.Writer.Write(tagBuilder.ToString(TagRenderMode.StartTag));

			//new UmbracoForm:
			var theForm = new UmbracoForm(htmlHelper.ViewContext, surfaceController, surfaceAction, area, method, additionalRouteVals);

			if (traditionalJavascriptEnabled)
			{
				htmlHelper.ViewContext.FormContext.FormId = tagBuilder.Attributes[&quot;id&quot;];
			}
			return theForm;
		}

		#endregion
        
		#region Wrap

		public static HtmlTagWrapper Wrap(this HtmlHelper html, string tag, string innerText, params IHtmlTagWrapper[] children)
		{
			var item = html.Wrap(tag, innerText, (object)null);
			foreach (var child in children)
			{
				item.AddChild(child);
			}
			return item;
		}

		public static HtmlTagWrapper Wrap(this HtmlHelper html, string tag, object inner, object anonymousAttributes, params IHtmlTagWrapper[] children)
		{
			string innerText = null;
			if (inner != null &amp;&amp; inner.GetType() != typeof(DynamicNull))
			{
				innerText = string.Format(&quot;{0}&quot;, inner);
			}
			var item = html.Wrap(tag, innerText, anonymousAttributes);
			foreach (var child in children)
			{
				item.AddChild(child);
			}
			return item;
		}
		public static HtmlTagWrapper Wrap(this HtmlHelper html, string tag, object inner)
		{
			string innerText = null;
			if (inner != null &amp;&amp; inner.GetType() != typeof(DynamicNull))
			{
				innerText = string.Format(&quot;{0}&quot;, inner);
			}
			return html.Wrap(tag, innerText, (object)null);
		}

		public static HtmlTagWrapper Wrap(this HtmlHelper html, string tag, string innerText, object anonymousAttributes, params IHtmlTagWrapper[] children)
		{
			var wrap = new HtmlTagWrapper(tag);
			if (anonymousAttributes != null)
			{
				wrap.ReflectAttributesFromAnonymousType(anonymousAttributes);
			}
			if (!string.IsNullOrWhiteSpace(innerText))
			{
				wrap.AddChild(new HtmlTagWrapperTextNode(innerText));
			}
			foreach (var child in children)
			{
				wrap.AddChild(child);
			}
			return wrap;
		}

		public static HtmlTagWrapper Wrap(this HtmlHelper html, bool visible, string tag, string innerText, object anonymousAttributes, params IHtmlTagWrapper[] children)
		{
			var item = html.Wrap(tag, innerText, anonymousAttributes, children);
			item.Visible = visible;
			return item;
		}

        #endregion

        #region canvasdesigner

        public static IHtmlString EnableCanvasDesigner(this HtmlHelper html, 
            UrlHelper url,
            UmbracoContext umbCtx)
        {
            return html.EnableCanvasDesigner(url, umbCtx, string.Empty, string.Empty);
        }

        public static IHtmlString EnableCanvasDesigner(this HtmlHelper html,
            UrlHelper url,
            UmbracoContext umbCtx, string canvasdesignerConfigPath)
        {
            return html.EnableCanvasDesigner(url, umbCtx, canvasdesignerConfigPath, string.Empty);
        }

        public static IHtmlString EnableCanvasDesigner(this HtmlHelper html,
            UrlHelper url,
            UmbracoContext umbCtx, string canvasdesignerConfigPath, string canvasdesignerPalettesPath)
        {
            
            var umbracoPath = url.Content(SystemDirectories.Umbraco);

            string previewLink = @&quot;&lt;script src=&quot;&quot;{0}/lib/jquery/jquery.min.js&quot;&quot; type=&quot;&quot;text/javascript&quot;&quot;&gt;&lt;/script&gt;&quot; +
                                 @&quot;&lt;script src=&quot;&quot;{1}&quot;&quot; type=&quot;&quot;text/javascript&quot;&quot;&gt;&lt;/script&gt;&quot; +
                                 @&quot;&lt;script src=&quot;&quot;{2}&quot;&quot; type=&quot;&quot;text/javascript&quot;&quot;&gt;&lt;/script&gt;&quot; +
                                 @&quot;&lt;script type=&quot;&quot;text/javascript&quot;&quot;&gt;var pageId = &#39;{3}&#39;&lt;/script&gt;&quot; +
                                 @&quot;&lt;script src=&quot;&quot;{0}/js/canvasdesigner.front.js&quot;&quot; type=&quot;&quot;text/javascript&quot;&quot;&gt;&lt;/script&gt;&quot;;

            string noPreviewLinks = @&quot;&lt;link href=&quot;&quot;{1}&quot;&quot; type=&quot;&quot;text/css&quot;&quot; rel=&quot;&quot;stylesheet&quot;&quot; data-title=&quot;&quot;canvasdesignerCss&quot;&quot; /&gt;&quot;;

            // Get page value
            int pageId = umbCtx.PublishedContentRequest.UmbracoPage.PageID;
            string[] path = umbCtx.PublishedContentRequest.UmbracoPage.SplitPath;
            string result = string.Empty;
            string cssPath = CanvasDesignerUtility.GetStylesheetPath(path, false);

            if (umbCtx.InPreviewMode)
            {
                canvasdesignerConfigPath = string.IsNullOrEmpty(canvasdesignerConfigPath) == false 
                    ? canvasdesignerConfigPath 
                    : string.Format(&quot;{0}/js/canvasdesigner.config.js&quot;, umbracoPath);
                canvasdesignerPalettesPath = string.IsNullOrEmpty(canvasdesignerPalettesPath) == false 
                    ? canvasdesignerPalettesPath 
                    : string.Format(&quot;{0}/js/canvasdesigner.palettes.js&quot;, umbracoPath);

                if (string.IsNullOrEmpty(cssPath) == false)
                    result = string.Format(noPreviewLinks, cssPath) + Environment.NewLine;

                result = result + string.Format(previewLink, umbracoPath, canvasdesignerConfigPath, canvasdesignerPalettesPath, pageId);
            }
            else
            {
                // Get css path for current page
                if (string.IsNullOrEmpty(cssPath) == false)
                    result = string.Format(noPreviewLinks, cssPath);
            }

            return new HtmlString(result);

        }

        #endregion

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[34,9,34,10,0],[35,13,35,79,0],[36,9,36,10,0],[48,9,48,10,0],[49,13,49,80,0],[50,13,50,68,0],[51,13,51,67,0],[52,13,52,76,0],[53,13,53,27,0],[54,9,54,10,0],[66,9,66,10,0],[67,13,67,54,0],[68,13,68,14,0],[69,17,73,137,0],[74,17,74,53,0],[76,13,76,42,0],[78,9,78,10,0],[89,3,89,4,0],[90,4,90,54,0],[91,4,91,20,0],[92,4,92,5,0],[93,5,93,40,0],[94,5,94,6,0],[95,6,95,183,0],[97,5,97,66,0],[98,4,98,5,0],[99,4,99,22,0],[100,4,100,5,0],[101,5,101,51,0],[102,5,102,82,0],[103,4,103,5,0],[104,4,104,37,0],[105,7,105,8,0],[106,11,106,69,0],[107,17,107,63,0],[108,7,108,8,0],[109,4,109,155,0],[110,3,110,4,0],[114,3,114,4,0],[115,4,115,24,0],[116,4,118,56,0],[120,4,120,94,0],[121,3,121,4,0],[138,3,138,4,0],[139,4,139,36,0],[140,4,140,5,0],[141,5,141,89,0],[146,4,146,122,0],[147,4,147,96,0],[148,3,148,4,0],[159,9,159,10,0],[160,13,160,61,0],[161,9,161,10,0],[172,9,172,10,0],[173,13,173,66,0],[174,13,174,71,0],[176,13,176,71,0],[178,13,179,39,0],[179,39,179,55,0],[179,55,179,57,0],[178,13,179,57,0],[180,13,180,43,0],[181,17,181,126,0],[182,13,182,76,0],[183,13,183,57,0],[184,13,184,14,0],[186,17,186,51,0],[187,17,187,18,0],[188,21,188,59,0],[189,17,189,18,0],[191,17,191,18,0],[192,21,192,62,0],[193,17,193,18,0],[194,13,194,14,0],[196,13,196,86,0],[197,9,197,10,0],[204,9,204,10,0],[205,13,205,104,0],[206,9,206,10,0],[211,9,211,10,0],[212,13,212,134,0],[213,9,213,10,0],[232,9,232,10,0],[233,13,236,31,0],[237,9,237,10,0],[256,9,256,10,0],[257,13,260,31,0],[261,9,261,10,0],[288,7,288,24,0],[289,4,289,5,0],[290,11,290,38,0],[291,11,291,28,0],[292,17,292,138,0],[293,4,293,5,0],[301,4,301,5,0],[302,5,302,24,0],[303,6,303,13,0],[304,5,304,27,0],[307,17,307,116,0],[309,5,309,29,0],[310,4,310,5,0],[322,9,322,10,0],[323,13,323,114,0],[324,9,324,10,0],[334,3,334,4,0],[335,4,335,97,0],[336,3,336,4,0],[348,9,348,10,0],[349,13,349,129,0],[350,9,350,10,0],[361,3,361,4,0],[362,4,362,112,0],[363,3,363,4,0],[379,9,379,10,0],[380,13,380,155,0],[381,9,381,10,0],[395,3,395,4,0],[396,13,396,147,0],[397,3,397,4,0],[413,9,413,10,0],[414,13,414,63,0],[415,13,415,79,0],[417,13,417,115,0],[418,9,418,10,0],[432,3,432,4,0],[433,4,433,54,0],[434,4,434,70,0],[436,4,436,98,0],[437,3,437,4,0],[448,9,448,10,0],[449,13,449,111,0],[450,9,450,10,0],[460,3,460,4,0],[461,4,461,94,0],[462,3,462,4,0],[474,9,474,10,0],[475,13,475,69,0],[476,9,476,10,0],[487,3,487,4,0],[488,4,488,52,0],[489,3,489,4,0],[502,9,502,10,0],[503,13,503,126,0],[504,9,504,10,0],[516,3,516,4,0],[517,4,517,109,0],[518,3,518,4,0],[531,9,531,10,0],[532,13,532,90,0],[533,9,533,10,0],[545,3,545,4,0],[546,4,546,73,0],[547,3,547,4,0],[563,9,563,10,0],[564,13,564,152,0],[565,9,565,10,0],[579,3,579,4,0],[580,13,580,144,0],[581,3,581,4,0],[598,9,598,10,0],[599,13,599,106,0],[600,9,600,10,0],[615,3,615,4,0],[616,4,616,89,0],[617,3,617,4,0],[633,9,633,10,0],[634,13,634,63,0],[635,13,635,66,0],[637,13,637,27,0],[639,13,640,84,0],[640,84,640,100,0],[640,100,640,102,0],[639,13,640,102,0],[641,13,641,43,0],[642,17,642,126,0],[643,13,643,76,0],[644,13,644,65,0],[645,13,645,14,0],[647,17,647,42,0],[648,13,648,14,0],[649,13,649,126,0],[650,9,650,10,0],[664,9,664,10,0],[665,13,665,117,0],[666,9,666,10,0],[683,9,683,10,0],[684,13,684,106,0],[685,9,685,10,0],[700,3,700,4,0],[701,4,701,89,0],[702,3,702,4,0],[714,9,714,10,0],[715,13,715,120,0],[716,9,716,10,0],[727,3,727,4,0],[728,4,728,103,0],[729,3,729,4,0],[746,9,746,10,0],[747,13,747,63,0],[748,13,748,79,0],[750,13,750,85,0],[751,13,751,123,0],[752,9,752,10,0],[767,9,767,10,0],[768,13,768,126,0],[769,9,769,10,0],[794,3,794,4,0],[797,4,797,55,0],[798,4,798,5,0],[799,5,799,58,0],[800,4,800,5,0],[802,4,802,44,0],[803,4,803,47,0],[805,4,805,52,0],[807,4,807,86,0],[808,4,808,150,0],[809,4,809,37,0],[810,4,810,5,0],[812,5,812,66,0],[813,4,813,5,0],[814,4,814,85,0],[817,4,817,127,0],[819,4,819,37,0],[820,4,820,5,0],[821,5,821,77,0],[822,4,822,5,0],[823,4,823,19,0],[824,3,824,4,0],[831,3,831,4,1],[832,4,832,55,1],[833,4,833,11,1],[833,13,833,22,0],[833,23,833,25,1],[833,26,833,34,1],[834,4,834,5,0],[835,5,835,26,0],[836,4,836,5,0],[837,4,837,16,1],[838,3,838,4,1],[841,3,841,4,0],[842,4,842,28,0],[843,4,843,64,0],[844,4,844,5,0],[845,5,845,45,0],[846,4,846,5,0],[847,4,847,62,0],[848,4,848,11,0],[848,13,848,22,0],[848,23,848,25,0],[848,26,848,34,0],[849,4,849,5,0],[850,5,850,26,0],[851,4,851,5,0],[852,4,852,16,0],[853,3,853,4,0],[855,3,855,4,0],[856,4,856,28,0],[857,4,857,64,0],[858,4,858,5,0],[859,5,859,45,0],[860,4,860,5,0],[861,4,861,51,0],[862,3,862,4,0],[865,3,865,4,1],[866,4,866,39,1],[867,4,867,36,1],[868,4,868,5,1],[869,5,869,66,1],[870,4,870,5,1],[871,4,871,46,1],[872,4,872,5,1],[873,5,873,58,1],[874,4,874,5,1],[875,4,875,11,1],[875,13,875,22,0],[875,23,875,25,1],[875,26,875,34,1],[876,4,876,5,0],[877,5,877,26,0],[878,4,878,5,0],[879,4,879,16,1],[880,3,880,4,1],[883,3,883,4,0],[884,4,884,72,0],[885,4,885,27,0],[886,4,886,16,0],[887,3,887,4,0],[896,9,896,10,0],[897,13,897,87,0],[898,9,898,10,0],[903,9,903,10,0],[904,13,904,99,0],[905,9,905,10,0],[910,9,910,10,0],[912,13,912,70,0],[914,13,918,119,0],[920,13,920,132,0],[923,13,923,76,0],[924,13,924,82,0],[925,13,925,42,0],[926,13,926,83,0],[928,13,928,38,0],[929,13,929,14,0],[930,17,932,85,0],[933,17,935,87,0],[937,17,937,60,0],[938,21,938,91,0],[940,17,940,137,0],[941,13,941,14,0],[943,13,943,14,0],[945,17,945,60,0],[946,21,946,69,0],[947,13,947,14,0],[949,13,949,43,0],[951,9,951,10,0]]);
    </script>
  </body>
</html>