<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\member\MemberType.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Runtime.CompilerServices;
using System.Xml;
using Umbraco.Core.Logging;
using System.Linq;
using umbraco.BusinessLogic;
using Umbraco.Core;
using Umbraco.Core.Models;
using PropertyType = umbraco.cms.businesslogic.propertytype.PropertyType;

namespace umbraco.cms.businesslogic.member
{
	/// MemberType
	/// 
	/// Due to the inheritance of the ContentType class, it enables definition of generic datafields on a Members.
    [Obsolete(&quot;Obsolete, Use the MemberTypeService and Umbraco.Core.Models.MemberType&quot;, false)]
	public class MemberType : ContentType
    {
        #region Private Members

        internal static readonly Guid ObjectType = new Guid(Constants.ObjectTypes.MemberType);
        internal IMemberType MemberTypeItem
        {
            get { return base.ContentTypeItem as IMemberType; }
            set { base.ContentTypeItem = value; }
        }

        #endregion

        #region Constructors

        internal MemberType(IMemberType memberType)
            : base(memberType)
        {
            SetupNode(memberType);
        }

        /// &lt;summary&gt;
		/// Initializes a new instance of the MemberType class.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;id&quot;&gt;MemberType id&lt;/param&gt;
        public MemberType(int id) : base(id) { }

		/// &lt;summary&gt;
		/// Initializes a new instance of the MemberType class.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;id&quot;&gt;MemberType id&lt;/param&gt;
        public MemberType(Guid id) : base(id) { }

        #region Regenerate Xml Structures

        /// &lt;summary&gt;
        /// Rebuilds the xml structure for the member item by id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentId&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// This is not thread safe
        /// &lt;/remarks&gt;
        internal override void RebuildXmlStructureForContentItem(int contentId)
        {
            var xd = new XmlDocument();
            try
            {
                new Member(contentId).XmlGenerate(xd);
            }
            catch (Exception ee)
            {
                LogHelper.Error&lt;MemberType&gt;(&quot;Error generating xml&quot;, ee);
            }
        }

        #endregion

        #endregion

        #region Public Methods
        
        /// &lt;summary&gt;
		/// Get an true/false if the Member can edit the given data defined in the propertytype
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;pt&quot;&gt;Propertytype to edit&lt;/param&gt;
		/// &lt;returns&gt;True if the Member can edit the data&lt;/returns&gt;
        public bool MemberCanEdit(PropertyType pt)
        {
            return MemberTypeItem.MemberCanEditProperty(pt.Alias);
        }
        
		/// &lt;summary&gt;
		/// Get an true/false if the given data defined in the propertytype, should be visible on the members profile page
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;pt&quot;&gt;Propertytype&lt;/param&gt;
		/// &lt;returns&gt;True if the data should be displayed on the profilepage&lt;/returns&gt;
		public bool ViewOnProfile(PropertyType pt) 
		{
            return MemberTypeItem.MemberCanViewProperty(pt.Alias);
		}
		
		/// &lt;summary&gt;
		/// Set if the member should be able to edit the data defined by its propertytype
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;pt&quot;&gt;PropertyType&lt;/param&gt;
		/// &lt;param name=&quot;value&quot;&gt;True/False if Members of the type shoï¿½ld be able to edit the data&lt;/param&gt;
        public void setMemberCanEdit(PropertyType pt, bool value)
		{
		    MemberTypeItem.SetMemberCanEditProperty(pt.Alias, value);            
        }
        
		/// &lt;summary&gt;
		/// Set if the data should be displayed on members of this type&#39;s profilepage
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;pt&quot;&gt;PropertyType&lt;/param&gt;
		/// &lt;param name=&quot;value&quot;&gt;True/False if the data should be displayed&lt;/param&gt;
        public void setMemberViewOnProfile(PropertyType pt, bool value) 
		{
            MemberTypeItem.SetMemberCanViewProperty(pt.Alias, value);            
		}

		/// &lt;summary&gt;
		/// Delete the current MemberType.
		/// 
		/// Deletes all Members of the type
		/// 
		/// Use with care
		/// &lt;/summary&gt;
		public override void delete() 
		{
            var e = new DeleteEventArgs();

            FireBeforeDelete(e);

            if (e.Cancel == false) {

                ApplicationContext.Current.Services.MemberTypeService.Delete(MemberTypeItem);

                // delete all documents of this type
                FireAfterDelete(e);
            }
        }

        /// &lt;summary&gt;
        /// Used to persist object changes to the database
        /// &lt;/summary&gt;
        public override void Save()
        {
            var e = new SaveEventArgs();
            FireBeforeSave(e);

            if (e.Cancel == false)
            {
                ApplicationContext.Current.Services.MemberTypeService.Save(MemberTypeItem);
                base.Save();
                FireAfterSave(e);
            }
        }
        
        public XmlElement ToXml(XmlDocument xd)
        {
            XmlElement root = xd.CreateElement(&quot;MemberType&quot;);

            var info = xd.CreateElement(&quot;Info&quot;);
            root.AppendChild(info);
            info.AppendChild(xmlHelper.addTextNode(xd, &quot;Name&quot;, this.Text));
            info.AppendChild(xmlHelper.addTextNode(xd, &quot;Alias&quot;, this.Alias));
            info.AppendChild(xmlHelper.addTextNode(xd, &quot;Icon&quot;, this.IconUrl));
            info.AppendChild(xmlHelper.addTextNode(xd, &quot;Thumbnail&quot;, this.Thumbnail));
            info.AppendChild(xmlHelper.addTextNode(xd, &quot;Description&quot;, this.Description));

            XmlElement pts = xd.CreateElement(&quot;GenericProperties&quot;);
            foreach (PropertyType pt in this.PropertyTypes)
            {
                XmlElement ptx = xd.CreateElement(&quot;GenericProperty&quot;);
                ptx.AppendChild(xmlHelper.addTextNode(xd, &quot;Name&quot;, pt.Name));
                ptx.AppendChild(xmlHelper.addTextNode(xd, &quot;Alias&quot;, pt.Alias));
                ptx.AppendChild(xmlHelper.addTextNode(xd, &quot;Type&quot;, pt.DataTypeDefinition.DataType.Id.ToString()));

                //Datatype definition guid was added in v4 to enable datatype imports
                ptx.AppendChild(xmlHelper.addTextNode(xd, &quot;Definition&quot;, pt.DataTypeDefinition.UniqueId.ToString()));

                ptx.AppendChild(xmlHelper.addTextNode(xd, &quot;Tab&quot;, Tab.GetCaptionById(pt.TabId)));
                ptx.AppendChild(xmlHelper.addTextNode(xd, &quot;Mandatory&quot;, pt.Mandatory.ToString()));
                ptx.AppendChild(xmlHelper.addTextNode(xd, &quot;Validation&quot;, pt.ValidationRegExp));
                ptx.AppendChild(xmlHelper.addCDataNode(xd, &quot;Description&quot;, pt.Description));
                pts.AppendChild(ptx);
            }
            root.AppendChild(pts);

            // tabs
            XmlElement tabs = xd.CreateElement(&quot;Tabs&quot;);
            foreach (TabI t in getVirtualTabs.ToList())
            {
                XmlElement tabx = xd.CreateElement(&quot;Tab&quot;);
                tabx.AppendChild(xmlHelper.addTextNode(xd, &quot;Id&quot;, t.Id.ToString()));
                tabx.AppendChild(xmlHelper.addTextNode(xd, &quot;Caption&quot;, t.Caption));
                tabs.AppendChild(tabx);
            }
            root.AppendChild(tabs);
            return root;
        }

        #endregion

        #region Public Static Methods
        /// &lt;summary&gt;
        /// Get a MemberType by it&#39;s alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Alias&quot;&gt;The alias of the MemberType&lt;/param&gt;
        /// &lt;returns&gt;The MemberType with the given Alias&lt;/returns&gt;
        public new static MemberType GetByAlias(string Alias)
        {
            var result = ApplicationContext.Current.Services.MemberTypeService.Get(Alias);
            return result == null ? null : new MemberType(result);
        }

        /// &lt;summary&gt;
        /// Create a new MemberType
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Text&quot;&gt;The name of the MemberType&lt;/param&gt;
        /// &lt;param name=&quot;u&quot;&gt;Creator of the MemberType&lt;/param&gt;
        public static MemberType MakeNew(User u, string Text)
        {
            var alias = helpers.Casing.SafeAliasWithForcingCheck(Text);
            //special case, if it stars with an underscore, we have to re-add it for member types
            if (Text.StartsWith(&quot;_&quot;)) alias = &quot;_&quot; + alias;
            var mt = new Umbraco.Core.Models.MemberType(-1)
            {
                Level = 1,
                Name = Text,
                Icon = &quot;icon-user&quot;,
                Alias = alias
            };
            ApplicationContext.Current.Services.MemberTypeService.Save(mt);
            var legacy = new MemberType(mt);
            var e = new NewEventArgs();
            legacy.OnNew(e);
            return legacy;
        }

        /// &lt;summary&gt;
        /// Retrieve a list of all MemberTypes
        /// &lt;/summary&gt;
        public new static MemberType[] GetAll
        {
            get
            {
                var result = ApplicationContext.Current.Services.MemberTypeService.GetAll();
                return result.Select(x =&gt; new MemberType(x)).ToArray();
            }
        }
        #endregion

        #region Protected Methods

        protected override void setupNode()
        {
            var memberType = ApplicationContext.Current.Services.MemberTypeService.Get(Id);
            SetupNode(memberType);
        }

        #endregion

        #region Private Methods

        private void SetupNode(IMemberType contentType)
        {
            MemberTypeItem = contentType;            

            base.PopulateContentTypeFromContentTypeBase(MemberTypeItem);
            base.PopulateCMSNodeFromUmbracoEntity(MemberTypeItem, ObjectType);
        }

        #endregion

        #region Events

        /// &lt;summary&gt;
        /// The save event handler
        /// &lt;/summary&gt;
        public delegate void SaveEventHandler(MemberType sender, SaveEventArgs e);
        /// &lt;summary&gt;
        /// The new event handler
        /// &lt;/summary&gt;
        public delegate void NewEventHandler(MemberType sender, NewEventArgs e);
        /// &lt;summary&gt;
        /// The delete event handler
        /// &lt;/summary&gt;
        public delegate void DeleteEventHandler(MemberType sender, DeleteEventArgs e);


        /// &lt;summary&gt;
        /// Occurs when a language is saved.
        /// &lt;/summary&gt;
        public static event SaveEventHandler BeforeSave;
        protected virtual void FireBeforeSave(SaveEventArgs e)
        {
            if (BeforeSave != null)
                BeforeSave(this, e);
        }

        public static event SaveEventHandler AfterSave;
        protected virtual void FireAfterSave(SaveEventArgs e)
        {
            if (AfterSave != null)
                AfterSave(this, e);
        }

        public static event NewEventHandler New;
        protected virtual void OnNew(NewEventArgs e)
        {
            if (New != null)
                New(this, e);
        }

        public static event DeleteEventHandler BeforeDelete;
        protected virtual void FireBeforeDelete(DeleteEventArgs e)
        {
            if (BeforeDelete != null)
                BeforeDelete(this, e);
        }

        public static event DeleteEventHandler AfterDelete;
        protected virtual void FireAfterDelete(DeleteEventArgs e)
        {
            if (AfterDelete != null)
                AfterDelete(this, e);
        } 
        #endregion
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,95,0],[24,17,24,18,0],[24,19,24,62,0],[24,63,24,64,0],[25,17,25,18,0],[25,19,25,48,0],[25,49,25,50,0],[33,15,33,31,0],[34,9,34,10,0],[35,13,35,35,0],[36,9,36,10,0],[42,37,42,45,0],[42,46,42,47,0],[42,48,42,49,0],[48,38,48,46,0],[48,47,48,48,0],[48,49,48,50,0],[60,9,60,10,0],[61,13,61,40,0],[63,13,63,14,0],[64,17,64,55,0],[65,13,65,14,0],[66,13,66,33,0],[67,13,67,14,0],[68,17,68,73,0],[69,13,69,14,0],[70,9,70,10,0],[84,9,84,10,0],[85,13,85,67,0],[86,9,86,10,0],[94,3,94,4,0],[95,13,95,67,0],[96,3,96,4,0],[104,3,104,4,0],[105,7,105,64,0],[106,9,106,10,0],[114,3,114,4,0],[115,13,115,70,0],[116,3,116,4,0],[126,3,126,4,0],[127,13,127,43,0],[129,13,129,33,0],[131,13,131,35,0],[131,36,131,37,0],[133,17,133,94,0],[136,17,136,36,0],[137,13,137,14,0],[138,9,138,10,0],[144,9,144,10,0],[145,13,145,41,0],[146,13,146,31,0],[148,13,148,35,0],[149,13,149,14,0],[150,17,150,92,0],[151,17,151,29,0],[152,17,152,34,0],[153,13,153,14,0],[154,9,154,10,0],[157,9,157,10,0],[158,13,158,62,0],[160,13,160,49,0],[161,13,161,36,0],[162,13,162,76,0],[163,13,163,78,0],[164,13,164,79,0],[165,13,165,86,0],[166,13,166,90,0],[168,13,168,68,0],[169,13,169,20,0],[169,22,169,37,0],[169,38,169,40,0],[169,41,169,59,0],[170,13,170,14,0],[171,17,171,70,0],[172,17,172,77,0],[173,17,173,79,0],[174,17,174,114,0],[177,17,177,117,0],[179,17,179,97,0],[180,17,180,98,0],[181,17,181,95,0],[182,17,182,92,0],[183,17,183,38,0],[184,13,184,14,0],[185,13,185,35,0],[188,13,188,56,0],[189,13,189,20,0],[189,22,189,28,0],[189,29,189,31,0],[189,32,189,55,0],[190,13,190,14,0],[191,17,191,59,0],[192,17,192,84,0],[193,17,193,83,0],[194,17,194,40,0],[195,13,195,14,0],[196,13,196,36,0],[197,13,197,25,0],[198,9,198,10,0],[209,9,209,10,0],[210,13,210,91,0],[211,13,211,67,0],[212,9,212,10,0],[220,9,220,10,0],[221,13,221,72,0],[223,13,223,38,0],[223,39,223,59,0],[224,13,230,15,0],[231,13,231,76,0],[232,13,232,45,0],[233,13,233,40,0],[234,13,234,29,0],[235,13,235,27,0],[236,9,236,10,0],[244,13,244,14,0],[245,17,245,93,0],[246,17,246,43,0],[246,43,246,60,0],[246,60,246,72,0],[246,17,246,72,0],[247,13,247,14,0],[254,9,254,10,0],[255,13,255,92,0],[256,13,256,35,0],[257,9,257,10,0],[264,9,264,10,0],[265,13,265,42,0],[267,13,267,73,0],[268,13,268,79,0],[269,9,269,10,0],[294,9,294,10,0],[295,13,295,36,0],[296,17,296,37,0],[297,9,297,10,0],[301,9,301,10,0],[302,13,302,35,0],[303,17,303,36,0],[304,9,304,10,0],[308,9,308,10,0],[309,13,309,29,0],[310,17,310,30,0],[311,9,311,10,0],[315,9,315,10,0],[316,13,316,38,0],[317,17,317,39,0],[318,9,318,10,0],[322,9,322,10,0],[323,13,323,37,0],[324,17,324,38,0],[325,9,325,10,0]]);
    </script>
  </body>
</html>