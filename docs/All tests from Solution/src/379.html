<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\ScriptRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.IO;
using System.Linq;
using System.Text;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [TestFixture]
    public class ScriptRepositoryTest : BaseUmbracoApplicationTest
    {
        private IFileSystem _fileSystem;

        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            _fileSystem = new PhysicalFileSystem(SystemDirectories.Scripts);
            using (var stream = CreateStream(&quot;Umbraco.Sys.registerNamespace(\&quot;Umbraco.Utils\&quot;);&quot;))
            {
                _fileSystem.AddFile(&quot;test-script.js&quot;, stream);    
            }
        }

        [Test]
        public void Can_Instantiate_Repository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();

            // Act
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            // Assert
            Assert.That(repository, Is.Not.Null);
        }

        [Test]
        public void Can_Perform_Add_On_ScriptRepository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            // Act
            var script = new Script(&quot;test-add-script.js&quot;) {Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot;};
            repository.AddOrUpdate(script);
            unitOfWork.Commit();

            //Assert
            Assert.That(_fileSystem.FileExists(&quot;test-add-script.js&quot;), Is.True);
        }

        [Test]
        public void Can_Perform_Update_On_ScriptRepository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            // Act
            var script = new Script(&quot;test-updated-script.js&quot;) { Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot; };
            repository.AddOrUpdate(script);
            unitOfWork.Commit();

            script.Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax-Updated.js\&quot;/&gt;&quot;;
            repository.AddOrUpdate(script);
            unitOfWork.Commit();

            var scriptUpdated = repository.Get(&quot;test-updated-script.js&quot;);

            // Assert
            Assert.That(_fileSystem.FileExists(&quot;test-updated-script.js&quot;), Is.True);
            Assert.That(scriptUpdated.Content, Is.EqualTo(&quot;/// &lt;reference name=\&quot;MicrosoftAjax-Updated.js\&quot;/&gt;&quot;));
        }

        [Test]
        public void Can_Perform_Delete_On_ScriptRepository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            // Act
            var script = repository.Get(&quot;test-script.js&quot;);
            repository.Delete(script);
            unitOfWork.Commit();

            // Assert

            Assert.IsFalse(repository.Exists(&quot;test-script.js&quot;));

        }

        [Test]
        public void Can_Perform_Get_On_ScriptRepository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            // Act
            var exists = repository.Get(&quot;test-script.js&quot;);

            // Assert
            Assert.That(exists, Is.Not.Null);
            Assert.That(exists.Alias, Is.EqualTo(&quot;test-script&quot;));
            Assert.That(exists.Name, Is.EqualTo(&quot;test-script.js&quot;));
        }

        [Test]
        public void Can_Perform_GetAll_On_ScriptRepository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            var script = new Script(&quot;test-script1.js&quot;) { Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot; };
            repository.AddOrUpdate(script);
            var script2 = new Script(&quot;test-script2.js&quot;) { Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot; };
            repository.AddOrUpdate(script2);
            var script3 = new Script(&quot;test-script3.js&quot;) { Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot; };
            repository.AddOrUpdate(script3);
            unitOfWork.Commit();

            // Act
            var scripts = repository.GetAll();

            // Assert
            Assert.That(scripts, Is.Not.Null);
            Assert.That(scripts.Any(), Is.True);
            Assert.That(scripts.Any(x =&gt; x == null), Is.False);
            Assert.That(scripts.Count(), Is.EqualTo(4));
        }

        [Test]
        public void Can_Perform_GetAll_With_Params_On_ScriptRepository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            var script = new Script(&quot;test-script1.js&quot;) { Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot; };
            repository.AddOrUpdate(script);
            var script2 = new Script(&quot;test-script2.js&quot;) { Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot; };
            repository.AddOrUpdate(script2);
            var script3 = new Script(&quot;test-script3.js&quot;) { Content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot; };
            repository.AddOrUpdate(script3);
            unitOfWork.Commit();

            // Act
            var scripts = repository.GetAll(&quot;test-script1.js&quot;, &quot;test-script2.js&quot;);

            // Assert
            Assert.That(scripts, Is.Not.Null);
            Assert.That(scripts.Any(), Is.True);
            Assert.That(scripts.Any(x =&gt; x == null), Is.False);
            Assert.That(scripts.Count(), Is.EqualTo(2));
        }

        [Test]
        public void Can_Perform_Exists_On_ScriptRepository()
        {
            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            // Act
            var exists = repository.Exists(&quot;test-script.js&quot;);

            // Assert
            Assert.That(exists, Is.True);
        }

        [Test]
        public void Can_Perform_Move_On_ScriptRepository()
        {
            const string content = &quot;/// &lt;reference name=\&quot;MicrosoftAjax.js\&quot;/&gt;&quot;;

            // Arrange
            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            var script = new Script(&quot;test-move-script.js&quot;) { Content = content };
            repository.AddOrUpdate(script);
            unitOfWork.Commit();

            // Act
            script = repository.Get(&quot;test-move-script.js&quot;);
            script.Path = &quot;moved/test-move-script.js&quot;;
            repository.AddOrUpdate(script);
            unitOfWork.Commit();

            var existsOld = repository.Exists(&quot;test-move-script.js&quot;);
            var existsNew = repository.Exists(&quot;moved/test-move-script.js&quot;);

            script = repository.Get(&quot;moved/test-move-script.js&quot;);

            // Assert
            Assert.IsNotNull(script);
            Assert.IsFalse(existsOld);
            Assert.IsTrue(existsNew);
            Assert.AreEqual(content, script.Content);
        }

        [Test]
        public void PathTests()
        {
            // unless noted otherwise, no changes / 7.2.8

            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new ScriptRepository(unitOfWork, _fileSystem, Mock.Of&lt;IContentSection&gt;());

            var script = new Script(&quot;test-path-1.js&quot;) { Content = &quot;// script&quot; };
            repository.AddOrUpdate(script);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;test-path-1.js&quot;));
            Assert.AreEqual(&quot;test-path-1.js&quot;, script.Path);
            Assert.AreEqual(&quot;/scripts/test-path-1.js&quot;, script.VirtualPath);

            script = new Script(&quot;path-2/test-path-2.js&quot;) { Content = &quot;// script&quot; };
            repository.AddOrUpdate(script);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;path-2/test-path-2.js&quot;));
            Assert.AreEqual(&quot;path-2\\test-path-2.js&quot;, script.Path); // fixed in 7.3 - 7.2.8 does not update the path
            Assert.AreEqual(&quot;/scripts/path-2/test-path-2.js&quot;, script.VirtualPath);

            script = repository.Get(&quot;path-2/test-path-2.js&quot;);
            Assert.IsNotNull(script);
            Assert.AreEqual(&quot;path-2\\test-path-2.js&quot;, script.Path);
            Assert.AreEqual(&quot;/scripts/path-2/test-path-2.js&quot;, script.VirtualPath);

            script = new Script(&quot;path-2\\test-path-3.js&quot;) { Content = &quot;// script&quot; };
            repository.AddOrUpdate(script);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;path-2/test-path-3.js&quot;));
            Assert.AreEqual(&quot;path-2\\test-path-3.js&quot;, script.Path);
            Assert.AreEqual(&quot;/scripts/path-2/test-path-3.js&quot;, script.VirtualPath);

            script = repository.Get(&quot;path-2/test-path-3.js&quot;);
            Assert.IsNotNull(script);
            Assert.AreEqual(&quot;path-2\\test-path-3.js&quot;, script.Path);
            Assert.AreEqual(&quot;/scripts/path-2/test-path-3.js&quot;, script.VirtualPath);

            script = repository.Get(&quot;path-2\\test-path-3.js&quot;);
            Assert.IsNotNull(script);
            Assert.AreEqual(&quot;path-2\\test-path-3.js&quot;, script.Path);
            Assert.AreEqual(&quot;/scripts/path-2/test-path-3.js&quot;, script.VirtualPath);

            script = new Script(&quot;\\test-path-4.js&quot;) { Content = &quot;// script&quot; };
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt; // fixed in 7.3 - 7.2.8 used to strip the \
            {
                repository.AddOrUpdate(script);
            });

            script = repository.Get(&quot;missing.js&quot;);
            Assert.IsNull(script);

            // fixed in 7.3 - 7.2.8 used to...
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt;
            {
                script = repository.Get(&quot;\\test-path-4.js&quot;); // outside the filesystem, does not exist
            });
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt;
            {
                script = repository.Get(&quot;../packages.config&quot;); // outside the filesystem, exists
            });
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();

            //Delete all files
            Purge((PhysicalFileSystem) _fileSystem, &quot;&quot;);
            _fileSystem = null;
        }

        private void Purge(PhysicalFileSystem fs, string path)
        {
            var files = fs.GetFiles(path, &quot;*.js&quot;);
            foreach (var file in files)
            {
                fs.DeleteFile(file);
            }
            var dirs = fs.GetDirectories(path);
            foreach (var dir in dirs)
            {
                Purge(fs, dir);
                fs.DeleteDirectory(dir);
            }
        }

        protected Stream CreateStream(string contents = null)
        {
            if (string.IsNullOrEmpty(contents))
                contents = &quot;/* test */&quot;;

            var bytes = Encoding.UTF8.GetBytes(contents);
            var stream = new MemoryStream(bytes);

            return stream;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[24,13,24,31,1],[26,13,26,77,1],[27,20,27,98,1],[28,13,28,14,1],[29,17,29,63,1],[30,13,30,14,1],[31,9,31,10,1],[35,9,35,10,1],[37,13,37,57,1],[38,13,38,55,1],[41,13,41,104,1],[44,13,44,50,1],[45,9,45,10,1],[49,9,49,10,1],[51,13,51,57,1],[52,13,52,55,1],[53,13,53,104,1],[56,13,56,116,1],[57,13,57,44,1],[58,13,58,33,1],[61,13,61,80,1],[62,9,62,10,1],[66,9,66,10,1],[68,13,68,57,1],[69,13,69,55,1],[70,13,70,104,1],[73,13,73,122,1],[74,13,74,44,1],[75,13,75,33,1],[77,13,77,83,1],[78,13,78,44,1],[79,13,79,33,1],[81,13,81,74,1],[84,13,84,84,1],[85,13,85,114,1],[86,9,86,10,1],[90,9,90,10,1],[92,13,92,57,1],[93,13,93,55,1],[94,13,94,104,1],[97,13,97,59,1],[98,13,98,39,1],[99,13,99,33,1],[103,13,103,65,1],[105,9,105,10,1],[109,9,109,10,1],[111,13,111,57,1],[112,13,112,55,1],[113,13,113,104,1],[116,13,116,59,1],[119,13,119,46,1],[120,13,120,66,1],[121,13,121,68,1],[122,9,122,10,1],[126,9,126,10,1],[128,13,128,57,1],[129,13,129,55,1],[130,13,130,104,1],[132,13,132,115,1],[133,13,133,44,1],[134,13,134,116,1],[135,13,135,45,1],[136,13,136,116,1],[137,13,137,45,1],[138,13,138,33,1],[141,13,141,47,1],[144,13,144,47,1],[145,13,145,49,1],[146,13,146,42,1],[146,42,146,51,1],[146,51,146,64,1],[146,13,146,64,1],[147,13,147,57,1],[148,9,148,10,1],[152,9,152,10,1],[154,13,154,57,1],[155,13,155,55,1],[156,13,156,104,1],[158,13,158,115,1],[159,13,159,44,1],[160,13,160,116,1],[161,13,161,45,1],[162,13,162,116,1],[163,13,163,45,1],[164,13,164,33,1],[167,13,167,83,1],[170,13,170,47,1],[171,13,171,49,1],[172,13,172,42,1],[172,42,172,51,1],[172,51,172,64,1],[172,13,172,64,1],[173,13,173,57,1],[174,9,174,10,1],[178,9,178,10,1],[180,13,180,57,1],[181,13,181,55,1],[182,13,182,104,1],[185,13,185,62,1],[188,13,188,42,1],[189,9,189,10,1],[193,9,193,10,1],[197,13,197,57,1],[198,13,198,55,1],[199,13,199,104,1],[201,13,201,82,1],[202,13,202,44,1],[203,13,203,33,1],[206,13,206,60,1],[207,13,207,55,1],[208,13,208,44,1],[209,13,209,33,1],[211,13,211,70,1],[212,13,212,76,1],[214,13,214,66,1],[217,13,217,38,1],[218,13,218,39,1],[219,13,219,38,1],[220,13,220,54,1],[221,9,221,10,1],[225,9,225,10,1],[228,13,228,57,1],[229,13,229,55,1],[230,13,230,104,1],[232,13,232,81,1],[233,13,233,44,1],[234,13,234,33,1],[235,13,235,69,1],[236,13,236,60,1],[237,13,237,76,1],[239,13,239,84,1],[240,13,240,44,1],[241,13,241,33,1],[242,13,242,76,1],[243,13,243,68,1],[244,13,244,83,1],[246,13,246,62,1],[247,13,247,38,1],[248,13,248,68,1],[249,13,249,83,1],[251,13,251,85,1],[252,13,252,44,1],[253,13,253,33,1],[254,13,254,76,1],[255,13,255,68,1],[256,13,256,83,1],[258,13,258,62,1],[259,13,259,38,1],[260,13,260,68,1],[261,13,261,83,1],[263,13,263,63,1],[264,13,264,38,1],[265,13,265,68,1],[266,13,266,83,1],[268,13,268,79,1],[269,13,270,13,1],[270,13,270,14,1],[270,14,271,17,1],[271,17,271,48,1],[271,48,272,13,1],[272,13,272,14,0],[272,14,272,16,1],[269,13,272,16,1],[274,13,274,51,1],[275,13,275,35,1],[278,13,279,13,1],[279,13,279,14,1],[279,14,280,17,1],[280,17,280,61,1],[280,61,281,13,1],[281,13,281,14,0],[281,14,281,16,1],[278,13,281,16,1],[282,13,283,13,1],[283,13,283,14,1],[283,14,284,17,1],[284,17,284,63,1],[284,63,285,13,1],[285,13,285,14,0],[285,14,285,16,1],[282,13,285,16,1],[286,9,286,10,1],[290,9,290,10,1],[291,13,291,29,1],[294,13,294,57,1],[295,13,295,32,1],[296,9,296,10,1],[299,9,299,10,1],[300,13,300,51,1],[301,13,301,20,1],[301,22,301,30,1],[301,31,301,33,1],[301,34,301,39,1],[302,13,302,14,1],[303,17,303,37,1],[304,13,304,14,1],[305,13,305,48,1],[306,13,306,20,1],[306,22,306,29,1],[306,30,306,32,1],[306,33,306,37,1],[307,13,307,14,1],[308,17,308,32,1],[309,17,309,41,1],[310,13,310,14,1],[311,9,311,10,1],[314,9,314,10,1],[315,13,315,48,1],[316,17,316,41,0],[318,13,318,58,1],[319,13,319,50,1],[321,13,321,27,1],[322,9,322,10,1]]);
    </script>
  </body>
</html>