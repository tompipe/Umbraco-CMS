<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSeven\AssignMissingKeysAndIndexes.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Data;
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSeven
{
    /// &lt;summary&gt;
    /// I&#39;m not actually sure how this is possible but I&#39;ve come across one install that was missing these PKs
    /// and it wasn&#39;t a MySQL install. 
    /// see: http://issues.umbraco.org/issue/U4-5707
    /// &lt;/summary&gt;
    [Migration(&quot;7.0.0&quot;, 0, GlobalSettings.UmbracoMigrationName)]
    public class AssignMissingKeysAndIndexes : MigrationBase
    {
        public AssignMissingKeysAndIndexes(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {

            //Some very old schemas don&#39;t have an index on the cmsContent.nodeId column, I&#39;m not actually sure when it was added but 
            // it is absolutely required to exist in order to have it as a foreign key reference, so we&#39;ll need to check it&#39;s existence
            // this came to light from this issue: http://issues.umbraco.org/issue/U4-4133
            var dbIndexes = SqlSyntax.GetDefinedIndexes(Context.Database)
                .Select(x =&gt; new DbIndexDefinition()
                {
                    TableName = x.Item1,
                    IndexName = x.Item2,
                    ColumnName = x.Item3,
                    IsUnique = x.Item4
                }).ToArray();
            if (dbIndexes.Any(x =&gt; x.IndexName.InvariantEquals(&quot;IX_cmsContent&quot;)) == false)
            {
                Create.Index(&quot;IX_cmsContent&quot;).OnTable(&quot;cmsContent&quot;).OnColumn(&quot;nodeId&quot;).Ascending().WithOptions().Unique();
            }

            if (Context.CurrentDatabaseProvider == DatabaseProviders.SqlServer 
                || Context.CurrentDatabaseProvider == DatabaseProviders.SqlServerCE)
            {
                var constraints = SqlSyntax.GetConstraintsPerColumn(Context.Database).Distinct().ToArray();

                //This should be 2 because this table has 2 keys
                if (constraints.Count(x =&gt; x.Item1.InvariantEquals(&quot;cmsPreviewXml&quot;) &amp;&amp; x.Item3.InvariantStartsWith(&quot;PK_&quot;)) == 0)
                {
                    Create.PrimaryKey(&quot;PK_cmsContentPreviewXml&quot;)
                        .OnTable(&quot;cmsPreviewXml&quot;)
                        .Columns(new[] { &quot;nodeId&quot;, &quot;versionId&quot; });
                }

                if (constraints.Count(x =&gt; x.Item1.InvariantEquals(&quot;cmsTags&quot;) &amp;&amp; x.Item3.InvariantStartsWith(&quot;PK_&quot;)) == 0)
                {
                    Create.PrimaryKey(&quot;PK_cmsTags&quot;)
                        .OnTable(&quot;cmsTags&quot;)
                        .Columns(new[] { &quot;id&quot; });
                }

                if (constraints.Count(x =&gt; x.Item1.InvariantEquals(&quot;cmsStylesheetProperty&quot;) &amp;&amp; x.Item3.InvariantStartsWith(&quot;PK_&quot;)) == 0)
                {
                    Create.PrimaryKey(&quot;PK_cmsStylesheetProperty&quot;)
                        .OnTable(&quot;cmsStylesheetProperty&quot;)
                        .Columns(new[] { &quot;nodeId&quot; });
                }

                if (constraints.Count(x =&gt; x.Item1.InvariantEquals(&quot;cmsStylesheet&quot;) &amp;&amp; x.Item3.InvariantStartsWith(&quot;PK_&quot;)) == 0)
                {
                    Create.PrimaryKey(&quot;PK_cmsStylesheet&quot;)
                        .OnTable(&quot;cmsStylesheet&quot;)
                        .Columns(new[] { &quot;nodeId&quot; });

                    Create.ForeignKey(&quot;FK_cmsStylesheet_umbracoNode_id&quot;).FromTable(&quot;cmsStylesheet&quot;).ForeignColumn(&quot;nodeId&quot;)
                        .ToTable(&quot;umbracoNode&quot;).PrimaryColumn(&quot;id&quot;).OnDeleteOrUpdate(Rule.None);
                }

                if (constraints.Count(x =&gt; x.Item1.InvariantEquals(&quot;cmsMember&quot;) &amp;&amp; x.Item3.InvariantStartsWith(&quot;PK_&quot;)) == 0)
                {
                    Create.PrimaryKey(&quot;PK_cmsMember&quot;)
                        .OnTable(&quot;cmsMember&quot;)
                        .Columns(new[] { &quot;nodeId&quot; });

                    Create.ForeignKey(&quot;FK_cmsMember_umbracoNode_id&quot;).FromTable(&quot;cmsMember&quot;).ForeignColumn(&quot;nodeId&quot;)
                        .ToTable(&quot;umbracoNode&quot;).PrimaryColumn(&quot;id&quot;).OnDeleteOrUpdate(Rule.None);

                    Create.ForeignKey(&quot;FK_cmsMember_cmsContent_nodeId&quot;).FromTable(&quot;cmsMember&quot;).ForeignColumn(&quot;nodeId&quot;)
                        .ToTable(&quot;cmsContent&quot;).PrimaryColumn(&quot;nodeId&quot;).OnDeleteOrUpdate(Rule.None);
                }
            }
        }

        public override void Down()
        {
            //don&#39;t do anything, these keys should have always existed!
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,92,18,115,0],[19,9,19,10,0],[20,9,20,10,0],[23,9,23,10,0],[28,13,29,30,0],[29,30,35,18,0],[35,18,35,30,0],[28,13,35,30,0],[36,13,36,36,0],[36,36,36,80,0],[36,80,36,91,0],[36,13,36,91,0],[37,13,37,14,0],[38,17,38,123,0],[39,13,39,14,0],[41,13,42,85,0],[43,13,43,14,0],[44,17,44,108,0],[47,17,47,44,0],[47,44,47,122,0],[47,122,47,129,0],[47,17,47,129,0],[48,17,48,18,0],[49,21,51,67,0],[52,17,52,18,0],[54,17,54,44,0],[54,44,54,116,0],[54,116,54,123,0],[54,17,54,123,0],[55,17,55,18,0],[56,21,58,50,0],[59,17,59,18,0],[61,17,61,44,0],[61,44,61,130,0],[61,130,61,137,0],[61,17,61,137,0],[62,17,62,18,0],[63,21,65,54,0],[66,17,66,18,0],[68,17,68,44,0],[68,44,68,122,0],[68,122,68,129,0],[68,17,68,129,0],[69,17,69,18,0],[70,21,72,54,0],[74,21,75,97,0],[76,17,76,18,0],[78,17,78,44,0],[78,44,78,118,0],[78,118,78,125,0],[78,17,78,125,0],[79,17,79,18,0],[80,21,82,54,0],[84,21,85,97,0],[87,21,88,100,0],[89,17,89,18,0],[90,13,90,14,0],[91,9,91,10,0],[94,9,94,10,0],[96,9,96,10,0]]);
    </script>
  </body>
</html>