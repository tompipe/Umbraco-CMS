<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\ApplicationContext.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using System.Threading;
using System.Threading.Tasks;
using System.Web;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;
using Umbraco.Core.Profiling;
using Umbraco.Core.Services;
using Umbraco.Core.Sync;

namespace Umbraco.Core
{
	/// &lt;summary&gt;
    /// the Umbraco Application context
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// one per AppDomain, represents the global Umbraco application
    /// &lt;/remarks&gt;
    public class ApplicationContext : IDisposable
    {
        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dbContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;serviceContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cache&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;logger&quot;&gt;&lt;/param&gt;
        public ApplicationContext(DatabaseContext dbContext, ServiceContext serviceContext, CacheHelper cache, ProfilingLogger logger)
	    {
            if (dbContext == null) throw new ArgumentNullException(&quot;dbContext&quot;);
            if (serviceContext == null) throw new ArgumentNullException(&quot;serviceContext&quot;);
            if (cache == null) throw new ArgumentNullException(&quot;cache&quot;);
            if (logger == null) throw new ArgumentNullException(&quot;logger&quot;);
            _databaseContext = dbContext;
            _services = serviceContext;
            ApplicationCache = cache;
            ProfilingLogger = logger;

            Init();
	    }

	    /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dbContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;serviceContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cache&quot;&gt;&lt;/param&gt;
        [Obsolete(&quot;Use the other constructor specifying a ProfilingLogger instead&quot;)]
        public ApplicationContext(DatabaseContext dbContext, ServiceContext serviceContext, CacheHelper cache)
            : this(dbContext, serviceContext, cache, 
                new ProfilingLogger(LoggerResolver.Current.Logger, ProfilerResolver.Current.Profiler))
        {
        }

        /// &lt;summary&gt;
        /// Creates a basic app context
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cache&quot;&gt;&lt;/param&gt;
        [Obsolete(&quot;Use the other constructor specifying a ProfilingLogger instead&quot;)]
        public ApplicationContext(CacheHelper cache)
        {
            if (cache == null) throw new ArgumentNullException(&quot;cache&quot;);
            ApplicationCache = cache;
            ProfilingLogger = new ProfilingLogger(LoggerResolver.Current.Logger, ProfilerResolver.Current.Profiler);
            Init();
        }

	    /// &lt;summary&gt;
	    /// Creates a basic app context
	    /// &lt;/summary&gt;
	    /// &lt;param name=&quot;cache&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;logger&quot;&gt;&lt;/param&gt;
	    public ApplicationContext(CacheHelper cache, ProfilingLogger logger)
        {
	        if (cache == null) throw new ArgumentNullException(&quot;cache&quot;);
	        if (logger == null) throw new ArgumentNullException(&quot;logger&quot;);
	        ApplicationCache = cache;
	        ProfilingLogger = logger;
            Init();
        }

	    /// &lt;summary&gt;
	    /// A method used to set and/or ensure that a global ApplicationContext singleton is created.
	    /// &lt;/summary&gt;
	    /// &lt;param name=&quot;appContext&quot;&gt;
	    /// The instance to set on the global application singleton
	    /// &lt;/param&gt;
	    /// &lt;param name=&quot;replaceContext&quot;&gt;If set to true and the singleton is already set, it will be replaced&lt;/param&gt;
	    /// &lt;returns&gt;&lt;/returns&gt;
	    /// &lt;remarks&gt;
	    /// This is NOT thread safe 
	    /// &lt;/remarks&gt;
	    public static ApplicationContext EnsureContext(ApplicationContext appContext, bool replaceContext)
	    {
            if (Current != null)
            {
                if (!replaceContext)
                    return Current;
            }
            Current = appContext;
            return Current;
	    }

	    /// &lt;summary&gt;
	    /// A method used to create and ensure that a global ApplicationContext singleton is created.
	    /// &lt;/summary&gt;
	    /// &lt;param name=&quot;cache&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;replaceContext&quot;&gt;
	    /// If set to true will replace the current singleton instance - This should only be used for unit tests or on app 
	    /// startup if for some reason the boot manager is not the umbraco boot manager.
	    /// &lt;/param&gt;
	    /// &lt;param name=&quot;dbContext&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;serviceContext&quot;&gt;&lt;/param&gt;
	    /// &lt;returns&gt;&lt;/returns&gt;
	    /// &lt;remarks&gt;
	    /// This is NOT thread safe 
	    /// &lt;/remarks&gt;
        [Obsolete(&quot;Use the other method specifying an ProfilingLogger instead&quot;)]
	    public static ApplicationContext EnsureContext(DatabaseContext dbContext, ServiceContext serviceContext, CacheHelper cache, bool replaceContext)
        {
            if (Current != null)
            {
                if (!replaceContext)
                    return Current;
            }
            var ctx = new ApplicationContext(dbContext, serviceContext, cache);
            Current = ctx;
            return Current;
        }

	    /// &lt;summary&gt;
	    /// A method used to create and ensure that a global ApplicationContext singleton is created.
	    /// &lt;/summary&gt;
	    /// &lt;param name=&quot;cache&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;logger&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;replaceContext&quot;&gt;
	    /// If set to true will replace the current singleton instance - This should only be used for unit tests or on app 
	    /// startup if for some reason the boot manager is not the umbraco boot manager.
	    /// &lt;/param&gt;
	    /// &lt;param name=&quot;dbContext&quot;&gt;&lt;/param&gt;
	    /// &lt;param name=&quot;serviceContext&quot;&gt;&lt;/param&gt;
	    /// &lt;returns&gt;&lt;/returns&gt;
	    /// &lt;remarks&gt;
	    /// This is NOT thread safe 
	    /// &lt;/remarks&gt;
        public static ApplicationContext EnsureContext(DatabaseContext dbContext, ServiceContext serviceContext, CacheHelper cache, ProfilingLogger logger, bool replaceContext)
        {
            if (Current != null)
            {
                if (!replaceContext)
                    return Current;
            }
            var ctx = new ApplicationContext(dbContext, serviceContext, cache, logger);
            Current = ctx;
            return Current;
        }

	    /// &lt;summary&gt;
    	/// Singleton accessor
    	/// &lt;/summary&gt;
    	public static ApplicationContext Current { get; internal set; }

		/// &lt;summary&gt;
		/// Returns the application wide cache accessor
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Any caching that is done in the application (app wide) should be done through this property
		/// &lt;/remarks&gt;
		public CacheHelper ApplicationCache { get; private set; }

        /// &lt;summary&gt;
        /// Exposes the global ProfilingLogger - this should generally not be accessed via the UmbracoContext and should normally just be exposed 
        /// on most base classes or injected with IoC
        /// &lt;/summary&gt;
        public ProfilingLogger ProfilingLogger { get; private set; }

	    // IsReady is set to true by the boot manager once it has successfully booted
        // note - the original umbraco module checks on content.Instance in umbraco.dll
        //   now, the boot task that setup the content store ensures that it is ready
        bool _isReady = false;
		readonly ManualResetEventSlim _isReadyEvent = new ManualResetEventSlim(false);
		private DatabaseContext _databaseContext;
		private ServiceContext _services;

		public bool IsReady
        {
            get
            {
                return _isReady;
            }
            internal set
            {
                AssertIsNotReady();
                _isReady = value;
				_isReadyEvent.Set();
            }
        }

		public bool WaitForReady(int timeout)
		{
			return _isReadyEvent.WaitHandle.WaitOne(timeout);
		}


        // notes
        //   GlobalSettings.ConfigurationStatus returns the value that&#39;s in the web.config, so it&#39;s the &quot;configured version&quot;
        //   GlobalSettings.CurrentVersion returns the hard-coded &quot;current version&quot;
        //   the system is configured if they match
        //   if they don&#39;t, install runs, updates web.config (presumably) and updates GlobalSettings.ConfiguredStatus
        
        public bool IsConfigured
        {
            get { return _configured.Value; }
        }

        /// &lt;summary&gt;
        /// If the db is configured, there is a database context and there is an umbraco schema, but we are not &#39;configured&#39; , then it means we are upgrading
        /// &lt;/summary&gt;
	    public bool IsUpgrading
	    {
            get
            {
                if (IsConfigured == false 
                    &amp;&amp; DatabaseContext != null 
                    &amp;&amp; DatabaseContext.IsDatabaseConfigured)
                {
                    var schemaresult = DatabaseContext.ValidateDatabaseSchema();
                    if (schemaresult.ValidTables.Count &gt; 0) return true;
                }

                return false;
            }
	    }

	    /// &lt;summary&gt;
        /// The application url.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// The application url is the url that should be used by services to talk to the application,
        /// eg keep alive or scheduled publishing services. It must exist on a global context because
        /// some of these services may not run within a web context.
        /// The format of the application url is:
        /// - has a scheme (http or https)
        /// - has the SystemDirectories.Umbraco path
        /// - does not end with a slash
        /// It is initialized on the first request made to the server, by UmbracoModule.EnsureApplicationUrl:
        /// - if umbracoSettings:settings/web.routing/@umbracoApplicationUrl is set, use the value (new setting)
        /// - if umbracoSettings:settings/scheduledTasks/@baseUrl is set, use the value (backward compatibility)
        /// - otherwise, use the url of the (first) request.
        /// Not locking, does not matter if several threads write to this.
        /// See also issues:
        /// - http://issues.umbraco.org/issue/U4-2059
        /// - http://issues.umbraco.org/issue/U4-6788
        /// - http://issues.umbraco.org/issue/U4-5728
        /// - http://issues.umbraco.org/issue/U4-5391
        /// &lt;/remarks&gt;
        internal string UmbracoApplicationUrl
        {
            get
            {
                ApplicationUrlHelper.EnsureApplicationUrl(this);
                return _umbracoApplicationUrl;
            }
        }

	    // ReSharper disable once InconsistentNaming
	    internal string _umbracoApplicationUrl;

        private Lazy&lt;bool&gt; _configured;
        internal MainDom MainDom { get; private set; }
       
	    private void Init()
		{
            MainDom = new MainDom(ProfilingLogger.Logger);
            MainDom.Acquire();
            
            //Create the lazy value to resolve whether or not the application is &#39;configured&#39;
            _configured = new Lazy&lt;bool&gt;(() =&gt;
            {
                try
                {
                    var configStatus = ConfigurationStatus;
                    var currentVersion = UmbracoVersion.GetSemanticVersion();

                    var ok =
                        //we are not configured if this is null    
                        string.IsNullOrWhiteSpace(configStatus) == false
                        //they must match
                        &amp;&amp; configStatus == currentVersion;

                    if (ok)
                    {
                        //The versions are the same in config, but are they the same in the database. We can only check this
                        // if we have a db context available, if we don&#39;t then we are not installed anyways
                        if (DatabaseContext.IsDatabaseConfigured &amp;&amp; DatabaseContext.CanConnect)
                        {
                            var found = Services.MigrationEntryService.FindEntry(GlobalSettings.UmbracoMigrationName, UmbracoVersion.GetSemanticVersion());
                            if (found == null)
                            {
                                //we haven&#39;t executed this migration in this environment, so even though the config versions match, 
                                // this db has not been updated.
                                ProfilingLogger.Logger.Debug&lt;ApplicationContext&gt;(string.Format(&quot;The migration for version: &#39;{0} has not been executed, there is no record in the database&quot;, currentVersion.ToSemanticString()));
                                ok = false;
                            }
                        }
                    }
                    else
                    {
                        ProfilingLogger.Logger.Debug&lt;ApplicationContext&gt;(string.Format(&quot;CurrentVersion different from configStatus: &#39;{0}&#39;,&#39;{1}&#39;&quot;, currentVersion.ToSemanticString(), configStatus));
                    }

                    return ok;
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;ApplicationContext&gt;(&quot;Error determining if application is configured, returning false&quot;, ex);
                    return false;
                }

            }); 
		}

		private string ConfigurationStatus
		{
			get
			{
				try
				{
					return ConfigurationManager.AppSettings[&quot;umbracoConfigurationStatus&quot;];
				}
				catch
				{
					return String.Empty;
				}
			}			
		}

        private void AssertIsNotReady()
        {
            if (this.IsReady)
                throw new Exception(&quot;ApplicationContext has already been initialized.&quot;);
        }

		/// &lt;summary&gt;
		/// Gets the current DatabaseContext
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Internal set is generally only used for unit tests
		/// &lt;/remarks&gt;
		public DatabaseContext DatabaseContext
		{
			get
			{
				if (_databaseContext == null)
					throw new InvalidOperationException(&quot;The DatabaseContext has not been set on the ApplicationContext&quot;);
				return _databaseContext;
			}
			internal set { _databaseContext = value; }
		}
		
		/// &lt;summary&gt;
		/// Gets the current ServiceContext
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// Internal set is generally only used for unit tests
		/// &lt;/remarks&gt;
		public ServiceContext Services
		{
			get
			{
				if (_services == null)
					throw new InvalidOperationException(&quot;The ServiceContext has not been set on the ApplicationContext&quot;);
				return _services;
			}
			internal set { _services = value; }
		}

	    internal ServerRole GetCurrentServerRole()
	    {
	        var registrar = ServerRegistrarResolver.Current.Registrar as IServerRegistrar2;
            return registrar == null ? ServerRole.Unknown : registrar.GetCurrentServerRole();
	    }

        private volatile bool _disposed;
        private readonly ReaderWriterLockSlim _disposalLocker = new ReaderWriterLockSlim();

        /// &lt;summary&gt;
        /// This will dispose and reset all resources used to run the application
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// IMPORTANT: Never dispose this object if you require the Umbraco application to run, disposing this object
        /// is generally used for unit testing and when your application is shutting down after you have booted Umbraco.
        /// &lt;/remarks&gt;
        void IDisposable.Dispose()
        {
            // Only operate if we haven&#39;t already disposed
            if (_disposed) return;

            using (new WriteLock(_disposalLocker))
            {
                // Check again now we&#39;re inside the lock
                if (_disposed) return;

                //clear the cache
                if (ApplicationCache != null)
                {
                    ApplicationCache.RuntimeCache.ClearAllCache();
                    ApplicationCache.IsolatedRuntimeCache.ClearAllCaches();
                }
                //reset all resolvers
                ResolverCollection.ResetAll();
                //reset resolution itself (though this should be taken care of by resetting any of the resolvers above)
                Resolution.Reset();
                
                //reset the instance objects
                this.ApplicationCache = null;
                if (_databaseContext != null) //need to check the internal field here
                {
                    if (DatabaseContext.IsDatabaseConfigured &amp;&amp; DatabaseContext.Database != null)
                    {
                        DatabaseContext.Database.Dispose();       
                    }                    
                }
                this.DatabaseContext = null;
                this.Services = null;
                this._isReady = false; //set the internal field
                
                // Indicate that the instance has been disposed.
                _disposed = true;
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,135,1],[31,6,31,7,1],[32,13,32,35,1],[32,36,32,81,0],[33,13,33,40,1],[33,41,33,91,0],[34,13,34,31,1],[34,32,34,73,0],[35,13,35,32,1],[35,33,35,75,0],[36,13,36,42,1],[37,13,37,40,1],[38,13,38,38,1],[39,13,39,38,1],[41,13,41,20,1],[42,6,42,7,1],[52,15,53,103,0],[54,9,54,10,0],[55,9,55,10,0],[62,9,62,53,0],[63,9,63,10,0],[64,13,64,31,0],[64,32,64,73,0],[65,13,65,38,0],[66,13,66,117,0],[67,13,67,20,0],[68,9,68,10,0],[75,6,75,74,1],[76,9,76,10,1],[77,10,77,28,1],[77,29,77,70,0],[78,10,78,29,1],[78,30,78,72,0],[79,10,79,35,1],[80,10,80,35,1],[81,13,81,20,1],[82,9,82,10,1],[96,6,96,7,1],[97,13,97,33,1],[98,13,98,14,1],[99,17,99,37,1],[100,21,100,36,1],[101,13,101,14,1],[102,13,102,34,1],[103,13,103,28,1],[104,6,104,7,1],[122,9,122,10,0],[123,13,123,33,0],[124,13,124,14,0],[125,17,125,37,0],[126,21,126,36,0],[127,13,127,14,0],[128,13,128,80,0],[129,13,129,27,0],[130,13,130,28,0],[131,9,131,10,0],[149,9,149,10,0],[150,13,150,33,0],[151,13,151,14,0],[152,17,152,37,0],[153,21,153,36,0],[154,13,154,14,0],[155,13,155,88,0],[156,13,156,27,0],[157,13,157,28,0],[158,9,158,10,0],[163,49,163,53,1],[163,54,163,67,1],[171,41,171,45,1],[171,46,171,58,1],[177,50,177,54,1],[177,55,177,67,1],[182,9,182,31,1],[182,9,182,31,1],[182,9,182,31,0],[183,3,183,81,1],[183,3,183,81,0],[183,3,183,81,1],[190,13,190,14,1],[191,17,191,33,1],[192,13,192,14,1],[194,13,194,14,1],[195,17,195,36,1],[196,17,196,34,1],[197,5,197,25,1],[198,13,198,14,1],[202,3,202,4,0],[203,4,203,53,0],[204,3,204,4,0],[215,17,215,18,1],[215,19,215,44,1],[215,45,215,46,1],[224,13,224,14,0],[225,17,227,61,0],[228,17,228,18,0],[229,21,229,81,0],[230,21,230,60,0],[230,61,230,73,0],[231,17,231,18,0],[233,17,233,30,0],[234,13,234,14,0],[262,13,262,14,1],[263,17,263,65,1],[264,17,264,47,1],[265,13,265,14,1],[272,36,272,40,1],[272,41,272,53,1],[275,3,275,4,1],[276,13,276,59,1],[277,13,277,31,1],[280,13,281,13,1],[281,13,281,14,1],[281,14,283,17,1],[283,17,283,18,1],[283,18,284,21,1],[284,21,284,60,1],[284,60,285,21,1],[285,21,285,78,1],[285,78,287,21,1],[287,21,291,59,1],[291,59,293,21,1],[293,21,293,28,1],[293,28,294,21,1],[294,21,294,22,1],[294,22,297,25,1],[297,25,297,96,1],[297,96,298,25,1],[298,25,298,26,1],[298,26,299,29,1],[299,29,299,156,1],[299,156,300,29,1],[300,29,300,47,1],[300,47,301,29,1],[301,29,301,30,1],[301,30,304,33,1],[304,33,304,225,1],[304,225,305,33,1],[305,33,305,44,1],[305,44,306,29,1],[306,29,306,30,1],[306,30,307,25,1],[307,25,307,26,1],[307,26,308,21,1],[308,21,308,22,1],[308,22,310,21,1],[310,21,310,22,1],[310,22,311,25,1],[311,25,311,197,1],[311,197,312,21,1],[312,21,312,22,1],[312,22,314,21,1],[314,21,314,31,1],[314,31,316,17,1],[316,17,316,37,1],[316,37,317,17,1],[317,17,317,18,1],[317,18,318,21,1],[318,21,318,128,1],[318,128,319,21,1],[319,21,319,34,1],[319,34,322,13,1],[322,13,322,14,1],[322,14,322,16,1],[280,13,322,16,1],[323,3,323,4,1],[328,4,328,5,1],[330,5,330,6,1],[331,6,331,76,1],[333,5,333,10,0],[334,5,334,6,0],[335,6,335,26,0],[337,4,337,5,1],[341,9,341,10,1],[342,13,342,30,1],[343,17,343,89,0],[344,9,344,10,1],[355,4,355,5,1],[356,5,356,34,1],[357,6,357,108,1],[358,5,358,29,1],[359,4,359,5,1],[360,17,360,18,1],[360,19,360,44,1],[360,45,360,46,1],[372,4,372,5,1],[373,5,373,27,1],[374,6,374,107,0],[375,5,375,22,1],[376,4,376,5,1],[377,17,377,18,1],[377,19,377,37,1],[377,38,377,39,1],[381,6,381,7,0],[382,10,382,89,0],[383,13,383,94,0],[384,6,384,7,0],[387,9,387,92,0],[387,9,387,92,1],[387,9,387,92,1],[397,9,397,10,1],[399,13,399,27,1],[399,28,399,35,0],[401,13,401,51,1],[402,13,402,14,1],[404,17,404,31,1],[404,32,404,39,0],[407,17,407,46,1],[408,17,408,18,1],[409,21,409,67,1],[410,21,410,76,1],[411,17,411,18,1],[413,17,413,47,1],[415,17,415,36,1],[418,17,418,46,1],[419,17,419,46,1],[420,17,420,18,1],[421,21,421,98,1],[422,21,422,22,1],[423,25,423,60,1],[424,21,424,22,1],[425,17,425,18,1],[426,17,426,45,1],[427,17,427,38,1],[428,17,428,39,1],[431,17,431,34,1],[432,13,432,14,1],[433,9,433,10,1]]);
    </script>
  </body>
</html>