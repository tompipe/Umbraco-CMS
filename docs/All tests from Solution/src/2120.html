<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Manifest\ManifestWatcher.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Web;
using Umbraco.Core.Logging;

namespace Umbraco.Core.Manifest
{
    internal class ManifestWatcher : DisposableObject
    {
        private readonly ILogger _logger;
        private readonly List&lt;FileSystemWatcher&gt; _fws = new List&lt;FileSystemWatcher&gt;();
        private static volatile bool _isRestarting = false;
        private static readonly object Locker = new object();

        public ManifestWatcher(ILogger logger)
        {
            if (logger == null) throw new ArgumentNullException(&quot;logger&quot;);
            _logger = logger;
        }

        public void Start(params string[] packageFolders)
        {
            foreach (var packageFolder in packageFolders)
            {
                if (Directory.Exists(packageFolder) &amp;&amp; File.Exists(Path.Combine(packageFolder, &quot;package.manifest&quot;)))
                {
                    //NOTE: for some reason *.manifest doesn&#39;t work!
                    var fsw = new FileSystemWatcher(packageFolder, &quot;*package.*&quot;)
                    {
                        IncludeSubdirectories = false,
                        NotifyFilter = NotifyFilters.LastAccess | NotifyFilters.LastWrite 
                    };
                    _fws.Add(fsw);
                    fsw.Changed += FswChanged;
                    fsw.EnableRaisingEvents = true;
                }
            }
        }

        void FswChanged(object sender, FileSystemEventArgs e)
        {
            if (e.Name.InvariantContains(&quot;package.manifest&quot;))
            {
                //Ensure the app is not restarted multiple times for multiple saving during the same app domain execution
                if (_isRestarting == false)
                {
                    lock (Locker)
                    {
                        if (_isRestarting == false)
                        {
                            _isRestarting = true;

                            _logger.Info&lt;ManifestWatcher&gt;(&quot;manifest has changed, app pool is restarting (&quot; + e.FullPath + &quot;)&quot;);
                            HttpRuntime.UnloadAppDomain();
                            Dispose();               
                        }
                    }
                }                
            }
        }

        protected override void DisposeResources()
        {
            foreach (var fw in _fws)
            {
                fw.Dispose();
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,9,12,87,0],[13,9,13,60,0],[14,9,14,62,0],[16,9,16,47,0],[17,9,17,10,0],[18,13,18,32,0],[18,33,18,75,0],[19,13,19,30,0],[20,9,20,10,0],[23,9,23,10,0],[24,13,24,20,0],[24,22,24,39,0],[24,40,24,42,0],[24,43,24,57,0],[25,13,25,14,0],[26,17,26,117,0],[27,17,27,18,0],[29,21,33,23,0],[34,21,34,35,0],[35,21,35,47,0],[36,21,36,52,0],[37,17,37,18,0],[38,13,38,14,0],[39,9,39,10,0],[42,9,42,10,0],[43,13,43,62,0],[44,13,44,14,0],[46,17,46,44,0],[47,17,47,18,0],[48,21,48,34,0],[49,21,49,22,0],[50,25,50,52,0],[51,25,51,26,0],[52,29,52,50,0],[54,29,54,128,0],[55,29,55,59,0],[56,29,56,39,0],[57,25,57,26,0],[58,21,58,22,0],[59,17,59,18,0],[60,13,60,14,0],[61,9,61,10,0],[64,9,64,10,0],[65,13,65,20,0],[65,22,65,28,0],[65,29,65,31,0],[65,32,65,36,0],[66,13,66,14,0],[67,17,67,30,0],[68,13,68,14,0],[69,9,69,10,0]]);
    </script>
  </body>
</html>