<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\tinyMCE3\webcontrol\plugin\JSONReader.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * $Id: JSONReader.cs 439 2007-11-26 13:26:10Z spocke $
 *
 * Copyright ï¿½ 2007, Moxiecode Systems AB, All rights reserved. 
 */

using System;
using System.IO;
using System.Text;
using System.Collections;

namespace umbraco.editorControls.tinyMCE3.webcontrol.plugin
{
    /// &lt;summary&gt;
	/// 
	/// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public enum JSONToken
    {
		/// &lt;summary&gt; &lt;/summary&gt;
		Boolean,

		/// &lt;summary&gt; &lt;/summary&gt;
		Integer,

		/// &lt;summary&gt; &lt;/summary&gt;
		String,

		/// &lt;summary&gt; &lt;/summary&gt;
		Null,

		/// &lt;summary&gt; &lt;/summary&gt;
		Float,

		/// &lt;summary&gt; &lt;/summary&gt;
		StartArray,

		/// &lt;summary&gt; &lt;/summary&gt;
		EndArray,

		/// &lt;summary&gt; &lt;/summary&gt;
		PropertyName,

		/// &lt;summary&gt; &lt;/summary&gt;
		StartObject,

		/// &lt;summary&gt; &lt;/summary&gt;
		EndObject
	}

	/// &lt;summary&gt;
	///  Description of JSONReader.
	/// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class JSONReader
    {
		private TextReader reader;
		private JSONToken token;
		private object val;
		private JSONLocation location;
		private Stack lastLocations;
		private bool needProp;

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;reader&quot;&gt;&lt;/param&gt;
		public JSONReader(TextReader reader) {
			this.reader = reader;
			this.val = null;
			this.token = JSONToken.Null;
			this.location = JSONLocation.Normal;
			this.lastLocations = new Stack();
			this.needProp = false;
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public JSONLocation Location {
			get { return location; }
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public JSONToken TokenType {
			get {
				return this.token;
			}
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		public object Value {
			get {
				return this.val;
			}
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public bool Read() {
			int chr = this.reader.Read();

			if (chr != -1) {
				switch ((char) chr) {
					case &#39;[&#39;:
						this.lastLocations.Push(this.location);
						this.location = JSONLocation.InArray;
						this.token = JSONToken.StartArray;
						this.val = null;
						this.ReadAway();
						return true;

					case &#39;]&#39;:
						this.location = (JSONLocation) this.lastLocations.Pop();
						this.token = JSONToken.EndArray;
						this.val = null;
						this.ReadAway();

						if (this.location == JSONLocation.InObject)
							this.needProp = true;

						return true;

					case &#39;{&#39;:
						this.lastLocations.Push(this.location);
						this.location = JSONLocation.InObject;
						this.needProp = true;
						this.token = JSONToken.StartObject;
						this.val = null;
						this.ReadAway();
						return true;

					case &#39;}&#39;:
						this.location = (JSONLocation) this.lastLocations.Pop();
						this.token = JSONToken.EndObject;
						this.val = null;
						this.ReadAway();

						if (this.location == JSONLocation.InObject)
							this.needProp = true;

						return true;

					// String
					case &#39;&quot;&#39;:
					case &#39;\&#39;&#39;:
						return this.ReadString((char) chr);

					// Null
					case &#39;n&#39;:
						return this.ReadNull();

					// Bool
					case &#39;t&#39;:
					case &#39;f&#39;:
						return this.ReadBool((char) chr);

					default:
						// Is number
						if (Char.IsNumber((char) chr) || (char) chr == &#39;-&#39; || (char) chr == &#39;.&#39;)
							return this.ReadNumber((char) chr);

						return true;
				}
			}

			return false;
		}

		/// &lt;summary&gt;
		/// 
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public override string ToString() {
			switch (this.token) {
				case JSONToken.Boolean:
					return &quot;[Boolean] = &quot; + ((bool) this.Value ? &quot;true&quot; : &quot;false&quot;);

				case JSONToken.EndArray:
					return &quot;[EndArray]&quot;;

				case JSONToken.EndObject:
					return &quot;[EndObject]&quot;;

				case JSONToken.Float:
					return &quot;[Float] = &quot; + Convert.ToDouble(this.Value);

				case JSONToken.Integer:
					return &quot;[Integer] = &quot; + ((int) this.Value);

				case JSONToken.Null:
					return &quot;[Null]&quot;;

				case JSONToken.StartArray:
					return &quot;[StartArray]&quot;;

				case JSONToken.StartObject:
					return &quot;[StartObject]&quot;;

				case JSONToken.String:
					return &quot;[String]&quot; + (string) this.Value;

				case JSONToken.PropertyName:
					return &quot;[PropertyName]&quot; + (string) this.Value;
			}

			return base.ToString();
		}
		
		#region private methods

		private bool ReadString(char quote) {
			StringBuilder buff = new StringBuilder();
			this.token = JSONToken.String;
			bool endString = false;
			int chr;

			while ((chr = this.reader.Peek()) != -1) {
				switch (chr) {
					case &#39;\\&#39;:
						// Read away slash
						chr = this.reader.Read();

						// Read escape code
						chr = this.reader.Read();
						switch (chr) {
								case &#39;t&#39;:
									buff.Append(&#39;\t&#39;);
									break;

								case &#39;b&#39;:
									buff.Append(&#39;\b&#39;);
									break;

								case &#39;f&#39;:
									buff.Append(&#39;\f&#39;);
									break;

								case &#39;r&#39;:
									buff.Append(&#39;\r&#39;);
									break;

								case &#39;n&#39;:
									buff.Append(&#39;\n&#39;);
									break;

								case &#39;u&#39;:
									buff.Append((char) Convert.ToInt32(ReadLen(4), 16));
									break;

								default:
									buff.Append((char) chr);
									break;
						}

						break;

						case &#39;\&#39;&#39;:
						case &#39;&quot;&#39;:
							if (chr == quote)
								endString = true;

							chr = this.reader.Read();
							if (chr != -1 &amp;&amp; chr != quote)
								buff.Append((char) chr);

							break;

						default:
							buff.Append((char) this.reader.Read());
							break;
				}

				// String terminated
				if (endString)
					break;
			}

			this.ReadAway();

			this.val = buff.ToString();

			// Needed a property
			if (this.needProp) {
				this.token = JSONToken.PropertyName;
				this.needProp = false;
				return true;
			}

			if (this.location == JSONLocation.InObject &amp;&amp; !this.needProp)
				this.needProp = true;

			return true;
		}

		private bool ReadNull() {
			this.token = JSONToken.Null;
			this.val = null;

			this.ReadAway(3); // ull
			this.ReadAway();

			if (this.location == JSONLocation.InObject &amp;&amp; !this.needProp)
				this.needProp = true;

			return true;
		}

		private bool ReadNumber(char start) {
			StringBuilder buff = new StringBuilder();
			int chr;
			bool isFloat = false;

			this.token = JSONToken.Integer;
			buff.Append(start);

			while ((chr = this.reader.Peek()) != -1) {
				if (Char.IsNumber((char) chr) || (char) chr == &#39;-&#39; || (char) chr == &#39;.&#39;) {
					if (((char) chr) == &#39;.&#39;)
						isFloat = true;

					buff.Append((char) this.reader.Read());
				} else
					break;
			}

			this.ReadAway();

			if (isFloat) {
				this.token = JSONToken.Float;
				this.val = Convert.ToDouble(buff.ToString().Replace(&#39;.&#39;, &#39;,&#39;));
			} else
				this.val = Convert.ToInt32(buff.ToString());

			if (this.location == JSONLocation.InObject &amp;&amp; !this.needProp)
				this.needProp = true;

			return true;
		}

		private bool ReadBool(char chr) {
			this.token = JSONToken.Boolean;
			this.val = chr == &#39;t&#39;;

			if (chr == &#39;t&#39;)
				this.ReadAway(3); // rue
			else
				this.ReadAway(4); // alse

			this.ReadAway();

			if (this.location == JSONLocation.InObject &amp;&amp; !this.needProp)
				this.needProp = true;

			return true;
		}

		private void ReadAway() {
			int chr;
			
			while ((chr = this.reader.Peek()) != -1) {
				if (chr != &#39;:&#39; &amp;&amp; chr != &#39;,&#39; &amp;&amp; !Char.IsWhiteSpace((char) chr))
					break;

				this.reader.Read();
			}
		}

		private string ReadLen(int num) {
			StringBuilder buff = new StringBuilder();
			int chr;

			for (int i=0; i&lt;num &amp;&amp; (chr = this.reader.Read()) != -1; i++)
				buff.Append((char) chr);

			return buff.ToString();
		}
		
		private void ReadAway(int num) {
			for (int i=0; i&lt;num &amp;&amp; this.reader.Read() != -1; i++) ;
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[68,3,68,39,0],[68,40,68,41,0],[69,4,69,25,0],[70,4,70,20,0],[71,4,71,32,0],[72,4,72,40,0],[73,4,73,37,0],[74,4,74,26,0],[75,3,75,4,0],[81,8,81,9,0],[81,10,81,26,0],[81,27,81,28,0],[88,8,88,9,0],[89,5,89,23,0],[90,4,90,5,0],[97,8,97,9,0],[98,5,98,21,0],[99,4,99,5,0],[106,22,106,23,0],[107,4,107,33,0],[109,4,109,18,0],[109,19,109,20,0],[110,5,110,24,0],[112,7,112,46,0],[113,7,113,44,0],[114,7,114,41,0],[115,7,115,23,0],[116,7,116,23,0],[117,7,117,19,0],[120,7,120,63,0],[121,7,121,39,0],[122,7,122,23,0],[123,7,123,23,0],[125,7,125,50,0],[126,8,126,29,0],[128,7,128,19,0],[131,7,131,46,0],[132,7,132,45,0],[133,7,133,28,0],[134,7,134,42,0],[135,7,135,23,0],[136,7,136,23,0],[137,7,137,19,0],[140,7,140,63,0],[141,7,141,40,0],[142,7,142,23,0],[143,7,143,23,0],[145,7,145,50,0],[146,8,146,29,0],[148,7,148,19,0],[153,7,153,42,0],[157,7,157,30,0],[162,7,162,40,0],[166,7,166,79,0],[167,8,167,43,0],[169,7,169,19,0],[173,4,173,17,0],[174,3,174,4,0],[180,37,180,38,0],[181,4,181,23,0],[183,6,183,69,0],[186,6,186,26,0],[189,6,189,27,0],[192,6,192,57,0],[195,6,195,49,0],[198,6,198,22,0],[201,6,201,28,0],[204,6,204,29,0],[207,6,207,46,0],[210,6,210,52,0],[213,4,213,27,0],[214,3,214,4,0],[218,39,218,40,0],[219,4,219,45,0],[220,4,220,34,0],[221,4,221,27,0],[224,4,224,44,0],[224,45,224,46,0],[225,5,225,17,0],[228,7,228,32,0],[231,7,231,32,0],[232,7,232,19,0],[234,10,234,28,0],[235,10,235,16,0],[238,10,238,28,0],[239,10,239,16,0],[242,10,242,28,0],[243,10,243,16,0],[246,10,246,28,0],[247,10,247,16,0],[250,10,250,28,0],[251,10,251,16,0],[254,10,254,62,0],[255,10,255,16,0],[258,10,258,34,0],[259,10,259,16,0],[262,7,262,13,0],[266,8,266,25,0],[267,9,267,26,0],[269,8,269,33,0],[270,8,270,38,0],[271,9,271,33,0],[273,8,273,14,0],[276,8,276,47,0],[277,8,277,14,0],[281,5,281,19,0],[282,6,282,12,0],[283,4,283,5,0],[285,4,285,20,0],[287,4,287,31,0],[290,4,290,22,0],[290,23,290,24,0],[291,5,291,41,0],[292,5,292,27,0],[293,5,293,17,0],[296,4,296,65,0],[297,5,297,26,0],[299,4,299,16,0],[300,3,300,4,0],[302,27,302,28,0],[303,4,303,32,0],[304,4,304,20,0],[306,4,306,21,0],[307,4,307,20,0],[309,4,309,65,0],[310,5,310,26,0],[312,4,312,16,0],[313,3,313,4,0],[315,39,315,40,0],[316,4,316,45,0],[318,4,318,25,0],[320,4,320,35,0],[321,4,321,23,0],[323,4,323,44,0],[323,45,323,46,0],[324,5,324,77,0],[324,78,324,79,0],[325,6,325,30,0],[326,7,326,22,0],[328,6,328,45,0],[329,5,329,6,0],[330,6,330,12,0],[331,4,331,5,0],[333,4,333,20,0],[335,4,335,16,0],[335,17,335,18,0],[336,5,336,34,0],[337,5,337,68,0],[338,4,338,5,0],[339,5,339,49,0],[341,4,341,65,0],[342,5,342,26,0],[344,4,344,16,0],[345,3,345,4,0],[347,35,347,36,0],[348,4,348,35,0],[349,4,349,26,0],[351,4,351,19,0],[352,5,352,22,0],[354,5,354,22,0],[356,4,356,20,0],[358,4,358,65,0],[359,5,359,26,0],[361,4,361,16,0],[362,3,362,4,0],[364,27,364,28,0],[367,4,367,44,0],[367,45,367,46,0],[368,5,368,68,0],[369,6,369,12,0],[371,5,371,24,0],[372,4,372,5,0],[373,3,373,4,0],[375,35,375,36,0],[376,4,376,45,0],[379,9,379,16,0],[379,18,379,59,0],[379,61,379,64,0],[380,5,380,29,0],[382,4,382,27,0],[383,3,383,4,0],[385,34,385,35,0],[386,9,386,16,0],[386,18,386,51,0],[386,53,386,56,0],[386,58,386,59,0],[387,3,387,4,0]]);
    </script>
  </body>
</html>