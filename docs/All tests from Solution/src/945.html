<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Routing\ContentFinderByNotFoundHandlers.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using Umbraco.Core.Logging;
using umbraco.interfaces;

namespace Umbraco.Web.Routing
{
	/// &lt;summary&gt;
	/// Provides an implementation of &lt;see cref=&quot;IContentFinder&quot;/&gt; that runs legacy &lt;c&gt;INotFoundHandler&lt;/c&gt;.
	/// &lt;/summary&gt;
    public class ContentFinderByNotFoundHandlers : IContentFinder
    {
		// notes
		//
		// at the moment we load the legacy INotFoundHandler
		// excluding those that have been replaced by proper finders,
		// and run them.

		/// &lt;summary&gt;
		/// Tries to find and assign an Umbraco document to a &lt;c&gt;PublishedContentRequest&lt;/c&gt;.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;docRequest&quot;&gt;The &lt;c&gt;PublishedContentRequest&lt;/c&gt;.&lt;/param&gt;
		/// &lt;returns&gt;A value indicating whether an Umbraco document was found and assigned.&lt;/returns&gt;
		public bool TryFindContent(PublishedContentRequest docRequest)
        {
			HandlePageNotFound(docRequest);
            return docRequest.HasPublishedContent;
        }

		#region Copied over and adapted from presentation.requestHandler

		private static void HandlePageNotFound(PublishedContentRequest docRequest)
        {			
			var url = NotFoundHandlerHelper.GetLegacyUrlForNotFoundHandlers();
            LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Running for legacy url=&#39;{0}&#39;.&quot;, () =&gt; url);

            foreach (var handler in NotFoundHandlerHelper.GetNotFoundHandlers())
            {
                var handlerName = handler.GetType().FullName;
                LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39;.&quot;, () =&gt; handlerName);

                var finder = NotFoundHandlerHelper.SubsituteFinder(handler);
                if (finder != null)
                {
                    var finderName = finder.GetType().FullName;
                    LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Replace handler &#39;{0}&#39; by new finder &#39;{1}&#39;.&quot;, () =&gt; handlerName, () =&gt; finderName);

                    // can&#39;t find a document =&gt; continue with other handlers
                    if (finder.TryFindContent(docRequest) == false)
                        continue;

                    // found a document =&gt; break, don&#39;t run other handlers, we&#39;re done

                    // in theory an IContentFinder can return true yet set no document
                    // but none of the substitued finders (see SubstituteFinder) do it.

                    // do NOT set docRequest.PublishedContent again here
                    // as it would clear any template that the finder might have set

                    LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Finder &#39;{0}&#39; found node with id={1}.&quot;, () =&gt; finderName, () =&gt; docRequest.PublishedContent.Id);
                    if (docRequest.Is404)
                        LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Finder &#39;{0}&#39; set status to 404.&quot;, () =&gt; finderName);

                    LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39; found valid node with id={1}.&quot;, () =&gt; handlerName, () =&gt; docRequest.PublishedContent.Id);
                    break;
                }

                // else it&#39;s a legacy handler: run

                // can&#39;t find a document =&gt; continue with other handlers
                if (handler.Execute(url) == false || handler.redirectID &lt;= 0)
                    continue;

                // found a document ID =&gt; ensure it&#39;s a valid document
                var redirectId = handler.redirectID;
                docRequest.PublishedContent = docRequest.RoutingContext.UmbracoContext.ContentCache.GetById(redirectId);

                if (docRequest.HasPublishedContent == false)
                {
                    // the handler said it could handle the url, and returned a content ID
                    // yet that content ID is invalid... should we run the other handlers?
                    // I don&#39;t think so, not here, let the &quot;last chance&quot; finder take care.
                    // so, break.

                    LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39; found node with id={1} which is not valid.&quot;, () =&gt; handlerName, () =&gt; redirectId);
                    break;
                }

                // found a valid document =&gt; break, don&#39;t run other handlers, we&#39;re done

                LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39; found valid node with id={1}.&quot;, () =&gt; handlerName, () =&gt; redirectId);

                if (docRequest.RoutingContext.UmbracoContext.HttpContext.Response.StatusCode == 404)
                {
                    LogHelper.Debug&lt;ContentFinderByNotFoundHandlers&gt;(&quot;Handler &#39;{0}&#39; set status code to 404.&quot;, () =&gt; handlerName);
                    docRequest.Is404 = true;
                }

                break;
            }
        }

		#endregion
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,0],[26,4,26,35,0],[27,13,27,51,0],[28,9,28,10,0],[33,9,33,10,0],[34,4,34,70,0],[35,13,35,101,0],[35,101,35,104,0],[35,104,35,106,0],[35,13,35,106,0],[37,13,37,20,0],[37,22,37,33,0],[37,34,37,36,0],[37,37,37,80,0],[38,13,38,14,0],[39,17,39,62,0],[40,17,40,90,0],[40,90,40,101,0],[40,101,40,103,0],[40,17,40,103,0],[42,17,42,77,0],[43,17,43,36,0],[44,17,44,18,0],[45,21,45,64,0],[46,21,46,122,0],[46,122,46,133,0],[46,133,46,141,0],[46,141,46,151,0],[46,151,46,153,0],[46,21,46,153,0],[49,21,49,68,0],[50,25,50,34,0],[60,21,60,116,0],[60,116,60,126,0],[60,126,60,134,0],[60,134,60,164,0],[60,164,60,166,0],[60,21,60,166,0],[61,21,61,42,0],[62,25,62,115,0],[62,115,62,125,0],[62,125,62,127,0],[62,25,62,127,0],[64,21,64,123,0],[64,123,64,134,0],[64,134,64,142,0],[64,142,64,172,0],[64,172,64,174,0],[64,21,64,174,0],[65,21,65,27,0],[71,17,71,78,0],[72,21,72,30,0],[75,17,75,53,0],[76,17,76,121,0],[78,17,78,61,0],[79,17,79,18,0],[85,21,85,136,0],[85,136,85,147,0],[85,147,85,155,0],[85,155,85,165,0],[85,165,85,167,0],[85,21,85,167,0],[86,21,86,27,0],[91,17,91,119,0],[91,119,91,130,0],[91,130,91,138,0],[91,138,91,148,0],[91,148,91,150,0],[91,17,91,150,0],[93,17,93,101,0],[94,17,94,18,0],[95,21,95,117,0],[95,117,95,128,0],[95,128,95,130,0],[95,21,95,130,0],[96,21,96,45,0],[97,17,97,18,0],[99,17,99,23,0],[101,9,101,10,0]]);
    </script>
  </body>
</html>