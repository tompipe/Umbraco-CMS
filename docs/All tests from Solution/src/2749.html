<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\PickerRelations\PickerRelationsDataEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.UI;
using System.Web.UI.WebControls;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.datatype; // DefaultData
using umbraco.cms.businesslogic.property; // Property
using umbraco.cms.businesslogic.relation; // RelationType
using umbraco.interfaces; // IDataEditor
using UmbracoContent = umbraco.cms.businesslogic.Content; // UmbracoContent defined here so as to differentiate with System.Web.UI.WebControls.Content

namespace umbraco.editorControls.PickerRelations
{
    /// &lt;summary&gt;
    /// 
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class PickerRelationsDataEditor : CompositeControl, IDataEditor
    {
        /// &lt;summary&gt;
        /// value stored by a datatype instance
        /// &lt;/summary&gt;
        private IData data;

        /// &lt;summary&gt;
        /// configuration options for this datatype, as defined by the PreValueEditor
        /// &lt;/summary&gt;
        private PickerRelationsOptions options;

        /// &lt;summary&gt;
        /// Literal used to render status (Enabled || Disabled)
        /// this datatype is only enabled and active if it can find the property alias on the current node (as defined in PreValueEditor) and 
        /// the relation type parent object type (or child if reverse index used) matches the object type of the current node which this datatype is on
        /// &lt;/summary&gt;
        private Literal statusLiteral = new Literal();


		private Literal jsLiteral = new Literal();

        /// &lt;summary&gt;
        /// Gets a value indicating whether this is an RTE - this Property expected by Umbraco
        /// &lt;/summary&gt;
        public virtual bool TreatAsRichTextEditor 
        { 
            get { return false; } 
        }

        /// &lt;summary&gt;
        /// Gets a value indicating whether the label should be shown when editing - this Property exected by Umbraco
        /// &lt;/summary&gt;
        public virtual bool ShowLabel 
        { 
            get { return true; } 
        }

        /// &lt;summary&gt;
        /// Gets the DataEditor - Property expected by Umbraco
        /// &lt;/summary&gt;
        public Control Editor { get { return this; } }

        /// &lt;summary&gt;
        /// Gets the id of the current (content || media || member) node on which this datatype is a property
        /// &lt;/summary&gt;
        private int CurrentContentId
        {
            get
            {
                return ((umbraco.cms.businesslogic.datatype.DefaultData)this.data).NodeId;
            }
        }

        /// &lt;summary&gt;
        /// Gets the UmbracoObjectType on which this datatype is a property of
        /// &lt;/summary&gt;
        private uQuery.UmbracoObjectType CurrentContextObjectType
        {
            get
            {
                using (var sqlHelper = Application.SqlHelper)
                {
                    var guid = sqlHelper.ExecuteScalar&lt;Guid&gt;(
                        &quot;SELECT nodeObjectType FROM umbracoNode WHERE id = @id&quot;,
                        sqlHelper.CreateParameter(&quot;@id&quot;, this.CurrentContentId));
                    return uQuery.GetUmbracoObjectType(guid);
                }
            }
        }

        /////// NOT CURRENTLY USED, BUT MIGHT BE USEFUL TO MARK BIDIRECTIONAL RELATIONS
        /////// &lt;summary&gt;
        /////// string to identify a particular instance of this datatype
        /////// &lt;/summary&gt;
        ////private string InstanceIdentifier
        ////{
        ////    get
        ////    {
        ////        Property pickerRelationsProperty = new Property(((DefaultData)this.data).PropertyId);
        ////        return &quot;[&quot; + pickerRelationsProperty.PropertyType.Id.ToString() + &quot;]&quot;;
        ////    }
        ////}

        /// &lt;summary&gt;
        /// Initializes a new instance of PickerRelationsDataEditor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;data&quot;&gt;data stored by this instance of this datatype (not currently used)&lt;/param&gt;
        /// &lt;param name=&quot;options&quot;&gt;configuration options for this datatype as set by the PreValueEditor&lt;/param&gt;
        internal PickerRelationsDataEditor(IData data, PickerRelationsOptions options)
        {
            this.data = data;
            this.options = options;
        }

        /// &lt;summary&gt;
        /// Creates the child controls
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
			this.statusLiteral.ID = &quot;pickerRelations&quot;;
            this.Controls.Add(this.statusLiteral); // displays if this datatype is valid in this context, and if so, which pickerProperty and relationtype it wires up			
			this.Controls.Add(this.jsLiteral);
        }

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
            this.EnsureChildControls();

			this.statusLiteral.Text = &quot;&lt;span id=\&quot;&quot; + this.statusLiteral.ClientID + &quot;\&quot;&gt;&quot;;

            try
            {
                this.statusLiteral.Text += &quot;Mapping: &quot; + this.GetMappingDetails();
            }
            catch(Exception ex) 
            {
                this.statusLiteral.Text += &quot;Error: &quot; + ex.Message;
            }

			this.statusLiteral.Text += &quot;&lt;/span&gt;&quot;;

			if (this.options.HideDataEditor)
			{
				this.jsLiteral.Text = @&quot;
				&lt;script type=&quot;&quot;text/javascript&quot;&quot;&gt;
					jQuery(document).ready(function () {
						jQuery(&#39;span#&quot; + this.statusLiteral.ClientID + @&quot;&#39;).parents(&#39;div.propertypane&#39;).first().hide();
					});
				&lt;/script&gt;&quot;;
			}
        }

        /// &lt;summary&gt;
        /// Called by Umbraco when saving the node, this datatype doens&#39;t do anythign here, but with an event handler instead,
        /// as needs to know the saved values of a sibling pickerProperty
        /// &lt;/summary&gt;
        public void Save()
        {
        }

        /// &lt;summary&gt;
        /// returns a string &quot;Property &#39;[propertyAlias]&#39; with RelationType &#39;[relationTypeName]&quot;
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private string GetMappingDetails()
        {
            string mappingDetails = string.Empty;

            UmbracoContent currentContentNode = new UmbracoContent(this.CurrentContentId);
            Property pickerProperty = currentContentNode.getProperty(this.options.PropertyAlias);

            if (pickerProperty != null)
            {
                RelationType relationType = new RelationType(this.options.RelationTypeId); // Does it still exist ? TODO: check

                if (this.IsContextUmbracoObjectTypeValid(this.CurrentContextObjectType, relationType))
                {
                    mappingDetails = &quot;Property &#39;&lt;strong&gt;&quot; + pickerProperty.PropertyType.Name + &quot;&lt;/strong&gt;&#39; with &quot; + 
                                     &quot;Relation Type &#39;&lt;strong&gt;&quot; + relationType.Name + &quot;&lt;/strong&gt;&#39;&quot;;

                    if(this.options.ReverseIndexing)
                    {
                        mappingDetails += &quot; &lt;i&gt;(Reverse Index)&lt;/i&gt;&quot;;
                    }
                }
                else
                {
                    throw new Exception(&quot;Conflict with this Content Object Type and that expected by the Relation Type &#39;&quot; + relationType.Name  + &quot;&#39;&quot;);
                }
            }
            else
            {
                throw new Exception(&quot;Can&#39;t find a Property with the Alias &#39;&quot; + this.options.PropertyAlias + &quot;&#39;&quot;);
            }

            return mappingDetails;
        }

        /// &lt;summary&gt;
        /// returns the UmbracoObjectType associated as defined by the supplied relation type, and if reverse indexing has been enabled
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;relationType&quot;&gt;associated RealationType&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public uQuery.UmbracoObjectType GetPickerUmbracoObjectType(RelationType relationType)
        {
            uQuery.UmbracoObjectType pickerUmbracoObjectType = uQuery.UmbracoObjectType.Unknown;

            if (!relationType.Dual &amp;&amp; this.options.ReverseIndexing)
            {
                pickerUmbracoObjectType = relationType.GetParentUmbracoObjectType();
            }
            else
            {
                pickerUmbracoObjectType = relationType.GetChildUmbracoObjectType();
            }

            return pickerUmbracoObjectType;
        }

		/// &lt;summary&gt;
		/// Check to see if the content id side of the relation type is valid (doesn&#39;t check the node picker id side)
		/// &lt;/summary&gt;
        /// &lt;param name=&quot;contextUmbracoObjectType&quot;&gt;Type of the content object (content/ media or member)&lt;/param&gt;
		/// &lt;param name=&quot;relationType&quot;&gt;Type of the relation.&lt;/param&gt;
		/// &lt;returns&gt;
		/// 	&lt;c&gt;true&lt;/c&gt; if [is content object type valid] [the specified content object type]; otherwise, &lt;c&gt;false&lt;/c&gt;.
		/// &lt;/returns&gt;
        public bool IsContextUmbracoObjectTypeValid(uQuery.UmbracoObjectType contextUmbracoObjectType, RelationType relationType)
        {
            bool isContextObjectTypeValid = false;

            if (!relationType.Dual &amp;&amp; this.options.ReverseIndexing)
            {
                // expects the current context to be the child in the relation
                if (contextUmbracoObjectType == relationType.GetChildUmbracoObjectType())
                {
                    isContextObjectTypeValid = true;
                }
            }
            else
            {
                // expects the current context to be the parent in the relation
                if (contextUmbracoObjectType == relationType.GetParentUmbracoObjectType())
                {
                    isContextObjectTypeValid = true;
                }
            }

            return isContextObjectTypeValid;
        }
    }        
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[36,9,36,55,0],[39,3,39,45,0],[46,17,46,18,0],[46,19,46,32,0],[46,33,46,34,0],[54,17,54,18,0],[54,19,54,31,0],[54,32,54,33,0],[60,37,60,38,0],[60,39,60,51,0],[60,52,60,53,0],[68,13,68,14,0],[69,17,69,91,0],[70,13,70,14,0],[79,13,79,14,0],[80,24,80,61,0],[81,17,81,18,0],[82,21,84,82,0],[85,21,85,62,0],[87,13,87,14,0],[108,9,108,87,0],[109,9,109,10,0],[110,13,110,30,0],[111,13,111,36,0],[112,9,112,10,0],[118,9,118,10,0],[119,4,119,46,0],[120,13,120,51,0],[121,4,121,38,0],[122,9,122,10,0],[129,9,129,10,0],[130,13,130,28,0],[131,13,131,40,0],[133,4,133,82,0],[136,13,136,14,0],[137,17,137,83,0],[138,13,138,14,0],[139,13,139,32,0],[140,13,140,14,0],[141,17,141,67,0],[142,13,142,14,0],[144,4,144,41,0],[146,4,146,36,0],[147,4,147,5,0],[148,5,153,16,0],[154,4,154,5,0],[155,9,155,10,0],[162,9,162,10,0],[163,9,163,10,0],[170,9,170,10,0],[171,13,171,50,0],[173,13,173,91,0],[174,13,174,98,0],[176,13,176,40,0],[177,13,177,14,0],[178,17,178,91,0],[180,17,180,103,0],[181,17,181,18,0],[182,21,183,99,0],[185,21,185,53,0],[186,21,186,22,0],[187,25,187,69,0],[188,21,188,22,0],[189,17,189,18,0],[191,17,191,18,0],[192,21,192,151,0],[194,13,194,14,0],[196,13,196,14,0],[197,17,197,114,0],[200,13,200,35,0],[201,9,201,10,0],[209,9,209,10,0],[210,13,210,97,0],[212,13,212,68,0],[213,13,213,14,0],[214,17,214,85,0],[215,13,215,14,0],[217,13,217,14,0],[218,17,218,84,0],[219,13,219,14,0],[221,13,221,44,0],[222,9,222,10,0],[233,9,233,10,0],[234,13,234,51,0],[236,13,236,68,0],[237,13,237,14,0],[239,17,239,90,0],[240,17,240,18,0],[241,21,241,53,0],[242,17,242,18,0],[243,13,243,14,0],[245,13,245,14,0],[247,17,247,91,0],[248,17,248,18,0],[249,21,249,53,0],[250,17,250,18,0],[251,13,251,14,0],[253,13,253,45,0],[254,9,254,10,0]]);
    </script>
  </body>
</html>