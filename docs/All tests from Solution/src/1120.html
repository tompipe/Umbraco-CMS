<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\FilePermissionHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.IO;
using Umbraco.Core.IO;
using umbraco;

namespace Umbraco.Web.Install
{
    internal class FilePermissionHelper
    {
        internal static readonly string[] PermissionDirs = { SystemDirectories.Css, SystemDirectories.Config, SystemDirectories.Data, SystemDirectories.Media, SystemDirectories.Masterpages, SystemDirectories.Xslt, SystemDirectories.UserControls, SystemDirectories.Preview };
        internal static readonly string[] PermissionFiles = { };
        internal static readonly string[] PackagesPermissionsDirs = { SystemDirectories.Bin, SystemDirectories.Umbraco, SystemDirectories.UserControls, SystemDirectories.Packages };

        public static bool RunFilePermissionTestSuite(out Dictionary&lt;string, List&lt;string&gt;&gt; errorReport)
        {
            errorReport = new Dictionary&lt;string, List&lt;string&gt;&gt;();

            List&lt;string&gt; errors;

            if (TestDirectories(PermissionDirs, out errors) == false)
                errorReport[&quot;Folder creation failed&quot;] = errors.ToList();

            if (TestDirectories(PackagesPermissionsDirs, out errors) == false)
                errorReport[&quot;File writing for packages failed&quot;] = errors.ToList();

            if (TestFiles(PermissionFiles, out errors) == false)
                errorReport[&quot;File writing failed&quot;] = errors.ToList();

            if (TestContentXml(out errors) == false)
                errorReport[&quot;Cache file writing failed&quot;] = errors.ToList();

            if (TestFolderCreation(SystemDirectories.Media, out errors) == false)
                errorReport[&quot;Media folder creation failed&quot;] = errors.ToList();

            return errorReport.Any() == false;
        }

        public static bool TestDirectories(string[] directories, out List&lt;string&gt; errorReport)
        {
            errorReport = new List&lt;string&gt;();
            bool succes = true;
            foreach (string dir in directories)
            {
                if (Directory.Exists(dir) == false) continue;

                bool result = SaveAndDeleteFile(IOHelper.MapPath(dir + &quot;/configWizardPermissionTest.txt&quot;));

                if (result == false)
                {
                    succes = false;
                    errorReport.Add(dir);
                }
            }

            return succes;
        }

        public static bool TestFiles(string[] files, out List&lt;string&gt; errorReport)
        {
            errorReport = new List&lt;string&gt;();
            bool succes = true;
            foreach (string file in files)
            {
                bool result = OpenFileForWrite(IOHelper.MapPath(file));
                if (result == false)
                {
                    errorReport.Add(file);
                    succes = false;
                }
            }

            return succes;
        }

        public static bool TestFolderCreation(string folder, out List&lt;string&gt; errorReport)
        {
            errorReport = new List&lt;string&gt;();
            try
            {
                string tempDir = IOHelper.MapPath(folder + &quot;/testCreatedByConfigWizard&quot;);
                Directory.CreateDirectory(tempDir);
                Directory.Delete(tempDir);
                return true;
            }
            catch
            {
                errorReport.Add(folder);
                return false;
            }
        }

        public static bool TestContentXml(out List&lt;string&gt; errorReport)
        {
            errorReport = new List&lt;string&gt;();
            // Test creating/saving/deleting a file in the same location as the content xml file
            // NOTE: We cannot modify the xml file directly because a background thread is responsible for 
            // that and we might get lock issues.
            try
            {
                var xmlFile = content.GetUmbracoXmlDiskFileName() + &quot;.tmp&quot;;
                SaveAndDeleteFile(xmlFile);
                return true;
            }
            catch
            {
                errorReport.Add(SystemFiles.ContentCacheXml);
                return false;    
            }
        }

        private static bool SaveAndDeleteFile(string file)
        {
            try
            {
                //first check if the directory of the file exists, and if not try to create that first.
                FileInfo fi = new FileInfo(file);
                if (fi.Directory.Exists == false)
                {
                    fi.Directory.Create();
                }

                File.WriteAllText(file,
                                  &quot;This file has been created by the umbraco configuration wizard. It is safe to delete it!&quot;);
                File.Delete(file);
                return true;
            }
            catch
            {
                return false;
            }

        }

        private static bool OpenFileForWrite(string file)
        {
            try
            {
                File.AppendText(file).Close();
            }
            catch
            {
                return false;
            }
            return true;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,275,0],[14,9,14,65,0],[15,9,15,182,0],[18,9,18,10,0],[19,13,19,66,0],[23,13,23,70,0],[24,17,24,73,0],[26,13,26,79,0],[27,17,27,83,0],[29,13,29,65,0],[30,17,30,70,0],[32,13,32,53,0],[33,17,33,76,0],[35,13,35,82,0],[36,17,36,79,0],[38,13,38,47,0],[39,9,39,10,0],[42,9,42,10,0],[43,13,43,46,0],[44,13,44,32,0],[45,13,45,20,0],[45,22,45,32,0],[45,33,45,35,0],[45,36,45,47,0],[46,13,46,14,0],[47,17,47,52,0],[47,53,47,62,0],[49,17,49,108,0],[51,17,51,37,0],[52,17,52,18,0],[53,21,53,36,0],[54,21,54,42,0],[55,17,55,18,0],[56,13,56,14,0],[58,13,58,27,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,46,0],[64,13,64,32,0],[65,13,65,20,0],[65,22,65,33,0],[65,34,65,36,0],[65,37,65,42,0],[66,13,66,14,0],[67,17,67,72,0],[68,17,68,37,0],[69,17,69,18,0],[70,21,70,43,0],[71,21,71,36,0],[72,17,72,18,0],[73,13,73,14,0],[75,13,75,27,0],[76,9,76,10,0],[79,9,79,10,0],[80,13,80,46,0],[82,13,82,14,0],[83,17,83,90,0],[84,17,84,52,0],[85,17,85,43,0],[86,17,86,29,0],[88,13,88,18,0],[89,13,89,14,0],[90,17,90,41,0],[91,17,91,30,0],[93,9,93,10,0],[96,9,96,10,0],[97,13,97,46,0],[102,13,102,14,0],[103,17,103,76,0],[104,17,104,44,0],[105,17,105,29,0],[107,13,107,18,0],[108,13,108,14,0],[109,17,109,62,0],[110,17,110,30,0],[112,9,112,10,0],[115,9,115,10,0],[117,13,117,14,0],[119,17,119,50,0],[120,17,120,50,0],[121,17,121,18,0],[122,21,122,43,0],[123,17,123,18,0],[125,17,126,127,0],[127,17,127,35,0],[128,17,128,29,0],[130,13,130,18,0],[131,13,131,14,0],[132,17,132,30,0],[135,9,135,10,0],[138,9,138,10,0],[140,13,140,14,0],[141,17,141,47,0],[142,13,142,14,0],[143,13,143,18,0],[144,13,144,14,0],[145,17,145,30,0],[147,13,147,25,0],[148,9,148,10,0]]);
    </script>
  </body>
</html>