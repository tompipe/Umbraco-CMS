<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Routing\ContentFinderByNiceUrlAndTemplate.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core;
using Umbraco.Core.Configuration;

namespace Umbraco.Web.Routing
{
    /// &lt;summary&gt;
    /// Provides an implementation of &lt;see cref=&quot;IContentFinder&quot;/&gt; that handles page nice urls and a template.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// &lt;para&gt;Handles &lt;c&gt;/foo/bar/template&lt;/c&gt; where &lt;c&gt;/foo/bar&lt;/c&gt; is the nice url of a document, and &lt;c&gt;template&lt;/c&gt; a template alias.&lt;/para&gt;
    /// &lt;para&gt;If successful, then the template of the document request is also assigned.&lt;/para&gt;
    /// &lt;/remarks&gt;
    public class ContentFinderByNiceUrlAndTemplate : ContentFinderByNiceUrl
    {
        /// &lt;summary&gt;
        /// Tries to find and assign an Umbraco document to a &lt;c&gt;PublishedContentRequest&lt;/c&gt;.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;docRequest&quot;&gt;The &lt;c&gt;PublishedContentRequest&lt;/c&gt;.&lt;/param&gt;		
        /// &lt;returns&gt;A value indicating whether an Umbraco document was found and assigned.&lt;/returns&gt;
        /// &lt;remarks&gt;If successful, also assigns the template.&lt;/remarks&gt;
        public override bool TryFindContent(PublishedContentRequest docRequest)
        {
            IPublishedContent node = null;
            string path = docRequest.Uri.GetAbsolutePathDecoded();

            if (docRequest.HasDomain)
                path = DomainHelper.PathRelativeToDomain(docRequest.DomainUri, path);

            if (path != &quot;/&quot;) // no template if &quot;/&quot;
            {
                var pos = path.LastIndexOf(&#39;/&#39;);
                var templateAlias = path.Substring(pos + 1);
                path = pos == 0 ? &quot;/&quot; : path.Substring(0, pos);

                var template = ApplicationContext.Current.Services.FileService.GetTemplate(templateAlias);
                if (template != null)
                {
                    LogHelper.Debug&lt;ContentFinderByNiceUrlAndTemplate&gt;(&quot;Valid template: \&quot;{0}\&quot;&quot;, () =&gt; templateAlias);

                    var route = docRequest.HasDomain ? (docRequest.Domain.RootNodeId.ToString() + path) : path;
                    node = FindContent(docRequest, route);

                    if (UmbracoConfig.For.UmbracoSettings().WebRouting.DisableAlternativeTemplates == false &amp;&amp; node != null)
                        docRequest.TemplateModel = template;
                }
                else
                {
                    LogHelper.Debug&lt;ContentFinderByNiceUrlAndTemplate&gt;(&quot;Not a valid template: \&quot;{0}\&quot;&quot;, () =&gt; templateAlias);
                }
            }
            else
            {
                LogHelper.Debug&lt;ContentFinderByNiceUrlAndTemplate&gt;(&quot;No template in path \&quot;/\&quot;&quot;);
            }

            return node != null;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,1],[25,13,25,43,1],[26,13,26,67,1],[28,13,28,38,1],[29,17,29,86,0],[31,13,31,29,1],[32,13,32,14,1],[33,17,33,49,1],[34,17,34,61,1],[35,17,35,64,1],[37,17,37,107,1],[38,17,38,38,1],[39,17,39,18,1],[40,21,40,105,1],[40,105,40,118,0],[40,118,40,120,1],[40,21,40,120,1],[42,21,42,112,1],[43,21,43,59,1],[45,21,45,125,1],[46,25,46,61,1],[47,17,47,18,1],[49,17,49,18,0],[50,21,50,111,0],[50,111,50,124,0],[50,124,50,126,0],[50,21,50,126,0],[51,17,51,18,0],[52,13,52,14,1],[54,13,54,14,0],[55,17,55,97,0],[56,13,56,14,0],[58,13,58,33,1],[59,9,59,10,1]]);
    </script>
  </body>
</html>