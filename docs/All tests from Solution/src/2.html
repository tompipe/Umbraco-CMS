<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\ApplicationContextTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using Moq;
using NUnit.Framework;
using Semver;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Profiling;
using Umbraco.Core.Services;

namespace Umbraco.Tests
{
    [TestFixture]
    public class ApplicationContextTests
    {
        [Test]
        public void Is_Configured()
        {
            ConfigurationManager.AppSettings.Set(&quot;umbracoConfigurationStatus&quot;, UmbracoVersion.GetSemanticVersion().ToSemanticString());

            var migrationEntryService = new Mock&lt;IMigrationEntryService&gt;();
            migrationEntryService.Setup(x =&gt; x.FindEntry(It.IsAny&lt;string&gt;(), It.IsAny&lt;SemVersion&gt;()))
                .Returns(Mock.Of&lt;IMigrationEntry&gt;());

            var dbCtx = new Mock&lt;DatabaseContext&gt;(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider(), &quot;test&quot;);
            dbCtx.Setup(x =&gt; x.IsDatabaseConfigured).Returns(true);
            dbCtx.Setup(x =&gt; x.CanConnect).Returns(true);

            var appCtx = new ApplicationContext(
                dbCtx.Object,
                new ServiceContext(migrationEntryService:migrationEntryService.Object), 
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            Assert.IsTrue(appCtx.IsConfigured);
        }

        [Test]
        public void Is_Not_Configured_By_Migration_Not_Found()
        {
            ConfigurationManager.AppSettings.Set(&quot;umbracoConfigurationStatus&quot;, UmbracoVersion.GetSemanticVersion().ToSemanticString());

            var migrationEntryService = new Mock&lt;IMigrationEntryService&gt;();
            migrationEntryService.Setup(x =&gt; x.FindEntry(It.IsAny&lt;string&gt;(), It.IsAny&lt;SemVersion&gt;()))
                .Returns((IMigrationEntry)null);

            var dbCtx = new Mock&lt;DatabaseContext&gt;(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider(), &quot;test&quot;);
            dbCtx.Setup(x =&gt; x.IsDatabaseConfigured).Returns(true);
            dbCtx.Setup(x =&gt; x.CanConnect).Returns(true);

            var appCtx = new ApplicationContext(
                dbCtx.Object,
                new ServiceContext(migrationEntryService: migrationEntryService.Object),
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            Assert.IsFalse(appCtx.IsConfigured);
        }

        [Test]
        public void Is_Not_Configured_By_Configuration()
        {
            ConfigurationManager.AppSettings.Set(&quot;umbracoConfigurationStatus&quot;, new SemVersion(UmbracoVersion.Current.Major - 1, 0, 0).ToString());

            var migrationEntryService = new Mock&lt;IMigrationEntryService&gt;();

            var dbCtx = new Mock&lt;DatabaseContext&gt;(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider(), &quot;test&quot;);
            dbCtx.Setup(x =&gt; x.IsDatabaseConfigured).Returns(true);
            dbCtx.Setup(x =&gt; x.CanConnect).Returns(true);

            var appCtx = new ApplicationContext(
                dbCtx.Object,
                new ServiceContext(migrationEntryService: migrationEntryService.Object),
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            Assert.IsFalse(appCtx.IsConfigured);
        }

        [Test]
        public void Is_Not_Configured_By_Database_Not_Configured()
        {
            ConfigurationManager.AppSettings.Set(&quot;umbracoConfigurationStatus&quot;, new SemVersion(UmbracoVersion.Current.Major - 1, 0, 0).ToString());

            var migrationEntryService = new Mock&lt;IMigrationEntryService&gt;();

            var dbCtx = new Mock&lt;DatabaseContext&gt;(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider(), &quot;test&quot;);
            dbCtx.Setup(x =&gt; x.IsDatabaseConfigured).Returns(false);
            dbCtx.Setup(x =&gt; x.CanConnect).Returns(true);

            var appCtx = new ApplicationContext(
                dbCtx.Object,
                new ServiceContext(migrationEntryService: migrationEntryService.Object),
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            Assert.IsFalse(appCtx.IsConfigured);
        }

        [Test]
        public void Is_Not_Configured_By_Database_Cannot_Connect()
        {
            ConfigurationManager.AppSettings.Set(&quot;umbracoConfigurationStatus&quot;, new SemVersion(UmbracoVersion.Current.Major - 1, 0, 0).ToString());

            var migrationEntryService = new Mock&lt;IMigrationEntryService&gt;();

            var dbCtx = new Mock&lt;DatabaseContext&gt;(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider(), &quot;test&quot;);
            dbCtx.Setup(x =&gt; x.IsDatabaseConfigured).Returns(true);
            dbCtx.Setup(x =&gt; x.CanConnect).Returns(false);

            var appCtx = new ApplicationContext(
                dbCtx.Object,
                new ServiceContext(migrationEntryService: migrationEntryService.Object),
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            Assert.IsFalse(appCtx.IsConfigured);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,136,1],[25,13,25,76,1],[26,13,27,54,1],[29,13,29,135,1],[30,13,30,68,1],[31,13,31,58,1],[33,13,37,80,1],[39,13,39,48,1],[40,9,40,10,1],[44,9,44,10,1],[45,13,45,136,1],[47,13,47,76,1],[48,13,49,49,1],[51,13,51,135,1],[52,13,52,68,1],[53,13,53,58,1],[55,13,59,80,1],[61,13,61,49,1],[62,9,62,10,1],[66,9,66,10,1],[67,13,67,147,1],[69,13,69,76,1],[71,13,71,135,1],[72,13,72,68,1],[73,13,73,58,1],[75,13,79,80,1],[81,13,81,49,1],[82,9,82,10,1],[86,9,86,10,1],[87,13,87,147,1],[89,13,89,76,1],[91,13,91,135,1],[92,13,92,69,1],[93,13,93,58,1],[95,13,99,80,1],[101,13,101,49,1],[102,9,102,10,1],[106,9,106,10,1],[107,13,107,147,1],[109,13,109,76,1],[111,13,111,135,1],[112,13,112,68,1],[113,13,113,59,1],[115,13,119,80,1],[121,13,121,49,1],[122,9,122,10,1]]);
    </script>
  </body>
</html>