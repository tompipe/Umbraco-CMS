<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Mappers\BaseMapper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Concurrent;
using System.Linq.Expressions;
using System.Reflection;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Mappers
{
    public abstract class BaseMapper
    {
        private readonly ISqlSyntaxProvider _sqlSyntax;

        protected BaseMapper() : this(SqlSyntaxContext.SqlSyntaxProvider)
        {            
        }

        protected BaseMapper(ISqlSyntaxProvider sqlSyntax)
        {
            _sqlSyntax = sqlSyntax;
        }

        internal abstract ConcurrentDictionary&lt;string, DtoMapModel&gt; PropertyInfoCache { get; }

        internal abstract void BuildMap();

        internal string Map(string propertyName, bool throws = false)
        {
            DtoMapModel dtoTypeProperty;
            if (PropertyInfoCache.TryGetValue(propertyName, out dtoTypeProperty))
            {
                return GetColumnName(dtoTypeProperty.Type, dtoTypeProperty.PropertyInfo);
            }
            else
            {
                if (throws)
                {
                    throw new InvalidOperationException(&quot;Could not get the value with the key &quot; + propertyName + &quot; from the property info cache, keys available: &quot; + string.Join(&quot;, &quot;, PropertyInfoCache.Keys));
                }
                return string.Empty;
            }
        }

        internal void CacheMap&lt;TSource, TDestination&gt;(Expression&lt;Func&lt;TSource, object&gt;&gt; sourceMember, Expression&lt;Func&lt;TDestination, object&gt;&gt; destinationMember)
        {
            var property = ResolveMapping(sourceMember, destinationMember);
            PropertyInfoCache.AddOrUpdate(property.SourcePropertyName, property, (x, y) =&gt; property);
        }

        internal DtoMapModel ResolveMapping&lt;TSource, TDestination&gt;(Expression&lt;Func&lt;TSource, object&gt;&gt; sourceMember, Expression&lt;Func&lt;TDestination, object&gt;&gt; destinationMember)
        {
            var source = ExpressionHelper.FindProperty(sourceMember);
            var destination = (PropertyInfo)ExpressionHelper.FindProperty(destinationMember);

            if (destination == null)
            {
                throw new InvalidOperationException(&quot;The &#39;destination&#39; returned was null, cannot resolve the mapping&quot;);
            }

            return new DtoMapModel(typeof(TDestination), destination, source.Name);
        }

        internal virtual string GetColumnName(Type dtoType, PropertyInfo dtoProperty)
        {
            var tableNameAttribute = dtoType.FirstAttribute&lt;TableNameAttribute&gt;();
            string tableName = tableNameAttribute.Value;

            var columnAttribute = dtoProperty.FirstAttribute&lt;ColumnAttribute&gt;();
            string columnName = columnAttribute.Name;

            string columnMap = string.Format(&quot;{0}.{1}&quot;,
                                             _sqlSyntax.GetQuotedTableName(tableName),
                                             _sqlSyntax.GetQuotedColumnName(columnName));
            return columnMap;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,34,13,74,1],[14,9,14,10,1],[15,9,15,10,1],[17,9,17,59,1],[18,9,18,10,1],[19,13,19,36,1],[20,9,20,10,1],[27,9,27,10,1],[29,13,29,82,1],[30,13,30,14,1],[31,17,31,90,1],[34,13,34,14,0],[35,17,35,28,0],[36,17,36,18,0],[37,21,37,209,0],[39,17,39,37,0],[41,9,41,10,1],[44,9,44,10,1],[45,13,45,76,1],[46,13,46,92,1],[46,92,46,100,1],[46,100,46,102,1],[46,13,46,102,1],[47,9,47,10,1],[50,9,50,10,1],[51,13,51,70,1],[52,13,52,94,1],[54,13,54,37,1],[55,13,55,14,0],[56,17,56,120,0],[59,13,59,84,1],[60,9,60,10,1],[63,9,63,10,1],[64,13,64,83,1],[65,13,65,57,1],[67,13,67,81,1],[68,13,68,54,1],[70,13,72,90,1],[73,13,73,30,1],[74,9,74,10,1]]);
    </script>
  </body>
</html>