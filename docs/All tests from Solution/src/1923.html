<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Factories\DataTypeDefinitionFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;

namespace Umbraco.Core.Persistence.Factories
{
    internal class DataTypeDefinitionFactory
    {
        private readonly Guid _nodeObjectTypeId;
        private int _primaryKey;

        public DataTypeDefinitionFactory(Guid nodeObjectTypeId)
        {
            _nodeObjectTypeId = nodeObjectTypeId;
        }

        #region Implementation of IEntityFactory&lt;DataTypeDefinition,DataTypeDto&gt;

        public IDataTypeDefinition BuildEntity(DataTypeDto dto)
        {
            var dataTypeDefinition = new DataTypeDefinition(dto.PropertyEditorAlias);


            try
            {
                dataTypeDefinition.DisableChangeTracking();

                dataTypeDefinition.CreateDate = dto.NodeDto.CreateDate;
                dataTypeDefinition.DatabaseType = dto.DbType.EnumParse&lt;DataTypeDatabaseType&gt;(true);
                dataTypeDefinition.Id = dto.DataTypeId;
                dataTypeDefinition.Key = dto.NodeDto.UniqueId;
                dataTypeDefinition.Level = dto.NodeDto.Level;
                dataTypeDefinition.UpdateDate = dto.NodeDto.CreateDate;
                dataTypeDefinition.Name = dto.NodeDto.Text;
                dataTypeDefinition.ParentId = dto.NodeDto.ParentId;
                dataTypeDefinition.Path = dto.NodeDto.Path;
                dataTypeDefinition.SortOrder = dto.NodeDto.SortOrder;
                dataTypeDefinition.Trashed = dto.NodeDto.Trashed;
                dataTypeDefinition.CreatorId = dto.NodeDto.UserId.Value;

                //on initial construction we don&#39;t want to have dirty properties tracked
                // http://issues.umbraco.org/issue/U4-1946
                dataTypeDefinition.ResetDirtyProperties(false);
                return dataTypeDefinition;
            }
            finally
            {
                dataTypeDefinition.EnableChangeTracking();
            }
        }

        public DataTypeDto BuildDto(IDataTypeDefinition entity)
        {
            var dataTypeDto = new DataTypeDto
                                  {
                                      PropertyEditorAlias = entity.PropertyEditorAlias,
                                      DataTypeId = entity.Id,
                                      DbType = entity.DatabaseType.ToString(),
                                      NodeDto = BuildNodeDto(entity)
                                  };

            if (_primaryKey &gt; 0)
            {
                dataTypeDto.PrimaryKey = _primaryKey;
            }

            return dataTypeDto;
        }

        #endregion

        public void SetPrimaryKey(int primaryKey)
        {
            _primaryKey = primaryKey;
        }

        private NodeDto BuildNodeDto(IDataTypeDefinition entity)
        {
            var nodeDto = new NodeDto
                              {
                                  CreateDate = entity.CreateDate,
                                  NodeId = entity.Id,
                                  Level = short.Parse(entity.Level.ToString(CultureInfo.InvariantCulture)),
                                  NodeObjectType = _nodeObjectTypeId,
                                  ParentId = entity.ParentId,
                                  Path = entity.Path,
                                  SortOrder = entity.SortOrder,
                                  Text = entity.Name,
                                  Trashed = entity.Trashed,
                                  UniqueId = entity.Key,
                                  UserId = entity.CreatorId
                              };

            return nodeDto;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,64,1],[14,9,14,10,1],[15,13,15,50,1],[16,9,16,10,1],[21,9,21,10,1],[22,13,22,86,1],[26,13,26,14,1],[27,17,27,60,1],[29,17,29,72,1],[30,17,30,100,1],[31,17,31,56,1],[32,17,32,63,1],[33,17,33,62,1],[34,17,34,72,1],[35,17,35,60,1],[36,17,36,68,1],[37,17,37,60,1],[38,17,38,70,1],[39,17,39,66,1],[40,17,40,73,1],[44,17,44,64,1],[45,17,45,43,1],[48,13,48,14,1],[49,17,49,59,1],[50,13,50,14,1],[51,9,51,10,1],[54,9,54,10,1],[55,13,61,37,1],[63,13,63,33,1],[64,13,64,14,1],[65,17,65,54,1],[66,13,66,14,1],[68,13,68,32,1],[69,9,69,10,1],[74,9,74,10,1],[75,13,75,38,1],[76,9,76,10,1],[79,9,79,10,1],[80,13,93,33,1],[95,13,95,28,1],[96,9,96,10,1]]);
    </script>
  </body>
</html>