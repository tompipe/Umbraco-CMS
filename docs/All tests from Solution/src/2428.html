<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\Packager\PackageActions\addStringToHtmlElement.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Xml;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;

namespace umbraco.cms.businesslogic.packager.standardPackageActions
{
	/// &lt;summary&gt;
	/// This class implements the IPackageAction Interface, used to execute code when packages are installed.
	/// All IPackageActions only takes a PackageName and a XmlNode as input, and executes based on the data in the xmlnode.
	/// addStringToHtmlElement adds a string to specific HTML element in a specific template, and can either append or prepend it.
	/// It uses the action xml node to do this, exemple action xml node:
	/// &lt;Action runat=&quot;install&quot; alias=&quot;addStringToHtmlElement&quot; templateAlias=&quot;news&quot; htmlElementId=&quot;newsSection&quot; position=&quot;end&quot;&gt;&lt;![CDATA[hello world!]]&gt;&lt;/action&gt;
	/// The above will add the string &quot;hello world!&quot; to the first html element with the id &quot;newsSection&quot; in the template &quot;news&quot;
	/// &lt;/summary&gt;
	public class addStringToHtmlElement : umbraco.interfaces.IPackageAction
	{
		#region IPackageAction Members

		/// &lt;summary&gt;
		/// Executes the specified package action.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;packageName&quot;&gt;Name of the package.&lt;/param&gt;
		/// &lt;param name=&quot;xmlData&quot;&gt;The XML data.&lt;/param&gt;
		/// &lt;example&gt;&lt;code&gt;&lt;code&gt; 
		///     &lt;Action runat=&quot;install&quot; alias=&quot;addStringToHtmlElement&quot; templateAlias=&quot;news&quot; htmlElementId=&quot;newsSection&quot; position=&quot;[beginning/end&quot;&gt;&lt;![CDATA[hello world!]]&gt;&lt;/action&gt;
		/// &lt;/code&gt;&lt;/code&gt;&lt;/example&gt;
		/// &lt;returns&gt;True if executed successfully&lt;/returns&gt;
		public bool Execute(string packageName, XmlNode xmlData)
		{


			string templateAlias = xmlData.Attributes[&quot;templateAlias&quot;].Value;
			string htmlElementId = xmlData.Attributes[&quot;htmlElementId&quot;].Value;
			string position = xmlData.Attributes[&quot;position&quot;].Value;
			string value = xmlHelper.GetNodeValue(xmlData);
			template.Template tmp = template.Template.GetByAlias(templateAlias);

            if (UmbracoConfig.For.UmbracoSettings().Templates.UseAspNetMasterPages)
				value = tmp.EnsureMasterPageSyntax(value);

			_addStringToHtmlElement(tmp, value, templateAlias, htmlElementId, position);

			return true;
		}


		/// &lt;summary&gt;
		/// Undoes the addStringToHtml Execute() method, by removing the same string from the same template.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;packageName&quot;&gt;Name of the package.&lt;/param&gt;
		/// &lt;param name=&quot;xmlData&quot;&gt;The XML data.&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public bool Undo(string packageName, XmlNode xmlData)
		{
			string templateAlias = xmlData.Attributes[&quot;templateAlias&quot;].Value;
			string htmlElementId = xmlData.Attributes[&quot;htmlElementId&quot;].Value;
			string value = xmlHelper.GetNodeValue(xmlData);
			template.Template tmp = template.Template.GetByAlias(templateAlias);

			if (UmbracoConfig.For.UmbracoSettings().Templates.UseAspNetMasterPages)
				value = tmp.EnsureMasterPageSyntax(value);

			_removeStringFromHtmlElement(tmp, value, templateAlias, htmlElementId);
			return true;
		}

		/// &lt;summary&gt;
		/// Action alias.
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public string Alias()
		{
			return &quot;addStringToHtmlElement&quot;;
		}

		private void _addStringToHtmlElement(template.Template tmp, string value, string templateAlias, string htmlElementId, string position)
		{
			bool hasAspNetContentBeginning = false;
			string design = &quot;&quot;;
			string directive = &quot;&quot;;

			if (tmp != null)
			{
				try
				{
					XmlDocument templateXml = new XmlDocument();
					templateXml.PreserveWhitespace = true;

					//Make sure that directive is remove before hacked non html4 compatiple replacement action... 
					design = tmp.Design;


					splitDesignAndDirective(ref design, ref directive);

					//making sure that the template xml has a root node...
					if (tmp.MasterTemplate &gt; 0)
						templateXml.LoadXml(helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, &quot;&lt;root&gt;&quot; + design + &quot;&lt;/root&gt;&quot;, true));
					else
						templateXml.LoadXml(helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, design, true));

					XmlNode xmlElement = templateXml.SelectSingleNode(&quot;//* [@id = &#39;&quot; + htmlElementId + &quot;&#39;]&quot;);

					if (xmlElement != null)
					{

						if (position == &quot;beginning&quot;)
						{
							xmlElement.InnerXml = &quot;\n&quot; + helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, value, true) + &quot;\n&quot; + xmlElement.InnerXml;
						}
						else
						{
							xmlElement.InnerXml = xmlElement.InnerXml + &quot;\n&quot; + helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, value, true) + &quot;\n&quot;;
						}
					}

					tmp.Design = directive + &quot;\n&quot; + helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, templateXml.OuterXml, false);
					tmp.Save();
				}
				catch (Exception ex)
				{
					LogHelper.Error&lt;addStringToHtmlElement&gt;(&quot;An error occurred&quot;, ex);
				}
			}
			else
			{
				LogHelper.Debug&lt;addStringToHtmlElement&gt;(&quot;template not found&quot;);
			}
		}

		private void _removeStringFromHtmlElement(template.Template tmp, string value, string templateAlias, string htmlElementId)
		{
			bool hasAspNetContentBeginning = false;
			string design = &quot;&quot;;
			string directive = &quot;&quot;;


			if (tmp != null)
			{
				try
				{
					XmlDocument templateXml = new XmlDocument();
					templateXml.PreserveWhitespace = true;

					//Make sure that directive is remove before hacked non html4 compatiple replacement action... 
					design = tmp.Design;
					splitDesignAndDirective(ref design, ref directive);

					//making sure that the template xml has a root node...
					if (tmp.MasterTemplate &gt; 0)
						templateXml.LoadXml(helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, &quot;&lt;root&gt;&quot; + design + &quot;&lt;/root&gt;&quot;, true));
					else
						templateXml.LoadXml(helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, design, true));

					XmlNode xmlElement = templateXml.SelectSingleNode(&quot;//* [@id = &#39;&quot; + htmlElementId + &quot;&#39;]&quot;);



					if (xmlElement != null)
					{
						string repValue = helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, value, true);
						xmlElement.InnerXml = xmlElement.InnerXml.Replace(repValue, &quot;&quot;);
					}

					tmp.Design = directive + &quot;\n&quot; + helper.parseToValidXml(tmp, ref hasAspNetContentBeginning, templateXml.OuterXml, false);
					tmp.Save();
				}
				catch (Exception ex)
				{
					LogHelper.Error&lt;addStringToHtmlElement&gt;(&quot;An error occurred&quot;, ex);
				}
			}
			else
			{
				LogHelper.Debug&lt;addStringToHtmlElement&gt;(&quot;template not found&quot;);
			}
		}



		private void splitDesignAndDirective(ref string design, ref string directive)
		{
			if (design.StartsWith(&quot;&lt;%@&quot;))
			{
				directive = design.Substring(0, design.IndexOf(&quot;%&gt;&quot;) + 2).Trim(Environment.NewLine.ToCharArray());
				design = design.Substring(design.IndexOf(&quot;%&gt;&quot;) + 3).Trim(Environment.NewLine.ToCharArray());
			}
		}

		#endregion

		public XmlNode SampleXml()
		{
			throw new NotImplementedException();
		}

	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[30,3,30,4,0],[33,4,33,69,0],[34,4,34,69,0],[35,4,35,59,0],[36,4,36,51,0],[37,4,37,72,0],[39,13,39,84,0],[40,5,40,47,0],[42,4,42,80,0],[44,4,44,16,0],[45,3,45,4,0],[55,3,55,4,0],[56,4,56,69,0],[57,4,57,69,0],[58,4,58,51,0],[59,4,59,72,0],[61,4,61,75,0],[62,5,62,47,0],[64,4,64,75,0],[65,4,65,16,0],[66,3,66,4,0],[73,3,73,4,0],[74,4,74,36,0],[75,3,75,4,0],[78,3,78,4,0],[79,4,79,43,0],[80,4,80,23,0],[81,4,81,26,0],[83,4,83,20,0],[84,4,84,5,0],[86,5,86,6,0],[87,6,87,50,0],[88,6,88,44,0],[91,6,91,26,0],[94,6,94,57,0],[97,6,97,33,0],[98,7,98,124,0],[100,7,100,101,0],[102,6,102,95,0],[104,6,104,29,0],[105,6,105,7,0],[107,7,107,35,0],[108,7,108,8,0],[109,8,109,138,0],[110,7,110,8,0],[112,7,112,8,0],[113,8,113,138,0],[114,7,114,8,0],[115,6,115,7,0],[117,6,117,126,0],[118,6,118,17,0],[119,5,119,6,0],[120,5,120,25,0],[121,5,121,6,0],[122,6,122,71,0],[123,5,123,6,0],[124,4,124,5,0],[126,4,126,5,0],[127,5,127,67,0],[128,4,128,5,0],[129,3,129,4,0],[132,3,132,4,0],[133,4,133,43,0],[134,4,134,23,0],[135,4,135,26,0],[138,4,138,20,0],[139,4,139,5,0],[141,5,141,6,0],[142,6,142,50,0],[143,6,143,44,0],[146,6,146,26,0],[147,6,147,57,0],[150,6,150,33,0],[151,7,151,124,0],[153,7,153,101,0],[155,6,155,95,0],[159,6,159,29,0],[160,6,160,7,0],[161,7,161,97,0],[162,7,162,71,0],[163,6,163,7,0],[165,6,165,126,0],[166,6,166,17,0],[167,5,167,6,0],[168,5,168,25,0],[169,5,169,6,0],[170,6,170,71,0],[171,5,171,6,0],[172,4,172,5,0],[174,4,174,5,0],[175,5,175,67,0],[176,4,176,5,0],[177,3,177,4,0],[182,3,182,4,0],[183,4,183,33,0],[184,4,184,5,0],[185,5,185,103,0],[186,5,186,97,0],[187,4,187,5,0],[188,3,188,4,0],[193,3,193,4,0],[194,4,194,40,0]]);
    </script>
  </body>
</html>