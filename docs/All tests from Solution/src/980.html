<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\MultiNodeTreePickerPropertyEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.PropertyEditors;

namespace Umbraco.Web.PropertyEditors
{
    [PropertyEditor(Constants.PropertyEditors.MultiNodeTreePickerAlias, &quot;Multinode Treepicker&quot;, &quot;contentpicker&quot;, Group=&quot;pickers&quot;, Icon=&quot;icon-page-add&quot;)]
    public class MultiNodeTreePickerPropertyEditor : PropertyEditor
    {
        public MultiNodeTreePickerPropertyEditor()
        {
            _internalPreValues = new Dictionary&lt;string, object&gt;
            {
                {&quot;multiPicker&quot;, &quot;1&quot;},
                {&quot;showOpenButton&quot;, &quot;0&quot;},
                {&quot;showEditButton&quot;, &quot;0&quot;},
                {&quot;showPathOnHover&quot;, &quot;0&quot;}
            };
        }
        
        protected override PreValueEditor CreatePreValueEditor()
        {
            return new MultiNodePickerPreValueEditor();
        }

        private IDictionary&lt;string, object&gt; _internalPreValues;
        public override IDictionary&lt;string, object&gt; DefaultPreValues
        {
            get { return _internalPreValues; }
            set { _internalPreValues = value; }
        }

        internal class MultiNodePickerPreValueEditor : PreValueEditor
        {
            [PreValueField(&quot;startNode&quot;, &quot;Node type&quot;, &quot;treesource&quot;)]
            public string StartNode { get; set; }
            
            [PreValueField(&quot;filter&quot;, &quot;Allow items of type&quot;, &quot;textstring&quot;, Description = &quot;Separate with comma&quot;)]
            public string Filter { get; set; }

            [PreValueField(&quot;minNumber&quot;, &quot;Minimum number of items&quot;, &quot;number&quot;)]
            public string MinNumber { get; set; }

            [PreValueField(&quot;maxNumber&quot;, &quot;Maximum number of items&quot;, &quot;number&quot;)]
            public string MaxNumber { get; set; }


            [PreValueField(&quot;showOpenButton&quot;, &quot;Show open button&quot;, &quot;boolean&quot;)]
            public string ShowOpenButton { get; set; }

            [PreValueField(&quot;showEditButton&quot;, &quot;Show edit button (this feature is in preview!)&quot;, &quot;boolean&quot;)]
            public string ShowEditButton { get; set; }

            [PreValueField(&quot;showPathOnHover&quot;, &quot;Show path when hovering items&quot;, &quot;boolean&quot;)]
            public bool ShowPathOnHover { get; set; }

            /// &lt;summary&gt;
            /// This ensures the multiPicker pre-val is set based on the maxNumber of nodes set
            /// &lt;/summary&gt;
            /// &lt;param name=&quot;defaultPreVals&quot;&gt;&lt;/param&gt;
            /// &lt;param name=&quot;persistedPreVals&quot;&gt;&lt;/param&gt;
            /// &lt;returns&gt;&lt;/returns&gt;
            /// &lt;remarks&gt;
            /// Due to compatibility with 7.0.0 the multiPicker pre-val might already exist in the db, but we&#39;ve removed that setting in 7.0.1 so we need to detect it and if it is
            /// there, then we&#39;ll set the maxNumber to &#39;1&#39;
            /// &lt;/remarks&gt;
            public override IDictionary&lt;string, object&gt; ConvertDbToEditor(IDictionary&lt;string, object&gt; defaultPreVals, PreValueCollection persistedPreVals)
            {
                var result = base.ConvertDbToEditor(defaultPreVals, persistedPreVals);

                //backwards compatibility check
                if (result.ContainsKey(&quot;multiPicker&quot;) &amp;&amp; result[&quot;multiPicker&quot;].ToString() == &quot;0&quot;)
                {
                    result[&quot;maxNumber&quot;] = &quot;1&quot;;
                }

                //set the multiPicker val correctly depending on the maxNumber
                if (result.ContainsKey(&quot;maxNumber&quot;))
                {
                    var asNumber = result[&quot;maxNumber&quot;].TryConvertTo&lt;int&gt;();
                    if (asNumber.Success)
                    {
                        if (asNumber.Result &lt;= 1)
                        {
                            result[&quot;multiPicker&quot;] = &quot;0&quot;;
                        }
                        else
                        {
                            result[&quot;multiPicker&quot;] = &quot;1&quot;;
                        }
                    }    
                }
                

                return result;
            }

        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[11,9,11,51,1],[12,9,12,10,1],[13,13,19,15,1],[20,9,20,10,1],[23,9,23,10,0],[24,13,24,56,0],[25,9,25,10,0],[30,17,30,18,0],[30,19,30,45,0],[30,46,30,47,0],[31,17,31,18,0],[31,19,31,46,0],[31,47,31,48,0],[37,39,37,43,0],[37,44,37,48,0],[40,36,40,40,0],[40,41,40,45,0],[43,39,43,43,0],[43,44,43,48,0],[46,39,46,43,0],[46,44,46,48,0],[50,44,50,48,0],[50,49,50,53,0],[53,44,53,48,0],[53,49,53,53,0],[56,43,56,47,0],[56,48,56,52,0],[69,13,69,14,0],[70,17,70,87,0],[73,17,73,98,0],[74,17,74,18,0],[75,21,75,47,0],[76,17,76,18,0],[79,17,79,53,0],[80,17,80,18,0],[81,21,81,76,0],[82,21,82,42,0],[83,21,83,22,0],[84,25,84,50,0],[85,25,85,26,0],[86,29,86,57,0],[87,25,87,26,0],[89,25,89,26,0],[90,29,90,57,0],[91,25,91,26,0],[92,21,92,22,0],[93,17,93,18,0],[96,17,96,31,0],[97,13,97,14,0]]);
    </script>
  </body>
</html>