<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\settings\scripts\editScript.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.IO;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using umbraco.cms.presentation.Trees;
using System.Linq;
using umbraco.cms.helpers;
using umbraco.uicontrols;

namespace umbraco.cms.presentation.settings.scripts
{
    public partial class editScript : BasePages.UmbracoEnsuredPage
    {
        public editScript()
        {
            CurrentApp = BusinessLogic.DefaultApps.settings.ToString();

        }
        protected System.Web.UI.HtmlControls.HtmlForm Form1;
        protected uicontrols.TabView Panel1;
        protected System.Web.UI.WebControls.TextBox NameTxt;
        protected uicontrols.Pane Pane7;
        protected uicontrols.Pane Pane8;

        protected System.Web.UI.WebControls.Literal lttPath;
        protected System.Web.UI.WebControls.Literal editorJs;
        protected umbraco.uicontrols.CodeArea editorSource;
        protected umbraco.uicontrols.PropertyPanel pp_name;
        protected umbraco.uicontrols.PropertyPanel pp_path;

        protected MenuButton SaveButton;

        private string filename;
        protected string ScriptTreeSyncPath { get; private set; }

        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            // get the script, ensure it exists (not null) and validate (because
            // the file service ensures that it loads scripts from the proper location
            // but does not seem to validate extensions?) - in case of an error,
            // throw - that&#39;s what we did anyways.

            // also scrapping the code that added .cshtml and .vbhtml extensions, and
            // ~/Views directory - we&#39;re not using editScript.aspx for views anymore.

            var svce = ApplicationContext.Current.Services.FileService;
            var script = svce.GetScriptByName(filename);
            if (script == null) // not found
                throw new FileNotFoundException(&quot;Could not find file &#39;&quot; + filename + &quot;&#39;.&quot;);

            lttPath.Text = &quot;&lt;a id=\&quot;&quot; + lttPath.ClientID + &quot;\&quot; target=\&quot;_blank\&quot; href=\&quot;&quot; + script.VirtualPath + &quot;\&quot;&gt;&quot; + script.VirtualPath + &quot;&lt;/a&gt;&quot;;
            editorSource.Text = script.Content;
            ScriptTreeSyncPath = DeepLink.GetTreePathFromFilePath(filename);

            // name derives from filename, clean for xss
            NameTxt.Text = filename.CleanForXss(&#39;\\&#39;, &#39;/&#39;);

            Panel1.Text = ui.Text(&quot;editscript&quot;, base.getUser());
            pp_name.Text = ui.Text(&quot;name&quot;, base.getUser());
            pp_path.Text = ui.Text(&quot;path&quot;, base.getUser());

            if (IsPostBack == false)
            {
                ClientTools
                    .SetActiveTreeType(TreeDefinitionCollection.Instance.FindTree&lt;loadScripts&gt;().Tree.Alias)
                    .SyncTree(ScriptTreeSyncPath, false);
            }
        }

        override protected void OnInit(EventArgs e)
        {
            base.OnInit(e);

            filename = Request.QueryString[&quot;file&quot;].Replace(&#39;\\&#39;, &#39;/&#39;).TrimStart(&#39;/&#39;);

            //need to change the editor type if it is XML
            if (filename.EndsWith(&quot;xml&quot;))
                editorSource.CodeBase = uicontrols.CodeArea.EditorType.XML;
            else if (filename.EndsWith(&quot;master&quot;))
                editorSource.CodeBase = uicontrols.CodeArea.EditorType.HTML;


            var editor = Panel1.NewTabPage(ui.Text(&quot;settings&quot;,&quot;script&quot;));
            editor.Controls.Add(Pane7);

            var props = Panel1.NewTabPage(ui.Text(&quot;properties&quot;));
            props.Controls.Add(Pane8);


            SaveButton = Panel1.Menu.NewButton();
            SaveButton.Text = ui.Text(&quot;save&quot;);
            SaveButton.ButtonType = MenuButtonType.Primary;
            SaveButton.ID = &quot;save&quot;;
            SaveButton.CssClass = &quot;client-side&quot;;

            if (editorSource.CodeBase == uicontrols.CodeArea.EditorType.HTML)
            {
                // Editing buttons
                Panel1.Menu.InsertSplitter();
                uicontrols.MenuIconI umbField = Panel1.Menu.NewIcon();
                umbField.ImageURL = UmbracoPath + &quot;/images/editor/insField.gif&quot;;
                umbField.OnClickCommand = BasePages.ClientTools.Scripts.OpenModalWindow(IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/umbracoField.aspx?objectId=&quot; + editorSource.ClientID + &quot;&amp;tagName=UMBRACOGETDATA&quot;, ui.Text(&quot;template&quot;, &quot;insertPageField&quot;), 640, 550);
                umbField.AltText = ui.Text(&quot;template&quot;, &quot;insertPageField&quot;);

                // TODO: Update icon
                uicontrols.MenuIconI umbDictionary = Panel1.Menu.NewIcon();
                umbDictionary.ImageURL = GlobalSettings.Path + &quot;/images/editor/dictionaryItem.gif&quot;;
                umbDictionary.OnClickCommand = BasePages.ClientTools.Scripts.OpenModalWindow(IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/umbracoField.aspx?objectId=&quot; + editorSource.ClientID + &quot;&amp;tagName=UMBRACOGETDICTIONARY&quot;, ui.Text(&quot;template&quot;, &quot;insertDictionaryItem&quot;), 640, 550);
                umbDictionary.AltText = &quot;Insert umbraco dictionary item&quot;;

                uicontrols.MenuIconI umbMacro = Panel1.Menu.NewIcon();
                umbMacro.ImageURL = UmbracoPath + &quot;/images/editor/insMacro.gif&quot;;
                umbMacro.AltText = ui.Text(&quot;template&quot;, &quot;insertMacro&quot;);
                umbMacro.OnClickCommand = BasePages.ClientTools.Scripts.OpenModalWindow(IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/editMacro.aspx?objectId=&quot; + editorSource.ClientID, ui.Text(&quot;template&quot;, &quot;insertMacro&quot;), 470, 530);

                // Help
                Panel1.Menu.InsertSplitter();

                uicontrols.MenuIconI helpIcon = Panel1.Menu.NewIcon();
                helpIcon.OnClickCommand = umbraco.BasePages.ClientTools.Scripts.OpenModalWindow(Umbraco.Core.IO.IOHelper.ResolveUrl(Umbraco.Core.IO.SystemDirectories.Umbraco) + &quot;/settings/modals/showumbracotags.aspx?alias=&quot;, ui.Text(&quot;template&quot;, &quot;quickGuide&quot;), 600, 580);
                helpIcon.ImageURL = UmbracoPath + &quot;/images/editor/help.png&quot;;
                helpIcon.AltText = ui.Text(&quot;template&quot;, &quot;quickGuide&quot;);

            }

        }

        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);
            ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/codeEditorSave.asmx&quot;));
            ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/legacyAjaxCalls.asmx&quot;));
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,28,0],[26,9,26,10,0],[27,13,27,72,0],[29,9,29,10,0],[45,47,45,51,0],[45,52,45,64,0],[48,9,48,10,0],[49,13,49,28,0],[59,13,59,72,0],[60,13,60,57,0],[61,13,61,32,0],[62,17,62,92,0],[64,13,64,150,0],[65,13,65,48,0],[66,13,66,77,0],[69,13,69,60,0],[71,13,71,65,0],[72,13,72,60,0],[73,13,73,60,0],[75,13,75,37,0],[76,13,76,14,0],[77,17,79,58,0],[80,13,80,14,0],[81,9,81,10,0],[84,9,84,10,0],[85,13,85,28,0],[87,13,87,86,0],[90,13,90,42,0],[91,17,91,76,0],[92,18,92,50,0],[93,17,93,77,0],[96,13,96,74,0],[97,13,97,40,0],[99,13,99,66,0],[100,13,100,39,0],[103,13,103,50,0],[104,13,104,47,0],[105,13,105,60,0],[106,13,106,36,0],[107,13,107,49,0],[109,13,109,78,0],[110,13,110,14,0],[112,17,112,46,0],[113,17,113,71,0],[114,17,114,81,0],[115,17,115,280,0],[116,17,116,75,0],[119,17,119,76,0],[120,17,120,100,0],[121,17,121,296,0],[122,17,122,74,0],[124,17,124,71,0],[125,17,125,81,0],[126,17,126,71,0],[127,17,127,245,0],[130,17,130,46,0],[132,17,132,71,0],[133,17,133,271,0],[134,17,134,77,0],[135,17,135,70,0],[137,13,137,14,0],[139,9,139,10,0],[142,9,142,10,0],[143,13,143,33,0],[144,13,144,117,0],[145,13,145,118,0],[146,9,146,10,0]]);
    </script>
  </body>
</html>