<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Cache\DeepCloneRuntimeCacheProviderTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.Reflection;
using System.Web;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Collections;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Tests.Collections;

namespace Umbraco.Tests.Cache
{
    [TestFixture]
    public class DeepCloneRuntimeCacheProviderTests : RuntimeCacheProviderTests
    {
        private DeepCloneRuntimeCacheProvider _provider;

        protected override int GetTotalItemCount
        {
            get { return HttpRuntime.Cache.Count; }
        }

        public override void Setup()
        {
            base.Setup();
            _provider = new DeepCloneRuntimeCacheProvider(new HttpRuntimeCacheProvider(HttpRuntime.Cache));
        }

        internal override ICacheProvider Provider
        {
            get { return _provider; }
        }

        internal override IRuntimeCacheProvider RuntimeProvider
        {
            get { return _provider; }
        }

        [Test]
        public void Clones_List()
        {
            var original = new DeepCloneableList&lt;DeepCloneableListTests.TestClone&gt;(ListCloneBehavior.Always);
            original.Add(new DeepCloneableListTests.TestClone());
            original.Add(new DeepCloneableListTests.TestClone());
            original.Add(new DeepCloneableListTests.TestClone());

            var val = _provider.GetCacheItem&lt;DeepCloneableList&lt;DeepCloneableListTests.TestClone&gt;&gt;(&quot;test&quot;, () =&gt; original);

            Assert.AreEqual(original.Count, val.Count);
            foreach (var item in val)
            {
                Assert.IsTrue(item.IsClone);
            }
        }

        [Test]
        public void Ensures_Cloned_And_Reset()
        {
            var original = new TestClass()
            {
                Name = &quot;hello&quot;
            };
            Assert.IsTrue(original.IsDirty());

            var val = _provider.GetCacheItem&lt;TestClass&gt;(&quot;test&quot;, () =&gt; original);
            
            Assert.AreNotEqual(original.CloneId, val.CloneId);
            Assert.IsFalse(val.IsDirty());
        }

        [Test]
        public void DoesNotCacheExceptions()
        {
            string value;
            Assert.Throws&lt;Exception&gt;(() =&gt; { value = (string)_provider.GetCacheItem(&quot;key&quot;, () =&gt; GetValue(1)); });
            Assert.Throws&lt;Exception&gt;(() =&gt; { value = (string)_provider.GetCacheItem(&quot;key&quot;, () =&gt; GetValue(2)); });

            // does not throw
            value = (string)_provider.GetCacheItem(&quot;key&quot;, () =&gt; GetValue(3));
            Assert.AreEqual(&quot;succ3&quot;, value);

            // cache
            value = (string)_provider.GetCacheItem(&quot;key&quot;, () =&gt; GetValue(4));
            Assert.AreEqual(&quot;succ3&quot;, value);
        }

        private static string GetValue(int i)
        {
            Debug.Print(&quot;get&quot; + i);
            if (i &lt; 3)
                throw new Exception(&quot;fail&quot;);
            return &quot;succ&quot; + i;
        }

        private class TestClass : TracksChangesEntityBase, IDeepCloneable
        {
            public TestClass()
            {
                CloneId = Guid.NewGuid();
            }

            private static readonly Lazy&lt;PropertySelectors&gt; Ps = new Lazy&lt;PropertySelectors&gt;();

            private class PropertySelectors
            {
                public readonly PropertyInfo WriterSelector = ExpressionHelper.GetPropertyInfo&lt;Content, string&gt;(x =&gt; x.Name);
            }

            private string _name;
            public string Name
            {
                get { return _name; }
                set { SetPropertyValueAndDetectChanges(value, ref _name, Ps.Value.WriterSelector); }
            }

            public Guid CloneId { get; set; }

            public object DeepClone()
            {
                var shallowClone = (TestClass)MemberwiseClone();
                DeepCloneHelper.DeepCloneRefProperties(this, shallowClone);
                shallowClone.CloneId = Guid.NewGuid();
                return shallowClone;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,17,23,18,1],[23,19,23,50,1],[23,51,23,52,1],[27,9,27,10,1],[28,13,28,26,1],[29,13,29,108,1],[30,9,30,10,1],[34,17,34,18,1],[34,19,34,36,1],[34,37,34,38,1],[39,17,39,18,1],[39,19,39,36,1],[39,37,39,38,1],[44,9,44,10,1],[45,13,45,110,1],[46,13,46,66,1],[47,13,47,66,1],[48,13,48,66,1],[50,13,50,113,1],[50,113,50,121,1],[50,121,50,123,1],[50,13,50,123,1],[52,13,52,56,1],[53,13,53,20,1],[53,22,53,30,1],[53,31,53,33,1],[53,34,53,37,1],[54,13,54,14,1],[55,17,55,45,1],[56,13,56,14,1],[57,9,57,10,1],[61,9,61,10,1],[62,13,65,15,1],[66,13,66,47,1],[68,13,68,71,1],[68,71,68,79,1],[68,79,68,81,1],[68,13,68,81,1],[70,13,70,63,1],[71,13,71,43,1],[72,9,72,10,1],[76,9,76,10,1],[78,13,78,44,1],[78,44,78,45,1],[78,45,78,46,1],[78,46,78,98,1],[78,98,78,109,1],[78,109,78,111,1],[78,46,78,111,1],[78,111,78,112,1],[78,112,78,113,0],[78,113,78,115,1],[78,13,78,115,1],[79,13,79,44,1],[79,44,79,45,1],[79,45,79,46,1],[79,46,79,98,1],[79,98,79,109,1],[79,109,79,111,1],[79,46,79,111,1],[79,111,79,112,1],[79,112,79,113,0],[79,113,79,115,1],[79,13,79,115,1],[82,13,82,65,1],[82,65,82,76,1],[82,76,82,78,1],[82,13,82,78,1],[83,13,83,45,1],[86,13,86,65,1],[86,65,86,76,0],[86,76,86,78,1],[86,13,86,78,1],[87,13,87,45,1],[88,9,88,10,1],[91,9,91,10,1],[92,13,92,36,1],[93,13,93,23,1],[94,17,94,45,1],[95,13,95,31,1],[96,9,96,10,1],[100,13,100,31,1],[101,13,101,14,1],[102,17,102,42,1],[103,13,103,14,1],[105,13,105,96,1],[109,17,109,126,1],[115,21,115,22,0],[115,23,115,36,0],[115,37,115,38,0],[116,21,116,22,1],[116,23,116,99,1],[116,100,116,101,1],[119,35,119,39,1],[119,40,119,44,1],[122,13,122,14,1],[123,17,123,65,1],[124,17,124,76,1],[125,17,125,55,1],[126,17,126,37,1],[127,13,127,14,1]]);
    </script>
  </body>
</html>