<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\PermissionRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Dynamic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Web.Caching;
using Umbraco.Core.Events;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Core.Services;
using CacheKeys = Umbraco.Core.Cache.CacheKeys;
using Umbraco.Core.Cache;

namespace Umbraco.Core.Persistence.Repositories
{
    /// &lt;summary&gt;
    /// A repository that exposes functionality to modify assigned permissions to a node
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;TEntity&quot;&gt;&lt;/typeparam&gt;
    internal class PermissionRepository&lt;TEntity&gt;
        where TEntity : class, IAggregateRoot
    {
        private readonly IDatabaseUnitOfWork _unitOfWork;
        private readonly IRuntimeCacheProvider _runtimeCache;
        private readonly ISqlSyntaxProvider _sqlSyntax;

        internal PermissionRepository(IDatabaseUnitOfWork unitOfWork, CacheHelper cache, ISqlSyntaxProvider sqlSyntax)
        {
            _unitOfWork = unitOfWork;
            //Make this repository use an isolated cache
            _runtimeCache = cache.IsolatedRuntimeCache.GetOrCreateCache&lt;EntityPermission&gt;();
            _sqlSyntax = sqlSyntax;
        }

        /// &lt;summary&gt;
        /// Returns permissions for a given user for any number of nodes
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;entityIds&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;        
        public IEnumerable&lt;EntityPermission&gt; GetUserPermissionsForEntities(int userId, params int[] entityIds)
        {
            var entityIdKey = string.Join(&quot;,&quot;, entityIds.Select(x =&gt; x.ToString(CultureInfo.InvariantCulture)));
            return _runtimeCache.GetCacheItem&lt;IEnumerable&lt;EntityPermission&gt;&gt;(
                string.Format(&quot;{0}{1}{2}&quot;, CacheKeys.UserPermissionsCacheKey, userId, entityIdKey),
                () =&gt;
        {            

                    var whereBuilder = new StringBuilder();
            
                    //where userId = @userId AND
                    whereBuilder.Append(_sqlSyntax.GetQuotedColumnName(&quot;userId&quot;));
                    whereBuilder.Append(&quot;=&quot;);
                    whereBuilder.Append(userId);

                    if (entityIds.Any())
                    {
                        whereBuilder.Append(&quot; AND &quot;);

                        //where nodeId = @nodeId1 OR nodeId = @nodeId2, etc...
                        whereBuilder.Append(&quot;(&quot;);
                        for (var index = 0; index &lt; entityIds.Length; index++)
                        {
                            var entityId = entityIds[index];
                            whereBuilder.Append(_sqlSyntax.GetQuotedColumnName(&quot;nodeId&quot;));
                            whereBuilder.Append(&quot;=&quot;);
                            whereBuilder.Append(entityId);
                            if (index &lt; entityIds.Length - 1)
                            {
                                whereBuilder.Append(&quot; OR &quot;);
                            }
                        }
                        whereBuilder.Append(&quot;)&quot;);
                    }

                    var sql = new Sql();
                    sql.Select(&quot;*&quot;)
                        .From&lt;User2NodePermissionDto&gt;()
                        .Where(whereBuilder.ToString());

                    //ToArray() to ensure it&#39;s all fetched from the db once.
                    var result = _unitOfWork.Database.Fetch&lt;User2NodePermissionDto&gt;(sql).ToArray();
                    return ConvertToPermissionList(result);

                },
                //Since this cache can be quite large (http://issues.umbraco.org/issue/U4-2161) we will only have this exist in cache for 20 minutes, 
                // then it will refresh from the database.
                new TimeSpan(0, 20, 0),
                //Since this cache can be quite large (http://issues.umbraco.org/issue/U4-2161) we will make this priority below average
                priority: CacheItemPriority.BelowNormal);

        } 

        /// &lt;summary&gt;
        /// Returns permissions for all users for a given entity
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;entityId&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;EntityPermission&gt; GetPermissionsForEntity(int entityId)
        {
            var sql = new Sql();
            sql.Select(&quot;*&quot;)
               .From&lt;User2NodePermissionDto&gt;()
               .Where&lt;User2NodePermissionDto&gt;(dto =&gt; dto.NodeId == entityId)
               .OrderBy&lt;User2NodePermissionDto&gt;(dto =&gt; dto.NodeId);

            //ToArray() to ensure it&#39;s all fetched from the db once.
            var result = _unitOfWork.Database.Fetch&lt;User2NodePermissionDto&gt;(sql).ToArray();
            return ConvertToPermissionList(result);
        }

        /// &lt;summary&gt;
        /// Assigns the same permission set for a single user to any number of entities
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;permissions&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;entityIds&quot;&gt;&lt;/param&gt;
        /// &lt;remarks&gt;
        /// This will first clear the permissions for this user and entities and recreate them
        /// &lt;/remarks&gt;
        public void ReplaceUserPermissions(int userId, IEnumerable&lt;char&gt; permissions, params int[] entityIds)
        {
            var db = _unitOfWork.Database;
            using (var trans = db.GetTransaction())
            {
                //we need to batch these in groups of 2000 so we don&#39;t exceed the max 2100 limit
                foreach (var idGroup in entityIds.InGroupsOf(2000))
                {
                    db.Execute(&quot;DELETE FROM umbracoUser2NodePermission WHERE userId=@userId AND nodeId in (@nodeIds)&quot;,
                        new { userId = userId, nodeIds = idGroup });
                }

                var toInsert = new List&lt;User2NodePermissionDto&gt;();
                foreach (var p in permissions)
                {
                    foreach (var e in entityIds)
                    {
                        toInsert.Add(new User2NodePermissionDto
                        {
                            NodeId = e,
                            Permission = p.ToString(CultureInfo.InvariantCulture),
                            UserId = userId
                        });
                    }
                }

                _unitOfWork.Database.BulkInsertRecords(toInsert, trans);

                trans.Complete();

                //Raise the event
                AssignedPermissions.RaiseEvent(
                    new SaveEventArgs&lt;EntityPermission&gt;(ConvertToPermissionList(toInsert), false), this);
            }
        }

        /// &lt;summary&gt;
        /// Assigns one permission for a user to many entities
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;permission&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;entityIds&quot;&gt;&lt;/param&gt;
        public void AssignUserPermission(int userId, char permission, params int[] entityIds)
        {
            var db = _unitOfWork.Database;
            using (var trans = db.GetTransaction())
            {
                db.Execute(&quot;DELETE FROM umbracoUser2NodePermission WHERE userId=@userId AND permission=@permission AND nodeId in (@entityIds)&quot;,
                    new
                    {
                        userId = userId,
                        permission = permission.ToString(CultureInfo.InvariantCulture),
                        entityIds = entityIds
                    });

                var actions = entityIds.Select(id =&gt; new User2NodePermissionDto
                {
                    NodeId = id,
                    Permission = permission.ToString(CultureInfo.InvariantCulture),
                    UserId = userId
                }).ToArray();

                _unitOfWork.Database.BulkInsertRecords(actions, trans);

                trans.Complete();

                //Raise the event
                AssignedPermissions.RaiseEvent(
                    new SaveEventArgs&lt;EntityPermission&gt;(ConvertToPermissionList(actions), false), this);
            }
        } 

        /// &lt;summary&gt;
        /// Assigns one permission to an entity for multiple users
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;entity&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;permission&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;userIds&quot;&gt;&lt;/param&gt;
        public void AssignEntityPermission(TEntity entity, char permission, IEnumerable&lt;int&gt; userIds)
        {
            var db = _unitOfWork.Database;
            using (var trans = db.GetTransaction())
            {
                db.Execute(&quot;DELETE FROM umbracoUser2NodePermission WHERE nodeId=@nodeId AND permission=@permission AND userId in (@userIds)&quot;,
                    new
                    {
                        nodeId = entity.Id, 
                        permission = permission.ToString(CultureInfo.InvariantCulture),
                        userIds = userIds
                    });

                var actions = userIds.Select(id =&gt; new User2NodePermissionDto
                {
                    NodeId = entity.Id,
                    Permission = permission.ToString(CultureInfo.InvariantCulture),
                    UserId = id
                }).ToArray();

                _unitOfWork.Database.BulkInsertRecords(actions, trans);

                trans.Complete();

                //Raise the event
                AssignedPermissions.RaiseEvent(
                    new SaveEventArgs&lt;EntityPermission&gt;(ConvertToPermissionList(actions), false), this);
            }
        }

        /// &lt;summary&gt;
        /// Assigns permissions to an entity for multiple users/permission entries
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;permissionSet&quot;&gt;
        /// &lt;/param&gt;
        /// &lt;remarks&gt;
        /// This will first clear the permissions for this entity then re-create them
        /// &lt;/remarks&gt;
        public void ReplaceEntityPermissions(EntityPermissionSet permissionSet)
        {
            var db = _unitOfWork.Database;
            using (var trans = db.GetTransaction())
            {
                db.Execute(&quot;DELETE FROM umbracoUser2NodePermission WHERE nodeId=@nodeId&quot;, new { nodeId = permissionSet.EntityId });

                var actions = permissionSet.UserPermissionsSet.Select(p =&gt; new User2NodePermissionDto
                {
                    NodeId = permissionSet.EntityId,
                    Permission = p.Permission,
                    UserId = p.UserId
                }).ToArray();

                _unitOfWork.Database.BulkInsertRecords(actions, trans);

                trans.Complete();

                //Raise the event
                AssignedPermissions.RaiseEvent(
                    new SaveEventArgs&lt;EntityPermission&gt;(ConvertToPermissionList(actions), false), this);
            }            
        }

        private static IEnumerable&lt;EntityPermission&gt; ConvertToPermissionList(IEnumerable&lt;User2NodePermissionDto&gt; result)
        {
            var permissions = new List&lt;EntityPermission&gt;();
            var nodePermissions = result.GroupBy(x =&gt; x.NodeId);
            foreach (var np in nodePermissions)
            {
                var userPermissions = np.GroupBy(x =&gt; x.UserId);
                foreach (var up in userPermissions)
                {
                    var perms = up.Select(x =&gt; x.Permission).ToArray();
                    permissions.Add(new EntityPermission(up.Key, up.First().NodeId, perms));
                }
            }
            return permissions;
        }

        public static event TypedEventHandler&lt;PermissionRepository&lt;TEntity&gt;, SaveEventArgs&lt;EntityPermission&gt;&gt; AssignedPermissions;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[32,9,32,119,1],[33,9,33,10,1],[34,13,34,38,1],[36,13,36,93,1],[37,13,37,36,1],[38,9,38,10,1],[47,9,47,10,1],[48,13,48,70,1],[48,70,48,110,1],[48,110,48,113,1],[48,13,48,113,1],[49,13,52,9,1],[52,9,52,10,1],[52,10,54,21,1],[54,21,54,60,1],[54,60,57,21,1],[57,21,57,83,1],[57,83,58,21,1],[58,21,58,46,1],[58,46,59,21,1],[59,21,59,49,1],[59,49,61,21,1],[61,21,61,41,1],[61,41,62,21,1],[62,21,62,22,1],[62,22,63,25,1],[63,25,63,54,1],[63,54,66,25,1],[66,25,66,50,1],[66,50,67,30,1],[67,30,67,43,1],[67,43,67,45,1],[67,45,67,69,1],[67,69,67,71,1],[67,71,67,78,1],[67,78,68,25,1],[68,25,68,26,1],[68,26,69,29,1],[69,29,69,61,1],[69,61,70,29,1],[70,29,70,91,1],[70,91,71,29,1],[71,29,71,54,1],[71,54,72,29,1],[72,29,72,59,1],[72,59,73,29,1],[73,29,73,62,1],[73,62,74,29,1],[74,29,74,30,1],[74,30,75,33,1],[75,33,75,61,1],[75,61,76,29,1],[76,29,76,30,1],[76,30,77,25,1],[77,25,77,26,1],[77,26,78,25,1],[78,25,78,50,1],[78,50,79,21,1],[79,21,79,22,1],[79,22,81,21,1],[81,21,81,41,1],[81,41,82,21,1],[82,21,84,57,1],[84,57,87,21,1],[87,21,87,100,1],[87,100,88,21,1],[88,21,88,60,1],[88,60,90,17,1],[90,17,90,18,1],[90,18,95,58,1],[49,13,95,58,1],[97,9,97,10,1],[105,9,105,10,1],[106,13,106,33,1],[107,13,110,68,1],[113,13,113,92,1],[114,13,114,52,1],[115,9,115,10,1],[127,9,127,10,0],[128,13,128,43,0],[129,20,129,51,0],[130,13,130,14,0],[132,17,132,24,0],[132,26,132,37,0],[132,38,132,40,0],[132,41,132,67,0],[133,17,133,18,0],[134,21,135,69,0],[136,17,136,18,0],[138,17,138,67,0],[139,17,139,24,0],[139,26,139,31,0],[139,32,139,34,0],[139,35,139,46,0],[140,17,140,18,0],[141,21,141,28,0],[141,30,141,35,0],[141,36,141,38,0],[141,39,141,48,0],[142,21,142,22,0],[143,25,148,28,0],[149,21,149,22,0],[150,17,150,18,0],[152,17,152,73,0],[154,17,154,34,0],[157,17,158,106,0],[159,13,159,14,0],[160,9,160,10,0],[169,9,169,10,0],[170,13,170,43,0],[171,20,171,51,0],[172,13,172,14,0],[173,17,179,24,0],[181,17,181,54,0],[181,54,186,18,0],[186,18,186,30,0],[181,17,186,30,0],[188,17,188,72,0],[190,17,190,34,0],[193,17,194,105,0],[195,13,195,14,0],[196,9,196,10,0],[205,9,205,10,1],[206,13,206,43,1],[207,20,207,51,1],[208,13,208,14,1],[209,17,215,24,1],[217,17,217,52,1],[217,52,222,18,1],[222,18,222,30,1],[217,17,222,30,1],[224,17,224,72,1],[226,17,226,34,1],[229,17,230,105,1],[231,13,231,14,1],[232,9,232,10,1],[243,9,243,10,1],[244,13,244,43,1],[245,20,245,51,1],[246,13,246,14,1],[247,17,247,132,1],[249,17,249,76,1],[249,76,254,18,1],[254,18,254,30,1],[249,17,254,30,1],[256,17,256,72,1],[258,17,258,34,1],[261,17,262,105,1],[263,13,263,14,1],[264,9,264,10,1],[267,9,267,10,1],[268,13,268,60,1],[269,13,269,55,1],[269,55,269,63,1],[269,63,269,65,1],[269,13,269,65,1],[270,13,270,20,1],[270,22,270,28,1],[270,29,270,31,1],[270,32,270,47,1],[271,13,271,14,1],[272,17,272,55,1],[272,55,272,63,1],[272,63,272,65,1],[272,17,272,65,1],[273,17,273,24,1],[273,26,273,32,1],[273,33,273,35,1],[273,36,273,51,1],[274,17,274,18,1],[275,21,275,48,1],[275,48,275,60,1],[275,60,275,72,1],[275,21,275,72,1],[276,21,276,93,1],[277,17,277,18,1],[278,13,278,14,1],[279,13,279,32,1],[280,9,280,10,1]]);
    </script>
  </body>
</html>