<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\SQLCE4Umbraco\SqlCEInstaller.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/************************************************************************************
 * 
 *  Umbraco Data Layer
 *  MIT Licensed work
 *  ï¿½2008 Ruben Verborgh
 * 
 ***********************************************************************************/

using System;
using System.Resources;
using SQLCE4Umbraco;
using umbraco.DataLayer.Utility.Installer;
using System.Diagnostics;

namespace SqlCE4Umbraco
{
    /// &lt;summary&gt;
    /// Database installer for an SQL Server data source.
    /// &lt;/summary&gt;
    [Obsolete(&quot;The legacy installers are no longer used and will be removed from the codebase in the future&quot;)]
    public class SqlCEInstaller : DefaultInstallerUtility&lt;SqlCEHelper&gt;
    {
        #region Private Constants

        /// &lt;summary&gt;The latest database version this installer supports.&lt;/summary&gt;
        private const DatabaseVersion LatestVersionSupported = DatabaseVersion.Version4_8;

        /// &lt;summary&gt;The specifications to determine the database version.&lt;/summary&gt;
        private static readonly VersionSpecs[] m_VersionSpecs = new VersionSpecs[] {
                    new VersionSpecs(&quot;SELECT CONSTRAINT_NAME FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS LEFT OUTER JOIN umbracoApp ON appAlias = appAlias WHERE CONSTRAINT_NAME = &#39;FK_umbracoUser2app_umbracoApp&#39;&quot;, 0, DatabaseVersion.Version4_8),
                    new VersionSpecs(&quot;SELECT id FROM umbracoNode WHERE id = -21&quot;, 1, DatabaseVersion.Version4_1),
                    new VersionSpecs(&quot;SELECT action FROM umbracoAppTree&quot;,DatabaseVersion.Version4),
                    new VersionSpecs(&quot;SELECT description FROM cmsContentType&quot;,DatabaseVersion.Version3),
                    new VersionSpecs(&quot;SELECT id FROM sysobjects&quot;,DatabaseVersion.None) };

        #endregion

        #region Public Properties

        /// &lt;summary&gt;
        /// This ensures that the database exists, then runs the base method
        /// &lt;/summary&gt;
        public override bool CanConnect
        {
            get
            {
                using (var sqlHelper = SqlHelper)
                    sqlHelper.CreateEmptyDatabase();
                return base.CanConnect;
            }
        }

        /// &lt;summary&gt;
        /// Gets a value indicating whether the installer can upgrade the data source.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// 	&lt;c&gt;true&lt;/c&gt; if the installer can upgrade the data source; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/value&gt;
        /// &lt;remarks&gt;Empty data sources can&#39;t be upgraded, just installed.&lt;/remarks&gt;
        public override bool CanUpgrade
        {
            get
            {
                return CurrentVersion == DatabaseVersion.Version4_1;
            }
        }

        #endregion

        #region Protected Properties

        /// &lt;summary&gt;
        /// Gets the version specification for evaluation by DetermineCurrentVersion.
        /// Only first matching specification is taken into account.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The version specifications.&lt;/value&gt;
        protected override VersionSpecs[] VersionSpecs
        {
            get { return m_VersionSpecs; }
        }

        #endregion

        #region Public Constructors

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;SqlCEInstaller&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sqlHelper&quot;&gt;The SQL helper.&lt;/param&gt;
        public SqlCEInstaller(SqlCEHelper sqlHelper) : base(sqlHelper, LatestVersionSupported)
        { }

        #endregion

        #region DefaultInstaller Members       

        /// &lt;summary&gt;
        /// Returns the sql to do a full install
        /// &lt;/summary&gt;
        protected override string FullInstallSql
        {
            get { return string.Empty; }
        }


        /// &lt;summary&gt;
        /// Returns the sql to do an upgrade
        /// &lt;/summary&gt;
        protected override string UpgradeSql
        {
            get { return string.Empty; }
        }

        // We need to override this as the default way of detection a db connection checks for systables that doesn&#39;t exist
        // in a CE db
        protected override DatabaseVersion DetermineCurrentVersion()
        {
            DatabaseVersion version = base.DetermineCurrentVersion();
            if (version != DatabaseVersion.Unavailable)
            {
                return version;
            }

            // verify connection
            try
            {
                using (var sqlHelper = SqlHelper)
                    if (SqlCeApplicationBlock.VerifyConnection(sqlHelper.ConnectionString))
                        return DatabaseVersion.None;
            }
            catch (Exception e)
            {
                Trace.WriteLine(e.ToString());
            }

            return DatabaseVersion.Unavailable;
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,34,90,0],[46,13,46,14,0],[47,24,47,49,0],[48,21,48,53,0],[49,17,49,40,0],[50,13,50,14,0],[63,13,63,14,0],[64,17,64,69,0],[65,13,65,14,0],[79,17,79,18,0],[79,19,79,41,0],[79,42,79,43,0],[90,56,90,95,0],[91,9,91,10,0],[91,11,91,12,0],[102,17,102,18,0],[102,19,102,39,0],[102,40,102,41,0],[111,17,111,18,0],[111,19,111,39,0],[111,40,111,41,0],[117,9,117,10,0],[118,13,118,70,0],[119,13,119,56,0],[120,13,120,14,0],[121,17,121,32,0],[126,13,126,14,0],[127,24,127,49,0],[128,21,128,92,0],[129,25,129,53,0],[130,13,130,14,0],[131,13,131,32,0],[132,13,132,14,0],[133,17,133,47,0],[134,13,134,14,0],[136,13,136,48,0],[137,9,137,10,0]]);
    </script>
  </body>
</html>