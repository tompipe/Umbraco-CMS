<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\users\EditUserType.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using umbraco.BasePages;
using System.Collections.Generic;
using umbraco.interfaces;
using umbraco.BusinessLogic.Actions;
using umbraco.BusinessLogic;
using umbraco.uicontrols;
using umbraco.cms.presentation.Trees;
using Umbraco.Core.IO;

namespace umbraco.cms.presentation.user
{
    public partial class EditUserType : UmbracoEnsuredPage
    {
        public EditUserType()
        {
            CurrentApp = BusinessLogic.DefaultApps.users.ToString();
        }
        protected void Page_Load(object sender, EventArgs e)
        {
            pnlUmbraco.Text = umbraco.ui.Text(&quot;usertype&quot;, base.getUser());

            var save = pnlUmbraco.Menu.NewButton();
            save.Click += save_Click;
            save.ID = &quot;save&quot;;
            save.ToolTip = ui.Text(&quot;save&quot;);
            save.Text = ui.Text(&quot;save&quot;);

            pp_alias.Text = umbraco.ui.Text(&quot;usertype&quot;, base.getUser()) + &quot; &quot; + umbraco.ui.Text(&quot;alias&quot;, base.getUser());
            pp_name.Text = umbraco.ui.Text(&quot;usertype&quot;, base.getUser()) + &quot; &quot; + umbraco.ui.Text(&quot;name&quot;, base.getUser());

            pp_rights.Text = umbraco.ui.Text(&quot;default&quot;, base.getUser()) + &quot; &quot; + umbraco.ui.Text(&quot;rights&quot;, base.getUser());
            
            //ensure we have a query string
            if (string.IsNullOrEmpty(Request.QueryString[&quot;id&quot;]))
                return;
            //ensuer it is an integer
            if (!int.TryParse(Request.QueryString[&quot;id&quot;], out m_userTypeID))
                return;

			if (!IsPostBack)
			{
				BindActions();

				ClientTools
					.SetActiveTreeType(TreeDefinitionCollection.Instance.FindTree&lt;UserTypes&gt;().Tree.Alias)
					.SyncTree(m_userTypeID.ToString(), false);
			}

        }

        void save_Click(object sender, EventArgs e)
        {
            UserType userType = CurrentUserType;
            userType.Name = txtUserTypeName.Text;
            string actions = &quot;&quot;;

            foreach (ListItem li in cbl_rights.Items) {
                if (li.Selected)
                    actions += li.Value;
            }

            userType.DefaultPermissions = actions;
            userType.Save();

            ClientTools.ShowSpeechBubble(speechBubbleIcon.save, ui.Text(&quot;speechBubbles&quot;, &quot;editUserTypeSaved&quot;, base.getUser()), &quot;&quot;);
        }

        protected List&lt;IAction&gt; CurrentUserTypeActions
        {
            get
            {
                if (m_userTypeActions == null)
                    m_userTypeActions = umbraco.BusinessLogic.Actions.Action.FromString(CurrentUserType.DefaultPermissions);
                return m_userTypeActions;
            }
        }

        protected UserType CurrentUserType
        {
            get
            {
                if (m_userType == null)
                    m_userType = UserType.GetUserType(m_userTypeID);
                return m_userType;
            }
        }
        private UserType m_userType;
        private List&lt;IAction&gt; m_userTypeActions;
        private int m_userTypeID;

        private void BindActions()
        {
            lblUserTypeAlias.Text = CurrentUserType.Alias;
            txtUserTypeName.Text = CurrentUserType.Name;
            hidUserTypeID.Value = CurrentUserType.Id.ToString();

            foreach (IAction ai in global::umbraco.BusinessLogic.Actions.Action.GetPermissionAssignable()) {

                ListItem li = new ListItem(umbraco.ui.Text(ai.Alias, base.getUser()), ai.Letter.ToString());

                if(CurrentUserTypeActions.Contains(ai))
                    li.Selected = true;

                cbl_rights.Items.Add(li);
            }
        }


        
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,30,0],[25,9,25,10,0],[26,13,26,69,0],[27,9,27,10,0],[29,9,29,10,0],[30,13,30,75,0],[32,13,32,52,0],[33,13,33,38,0],[34,13,34,30,0],[35,13,35,44,0],[36,13,36,41,0],[38,13,38,122,0],[39,13,39,120,0],[41,13,41,123,0],[44,13,44,65,0],[45,17,45,24,0],[47,13,47,76,0],[48,17,48,24,0],[50,4,50,20,0],[51,4,51,5,0],[52,5,52,19,0],[54,5,56,48,0],[57,4,57,5,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,49,0],[64,13,64,50,0],[65,13,65,33,0],[67,13,67,20,0],[67,22,67,33,0],[67,34,67,36,0],[67,37,67,53,0],[67,55,67,56,0],[68,17,68,33,0],[69,21,69,41,0],[70,13,70,14,0],[72,13,72,51,0],[73,13,73,29,0],[75,13,75,132,0],[76,9,76,10,0],[81,13,81,14,0],[82,17,82,47,0],[83,21,83,125,0],[84,17,84,42,0],[85,13,85,14,0],[91,13,91,14,0],[92,17,92,40,0],[93,21,93,69,0],[94,17,94,35,0],[95,13,95,14,0],[102,9,102,10,0],[103,13,103,59,0],[104,13,104,57,0],[105,13,105,65,0],[107,13,107,20,0],[107,22,107,32,0],[107,33,107,35,0],[107,36,107,106,0],[107,108,107,109,0],[109,17,109,109,0],[111,17,111,56,0],[112,21,112,40,0],[114,17,114,42,0],[115,13,115,14,0],[116,9,116,10,0]]);
    </script>
  </body>
</html>