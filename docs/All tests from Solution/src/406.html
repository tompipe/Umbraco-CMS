<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\create\PartialViewTasksBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Web;
using Umbraco.Core.CodeAnnotations;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Web;
using Umbraco.Web.UI;
using umbraco.BasePages;
using Umbraco.Core;

namespace umbraco
{
    /// &lt;summary&gt;
    /// The base UI &#39;tasks&#39; for the create dialog and delete processes
    /// &lt;/summary&gt;
    [UmbracoWillObsolete(&quot;http://issues.umbraco.org/issue/U4-1373&quot;, &quot;This will one day be removed when we overhaul the create process&quot;)]
    public abstract class PartialViewTasksBase : LegacyDialogTask
    {
        private string _returnUrl = string.Empty;

        public override string ReturnUrl
        {
            get { return _returnUrl; }
        }

        protected virtual string EditViewFile
        {
            get { return &quot;Settings/Views/EditView.aspx&quot;; }
        }

        protected virtual bool IsPartialViewMacro
        {
            get { return false; }
        }

        public override bool PerformSave()
        {
            var pipesIndex = Alias.IndexOf(&quot;|||&quot;, StringComparison.Ordinal);
            var snippetName = Alias.Substring(0, pipesIndex).Trim();
            var fileName = Alias.Substring(pipesIndex + 3, Alias.Length - pipesIndex - 3);
            if (fileName.ToLowerInvariant().EndsWith(&quot;.cshtml&quot;) == false)
            {
                fileName += &quot;.cshtml&quot;;
            }

            var model = new PartialView(fileName);
            var fileService = (FileService)ApplicationContext.Current.Services.FileService;
            var macroService = ApplicationContext.Current.Services.MacroService;

            if (IsPartialViewMacro == false)
            {
                var attempt = fileService.CreatePartialView(model, snippetName, User.Id);
                _returnUrl = string.Format(&quot;settings/views/EditView.aspx?treeType=partialViews&amp;file={0}&quot;, HttpUtility.UrlEncode(model.Path.TrimStart(&#39;/&#39;).Replace(&quot;\\&quot;, &quot;/&quot;)));
                return attempt.Success;
            }
            else
            {

                var attempt = fileService.CreatePartialViewMacro(model, /*ParentID == 1,*/ snippetName, User.Id);
                // if ParentId = 0 then that means that the &quot;Create macro&quot; checkbox was OFF, so don&#39;t try to create an actual macro
                // See PartialViewMacro.ascx.cs and PartialView.ascx.cs: SubmitButton_Click
                if (attempt &amp;&amp; ParentID != 0)
                {
                    //The partial view path to be saved with the macro must be a fully qualified virtual path
                    var virtualPath = string.Format(&quot;{0}/{1}/{2}&quot;, SystemDirectories.MvcViews, &quot;MacroPartials&quot;, attempt.Result.Path);
                    macroService.Save(new Macro(attempt.Result.Alias, attempt.Result.Alias) { ScriptPath = virtualPath });
                }

                _returnUrl = string.Format(&quot;settings/views/EditView.aspx?treeType=partialViewMacros&amp;file={0}&quot;, HttpUtility.UrlEncode(model.Path.TrimStart(&#39;/&#39;).Replace(&quot;\\&quot;, &quot;/&quot;)));
                return attempt.Success;
            }

        }

        public override bool PerformDelete()
        {
            var fileService = (FileService)ApplicationContext.Current.Services.FileService;

            if (IsPartialViewMacro == false)
            {
                if (Alias.Contains(&quot;.&quot;) == false)
                {
                    //there is no extension so we&#39;ll assume it&#39;s a folder
                    fileService.DeletePartialViewFolder(Alias.TrimStart(&#39;/&#39;));
                    return true;
                }
                return fileService.DeletePartialView(Alias.TrimStart(&#39;/&#39;), User.Id);
            }

            if (Alias.Contains(&quot;.&quot;) == false)
            {
                //there is no extension so we&#39;ll assume it&#39;s a folder
                fileService.DeletePartialViewMacroFolder(Alias.TrimStart(&#39;/&#39;));
                return true;
            }
            return fileService.DeletePartialViewMacro(Alias.TrimStart(&#39;/&#39;), User.Id);
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,50,1],[26,17,26,18,0],[26,19,26,37,0],[26,38,26,39,0],[31,17,31,18,0],[31,19,31,57,0],[31,58,31,59,0],[36,17,36,18,0],[36,19,36,32,0],[36,33,36,34,0],[40,9,40,10,0],[41,13,41,77,0],[42,13,42,69,0],[43,13,43,91,0],[44,13,44,74,0],[45,13,45,14,0],[46,17,46,39,0],[47,13,47,14,0],[49,13,49,51,0],[50,13,50,92,0],[51,13,51,81,0],[53,13,53,45,0],[54,13,54,14,0],[55,17,55,90,0],[56,17,56,176,0],[57,17,57,40,0],[60,13,60,14,0],[62,17,62,114,0],[65,17,65,46,0],[66,17,66,18,0],[68,21,68,134,0],[69,21,69,123,0],[70,17,70,18,0],[72,17,72,181,0],[73,17,73,40,0],[76,9,76,10,0],[79,9,79,10,0],[80,13,80,92,0],[82,13,82,45,0],[83,13,83,14,0],[84,17,84,50,0],[85,17,85,18,0],[87,21,87,79,0],[88,21,88,33,0],[90,17,90,85,0],[93,13,93,46,0],[94,13,94,14,0],[96,17,96,80,0],[97,17,97,29,0],[99,13,99,86,0],[100,9,100,10,0]]);
    </script>
  </body>
</html>