<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\webservices\TreeDataService.ashx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Formatting;
using System.Runtime.Remoting.Contexts;
using System.Web;
using System.Web.Services;
using Umbraco.Core;
using Umbraco.Web.Trees;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebServices;
using umbraco.BusinessLogic;
using umbraco.cms.presentation;
using umbraco.cms.presentation.Trees;
using System.Threading;

namespace umbraco.presentation.webservices
{
    /// &lt;summary&gt;
    /// Summary description for TreeDataService
    /// &lt;/summary&gt;
    [WebService(Namespace = &quot;http://tempuri.org/&quot;)]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    [System.ComponentModel.ToolboxItem(false)]
    public class TreeDataService : UmbracoAuthorizedHttpHandler
    {

        public override void ProcessRequest(HttpContext context)
        {
            AuthorizeRequest(true);
            context.Response.ContentType = &quot;application/json&quot;;
            context.Response.Write(GetXmlTree(context).ToString());

        }

        public override bool IsReusable
        {
            get
            {
                return false;
            }
        }

        [Obsolete(&quot;Use the base class AuthorizeRequest methods in UmbracoAuthorizedHttpHandler&quot;)]
        public static void Authorize()
        {
            if (!BasePages.BasePage.ValidateUserContextID(BasePages.BasePage.umbracoUserContextID))
                throw new Exception(&quot;Client authorization failed. User is not logged in&quot;);

        }

        /// &lt;summary&gt;
        /// Returns the an XmlTree based on the current http request
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public XmlTree GetXmlTree(HttpContext context)
        {
            var treeParams = TreeRequestParams.FromQueryStrings();

            //validate the current user for the request app!
            AuthorizeRequest(treeParams.Application, true);

            if (string.IsNullOrEmpty(treeParams.TreeType))
                if (!string.IsNullOrEmpty(treeParams.Application))
                    LoadAppTrees(treeParams, context);
                else
                    return new XmlTree(); //returns an empty tree
            else
                LoadTree(treeParams, context);

            return _xTree;
        }

        private XmlTree _xTree = new XmlTree();

        /// &lt;summary&gt;
        /// If the application supports multiple trees, then this function iterates over all of the trees assigned to it
        /// and creates their top level nodes and context menus.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;treeParams&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;context&quot;&gt;&lt;/param&gt;
        private void LoadAppTrees(TreeRequestParams treeParams, HttpContext context)
        {
            var appTrees = Services.ApplicationTreeService.GetApplicationTrees(treeParams.Application, true);
            foreach (var appTree in appTrees)
            {
                var tree = LegacyTreeDataConverter.GetLegacyTreeForLegacyServices(Services.ApplicationTreeService, appTree.Alias);
                if (tree != null)
                {
                    tree.SetTreeParameters(treeParams);
                    _xTree.Add(tree.RootNode);
                }
            }
        }

        /// &lt;summary&gt;
        /// This will load the particular ITree object and call it&#39;s render method to get the nodes that need to be rendered.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;treeParams&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;httpContext&quot;&gt;&lt;/param&gt;
        private void LoadTree(TreeRequestParams treeParams, HttpContext httpContext)
        {
            var tree = LegacyTreeDataConverter.GetLegacyTreeForLegacyServices(Services.ApplicationTreeService, treeParams.TreeType);
            if (tree != null)
            {
                tree.SetTreeParameters(treeParams);
                tree.Render(ref _xTree);
            }
            else
            {
                LoadNullTree(treeParams);
            }
            
        }

        /// &lt;summary&gt;
        /// Load an empty tree structure to show the end user that there was a problem loading the tree.
        /// &lt;/summary&gt;
        private void LoadNullTree(TreeRequestParams treeParams)
        {
            BaseTree nullTree = new NullTree(treeParams.Application);
            nullTree.SetTreeParameters(treeParams);
            nullTree.Render(ref _xTree);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,9,29,10,0],[30,13,30,36,0],[31,13,31,63,0],[32,13,32,68,0],[34,9,34,10,0],[39,13,39,14,0],[40,17,40,30,0],[41,13,41,14,0],[46,9,46,10,0],[47,13,47,100,0],[48,17,48,91,0],[50,9,50,10,0],[57,9,57,10,0],[58,13,58,67,0],[61,13,61,60,0],[63,13,63,59,0],[64,17,64,67,0],[65,21,65,55,0],[67,21,67,42,0],[69,17,69,47,0],[71,13,71,27,0],[72,9,72,10,0],[74,9,74,48,0],[83,9,83,10,0],[84,13,84,110,0],[85,13,85,20,0],[85,22,85,33,0],[85,34,85,36,0],[85,37,85,45,0],[86,13,86,14,0],[87,17,87,131,0],[88,17,88,34,0],[89,17,89,18,0],[90,21,90,56,0],[91,21,91,47,0],[92,17,92,18,0],[93,13,93,14,0],[94,9,94,10,0],[102,9,102,10,0],[103,13,103,133,0],[104,13,104,30,0],[105,13,105,14,0],[106,17,106,52,0],[107,17,107,41,0],[108,13,108,14,0],[110,13,110,14,0],[111,17,111,42,0],[112,13,112,14,0],[114,9,114,10,0],[120,9,120,10,0],[121,13,121,70,0],[122,13,122,52,0],[123,13,123,41,0],[124,9,124,10,0]]);
    </script>
  </body>
</html>