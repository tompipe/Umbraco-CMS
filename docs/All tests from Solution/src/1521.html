<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Services\EntityService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Cache;
using Umbraco.Core.CodeAnnotations;
using Umbraco.Core.Events;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Services
{
    public class EntityService : RepositoryService, IEntityService
    {
        private readonly IRuntimeCacheProvider _runtimeCache;
        private readonly Dictionary&lt;string, Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;&gt; _supportedObjectTypes;
        

        public EntityService(IDatabaseUnitOfWorkProvider provider, RepositoryFactory repositoryFactory, ILogger logger, IEventMessagesFactory eventMessagesFactory,
           IContentService contentService, IContentTypeService contentTypeService, IMediaService mediaService, IDataTypeService dataTypeService,
           IMemberService memberService, IMemberTypeService memberTypeService, IRuntimeCacheProvider runtimeCache)
            : base(provider, repositoryFactory, logger, eventMessagesFactory)
        {
            _runtimeCache = runtimeCache;
            IContentTypeService contentTypeService1 = contentTypeService;

            _supportedObjectTypes = new Dictionary&lt;string, Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;&gt;
            {
                {typeof (IDataTypeDefinition).FullName, new Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;(UmbracoObjectTypes.DataType, dataTypeService.GetDataTypeDefinitionById)},
                {typeof (IContent).FullName, new Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;(UmbracoObjectTypes.Document, contentService.GetById)},
                {typeof (IContentType).FullName, new Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;(UmbracoObjectTypes.DocumentType, contentTypeService1.GetContentType)},
                {typeof (IMedia).FullName, new Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;(UmbracoObjectTypes.Media, mediaService.GetById)},
                {typeof (IMediaType).FullName, new Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;(UmbracoObjectTypes.MediaType, contentTypeService1.GetMediaType)},
                {typeof (IMember).FullName, new Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;(UmbracoObjectTypes.Member, memberService.GetById)},
                {typeof (IMemberType).FullName, new Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;(UmbracoObjectTypes.MemberType, memberTypeService.Get)},
                //{typeof (IUmbracoEntity).FullName, new Tuple&lt;UmbracoObjectTypes, Func&lt;int, IUmbracoEntity&gt;&gt;(UmbracoObjectTypes.EntityContainer, id =&gt;
                //{
                //    using (var uow = UowProvider.GetUnitOfWork())
                //    {
                //        var found = uow.Database.FirstOrDefault&lt;NodeDto&gt;(&quot;SELECT * FROM umbracoNode WHERE id=@id&quot;, new { id = id });
                //        return found == null ? null : new UmbracoEntity(found.Trashed)
                //        {
                //            Id = found.NodeId,
                //            Name = found.Text,
                //            Key = found.UniqueId,
                //            SortOrder = found.SortOrder,
                //            Path = found.Path,
                //            NodeObjectTypeId = found.NodeObjectType.Value,
                //            CreateDate = found.CreateDate,
                //            CreatorId = found.UserId.Value,
                //            Level = found.Level,
                //            ParentId = found.ParentId
                //        };
                //    }
                    
                //})}
            };

        }

        #region Static Queries

        private IQuery&lt;IUmbracoEntity&gt; _rootEntityQuery;

        #endregion

        /// &lt;summary&gt;
        /// Returns the integer id for a given GUID
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Attempt&lt;int&gt; GetIdForKey(Guid key, UmbracoObjectTypes umbracoObjectType)
        {
            var result = _runtimeCache.GetCacheItem&lt;int?&gt;(CacheKeys.IdToKeyCacheKey + key, () =&gt;
            {
                using (var uow = UowProvider.GetUnitOfWork())
                {
                    switch (umbracoObjectType)
                    {
                        case UmbracoObjectTypes.Document:
                        case UmbracoObjectTypes.MemberType:
                        case UmbracoObjectTypes.Media:
                        case UmbracoObjectTypes.Template:
                        case UmbracoObjectTypes.MediaType:
                        case UmbracoObjectTypes.DocumentType:
                        case UmbracoObjectTypes.Member:
                        case UmbracoObjectTypes.DataType:
                        case UmbracoObjectTypes.DocumentTypeContainer:
                            return uow.Database.ExecuteScalar&lt;int?&gt;(new Sql().Select(&quot;id&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(dto =&gt; dto.UniqueId == key));
                        case UmbracoObjectTypes.RecycleBin:
                        case UmbracoObjectTypes.Stylesheet:
                        case UmbracoObjectTypes.MemberGroup:
                        case UmbracoObjectTypes.ContentItem:
                        case UmbracoObjectTypes.ContentItemType:
                        case UmbracoObjectTypes.ROOT:
                        case UmbracoObjectTypes.Unknown:
                        default:
                            throw new NotSupportedException();
                    }
                }                
            });
            return result.HasValue ? Attempt.Succeed(result.Value) : Attempt&lt;int&gt;.Fail();
        }

        /// &lt;summary&gt;
        /// Returns the GUID for a given integer id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Attempt&lt;Guid&gt; GetKeyForId(int id, UmbracoObjectTypes umbracoObjectType)
        {
            var result = _runtimeCache.GetCacheItem&lt;Guid?&gt;(CacheKeys.KeyToIdCacheKey + id, () =&gt;
            {
                using (var uow = UowProvider.GetUnitOfWork())
                {
                    switch (umbracoObjectType)
                    {
                        case UmbracoObjectTypes.Document:
                        case UmbracoObjectTypes.MemberType:
                        case UmbracoObjectTypes.Media:
                        case UmbracoObjectTypes.Template:
                        case UmbracoObjectTypes.MediaType:
                        case UmbracoObjectTypes.DocumentType:
                        case UmbracoObjectTypes.Member:
                        case UmbracoObjectTypes.DataType:
                            return uow.Database.ExecuteScalar&lt;Guid?&gt;(new Sql().Select(&quot;uniqueID&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(dto =&gt; dto.NodeId == id));
                        case UmbracoObjectTypes.RecycleBin:
                        case UmbracoObjectTypes.Stylesheet:
                        case UmbracoObjectTypes.MemberGroup:
                        case UmbracoObjectTypes.ContentItem:
                        case UmbracoObjectTypes.ContentItemType:
                        case UmbracoObjectTypes.ROOT:
                        case UmbracoObjectTypes.Unknown:
                        default:
                            throw new NotSupportedException();
                    }
                }
            });
            return result.HasValue ? Attempt.Succeed(result.Value) : Attempt&lt;Guid&gt;.Fail();
        }

        public IUmbracoEntity GetByKey(Guid key, bool loadBaseType = true)
        {
            if (loadBaseType)
            {
                using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
                {
                    return repository.GetByKey(key);
                }
            }

            //SD: TODO: Need to enable this at some stage ... just need to ask Morten what the deal is with what this does.
            throw new NotSupportedException();

            //var objectType = GetObjectType(key);
            //var entityType = GetEntityType(objectType);
            //var typeFullName = entityType.FullName;
            //var entity = _supportedObjectTypes[typeFullName].Item2(id);

            //return entity;
        }

        /// &lt;summary&gt;
        /// Gets an UmbracoEntity by its Id, and optionally loads the complete object graph.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// By default this will load the base type &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; with a minimum set of properties.
        /// &lt;/returns&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the object to retrieve&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;.&lt;/param&gt;
        /// &lt;returns&gt;An &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public virtual IUmbracoEntity Get(int id, bool loadBaseType = true)
        {
            if (loadBaseType)
            {
                using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
                {
                    return repository.Get(id);
                }
            }

            var objectType = GetObjectType(id);
            var entityType = GetEntityType(objectType);
            var typeFullName = entityType.FullName;
            var entity = _supportedObjectTypes[typeFullName].Item2(id);

            return entity;
        }

        public IUmbracoEntity GetByKey(Guid key, UmbracoObjectTypes umbracoObjectType, bool loadBaseType = true)
        {
            if (loadBaseType)
            {
                var objectTypeId = umbracoObjectType.GetGuid();
                using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
                {
                    return repository.GetByKey(key, objectTypeId);
                }
            }

            //SD: TODO: Need to enable this at some stage ... just need to ask Morten what the deal is with what this does.
            throw new NotSupportedException();

            //var entityType = GetEntityType(umbracoObjectType);
            //var typeFullName = entityType.FullName;
            //var entity = _supportedObjectTypes[typeFullName].Item2(id);

            //return entity;
        }

        /// &lt;summary&gt;
        /// Gets an UmbracoEntity by its Id and UmbracoObjectType, and optionally loads the complete object graph.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// By default this will load the base type &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; with a minimum set of properties.
        /// &lt;/returns&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the object to retrieve&lt;/param&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;UmbracoObjectType of the entity to retrieve&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;.&lt;/param&gt;
        /// &lt;returns&gt;An &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public virtual IUmbracoEntity Get(int id, UmbracoObjectTypes umbracoObjectType, bool loadBaseType = true)
        {
            if (loadBaseType)
            {
                var objectTypeId = umbracoObjectType.GetGuid();
                using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
                {
                    return repository.Get(id, objectTypeId);
                }
            }

            var entityType = GetEntityType(umbracoObjectType);
            var typeFullName = entityType.FullName;
            var entity = _supportedObjectTypes[typeFullName].Item2(id);

            return entity;
        }

        public IUmbracoEntity GetByKey&lt;T&gt;(Guid key, bool loadBaseType = true) where T : IUmbracoEntity
        {
            throw new NotImplementedException();
        }

        /// &lt;summary&gt;
        /// Gets an UmbracoEntity by its Id and specified Type. Optionally loads the complete object graph.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;
        /// By default this will load the base type &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; with a minimum set of properties.
        /// &lt;/returns&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;Type of the model to retrieve. Must be based on an &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the object to retrieve&lt;/param&gt;
        /// &lt;param name=&quot;loadBaseType&quot;&gt;Optional bool to load the complete object graph when set to &lt;c&gt;False&lt;/c&gt;.&lt;/param&gt;
        /// &lt;returns&gt;An &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public virtual IUmbracoEntity Get&lt;T&gt;(int id, bool loadBaseType = true) where T : IUmbracoEntity
        {
            if (loadBaseType)
            {
                using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
                {
                    return repository.Get(id);
                }
            }

            var typeFullName = typeof(T).FullName;
            Mandate.That&lt;NotSupportedException&gt;(_supportedObjectTypes.ContainsKey(typeFullName), () =&gt;
            {
                throw new NotSupportedException
                    (&quot;The passed in type is not supported&quot;);
            });
            var entity = _supportedObjectTypes[typeFullName].Item2(id);

            return entity;
        }

        /// &lt;summary&gt;
        /// Gets the parent of entity by its id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the entity to retrieve the Parent for&lt;/param&gt;
        /// &lt;returns&gt;An &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public virtual IUmbracoEntity GetParent(int id)
        {
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                var entity = repository.Get(id);
                if (entity.ParentId == -1 || entity.ParentId == -20 || entity.ParentId == -21)
                    return null;

                return repository.Get(entity.ParentId);
            }
        }

        /// &lt;summary&gt;
        /// Gets the parent of entity by its id and UmbracoObjectType
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the entity to retrieve the Parent for&lt;/param&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;UmbracoObjectType of the parent to retrieve&lt;/param&gt;
        /// &lt;returns&gt;An &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/returns&gt;
        public virtual IUmbracoEntity GetParent(int id, UmbracoObjectTypes umbracoObjectType)
        {
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                var entity = repository.Get(id);
                if (entity.ParentId == -1 || entity.ParentId == -20 || entity.ParentId == -21)
                    return null;

                var objectTypeId = umbracoObjectType.GetGuid();
                return repository.Get(entity.ParentId, objectTypeId);
            }
        }

        /// &lt;summary&gt;
        /// Gets a collection of children by the parents Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;Id of the parent to retrieve children for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects&lt;/returns&gt;
        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetChildren(int parentId)
        {
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                var query = Query&lt;IUmbracoEntity&gt;.Builder.Where(x =&gt; x.ParentId == parentId);
                var contents = repository.GetByQuery(query);

                return contents;
            }
        }

        /// &lt;summary&gt;
        /// Gets a collection of children by the parents Id and UmbracoObjectType
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;parentId&quot;&gt;Id of the parent to retrieve children for&lt;/param&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;UmbracoObjectType of the children to retrieve&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects&lt;/returns&gt;
        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetChildren(int parentId, UmbracoObjectTypes umbracoObjectType)
        {
            var objectTypeId = umbracoObjectType.GetGuid();
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                var query = Query&lt;IUmbracoEntity&gt;.Builder.Where(x =&gt; x.ParentId == parentId);
                var contents = repository.GetByQuery(query, objectTypeId);

                return contents;
            }
        }

        /// &lt;summary&gt;
        /// Gets a collection of descendents by the parents Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of entity to retrieve descendents for&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects&lt;/returns&gt;
        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetDescendents(int id)
        {
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                var entity = repository.Get(id);
                var pathMatch = entity.Path + &quot;,&quot;;
                var query = Query&lt;IUmbracoEntity&gt;.Builder.Where(x =&gt; x.Path.StartsWith(pathMatch) &amp;&amp; x.Id != id);
                var entities = repository.GetByQuery(query);

                return entities;
            }
        }

        /// &lt;summary&gt;
        /// Gets a collection of descendents by the parents Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of entity to retrieve descendents for&lt;/param&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;UmbracoObjectType of the descendents to retrieve&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects&lt;/returns&gt;
        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetDescendents(int id, UmbracoObjectTypes umbracoObjectType)
        {
            var objectTypeId = umbracoObjectType.GetGuid();
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                var entity = repository.Get(id);
                var query = Query&lt;IUmbracoEntity&gt;.Builder.Where(x =&gt; x.Path.StartsWith(entity.Path) &amp;&amp; x.Id != id);
                var entities = repository.GetByQuery(query, objectTypeId);

                return entities;
            }
        }

        /// &lt;summary&gt;
        /// Gets a collection of the entities at the root, which corresponds to the entities with a Parent Id of -1.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;UmbracoObjectType of the root entities to retrieve&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects&lt;/returns&gt;
        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetRootEntities(UmbracoObjectTypes umbracoObjectType)
        {
            //create it once if it is needed (no need for locking here)
            if (_rootEntityQuery == null)
            {
                _rootEntityQuery = Query&lt;IUmbracoEntity&gt;.Builder.Where(x =&gt; x.ParentId == -1);
            }

            var objectTypeId = umbracoObjectType.GetGuid();
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                var entities = repository.GetByQuery(_rootEntityQuery, objectTypeId);

                return entities;
            }
        }

        /// &lt;summary&gt;
        /// Gets a collection of all &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; of a given type.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;Type of the entities to retrieve&lt;/typeparam&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects&lt;/returns&gt;
        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetAll&lt;T&gt;(params int[] ids) where T : IUmbracoEntity
        {
            var typeFullName = typeof(T).FullName;
            Mandate.That&lt;NotSupportedException&gt;(_supportedObjectTypes.ContainsKey(typeFullName), () =&gt;
            {
                throw new NotSupportedException
                    (&quot;The passed in type is not supported&quot;);
            });
            var objectType = _supportedObjectTypes[typeFullName].Item1;

            return GetAll(objectType, ids);
        }

        /// &lt;summary&gt;
        /// Gets a collection of all &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; of a given type.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;UmbracoObjectType of the entities to return&lt;/param&gt;
        /// &lt;param name=&quot;ids&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects&lt;/returns&gt;
        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetAll(UmbracoObjectTypes umbracoObjectType, params int[] ids)
        {
            var entityType = GetEntityType(umbracoObjectType);
            var typeFullName = entityType.FullName;
            Mandate.That&lt;NotSupportedException&gt;(_supportedObjectTypes.ContainsKey(typeFullName), () =&gt;
            {
                throw new NotSupportedException
                    (&quot;The passed in type is not supported&quot;);
            });

            var objectTypeId = umbracoObjectType.GetGuid();
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(objectTypeId, ids);
            }
        }

        public IEnumerable&lt;IUmbracoEntity&gt; GetAll(UmbracoObjectTypes umbracoObjectType, Guid[] keys)
        {
            var entityType = GetEntityType(umbracoObjectType);
            var typeFullName = entityType.FullName;
            Mandate.That&lt;NotSupportedException&gt;(_supportedObjectTypes.ContainsKey(typeFullName), () =&gt;
            {
                throw new NotSupportedException
                    (&quot;The passed in type is not supported&quot;);
            });

            var objectTypeId = umbracoObjectType.GetGuid();
            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(objectTypeId, keys);
            }
        }

        /// &lt;summary&gt;
        /// Gets a collection of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;objectTypeId&quot;&gt;Guid id of the UmbracoObjectType&lt;/param&gt;
        /// &lt;param name=&quot;ids&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;An enumerable list of &lt;see cref=&quot;IUmbracoEntity&quot;/&gt; objects&lt;/returns&gt;
        public virtual IEnumerable&lt;IUmbracoEntity&gt; GetAll(Guid objectTypeId, params int[] ids)
        {
            var umbracoObjectType = UmbracoObjectTypesExtensions.GetUmbracoObjectType(objectTypeId);
            var entityType = GetEntityType(umbracoObjectType);
            var typeFullName = entityType.FullName;
            Mandate.That&lt;NotSupportedException&gt;(_supportedObjectTypes.ContainsKey(typeFullName), () =&gt;
            {
                throw new NotSupportedException
                    (&quot;The passed in type is not supported&quot;);
            });

            using (var repository = RepositoryFactory.CreateEntityRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(objectTypeId, ids);
            }
        }

        /// &lt;summary&gt;
        /// Gets the UmbracoObjectType from the integer id of an IUmbracoEntity.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the entity&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;UmbracoObjectTypes&quot;/&gt;&lt;/returns&gt;
        public virtual UmbracoObjectTypes GetObjectType(int id)
        {
            using (var uow = UowProvider.GetUnitOfWork())
            {
                var sql = new Sql().Select(&quot;nodeObjectType&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.NodeId == id);
                var nodeObjectTypeId = uow.Database.ExecuteScalar&lt;Guid&gt;(sql);
                var objectTypeId = nodeObjectTypeId;
                return UmbracoObjectTypesExtensions.GetUmbracoObjectType(objectTypeId);
            }
        }

        /// &lt;summary&gt;
        /// Gets the UmbracoObjectType from the integer id of an IUmbracoEntity.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Unique Id of the entity&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;UmbracoObjectTypes&quot;/&gt;&lt;/returns&gt;
        public virtual UmbracoObjectTypes GetObjectType(Guid key)
        {
            using (var uow = UowProvider.GetUnitOfWork())
            {
                var sql = new Sql().Select(&quot;nodeObjectType&quot;).From&lt;NodeDto&gt;().Where&lt;NodeDto&gt;(x =&gt; x.UniqueId == key);
                var nodeObjectTypeId = uow.Database.ExecuteScalar&lt;Guid&gt;(sql);
                var objectTypeId = nodeObjectTypeId;
                return UmbracoObjectTypesExtensions.GetUmbracoObjectType(objectTypeId);
            }
        }

        /// &lt;summary&gt;
        /// Gets the UmbracoObjectType from an IUmbracoEntity.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;entity&quot;&gt;&lt;see cref=&quot;IUmbracoEntity&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;UmbracoObjectTypes&quot;/&gt;&lt;/returns&gt;
        public virtual UmbracoObjectTypes GetObjectType(IUmbracoEntity entity)
        {
            var entityImpl = entity as UmbracoEntity;
            if (entityImpl == null)
                return GetObjectType(entity.Id);

            return UmbracoObjectTypesExtensions.GetUmbracoObjectType(entityImpl.NodeObjectTypeId);
        }

        /// &lt;summary&gt;
        /// Gets the Type of an entity by its Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the entity&lt;/param&gt;
        /// &lt;returns&gt;Type of the entity&lt;/returns&gt;
        public virtual Type GetEntityType(int id)
        {
            var objectType = GetObjectType(id);
            return GetEntityType(objectType);
        }

        /// &lt;summary&gt;
        /// Gets the Type of an entity by its &lt;see cref=&quot;UmbracoObjectTypes&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;umbracoObjectType&quot;&gt;&lt;see cref=&quot;UmbracoObjectTypes&quot;/&gt;&lt;/param&gt;
        /// &lt;returns&gt;Type of the entity&lt;/returns&gt;
        public virtual Type GetEntityType(UmbracoObjectTypes umbracoObjectType)
        {
            var type = typeof(UmbracoObjectTypes);
            var memInfo = type.GetMember(umbracoObjectType.ToString());
            var attributes = memInfo[0].GetCustomAttributes(typeof(UmbracoObjectTypeAttribute),
                false);

            var attribute = ((UmbracoObjectTypeAttribute)attributes[0]);
            if (attribute == null)
                throw new NullReferenceException(&quot;The passed in UmbracoObjectType does not contain an UmbracoObjectTypeAttribute, which is used to retrieve the Type.&quot;);

            if (attribute.ModelType == null)
                throw new NullReferenceException(&quot;The passed in UmbracoObjectType does not contain a Type definition&quot;);

            return attribute.ModelType;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,15,26,78,1],[27,9,27,10,1],[28,13,28,42,1],[29,13,29,74,1],[31,13,61,15,1],[63,9,63,10,1],[78,9,78,10,0],[79,13,80,13,0],[80,13,80,14,0],[80,14,81,24,0],[81,24,81,61,0],[81,61,82,17,0],[82,17,82,18,0],[82,18,83,21,0],[83,21,83,47,0],[83,47,94,29,0],[94,29,94,152,0],[94,152,103,29,0],[103,29,103,63,0],[103,63,106,13,0],[106,13,106,14,0],[106,14,106,16,0],[79,13,106,16,0],[107,13,107,90,0],[108,9,108,10,0],[117,9,117,10,0],[118,13,119,13,0],[119,13,119,14,0],[119,14,120,24,0],[120,24,120,61,0],[120,61,121,17,0],[121,17,121,18,0],[121,18,122,21,0],[122,21,122,47,0],[122,47,132,29,0],[132,29,132,156,0],[132,156,141,29,0],[141,29,141,63,0],[141,63,144,13,0],[144,13,144,14,0],[144,14,144,16,0],[118,13,144,16,0],[145,13,145,91,0],[146,9,146,10,0],[149,9,149,10,0],[150,13,150,30,0],[151,13,151,14,0],[152,24,152,110,0],[153,17,153,18,0],[154,21,154,53,0],[159,13,159,47,0],[167,9,167,10,0],[179,9,179,10,0],[180,13,180,30,0],[181,13,181,14,0],[182,24,182,110,0],[183,17,183,18,0],[184,21,184,47,0],[188,13,188,48,0],[189,13,189,56,0],[190,13,190,52,0],[191,13,191,72,0],[193,13,193,27,0],[194,9,194,10,0],[197,9,197,10,0],[198,13,198,30,0],[199,13,199,14,0],[200,17,200,64,0],[201,24,201,110,0],[202,17,202,18,0],[203,21,203,67,0],[208,13,208,47,0],[215,9,215,10,0],[228,9,228,10,0],[229,13,229,30,0],[230,13,230,14,0],[231,17,231,64,0],[232,24,232,110,0],[233,17,233,18,0],[234,21,234,61,0],[238,13,238,63,0],[239,13,239,52,0],[240,13,240,72,0],[242,13,242,27,0],[243,9,243,10,0],[246,9,246,10,0],[247,13,247,49,0],[261,9,261,10,0],[262,13,262,30,0],[263,13,263,14,0],[264,24,264,110,0],[265,17,265,18,0],[266,21,266,47,0],[270,13,270,51,0],[271,13,272,13,0],[272,13,272,14,0],[272,14,273,17,0],[273,17,274,61,0],[274,61,275,16,0],[271,13,275,16,0],[276,13,276,72,0],[278,13,278,27,0],[279,9,279,10,0],[287,9,287,10,0],[288,20,288,106,0],[289,13,289,14,0],[290,17,290,49,0],[291,17,291,95,0],[292,21,292,33,0],[294,17,294,56,0],[296,9,296,10,0],[305,9,305,10,0],[306,20,306,106,0],[307,13,307,14,0],[308,17,308,49,0],[309,17,309,95,0],[310,21,310,33,0],[312,17,312,64,0],[313,17,313,70,0],[315,9,315,10,0],[323,9,323,10,1],[324,20,324,106,1],[325,13,325,14,1],[326,17,326,94,1],[327,17,327,61,1],[329,17,329,33,1],[331,9,331,10,1],[340,9,340,10,1],[341,13,341,60,1],[342,20,342,106,1],[343,13,343,14,1],[344,17,344,94,1],[345,17,345,75,1],[347,17,347,33,1],[349,9,349,10,1],[357,9,357,10,1],[358,20,358,106,1],[359,13,359,14,1],[360,17,360,49,1],[361,17,361,51,1],[362,17,362,114,1],[363,17,363,61,1],[365,17,365,33,1],[367,9,367,10,1],[376,9,376,10,0],[377,13,377,60,0],[378,20,378,106,0],[379,13,379,14,0],[380,17,380,49,0],[381,17,381,116,0],[382,17,382,75,0],[384,17,384,33,0],[386,9,386,10,0],[394,9,394,10,0],[396,13,396,42,0],[397,13,397,14,0],[398,17,398,95,0],[399,13,399,14,0],[401,13,401,60,0],[402,20,402,106,0],[403,13,403,14,0],[404,17,404,86,0],[406,17,406,33,0],[408,9,408,10,0],[416,9,416,10,1],[417,13,417,51,1],[418,13,419,13,1],[419,13,419,14,1],[419,14,420,17,1],[420,17,421,61,1],[421,61,422,16,1],[418,13,422,16,1],[423,13,423,72,1],[425,13,425,44,1],[426,9,426,10,1],[435,9,435,10,1],[436,13,436,63,1],[437,13,437,52,1],[438,13,439,13,1],[439,13,439,14,0],[439,14,440,17,1],[440,17,441,61,0],[441,61,442,16,1],[438,13,442,16,1],[444,13,444,60,1],[445,20,445,106,1],[446,13,446,14,1],[447,17,447,61,1],[449,9,449,10,1],[452,9,452,10,0],[453,13,453,63,0],[454,13,454,52,0],[455,13,456,13,0],[456,13,456,14,0],[456,14,457,17,0],[457,17,458,61,0],[458,61,459,16,0],[455,13,459,16,0],[461,13,461,60,0],[462,20,462,106,0],[463,13,463,14,0],[464,17,464,62,0],[466,9,466,10,0],[475,9,475,10,1],[476,13,476,101,1],[477,13,477,63,1],[478,13,478,52,1],[479,13,480,13,1],[480,13,480,14,0],[480,14,481,17,1],[481,17,482,61,0],[482,61,483,16,1],[479,13,483,16,1],[485,20,485,106,1],[486,13,486,14,1],[487,17,487,61,1],[489,9,489,10,1],[497,9,497,10,1],[498,20,498,57,1],[499,13,499,14,1],[500,17,500,114,1],[501,17,501,78,1],[502,17,502,53,1],[503,17,503,88,1],[505,9,505,10,1],[513,9,513,10,0],[514,20,514,57,0],[515,13,515,14,0],[516,17,516,117,0],[517,17,517,78,0],[518,17,518,53,0],[519,17,519,88,0],[521,9,521,10,0],[529,9,529,10,0],[530,13,530,54,0],[531,13,531,36,0],[532,17,532,49,0],[534,13,534,99,0],[535,9,535,10,0],[543,9,543,10,0],[544,13,544,48,0],[545,13,545,46,0],[546,9,546,10,0],[554,9,554,10,1],[555,13,555,51,1],[556,13,556,72,1],[557,13,558,24,1],[560,13,560,73,1],[561,13,561,35,1],[562,17,562,169,0],[564,13,564,45,1],[565,17,565,120,1],[567,13,567,40,1],[568,9,568,10,1]]);
    </script>
  </body>
</html>