<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Resolvers\ManyResolverTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web;
using Moq;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.ObjectResolution;
using Umbraco.Tests.TestHelpers;

using NUnit.Framework;

namespace Umbraco.Tests.Resolvers
{
    [TestFixture]
    public class ManyResolverTests
    {
        [SetUp]
        public void Setup()
        {
            ManyResolver.Reset();
        }

        [TearDown]
        public void TearDown()
        {
            ManyResolver.Reset();
        }

        #region Resolvers and Resolved

        public abstract class Resolved
        { }

        public class Resolved1 : Resolved
        { }

        [Weight(5)] // default is 100
        public class Resolved2 : Resolved
        { }

        public class Resolved3 : Resolved
        { }

        public class Resolved4 // not! : Resolved
        { }

        public sealed class ManyResolver : ManyObjectsResolverBase&lt;ManyResolver, Resolved&gt;
        {
            public ManyResolver(IServiceProvider serviceProvider, ILogger logger)
                : base(serviceProvider, logger)
            { }

            public ManyResolver(IServiceProvider serviceProvider, ILogger logger, IEnumerable&lt;Type&gt; value)
                : base(serviceProvider, logger, value)
            { }

            public ManyResolver(IServiceProvider serviceProvider, ILogger logger, IEnumerable&lt;Type&gt; value, ObjectLifetimeScope scope)
                : base(serviceProvider, logger, value, scope)
            { }

            public ManyResolver(IServiceProvider serviceProvider, ILogger logger, HttpContextBase httpContext)
                : base(serviceProvider, logger, httpContext)
            { }

            public IEnumerable&lt;Resolved&gt; SortedResolvedObjects { get { return GetSortedValues(); } }
            public IEnumerable&lt;Resolved&gt; ResolvedObjects { get { return Values; } }
        }

        #endregion

        #region Test ManyResolver types collection manipulation

        [Test]
        public void ManyResolverContainsTypes()
        {
            var resolver = new ManyResolver(
                new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(),
                new Type[] { typeof(Resolved1), typeof(Resolved2) });

            Assert.IsTrue(resolver.ContainsType&lt;Resolved1&gt;());
            Assert.IsTrue(resolver.ContainsType&lt;Resolved2&gt;());
            Assert.IsFalse(resolver.ContainsType&lt;Resolved3&gt;());
            //Assert.IsFalse(resolver.ContainsType&lt;Resolved4&gt;()); // does not compile
        }

        [Test]
        public void ManyResolverCanClearBeforeFreeze()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;());
            resolver.AddType&lt;Resolved1&gt;();
            resolver.AddType&lt;Resolved2&gt;();
            resolver.Clear();
            Assert.IsFalse(resolver.ContainsType&lt;Resolved1&gt;());
            Assert.IsFalse(resolver.ContainsType&lt;Resolved2&gt;());
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotClearOnceFrozen()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;());
            resolver.AddType&lt;Resolved1&gt;();
            resolver.AddType&lt;Resolved2&gt;();
            Resolution.Freeze();
            resolver.Clear();
        }

        [Test]
        public void ManyResolverCanAddTypeBeforeFreeze()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;());
            resolver.AddType&lt;Resolved1&gt;();
            resolver.AddType&lt;Resolved2&gt;();

            Assert.IsTrue(resolver.ContainsType&lt;Resolved1&gt;());
            Assert.IsTrue(resolver.ContainsType&lt;Resolved2&gt;());
            Assert.IsFalse(resolver.ContainsType&lt;Resolved3&gt;());
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotAddTypeOnceFrozen()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;());
            Resolution.Freeze();
            resolver.AddType&lt;Resolved1&gt;();
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotAddTypeAgain()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;());
            resolver.AddType&lt;Resolved1&gt;();
            resolver.AddType&lt;Resolved1&gt;();
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotAddInvalidType()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;());
            //resolver.AddType&lt;Resolved4&gt;(); // does not compile
            resolver.AddType(typeof(Resolved4)); // throws
        }

        [Test]
        public void ManyResolverCanRemoveTypeBeforeFreeze()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            resolver.RemoveType&lt;Resolved2&gt;();

            Assert.IsTrue(resolver.ContainsType&lt;Resolved1&gt;());
            Assert.IsFalse(resolver.ContainsType&lt;Resolved2&gt;());
            Assert.IsFalse(resolver.ContainsType&lt;Resolved3&gt;());
        }

        [Test]
        public void ManyResolverCanRemoveAbsentType()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            resolver.RemoveType&lt;Resolved3&gt;();
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotRemoveInvalidType()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            //resolver.RemoveType&lt;Resolved4&gt;(); // does not compile
            resolver.RemoveType(typeof(Resolved4)); // throws
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotRemoveTypeOnceFrozen()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            Resolution.Freeze();
            resolver.RemoveType&lt;Resolved2&gt;(); // throws
        }

        [Test]
        public void ManyResolverCanInsertTypeBeforeFreeze()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            resolver.InsertType&lt;Resolved3&gt;(0);

            Assert.IsTrue(resolver.ContainsType&lt;Resolved1&gt;());
            Assert.IsTrue(resolver.ContainsType&lt;Resolved2&gt;());
            Assert.IsTrue(resolver.ContainsType&lt;Resolved3&gt;());
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotInsertTypeOnceFrozen()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            Resolution.Freeze();
            resolver.InsertType&lt;Resolved3&gt;(0);
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotInsertTypeAgain()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            resolver.InsertType&lt;Resolved2&gt;(0);
        }

        [Test]
        public void ManyResolverCanInsertInEmptyList()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;());
            resolver.InsertType&lt;Resolved2&gt;();
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotInsertInvalidType()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            //resolver.InsertType&lt;Resolved4&gt;(0); // does not compile
            resolver.InsertType(0, typeof(Resolved4)); // throws
        }

        [Test]
        [ExpectedException(typeof(ArgumentOutOfRangeException))]
        public void ManyResolverCannotInsertTypeAtWrongIndex()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            resolver.InsertType(99, typeof(Resolved3)); // throws
        }

        //

        [Test]
        public void ManyResolverCanInsertBeforeTypeBeforeFreeze()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            resolver.InsertTypeBefore&lt;Resolved2, Resolved3&gt;();

            Assert.IsTrue(resolver.ContainsType&lt;Resolved1&gt;());
            Assert.IsTrue(resolver.ContainsType&lt;Resolved2&gt;());
            Assert.IsTrue(resolver.ContainsType&lt;Resolved3&gt;());
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotInsertBeforeTypeOnceFrozen()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            Resolution.Freeze();
            resolver.InsertTypeBefore&lt;Resolved2, Resolved3&gt;();
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotInsertBeforeTypeAgain()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            resolver.InsertTypeBefore&lt;Resolved2, Resolved1&gt;();
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotInsertBeforeAbsentType()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1) });
            resolver.InsertTypeBefore&lt;Resolved2, Resolved3&gt;();
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotInsertBeforeInvalidType()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            //resolver.InsertTypeBefore&lt;Resolved2, Resolved4&gt;(); // does not compile
            resolver.InsertTypeBefore(typeof(Resolved2), typeof(Resolved4)); // throws
        }

        #endregion

        #region Test ManyResolver resolution

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ManyResolverCannotGetValuesBeforeFreeze()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            var values = resolver.ResolvedObjects;
        }

        [Test]
        public void ManyResolverCannotGetValuesBeforeFreezeUnless()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            resolver.CanResolveBeforeFrozen = true;
            var values = resolver.ResolvedObjects;
        }

        [Test]
        public void ManyResolverCanGetValuesOnceFrozen()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            Resolution.Freeze();
            var values = resolver.ResolvedObjects;

            Assert.AreEqual(2, values.Count());
            Assert.IsInstanceOf&lt;Resolved1&gt;(values.ElementAt(0));
            Assert.IsInstanceOf&lt;Resolved2&gt;(values.ElementAt(1));
        }

        [Test]
        public void ManyResolverDefaultLifetimeScopeIsApplication()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            Resolution.Freeze();
            var values = resolver.ResolvedObjects;

            Assert.AreEqual(2, values.Count());
            Assert.IsInstanceOf&lt;Resolved1&gt;(values.ElementAt(0));
            Assert.IsInstanceOf&lt;Resolved2&gt;(values.ElementAt(1));

            var values2 = resolver.ResolvedObjects;
            Assert.AreEqual(2, values2.Count());
            Assert.AreSame(values.ElementAt(0), values2.ElementAt(0));
            Assert.AreSame(values.ElementAt(1), values2.ElementAt(1));
        }

        [Test]
        public void ManyResolverTransientLifetimeScope()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) }, ObjectLifetimeScope.Transient);
            Resolution.Freeze();
            var values = resolver.ResolvedObjects;

            Assert.AreEqual(2, values.Count());
            Assert.IsInstanceOf&lt;Resolved1&gt;(values.ElementAt(0));
            Assert.IsInstanceOf&lt;Resolved2&gt;(values.ElementAt(1));

            var values2 = resolver.ResolvedObjects;
            Assert.AreEqual(2, values2.Count());
            Assert.AreNotSame(values.ElementAt(0), values2.ElementAt(0));
            Assert.AreNotSame(values.ElementAt(1), values2.ElementAt(1));
        }

        [Test]
        public void ManyResolverDefaultOrderOfTypes()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;());
            resolver.AddType&lt;Resolved3&gt;();
            resolver.InsertType&lt;Resolved1&gt;(0);
            resolver.InsertTypeBefore&lt;Resolved3, Resolved2&gt;();
            Resolution.Freeze();
            var values = resolver.ResolvedObjects;

            Assert.AreEqual(3, values.Count());
            Assert.IsInstanceOf&lt;Resolved1&gt;(values.ElementAt(0));
            Assert.IsInstanceOf&lt;Resolved2&gt;(values.ElementAt(1));
            Assert.IsInstanceOf&lt;Resolved3&gt;(values.ElementAt(2));
        }

        [Test]
        public void ManyResolverHttpRequestLifetimeScope()
        {
            var httpContextFactory = new FakeHttpContextFactory(&quot;~/Home&quot;);
            var httpContext = httpContextFactory.HttpContext;
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), httpContext);

            resolver.AddType&lt;Resolved1&gt;();
            resolver.AddType&lt;Resolved2&gt;();
            Resolution.Freeze();

            var values = resolver.ResolvedObjects;
            Assert.AreEqual(2, values.Count());
            Assert.IsInstanceOf&lt;Resolved1&gt;(values.ElementAt(0));
            Assert.IsInstanceOf&lt;Resolved2&gt;(values.ElementAt(1));

            var values2 = resolver.ResolvedObjects;
            Assert.AreEqual(2, values2.Count());
            Assert.AreSame(values.ElementAt(0), values2.ElementAt(0));
            Assert.AreSame(values.ElementAt(1), values2.ElementAt(1));

            httpContextFactory.HttpContext.Items.Clear(); // new context

            var values3 = resolver.ResolvedObjects;
            Assert.AreEqual(2, values3.Count());
            Assert.AreNotSame(values.ElementAt(0), values3.ElementAt(0));
            Assert.AreNotSame(values.ElementAt(1), values3.ElementAt(1));
        }

        [Test]
        public void ManyResolverWeightedResolution()
        {
            var resolver = new ManyResolver(new ActivatorServiceProvider(), Mock.Of&lt;ILogger&gt;(), new Type[] { typeof(Resolved1), typeof(Resolved2) });
            Resolution.Freeze();

            var values = resolver.SortedResolvedObjects;
            Assert.AreEqual(2, values.Count());
            Assert.IsInstanceOf&lt;Resolved2&gt;(values.ElementAt(0));
            Assert.IsInstanceOf&lt;Resolved1&gt;(values.ElementAt(1));
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,1],[22,13,22,34,1],[23,9,23,10,1],[27,9,27,10,1],[28,13,28,34,1],[29,9,29,10,1],[52,19,52,48,1],[53,13,53,14,1],[53,15,53,16,1],[56,19,56,55,1],[57,13,57,14,1],[57,15,57,16,1],[60,19,60,62,1],[61,13,61,14,1],[61,15,61,16,1],[64,19,64,61,1],[65,13,65,14,1],[65,15,65,16,1],[67,70,67,71,1],[67,72,67,97,1],[67,98,67,99,1],[68,64,68,65,1],[68,66,68,80,1],[68,81,68,82,1],[77,9,77,10,1],[78,13,80,70,1],[82,13,82,63,1],[83,13,83,63,1],[84,13,84,64,1],[86,9,86,10,1],[90,9,90,10,1],[91,13,91,97,1],[92,13,92,43,1],[93,13,93,43,1],[94,13,94,30,1],[95,13,95,64,1],[96,13,96,64,1],[97,9,97,10,1],[102,9,102,10,1],[103,13,103,97,1],[104,13,104,43,1],[105,13,105,43,1],[106,13,106,33,1],[107,13,107,30,1],[108,9,108,10,0],[112,9,112,10,1],[113,13,113,97,1],[114,13,114,43,1],[115,13,115,43,1],[117,13,117,63,1],[118,13,118,63,1],[119,13,119,64,1],[120,9,120,10,1],[125,9,125,10,1],[126,13,126,97,1],[127,13,127,33,1],[128,13,128,43,1],[129,9,129,10,0],[134,9,134,10,1],[135,13,135,97,1],[136,13,136,43,1],[137,13,137,43,1],[138,9,138,10,0],[143,9,143,10,1],[144,13,144,97,1],[146,13,146,49,1],[147,9,147,10,0],[151,9,151,10,1],[152,13,152,150,1],[153,13,153,46,1],[155,13,155,63,1],[156,13,156,64,1],[157,13,157,64,1],[158,9,158,10,1],[162,9,162,10,1],[163,13,163,150,1],[164,13,164,46,1],[165,9,165,10,1],[170,9,170,10,1],[171,13,171,150,1],[173,13,173,52,1],[174,9,174,10,0],[179,9,179,10,1],[180,13,180,150,1],[181,13,181,33,1],[182,13,182,46,1],[183,9,183,10,0],[187,9,187,10,1],[188,13,188,150,1],[189,13,189,47,1],[191,13,191,63,1],[192,13,192,63,1],[193,13,193,63,1],[194,9,194,10,1],[199,9,199,10,1],[200,13,200,150,1],[201,13,201,33,1],[202,13,202,47,1],[203,9,203,10,0],[208,9,208,10,1],[209,13,209,150,1],[210,13,210,47,1],[211,9,211,10,0],[215,9,215,10,1],[216,13,216,97,1],[217,13,217,46,1],[218,9,218,10,1],[223,9,223,10,1],[224,13,224,150,1],[226,13,226,55,1],[227,9,227,10,0],[232,9,232,10,1],[233,13,233,150,1],[234,13,234,56,1],[235,9,235,10,0],[241,9,241,10,1],[242,13,242,150,1],[243,13,243,63,1],[245,13,245,63,1],[246,13,246,63,1],[247,13,247,63,1],[248,9,248,10,1],[253,9,253,10,1],[254,13,254,150,1],[255,13,255,33,1],[256,13,256,63,1],[257,9,257,10,0],[262,9,262,10,1],[263,13,263,150,1],[264,13,264,63,1],[265,9,265,10,0],[270,9,270,10,1],[271,13,271,131,1],[272,13,272,63,1],[273,9,273,10,0],[278,9,278,10,1],[279,13,279,150,1],[281,13,281,77,1],[282,9,282,10,0],[291,9,291,10,1],[292,13,292,150,1],[293,13,293,51,1],[294,9,294,10,0],[298,9,298,10,1],[299,13,299,150,1],[300,13,300,52,1],[301,13,301,51,1],[302,9,302,10,1],[306,9,306,10,1],[307,13,307,150,1],[308,13,308,33,1],[309,13,309,51,1],[311,13,311,48,1],[312,13,312,65,1],[313,13,313,65,1],[314,9,314,10,1],[318,9,318,10,1],[319,13,319,150,1],[320,13,320,33,1],[321,13,321,51,1],[323,13,323,48,1],[324,13,324,65,1],[325,13,325,65,1],[327,13,327,52,1],[328,13,328,49,1],[329,13,329,71,1],[330,13,330,71,1],[331,9,331,10,1],[335,9,335,10,1],[336,13,336,181,1],[337,13,337,33,1],[338,13,338,51,1],[340,13,340,48,1],[341,13,341,65,1],[342,13,342,65,1],[344,13,344,52,1],[345,13,345,49,1],[346,13,346,74,1],[347,13,347,74,1],[348,9,348,10,1],[352,9,352,10,1],[353,13,353,97,1],[354,13,354,43,1],[355,13,355,47,1],[356,13,356,63,1],[357,13,357,33,1],[358,13,358,51,1],[360,13,360,48,1],[361,13,361,65,1],[362,13,362,65,1],[363,13,363,65,1],[364,9,364,10,1],[368,9,368,10,1],[369,13,369,75,1],[370,13,370,62,1],[371,13,371,110,1],[373,13,373,43,1],[374,13,374,43,1],[375,13,375,33,1],[377,13,377,51,1],[378,13,378,48,1],[379,13,379,65,1],[380,13,380,65,1],[382,13,382,52,1],[383,13,383,49,1],[384,13,384,71,1],[385,13,385,71,1],[387,13,387,58,1],[389,13,389,52,1],[390,13,390,49,1],[391,13,391,74,1],[392,13,392,74,1],[393,9,393,10,1],[397,9,397,10,1],[398,13,398,150,1],[399,13,399,33,1],[401,13,401,57,1],[402,13,402,48,1],[403,13,403,65,1],[404,13,404,65,1],[405,9,405,10,1]]);
    </script>
  </body>
</html>