<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\DatabaseContextTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using System.Data.SqlServerCe;
using System.IO;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Profiling;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence
{

    [TestFixture, RequiresSTA]
    public class DatabaseContextTests
    {
	    private DatabaseContext _dbContext;

		[SetUp]
		public void Setup()
		{
            _dbContext = new DatabaseContext(
                new DefaultDatabaseFactory(Core.Configuration.GlobalSettings.UmbracoConnectionName, Mock.Of&lt;ILogger&gt;()),
                Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider(), Constants.DatabaseProviders.SqlCe);

			//unfortunately we have to set this up because the PetaPocoExtensions require singleton access
			ApplicationContext.Current = new ApplicationContext(
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()))
				{
					DatabaseContext = _dbContext,
					IsReady = true
				};
		}

		[TearDown]
		public void TearDown()
		{
			_dbContext = null;
			ApplicationContext.Current = null;
		}

        [Test]
        public void Database_Connection()
        {
            var db = _dbContext.Database;
            Assert.IsNull(db.Connection);
        }

        [Test]
        public void Can_Verify_Single_Database_Instance()
        {
			var db1 = _dbContext.Database;
			var db2 = _dbContext.Database;

            Assert.AreSame(db1, db2);
        }

        [Test]
        public void Can_Assert_DatabaseProvider()
        {
			var provider = _dbContext.DatabaseProvider;

            Assert.AreEqual(DatabaseProviders.SqlServerCE, provider);
        }

        [Test]
        public void Can_Assert_Created_Database()
        {
            string path = TestHelper.CurrentAssemblyDirectory;
            AppDomain.CurrentDomain.SetData(&quot;DataDirectory&quot;, path);

            //Delete database file before continueing
            //NOTE: we&#39;ll use a custom db file for this test since we&#39;re re-using the one created with BaseDatabaseFactoryTest
            string filePath = string.Concat(path, &quot;\\DatabaseContextTests.sdf&quot;);
            if (File.Exists(filePath))
            {
                File.Delete(filePath);
            }

            //Get the connectionstring settings from config
            var settings = ConfigurationManager.ConnectionStrings[Core.Configuration.GlobalSettings.UmbracoConnectionName];

            //by default the conn string is: Datasource=|DataDirectory|UmbracoPetaPocoTests.sdf;Flush Interval=1;
            //we&#39;ll just replace the sdf file with our custom one:
            //Create the Sql CE database
            var connString = settings.ConnectionString.Replace(&quot;UmbracoPetaPocoTests&quot;, &quot;DatabaseContextTests&quot;);
            using (var engine = new SqlCeEngine(connString))
            {
                engine.CreateDatabase();
            }

            var dbFactory = new DefaultDatabaseFactory(connString, Constants.DatabaseProviders.SqlCe, Mock.Of&lt;ILogger&gt;());
            //re-map the dbcontext to the new conn string
            _dbContext = new DatabaseContext(
                dbFactory,
                Mock.Of&lt;ILogger&gt;(),
                new SqlCeSyntaxProvider(),
                dbFactory.ProviderName);

            var schemaHelper = new DatabaseSchemaHelper(_dbContext.Database, Mock.Of&lt;ILogger&gt;(), new SqlCeSyntaxProvider());

            var appCtx = new ApplicationContext(
                new DatabaseContext(Mock.Of&lt;IDatabaseFactory&gt;(), Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;ISqlSyntaxProvider&gt;(), &quot;test&quot;),
                new ServiceContext(migrationEntryService: Mock.Of&lt;IMigrationEntryService&gt;()),
                CacheHelper.CreateDisabledCacheHelper(),
                new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            //Create the umbraco database
            schemaHelper.CreateDatabaseSchema(false, appCtx);

            bool umbracoNodeTable = schemaHelper.TableExist(&quot;umbracoNode&quot;);
            bool umbracoUserTable = schemaHelper.TableExist(&quot;umbracoUser&quot;);
            bool cmsTagsTable = schemaHelper.TableExist(&quot;cmsTags&quot;);

            Assert.That(umbracoNodeTable, Is.True);
            Assert.That(umbracoUserTable, Is.True);
            Assert.That(cmsTagsTable, Is.True);
        }

        [TestCase(&quot;MyServer&quot;, &quot;MyDatabase&quot;, &quot;MyUser&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;MyServer&quot;, &quot;MyDatabase&quot;, &quot;MyUser@MyServer&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:MyServer&quot;, &quot;MyDatabase&quot;, &quot;MyUser&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:MyServer&quot;, &quot;MyDatabase&quot;, &quot;MyUser@MyServer&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:MyServer,1433&quot;, &quot;MyDatabase&quot;, &quot;MyUser&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:MyServer,1433&quot;, &quot;MyDatabase&quot;, &quot;MyUser@MyServer&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:MyServer.database.windows.net&quot;, &quot;MyDatabase&quot;, &quot;MyUser&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:MyServer.database.windows.net&quot;, &quot;MyDatabase&quot;, &quot;MyUser@MyServer&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:MyServer.database.windows.net,1433&quot;, &quot;MyDatabase&quot;, &quot;MyUser&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:MyServer.database.windows.net,1433&quot;, &quot;MyDatabase&quot;, &quot;MyUser@MyServer&quot;, &quot;MyPassword&quot;)]
        public void Build_Azure_Connection_String_Regular(string server, string databaseName, string userName, string password)
        {
            var connectionString = _dbContext.BuildAzureConnectionString(server, databaseName, userName, password);
            Assert.AreEqual(connectionString, &quot;Server=tcp:MyServer.database.windows.net,1433;Database=MyDatabase;User ID=MyUser@MyServer;Password=MyPassword&quot;);
        }

        [TestCase(&quot;tcp:kzeej5z8ty.ssmsawacluster4.windowsazure.mscds.com,1433&quot;, &quot;MyDatabase&quot;, &quot;MyUser&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:kzeej5z8ty.ssmsawacluster4.windowsazure.mscds.com,1433&quot;, &quot;MyDatabase&quot;, &quot;MyUser@kzeej5z8ty&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:kzeej5z8ty.ssmsawacluster4.windowsazure.mscds.com&quot;, &quot;MyDatabase&quot;, &quot;MyUser&quot;, &quot;MyPassword&quot;)]
        [TestCase(&quot;tcp:kzeej5z8ty.ssmsawacluster4.windowsazure.mscds.com&quot;, &quot;MyDatabase&quot;, &quot;MyUser@kzeej5z8ty&quot;, &quot;MyPassword&quot;)]
        public void Build_Azure_Connection_String_CustomServer(string server, string databaseName, string userName, string password)
        {
            var connectionString = _dbContext.BuildAzureConnectionString(server, databaseName, userName, password);
            Assert.AreEqual(connectionString, &quot;Server=tcp:kzeej5z8ty.ssmsawacluster4.windowsazure.mscds.com,1433;Database=MyDatabase;User ID=MyUser@kzeej5z8ty;Password=MyPassword&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,3,25,4,1],[26,13,28,99,1],[31,4,37,7,1],[38,3,38,4,1],[42,3,42,4,1],[43,4,43,22,1],[44,4,44,38,1],[45,3,45,4,1],[49,9,49,10,1],[50,13,50,42,1],[51,13,51,42,1],[52,9,52,10,1],[56,9,56,10,1],[57,4,57,34,1],[58,4,58,34,1],[60,13,60,38,1],[61,9,61,10,1],[65,9,65,10,1],[66,4,66,47,1],[68,13,68,70,1],[69,9,69,10,1],[73,9,73,10,1],[74,13,74,63,1],[75,13,75,68,1],[79,13,79,81,1],[80,13,80,39,1],[81,13,81,14,0],[82,17,82,39,0],[83,13,83,14,0],[86,13,86,124,1],[91,13,91,112,1],[92,20,92,60,1],[93,13,93,14,1],[94,17,94,41,1],[95,13,95,14,1],[97,13,97,123,1],[99,13,103,41,1],[105,13,105,125,1],[107,13,111,80,1],[114,13,114,62,1],[116,13,116,76,1],[117,13,117,76,1],[118,13,118,68,1],[120,13,120,52,1],[121,13,121,52,1],[122,13,122,48,1],[123,9,123,10,1],[136,9,136,10,1],[137,13,137,116,1],[138,13,138,160,1],[139,9,139,10,1],[146,9,146,10,1],[147,13,147,116,1],[148,13,148,182,1],[149,9,149,10,1]]);
    </script>
  </body>
</html>