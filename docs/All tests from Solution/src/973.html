<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\ColorListPreValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Text.RegularExpressions;
using Newtonsoft.Json.Linq;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.PropertyEditors;

namespace Umbraco.Web.PropertyEditors
{
    internal class ColorListPreValueEditor : ValueListPreValueEditor
    {
      
        public ColorListPreValueEditor()
        {
            var field = Fields.First();

            //use a custom editor too
            field.View = &quot;views/propertyeditors/colorpicker/colorpicker.prevalues.html&quot;;
            //change the description
            field.Description = &quot;Add and remove colors&quot;;
            //change the label
            field.Name = &quot;Add color&quot;;
            //need to have some custom validation happening here
            field.Validators.Add(new ColorListValidator()); 
        }

        public override IDictionary&lt;string, object&gt; ConvertDbToEditor(IDictionary&lt;string, object&gt; defaultPreVals, PreValueCollection persistedPreVals)
        {
            var dictionary = persistedPreVals.FormatAsDictionary();
            var arrayOfVals = dictionary.Select(item =&gt; item.Value).ToList();
            return new Dictionary&lt;string, object&gt; { { &quot;items&quot;, arrayOfVals.ToDictionary(x =&gt; x.Id, x =&gt; x.Value) } };
        }

        internal class ColorListValidator : IPropertyValidator
        {
            public IEnumerable&lt;ValidationResult&gt; Validate(object value, PreValueCollection preValues, PropertyEditor editor)
            {
                var json = value as JArray;
                if (json == null) yield break;
                
                //validate each item which is a json object
                for (var index = 0; index &lt; json.Count; index++)
                {
                    var i = json[index];
                    var jItem = i as JObject;
                    if (jItem == null || jItem[&quot;value&quot;] == null) continue;

                    //NOTE: we will be removing empty values when persisting so no need to validate
                    var asString = jItem[&quot;value&quot;].ToString();
                    if (asString.IsNullOrWhiteSpace()) continue;

                    if (Regex.IsMatch(asString, &quot;^([0-9a-f]{3}|[0-9a-f]{6})$&quot;, RegexOptions.IgnoreCase) == false)
                    {
                        yield return new ValidationResult(&quot;The value &quot; + asString + &quot; is not a valid hex color&quot;, new[]
                            {
                                //we&#39;ll make the server field the index number of the value so it can be wired up to the view
                                &quot;item_&quot; + index.ToInvariantString()
                            });
                    }
                }
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,9,15,41,0],[16,9,16,10,0],[17,13,17,40,0],[20,13,20,89,0],[22,13,22,57,0],[24,13,24,38,0],[26,13,26,60,0],[27,9,27,10,0],[30,9,30,10,0],[31,13,31,68,0],[32,13,32,57,0],[32,57,32,67,0],[32,67,32,78,0],[32,13,32,78,0],[33,13,33,94,0],[33,94,33,98,0],[33,98,33,105,0],[33,105,33,112,0],[33,112,33,118,0],[33,13,33,118,0],[34,9,34,10,0]]);
    </script>
  </body>
</html>