<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSeven\AddIndexToCmsMacroTable.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.CodeDom;
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSeven
{
    /// &lt;summary&gt;
    /// Creates a unique index on the macro alias so we cannot have duplicates by alias
    /// &lt;/summary&gt;
    [Migration(&quot;7.0.0&quot;, 4, GlobalSettings.UmbracoMigrationName)]
    public class AddIndexToCmsMacroTable : MigrationBase
    {
        private readonly bool _forTesting;

        internal AddIndexToCmsMacroTable(bool forTesting, ISqlSyntaxProvider sqlSyntax, ILogger logger)
            : base(sqlSyntax, logger)
        {
            _forTesting = forTesting;
        }

        public AddIndexToCmsMacroTable(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {
            var dbIndexes = _forTesting ? new DbIndexDefinition[] { } : SqlSyntax.GetDefinedIndexes(Context.Database)
                .Select(x =&gt; new DbIndexDefinition()
                {
                    TableName = x.Item1,
                    IndexName = x.Item2,
                    ColumnName = x.Item3,
                    IsUnique = x.Item4
                }).ToArray();

            //make sure it doesn&#39;t already exist
            if (dbIndexes.Any(x =&gt; x.IndexName.InvariantEquals(&quot;IX_cmsMacro_Alias&quot;)) == false)
            {
                //in order to create this index, we need to ensure that there are no duplicates. This could have happened with very old/corrupt umbraco versions.
                // So we&#39;ll remove any duplicates based on alias and only keep the one with the smallest id since I&#39;m pretty sure we&#39;d always choose the &#39;first&#39; one
                // when running a query.

                if (_forTesting == false)
                {
                    //NOTE: Using full SQL statement here in case the DTO has changed between versions
                    var macros = Context.Database.Fetch&lt;MacroDto&gt;(&quot;SELECT * FROM cmsMacro&quot;)
                        .GroupBy(x =&gt; x.Alias)
                        .Where(x =&gt; x.Count() &gt; 1);

                    foreach (var m in macros)
                    {
                        //get the min id (to keep)
                        var minId = m.Min(x =&gt; x.Id);
                        //delete all the others
                        foreach (var macroDto in m.Where(x =&gt; x.Id != minId))
                        {
                            Delete.FromTable(&quot;cmsMacro&quot;).Row(new { id = macroDto.Id });
                        }
                    }
                }
                

                Create.Index(&quot;IX_cmsMacro_Alias&quot;).OnTable(&quot;cmsMacro&quot;).OnColumn(&quot;macroAlias&quot;).Unique();            
            }
            
        }

        public override void Down()
        {
            Delete.Index(&quot;IX_cmsMacro_Alias&quot;).OnTable(&quot;cmsMacro&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,15,21,38,1],[22,9,22,10,1],[23,13,23,38,1],[24,9,24,10,1],[26,88,26,111,0],[27,9,27,10,0],[28,9,28,10,0],[31,9,31,10,1],[32,13,33,30,1],[33,30,39,18,0],[39,18,39,30,1],[32,13,39,30,1],[42,13,42,36,1],[42,36,42,84,0],[42,84,42,95,1],[42,13,42,95,1],[43,13,43,14,1],[48,17,48,42,1],[49,17,49,18,0],[51,21,52,39,0],[52,39,52,46,0],[52,46,53,37,0],[53,37,53,50,0],[53,50,53,52,0],[51,21,53,52,0],[55,21,55,28,0],[55,30,55,35,0],[55,36,55,38,0],[55,39,55,45,0],[56,21,56,22,0],[58,25,58,48,0],[58,48,58,52,0],[58,52,58,54,0],[58,25,58,54,0],[60,25,60,32,0],[60,34,60,46,0],[60,47,60,49,0],[60,50,60,63,0],[60,63,60,76,0],[60,76,60,77,0],[60,50,60,77,0],[61,25,61,26,0],[62,29,62,88,0],[63,25,63,26,0],[64,21,64,22,0],[65,17,65,18,0],[68,17,68,103,1],[69,13,69,14,1],[71,9,71,10,1],[74,9,74,10,0],[75,13,75,67,0],[76,9,76,10,0]]);
    </script>
  </body>
</html>