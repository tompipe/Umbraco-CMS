<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\webservices\templates.asmx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Diagnostics;
using System.Web;
using System.Web.Services;
using System.Xml;
using System.Web.Script.Services;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Web.WebServices;
using umbraco.BusinessLogic;
using umbraco.presentation.webservices;

namespace umbraco.webservices
{
	/// &lt;summary&gt;
	/// Summary description for templates.
	/// &lt;/summary&gt;
	[WebService(Namespace=&quot;http://umbraco.org/webservices/&quot;)]
    [ScriptService]
    public class templates : UmbracoAuthorizedWebService
	{
		
		[WebMethod]
		public XmlNode GetTemplates(string Login, string Password)
		{
		    if (ValidateCredentials(Login, Password) &amp;&amp; UserHasAppAccess(DefaultApps.settings.ToString(), Login)) 
			{
				var xmlDoc = new XmlDocument();
				xmlDoc.LoadXml(&quot;&lt;templates/&gt;&quot;);
				foreach (cms.businesslogic.template.Template t in cms.businesslogic.template.Template.GetAllAsList()) 
				{
					var tt = xmlDoc.CreateElement(&quot;template&quot;);
					tt.Attributes.Append(XmlHelper.AddAttribute(xmlDoc, &quot;id&quot;, t.Id.ToString()));
                    tt.Attributes.Append(XmlHelper.AddAttribute(xmlDoc, &quot;name&quot;, t.Text));
					xmlDoc.DocumentElement.AppendChild(tt);
				}
				return xmlDoc.DocumentElement;
			}
		    return null;
		}

	    [WebMethod]
		public XmlNode GetTemplate(int Id, string Login, string Password)
		{
            if (ValidateCredentials(Login, Password) &amp;&amp; UserHasAppAccess(DefaultApps.settings.ToString(), Login)) 
			{
				var t = new cms.businesslogic.template.Template(Id);
				var xmlDoc = new XmlDocument();
				var tXml = xmlDoc.CreateElement(&quot;template&quot;);
                tXml.Attributes.Append(XmlHelper.AddAttribute(xmlDoc, &quot;id&quot;, t.Id.ToString()));
                tXml.Attributes.Append(XmlHelper.AddAttribute(xmlDoc, &quot;master&quot;, t.MasterTemplate.ToString()));
                tXml.Attributes.Append(XmlHelper.AddAttribute(xmlDoc, &quot;name&quot;, t.Text));
				tXml.AppendChild(XmlHelper.AddCDataNode(xmlDoc, &quot;design&quot;, t.Design));
				return tXml;
			}
		    return null;
		}

	    [WebMethod]
		public bool UpdateTemplate(int Id, int Master, string Design, string Login, string Password)
		{
            if (ValidateCredentials(Login, Password) &amp;&amp; UserHasAppAccess(DefaultApps.settings.ToString(), Login)) 
			{
                try
                {
                    var t = new cms.businesslogic.template.Template(Id)
                        {
                            MasterTemplate = Master,
                            Design = Design
                        };
                    //ensure events are raised
                    t.Save();
                    return true;
                }
                catch (ArgumentException)
                {
                    return false;
                }			    
			}
		    return false;
		}

	    [WebMethod]
        [ScriptMethod]
        public string GetCodeSnippet(object templateId)
	    {
            //NOTE: The legacy code threw an exception so will continue to do that.
	        AuthorizeRequest(DefaultApps.settings.ToString(), true);

	        var snippetPath = SystemDirectories.Umbraco + &quot;/scripting/templates/cshtml/&quot;;
	        var filePath = IOHelper.MapPath(snippetPath + templateId);

            //Directory check.. only allow files in script dir and below to be edited
            if (filePath.StartsWith(IOHelper.MapPath(snippetPath)))
            {
                var templateFile =
                    System.IO.File.OpenText(filePath);
                var content = templateFile.ReadToEnd();
                templateFile.Close();
                return content;
            }
            else
            {
                throw new ArgumentException(&quot;Couldn&#39;t open snippet - Illegal path&quot;);
                
            }
        }
		
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,3,28,4,0],[29,7,29,108,0],[30,4,30,5,0],[31,5,31,36,0],[32,5,32,36,0],[33,5,33,12,0],[33,14,33,51,0],[33,52,33,54,0],[33,55,33,105,0],[34,5,34,6,0],[35,6,35,48,0],[36,6,36,82,0],[37,21,37,90,0],[38,6,38,45,0],[39,5,39,6,0],[40,5,40,35,0],[42,7,42,19,0],[43,3,43,4,0],[47,3,47,4,0],[48,13,48,114,0],[49,4,49,5,0],[50,5,50,57,0],[51,5,51,36,0],[52,5,52,49,0],[53,17,53,95,0],[54,17,54,111,0],[55,17,55,88,0],[56,5,56,74,0],[57,5,57,17,0],[59,7,59,19,0],[60,3,60,4,0],[64,3,64,4,0],[65,13,65,114,0],[66,4,66,5,0],[68,17,68,18,0],[69,21,73,27,0],[75,21,75,30,0],[76,21,76,33,0],[78,17,78,42,0],[79,17,79,18,0],[80,21,80,34,0],[83,7,83,20,0],[84,3,84,4,0],[89,6,89,7,0],[91,10,91,66,0],[93,10,93,87,0],[94,10,94,68,0],[97,13,97,68,0],[98,13,98,14,0],[99,17,100,55,0],[101,17,101,56,0],[102,17,102,38,0],[103,17,103,32,0],[106,13,106,14,0],[107,17,107,85,0],[110,9,110,10,0]]);
    </script>
  </body>
</html>