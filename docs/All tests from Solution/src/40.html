<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\PublishedContent\PublishedContentRequestEngineTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.ObjectModel;
using System.Globalization;
using System.Web.Security;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.Models;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web.Routing;

namespace Umbraco.Tests.PublishedContent
{
    [TestFixture]
    public class PublishedContentRequestEngineTests : BaseRoutingTest
    {
        [Test]
        public void Ctor_Throws_On_Null_PCR()
        {
            Assert.Throws&lt;ArgumentException&gt;(() =&gt; new PublishedContentRequestEngine(                
                Mock.Of&lt;IWebRoutingSection&gt;(),
                null));
        }

        [Test]
        public void ConfigureRequest_Returns_False_Without_HasPublishedContent()
        {
            var routeCtx = GetRoutingContext(&quot;/test&quot;);

            var pcre = new PublishedContentRequestEngine(
                Mock.Of&lt;IWebRoutingSection&gt;(),
                new PublishedContentRequest(
                    routeCtx.UmbracoContext.CleanedUmbracoUrl, 
                    routeCtx,
                    Mock.Of&lt;IWebRoutingSection&gt;(),
                    s =&gt; new string[] { }));

            var result = pcre.ConfigureRequest();
            Assert.IsFalse(result);
        }

        [Test]
        public void ConfigureRequest_Returns_False_When_IsRedirect()
        {
            var routeCtx = GetRoutingContext(&quot;/test&quot;);

            var pcr = new PublishedContentRequest(routeCtx.UmbracoContext.CleanedUmbracoUrl, routeCtx, Mock.Of&lt;IWebRoutingSection&gt;(), s =&gt; new string[] { });
            var pc = GetPublishedContentMock();            
            pcr.PublishedContent = pc.Object;
            pcr.Culture = new CultureInfo(&quot;en-AU&quot;);
            pcr.SetRedirect(&quot;/hello&quot;);
            var pcre = new PublishedContentRequestEngine(
                Mock.Of&lt;IWebRoutingSection&gt;(),
                pcr);

            var result = pcre.ConfigureRequest();
            Assert.IsFalse(result);
        }

        [Test]
        public void ConfigureRequest_Adds_HttpContext_Items_When_Published_Content_Assigned()
        {
            var routeCtx = GetRoutingContext(&quot;/test&quot;);

            var pcr = new PublishedContentRequest(routeCtx.UmbracoContext.CleanedUmbracoUrl, routeCtx, Mock.Of&lt;IWebRoutingSection&gt;(), s =&gt; new string[] { });
            var pc = GetPublishedContentMock();
            pcr.PublishedContent = pc.Object;
            pcr.Culture = new CultureInfo(&quot;en-AU&quot;);
            var pcre = new PublishedContentRequestEngine(
                Mock.Of&lt;IWebRoutingSection&gt;(),
                pcr);

            pcre.ConfigureRequest();
            
            Assert.AreEqual(1, routeCtx.UmbracoContext.HttpContext.Items[&quot;pageID&quot;]);
            Assert.AreEqual(pcr.UmbracoPage.Elements.Count, ((Hashtable)routeCtx.UmbracoContext.HttpContext.Items[&quot;pageElements&quot;]).Count);
        }

        [Test]
        public void ConfigureRequest_Sets_UmbracoPage_When_Published_Content_Assigned()
        {
            var routeCtx = GetRoutingContext(&quot;/test&quot;);

            var pcr = new PublishedContentRequest(routeCtx.UmbracoContext.CleanedUmbracoUrl, routeCtx, Mock.Of&lt;IWebRoutingSection&gt;(), s =&gt; new string[] { });
            var pc = GetPublishedContentMock();
            pcr.Culture = new CultureInfo(&quot;en-AU&quot;);
            pcr.PublishedContent = pc.Object;
            var pcre = new PublishedContentRequestEngine(
                Mock.Of&lt;IWebRoutingSection&gt;(),
                pcr);

            pcre.ConfigureRequest();

            Assert.IsNotNull(pcr.UmbracoPage);
        }

        private Mock&lt;IPublishedContent&gt; GetPublishedContentMock()
        {
            var pc = new Mock&lt;IPublishedContent&gt;();
            pc.Setup(content =&gt; content.Id).Returns(1);
            pc.Setup(content =&gt; content.Name).Returns(&quot;test&quot;);
            pc.Setup(content =&gt; content.DocumentTypeId).Returns(2);
            pc.Setup(content =&gt; content.DocumentTypeAlias).Returns(&quot;testAlias&quot;);
            pc.Setup(content =&gt; content.WriterName).Returns(&quot;admin&quot;);
            pc.Setup(content =&gt; content.CreatorName).Returns(&quot;admin&quot;);
            pc.Setup(content =&gt; content.CreateDate).Returns(DateTime.Now);
            pc.Setup(content =&gt; content.UpdateDate).Returns(DateTime.Now);
            pc.Setup(content =&gt; content.Path).Returns(&quot;-1,1&quot;);
            pc.Setup(content =&gt; content.Version).Returns(Guid.NewGuid);
            pc.Setup(content =&gt; content.Parent).Returns(() =&gt; null);
            pc.Setup(content =&gt; content.Version).Returns(Guid.NewGuid);
            pc.Setup(content =&gt; content.Properties).Returns(new Collection&lt;IPublishedProperty&gt;());
            return pc;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,52,1],[21,52,23,22,1],[23,22,23,24,1],[21,13,23,24,1],[24,9,24,10,1],[28,9,28,10,1],[29,13,29,55,1],[31,13,37,26,1],[37,26,37,42,0],[37,42,37,45,1],[31,13,37,45,1],[39,13,39,50,1],[40,13,40,36,1],[41,9,41,10,1],[45,9,45,10,1],[46,13,46,55,1],[48,13,48,140,1],[48,140,48,156,0],[48,156,48,158,1],[48,13,48,158,1],[49,13,49,48,1],[50,13,50,46,1],[51,13,51,52,1],[52,13,52,39,1],[53,13,55,22,1],[57,13,57,50,1],[58,13,58,36,1],[59,9,59,10,1],[63,9,63,10,1],[64,13,64,55,1],[66,13,66,140,1],[66,140,66,156,0],[66,156,66,158,1],[66,13,66,158,1],[67,13,67,48,1],[68,13,68,46,1],[69,13,69,52,1],[70,13,72,22,1],[74,13,74,37,1],[76,13,76,85,1],[77,13,77,139,1],[78,9,78,10,1],[82,9,82,10,1],[83,13,83,55,1],[85,13,85,140,1],[85,140,85,156,0],[85,156,85,158,1],[85,13,85,158,1],[86,13,86,48,1],[87,13,87,52,1],[88,13,88,46,1],[89,13,91,22,1],[93,13,93,37,1],[95,13,95,47,1],[96,9,96,10,1],[99,9,99,10,1],[100,13,100,52,1],[101,13,101,56,1],[102,13,102,63,1],[103,13,103,68,1],[104,13,104,81,1],[105,13,105,70,1],[106,13,106,71,1],[107,13,107,75,1],[108,13,108,75,1],[109,13,109,63,1],[110,13,110,72,1],[111,13,111,63,1],[111,63,111,67,1],[111,67,111,69,1],[111,13,111,69,1],[112,13,112,72,1],[113,13,113,99,1],[114,13,114,23,1],[115,9,115,10,1]]);
    </script>
  </body>
</html>