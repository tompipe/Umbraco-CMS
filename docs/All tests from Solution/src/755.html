<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Search\LuceneIndexerExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Examine;
using Examine.LuceneEngine.Providers;
using Examine.Providers;
using Lucene.Net.Index;
using Lucene.Net.Search;
using Lucene.Net.Store;
using Umbraco.Core.Logging;

namespace Umbraco.Web.Search
{
    /// &lt;summary&gt;
    /// Extension methods for the LuceneIndexer
    /// &lt;/summary&gt;
    internal static class ExamineExtensions
    {
        /// &lt;summary&gt;
        /// Checks if the index can be read/opened
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexer&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;ex&quot;&gt;The exception returned if there was an error&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static bool IsHealthy(this LuceneIndexer indexer, out Exception ex)
        {
            try
            {
                using (indexer.GetIndexWriter().GetReader())
                {
                    ex = null;
                    return true;
                }
            }
            catch (Exception e)
            {
                ex = e;
                return false;
            }
        }

        /// &lt;summary&gt;
        /// Return the number of indexed documents in Lucene
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexer&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static int GetIndexDocumentCount(this LuceneIndexer indexer)
        {
            try
            {
                using (var reader = indexer.GetIndexWriter().GetReader())
                {
                    return reader.NumDocs();
                }
            }
            catch (AlreadyClosedException)
            {
                LogHelper.Warn(typeof(ExamineExtensions), &quot;Cannot get GetIndexDocumentCount, the writer is already closed&quot;);
                return 0;
            }
        }

        /// &lt;summary&gt;
        /// Return the total number of fields in the index
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexer&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static int GetIndexFieldCount(this LuceneIndexer indexer)
        {
            //TODO: check for closing! and AlreadyClosedException

            try
            {
                using (var reader = indexer.GetIndexWriter().GetReader())
                {
                    return reader.GetFieldNames(IndexReader.FieldOption.ALL).Count;
                }
            }
            catch (AlreadyClosedException)
            {
                LogHelper.Warn(typeof(ExamineExtensions), &quot;Cannot get GetIndexFieldCount, the writer is already closed&quot;);
                return 0;
            }
        }

        /// &lt;summary&gt;
        /// Returns true if the index is optimized or not
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexer&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static bool IsIndexOptimized(this LuceneIndexer indexer)
        {
            try
            {
                using (var reader = indexer.GetIndexWriter().GetReader())
                {
                    return reader.IsOptimized();
                }
            }
            catch (AlreadyClosedException)
            {
                LogHelper.Warn(typeof(ExamineExtensions), &quot;Cannot get IsIndexOptimized, the writer is already closed&quot;);
                return false;
            }
        }

        /// &lt;summary&gt;
        /// Check if the index is locked
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexer&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// If the index does not exist we&#39;ll consider it locked
        /// &lt;/remarks&gt;
        public static bool IsIndexLocked(this LuceneIndexer indexer)
        {   
            return indexer.IndexExists() == false
                   || IndexWriter.IsLocked(indexer.GetLuceneDirectory());
        }

        /// &lt;summary&gt;
        /// The number of documents deleted in the index
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;indexer&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static int GetDeletedDocumentsCount(this LuceneIndexer indexer)
        {
            try
            {
                using (var reader = indexer.GetIndexWriter().GetReader())
                {
                    return reader.NumDeletedDocs();
                }
            }
            catch (AlreadyClosedException)
            {
                LogHelper.Warn(typeof(ExamineExtensions), &quot;Cannot get GetDeletedDocumentsCount, the writer is already closed&quot;);
                return 0;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,0],[27,13,27,14,0],[28,17,28,61,0],[29,17,29,18,0],[30,21,30,31,0],[31,21,31,33,0],[34,13,34,32,0],[35,13,35,14,0],[36,17,36,24,0],[37,17,37,30,0],[39,9,39,10,0],[47,9,47,10,0],[49,13,49,14,0],[50,24,50,73,0],[51,17,51,18,0],[52,21,52,45,0],[55,13,55,43,0],[56,13,56,14,0],[57,17,57,125,0],[58,17,58,26,0],[60,9,60,10,0],[68,9,68,10,0],[72,13,72,14,0],[73,24,73,73,0],[74,17,74,18,0],[75,21,75,84,0],[78,13,78,43,0],[79,13,79,14,0],[80,17,80,122,0],[81,17,81,26,0],[83,9,83,10,0],[91,9,91,10,0],[93,13,93,14,0],[94,24,94,73,0],[95,17,95,18,0],[96,21,96,49,0],[99,13,99,43,0],[100,13,100,14,0],[101,17,101,120,0],[102,17,102,30,0],[104,9,104,10,0],[115,9,115,10,0],[116,13,117,74,0],[118,9,118,10,0],[126,9,126,10,0],[128,13,128,14,0],[129,24,129,73,0],[130,17,130,18,0],[131,21,131,52,0],[134,13,134,43,0],[135,13,135,14,0],[136,17,136,128,0],[137,17,137,26,0],[139,9,139,10,0]]);
    </script>
  </body>
</html>