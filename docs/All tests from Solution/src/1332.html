<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\TemplateQueryController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Umbraco.Core.Models;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi.Filters;
using Umbraco.Web.WebApi;
using System;
using System.Diagnostics;
using Umbraco.Web.Dynamics;
using Umbraco.Web.Models.TemplateQuery;

namespace Umbraco.Web.Editors
{
    

    /// &lt;summary&gt;
    /// The API controller used for building content queries within the template
    /// &lt;/summary&gt;
    [PluginController(&quot;UmbracoApi&quot;)]
    [JsonCamelCaseFormatter]
    public class TemplateQueryController : UmbracoAuthorizedJsonController
    {
        public TemplateQueryController()
        { }

        public TemplateQueryController(UmbracoContext umbracoContext)
            :base(umbracoContext)
        { }


        private static readonly IEnumerable&lt;OperathorTerm&gt; Terms = new List&lt;OperathorTerm&gt;()
            {
                new OperathorTerm(&quot;is&quot;, Operathor.Equals, new [] {&quot;string&quot;}),
                new OperathorTerm(&quot;is not&quot;, Operathor.NotEquals, new [] {&quot;string&quot;}),
                new OperathorTerm(&quot;before&quot;, Operathor.LessThan, new [] {&quot;datetime&quot;}),
                new OperathorTerm(&quot;before (including selected date)&quot;, Operathor.LessThanEqualTo, new [] {&quot;datetime&quot;}),
                new OperathorTerm(&quot;after&quot;, Operathor.GreaterThan, new [] {&quot;datetime&quot;}),
                new OperathorTerm(&quot;after (including selected date)&quot;, Operathor.GreaterThanEqualTo, new [] {&quot;datetime&quot;}),
                new OperathorTerm(&quot;equals&quot;, Operathor.Equals, new [] {&quot;int&quot;}),
                new OperathorTerm(&quot;does not equal&quot;, Operathor.NotEquals, new [] {&quot;int&quot;}),
                new OperathorTerm(&quot;contains&quot;, Operathor.Contains, new [] {&quot;string&quot;}),
                new OperathorTerm(&quot;does not contain&quot;, Operathor.NotContains, new [] {&quot;string&quot;}),
                new OperathorTerm(&quot;greater than&quot;, Operathor.GreaterThan, new [] {&quot;int&quot;}),
                new OperathorTerm(&quot;greater than or equal to&quot;, Operathor.GreaterThanEqualTo, new [] {&quot;int&quot;}),
                new OperathorTerm(&quot;less than&quot;, Operathor.LessThan, new [] {&quot;int&quot;}),
                new OperathorTerm(&quot;less than or equal to&quot;, Operathor.LessThanEqualTo, new [] {&quot;int&quot;})
            };

        private static readonly IEnumerable&lt;PropertyModel&gt; Properties = new List&lt;PropertyModel&gt;()
            {
                new PropertyModel() { Name = &quot;Id&quot;, Alias = &quot;Id&quot;, Type = &quot;int&quot;  },
                new PropertyModel() { Name = &quot;Name&quot;, Alias = &quot;Name&quot;, Type = &quot;string&quot;  },
                //new PropertyModel() { Name = &quot;Url&quot;, Alias = &quot;url&quot;, Type = &quot;string&quot;  },
                new PropertyModel() { Name = &quot;Created Date&quot;, Alias = &quot;CreateDate&quot;, Type = &quot;datetime&quot;  },
                new PropertyModel() { Name = &quot;Last Updated Date&quot;, Alias = &quot;UpdateDate&quot;, Type = &quot;datetime&quot;  }

            };

        public QueryResultModel PostTemplateQuery(QueryModel model)
        {
            var umbraco = new UmbracoHelper(UmbracoContext);

            var queryResult = new QueryResultModel();

            var sb = new StringBuilder();
            
            sb.Append(&quot;CurrentPage.Site()&quot;);
            
            var timer = new Stopwatch();
            
            timer.Start();

            var currentPage = umbraco.TypedContentAtRoot().FirstOrDefault();
            timer.Stop();


            var pointerNode = currentPage;

            // adjust the &quot;FROM&quot;
            if (model != null &amp;&amp; model.Source.Id &gt; 0)
            {
                var targetNode = umbraco.TypedContent(model.Source.Id);

                if (targetNode != null)
                {
                    var aliases = this.GetChildContentTypeAliases(targetNode, currentPage).Reverse();

                    foreach (var contentTypeAlias in aliases)
                    {
                        timer.Start();

                        pointerNode = pointerNode.FirstChild(x =&gt; x.DocumentTypeAlias == contentTypeAlias);

                        if (pointerNode == null) break;

                        timer.Stop();

                        sb.AppendFormat(&quot;.FirstChild(\&quot;{0}\&quot;)&quot;, contentTypeAlias);
                    }

                    if (pointerNode == null || pointerNode.Id != model.Source.Id)
                    {
                        // we did not find the path
                        sb.Clear();
                        sb.AppendFormat(&quot;Umbraco.Content({0})&quot;, model.Source.Id);
                        pointerNode = targetNode;
                    }
                }
            }
                
            // TYPE to return if filtered by type            
            IEnumerable&lt;IPublishedContent&gt; contents;
            if (model != null &amp;&amp; string.IsNullOrEmpty(model.ContentType.Alias) == false)
            {
                timer.Start();

                contents = pointerNode.Children.OfTypes(new[] { model.ContentType.Alias });

                timer.Stop();
                // TODO change to .Children({0})
                sb.AppendFormat(&quot;.Children(\&quot;{0}\&quot;)&quot;, model.ContentType.Alias);
            }
            else
            {
                timer.Start();
                contents = pointerNode.Children;
                timer.Stop();
                sb.Append(&quot;.Children&quot;);
            }

            var clause = string.Empty;

            // WHERE
            var token = 0;

            if (model != null)
            {
                model.Filters = model.Filters.Where(x =&gt; x.ConstraintValue != null);

                foreach (var condition in model.Filters)
                {
                    if(string.IsNullOrEmpty( condition.ConstraintValue)) continue;

                

                    var operation = condition.BuildCondition(token);

                    clause = string.IsNullOrEmpty(clause) ? operation : string.Concat(new[] { clause, &quot; &amp;&amp; &quot;,  operation });

                    token++;
                }

                if (string.IsNullOrEmpty(clause) == false)
                {

                    timer.Start();

                    //clause = &quot;Visible &amp;&amp; &quot; + clause;

                    contents = contents.AsQueryable().Where(clause, model.Filters.Select(this.GetConstraintValue).ToArray());
                    // contents = contents.Where(clause, values.ToArray());
                    contents = contents.Where(x =&gt; x.IsVisible());

                    timer.Stop();

                    clause = string.Format(&quot;\&quot;Visible &amp;&amp; {0}\&quot;,{1}&quot;, clause,
                        string.Join(&quot;,&quot;, model.Filters.Select(x =&gt; x.Property.Type == &quot;string&quot; ? 
                                                                       string.Format(&quot;\&quot;{0}\&quot;&quot;, x.ConstraintValue) : x.ConstraintValue).ToArray()));

                    sb.AppendFormat(&quot;.Where({0})&quot;, clause);
                }
                else
                {
                    timer.Start();

                    contents = contents.Where(x =&gt; x.IsVisible());

                    timer.Stop();

                    sb.Append(&quot;.Where(\&quot;Visible\&quot;)&quot;);

                }

                if (model.Sort != null &amp;&amp; string.IsNullOrEmpty(model.Sort.Property.Alias) == false)
                {
                    timer.Start();

                    contents = this.SortByDefaultPropertyValue(contents, model.Sort);

                    timer.Stop();

                    var direction = model.Sort.Direction == &quot;ascending&quot; ? string.Empty : &quot; desc&quot;;

                    sb.AppendFormat(&quot;.OrderBy(\&quot;{0}{1}\&quot;)&quot;, model.Sort.Property.Alias, direction);
                }

                if (model.Take &gt; 0)
                {
                    timer.Start();

                    contents = contents.Take(model.Take);

                    timer.Stop();

                    sb.AppendFormat(&quot;.Take({0})&quot;, model.Take);
                }
            }

            queryResult.QueryExpression = sb.ToString();
            queryResult.ExecutionTime = timer.ElapsedMilliseconds;
            queryResult.ResultCount = contents.Count();
            queryResult.SampleResults = contents.Take(20).Select(x =&gt; new TemplateQueryResult()
                                                                 {
                                                                     Icon = &quot;icon-file&quot;,
                                                                     Name = x.Name
                                                                 });


            return queryResult;
        }

        private object GetConstraintValue(QueryCondition condition)
        {
            switch (condition.Property.Type)
            {
                case &quot;int&quot; :
                    return int.Parse(condition.ConstraintValue);
                case &quot;datetime&quot;:
                    DateTime dt;
                    return DateTime.TryParse(condition.ConstraintValue, out dt) ? dt : DateTime.Today;
                default:
                    return condition.ConstraintValue;
            }
        }

        private IEnumerable&lt;IPublishedContent&gt; SortByDefaultPropertyValue(IEnumerable&lt;IPublishedContent&gt; contents,  SortExpression sortExpression)
        {
            switch (sortExpression.Property.Alias)
            {
                case &quot;id&quot; :
                    return sortExpression.Direction == &quot;ascending&quot;
                               ? contents.OrderBy(x =&gt; x.Id)
                               : contents.OrderByDescending(x =&gt; x.Id);
                case &quot;createDate&quot; :
               
                    return sortExpression.Direction == &quot;ascending&quot;
                               ? contents.OrderBy(x =&gt; x.CreateDate)
                               : contents.OrderByDescending(x =&gt; x.CreateDate);
                case &quot;publishDate&quot;:
                   
                    return sortExpression.Direction == &quot;ascending&quot;
                               ? contents.OrderBy(x =&gt; x.UpdateDate)
                               : contents.OrderByDescending(x =&gt; x.UpdateDate);
                case &quot;name&quot;:
                    return sortExpression.Direction == &quot;ascending&quot;
                               ? contents.OrderBy(x =&gt; x.Name)
                               : contents.OrderByDescending(x =&gt; x.Name);
                default :

                    return sortExpression.Direction == &quot;ascending&quot;
                               ? contents.OrderBy(x =&gt; x.Name)
                               : contents.OrderByDescending(x =&gt; x.Name);

            }
        }
        
        private IEnumerable&lt;string&gt; GetChildContentTypeAliases(IPublishedContent targetNode, IPublishedContent current)
        {
            var aliases = new List&lt;string&gt;();
    
            if (targetNode.Id == current.Id) return aliases;
            if (targetNode.Id != current.Id)
            {
                aliases.Add(targetNode.DocumentTypeAlias);

            }

            aliases.AddRange(this.GetChildContentTypeAliases(targetNode.Parent, current));

            return aliases;
        }

        /// &lt;summary&gt;
        /// Gets a list of all content types
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public IEnumerable&lt;ContentTypeModel&gt; GetContentTypes()
        {
            var contentTypes =
                ApplicationContext.Services.ContentTypeService.GetAllContentTypes()
                    .Select(x =&gt; new ContentTypeModel() { Alias = x.Alias, Name = x.Name })
                    .OrderBy(x =&gt; x.Name).ToList();
            contentTypes.Insert(0, new ContentTypeModel() { Alias = string.Empty, Name = &quot;Everything&quot; });

            return contentTypes;
        }

        /// &lt;summary&gt;
        /// Returns a collection of allowed properties.
        /// &lt;/summary&gt;
        public IEnumerable&lt;PropertyModel&gt; GetAllowedProperties()
        {
            return Properties.OrderBy(x =&gt; x.Name);
        }

        /// &lt;summary&gt;
        /// Returns a collection of constraint conditions that can be used in the query
        /// &lt;/summary&gt;
        public IEnumerable&lt;object&gt; GetFilterConditions()
        {
            return Terms;
        }


    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,41,0],[25,9,25,10,0],[25,11,25,12,0],[28,14,28,34,0],[29,9,29,10,0],[29,11,29,12,0],[32,9,48,15,0],[50,9,58,15,0],[61,9,61,10,0],[62,13,62,61,0],[64,13,64,54,0],[66,13,66,42,0],[68,13,68,45,0],[70,13,70,41,0],[72,13,72,27,0],[74,13,74,77,0],[75,13,75,26,0],[78,13,78,43,0],[81,13,81,54,0],[82,13,82,14,0],[83,17,83,72,0],[85,17,85,40,0],[86,17,86,18,0],[87,21,87,102,0],[89,21,89,28,0],[89,30,89,50,0],[89,51,89,53,0],[89,54,89,61,0],[90,21,90,22,0],[91,25,91,39,0],[93,25,93,67,0],[93,67,93,106,0],[93,106,93,108,0],[93,25,93,108,0],[95,25,95,49,0],[95,50,95,56,0],[97,25,97,38,0],[99,25,99,83,0],[100,21,100,22,0],[102,21,102,82,0],[103,21,103,22,0],[105,25,105,36,0],[106,25,106,82,0],[107,25,107,50,0],[108,21,108,22,0],[109,17,109,18,0],[110,13,110,14,0],[114,13,114,89,0],[115,13,115,14,0],[116,17,116,31,0],[118,17,118,92,0],[120,17,120,30,0],[122,17,122,80,0],[123,13,123,14,0],[125,13,125,14,0],[126,17,126,31,0],[127,17,127,49,0],[128,17,128,30,0],[129,17,129,40,0],[130,13,130,14,0],[132,13,132,39,0],[135,13,135,27,0],[137,13,137,31,0],[138,13,138,14,0],[139,17,139,58,0],[139,58,139,83,0],[139,83,139,85,0],[139,17,139,85,0],[141,17,141,24,0],[141,26,141,39,0],[141,40,141,42,0],[141,43,141,56,0],[142,17,142,18,0],[143,21,143,73,0],[143,74,143,83,0],[147,21,147,69,0],[149,21,149,125,0],[151,21,151,29,0],[152,17,152,18,0],[154,17,154,59,0],[155,17,155,18,0],[157,21,157,35,0],[161,21,161,126,0],[163,21,163,52,0],[163,52,163,65,0],[163,65,163,67,0],[163,21,163,67,0],[165,21,165,34,0],[167,21,168,68,0],[168,68,169,135,0],[169,135,169,149,0],[167,21,169,149,0],[171,21,171,60,0],[172,17,172,18,0],[174,17,174,18,0],[175,21,175,35,0],[177,21,177,52,0],[177,52,177,65,0],[177,65,177,67,0],[177,21,177,67,0],[179,21,179,34,0],[181,21,181,54,0],[183,17,183,18,0],[185,17,185,100,0],[186,17,186,18,0],[187,21,187,35,0],[189,21,189,86,0],[191,21,191,34,0],[193,21,193,98,0],[195,21,195,99,0],[196,17,196,18,0],[198,17,198,36,0],[199,17,199,18,0],[200,21,200,35,0],[202,21,202,58,0],[204,21,204,34,0],[206,21,206,63,0],[207,17,207,18,0],[208,13,208,14,0],[210,13,210,57,0],[211,13,211,67,0],[212,13,212,56,0],[213,13,213,71,0],[213,71,217,67,0],[217,67,217,69,0],[213,13,217,69,0],[220,13,220,32,0],[221,9,221,10,0],[224,9,224,10,0],[225,13,225,45,0],[228,21,228,65,0],[231,21,231,103,0],[233,21,233,54,0],[235,9,235,10,0],[238,9,238,10,0],[239,13,239,51,0],[242,21,243,56,0],[243,56,243,60,0],[243,60,244,66,0],[244,66,244,70,0],[244,70,244,72,0],[242,21,244,72,0],[247,21,248,56,0],[248,56,248,68,0],[248,68,249,66,0],[249,66,249,78,0],[249,78,249,80,0],[247,21,249,80,0],[252,21,253,56,0],[253,56,253,68,0],[253,68,254,66,0],[254,66,254,78,0],[254,78,254,80,0],[252,21,254,80,0],[256,21,257,56,0],[257,56,257,62,0],[257,62,258,66,0],[258,66,258,72,0],[258,72,258,74,0],[256,21,258,74,0],[261,21,262,56,0],[262,56,262,62,0],[262,62,263,66,0],[263,66,263,72,0],[263,72,263,74,0],[261,21,263,74,0],[266,9,266,10,0],[269,9,269,10,0],[270,13,270,46,0],[272,13,272,45,0],[272,46,272,61,0],[273,13,273,45,0],[274,13,274,14,0],[275,17,275,59,0],[277,13,277,14,0],[279,13,279,91,0],[281,13,281,28,0],[282,9,282,10,0],[289,9,289,10,0],[290,13,292,34,0],[292,34,292,91,0],[292,91,293,35,0],[293,35,293,41,0],[293,41,293,52,0],[290,13,293,52,0],[294,13,294,106,0],[296,13,296,33,0],[297,9,297,10,0],[303,9,303,10,0],[304,13,304,44,0],[304,44,304,50,0],[304,50,304,52,0],[304,13,304,52,0],[305,9,305,10,0],[311,9,311,10,0],[312,13,312,26,0],[313,9,313,10,0]]);
    </script>
  </body>
</html>