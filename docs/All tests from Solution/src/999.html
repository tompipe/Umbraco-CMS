<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\TagsPropertyEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Runtime.InteropServices;
using Newtonsoft.Json.Linq;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Editors;
using Umbraco.Core.PropertyEditors;

namespace Umbraco.Web.PropertyEditors
{
    [SupportTags(typeof(TagPropertyEditorTagDefinition), ValueType = TagValueType.CustomTagList)]
    [PropertyEditor(Constants.PropertyEditors.TagsAlias, &quot;Tags&quot;, &quot;tags&quot;, Icon=&quot;icon-tags&quot;)]
    public class TagsPropertyEditor : PropertyEditor
    {
        public TagsPropertyEditor()
        {
            _defaultPreVals = new Dictionary&lt;string, object&gt;
                {
                    {&quot;group&quot;, &quot;default&quot;},
                    {&quot;storageType&quot;, TagCacheStorageType.Csv.ToString()}
                };
        }

        private IDictionary&lt;string, object&gt; _defaultPreVals;

        /// &lt;summary&gt;
        /// Override to supply the default group
        /// &lt;/summary&gt;
        public override IDictionary&lt;string, object&gt; DefaultPreValues
        {
            get { return _defaultPreVals; }
            set { _defaultPreVals = value; }
        }

        protected override PropertyValueEditor CreateValueEditor()
        {
            return new TagPropertyValueEditor(base.CreateValueEditor());
        }

        protected override PreValueEditor CreatePreValueEditor()
        {
            return new TagPreValueEditor();
        }

        internal class TagPropertyValueEditor : PropertyValueEditorWrapper
        {
            public TagPropertyValueEditor(PropertyValueEditor wrapped)
                : base(wrapped)
            {
            }

            /// &lt;summary&gt;
            /// This needs to return IEnumerable{string}
            /// &lt;/summary&gt;
            /// &lt;param name=&quot;editorValue&quot;&gt;&lt;/param&gt;
            /// &lt;param name=&quot;currentValue&quot;&gt;&lt;/param&gt;
            /// &lt;returns&gt;&lt;/returns&gt;
            public override object ConvertEditorToDb(ContentPropertyData editorValue, object currentValue)
            {
                var json = editorValue.Value as JArray;
                return json == null ? null : json.Select(x =&gt; x.Value&lt;string&gt;());
            }

            /// &lt;summary&gt;
            /// Returns the validator used for the required field validation which is specified on the PropertyType
            /// &lt;/summary&gt;
            /// &lt;remarks&gt;
            /// This will become legacy as soon as we implement overridable pre-values.
            /// 
            /// The default validator used is the RequiredValueValidator but this can be overridden by property editors
            /// if they need to do some custom validation, or if the value being validated is a json object.
            /// &lt;/remarks&gt;
            public override ManifestValueValidator RequiredValidator
            {
                get { return new RequiredTagsValueValidator(); }
            }
            
            /// &lt;summary&gt;
            /// Custom validator to validate a required value against an empty json value
            /// &lt;/summary&gt;
            /// &lt;remarks&gt;
            /// This is required because the Tags property editor is not of type &#39;JSON&#39;, it&#39;s just string so the underlying
            /// validator does not validate against an empty json string
            /// &lt;/remarks&gt;
            [ValueValidator(&quot;Required&quot;)]
            private class RequiredTagsValueValidator : ManifestValueValidator
            {
                /// &lt;summary&gt;
                /// Validates a null value or an empty json value
                /// &lt;/summary&gt;
                /// &lt;param name=&quot;value&quot;&gt;&lt;/param&gt;
                /// &lt;param name=&quot;config&quot;&gt;&lt;/param&gt;
                /// &lt;param name=&quot;preValues&quot;&gt;&lt;/param&gt;
                /// &lt;param name=&quot;editor&quot;&gt;&lt;/param&gt;
                /// &lt;returns&gt;&lt;/returns&gt;
                public override IEnumerable&lt;ValidationResult&gt; Validate(object value, string config, PreValueCollection preValues, PropertyEditor editor)
                {
                    if (value == null)
                    {
                        yield return new ValidationResult(&quot;Value cannot be null&quot;, new[] { &quot;value&quot; });
                    }
                    else
                    {
                        var asString = value.ToString();

                        if (asString.DetectIsEmptyJson())
                        {
                            yield return new ValidationResult(&quot;Value cannot be empty&quot;, new[] { &quot;value&quot; });
                        }

                        if (asString.IsNullOrWhiteSpace())
                        {
                            yield return new ValidationResult(&quot;Value cannot be empty&quot;, new[] { &quot;value&quot; });
                        }
                    }
                }
            }
        }

        internal class TagPreValueEditor : PreValueEditor
        {
            public TagPreValueEditor()
            {
                Fields.Add(new PreValueField(new ManifestPropertyValidator { Type = &quot;Required&quot; })
                {
                    Description = &quot;Define a tag group&quot;,
                    Key = &quot;group&quot;,
                    Name = &quot;Tag group&quot;,
                    View = &quot;requiredfield&quot;
                });

                Fields.Add(new PreValueField(new ManifestPropertyValidator {Type = &quot;Required&quot;})
                {
                    Description = &quot;Select whether to store the tags in cache as CSV (default) or as JSON. The only benefits of storage as JSON is that you are able to have commas in a tag value but this will require parsing the json in your views or using a property value converter&quot;,
                    Key = &quot;storageType&quot;,
                    Name = &quot;Storage Type&quot;,
                    View = &quot;views/propertyeditors/tags/tags.prevalues.html&quot;
                });
            }

            public override IDictionary&lt;string, object&gt; ConvertDbToEditor(IDictionary&lt;string, object&gt; defaultPreVals, PreValueCollection persistedPreVals)
            {
                var result = base.ConvertDbToEditor(defaultPreVals, persistedPreVals);

                //This is required because we&#39;ve added this pre-value so old installs that don&#39;t have it will need to have a default.
                if (result.ContainsKey(&quot;storageType&quot;) == false || result[&quot;storageType&quot;] == null || result[&quot;storageType&quot;].ToString().IsNullOrWhiteSpace())
                {
                    result[&quot;storageType&quot;] = TagCacheStorageType.Csv.ToString();
                }

                return result;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,36,1],[18,9,18,10,1],[19,13,23,19,1],[24,9,24,10,1],[33,17,33,18,0],[33,19,33,42,0],[33,43,33,44,0],[34,17,34,18,0],[34,19,34,43,0],[34,44,34,45,0],[38,9,38,10,1],[39,13,39,73,1],[40,9,40,10,1],[43,9,43,10,0],[44,13,44,44,0],[45,9,45,10,0],[50,19,50,32,1],[51,13,51,14,1],[52,13,52,14,1],[61,13,61,14,0],[62,17,62,56,0],[63,17,63,63,0],[63,63,63,80,0],[63,80,63,82,0],[63,17,63,82,0],[64,13,64,14,0],[77,21,77,22,0],[77,23,77,63,0],[77,64,77,65,0],[124,13,124,39,0],[125,13,125,14,0],[126,17,132,20,0],[134,17,140,20,0],[141,13,141,14,0],[144,13,144,14,0],[145,17,145,87,0],[148,17,148,154,0],[149,17,149,18,0],[150,21,150,80,0],[151,17,151,18,0],[153,17,153,31,0],[154,13,154,14,0]]);
    </script>
  </body>
</html>