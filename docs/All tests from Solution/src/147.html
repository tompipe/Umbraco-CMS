<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Integration\GetCultureTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Moq;
using NUnit.Framework;
using umbraco.cms.businesslogic.web;
using Umbraco.Core.Models;
using Umbraco.Tests.Services;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;
using Umbraco.Web.Routing;
using Language = umbraco.cms.businesslogic.language.Language;

namespace Umbraco.Tests.Integration
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, RequiresSTA]
    public class GetCultureTests : BaseServiceTest
    {
        protected override void FreezeResolution()
        {
            SiteDomainHelperResolver.Current = new SiteDomainHelperResolver(new SiteDomainHelper());

            base.FreezeResolution();
        }

        [Test]
        public void GetCulture()
        {
            var contentTypeService = ServiceContext.ContentTypeService;
            var contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbBlah&quot;, &quot;test Doc Type&quot;);
            contentTypeService.Save(contentType);
            var contentService = ServiceContext.ContentService;

            var c1 = contentService.CreateContentWithIdentity(&quot;content&quot;, -1, &quot;umbBlah&quot;);
            var c2 = contentService.CreateContentWithIdentity(&quot;content&quot;, c1, &quot;umbBlah&quot;);
            var c3 = contentService.CreateContentWithIdentity(&quot;content&quot;, c1, &quot;umbBlah&quot;);
            var c4 = contentService.CreateContentWithIdentity(&quot;content&quot;, c3, &quot;umbBlah&quot;);

            foreach (var l in ServiceContext.LocalizationService.GetAllLanguages().Where(x =&gt; x.CultureName != &quot;en-US&quot;).ToArray())
                ServiceContext.LocalizationService.Delete(l);

            var l0 = ServiceContext.LocalizationService.GetLanguageByIsoCode(&quot;en-US&quot;);
            var l1 = new Core.Models.Language(&quot;fr-FR&quot;);
            var l2 = new Core.Models.Language(&quot;de-DE&quot;);
            ServiceContext.LocalizationService.Save(l1);
            ServiceContext.LocalizationService.Save(l2);

            foreach (var d in ServiceContext.DomainService.GetAll(true).ToArray())
                ServiceContext.DomainService.Delete(d);

            ServiceContext.DomainService.Save(new UmbracoDomain(&quot;domain1.com&quot;) {DomainName=&quot;domain1.com&quot;, RootContentId = c1.Id, LanguageId = l0.Id});
            ServiceContext.DomainService.Save(new UmbracoDomain(&quot;domain1.fr&quot;) { DomainName = &quot;domain1.fr&quot;, RootContentId = c1.Id, LanguageId = l1.Id });
            ServiceContext.DomainService.Save(new UmbracoDomain(&quot;*100112&quot;) { DomainName = &quot;*100112&quot;, RootContentId = c3.Id, LanguageId = l2.Id });

            var content = c2;
            var culture = global::Umbraco.Web.Models.ContentExtensions.GetCulture(null,
                ServiceContext.DomainService, ServiceContext.LocalizationService, ServiceContext.ContentService,
                content.Id, content.Path, new Uri(&quot;http://domain1.com/&quot;));
            Assert.AreEqual(&quot;en-US&quot;, culture.Name);

            content = c2;
            culture = global::Umbraco.Web.Models.ContentExtensions.GetCulture(null,
                ServiceContext.DomainService, ServiceContext.LocalizationService, ServiceContext.ContentService, 
                content.Id, content.Path, new Uri(&quot;http://domain1.fr/&quot;));
            Assert.AreEqual(&quot;fr-FR&quot;, culture.Name);

            content = c4;
            culture = global::Umbraco.Web.Models.ContentExtensions.GetCulture(null,
                ServiceContext.DomainService, ServiceContext.LocalizationService, ServiceContext.ContentService, 
                content.Id, content.Path, new Uri(&quot;http://domain1.fr/&quot;));
            Assert.AreEqual(&quot;de-DE&quot;, culture.Name);
        }

        [Test]
        public void GetCultureWithWildcard()
        {
            var contentTypeService = ServiceContext.ContentTypeService;
            var contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbBlah&quot;, &quot;test Doc Type&quot;);
            contentTypeService.Save(contentType);
            var contentService = ServiceContext.ContentService;

            var c1 = contentService.CreateContentWithIdentity(&quot;content&quot;, -1, &quot;umbBlah&quot;);
            var c2 = contentService.CreateContentWithIdentity(&quot;content&quot;, c1, &quot;umbBlah&quot;);
            var c3 = contentService.CreateContentWithIdentity(&quot;content&quot;, c1, &quot;umbBlah&quot;);
            var c4 = contentService.CreateContentWithIdentity(&quot;content&quot;, c3, &quot;umbBlah&quot;);

            foreach (var l in ServiceContext.LocalizationService.GetAllLanguages().Where(x =&gt; x.CultureName != &quot;en-US&quot;).ToArray())
                ServiceContext.LocalizationService.Delete(l);

            var l0 = ServiceContext.LocalizationService.GetLanguageByIsoCode(&quot;en-US&quot;);
            var l1 = new Core.Models.Language(&quot;fr-FR&quot;);
            var l2 = new Core.Models.Language(&quot;de-DE&quot;);
            ServiceContext.LocalizationService.Save(l1);
            ServiceContext.LocalizationService.Save(l2);

            foreach (var d in ServiceContext.DomainService.GetAll(true).ToArray())
                ServiceContext.DomainService.Delete(d);

            ServiceContext.DomainService.Save(new UmbracoDomain(&quot;*0000&quot;) { DomainName = &quot;*0000&quot;, RootContentId = c1.Id, LanguageId = l2.Id });
            ServiceContext.DomainService.Save(new UmbracoDomain(&quot;*0001&quot;) { DomainName = &quot;*0001&quot;, RootContentId = c3.Id, LanguageId = l1.Id });
            //ServiceContext.DomainService.Save(new UmbracoDomain(&quot;*100112&quot;) { DomainName = &quot;*100112&quot;, RootContentId = c3.Id, LanguageId = l2.Id });

            var content = c2;
            var culture = Umbraco.Web.Models.ContentExtensions.GetCulture(null,
                ServiceContext.DomainService, ServiceContext.LocalizationService, ServiceContext.ContentService,
                content.Id, content.Path, new Uri(&quot;http://domain1.com/&quot;));
            Assert.AreEqual(&quot;de-DE&quot;, culture.Name);

            content = c4;
            culture = Umbraco.Web.Models.ContentExtensions.GetCulture(null,
                ServiceContext.DomainService, ServiceContext.LocalizationService, ServiceContext.ContentService,
                content.Id, content.Path, new Uri(&quot;http://domain1.fr/&quot;));
            Assert.AreEqual(&quot;fr-FR&quot;, culture.Name);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[24,13,24,101,1],[26,13,26,37,1],[27,9,27,10,1],[31,9,31,10,1],[32,13,32,72,1],[33,13,33,102,1],[34,13,34,50,1],[35,13,35,64,1],[37,13,37,89,1],[38,13,38,89,1],[39,13,39,89,1],[40,13,40,89,1],[42,13,42,20,1],[42,22,42,27,0],[42,28,42,30,1],[42,31,42,95,1],[42,95,42,119,1],[42,119,42,130,1],[42,31,42,130,1],[43,17,43,62,0],[45,13,45,87,1],[46,13,46,56,1],[47,13,47,56,1],[48,13,48,57,1],[49,13,49,57,1],[51,13,51,20,1],[51,22,51,27,0],[51,28,51,30,1],[51,31,51,82,1],[52,17,52,56,0],[54,13,54,151,1],[55,13,55,153,1],[56,13,56,147,1],[58,13,58,30,1],[59,13,61,75,1],[62,13,62,52,1],[64,13,64,26,1],[65,13,67,74,1],[68,13,68,52,1],[70,13,70,26,1],[71,13,73,74,1],[74,13,74,52,1],[75,9,75,10,1],[79,9,79,10,1],[80,13,80,72,1],[81,13,81,102,1],[82,13,82,50,1],[83,13,83,64,1],[85,13,85,89,1],[86,13,86,89,1],[87,13,87,89,1],[88,13,88,89,1],[90,13,90,20,1],[90,22,90,27,0],[90,28,90,30,1],[90,31,90,95,1],[90,95,90,119,1],[90,119,90,130,1],[90,31,90,130,1],[91,17,91,62,0],[93,13,93,87,1],[94,13,94,56,1],[95,13,95,56,1],[96,13,96,57,1],[97,13,97,57,1],[99,13,99,20,1],[99,22,99,27,0],[99,28,99,30,1],[99,31,99,82,1],[100,17,100,56,0],[102,13,102,143,1],[103,13,103,143,1],[106,13,106,30,1],[107,13,109,75,1],[110,13,110,52,1],[112,13,112,26,1],[113,13,115,74,1],[116,13,116,52,1],[117,9,117,10,1]]);
    </script>
  </body>
</html>