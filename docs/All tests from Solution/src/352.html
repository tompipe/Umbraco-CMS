<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Querying\QueryBuilderTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Querying
{
    [TestFixture]
    public class QueryBuilderTests : BaseUsingSqlCeSyntax
    {
        

        [Test]
        public void Can_Build_StartsWith_Query_For_IContent()
        {
            // Arrange
            var sql = new Sql();
            sql.Select(&quot;*&quot;);
            sql.From(&quot;umbracoNode&quot;);

            var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Path.StartsWith(&quot;-1&quot;));

            // Act
            var translator = new SqlTranslator&lt;IContent&gt;(sql, query);
            var result = translator.Translate();
            var strResult = result.SQL;

            string expectedResult = &quot;SELECT *\nFROM umbracoNode\nWHERE (upper([umbracoNode].[path]) LIKE upper(@0))&quot;;

            // Assert
            Assert.That(strResult, Is.Not.Empty);
            Assert.That(strResult, Is.EqualTo(expectedResult));

            Assert.AreEqual(1, result.Arguments.Length);
            Assert.AreEqual(&quot;-1%&quot;, sql.Arguments[0]);

            Debug.Print(strResult);
        }

        [Test]
        public void Can_Build_ParentId_Query_For_IContent()
        {
            // Arrange
            var sql = new Sql();
            sql.Select(&quot;*&quot;);
            sql.From(&quot;umbracoNode&quot;);

            var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.ParentId == -1);

            // Act
            var translator = new SqlTranslator&lt;IContent&gt;(sql, query);
            var result = translator.Translate();
            var strResult = result.SQL;

            string expectedResult = &quot;SELECT *\nFROM umbracoNode\nWHERE (([umbracoNode].[parentID] = @0))&quot;;

            // Assert
            Assert.That(strResult, Is.Not.Empty);
            Assert.That(strResult, Is.EqualTo(expectedResult));

            Assert.AreEqual(1, result.Arguments.Length);
            Assert.AreEqual(-1, sql.Arguments[0]);

            Debug.Print(strResult);
        }

        [Test]
        public void Can_Build_ContentTypeAlias_Query_For_IContentType()
        {
            // Arrange
            var sql = new Sql();
            sql.Select(&quot;*&quot;);
            sql.From(&quot;umbracoNode&quot;);

            var query = Query&lt;IContentType&gt;.Builder.Where(x =&gt; x.Alias == &quot;umbTextpage&quot;);

            // Act
            var translator = new SqlTranslator&lt;IContentType&gt;(sql, query);
            var result = translator.Translate();
            var strResult = result.SQL;

            string expectedResult = &quot;SELECT *\nFROM umbracoNode\nWHERE (([cmsContentType].[alias] = @0))&quot;;

            // Assert
            Assert.That(strResult, Is.Not.Empty);
            Assert.That(strResult, Is.EqualTo(expectedResult));
            Assert.AreEqual(1, result.Arguments.Length);
            Assert.AreEqual(&quot;umbTextpage&quot;, sql.Arguments[0]);

            Debug.Print(strResult);
        }

        [Test]
        public void Can_Build_PublishedDescendants_Query_For_IContent()
        {
            // Arrange
            var path = &quot;-1,1046,1076,1089&quot;;
            var id = 1046;
            var nodeObjectTypeId = new Guid(Constants.ObjectTypes.Document);

            var sql = new Sql();
            sql.Select(&quot;*&quot;)
                .From&lt;DocumentDto&gt;()
                .InnerJoin&lt;ContentVersionDto&gt;()
                .On&lt;DocumentDto, ContentVersionDto&gt;(left =&gt; left.VersionId, right =&gt; right.VersionId)
                .InnerJoin&lt;ContentDto&gt;()
                .On&lt;ContentVersionDto, ContentDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .InnerJoin&lt;NodeDto&gt;()
                .On&lt;ContentDto, NodeDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == nodeObjectTypeId);

            var query = Query&lt;IContent&gt;.Builder.Where(x =&gt; x.Path.StartsWith(path) &amp;&amp; x.Id != id &amp;&amp; x.Published == true &amp;&amp; x.Trashed == false);

            // Act
            var translator = new SqlTranslator&lt;IContent&gt;(sql, query);
            var result = translator.Translate();
            var strResult = result.SQL;

            // Assert
            Debug.Print(strResult);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[22,13,22,33,1],[23,13,23,29,1],[24,13,24,37,1],[26,13,26,85,1],[29,13,29,70,1],[30,13,30,49,1],[31,13,31,40,1],[33,13,33,118,1],[36,13,36,50,1],[37,13,37,64,1],[39,13,39,57,1],[40,13,40,54,1],[42,13,42,36,1],[43,9,43,10,1],[47,9,47,10,1],[49,13,49,33,1],[50,13,50,29,1],[51,13,51,37,1],[53,13,53,78,1],[56,13,56,70,1],[57,13,57,49,1],[58,13,58,40,1],[60,13,60,107,1],[63,13,63,50,1],[64,13,64,64,1],[66,13,66,57,1],[67,13,67,51,1],[69,13,69,36,1],[70,9,70,10,1],[74,9,74,10,1],[76,13,76,33,1],[77,13,77,29,1],[78,13,78,37,1],[80,13,80,90,1],[83,13,83,74,1],[84,13,84,49,1],[85,13,85,40,1],[87,13,87,107,1],[90,13,90,50,1],[91,13,91,64,1],[92,13,92,57,1],[93,13,93,62,1],[95,13,95,36,1],[96,9,96,10,1],[100,9,100,10,1],[102,13,102,44,1],[103,13,103,27,1],[104,13,104,77,1],[106,13,106,33,1],[107,13,115,76,1],[117,13,117,144,1],[120,13,120,70,1],[121,13,121,49,1],[122,13,122,40,1],[125,13,125,36,1],[126,9,126,10,1]]);
    </script>
  </body>
</html>