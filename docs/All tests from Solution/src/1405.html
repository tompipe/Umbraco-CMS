<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\ObservableDictionary.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Umbraco.Core
{
    /// &lt;summary&gt;
    /// An ObservableDictionary 
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// Assumes that the key will not change and is unique for each element in the collection.
    /// Collection is not thread-safe, so calls should be made single-threaded.
    /// &lt;/remarks&gt;
    /// &lt;typeparam name=&quot;TValue&quot;&gt;The type of elements contained in the BindableCollection&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TKey&quot;&gt;The type of the indexing key&lt;/typeparam&gt;
    public class ObservableDictionary&lt;TKey, TValue&gt; : ObservableCollection&lt;TValue&gt;
    {
        protected Dictionary&lt;TKey, int&gt; Indecies = new Dictionary&lt;TKey, int&gt;();
        protected Func&lt;TValue, TKey&gt; KeySelector;

        /// &lt;summary&gt;
        /// Create new ObservableDictionary
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;keySelector&quot;&gt;Selector function to create key from value&lt;/param&gt;
        public ObservableDictionary(Func&lt;TValue, TKey&gt; keySelector)
            : base()
        {
            if (keySelector == null) throw new ArgumentException(&quot;keySelector&quot;);
            KeySelector = keySelector;
        }

        #region Protected Methods
        protected override void InsertItem(int index, TValue item)
        {
            var key = KeySelector(item);
            if (Indecies.ContainsKey(key))
                throw new DuplicateKeyException(key.ToString());

            if (index != this.Count)
            {
                foreach (var k in Indecies.Keys.Where(k =&gt; Indecies[k] &gt;= index).ToList())
                {
                    Indecies[k]++;
                }
            }

            base.InsertItem(index, item);
            Indecies[key] = index;

        }

        protected override void ClearItems()
        {
            base.ClearItems();
            Indecies.Clear();
        }


        protected override void RemoveItem(int index)
        {
            var item = this[index];
            var key = KeySelector(item);

            base.RemoveItem(index);

            Indecies.Remove(key);

            foreach (var k in Indecies.Keys.Where(k =&gt; Indecies[k] &gt; index).ToList())
            {
                Indecies[k]--;
            }
        }
        #endregion

        public virtual bool ContainsKey(TKey key)
        {
            return Indecies.ContainsKey(key);
        }

        /// &lt;summary&gt;
        /// Gets or sets the element with the specified key.  If setting a new value, new value must have same key.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Key of element to replace&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public virtual TValue this[TKey key]
        {

            get { return this[Indecies[key]]; }
            set
            {
                //confirm key matches
                if (!KeySelector(value).Equals(key))
                    throw new InvalidOperationException(&quot;Key of new value does not match&quot;);

                if (!Indecies.ContainsKey(key))
                {
                    this.Add(value);
                }
                else
                {
                    this[Indecies[key]] = value;
                }
            }
        }

        /// &lt;summary&gt;
        /// Replaces element at given key with new value.  New value must have same key.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Key of element to replace&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;New value&lt;/param&gt;
        /// 
        /// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;&lt;/exception&gt;
        /// &lt;returns&gt;False if key not found&lt;/returns&gt;
        public virtual bool Replace(TKey key, TValue value)
        {
            if (!Indecies.ContainsKey(key)) return false;
            //confirm key matches
            if (!KeySelector(value).Equals(key))
                throw new InvalidOperationException(&quot;Key of new value does not match&quot;);

            this[Indecies[key]] = value;
            return true;

        }

        public virtual bool Remove(TKey key)
        {
            if (!Indecies.ContainsKey(key)) return false;

            this.RemoveAt(Indecies[key]);
            return true;

        }

        /// &lt;summary&gt;
        /// Allows us to change the key of an item
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;currentKey&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;newKey&quot;&gt;&lt;/param&gt;
        public virtual void ChangeKey(TKey currentKey, TKey newKey)
        {
            if (!Indecies.ContainsKey(currentKey))
            {
                throw new InvalidOperationException(&quot;No item with the key &quot; + currentKey + &quot;was found in the collection&quot;);
            }
            if (ContainsKey(newKey))
            {
                throw new DuplicateKeyException(newKey.ToString());
            }

            var currentIndex = Indecies[currentKey];

            Indecies.Remove(currentKey);
            Indecies.Add(newKey, currentIndex);
        }

        internal class DuplicateKeyException : Exception
        {

            public string Key { get; private set; }
            public DuplicateKeyException(string key)
                : base(&quot;Attempted to insert duplicate key &quot; + key + &quot; in collection&quot;)
            {
                Key = key;
            }
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,80,1],[29,15,29,21,1],[30,9,30,10,1],[31,13,31,37,1],[31,38,31,81,0],[32,13,32,39,1],[33,9,33,10,1],[37,9,37,10,1],[38,13,38,41,1],[39,13,39,43,1],[40,17,40,65,0],[42,13,42,37,1],[43,13,43,14,0],[44,17,44,24,0],[44,26,44,31,0],[44,32,44,34,0],[44,35,44,60,0],[44,60,44,80,0],[44,80,44,90,0],[44,35,44,90,0],[45,17,45,18,0],[46,21,46,35,0],[47,17,47,18,0],[48,13,48,14,0],[50,13,50,42,1],[51,13,51,35,1],[53,9,53,10,1],[56,9,56,10,0],[57,13,57,31,0],[58,13,58,30,0],[59,9,59,10,0],[63,9,63,10,1],[64,13,64,36,1],[65,13,65,41,1],[67,13,67,36,1],[69,13,69,34,1],[71,13,71,20,1],[71,22,71,27,1],[71,28,71,30,1],[71,31,71,56,1],[71,56,71,75,1],[71,75,71,85,1],[71,31,71,85,1],[72,13,72,14,1],[73,17,73,31,1],[74,13,74,14,1],[75,9,75,10,1],[79,9,79,10,1],[80,13,80,46,1],[81,9,81,10,1],[91,17,91,18,1],[91,19,91,46,1],[91,47,91,48,1],[93,13,93,14,0],[95,17,95,53,0],[96,21,96,92,0],[98,17,98,48,0],[99,17,99,18,0],[100,21,100,37,0],[101,17,101,18,0],[103,17,103,18,0],[104,21,104,49,0],[105,17,105,18,0],[106,13,106,14,0],[118,9,118,10,0],[119,13,119,44,0],[119,45,119,58,0],[121,13,121,49,0],[122,17,122,88,0],[124,13,124,41,0],[125,13,125,25,0],[127,9,127,10,0],[130,9,130,10,1],[131,13,131,44,1],[131,45,131,58,0],[133,13,133,42,1],[134,13,134,25,1],[136,9,136,10,1],[144,9,144,10,1],[145,13,145,51,1],[146,13,146,14,0],[147,17,147,123,0],[149,13,149,37,1],[150,13,150,14,0],[151,17,151,68,0],[154,13,154,53,1],[156,13,156,41,1],[157,13,157,48,1],[158,9,158,10,1],[163,33,163,37,0],[163,38,163,50,0],[165,19,165,86,0],[166,13,166,14,0],[167,17,167,27,0],[168,13,168,14,0]]);
    </script>
  </body>
</html>