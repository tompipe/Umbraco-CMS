<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\HtmlHelperBackOfficeExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web;
using System.Web.Mvc;
using ClientDependency.Core.Config;
using Microsoft.Owin.Security;
using Newtonsoft.Json;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Web.Editors;
using Umbraco.Web.Models;

namespace Umbraco.Web
{
    using Umbraco.Core.Configuration;

    /// &lt;summary&gt;
    /// HtmlHelper extensions for the back office
    /// &lt;/summary&gt;
    public static class HtmlHelperBackOfficeExtensions
    {
        /// &lt;summary&gt;
        /// Outputs a script tag containing the bare minimum (non secure) server vars for use with the angular app
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;uri&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;externalLoginsUrl&quot;&gt;
        /// The post url used to sign in with external logins - this can change depending on for what service the external login is service.
        /// Example: normal back office login or authenticating upgrade login
        /// &lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;remarks&gt;
        /// These are the bare minimal server variables that are required for the application to start without being authenticated,
        /// we will load the rest of the server vars after the user is authenticated.
        /// &lt;/remarks&gt;
        public static IHtmlString BareMinimumServerVariablesScript(this HtmlHelper html, UrlHelper uri, string externalLoginsUrl)
        {
            var version = UmbracoVersion.GetSemanticVersion().ToSemanticString();
            var str = @&quot;&lt;script type=&quot;&quot;text/javascript&quot;&quot;&gt;
                var Umbraco = {};
                Umbraco.Sys = {};
                Umbraco.Sys.ServerVariables = {
                    &quot;&quot;umbracoUrls&quot;&quot;: {
                        &quot;&quot;authenticationApiBaseUrl&quot;&quot;: &quot;&quot;&quot; + uri.GetUmbracoApiServiceBaseUrl&lt;AuthenticationController&gt;(controller =&gt; controller.PostLogin(null)) + @&quot;&quot;&quot;,
                        &quot;&quot;serverVarsJs&quot;&quot;: &quot;&quot;&quot; + uri.GetUrlWithCacheBust(&quot;ServerVariables&quot;, &quot;BackOffice&quot;) + @&quot;&quot;&quot;,
                        &quot;&quot;externalLoginsUrl&quot;&quot;: &quot;&quot;&quot; + externalLoginsUrl + @&quot;&quot;&quot;
                    },
                    &quot;&quot;umbracoSettings&quot;&quot;: {
                        &quot;&quot;allowPasswordReset&quot;&quot;: &quot; + (UmbracoConfig.For.UmbracoSettings().Security.AllowPasswordReset ? &quot;true&quot; : &quot;false&quot;) + @&quot;
                    },
                    &quot;&quot;application&quot;&quot;: {
                        &quot;&quot;applicationPath&quot;&quot;: &quot;&quot;&quot; + html.ViewContext.HttpContext.Request.ApplicationPath + @&quot;&quot;&quot;,
                        &quot;&quot;version&quot;&quot;: &quot;&quot;&quot; + version + @&quot;&quot;&quot;,
                        &quot;&quot;cdf&quot;&quot;: &quot;&quot;&quot; + ClientDependencySettings.Instance.Version + @&quot;&quot;&quot;
                    },
                    &quot;&quot;isDebuggingEnabled&quot;&quot; : &quot; + html.ViewContext.HttpContext.IsDebuggingEnabled.ToString().ToLowerInvariant() + @&quot;
                };       
            &lt;/script&gt;&quot;;

            return html.Raw(str);
        }      

        /// &lt;summary&gt;
        /// Used to render the script that will pass in the angular &quot;externalLoginInfo&quot; service/value on page load
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;externalLoginErrors&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IHtmlString AngularValueExternalLoginInfoScript(this HtmlHelper html, IEnumerable&lt;string&gt; externalLoginErrors)
        {
            var loginProviders = html.ViewContext.HttpContext.GetOwinContext().Authentication.GetExternalAuthenticationTypes()
                .Where(p =&gt; p.Properties.ContainsKey(&quot;UmbracoBackOffice&quot;))
                .Select(p =&gt; new
                {
                    authType = p.AuthenticationType,
                    caption = p.Caption,
                    properties = p.Properties
                })
                .ToArray();

            var sb = new StringBuilder();
            sb.AppendLine();
            sb.AppendLine(@&quot;var errors = [];&quot;);

            if (externalLoginErrors != null)
            {
                foreach (var error in externalLoginErrors)
                {
                    sb.AppendFormat(@&quot;errors.push(&quot;&quot;{0}&quot;&quot;);&quot;, error).AppendLine();
                }
            }

            sb.AppendLine(@&quot;app.value(&quot;&quot;externalLoginInfo&quot;&quot;, {&quot;);
            sb.AppendLine(@&quot;errors: errors,&quot;);
            sb.Append(@&quot;providers: &quot;);
            sb.AppendLine(JsonConvert.SerializeObject(loginProviders));
            sb.AppendLine(@&quot;});&quot;);

            return html.Raw(sb.ToString());
        }

        /// &lt;summary&gt;
        /// Used to render the script that will pass in the angular &quot;resetPasswordCodeInfo&quot; service/value on page load
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;html&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;val&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IHtmlString AngularValueResetPasswordCodeInfoScript(this HtmlHelper html, object val)
        {
            var sb = new StringBuilder();
            sb.AppendLine();
            sb.AppendLine(@&quot;var errors = [];&quot;);

            var errors = val as IEnumerable&lt;string&gt;;
            if (errors != null)
            {
                foreach (var error in errors)
                {
                    sb.AppendFormat(@&quot;errors.push(&quot;&quot;{0}&quot;&quot;);&quot;, error).AppendLine();
                }
            }

            var resetCodeModel = val as ValidatePasswordResetCodeModel;


            sb.AppendLine(@&quot;app.value(&quot;&quot;resetPasswordCodeInfo&quot;&quot;, {&quot;);
            sb.AppendLine(@&quot;errors: errors,&quot;);            
            sb.Append(@&quot;resetCodeModel: &quot;);
            sb.AppendLine(JsonConvert.SerializeObject(resetCodeModel));
            sb.AppendLine(@&quot;});&quot;);

            return html.Raw(sb.ToString());
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[38,9,38,10,0],[39,13,39,82,0],[40,13,59,24,0],[61,13,61,34,0],[62,9,62,10,0],[71,9,71,10,0],[72,13,73,29,0],[73,29,73,74,0],[73,74,74,30,0],[74,30,79,18,0],[79,18,80,28,0],[72,13,80,28,0],[82,13,82,42,0],[83,13,83,29,0],[84,13,84,48,0],[86,13,86,45,0],[87,13,87,14,0],[88,17,88,24,0],[88,26,88,35,0],[88,36,88,38,0],[88,39,88,58,0],[89,17,89,18,0],[90,21,90,83,0],[91,17,91,18,0],[92,13,92,14,0],[94,13,94,66,0],[95,13,95,47,0],[96,13,96,39,0],[97,13,97,72,0],[98,13,98,35,0],[100,13,100,44,0],[101,9,101,10,0],[110,9,110,10,0],[111,13,111,42,0],[112,13,112,29,0],[113,13,113,48,0],[115,13,115,53,0],[116,13,116,32,0],[117,13,117,14,0],[118,17,118,24,0],[118,26,118,35,0],[118,36,118,38,0],[118,39,118,45,0],[119,17,119,18,0],[120,21,120,83,0],[121,17,121,18,0],[122,13,122,14,0],[124,13,124,72,0],[127,13,127,70,0],[128,13,128,47,0],[129,13,129,44,0],[130,13,130,72,0],[131,13,131,35,0],[133,13,133,44,0],[134,9,134,10,0]]);
    </script>
  </body>
</html>