<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\RichTextPreValueController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml;
using Umbraco.Core.IO;
using Umbraco.Web.Editors;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Mvc;

namespace Umbraco.Web.PropertyEditors
{
    /// &lt;summary&gt;
    /// ApiController to provide RTE configuration with available plugins and commands from the RTE config
    /// &lt;/summary&gt;
    [PluginController(&quot;UmbracoApi&quot;)]
    public class RichTextPreValueController : UmbracoAuthorizedJsonController
    {
        private static volatile bool _init = false;
        private static readonly object Locker = new object();
        private static readonly Dictionary&lt;string, RichTextEditorCommand&gt; Commands = new Dictionary&lt;string,RichTextEditorCommand&gt;();
        private static readonly Dictionary&lt;string, RichTextEditorPlugin&gt; Plugins = new Dictionary&lt;string, RichTextEditorPlugin&gt;();
        private static readonly Dictionary&lt;string, string&gt; ConfigOptions = new Dictionary&lt;string, string&gt;();
       
        private static string _invalidElements = &quot;&quot;;
        private static string _validElements = &quot;&quot;;


        public RichTextEditorConfiguration GetConfiguration()
        {
            EnsureInit();

            RichTextEditorConfiguration config = new RichTextEditorConfiguration();
            config.Plugins = Plugins.Values;
            config.Commands = Commands.Values;
            config.ValidElements = _validElements;
            config.InvalidElements = _invalidElements;
            config.CustomConfig = ConfigOptions;

            return config;
        }

        private static void EnsureInit()
        {

            if (_init == false)
            {
                lock (Locker)
                {
                    if (_init == false)
                    {
                        // Load config
                        XmlDocument xd = new XmlDocument();
                        xd.Load(IOHelper.MapPath(SystemFiles.TinyMceConfig));

                        foreach (XmlNode n in xd.DocumentElement.SelectNodes(&quot;//command&quot;))
                        {
                            var alias = n.SelectSingleNode(&quot;./umbracoAlias&quot;).FirstChild.Value.ToLower();

                            bool isStyle = false;
                            if (n.Attributes.GetNamedItem(&quot;isStyle&quot;) != null)
                                isStyle = bool.Parse(n.Attributes.GetNamedItem(&quot;isStyle&quot;).Value);

                            if (!Commands.ContainsKey(alias))
                                Commands.Add(
                                         alias,
                                         new RichTextEditorCommand()
                                         {
                                             IsStylePicker = isStyle,
                                             Name = n.SelectSingleNode(&quot;./name&quot;) != null ? n.SelectSingleNode(&quot;./name&quot;).FirstChild.Value : alias,
                                             Icon = n.SelectSingleNode(&quot;./icon&quot;).FirstChild.Value,
                                             Command = n.SelectSingleNode(&quot;./tinyMceCommand&quot;).FirstChild.Value,
                                             Alias = alias,
                                             UserInterface = n.SelectSingleNode(&quot;./tinyMceCommand&quot;).Attributes.GetNamedItem(&quot;userInterface&quot;).Value,
                                             FrontEndCommand = n.SelectSingleNode(&quot;./tinyMceCommand&quot;).Attributes.GetNamedItem(&quot;frontendCommand&quot;).Value,
                                             Value = n.SelectSingleNode(&quot;./tinyMceCommand&quot;).Attributes.GetNamedItem(&quot;value&quot;).Value,
                                             Priority = int.Parse(n.SelectSingleNode(&quot;./priority&quot;).FirstChild.Value)
                                         }
                                   );
                        }


                        foreach (XmlNode n in xd.DocumentElement.SelectNodes(&quot;//plugin&quot;))
                        {
                            if (!Plugins.ContainsKey(n.FirstChild.Value))
                            {
                                bool useOnFrontend = false;
                                if (n.Attributes.GetNamedItem(&quot;loadOnFrontend&quot;) != null)
                                    useOnFrontend = bool.Parse(n.Attributes.GetNamedItem(&quot;loadOnFrontend&quot;).Value);

                                Plugins.Add(
                                    n.FirstChild.Value.ToLower(),
                                    new RichTextEditorPlugin()
                                    {
                                        Name = n.FirstChild.Value,
                                        UseOnFrontend = useOnFrontend
                                    });
                            }
                        }


                        foreach (XmlNode n in xd.DocumentElement.SelectNodes(&quot;//config&quot;))
                        {
                            if (!ConfigOptions.ContainsKey(n.Attributes[&quot;key&quot;].FirstChild.Value))
                            {
                                var value = &quot;&quot;;
                                if (n.FirstChild != null)
                                    value = n.FirstChild.Value;

                                ConfigOptions.Add(
                                    n.Attributes[&quot;key&quot;].FirstChild.Value.ToLower(),
                                    value);
                            }
                        }

                        if (xd.DocumentElement.SelectSingleNode(&quot;./invalidElements&quot;) != null)
                            _invalidElements = xd.DocumentElement.SelectSingleNode(&quot;./invalidElements&quot;).FirstChild.Value;
                        if (xd.DocumentElement.SelectSingleNode(&quot;./validElements&quot;) != null)
                        {
                            string _val = xd.DocumentElement.SelectSingleNode(&quot;./validElements&quot;).FirstChild.Value.Replace(&quot;\r&quot;, &quot;&quot;).Replace(&quot;\n&quot;, &quot;&quot;);
                            _validElements = _val;

                            /*foreach (string s in _val.Split(&quot;\n&quot;.ToCharArray()))
                                _validElements += &quot;&#39;&quot; + s + &quot;&#39; + \n&quot;;
                            _validElements = _validElements.Substring(0, _validElements.Length - 4);*/
                        }

                        _init = true;
                    }
                }
            }
            
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,52,0],[22,9,22,62,0],[23,9,23,133,0],[24,9,24,131,0],[25,9,25,109,0],[27,9,27,53,0],[28,9,28,51,0],[32,9,32,10,0],[33,13,33,26,0],[35,13,35,84,0],[36,13,36,45,0],[37,13,37,47,0],[38,13,38,51,0],[39,13,39,55,0],[40,13,40,49,0],[42,13,42,27,0],[43,9,43,10,0],[46,9,46,10,0],[48,13,48,32,0],[49,13,49,14,0],[50,17,50,30,0],[51,17,51,18,0],[52,21,52,40,0],[53,21,53,22,0],[55,25,55,60,0],[56,25,56,78,0],[58,25,58,32,0],[58,34,58,43,0],[58,44,58,46,0],[58,47,58,90,0],[59,25,59,26,0],[60,29,60,105,0],[62,29,62,50,0],[63,29,63,78,0],[64,33,64,98,0],[66,29,66,62,0],[67,33,81,38,0],[82,25,82,26,0],[85,25,85,32,0],[85,34,85,43,0],[85,44,85,46,0],[85,47,85,89,0],[86,25,86,26,0],[87,29,87,74,0],[88,29,88,30,0],[89,33,89,60,0],[90,33,90,89,0],[91,37,91,115,0],[93,33,99,40,0],[100,29,100,30,0],[101,25,101,26,0],[104,25,104,32,0],[104,34,104,43,0],[104,44,104,46,0],[104,47,104,89,0],[105,25,105,26,0],[106,29,106,98,0],[107,29,107,30,0],[108,33,108,48,0],[109,33,109,58,0],[110,37,110,64,0],[112,33,114,44,0],[115,29,115,30,0],[116,25,116,26,0],[118,25,118,94,0],[119,29,119,122,0],[120,25,120,92,0],[121,25,121,26,0],[122,29,122,151,0],[123,29,123,51,0],[128,25,128,26,0],[130,25,130,38,0],[131,21,131,22,0],[132,17,132,18,0],[133,13,133,14,0],[135,9,135,10,0]]);
    </script>
  </body>
</html>