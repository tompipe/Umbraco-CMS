<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\PetaPocoCachesTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Services;
using Umbraco.Tests.Services;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Persistence
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, NUnit.Framework.Ignore]
    public class PetaPocoCachesTest : BaseServiceTest
    {

#if DEBUG
        /// &lt;summary&gt;
        /// This tests the peta poco caches
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// This test WILL fail. This is because we cannot stop PetaPoco from creating more cached items for queries such as
        ///  ContentTypeRepository.GetAll(1,2,3,4);
        /// when combined with other GetAll queries that pass in an array of Ids, each query generated for different length
        /// arrays will produce a unique query which then gets added to the cache.
        /// 
        /// This test confirms this, if you analyze the DIFFERENCE output below you can see why the cached queries grow.
        /// &lt;/remarks&gt;
        [Test]
        public void Check_Peta_Poco_Caches()
        {
            var result = new List&lt;Tuple&lt;double, int, IEnumerable&lt;string&gt;&gt;&gt;();

            Database.PocoData.UseLongKeys = true;

            for (int i = 0; i &lt; 2; i++)
            {
                int id1, id2, id3;
                string alias;
                CreateStuff(out id1, out id2, out id3, out alias);
                QueryStuff(id1, id2, id3, alias);

                double totalBytes1;
                IEnumerable&lt;string&gt; keys;
                Debug.Print(Database.PocoData.PrintDebugCacheReport(out totalBytes1, out keys));

                result.Add(new Tuple&lt;double, int, IEnumerable&lt;string&gt;&gt;(totalBytes1, keys.Count(), keys));
            }

            for (int index = 0; index &lt; result.Count; index++)
            {
                var tuple = result[index];
                Debug.Print(&quot;Bytes: {0}, Delegates: {1}&quot;, tuple.Item1, tuple.Item2);
                if (index != 0)
                {
                    Debug.Print(&quot;----------------DIFFERENCE---------------------&quot;);
                    var diff = tuple.Item3.Except(result[index - 1].Item3);
                    foreach (var d in diff)
                    {
                        Debug.Print(d);
                    }
                }
                
            }

            var allByteResults = result.Select(x =&gt; x.Item1).Distinct();
            var totalKeys = result.Select(x =&gt; x.Item2).Distinct();

            Assert.AreEqual(1, allByteResults.Count());
            Assert.AreEqual(1, totalKeys.Count());
        }

        [Test]
        public void Verify_Memory_Expires()
        {
            Database.PocoData.SlidingExpirationSeconds = 2;

            var managedCache = new Database.ManagedCache();

            int id1, id2, id3;
            string alias;
            CreateStuff(out id1, out id2, out id3, out alias);
            QueryStuff(id1, id2, id3, alias);

            var count1 = managedCache.GetCache().GetCount();
            Debug.Print(&quot;Keys = &quot; + count1);
            Assert.Greater(count1, 0);
            
            Thread.Sleep(10000);

            var count2 = managedCache.GetCache().GetCount();
            Debug.Print(&quot;Keys = &quot; + count2);
            Assert.Less(count2, count1);
        }

        private void QueryStuff(int id1, int id2, int id3, string alias1)
        {
            var contentService = ServiceContext.ContentService;

            ServiceContext.TagService.GetTagsForEntity(id1);

            ServiceContext.TagService.GetAllContentTags();

            ServiceContext.TagService.GetTagsForEntity(id2);

            ServiceContext.TagService.GetTagsForEntity(id3);

            contentService.CountDescendants(id3);

            contentService.CountChildren(id3);

            contentService.Count(contentTypeAlias: alias1);

            contentService.Count();

            contentService.GetById(Guid.NewGuid());

            contentService.GetByLevel(2);

            contentService.GetChildren(id1);

            contentService.GetDescendants(id2);

            contentService.GetVersions(id3);

            contentService.GetRootContent();

            contentService.GetContentForExpiration();

            contentService.GetContentForRelease();

            contentService.GetContentInRecycleBin();

            ((ContentService)contentService).GetPublishedDescendants(new Content(&quot;Test&quot;, -1, new ContentType(-1))
            {
                Id = id1,
                Path = &quot;-1,&quot; + id1
            });

            contentService.GetByVersion(Guid.NewGuid());
        }

        private void CreateStuff(out int id1, out int id2, out int id3, out string alias)
        {
            var contentService = ServiceContext.ContentService;

            var ctAlias = &quot;umbTextpage&quot; + Guid.NewGuid().ToString(&quot;N&quot;);
            alias = ctAlias;

            for (int i = 0; i &lt; 20; i++)
            {
                contentService.CreateContentWithIdentity(&quot;Test&quot;, -1, &quot;umbTextpage&quot;, 0);
            }
            var contentTypeService = ServiceContext.ContentTypeService;
            var contentType = MockedContentTypes.CreateSimpleContentType(ctAlias, &quot;test Doc Type&quot;);
            contentTypeService.Save(contentType);
            for (int i = 0; i &lt; 20; i++)
            {
                contentService.CreateContentWithIdentity(&quot;Test&quot;, -1, ctAlias, 0);
            }
            var parent = contentService.CreateContentWithIdentity(&quot;Test&quot;, -1, ctAlias, 0);
            id1 = parent.Id;

            for (int i = 0; i &lt; 20; i++)
            {
                contentService.CreateContentWithIdentity(&quot;Test&quot;, parent, ctAlias);
            }
            IContent current = parent;
            for (int i = 0; i &lt; 20; i++)
            {
                current = contentService.CreateContentWithIdentity(&quot;Test&quot;, current, ctAlias);
            }
            contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbMandatory&quot; + Guid.NewGuid().ToString(&quot;N&quot;), &quot;Mandatory Doc Type&quot;, true);
            contentType.PropertyGroups.First().PropertyTypes.Add(
                new PropertyType(&quot;test&quot;, DataTypeDatabaseType.Ntext, &quot;tags&quot;)
                {
                    DataTypeDefinitionId = 1041
                });
            contentTypeService.Save(contentType);
            var content1 = MockedContent.CreateSimpleContent(contentType, &quot;Tagged content 1&quot;, -1);
            content1.SetTags(&quot;tags&quot;, new[] { &quot;hello&quot;, &quot;world&quot;, &quot;some&quot;, &quot;tags&quot; }, true);
            contentService.Publish(content1);
            id2 = content1.Id;

            var content2 = MockedContent.CreateSimpleContent(contentType, &quot;Tagged content 2&quot;, -1);
            content2.SetTags(&quot;tags&quot;, new[] { &quot;hello&quot;, &quot;world&quot;, &quot;some&quot;, &quot;tags&quot; }, true);
            contentService.Publish(content2);
            id3 = content2.Id;

            contentService.MoveToRecycleBin(content1);
        }
#endif
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[35,9,35,10,0],[36,13,36,78,0],[38,13,38,50,0],[40,18,40,27,0],[40,29,40,34,0],[40,36,40,39,0],[41,13,41,14,0],[44,17,44,67,0],[45,17,45,50,0],[49,17,49,97,0],[51,17,51,106,0],[52,13,52,14,0],[54,18,54,31,0],[54,33,54,53,0],[54,55,54,62,0],[55,13,55,14,0],[56,17,56,43,0],[57,17,57,85,0],[58,17,58,32,0],[59,17,59,18,0],[60,21,60,84,0],[61,21,61,76,0],[62,21,62,28,0],[62,30,62,35,0],[62,36,62,38,0],[62,39,62,43,0],[63,21,63,22,0],[64,25,64,40,0],[65,21,65,22,0],[66,17,66,18,0],[68,13,68,14,0],[70,13,70,53,0],[70,53,70,60,0],[70,60,70,73,0],[70,13,70,73,0],[71,13,71,48,0],[71,48,71,55,0],[71,55,71,68,0],[71,13,71,68,0],[73,13,73,56,0],[74,13,74,51,0],[75,9,75,10,0],[79,9,79,10,0],[80,13,80,60,0],[82,13,82,60,0],[86,13,86,63,0],[87,13,87,46,0],[89,13,89,61,0],[90,13,90,45,0],[91,13,91,39,0],[93,13,93,33,0],[95,13,95,61,0],[96,13,96,45,0],[97,13,97,41,0],[98,9,98,10,0],[101,9,101,10,0],[102,13,102,64,0],[104,13,104,61,0],[106,13,106,59,0],[108,13,108,61,0],[110,13,110,61,0],[112,13,112,50,0],[114,13,114,47,0],[116,13,116,60,0],[118,13,118,36,0],[120,13,120,52,0],[122,13,122,42,0],[124,13,124,45,0],[126,13,126,48,0],[128,13,128,45,0],[130,13,130,45,0],[132,13,132,54,0],[134,13,134,51,0],[136,13,136,53,0],[138,13,142,16,0],[144,13,144,57,0],[145,9,145,10,0],[148,9,148,10,0],[149,13,149,64,0],[151,13,151,72,0],[152,13,152,29,0],[154,18,154,27,0],[154,29,154,35,0],[154,37,154,40,0],[155,13,155,14,0],[156,17,156,88,0],[157,13,157,14,0],[158,13,158,72,0],[159,13,159,100,0],[160,13,160,50,0],[161,18,161,27,0],[161,29,161,35,0],[161,37,161,40,0],[162,13,162,14,0],[163,17,163,82,0],[164,13,164,14,0],[165,13,165,91,0],[166,13,166,29,0],[168,18,168,27,0],[168,29,168,35,0],[168,37,168,40,0],[169,13,169,14,0],[170,17,170,83,0],[171,13,171,14,0],[172,13,172,39,0],[173,18,173,27,0],[173,29,173,35,0],[173,37,173,40,0],[174,13,174,14,0],[175,17,175,94,0],[176,13,176,14,0],[177,13,177,145,0],[178,13,182,20,0],[183,13,183,50,0],[184,13,184,99,0],[185,13,185,88,0],[186,13,186,46,0],[187,13,187,31,0],[189,13,189,99,0],[190,13,190,88,0],[191,13,191,46,0],[192,13,192,31,0],[194,13,194,55,0],[195,9,195,10,0]]);
    </script>
  </body>
</html>