<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Scheduling\Scheduler.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Threading;
using System.Web;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Web.Routing;

namespace Umbraco.Web.Scheduling
{
    /// &lt;summary&gt;
    /// Used to do the scheduling for tasks, publishing, etc...
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// All tasks are run in a background task runner which is web aware and will wind down the task correctly instead of killing it completely when
    /// the app domain shuts down.
    /// &lt;/remarks&gt;
    internal sealed class Scheduler : ApplicationEventHandler
    {
        private BackgroundTaskRunner&lt;IBackgroundTask&gt; _keepAliveRunner;
        private BackgroundTaskRunner&lt;IBackgroundTask&gt; _publishingRunner;
        private BackgroundTaskRunner&lt;IBackgroundTask&gt; _tasksRunner;
        private BackgroundTaskRunner&lt;IBackgroundTask&gt; _scrubberRunner;
        private bool _started = false;
        private object _locker = new object();
        private IBackgroundTask[] _tasks;

        protected override void ApplicationStarted(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            if (umbracoApplication.Context == null)
                return;

            // backgrounds runners are web aware, if the app domain dies, these tasks will wind down correctly
            _keepAliveRunner = new BackgroundTaskRunner&lt;IBackgroundTask&gt;(&quot;KeepAlive&quot;, applicationContext.ProfilingLogger.Logger);
            _publishingRunner = new BackgroundTaskRunner&lt;IBackgroundTask&gt;(&quot;ScheduledPublishing&quot;, applicationContext.ProfilingLogger.Logger);
            _tasksRunner = new BackgroundTaskRunner&lt;IBackgroundTask&gt;(&quot;ScheduledTasks&quot;, applicationContext.ProfilingLogger.Logger);
            _scrubberRunner = new BackgroundTaskRunner&lt;IBackgroundTask&gt;(&quot;LogScrubber&quot;, applicationContext.ProfilingLogger.Logger);

            //We will start the whole process when a successful request is made
            UmbracoModule.RouteAttempt += UmbracoModuleRouteAttempt;
        }

        private void UmbracoModuleRouteAttempt(object sender, RoutableAttemptEventArgs e)
        {
            switch (e.Outcome)
            {
                case EnsureRoutableOutcome.IsRoutable:
                case EnsureRoutableOutcome.NotDocumentRequest:
                    RegisterBackgroundTasks(e);
                    break;
            }
        }

        private void RegisterBackgroundTasks(UmbracoRequestEventArgs e)
        {
            //remove handler, we&#39;re done
            UmbracoModule.RouteAttempt -= UmbracoModuleRouteAttempt;

            LazyInitializer.EnsureInitialized(ref _tasks, ref _started, ref _locker, () =&gt;
            {
                LogHelper.Debug&lt;Scheduler&gt;(() =&gt; &quot;Initializing the scheduler&quot;);
                var settings = UmbracoConfig.For.UmbracoSettings();

                var tasks = new List&lt;IBackgroundTask&gt;
                {
                    new KeepAlive(_keepAliveRunner, 60000, 300000, e.UmbracoContext.Application),
                    new ScheduledPublishing(_publishingRunner, 60000, 60000, e.UmbracoContext.Application, settings),
                    new ScheduledTasks(_tasksRunner, 60000, 60000, e.UmbracoContext.Application, settings),
                    new LogScrubber(_scrubberRunner, 60000, LogScrubber.GetLogScrubbingInterval(settings), e.UmbracoContext.Application, settings)
                };

                // ping/keepalive
                // on all servers
                _keepAliveRunner.TryAdd(tasks[0]);

                // scheduled publishing/unpublishing
                // install on all, will only run on non-slaves servers
                _publishingRunner.TryAdd(tasks[1]);

                _tasksRunner.TryAdd(tasks[2]);

                // log scrubbing
                // install on all, will only run on non-slaves servers
                _scrubberRunner.TryAdd(tasks[3]);

                return tasks.ToArray();
            });
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,39,0],[25,9,25,47,0],[29,9,29,10,0],[30,13,30,52,0],[31,17,31,24,0],[34,13,34,130,0],[35,13,35,141,0],[36,13,36,131,0],[37,13,37,131,0],[40,13,40,69,0],[41,9,41,10,0],[44,9,44,10,0],[45,13,45,31,0],[49,21,49,48,0],[50,21,50,27,0],[52,9,52,10,0],[55,9,55,10,0],[57,13,57,69,0],[59,13,60,13,0],[60,13,60,14,0],[60,14,61,17,0],[61,17,61,50,0],[61,50,61,78,0],[61,78,61,80,0],[61,17,61,80,0],[61,80,62,17,0],[62,17,62,68,0],[62,68,64,17,0],[64,17,70,19,0],[70,19,74,17,0],[74,17,74,51,0],[74,51,78,17,0],[78,17,78,52,0],[78,52,80,17,0],[80,17,80,47,0],[80,47,84,17,0],[84,17,84,50,0],[84,50,86,17,0],[86,17,86,40,0],[86,40,87,13,0],[87,13,87,14,0],[87,14,87,16,0],[59,13,87,16,0],[88,9,88,10,0]]);
    </script>
  </body>
</html>