<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\PetaPocoCommandExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Data.SqlClient;
using Umbraco.Core.Persistence.FaultHandling;

namespace Umbraco.Core.Persistence
{
    /// &lt;summary&gt;
    /// Provides a set of extension methods adding retry capabilities into the standard &lt;see cref=&quot;System.Data.IDbConnection&quot;/&gt; implementation, which is used in PetaPoco.
    /// &lt;/summary&gt;
    public static class PetaPocoCommandExtensions
    {
        #region ExecuteNonQueryWithRetry method implementations
        /// &lt;summary&gt;
        /// Executes a Transact-SQL statement against the connection and returns the number of rows affected. Uses the default retry policy when executing the command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;returns&gt;The number of rows affected.&lt;/returns&gt;
        public static int ExecuteNonQueryWithRetry(this IDbCommand command)
        {
            var connectionString = command.Connection.ConnectionString ?? string.Empty;
            return ExecuteNonQueryWithRetry(command, RetryPolicyFactory.GetDefaultSqlCommandRetryPolicyByConnectionString(connectionString));
        }

        /// &lt;summary&gt;
        /// Executes a Transact-SQL statement against the connection and returns the number of rows affected. Uses the specified retry policy when executing the command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;retryPolicy&quot;&gt;The retry policy defining whether to retry a command if a connection fails while executing the command.&lt;/param&gt;
        /// &lt;returns&gt;The number of rows affected.&lt;/returns&gt;
        public static int ExecuteNonQueryWithRetry(this IDbCommand command, RetryPolicy retryPolicy)
        {
            var connectionString = command.Connection.ConnectionString ?? string.Empty;
            return ExecuteNonQueryWithRetry(command, retryPolicy, RetryPolicyFactory.GetDefaultSqlConnectionRetryPolicyByConnectionString(connectionString));
        }

        /// &lt;summary&gt;
        /// Executes a Transact-SQL statement against the connection and returns the number of rows affected. Uses the specified retry policy when executing the command.
        /// Uses a separate specified retry policy when establishing a connection.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;cmdRetryPolicy&quot;&gt;The command retry policy defining whether to retry a command if it fails while executing.&lt;/param&gt;
        /// &lt;param name=&quot;conRetryPolicy&quot;&gt;The connection retry policy defining whether to re-establish a connection if it drops while executing the command.&lt;/param&gt;
        /// &lt;returns&gt;The number of rows affected.&lt;/returns&gt;
        public static int ExecuteNonQueryWithRetry(this IDbCommand command, RetryPolicy cmdRetryPolicy, RetryPolicy conRetryPolicy)
        {
            //GuardConnectionIsNotNull(command);

            // Check if retry policy was specified, if not, use the default retry policy.
            return (cmdRetryPolicy ?? RetryPolicy.NoRetry).ExecuteAction(() =&gt;
            {
                var hasOpenConnection = EnsureValidConnection(command, conRetryPolicy);

                try
                {
                    return command.ExecuteNonQuery();
                }
                finally
                {
                    if (hasOpenConnection &amp;&amp; command.Connection != null &amp;&amp; command.Connection.State == ConnectionState.Open)
                    {
                        //Connection is closed in PetaPoco, so no need to do it here (?)
                        //command.Connection.Close();
                    }
                }
            });
        }
        #endregion

        #region ExecuteReaderWithRetry method implementations
        /// &lt;summary&gt;
        /// Sends the specified command to the connection and builds a SqlDataReader object containing the results.
        /// Uses the default retry policy when executing the command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;returns&gt;A System.Data.IDataReader object.&lt;/returns&gt;
        public static IDataReader ExecuteReaderWithRetry(this IDbCommand command)
        {
            var connectionString = command.Connection.ConnectionString ?? string.Empty;
            return ExecuteReaderWithRetry(command, RetryPolicyFactory.GetDefaultSqlCommandRetryPolicyByConnectionString(connectionString));
        }

        /// &lt;summary&gt;
        /// Sends the specified command to the connection and builds a SqlDataReader object containing the results.
        /// Uses the specified retry policy when executing the command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;retryPolicy&quot;&gt;The retry policy defining whether to retry a command if a connection fails while executing the command.&lt;/param&gt;
        /// &lt;returns&gt;A System.Data.IDataReader object.&lt;/returns&gt;
        public static IDataReader ExecuteReaderWithRetry(this IDbCommand command, RetryPolicy retryPolicy)
        {
            var connectionString = command.Connection.ConnectionString ?? string.Empty;
            return ExecuteReaderWithRetry(command, retryPolicy, RetryPolicyFactory.GetDefaultSqlConnectionRetryPolicyByConnectionString(connectionString));
        }

        /// &lt;summary&gt;
        /// Sends the specified command to the connection and builds a SqlDataReader object containing the results.
        /// Uses the specified retry policy when executing the command. Uses a separate specified retry policy when
        /// establishing a connection.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;cmdRetryPolicy&quot;&gt;The command retry policy defining whether to retry a command if it fails while executing.&lt;/param&gt;
        /// &lt;param name=&quot;conRetryPolicy&quot;&gt;The connection retry policy defining whether to re-establish a connection if it drops while executing the command.&lt;/param&gt;
        /// &lt;returns&gt;A System.Data.IDataReader object.&lt;/returns&gt;
        public static IDataReader ExecuteReaderWithRetry(this IDbCommand command, RetryPolicy cmdRetryPolicy, RetryPolicy conRetryPolicy)
        {
            //GuardConnectionIsNotNull(command);

            // Check if retry policy was specified, if not, use the default retry policy.
            return (cmdRetryPolicy ?? RetryPolicy.NoRetry).ExecuteAction(() =&gt;
            {
                var hasOpenConnection = EnsureValidConnection(command, conRetryPolicy);

                try
                {
                    return command.ExecuteReader();
                }
                catch (Exception)
                {
                    if (hasOpenConnection &amp;&amp; command.Connection != null &amp;&amp; command.Connection.State == ConnectionState.Open)
                    {
                        //command.Connection.Close();
                    }

                    throw;
                }
            });
        }

        /// &lt;summary&gt;
        /// Sends the specified command to the connection and builds a SqlDataReader object using one of the 
        /// CommandBehavior values. Uses the default retry policy when executing the command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;behavior&quot;&gt;One of the System.Data.CommandBehavior values.&lt;/param&gt;
        /// &lt;returns&gt;A System.Data.IDataReader object.&lt;/returns&gt;
        public static IDataReader ExecuteReaderWithRetry(this IDbCommand command, CommandBehavior behavior)
        {
            var connectionString = command.Connection.ConnectionString ?? string.Empty;
            return ExecuteReaderWithRetry(command, behavior, RetryPolicyFactory.GetDefaultSqlCommandRetryPolicyByConnectionString(connectionString));
        }

        /// &lt;summary&gt;
        /// Sends the specified command to the connection and builds a SqlDataReader object using one of the
        /// CommandBehavior values. Uses the specified retry policy when executing the command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;behavior&quot;&gt;One of the System.Data.CommandBehavior values.&lt;/param&gt;
        /// &lt;param name=&quot;retryPolicy&quot;&gt;The retry policy defining whether to retry a command if a connection fails while executing the command.&lt;/param&gt;
        /// &lt;returns&gt;A System.Data.SqlClient.SqlDataReader object.&lt;/returns&gt;
        public static IDataReader ExecuteReaderWithRetry(this IDbCommand command, CommandBehavior behavior, RetryPolicy retryPolicy)
        {
            var connectionString = command.Connection.ConnectionString ?? string.Empty;
            return ExecuteReaderWithRetry(command, behavior, retryPolicy, RetryPolicyFactory.GetDefaultSqlConnectionRetryPolicyByConnectionString(connectionString));
        }

        /// &lt;summary&gt;
        /// Sends the specified command to the connection and builds a SqlDataReader object using one of the
        /// CommandBehavior values. Uses the specified retry policy when executing the command.
        /// Uses a separate specified retry policy when establishing a connection.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;behavior&quot;&gt;One of the System.Data.CommandBehavior values.&lt;/param&gt;
        /// &lt;param name=&quot;cmdRetryPolicy&quot;&gt;The command retry policy defining whether to retry a command if it fails while executing.&lt;/param&gt;
        /// &lt;param name=&quot;conRetryPolicy&quot;&gt;The connection retry policy defining whether to re-establish a connection if it drops while executing the command.&lt;/param&gt;
        /// &lt;returns&gt;A System.Data.IDataReader object.&lt;/returns&gt;
        public static IDataReader ExecuteReaderWithRetry(this IDbCommand command, CommandBehavior behavior, RetryPolicy cmdRetryPolicy, RetryPolicy conRetryPolicy)
        {
            //GuardConnectionIsNotNull(command);

            // Check if retry policy was specified, if not, use the default retry policy.
            return (cmdRetryPolicy ?? RetryPolicy.NoRetry).ExecuteAction(() =&gt;
            {
                var hasOpenConnection = EnsureValidConnection(command, conRetryPolicy);

                try
                {
                    return command.ExecuteReader(behavior);
                }
                catch (Exception)
                {
                    if (hasOpenConnection &amp;&amp; command.Connection != null &amp;&amp; command.Connection.State == ConnectionState.Open)
                    {
                        //command.Connection.Close();
                    }

                    throw;
                }
            });
        }
        #endregion

        #region ExecuteScalarWithRetry method implementations
        /// &lt;summary&gt;
        /// Executes the query, and returns the first column of the first row in the result set returned by the query. Additional columns or rows are ignored.
        /// Uses the default retry policy when executing the command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;returns&gt; The first column of the first row in the result set, or a null reference if the result set is empty. Returns a maximum of 2033 characters.&lt;/returns&gt;
        public static object ExecuteScalarWithRetry(this IDbCommand command)
        {
            var connectionString = command.Connection.ConnectionString ?? string.Empty;
            return ExecuteScalarWithRetry(command, RetryPolicyFactory.GetDefaultSqlCommandRetryPolicyByConnectionString(connectionString));
        }

        /// &lt;summary&gt;
        /// Executes the query, and returns the first column of the first row in the result set returned by the query. Additional columns or rows are ignored.
        /// Uses the specified retry policy when executing the command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;retryPolicy&quot;&gt;The retry policy defining whether to retry a command if a connection fails while executing the command.&lt;/param&gt;
        /// &lt;returns&gt; The first column of the first row in the result set, or a null reference if the result set is empty. Returns a maximum of 2033 characters.&lt;/returns&gt;
        public static object ExecuteScalarWithRetry(this IDbCommand command, RetryPolicy retryPolicy)
        {
            var connectionString = command.Connection.ConnectionString ?? string.Empty;
            return ExecuteScalarWithRetry(command, retryPolicy, RetryPolicyFactory.GetDefaultSqlConnectionRetryPolicyByConnectionString(connectionString));
        }
        /// &lt;summary&gt;
        /// Executes the query, and returns the first column of the first row in the result set returned by the query. Additional columns or rows are ignored.
        /// Uses the specified retry policy when executing the command. Uses a separate specified retry policy when establishing a connection.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command object that is required as per extension method declaration.&lt;/param&gt;
        /// &lt;param name=&quot;cmdRetryPolicy&quot;&gt;The command retry policy defining whether to retry a command if it fails while executing.&lt;/param&gt;
        /// &lt;param name=&quot;conRetryPolicy&quot;&gt;The connection retry policy defining whether to re-establish a connection if it drops while executing the command.&lt;/param&gt;
        /// &lt;returns&gt; The first column of the first row in the result set, or a null reference if the result set is empty. Returns a maximum of 2033 characters.&lt;/returns&gt;
        public static object ExecuteScalarWithRetry(this IDbCommand command, RetryPolicy cmdRetryPolicy, RetryPolicy conRetryPolicy)
        {
            //GuardConnectionIsNotNull(command);

            // Check if retry policy was specified, if not, use the default retry policy.
            return (cmdRetryPolicy ?? RetryPolicy.NoRetry).ExecuteAction(() =&gt;
            {
                var hasOpenConnection = EnsureValidConnection(command, conRetryPolicy);

                try
                {
                    return command.ExecuteScalar();
                }
                finally
                {
                    if (hasOpenConnection &amp;&amp; command.Connection != null &amp;&amp; command.Connection.State == ConnectionState.Open)
                    {
                        //Connection is closed in PetaPoco, so no need to do it here (?)
                        //command.Connection.Close();
                    }
                }
            });
        }
        #endregion

        /// &lt;summary&gt;
        /// Ensure a valid connection in case a connection hasn&#39;t been opened by PetaPoco (which shouldn&#39;t be possible by the way).
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;retryPolicy&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static bool EnsureValidConnection(IDbCommand command, RetryPolicy retryPolicy)
        {
            if (command != null)
            {
                //GuardConnectionIsNotNull(command);

                // Verify whether or not the connection is valid and is open. This code may be retried therefore
                // it is important to ensure that a connection is re-established should it have previously failed.
                if (command.Connection.State != ConnectionState.Open)
                {
                    // Attempt to open the connection using the retry policy that matches the policy for SQL commands.
                    command.Connection.OpenWithRetry(retryPolicy);

                    return true;
                }
            }

            return false;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,88,1],[22,13,22,142,1],[23,9,23,10,1],[32,9,32,10,1],[33,13,33,88,1],[34,13,34,158,1],[35,9,35,10,1],[46,9,46,10,1],[50,13,51,13,1],[51,13,51,14,1],[51,14,52,17,1],[52,17,52,88,1],[52,88,55,17,1],[55,17,55,18,1],[55,18,56,21,1],[56,21,56,54,1],[56,54,59,17,1],[59,17,59,18,1],[59,18,60,21,1],[60,21,60,125,1],[60,125,61,21,1],[61,21,61,22,0],[61,22,64,21,1],[64,21,64,22,0],[64,22,65,17,1],[65,17,65,18,1],[65,18,66,13,1],[66,13,66,14,1],[66,14,66,16,1],[50,13,66,16,1],[67,9,67,10,1],[78,9,78,10,1],[79,13,79,88,1],[80,13,80,140,1],[81,9,81,10,1],[91,9,91,10,1],[92,13,92,88,1],[93,13,93,156,1],[94,9,94,10,1],[106,9,106,10,1],[110,13,111,13,1],[111,13,111,14,1],[111,14,112,17,1],[112,17,112,88,1],[112,88,115,17,1],[115,17,115,18,1],[115,18,116,21,1],[116,21,116,52,1],[116,52,118,17,1],[118,17,118,34,0],[118,34,119,17,1],[119,17,119,18,0],[119,18,120,21,1],[120,21,120,125,0],[120,125,121,21,1],[121,21,121,22,0],[121,22,123,21,1],[123,21,123,22,0],[123,22,125,21,1],[125,21,125,27,0],[125,27,127,13,1],[127,13,127,14,1],[127,14,127,16,1],[110,13,127,16,1],[128,9,128,10,1],[138,9,138,10,0],[139,13,139,88,0],[140,13,140,150,0],[141,9,141,10,0],[152,9,152,10,0],[153,13,153,88,0],[154,13,154,166,0],[155,9,155,10,0],[168,9,168,10,0],[172,13,173,13,0],[173,13,173,14,0],[173,14,174,17,0],[174,17,174,88,0],[174,88,177,17,0],[177,17,177,18,0],[177,18,178,21,0],[178,21,178,60,0],[178,60,180,17,0],[180,17,180,34,0],[180,34,181,17,0],[181,17,181,18,0],[181,18,182,21,0],[182,21,182,125,0],[182,125,183,21,0],[183,21,183,22,0],[183,22,185,21,0],[185,21,185,22,0],[185,22,187,21,0],[187,21,187,27,0],[187,27,189,13,0],[189,13,189,14,0],[189,14,189,16,0],[172,13,189,16,0],[190,9,190,10,0],[201,9,201,10,1],[202,13,202,88,1],[203,13,203,140,1],[204,9,204,10,1],[214,9,214,10,1],[215,13,215,88,1],[216,13,216,156,1],[217,9,217,10,1],[227,9,227,10,1],[231,13,232,13,1],[232,13,232,14,1],[232,14,233,17,1],[233,17,233,88,1],[233,88,236,17,1],[236,17,236,18,1],[236,18,237,21,1],[237,21,237,52,1],[237,52,240,17,1],[240,17,240,18,1],[240,18,241,21,1],[241,21,241,125,1],[241,125,242,21,1],[242,21,242,22,0],[242,22,245,21,1],[245,21,245,22,0],[245,22,246,17,1],[246,17,246,18,1],[246,18,247,13,1],[247,13,247,14,1],[247,14,247,16,1],[231,13,247,16,1],[248,9,248,10,1],[258,9,258,10,1],[259,13,259,33,1],[260,13,260,14,1],[265,17,265,70,1],[266,17,266,18,0],[268,21,268,67,0],[270,21,270,33,0],[272,13,272,14,1],[274,13,274,26,1],[275,9,275,10,1]]);
    </script>
  </body>
</html>