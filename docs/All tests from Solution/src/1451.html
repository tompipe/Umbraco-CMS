<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Sync\RefreshInstruction.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using Newtonsoft.Json;
using umbraco.interfaces;

namespace Umbraco.Core.Sync
{
    [Serializable]
    public class RefreshInstruction
    {
        // NOTE
        // that class should be refactored
        // but at the moment it is exposed in CacheRefresher webservice
        // so for the time being we keep it as-is for backward compatibility reasons

        // need this public, parameter-less constructor so the web service messenger
        // can de-serialize the instructions it receives
        public RefreshInstruction()
        { }

        // need this public one so it can be de-serialized - used by the Json thing
        // otherwise, should use GetInstructions(...)
        public RefreshInstruction(Guid refresherId, RefreshMethodType refreshType, Guid guidId, int intId, string jsonIds, string jsonPayload)
        {
            RefresherId = refresherId;
            RefreshType = refreshType;
            GuidId = guidId;
            IntId = intId;
            JsonIds = jsonIds;
            JsonPayload = jsonPayload;
        }

        private RefreshInstruction(ICacheRefresher refresher, RefreshMethodType refreshType)
        {
            RefresherId = refresher.UniqueIdentifier;
            RefreshType = refreshType;
        }

        private RefreshInstruction(ICacheRefresher refresher, RefreshMethodType refreshType, Guid guidId)
            : this(refresher, refreshType)
        {
            GuidId = guidId;
        }

        private RefreshInstruction(ICacheRefresher refresher, RefreshMethodType refreshType, int intId)
            : this(refresher, refreshType)
        {
            IntId = intId;
        }

        private RefreshInstruction(ICacheRefresher refresher, RefreshMethodType refreshType, string json)
            : this(refresher, refreshType)
        {
            if (refreshType == RefreshMethodType.RefreshByJson)
                JsonPayload = json;
            else
                JsonIds = json;
        }

        public static IEnumerable&lt;RefreshInstruction&gt; GetInstructions(
            ICacheRefresher refresher,
            MessageType messageType,
            IEnumerable&lt;object&gt; ids,
            Type idType,
            string json)
        {
            switch (messageType)
            {
                case MessageType.RefreshAll:
                    return new[] { new RefreshInstruction(refresher, RefreshMethodType.RefreshAll) };

                case MessageType.RefreshByJson:
                    return new[] { new RefreshInstruction(refresher, RefreshMethodType.RefreshByJson, json) };
                
                case MessageType.RefreshById:
                    if (idType == null)
                        throw new InvalidOperationException(&quot;Cannot refresh by id if idType is null.&quot;);
                    if (idType == typeof (int)) // bulk of ints is supported
                        return new[] { new RefreshInstruction(refresher, RefreshMethodType.RefreshByIds, JsonConvert.SerializeObject(ids.Cast&lt;int&gt;().ToArray())) };
                    // else must be guids, bulk of guids is not supported, iterate
                    return ids.Select(x =&gt; new RefreshInstruction(refresher, RefreshMethodType.RefreshByGuid, (Guid) x));

                case MessageType.RemoveById:
                    if (idType == null)
                        throw new InvalidOperationException(&quot;Cannot remove by id if idType is null.&quot;);
                    // must be ints, bulk-remove is not supported, iterate
                    return ids.Select(x =&gt; new RefreshInstruction(refresher, RefreshMethodType.RemoveById, (int) x));
                    //return new[] { new RefreshInstruction(refresher, RefreshMethodType.RemoveByIds, JsonConvert.SerializeObject(ids.Cast&lt;int&gt;().ToArray())) };
                
                default:
                    //case MessageType.RefreshByInstance:
                    //case MessageType.RemoveByInstance:
                    throw new ArgumentOutOfRangeException(&quot;messageType&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Gets or sets the refresh action type.
        /// &lt;/summary&gt;
        public RefreshMethodType RefreshType { get; set; }

        /// &lt;summary&gt;
        /// Gets or sets the refresher unique identifier.
        /// &lt;/summary&gt;
        public Guid RefresherId { get; set; }

        /// &lt;summary&gt;
        /// Gets or sets the Guid data value.
        /// &lt;/summary&gt;
        public Guid GuidId { get; set; }

        /// &lt;summary&gt;
        /// Gets or sets the int data value.
        /// &lt;/summary&gt;
        public int IntId { get; set; }

        /// &lt;summary&gt;
        /// Gets or sets the ids data value.
        /// &lt;/summary&gt;
        public string JsonIds { get; set; }

        /// &lt;summary&gt;
        /// Gets or sets the payload data value.
        /// &lt;/summary&gt;
        public string JsonPayload { get; set; }
        
        protected bool Equals(RefreshInstruction other)
        {
            return RefreshType == other.RefreshType 
                &amp;&amp; RefresherId.Equals(other.RefresherId) 
                &amp;&amp; GuidId.Equals(other.GuidId) 
                &amp;&amp; IntId == other.IntId 
                &amp;&amp; string.Equals(JsonIds, other.JsonIds) 
                &amp;&amp; string.Equals(JsonPayload, other.JsonPayload);
        }

        public override bool Equals(object other)
        {
            if (ReferenceEquals(null, other)) return false;
            if (ReferenceEquals(this, other)) return true;
            if (other.GetType() != this.GetType()) return false;
            return Equals((RefreshInstruction) other);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = (int) RefreshType;
                hashCode = (hashCode*397) ^ RefresherId.GetHashCode();
                hashCode = (hashCode*397) ^ GuidId.GetHashCode();
                hashCode = (hashCode*397) ^ IntId;
                hashCode = (hashCode*397) ^ (JsonIds != null ? JsonIds.GetHashCode() : 0);
                hashCode = (hashCode*397) ^ (JsonPayload != null ? JsonPayload.GetHashCode() : 0);
                return hashCode;
            }
        }

        public static bool operator ==(RefreshInstruction left, RefreshInstruction right)
        {
            return Equals(left, right);
        }

        public static bool operator !=(RefreshInstruction left, RefreshInstruction right)
        {
            return Equals(left, right) == false;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,36,0],[21,9,21,10,0],[21,11,21,12,0],[25,9,25,143,0],[26,9,26,10,0],[27,13,27,39,0],[28,13,28,39,0],[29,13,29,29,0],[30,13,30,27,0],[31,13,31,31,0],[32,13,32,39,0],[33,9,33,10,0],[35,9,35,93,0],[36,9,36,10,0],[37,13,37,54,0],[38,13,38,39,0],[39,9,39,10,0],[42,15,42,43,0],[43,9,43,10,0],[44,13,44,29,0],[45,9,45,10,0],[48,15,48,43,0],[49,9,49,10,0],[50,13,50,27,0],[51,9,51,10,0],[54,15,54,43,0],[55,9,55,10,0],[56,13,56,64,0],[57,17,57,36,0],[59,17,59,32,0],[60,9,60,10,0],[68,9,68,10,0],[69,13,69,33,0],[72,21,72,102,0],[75,21,75,111,0],[78,21,78,40,0],[79,25,79,104,0],[80,21,80,48,0],[81,25,81,164,0],[83,21,83,44,0],[83,44,83,120,0],[83,120,83,122,0],[83,21,83,122,0],[86,21,86,40,0],[87,25,87,103,0],[89,21,89,44,0],[89,44,89,116,0],[89,116,89,118,0],[89,21,89,118,0],[95,21,95,74,0],[97,9,97,10,0],[102,48,102,52,0],[102,53,102,57,0],[107,35,107,39,0],[107,40,107,44,0],[112,30,112,34,0],[112,35,112,39,0],[117,28,117,32,0],[117,33,117,37,0],[122,33,122,37,0],[122,38,122,42,0],[127,37,127,41,0],[127,42,127,46,0],[130,9,130,10,0],[131,13,136,66,0],[137,9,137,10,0],[140,9,140,10,0],[141,13,141,46,0],[141,47,141,60,0],[142,13,142,46,0],[142,47,142,59,0],[143,13,143,51,0],[143,52,143,65,0],[144,13,144,55,0],[145,9,145,10,0],[148,9,148,10,0],[150,13,150,14,0],[151,17,151,50,0],[152,17,152,71,0],[153,17,153,66,0],[154,17,154,51,0],[155,17,155,91,0],[156,17,156,99,0],[157,17,157,33,0],[159,9,159,10,0],[162,9,162,10,0],[163,13,163,40,0],[164,9,164,10,0],[167,9,167,10,0],[168,13,168,49,0],[169,9,169,10,0]]);
    </script>
  </body>
</html>