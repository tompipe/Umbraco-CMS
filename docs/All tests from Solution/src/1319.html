<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\ContentPostValidateAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Net;
using System.Net.Http;
using System.Web.Http.Controllers;
using System.Web.Http.Filters;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Security;
using Umbraco.Web.WebApi;
using umbraco.BusinessLogic.Actions;

namespace Umbraco.Web.Editors
{
    /// &lt;summary&gt;
    /// Checks if the user has access to post a content item based on whether it&#39;s being created or saved.
    /// &lt;/summary&gt;
    internal sealed class ContentPostValidateAttribute : ActionFilterAttribute
    {
        private readonly IContentService _contentService;
        private readonly WebSecurity _security;
        private readonly IUserService _userService;

        public ContentPostValidateAttribute()
        {            
        }

        public ContentPostValidateAttribute(IContentService contentService, IUserService userService, WebSecurity security)
        {
            if (contentService == null) throw new ArgumentNullException(&quot;contentService&quot;);
            if (userService == null) throw new ArgumentNullException(&quot;userService&quot;);
            if (security == null) throw new ArgumentNullException(&quot;security&quot;);
            _contentService = contentService;
            _userService = userService;
            _security = security;
        }

        private IContentService ContentService
        {
            get { return _contentService ?? ApplicationContext.Current.Services.ContentService; }
        }

        private WebSecurity Security
        {
            get { return _security ?? UmbracoContext.Current.Security; }
        }

        private IUserService UserService
        {
            get { return _userService ?? ApplicationContext.Current.Services.UserService; }
        }

        public override bool AllowMultiple
        {
            get { return true; }
        }

        public override void OnActionExecuting(HttpActionContext actionContext)
        {
            var contentItem = (ContentItemSave)actionContext.ActionArguments[&quot;contentItem&quot;];

            //We now need to validate that the user is allowed to be doing what they are doing.
            //Based on the action we need to check different permissions.
            //Then if it is new, we need to lookup those permissions on the parent!

            var permissionToCheck = new List&lt;char&gt;();
            IContent contentToCheck = null;
            int contentIdToCheck;
            switch (contentItem.Action)
            {
                case ContentSaveAction.Save:
                    permissionToCheck.Add(ActionUpdate.Instance.Letter);
                    contentToCheck = contentItem.PersistedContent;
                    contentIdToCheck = contentToCheck.Id;
                    break;
                case ContentSaveAction.Publish:
                    permissionToCheck.Add(ActionPublish.Instance.Letter);
                    contentToCheck = contentItem.PersistedContent;
                    contentIdToCheck = contentToCheck.Id;
                    break;
                case ContentSaveAction.SendPublish:
                    permissionToCheck.Add(ActionToPublish.Instance.Letter);
                    contentToCheck = contentItem.PersistedContent;
                    contentIdToCheck = contentToCheck.Id;
                    break;
                case ContentSaveAction.SaveNew:
                    //Save new requires both ActionNew AND ActionUpdate

                    permissionToCheck.Add(ActionNew.Instance.Letter);
                    permissionToCheck.Add(ActionUpdate.Instance.Letter);
                    if (contentItem.ParentId != Constants.System.Root)
                    {
                        contentToCheck = ContentService.GetById(contentItem.ParentId);
                        contentIdToCheck = contentToCheck.Id;
                    }
                    else
                    {
                        contentIdToCheck = contentItem.ParentId;
                    }
                    break;
                case ContentSaveAction.SendPublishNew:
                    //Send new requires both ActionToPublish AND ActionUpdate

                    permissionToCheck.Add(ActionNew.Instance.Letter);
                    permissionToCheck.Add(ActionToPublish.Instance.Letter);
                    if (contentItem.ParentId != Constants.System.Root)
                    {
                        contentToCheck = ContentService.GetById(contentItem.ParentId);
                        contentIdToCheck = contentToCheck.Id;
                    }
                    else
                    {
                        contentIdToCheck = contentItem.ParentId;
                    }
                    break;
                case ContentSaveAction.PublishNew:
                    //Publish new requires both ActionNew AND ActionPublish

                    permissionToCheck.Add(ActionNew.Instance.Letter);
                    permissionToCheck.Add(ActionPublish.Instance.Letter);

                    if (contentItem.ParentId != Constants.System.Root)
                    {
                        contentToCheck = ContentService.GetById(contentItem.ParentId);
                        contentIdToCheck = contentToCheck.Id;
                    }
                    else
                    {
                        contentIdToCheck = contentItem.ParentId;
                    }
                    break;
                default:
                    throw new ArgumentOutOfRangeException();
            }

            if (ContentController.CheckPermissions(
                actionContext.Request.Properties,
                Security.CurrentUser,
                UserService,
                ContentService,
                contentIdToCheck,
                permissionToCheck.ToArray(),
                contentToCheck) == false)
            {
                actionContext.Response = actionContext.Request.CreateUserNoAccessResponse();
                return;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,46,0],[27,9,27,10,0],[28,9,28,10,0],[30,9,30,124,0],[31,9,31,10,0],[32,13,32,40,0],[32,41,32,91,0],[33,13,33,37,0],[33,38,33,85,0],[34,13,34,34,0],[34,35,34,79,0],[35,13,35,46,0],[36,13,36,40,0],[37,13,37,34,0],[38,9,38,10,0],[42,17,42,18,0],[42,19,42,96,0],[42,97,42,98,0],[47,17,47,18,0],[47,19,47,71,0],[47,72,47,73,0],[52,17,52,18,0],[52,19,52,90,0],[52,91,52,92,0],[57,17,57,18,0],[57,19,57,31,0],[57,32,57,33,0],[61,9,61,10,0],[62,13,62,93,0],[68,13,68,54,0],[69,13,69,44,0],[71,13,71,40,0],[74,21,74,73,0],[75,21,75,67,0],[76,21,76,58,0],[77,21,77,27,0],[79,21,79,74,0],[80,21,80,67,0],[81,21,81,58,0],[82,21,82,27,0],[84,21,84,76,0],[85,21,85,67,0],[86,21,86,58,0],[87,21,87,27,0],[91,21,91,70,0],[92,21,92,73,0],[93,21,93,71,0],[94,21,94,22,0],[95,25,95,87,0],[96,25,96,62,0],[97,21,97,22,0],[99,21,99,22,0],[100,25,100,65,0],[101,21,101,22,0],[102,21,102,27,0],[106,21,106,70,0],[107,21,107,76,0],[108,21,108,71,0],[109,21,109,22,0],[110,25,110,87,0],[111,25,111,62,0],[112,21,112,22,0],[114,21,114,22,0],[115,25,115,65,0],[116,21,116,22,0],[117,21,117,27,0],[121,21,121,70,0],[122,21,122,74,0],[124,21,124,71,0],[125,21,125,22,0],[126,25,126,87,0],[127,25,127,62,0],[128,21,128,22,0],[130,21,130,22,0],[131,25,131,65,0],[132,21,132,22,0],[133,21,133,27,0],[135,21,135,61,0],[138,13,145,42,0],[146,13,146,14,0],[147,17,147,93,0],[148,17,148,24,0],[150,9,150,10,0]]);
    </script>
  </body>
</html>