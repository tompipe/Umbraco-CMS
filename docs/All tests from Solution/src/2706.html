<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\MultiNodeTreePicker\FilteredMediaTree.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Xml;
using System.Xml.Linq;
using umbraco.cms.businesslogic.media;
using umbraco.cms.presentation.Trees;

namespace umbraco.editorControls.MultiNodeTreePicker
{
    /// &lt;summary&gt;
    /// FilteredMediaTree for the MultiNodeTreePicker.
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class FilteredMediaTree : BaseMediaTree
    {
        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;FilteredMediaTree&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;app&quot;&gt;The app.&lt;/param&gt;
        public FilteredMediaTree(string app)
            : base(app)
        {
        }

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        private Media m_UserStartNodeMedia;

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        private Media m_DefinedStartNodeMedia;

        /// &lt;summary&gt;
        /// Returns the Media object of the starting node for the current User. This ensures
        /// that the Media object is only instantiated once.
        /// &lt;/summary&gt;
        protected Media UserStartNodeDoc
        {
            get
            {
                if (m_UserStartNodeMedia == null)
                {
                    if (CurrentUser.StartMediaId &lt;= 0)
                    {
                        return new Media(-1, true);
                    }
                    m_UserStartNodeMedia = new Media(CurrentUser.StartMediaId);
                }
                return m_UserStartNodeMedia;
            }
        }

        /// &lt;summary&gt;
        /// Returns the Media object of the starting node that is defined in the prevalue editor. This ensures
        /// that the Media object is only instantiated once.
        /// &lt;/summary&gt;
        protected Media DefinedStartNodeMedia
        {
            get
            {
                if (m_DefinedStartNodeMedia == null)
                {
                    var definedId = this.GetPersistedCookieValue(x =&gt; x.MntpGetStartNodeId(this.GetDataTypeId()), -1);
                    if (definedId &lt;= 0)
                    {
                        return new Media(-1, true);
                    }
                    m_DefinedStartNodeMedia = new Media(definedId);
                }
                return m_DefinedStartNodeMedia;
            }
        }

        /// &lt;summary&gt;
        /// The start node id determined by the defined id and by the user&#39;s defined id
        /// &lt;/summary&gt;
        private int? m_DeterminedStartNodeId = null;

        #region Overridden methods
        /// &lt;summary&gt;
        /// Determines the allowed start node id based on the users start node id and the 
        /// defined start node id in the data type.
        /// &lt;/summary&gt;
        public override int StartNodeID
        {
            get
            {
                //we only need to determine the id once
                if (m_DeterminedStartNodeId.HasValue)
                {
                    return m_DeterminedStartNodeId.Value;
                }

                m_DeterminedStartNodeId = this.GetStartNodeId(DefinedStartNodeMedia, UserStartNodeDoc);

                return m_DeterminedStartNodeId.Value;
            }
        }

        /// &lt;summary&gt;
        /// Creates the root node.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;rootNode&quot;&gt;The root node.&lt;/param&gt;
        protected override void CreateRootNode(ref XmlTreeNode rootNode)
        {
            if (!this.SetNullTreeRootNode(StartNodeID, ref rootNode, app))
            {
                rootNode.Action = &quot;javascript:openContent(-1);&quot;;
                rootNode.Source = this.GetTreeServiceUrlWithParams(StartNodeID, this.GetDataTypeId());
                if (StartNodeID &gt; 0)
                {
                    var startNode = new Media(StartNodeID);
                    rootNode.Text = startNode.Text;
                    rootNode.Icon = startNode.ContentTypeIcon;
                }
            }
        }

        /// &lt;summary&gt;
        /// Called when [before node render].
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The sender.&lt;/param&gt;
        /// &lt;param name=&quot;node&quot;&gt;The node.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;System.EventArgs&quot;/&gt; instance containing the event data.&lt;/param&gt;
        protected override void OnBeforeNodeRender(ref XmlTree sender, ref XmlTreeNode node, EventArgs e)
        {

            var xpath = this.GetXPathFromCookie(this.GetDataTypeId());
            var xPathType = this.GetXPathFilterTypeFromCookie(this.GetDataTypeId());
            var xDoc = new XmlDocument();

            var xmlNode = umbraco.library.GetMedia(int.Parse(node.NodeID), false).Current.OuterXml;

            var xmlString = &quot;&lt;root&gt;&quot; + xmlNode + &quot;&lt;/root&gt;&quot;;
            var xml = XElement.Parse(xmlString);

            node.DetermineClickable(xpath, xPathType, xml);

            //ensure that the NodeKey is passed through
            node.Source = this.GetTreeServiceUrlWithParams(int.Parse(node.NodeID), this.GetDataTypeId());

            base.OnBeforeNodeRender(ref sender, ref node, e);
        }
        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,15,20,24,0],[21,9,21,10,0],[22,9,22,10,0],[41,13,41,14,0],[42,17,42,50,0],[43,17,43,18,0],[44,21,44,55,0],[45,21,45,22,0],[46,25,46,52,0],[48,21,48,80,0],[49,17,49,18,0],[50,17,50,45,0],[51,13,51,14,0],[61,13,61,14,0],[62,17,62,53,0],[63,17,63,18,0],[64,21,64,71,0],[64,71,64,113,0],[64,113,64,119,0],[64,21,64,119,0],[65,21,65,40,0],[66,21,66,22,0],[67,25,67,52,0],[69,21,69,68,0],[70,17,70,18,0],[71,17,71,48,0],[72,13,72,14,0],[78,9,78,53,0],[88,13,88,14,0],[90,17,90,54,0],[91,17,91,18,0],[92,21,92,58,0],[95,17,95,104,0],[97,17,97,54,0],[98,13,98,14,0],[106,9,106,10,0],[107,13,107,75,0],[108,13,108,14,0],[109,17,109,65,0],[110,17,110,103,0],[111,17,111,37,0],[112,17,112,18,0],[113,21,113,60,0],[114,21,114,52,0],[115,21,115,63,0],[116,17,116,18,0],[117,13,117,14,0],[118,9,118,10,0],[127,9,127,10,0],[129,13,129,71,0],[130,13,130,85,0],[131,13,131,42,0],[133,13,133,100,0],[135,13,135,60,0],[136,13,136,49,0],[138,13,138,60,0],[141,13,141,106,0],[143,13,143,62,0],[144,9,144,10,0]]);
    </script>
  </body>
</html>