<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\developer\Macros\assemblyBrowser.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Reflection;
using System.Collections.Specialized;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Web;
using Umbraco.Core.PropertyEditors;
using umbraco.BusinessLogic;
using System.Collections.Generic;
using MacroProperty = umbraco.cms.businesslogic.macro.MacroProperty;

namespace umbraco.developer
{
    /// &lt;summary&gt;
    /// Summary description for assemblyBrowser.
    /// &lt;/summary&gt;
    public partial class assemblyBrowser : BasePages.UmbracoEnsuredPage
    {
        public assemblyBrowser()
        {
            CurrentApp = DefaultApps.developer.ToString();
        }
        protected void Page_Load(object sender, EventArgs e)
        {

            var isUserControl = false;
            var errorReadingControl = false;

            try
            {

                Type type = null;
                if (Request.QueryString[&quot;type&quot;] == null)
                {
                    isUserControl = true;
                    var fileName = Request.GetItemAsString(&quot;fileName&quot;);
                    if (!fileName.StartsWith(&quot;~&quot;))
                    {
                        if (fileName.StartsWith(&quot;/&quot;))
                        {
                            fileName = &quot;~&quot; + fileName;
                        }
                        else
                        {
                            fileName = &quot;~/&quot; + fileName;
                        }
                    }
                    IOHelper.ValidateEditPath(fileName, SystemDirectories.UserControls);
                    
                    if (System.IO.File.Exists(IOHelper.MapPath(fileName)))
                    {
                        var oControl = (UserControl)LoadControl(fileName);

                        type = oControl.GetType();
                    }
                    else
                    {
                        errorReadingControl = true;
                        ChooseProperties.Visible = false;
                        AssemblyName.Text = &quot;&lt;span style=\&quot;color: red;\&quot;&gt;User control doesn&#39;t exist&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;Please verify that you&#39;ve copied the file to:&lt;br /&gt;&quot; + IOHelper.MapPath(&quot;~/&quot; + fileName);
                    }
                }
                else
                {
                    var currentAss = IOHelper.MapPath(SystemDirectories.Bin + &quot;/&quot; + Request.QueryString[&quot;fileName&quot;] + &quot;.dll&quot;);
                    var asm = Assembly.LoadFrom(currentAss);
                    type = asm.GetType(Request.QueryString[&quot;type&quot;]);
                }

                if (!errorReadingControl)
                {
                    string fullControlAssemblyName;
                    if (isUserControl)
                    {
                        AssemblyName.Text = &quot;Choose Properties from &quot; + type.BaseType.Name;
                        fullControlAssemblyName = type.BaseType.Namespace + &quot;.&quot; + type.BaseType.Name;
                    }
                    else
                    {
                        AssemblyName.Text = &quot;Choose Properties from &quot; + type.Name;
                        fullControlAssemblyName = type.Namespace + &quot;.&quot; + type.Name;
                    }


                    if (!IsPostBack &amp;&amp; type != null)
                    {
                        MacroProperties.Items.Clear();
                        foreach (var pi in type.GetProperties())
                        {
                            if (pi.CanWrite &amp;&amp; ((fullControlAssemblyName == pi.DeclaringType.Namespace + &quot;.&quot; + pi.DeclaringType.Name) || pi.DeclaringType == type))
                            {
                                MacroProperties.Items.Add(new ListItem(pi.Name + &quot; &lt;span style=\&quot;color: #99CCCC\&quot;&gt;(&quot; + pi.PropertyType.Name + &quot;)&lt;/span&gt;&quot;, pi.PropertyType.Name));
                            }

                            foreach (ListItem li in MacroProperties.Items)
                                li.Selected = true;
                        }
                    }
        
                }
            }
            catch (Exception err)
            {
                AssemblyName.Text = &quot;Error reading &quot; + Request.CleanForXss(&quot;fileName&quot;);
                Button1.Visible = false;
                ChooseProperties.Controls.Add(new LiteralControl(&quot;&lt;p class=\&quot;guiDialogNormal\&quot; style=\&quot;color: red;\&quot;&gt;&quot; + err.ToString() + &quot;&lt;/p&gt;&lt;p/&gt;&lt;p class=\&quot;guiDialogNormal\&quot;&gt;&quot;));
            }

        }
        
        protected void Button1_Click(object sender, EventArgs e)
        {
            var result = &quot;&quot;;

            // Get the macro object
            var macroObject = ApplicationContext.Current.Services.MacroService.GetById(Convert.ToInt32(Request.QueryString[&quot;macroID&quot;]));
            
            //// Load all macroPropertyTypes
            //var macroPropertyTypes = new Hashtable();
            //var macroPropertyIds = new Hashtable();

            //var macroPropTypes = ParameterEditorResolver.Current.ParameterEditors.ToArray();
            
            //foreach (var mpt in macroPropTypes)
            //{
            //    macroPropertyIds.Add(mpt.Alias, mpt.Id.ToString());
            //    macroPropertyTypes.Add(mpt.Alias, mpt.BaseType);
            //}
            var changed = false;

            foreach (ListItem li in MacroProperties.Items)
            {
                if (li.Selected &amp;&amp; MacroHasProperty(macroObject, li.Text.Substring(0, li.Text.IndexOf(&quot; &quot;, StringComparison.Ordinal)).ToLower()) == false)
                {
                    result += &quot;&lt;li&gt;Added: &quot; + SpaceCamelCasing(li.Text) + &quot;&lt;/li&gt;&quot;;
                    var macroPropertyTypeAlias = GetMacroTypeFromClrType(li.Value);

                    macroObject.Properties.Add(new Umbraco.Core.Models.MacroProperty
                    {
                        Name = SpaceCamelCasing(li.Text),
                        Alias = li.Text.Substring(0, li.Text.IndexOf(&quot; &quot;, StringComparison.Ordinal)),
                        EditorAlias = macroPropertyTypeAlias                        
                    });

                    changed = true;
                }
                else if (li.Selected)
                {
                    result += &quot;&lt;li&gt;Skipped: &quot; + SpaceCamelCasing(li.Text) + &quot; (already exists as a parameter)&lt;/li&gt;&quot;;
                }
            }

            if (changed)
            {
                ApplicationContext.Current.Services.MacroService.Save(macroObject);    
            }

            ChooseProperties.Visible = false;
            ConfigProperties.Visible = true;
            resultLiteral.Text = result;
        }

        private static bool MacroHasProperty(IMacro macroObject, string propertyAlias)
        {
            return macroObject.Properties.Any(mp =&gt; mp.Alias.ToLower() == propertyAlias);
        }

        private static string SpaceCamelCasing(string text)
        {
            var tempString = text.Substring(0, 1).ToUpper();
            for (var i = 1; i &lt; text.Length; i++)
            {
                if (text.Substring(i, 1) == &quot; &quot;)
                    break;
                if (text.Substring(i, 1).ToUpper() == text.Substring(i, 1))
                    tempString += &quot; &quot;;
                tempString += text.Substring(i, 1);
            }
            return tempString;
        }

        private static string GetMacroTypeFromClrType(string baseTypeName)
        {
            switch (baseTypeName)
            {
                case &quot;Int32&quot;:
                    return Constants.PropertyEditors.IntegerAlias;
                case &quot;Decimal&quot;:
                    //we previously only had an integer editor too! - this would of course
                    // fail if someone enters a real long number
                    return Constants.PropertyEditors.IntegerAlias;                
                case &quot;Boolean&quot;:
                    return Constants.PropertyEditors.TrueFalseAlias;
                case &quot;String&quot;:
                default:
                    return Constants.PropertyEditors.TextboxAlias;
            }
        }

    }

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,33,0],[31,9,31,10,0],[32,13,32,59,0],[33,9,33,10,0],[35,9,35,10,0],[37,13,37,39,0],[38,13,38,45,0],[41,13,41,14,0],[43,17,43,34,0],[44,17,44,57,0],[45,17,45,18,0],[46,21,46,42,0],[47,21,47,72,0],[48,21,48,51,0],[49,21,49,22,0],[50,25,50,54,0],[51,25,51,26,0],[52,29,52,55,0],[53,25,53,26,0],[55,25,55,26,0],[56,29,56,56,0],[57,25,57,26,0],[58,21,58,22,0],[59,21,59,89,0],[61,21,61,75,0],[62,21,62,22,0],[63,25,63,75,0],[65,25,65,51,0],[66,21,66,22,0],[68,21,68,22,0],[69,25,69,52,0],[70,25,70,58,0],[71,25,71,208,0],[72,21,72,22,0],[73,17,73,18,0],[75,17,75,18,0],[76,21,76,127,0],[77,21,77,61,0],[78,21,78,69,0],[79,17,79,18,0],[81,17,81,42,0],[82,17,82,18,0],[84,21,84,39,0],[85,21,85,22,0],[86,25,86,92,0],[87,25,87,102,0],[88,21,88,22,0],[90,21,90,22,0],[91,25,91,83,0],[92,25,92,84,0],[93,21,93,22,0],[96,21,96,53,0],[97,21,97,22,0],[98,25,98,55,0],[99,25,99,32,0],[99,34,99,40,0],[99,41,99,43,0],[99,44,99,64,0],[100,25,100,26,0],[101,29,101,164,0],[102,29,102,30,0],[103,33,103,178,0],[104,29,104,30,0],[106,29,106,36,0],[106,38,106,49,0],[106,50,106,52,0],[106,53,106,74,0],[107,33,107,52,0],[108,25,108,26,0],[109,21,109,22,0],[111,17,111,18,0],[112,13,112,14,0],[113,13,113,34,0],[114,13,114,14,0],[115,17,115,88,0],[116,17,116,41,0],[117,17,117,181,0],[118,13,118,14,0],[120,9,120,10,0],[123,9,123,10,0],[124,13,124,29,0],[127,13,127,137,0],[140,13,140,33,0],[142,13,142,20,0],[142,22,142,33,0],[142,34,142,36,0],[142,37,142,58,0],[143,13,143,14,0],[144,17,144,155,0],[145,17,145,18,0],[146,21,146,83,0],[147,21,147,84,0],[149,21,154,24,0],[156,21,156,36,0],[157,17,157,18,0],[158,22,158,38,0],[159,17,159,18,0],[160,21,160,117,0],[161,17,161,18,0],[162,13,162,14,0],[164,13,164,25,0],[165,13,165,14,0],[166,17,166,84,0],[167,13,167,14,0],[169,13,169,46,0],[170,13,170,45,0],[171,13,171,41,0],[172,9,172,10,0],[175,9,175,10,0],[176,13,176,53,0],[176,53,176,88,0],[176,88,176,90,0],[176,13,176,90,0],[177,9,177,10,0],[180,9,180,10,0],[181,13,181,61,0],[182,18,182,27,0],[182,29,182,44,0],[182,46,182,49,0],[183,13,183,14,0],[184,17,184,49,0],[185,21,185,27,0],[186,17,186,76,0],[187,21,187,39,0],[188,17,188,52,0],[189,13,189,14,0],[190,13,190,31,0],[191,9,191,10,0],[194,9,194,10,0],[195,13,195,34,0],[198,21,198,67,0],[202,21,202,67,0],[204,21,204,69,0],[207,21,207,67,0],[209,9,209,10,0]]);
    </script>
  </body>
</html>