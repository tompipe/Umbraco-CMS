<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\sort.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Globalization;
using System.Linq;
using System.Web.UI.WebControls;
using System.Xml;
using Umbraco.Core;
using Umbraco.Web;
using umbraco.BasePages;
using umbraco.BusinessLogic.Actions;
using umbraco.cms.businesslogic;
using umbraco.cms.businesslogic.media;
using umbraco.cms.businesslogic.web;
using System.Web.UI;
using System.Collections.Generic;

namespace umbraco.cms.presentation
{
    /// &lt;summary&gt;
    /// Summary description for sort.
    /// &lt;/summary&gt;
    public partial class sort : UmbracoEnsuredPage
    {
        private readonly List&lt;SortableNode&gt; _nodes = new List&lt;SortableNode&gt;();

        protected bool HideDateColumn
        {
            set { ViewState[&quot;HideDateColumn&quot;] = value; }
            get { return ViewState[&quot;HideDateColumn&quot;] == null ? false : (bool) ViewState[&quot;HideDateColumn&quot;]; }
        }

        protected override void OnInit(EventArgs e)
        {
            CurrentApp = helper.Request(&quot;app&quot;);

            base.OnInit(e);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            sortDone.Text = ui.Text(&quot;sort&quot;, &quot;sortDone&quot;);
        }
        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/nodesorter.asmx&quot;));
            ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/legacyAjaxCalls.asmx&quot;));

            var app = Request.GetItemAsString(&quot;app&quot;);

            var icon = &quot;../images/umbraco/doc.gif&quot;;

            int parentId;
            if (int.TryParse(Request.GetItemAsString(&quot;ID&quot;), out parentId))
            {
                if (app == Constants.Applications.Media)
                {
                    icon = &quot;../images/umbraco/mediaPhoto.gif&quot;;
                    var mediaService = ApplicationContext.Current.Services.MediaService;

                    if (parentId == -1)
                    {
                        foreach (var child in mediaService.GetRootMedia().ToList().OrderBy(x =&gt; x.SortOrder))
                            _nodes.Add(CreateNode(child.Id.ToInvariantString(), child.SortOrder, child.Name, child.CreateDate, icon));
                    }
                    else
                    {
                        var children = mediaService.GetChildren(parentId);
                        foreach (var child in children.OrderBy(x =&gt; x.SortOrder))
                            _nodes.Add(CreateNode(child.Id.ToInvariantString(), child.SortOrder, child.Name, child.CreateDate, icon));
                    }
                }

                if (app == Constants.Applications.Content)
                {
                    var contentService = ApplicationContext.Current.Services.ContentService;

                    if (parentId == -1)
                    {
                        foreach (var child in contentService.GetRootContent().ToList().OrderBy(x =&gt; x.SortOrder))
                            _nodes.Add(CreateNode(child.Id.ToInvariantString(), child.SortOrder, child.Name, child.CreateDate, icon));
                    }
                    else
                    {
                        var children = contentService.GetChildren(parentId);
                        foreach (var child in children)
                            _nodes.Add(CreateNode(child.Id.ToInvariantString(), child.SortOrder, child.Name, child.CreateDate, icon));
                    }
                }
                
                bindNodesToList(string.Empty);
            }
            else
            {
                // hack for stylesheet, used to sort stylesheet properties
                if (app == Constants.Applications.Settings)
                {
                    icon = &quot;../images/umbraco/settingCss.gif&quot;;

                    HideDateColumn = true;

                    var stylesheetName = Request.GetItemAsString(&quot;ID&quot;);
                    if (stylesheetName.IsNullOrWhiteSpace())throw new NullReferenceException(&quot;No Id passed in to editor&quot;);
                    var stylesheet = Services.FileService.GetStylesheetByName(stylesheetName.EnsureEndsWith(&quot;.css&quot;));
                    if (stylesheet == null) throw new InvalidOperationException(&quot;No stylesheet found by name &quot; + stylesheetName);

                    var sort = 0;
                    foreach (var child in stylesheet.Properties)
                    {                        
                        _nodes.Add(CreateNode(child.Name, sort, child.Name, DateTime.Now, icon));
                        sort++;
                    }
                    
                    bindNodesToList(string.Empty);
                }
            }
        }

        public void bindNodesToList(string sortBy)
        {
            if (string.IsNullOrEmpty(sortBy) == false)
            {
                switch (sortBy)
                {
                    case &quot;nodeName&quot;:
                        _nodes.Sort(new nodeNameCompare());
                        break;
                    case &quot;createDate&quot;:
                        _nodes.Sort(new createDateCompare());
                        break;
                }
            }

            foreach (var n in _nodes)
                lt_nodes.Text += string.Format(
                    &quot;&lt;tr id=&#39;node_{0}&#39;&gt;&lt;td&gt;{1}&lt;/td&gt;&lt;td class=&#39;nowrap&#39; style=&#39;display:{5};&#39;&gt;{2} {3}&lt;/td&gt;&lt;td style=&#39;text-align: center;&#39;&gt;{4}&lt;/td&gt;&lt;/tr&gt;&quot;,
                    n.id, n.Name, n.createDate.ToShortDateString(), n.createDate.ToShortTimeString(), n.sortOrder, HideDateColumn ? &quot;none&quot; : &quot;table-cell&quot;);
        }

        private static SortableNode CreateNode(string id, int sortOrder, string name, DateTime createDateTime, string icon)
        {
            var node = new SortableNode
                            {
                                id = id,
                                sortOrder = sortOrder,
                                Name = name,
                                icon = icon,
                                createDate = createDateTime
                            };
            return node;
        }

        public struct SortableNode
        {
            public string id;
            public int sortOrder;
            public string Name;
            public string icon;
            public DateTime createDate;
        }

        /// &lt;summary&gt;
        /// JsInclude1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::ClientDependency.Core.Controls.JsInclude JsInclude1;

        /// &lt;summary&gt;
        /// JsInclude2 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::ClientDependency.Core.Controls.JsInclude JsInclude2;

        /// &lt;summary&gt;
        /// prog1 control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.ProgressBar prog1;

        /// &lt;summary&gt;
        /// sortDone control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Literal sortDone;

        /// &lt;summary&gt;
        /// sortPane control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::umbraco.uicontrols.Pane sortPane;

        /// &lt;summary&gt;
        /// lt_nodes control.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Auto-generated field.
        /// To modify move field declaration from designer file to code-behind file.
        /// &lt;/remarks&gt;
        protected global::System.Web.UI.WebControls.Literal lt_nodes;

    }

    public class nodeNameCompare : IComparer&lt;sort.SortableNode&gt;
    {

        #region IComparer&lt;CMSNode&gt; Members

        public int Compare(sort.SortableNode x, sort.SortableNode y)
        {
            var returnValue = String.Compare(x.Name, y.Name, StringComparison.Ordinal);

            return returnValue;
        }

        #endregion
    }

    public class createDateCompare : IComparer&lt;sort.SortableNode&gt;
    {

        #region IComparer&lt;CMSNode&gt; Members

        public int Compare(sort.SortableNode x, sort.SortableNode y)
        {
            var returnValue = x.createDate.CompareTo(y.createDate);

            return returnValue;
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,79,0],[28,17,28,18,0],[28,19,28,55,0],[28,56,28,57,0],[29,17,29,18,0],[29,19,29,107,0],[29,108,29,109,0],[33,9,33,10,0],[34,13,34,48,0],[36,13,36,28,0],[37,9,37,10,0],[40,9,40,10,0],[41,13,41,57,0],[42,9,42,10,0],[44,9,44,10,0],[45,13,45,33,0],[47,13,47,113,0],[48,13,48,118,0],[50,13,50,54,0],[52,13,52,52,0],[55,13,55,75,0],[56,13,56,14,0],[57,17,57,57,0],[58,17,58,18,0],[59,21,59,63,0],[60,21,60,89,0],[62,21,62,40,0],[63,21,63,22,0],[64,25,64,32,0],[64,34,64,43,0],[64,44,64,46,0],[64,47,64,97,0],[64,97,64,108,0],[64,108,64,109,0],[64,47,64,109,0],[65,29,65,135,0],[66,21,66,22,0],[68,21,68,22,0],[69,25,69,75,0],[70,25,70,32,0],[70,34,70,43,0],[70,44,70,46,0],[70,47,70,69,0],[70,69,70,80,0],[70,80,70,81,0],[70,47,70,81,0],[71,29,71,135,0],[72,21,72,22,0],[73,17,73,18,0],[75,17,75,59,0],[76,17,76,18,0],[77,21,77,93,0],[79,21,79,40,0],[80,21,80,22,0],[81,25,81,32,0],[81,34,81,43,0],[81,44,81,46,0],[81,47,81,101,0],[81,101,81,112,0],[81,112,81,113,0],[81,47,81,113,0],[82,29,82,135,0],[83,21,83,22,0],[85,21,85,22,0],[86,25,86,77,0],[87,25,87,32,0],[87,34,87,43,0],[87,44,87,46,0],[87,47,87,55,0],[88,29,88,135,0],[89,21,89,22,0],[90,17,90,18,0],[92,17,92,47,0],[93,13,93,14,0],[95,13,95,14,0],[97,17,97,60,0],[98,17,98,18,0],[99,21,99,63,0],[101,21,101,43,0],[103,21,103,72,0],[104,21,104,61,0],[104,61,104,123,0],[105,21,105,118,0],[106,21,106,44,0],[106,45,106,130,0],[108,21,108,34,0],[109,21,109,28,0],[109,30,109,39,0],[109,40,109,42,0],[109,43,109,64,0],[110,21,110,22,0],[111,25,111,98,0],[112,25,112,32,0],[113,21,113,22,0],[115,21,115,51,0],[116,17,116,18,0],[117,13,117,14,0],[118,9,118,10,0],[121,9,121,10,0],[122,13,122,55,0],[123,13,123,14,0],[124,17,124,32,0],[127,25,127,60,0],[128,25,128,31,0],[130,25,130,62,0],[131,25,131,31,0],[133,13,133,14,0],[135,13,135,20,0],[135,22,135,27,0],[135,28,135,30,0],[135,31,135,37,0],[136,17,138,156,0],[139,9,139,10,0],[142,9,142,10,0],[143,13,150,31,0],[151,13,151,25,0],[152,9,152,10,0],[225,9,225,10,0],[226,13,226,88,0],[228,13,228,32,0],[229,9,229,10,0],[240,9,240,10,0],[241,13,241,68,0],[243,13,243,32,0],[244,9,244,10,0]]);
    </script>
  </body>
</html>