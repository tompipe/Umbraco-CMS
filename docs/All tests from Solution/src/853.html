<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Strategies\Migrations\PublishAfterUpgradeToVersionSixth.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core.Events;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Persistence.UnitOfWork;
using umbraco.interfaces;
using Umbraco.Core;
using Umbraco.Core.Configuration;

namespace Umbraco.Web.Strategies.Migrations
{
    /// &lt;summary&gt;
    /// This event ensures that upgrades from (configured) versions lower then 6.0.0
    /// have their publish state updated after the database schema has been migrated.
    /// &lt;/summary&gt;
    public class PublishAfterUpgradeToVersionSixth : MigrationStartupHander
    {
        protected override void AfterMigration(MigrationRunner sender, MigrationEventArgs e)
        {
            if (e.ProductName != GlobalSettings.UmbracoMigrationName) return;

            var target = new Version(6, 0, 0);
            if (e.ConfiguredVersion &lt; target)
            {
                var sql = new Sql();
                sql.Select(&quot;*&quot;)
                    .From&lt;DocumentDto&gt;()
                    .InnerJoin&lt;ContentVersionDto&gt;()
                    .On&lt;DocumentDto, ContentVersionDto&gt;(left =&gt; left.VersionId, right =&gt; right.VersionId)
                    .InnerJoin&lt;ContentDto&gt;()
                    .On&lt;ContentVersionDto, ContentDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                    .InnerJoin&lt;NodeDto&gt;()
                    .On&lt;ContentDto, NodeDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                    .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == new Guid(Constants.ObjectTypes.Document))
                    .Where&lt;NodeDto&gt;(x =&gt; x.Path.StartsWith(&quot;-1&quot;));

                var dtos = e.MigrationContext.Database.Fetch&lt;DocumentDto, ContentVersionDto, ContentDto, NodeDto&gt;(sql);
                var toUpdate = new List&lt;DocumentDto&gt;();
                var versionGroup = dtos.GroupBy(x =&gt; x.NodeId);
                foreach (var grp in versionGroup)
                {
                    var published = grp.FirstOrDefault(x =&gt; x.Published);
                    var newest = grp.FirstOrDefault(x =&gt; x.Newest);

                    if (newest != null)
                    {
                        double timeDiff = new TimeSpan(newest.UpdateDate.Ticks - newest.ContentVersionDto.VersionDate.Ticks).TotalMilliseconds;
                        var hasPendingChanges = timeDiff &gt; 2000;

                        if (hasPendingChanges == false &amp;&amp; published != null)
                        {
                            published.Published = false;
                            toUpdate.Add(published);
                            newest.Published = true;
                            toUpdate.Add(newest);
                        }
                    }
                }

                //Commit the updated entries for the cmsDocument table
                using (var transaction = e.MigrationContext.Database.GetTransaction())
                {
                    //Loop through the toUpdate
                    foreach (var dto in toUpdate)
                    {
                        e.MigrationContext.Database.Update(dto);
                    }

                    transaction.Complete();
                }
            }
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,0],[23,13,23,70,0],[23,71,23,78,0],[25,13,25,47,0],[26,13,26,46,0],[27,13,27,14,0],[28,17,28,37,0],[29,17,38,67,0],[40,17,40,120,0],[41,17,41,56,0],[42,17,42,54,0],[42,54,42,62,0],[42,62,42,64,0],[42,17,42,64,0],[43,17,43,24,0],[43,26,43,33,0],[43,34,43,36,0],[43,37,43,49,0],[44,17,44,18,0],[45,21,45,61,0],[45,61,45,72,0],[45,72,45,74,0],[45,21,45,74,0],[46,21,46,58,0],[46,58,46,66,0],[46,66,46,68,0],[46,21,46,68,0],[48,21,48,40,0],[49,21,49,22,0],[50,25,50,144,0],[51,25,51,65,0],[53,25,53,77,0],[54,25,54,26,0],[55,29,55,57,0],[56,29,56,53,0],[57,29,57,53,0],[58,29,58,50,0],[59,25,59,26,0],[60,21,60,22,0],[61,17,61,18,0],[64,24,64,86,0],[65,17,65,18,0],[67,21,67,28,0],[67,30,67,37,0],[67,38,67,40,0],[67,41,67,49,0],[68,21,68,22,0],[69,25,69,65,0],[70,21,70,22,0],[72,21,72,44,0],[73,17,73,18,0],[74,13,74,14,0],[75,9,75,10,0]]);
    </script>
  </body>
</html>