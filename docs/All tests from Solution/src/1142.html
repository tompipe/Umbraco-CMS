<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\InstallSteps\MajorVersion7UpgradeReport.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.PropertyEditors;
using Umbraco.Web.Install.Models;

namespace Umbraco.Web.Install.InstallSteps
{
    [InstallSetupStep(InstallationType.Upgrade,
        &quot;MajorVersion7UpgradeReport&quot;, 1, &quot;&quot;)]
    internal class MajorVersion7UpgradeReport : InstallSetupStep&lt;object&gt;
    {
        private readonly ApplicationContext _applicationContext;

        public MajorVersion7UpgradeReport(ApplicationContext applicationContext)
        {
            _applicationContext = applicationContext;
        }

        public override InstallSetupResult Execute(object model)
        {
            //we cannot run this step if the db is not configured.
            if (_applicationContext.DatabaseContext.IsDatabaseConfigured == false)
            {
                return null;
            }

            var result = _applicationContext.DatabaseContext.ValidateDatabaseSchema();
            var determinedVersion = result.DetermineInstalledVersion();

            return new InstallSetupResult(&quot;version7upgradereport&quot;, 
                new
                {
                    currentVersion = determinedVersion.ToString(),
                    newVersion = UmbracoVersion.Current.ToString(),
                    errors = CreateReport()
                });
        }

        public override bool RequiresExecution(object model)
        {
            //if it&#39;s configured, then no need to run
            if (_applicationContext.IsConfigured)
            {
                return false;
            }

            try
            {
                //we cannot run this step if the db is not configured.
                if (_applicationContext.DatabaseContext.IsDatabaseConfigured == false)
                {
                    return false;
                }
            }
            catch (InvalidOperationException)
            {
                //if there is no db context
                return false;
            }

            var result = _applicationContext.DatabaseContext.ValidateDatabaseSchema();
            var determinedVersion = result.DetermineInstalledVersion();
            if ((string.IsNullOrWhiteSpace(GlobalSettings.ConfigurationStatus) == false || determinedVersion.Equals(new Version(0, 0, 0)) == false)
                &amp;&amp; UmbracoVersion.Current.Major &gt; determinedVersion.Major)
            {
                //it&#39;s an upgrade to a major version so we&#39;re gonna show this step if there are issues

                var report = CreateReport();
                return report.Any();
            }

            return false;
        }

        private IEnumerable&lt;string&gt; CreateReport()
        {
            var errorReport = new List&lt;string&gt;();

            var sql = new Sql();
            sql
                .Select(
                    SqlSyntaxContext.SqlSyntaxProvider.GetQuotedColumn(&quot;cmsDataType&quot;, &quot;controlId&quot;),
                    SqlSyntaxContext.SqlSyntaxProvider.GetQuotedColumn(&quot;umbracoNode&quot;, &quot;text&quot;))
                .From(SqlSyntaxContext.SqlSyntaxProvider.GetQuotedTableName(&quot;cmsDataType&quot;))
                .InnerJoin(SqlSyntaxContext.SqlSyntaxProvider.GetQuotedTableName(&quot;umbracoNode&quot;))
                .On(
                    SqlSyntaxContext.SqlSyntaxProvider.GetQuotedColumn(&quot;cmsDataType&quot;, &quot;nodeId&quot;) + &quot; = &quot; +
                    SqlSyntaxContext.SqlSyntaxProvider.GetQuotedColumn(&quot;umbracoNode&quot;, &quot;id&quot;));

            var list = _applicationContext.DatabaseContext.Database.Fetch&lt;dynamic&gt;(sql);
            foreach (var item in list)
            {
                Guid legacyId = item.controlId;
                //check for a map entry
                var alias = LegacyPropertyEditorIdToAliasConverter.GetAliasFromLegacyId(legacyId);
                if (alias != null)
                {
                    //check that the new property editor exists with that alias
                    var editor = PropertyEditorResolver.Current.GetByAlias(alias);
                    if (editor == null)
                    {
                        errorReport.Add(string.Format(&quot;Property Editor with ID &#39;{0}&#39; (assigned to Data Type &#39;{1}&#39;) has a valid GUID -&gt; Alias map but no property editor was found. It will be replaced with a Readonly/Label property editor.&quot;, item.controlId, item.text));
                    }
                }
                else
                {
                    errorReport.Add(string.Format(&quot;Property Editor with ID &#39;{0}&#39; (assigned to Data Type &#39;{1}&#39;) does not have a valid GUID -&gt; Alias map. It will be replaced with a Readonly/Label property editor.&quot;, item.controlId, item.text));
                }
            }

            return errorReport;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,81,0],[20,9,20,10,0],[21,13,21,54,0],[22,9,22,10,0],[25,9,25,10,0],[27,13,27,83,0],[28,13,28,14,0],[29,17,29,29,0],[32,13,32,87,0],[33,13,33,72,0],[35,13,41,20,0],[42,9,42,10,0],[45,9,45,10,0],[47,13,47,50,0],[48,13,48,14,0],[49,17,49,30,0],[53,13,53,14,0],[55,17,55,87,0],[56,17,56,18,0],[57,21,57,34,0],[59,13,59,14,0],[60,13,60,46,0],[61,13,61,14,0],[63,17,63,30,0],[66,13,66,87,0],[67,13,67,72,0],[68,13,69,75,0],[70,13,70,14,0],[73,17,73,45,0],[74,17,74,37,0],[77,13,77,26,0],[78,9,78,10,0],[81,9,81,10,0],[82,13,82,50,0],[84,13,84,33,0],[85,13,93,94,0],[95,13,95,89,0],[96,13,96,20,0],[96,22,96,30,0],[96,31,96,33,0],[96,34,96,38,0],[97,13,97,14,0],[98,17,98,48,0],[100,17,100,99,0],[101,17,101,35,0],[102,17,102,18,0],[104,21,104,83,0],[105,21,105,40,0],[106,21,106,22,0],[107,25,107,269,0],[108,21,108,22,0],[109,17,109,18,0],[111,17,111,18,0],[112,21,112,242,0],[113,17,113,18,0],[114,13,114,14,0],[116,13,116,32,0],[117,9,117,10,0]]);
    </script>
  </body>
</html>