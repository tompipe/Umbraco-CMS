<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\InstallSteps\StarterKitDownloadStep.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using umbraco.cms.businesslogic.packager;
using Umbraco.Core;
using Umbraco.Web.Install.Models;

namespace Umbraco.Web.Install.InstallSteps
{
    [InstallSetupStep(InstallationType.NewInstall,
        &quot;StarterKitDownload&quot;, &quot;starterKit&quot;, 30, &quot;Adding a simple website to Umbraco, will make it easier for you to get started&quot;)]
    internal class StarterKitDownloadStep : InstallSetupStep&lt;Guid?&gt;
    {
        private readonly ApplicationContext _applicationContext;

        public StarterKitDownloadStep(ApplicationContext applicationContext)
        {
            _applicationContext = applicationContext;
        }

        private const string RepoGuid = &quot;65194810-1f85-11dd-bd0b-0800200c9a66&quot;;

        public override InstallSetupResult Execute(Guid? starterKitId)
        {
            //if there is no value assigned then use the default starter kit
            if (starterKitId.HasValue == false)
            {
                var installHelper = new InstallHelper(UmbracoContext.Current);
                var starterKits = installHelper.GetStarterKits().FirstOrDefault();
                if (starterKits != null)
                    starterKitId = starterKits.Id;
                else
                    return null;
            }
            else if (starterKitId.Value == Guid.Empty)
            {
                //if the startkit id is an empty GUID then it means the user has decided not to install one
                // so we&#39;ll just exit
                return null;
            }

            var result = DownloadPackageFiles(starterKitId.Value);

            return new InstallSetupResult(new Dictionary&lt;string, object&gt;
            {
                {&quot;manifestId&quot;, result.Item2},
                {&quot;packageFile&quot;, result.Item1}
            });
        }

        private Tuple&lt;string, int&gt; DownloadPackageFiles(Guid kitGuid)
        {
            var repo = global::umbraco.cms.businesslogic.packager.repositories.Repository.getByGuid(RepoGuid);
            if (repo == null)
            {
                throw new InstallException(&quot;No repository found with id &quot; + RepoGuid);
            }
            if (repo.HasConnection() == false)
            {
                throw new InstallException(&quot;Cannot connect to repository&quot;);
            }
            var installer = new Installer();

            var tempFile = installer.Import(repo.fetch(kitGuid.ToString()));
            installer.LoadConfig(tempFile);
            var pId = installer.CreateManifest(tempFile, kitGuid.ToString(), RepoGuid);

            InstallPackageFiles(pId, tempFile);

            return new Tuple&lt;string, int&gt;(tempFile, pId);
        }

        private void InstallPackageFiles(int manifestId, string packageFile)
        {
            packageFile = HttpUtility.UrlDecode(packageFile);
            var installer = new Installer();
            installer.LoadConfig(packageFile);
            installer.InstallFiles(manifestId, packageFile);

        }

        public override string View
        {
            get { return (InstalledPackage.GetAllInstalledPackages().Count &gt; 0) ? string.Empty : base.View; }
        }

        public override bool RequiresExecution(Guid? model)
        {
            //Don&#39;t execute if it&#39;s an empty GUID - meaning the user has chosen not to install one
            if (model.HasValue &amp;&amp; model.Value == Guid.Empty)
            {
                return false;
            }

            if (InstalledPackage.GetAllInstalledPackages().Count &gt; 0)
                return false;

            if (_applicationContext.Services.ContentService.GetRootContent().Any())
                return false;

            return true;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,77,0],[18,9,18,10,0],[19,13,19,54,0],[20,9,20,10,0],[25,9,25,10,0],[27,13,27,48,0],[28,13,28,14,0],[29,17,29,79,0],[30,17,30,83,0],[31,17,31,41,0],[32,21,32,51,0],[34,21,34,33,0],[35,13,35,14,0],[36,18,36,55,0],[37,13,37,14,0],[40,17,40,29,0],[43,13,43,67,0],[45,13,49,16,0],[50,9,50,10,0],[53,9,53,10,0],[54,13,54,111,0],[55,13,55,30,0],[56,13,56,14,0],[57,17,57,87,0],[59,13,59,47,0],[60,13,60,14,0],[61,17,61,76,0],[63,13,63,45,0],[65,13,65,77,0],[66,13,66,44,0],[67,13,67,88,0],[69,13,69,48,0],[71,13,71,58,0],[72,9,72,10,0],[75,9,75,10,0],[76,13,76,62,0],[77,13,77,45,0],[78,13,78,47,0],[79,13,79,61,0],[81,9,81,10,0],[85,17,85,18,0],[85,19,85,108,0],[85,109,85,110,0],[89,9,89,10,0],[91,13,91,61,0],[92,13,92,14,0],[93,17,93,30,0],[96,13,96,70,0],[97,17,97,30,0],[99,13,99,84,0],[100,17,100,30,0],[102,13,102,25,0],[103,9,103,10,0]]);
    </script>
  </body>
</html>