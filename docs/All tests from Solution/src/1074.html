<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\RedirectToUmbracoPageResult.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Specialized;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using Umbraco.Core;
using Umbraco.Core.Models;

namespace Umbraco.Web.Mvc
{
    /// &lt;summary&gt;
	/// Redirects to an Umbraco page by Id or Entity
	/// &lt;/summary&gt;
	public class RedirectToUmbracoPageResult : ActionResult
	{
		private IPublishedContent _publishedContent;
		private readonly int _pageId;
        private NameValueCollection _queryStringValues;
		private readonly UmbracoContext _umbracoContext;
		private string _url;

		public string Url
		{
			get
			{
				if (!_url.IsNullOrWhiteSpace()) return _url;

				if (PublishedContent == null)
				{
					throw new InvalidOperationException(string.Format(&quot;Cannot redirect, no entity was found for id {0}&quot;, _pageId));
				}

				var result = _umbracoContext.RoutingContext.UrlProvider.GetUrl(PublishedContent.Id);
				if (result != &quot;#&quot;)
				{
					_url = result;
					return _url;
				}

				throw new InvalidOperationException(string.Format(&quot;Could not route to entity with id {0}, the NiceUrlProvider could not generate a URL&quot;, _pageId));

			}
		}

        public int PageId
        {
            get { return _pageId; }
        }

		public IPublishedContent PublishedContent
		{
			get
			{
				if (_publishedContent != null) return _publishedContent;

				//need to get the URL for the page
			    _publishedContent = UmbracoContext.Current.ContentCache.GetById(_pageId);

				return _publishedContent;
			}
		}

		/// &lt;summary&gt;
		/// Creates a new RedirectToUmbracoResult
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
		public RedirectToUmbracoPageResult(int pageId)
			: this(pageId, UmbracoContext.Current)
		{
		}

        /// &lt;summary&gt;
        /// Creates a new RedirectToUmbracoResult
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        public RedirectToUmbracoPageResult(int pageId, NameValueCollection queryStringValues)
            : this(pageId, queryStringValues, UmbracoContext.Current)
        {
        }

        /// &lt;summary&gt;
        /// Creates a new RedirectToUmbracoResult
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryString&quot;&gt;&lt;/param&gt;
        public RedirectToUmbracoPageResult(int pageId, string queryString)
            : this(pageId, queryString, UmbracoContext.Current)
        {
        }

		/// &lt;summary&gt;
		/// Creates a new RedirectToUmbracoResult
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;publishedContent&quot;&gt;&lt;/param&gt;
		public RedirectToUmbracoPageResult(IPublishedContent publishedContent)
			: this(publishedContent, UmbracoContext.Current)
		{
		}

        /// &lt;summary&gt;
        /// Creates a new RedirectToUmbracoResult
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;publishedContent&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        public RedirectToUmbracoPageResult(IPublishedContent publishedContent, NameValueCollection queryStringValues)
            : this(publishedContent, queryStringValues, UmbracoContext.Current)
        {
        }

        /// &lt;summary&gt;
        /// Creates a new RedirectToUmbracoResult
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;queryString&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        public RedirectToUmbracoPageResult(IPublishedContent publishedContent, string queryString)
            : this(publishedContent, queryString, UmbracoContext.Current)
        {
        }

		/// &lt;summary&gt;
		/// Creates a new RedirectToUmbracoResult
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
		public RedirectToUmbracoPageResult(int pageId, UmbracoContext umbracoContext)
		{
			_pageId = pageId;
			_umbracoContext = umbracoContext;
		}

        /// &lt;summary&gt;
        /// Creates a new RedirectToUmbracoResult
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        public RedirectToUmbracoPageResult(int pageId, NameValueCollection queryStringValues, UmbracoContext umbracoContext)
        {
            _pageId = pageId;
            _queryStringValues = queryStringValues;
            _umbracoContext = umbracoContext;
        }

        /// &lt;summary&gt;
        /// Creates a new RedirectToUmbracoResult
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pageId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryString&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        public RedirectToUmbracoPageResult(int pageId, string queryString, UmbracoContext umbracoContext)
        {
            _pageId = pageId;
            _queryStringValues = ParseQueryString(queryString);
            _umbracoContext = umbracoContext;
        }

		/// &lt;summary&gt;
		/// Creates a new RedirectToUmbracoResult
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;publishedContent&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
		public RedirectToUmbracoPageResult(IPublishedContent publishedContent, UmbracoContext umbracoContext)
		{
			_publishedContent = publishedContent;
			_pageId = publishedContent.Id;
			_umbracoContext = umbracoContext;
		}

        /// &lt;summary&gt;
        /// Creates a new RedirectToUmbracoResult
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;publishedContent&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryStringValues&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        public RedirectToUmbracoPageResult(IPublishedContent publishedContent, NameValueCollection queryStringValues, UmbracoContext umbracoContext)
        {
            _publishedContent = publishedContent;
            _pageId = publishedContent.Id;
            _queryStringValues = queryStringValues;
            _umbracoContext = umbracoContext;
        }

        /// &lt;summary&gt;
        /// Creates a new RedirectToUmbracoResult
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;publishedContent&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;queryString&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt;&lt;/param&gt;
        public RedirectToUmbracoPageResult(IPublishedContent publishedContent, string queryString, UmbracoContext umbracoContext)
        {
            _publishedContent = publishedContent;
            _pageId = publishedContent.Id;
            _queryStringValues = ParseQueryString(queryString);
            _umbracoContext = umbracoContext;
        }

		public override void ExecuteResult(ControllerContext context)
		{
			if (context == null) throw new ArgumentNullException(&quot;context&quot;);

			if (context.IsChildAction)
			{
				throw new InvalidOperationException(&quot;Cannot redirect from a Child Action&quot;);
			}

			var destinationUrl = UrlHelper.GenerateContentUrl(Url, context.HttpContext);

            if (_queryStringValues != null &amp;&amp; _queryStringValues.Count &gt; 0)
            {
                destinationUrl = destinationUrl += &quot;?&quot; + string.Join(&quot;&amp;&quot;,
                    _queryStringValues.AllKeys.Select(x =&gt; x + &quot;=&quot; + HttpUtility.UrlEncode(_queryStringValues[x])));
            }

			context.Controller.TempData.Keep();

			context.HttpContext.Response.Redirect(destinationUrl, endResponse: false);
		}

        private NameValueCollection ParseQueryString(string queryString)
        {
            if (!string.IsNullOrEmpty(queryString))
            {
                return HttpUtility.ParseQueryString(queryString);
            }

            return null;
        }
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,4,25,5,0],[26,5,26,36,0],[26,37,26,49,0],[28,5,28,34,0],[29,5,29,6,0],[30,6,30,117,0],[33,5,33,89,0],[34,5,34,23,0],[35,5,35,6,0],[36,6,36,20,0],[37,6,37,18,0],[40,5,40,152,0],[42,4,42,5,0],[47,17,47,18,0],[47,19,47,34,0],[47,35,47,36,0],[53,4,53,5,0],[54,5,54,35,0],[54,36,54,61,0],[57,8,57,81,0],[59,5,59,30,0],[60,4,60,5,0],[68,6,68,42,0],[69,3,69,4,0],[70,3,70,4,0],[78,15,78,70,0],[79,9,79,10,0],[80,9,80,10,0],[88,15,88,64,0],[89,9,89,10,0],[90,9,90,10,0],[97,6,97,52,0],[98,3,98,4,0],[99,3,99,4,0],[107,15,107,80,0],[108,9,108,10,0],[109,9,109,10,0],[117,15,117,74,0],[118,9,118,10,0],[119,9,119,10,0],[126,3,126,80,0],[127,3,127,4,0],[128,4,128,21,0],[129,4,129,37,0],[130,3,130,4,0],[138,9,138,125,0],[139,9,139,10,0],[140,13,140,30,0],[141,13,141,52,0],[142,13,142,46,0],[143,9,143,10,0],[151,9,151,106,0],[152,9,152,10,0],[153,13,153,30,0],[154,13,154,64,0],[155,13,155,46,0],[156,9,156,10,0],[163,3,163,104,0],[164,3,164,4,0],[165,4,165,41,0],[166,4,166,34,0],[167,4,167,37,0],[168,3,168,4,0],[176,9,176,149,0],[177,9,177,10,0],[178,13,178,50,0],[179,13,179,43,0],[180,13,180,52,0],[181,13,181,46,0],[182,9,182,10,0],[190,9,190,130,0],[191,9,191,10,0],[192,13,192,50,0],[193,13,193,43,0],[194,13,194,64,0],[195,13,195,46,0],[196,9,196,10,0],[199,3,199,4,0],[200,4,200,24,0],[200,25,200,68,0],[202,4,202,30,0],[203,4,203,5,0],[204,5,204,80,0],[207,4,207,80,0],[209,13,209,76,0],[210,13,210,14,0],[211,17,212,60,0],[212,60,212,114,0],[212,114,212,117,0],[211,17,212,117,0],[213,13,213,14,0],[215,4,215,39,0],[217,4,217,78,0],[218,3,218,4,0],[221,9,221,10,0],[222,13,222,52,0],[223,13,223,14,0],[224,17,224,66,0],[227,13,227,25,0],[228,9,228,10,0]]);
    </script>
  </body>
</html>