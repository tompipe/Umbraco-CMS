<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\InstallSteps\DatabaseUpgradeStep.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Web.Install.Models;

namespace Umbraco.Web.Install.InstallSteps
{
    [InstallSetupStep(InstallationType.Upgrade | InstallationType.NewInstall,
        &quot;DatabaseUpgrade&quot;, 12, &quot;&quot;)]
    internal class DatabaseUpgradeStep : InstallSetupStep&lt;object&gt;
    {
        private readonly ApplicationContext _applicationContext;
        
        public DatabaseUpgradeStep(ApplicationContext applicationContext)
        {
            _applicationContext = applicationContext;
        }

        public override InstallSetupResult Execute(object model)
        {
            var installSteps = InstallStatusTracker.GetStatus().ToArray();            
            var previousStep = installSteps.Single(x =&gt; x.Name == &quot;DatabaseInstall&quot;);
            var upgrade = previousStep.AdditionalData.ContainsKey(&quot;upgrade&quot;);

            if (upgrade)
            {
                LogHelper.Info&lt;DatabaseUpgradeStep&gt;(&quot;Running &#39;Upgrade&#39; service&quot;);

                var result = _applicationContext.DatabaseContext.UpgradeSchemaAndData(_applicationContext.Services.MigrationEntryService);

                if (result.Success == false)
                {
                    throw new InstallException(&quot;The database failed to upgrade. ERROR: &quot; + result.Message);
                }

                DatabaseInstallStep.HandleConnectionStrings();
            }

            return null;
        }

        public override bool RequiresExecution(object model)
        {
            //if it&#39;s properly configured (i.e. the versions match) then no upgrade necessary
            if (_applicationContext.IsConfigured)
            {
                return false;
            }

            var installSteps = InstallStatusTracker.GetStatus().ToArray();
            //this step relies on the previous one completed - because it has stored some information we need
            if (installSteps.Any(x =&gt; x.Name == &quot;DatabaseInstall&quot; &amp;&amp; x.AdditionalData.ContainsKey(&quot;upgrade&quot;)) == false)
            {
                return false;
            }
            
            var databaseSettings = ConfigurationManager.ConnectionStrings[GlobalSettings.UmbracoConnectionName];

            if (_applicationContext.DatabaseContext.IsConnectionStringConfigured(databaseSettings))
            {
                //Since a connection string was present we verify whether this is an upgrade or an empty db
                var result = _applicationContext.DatabaseContext.ValidateDatabaseSchema();

                var determinedVersion = result.DetermineInstalledVersion();
                if (determinedVersion.Equals(new Version(0, 0, 0)))
                {
                    //Fresh install
                    return false;
                }

                //Upgrade
                return true;
            }

            //no connection string configured, probably a fresh install
            return false;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,74,0],[19,9,19,10,0],[20,13,20,54,0],[21,9,21,10,0],[24,9,24,10,0],[25,13,25,75,0],[26,13,26,57,0],[26,57,26,84,0],[26,84,26,86,0],[26,13,26,86,0],[27,13,27,78,0],[29,13,29,25,0],[30,13,30,14,0],[31,17,31,82,0],[33,17,33,139,0],[35,17,35,45,0],[36,17,36,18,0],[37,21,37,108,0],[40,17,40,63,0],[41,13,41,14,0],[43,13,43,25,0],[44,9,44,10,0],[47,9,47,10,0],[49,13,49,50,0],[50,13,50,14,0],[51,17,51,30,0],[54,13,54,75,0],[56,13,56,39,0],[56,39,56,109,0],[56,109,56,120,0],[56,13,56,120,0],[57,13,57,14,0],[58,17,58,30,0],[61,13,61,113,0],[63,13,63,100,0],[64,13,64,14,0],[66,17,66,91,0],[68,17,68,76,0],[69,17,69,68,0],[70,17,70,18,0],[72,21,72,34,0],[76,17,76,29,0],[80,13,80,26,0],[81,9,81,10,0]]);
    </script>
  </body>
</html>