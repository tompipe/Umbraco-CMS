<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UI\LegacyDialogTask.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Authentication;
using System.Text;
using Umbraco.Core;
using umbraco.BusinessLogic;
using umbraco.businesslogic.Exceptions;
using umbraco.interfaces;

namespace Umbraco.Web.UI
{
    /// &lt;summary&gt;
    /// An abstract class that is used to implement all secure ITasks
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// In the near future we will overhaul how create dialogs work and how deletions work as well. In the meantime 
    /// if you ever need to create an ITask you should just inherit from this class and do not manually implement 
    /// ITask or ITaskReturnUrl. If you do, you MUST also implement IAppTask which associates an ITask to an app
    /// so we can validate the current user&#39;s security with the implementation. If you do not do this then your 
    /// implementation will not be secure. It means that if someone is logged in and doesn&#39;t have access to a 
    /// specific app, they&#39;d still be able to execute code to create/delete for any ITask regardless of what app 
    /// they have access to.
    /// &lt;/remarks&gt;
    [Obsolete(&quot;ITask is used for legacy webforms back office editors, change to using the v7 angular approach&quot;)]
    public abstract class LegacyDialogTask : ITaskReturnUrl, IAssignedApp
    {
        public virtual int ParentID { get; set; }
        public int TypeID { get; set; }
        public string Alias { get; set; }
        
        /// &lt;summary&gt;
        /// Base class first performs authentication for the current app before proceeding
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool Save()
        {
            if (ValidateUserForApplication())
            {
                return PerformSave();                
            }
            throw new AuthenticationException(&quot;The current user does not have access to the required application that this task belongs to&quot;);
        }

        public abstract bool PerformSave();

        /// &lt;summary&gt;
        /// Base class first performs authentication for the current app before proceeding
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool Delete()
        {
            if (ValidateUserForApplication())
            {
                return PerformDelete();
            }
            throw new AuthenticationException(&quot;The current user does not have access to the required application that this task belongs to&quot;);
        }

        public abstract bool PerformDelete();

        /// &lt;summary&gt;
        /// Gets/sets the user object for this Task
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// accessible by inheritors but can only be set internally
        /// &lt;/remarks&gt;
        protected internal User User { get; internal set; }

        /// &lt;summary&gt;
        /// Implemented explicitly as we don&#39;t want to expose this
        /// &lt;/summary&gt;
        int ITask.UserId
        {
            set { User = User.GetUser(value); }
        }

        /// &lt;summary&gt;
        /// Checks if the currently assigned user has access to the assigned app
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected internal bool ValidateUserForApplication()
        {
            if (User == null)
                throw new InvalidOperationException(&quot;Cannot authenticate, no User object assigned&quot;);

            return User.Applications.Any(app =&gt; app.alias.InvariantEquals(AssignedApp));
        }

        public abstract string ReturnUrl { get; }
        public abstract string AssignedApp { get; }

        public IDictionary&lt;string, object&gt; AdditionalValues { get; set; }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,39,28,43,0],[28,44,28,48,0],[29,29,29,33,0],[29,34,29,38,0],[30,31,30,35,0],[30,36,30,40,0],[37,9,37,10,0],[38,13,38,46,0],[39,13,39,14,0],[40,17,40,38,0],[42,13,42,142,0],[43,9,43,10,0],[52,9,52,10,0],[53,13,53,46,0],[54,13,54,14,0],[55,17,55,40,0],[57,13,57,142,0],[58,9,58,10,0],[68,40,68,44,0],[68,45,68,58,0],[75,17,75,18,0],[75,19,75,46,0],[75,47,75,48,0],[83,9,83,10,0],[84,13,84,30,0],[85,17,85,101,0],[87,13,87,49,0],[87,49,87,87,0],[87,87,87,89,0],[87,13,87,89,0],[88,9,88,10,0],[93,63,93,67,0],[93,68,93,72,0]]);
    </script>
  </body>
</html>