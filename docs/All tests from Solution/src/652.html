<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\Trees\FileSystemTree.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Configuration;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using System.IO;
using Umbraco.Core.IO;

namespace umbraco.cms.presentation.Trees
{
    public abstract class FileSystemTree : BaseTree
    {

        public FileSystemTree(string application) : base(application) { }

        public override abstract void RenderJS(ref System.Text.StringBuilder Javascript);
        protected override abstract void CreateRootNode(ref XmlTreeNode rootNode);

        protected abstract string FilePath { get; }
        protected abstract string FileSearchPattern { get; }

        /// &lt;summary&gt;
        /// Inheritors can override this method to modify the file node that is created.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xNode&quot;&gt;&lt;/param&gt;
        protected virtual void OnRenderFileNode(ref XmlTreeNode xNode) { }

        /// &lt;summary&gt;
        /// Inheritors can override this method to modify the folder node that is created.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xNode&quot;&gt;&lt;/param&gt;
        protected virtual void OnRenderFolderNode(ref XmlTreeNode xNode) { }

        public override void Render(ref XmlTree tree)
        {
            string orgPath = &quot;&quot;;
            string path = &quot;&quot;;
            if (!string.IsNullOrEmpty(this.NodeKey))
            {
                orgPath = this.NodeKey;
                path = IOHelper.MapPath(FilePath + orgPath);
                orgPath += &quot;/&quot;;
            }
            else
            {
                path = IOHelper.MapPath(FilePath);
            }

            DirectoryInfo dirInfo = new DirectoryInfo(path);


            DirectoryInfo[] dirInfos = dirInfo.Exists ? dirInfo.GetDirectories() : new DirectoryInfo[] { };

            var args = new TreeEventArgs(tree);
            OnBeforeTreeRender(dirInfo, args);

            foreach (DirectoryInfo dir in dirInfos)
            {
                if ((dir.Attributes &amp; FileAttributes.Hidden) == 0)
                {
                    XmlTreeNode xDirNode = XmlTreeNode.Create(this);
                    xDirNode.NodeID = orgPath + dir.Name;
                    xDirNode.Menu.Clear();
                    xDirNode.Text = dir.Name;
                    xDirNode.Action = string.Empty;
                    xDirNode.Source = GetTreeServiceUrl(orgPath + dir.Name);
                    xDirNode.Icon = FolderIcon;
                    xDirNode.OpenIcon = FolderIconOpen;
                    xDirNode.HasChildren = dir.GetFiles().Length &gt; 0 || dir.GetDirectories().Length &gt; 0;

                    OnRenderFolderNode(ref xDirNode);
                    OnBeforeNodeRender(ref tree, ref xDirNode, EventArgs.Empty);
                    if (xDirNode != null)
                    {
                        tree.Add(xDirNode);
                        OnAfterNodeRender(ref tree, ref xDirNode, EventArgs.Empty);
                    }


                }
            }

            //this is a hack to enable file system tree to support multiple file extension look-up
            //so the pattern both support *.* *.xml and xml,js,vb for lookups
            string[] allowedExtensions = new string[0];
            bool filterByMultipleExtensions = FileSearchPattern.Contains(&quot;,&quot;);
            FileInfo[] fileInfo;

            if (filterByMultipleExtensions)
            {
                fileInfo = dirInfo.Exists ? dirInfo.GetFiles() : new FileInfo[] {};
                allowedExtensions = FileSearchPattern.ToLower().Split(&#39;,&#39;);
            }
            else
            {
                fileInfo = dirInfo.Exists ? dirInfo.GetFiles(FileSearchPattern) : new FileInfo[] { };
            }

            foreach (FileInfo file in fileInfo)
            {
                if ((file.Attributes &amp; FileAttributes.Hidden) == 0)
                {
                    if (filterByMultipleExtensions &amp;&amp; Array.IndexOf&lt;string&gt;(allowedExtensions, file.Extension.ToLower().Trim(&#39;.&#39;)) &lt; 0)
                        continue;

                    XmlTreeNode xFileNode = XmlTreeNode.Create(this);
                    xFileNode.NodeID = orgPath + file.Name;
                    xFileNode.Text = file.Name;
                    if (!((orgPath == &quot;&quot;)))
                        xFileNode.Action = &quot;javascript:openFile(&#39;&quot; + orgPath + file.Name + &quot;&#39;);&quot;;
                    else
                        xFileNode.Action = &quot;javascript:openFile(&#39;&quot; + file.Name + &quot;&#39;);&quot;;
                    xFileNode.Icon = &quot;doc.gif&quot;;
                    xFileNode.OpenIcon = &quot;doc.gif&quot;;

                    OnRenderFileNode(ref xFileNode);
                    OnBeforeNodeRender(ref tree, ref xFileNode, EventArgs.Empty);
                    if (xFileNode != null)
                    {
                        tree.Add(xFileNode);
                        OnAfterNodeRender(ref tree, ref xFileNode, EventArgs.Empty);
                    }


                }
            }
            OnAfterTreeRender(dirInfo, args);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,53,18,70,0],[18,71,18,72,0],[18,73,18,74,0],[30,72,30,73,0],[30,74,30,75,0],[36,74,36,75,0],[36,76,36,77,0],[39,9,39,10,0],[40,13,40,33,0],[41,13,41,30,0],[42,13,42,53,0],[43,13,43,14,0],[44,17,44,40,0],[45,17,45,61,0],[46,17,46,32,0],[47,13,47,14,0],[49,13,49,14,0],[50,17,50,51,0],[51,13,51,14,0],[53,13,53,61,0],[56,13,56,108,0],[58,13,58,48,0],[59,13,59,47,0],[61,13,61,20,0],[61,22,61,39,0],[61,40,61,42,0],[61,43,61,51,0],[62,13,62,14,0],[63,17,63,67,0],[64,17,64,18,0],[65,21,65,69,0],[66,21,66,58,0],[67,21,67,43,0],[68,21,68,46,0],[69,21,69,52,0],[70,21,70,77,0],[71,21,71,48,0],[72,21,72,56,0],[73,21,73,105,0],[75,21,75,54,0],[76,21,76,81,0],[77,21,77,42,0],[78,21,78,22,0],[79,25,79,44,0],[80,25,80,84,0],[81,21,81,22,0],[84,17,84,18,0],[85,13,85,14,0],[89,13,89,56,0],[90,13,90,79,0],[93,13,93,44,0],[94,13,94,14,0],[95,17,95,84,0],[96,17,96,76,0],[97,13,97,14,0],[99,13,99,14,0],[100,17,100,102,0],[101,13,101,14,0],[103,13,103,20,0],[103,22,103,35,0],[103,36,103,38,0],[103,39,103,47,0],[104,13,104,14,0],[105,17,105,68,0],[106,17,106,18,0],[107,21,107,136,0],[108,25,108,34,0],[110,21,110,70,0],[111,21,111,60,0],[112,21,112,48,0],[113,21,113,44,0],[114,25,114,98,0],[116,25,116,88,0],[117,21,117,48,0],[118,21,118,52,0],[120,21,120,53,0],[121,21,121,82,0],[122,21,122,43,0],[123,21,123,22,0],[124,25,124,45,0],[125,25,125,85,0],[126,21,126,22,0],[129,17,129,18,0],[130,13,130,14,0],[131,13,131,46,0],[132,9,132,10,0]]);
    </script>
  </body>
</html>