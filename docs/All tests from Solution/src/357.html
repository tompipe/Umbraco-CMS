<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\PartialViewRepositoryTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NUnit.Framework;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [TestFixture]
    public class PartialViewRepositoryTests : BaseUmbracoApplicationTest
    {
        private IFileSystem _fileSystem;

        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            _fileSystem = new PhysicalFileSystem(SystemDirectories.MvcViews + &quot;/Partials/&quot;);
        }

        [Test]
        public void PathTests()
        {
            // unless noted otherwise, no changes / 7.2.8

            var provider = new FileUnitOfWorkProvider();
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new PartialViewRepository(unitOfWork, _fileSystem);

            var partialView = new PartialView(&quot;test-path-1.cshtml&quot;) { Content = &quot;// partialView&quot; };
            repository.AddOrUpdate(partialView);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;test-path-1.cshtml&quot;));
            Assert.AreEqual(&quot;test-path-1.cshtml&quot;, partialView.Path);
            Assert.AreEqual(&quot;/Views/Partials/test-path-1.cshtml&quot;, partialView.VirtualPath);

            partialView = new PartialView(&quot;path-2/test-path-2.cshtml&quot;) { Content = &quot;// partialView&quot; };
            repository.AddOrUpdate(partialView);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;path-2/test-path-2.cshtml&quot;));
            Assert.AreEqual(&quot;path-2\\test-path-2.cshtml&quot;, partialView.Path); // fixed in 7.3 - 7.2.8 does not update the path
            Assert.AreEqual(&quot;/Views/Partials/path-2/test-path-2.cshtml&quot;, partialView.VirtualPath);

            partialView = (PartialView) repository.Get(&quot;path-2/test-path-2.cshtml&quot;);
            Assert.IsNotNull(partialView);
            Assert.AreEqual(&quot;path-2\\test-path-2.cshtml&quot;, partialView.Path);
            Assert.AreEqual(&quot;/Views/Partials/path-2/test-path-2.cshtml&quot;, partialView.VirtualPath);

            partialView = new PartialView(&quot;path-2\\test-path-3.cshtml&quot;) { Content = &quot;// partialView&quot; };
            repository.AddOrUpdate(partialView);
            unitOfWork.Commit();
            Assert.IsTrue(_fileSystem.FileExists(&quot;path-2/test-path-3.cshtml&quot;));
            Assert.AreEqual(&quot;path-2\\test-path-3.cshtml&quot;, partialView.Path);
            Assert.AreEqual(&quot;/Views/Partials/path-2/test-path-3.cshtml&quot;, partialView.VirtualPath);

            partialView = (PartialView) repository.Get(&quot;path-2/test-path-3.cshtml&quot;);
            Assert.IsNotNull(partialView);
            Assert.AreEqual(&quot;path-2\\test-path-3.cshtml&quot;, partialView.Path);
            Assert.AreEqual(&quot;/Views/Partials/path-2/test-path-3.cshtml&quot;, partialView.VirtualPath);

            partialView = (PartialView) repository.Get(&quot;path-2\\test-path-3.cshtml&quot;);
            Assert.IsNotNull(partialView);
            Assert.AreEqual(&quot;path-2\\test-path-3.cshtml&quot;, partialView.Path);
            Assert.AreEqual(&quot;/Views/Partials/path-2/test-path-3.cshtml&quot;, partialView.VirtualPath);

            partialView = new PartialView(&quot;\\test-path-4.cshtml&quot;) { Content = &quot;// partialView&quot; };
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt; // fixed in 7.3 - 7.2.8 used to strip the \
            {
                repository.AddOrUpdate(partialView);
            });

            partialView = (PartialView) repository.Get(&quot;missing.cshtml&quot;);
            Assert.IsNull(partialView);

            // fixed in 7.3 - 7.2.8 used to...
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt;
            {
                partialView = (PartialView) repository.Get(&quot;\\test-path-4.cshtml&quot;); // outside the filesystem, does not exist
            });
            Assert.Throws&lt;FileSecurityException&gt;(() =&gt;
            {
                partialView = (PartialView) repository.Get(&quot;../../packages.config&quot;); // outside the filesystem, exists
            });
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();

            //Delete all files
            Purge((PhysicalFileSystem)_fileSystem, &quot;&quot;);
            _fileSystem = null;
        }

        private void Purge(PhysicalFileSystem fs, string path)
        {
            var files = fs.GetFiles(path, &quot;*.cshtml&quot;);
            foreach (var file in files)
            {
                fs.DeleteFile(file);
            }
            var dirs = fs.GetDirectories(path);
            foreach (var dir in dirs)
            {
                Purge(fs, dir);
                fs.DeleteDirectory(dir);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,1],[24,13,24,31,1],[26,13,26,93,1],[27,9,27,10,1],[31,9,31,10,1],[34,13,34,57,1],[35,13,35,55,1],[36,13,36,81,1],[38,13,38,100,1],[39,13,39,49,1],[40,13,40,33,1],[41,13,41,73,1],[42,13,42,69,1],[43,13,43,92,1],[45,13,45,103,1],[46,13,46,49,1],[47,13,47,33,1],[48,13,48,80,1],[49,13,49,77,1],[50,13,50,99,1],[52,13,52,85,1],[53,13,53,43,1],[54,13,54,77,1],[55,13,55,99,1],[57,13,57,104,1],[58,13,58,49,1],[59,13,59,33,1],[60,13,60,80,1],[61,13,61,77,1],[62,13,62,99,1],[64,13,64,85,1],[65,13,65,43,1],[66,13,66,77,1],[67,13,67,99,1],[69,13,69,86,1],[70,13,70,43,1],[71,13,71,77,1],[72,13,72,99,1],[74,13,74,98,1],[75,13,76,13,1],[76,13,76,14,1],[76,14,77,17,1],[77,17,77,53,1],[77,53,78,13,1],[78,13,78,14,0],[78,14,78,16,1],[75,13,78,16,1],[80,13,80,74,1],[81,13,81,40,1],[84,13,85,13,1],[85,13,85,14,1],[85,14,86,17,1],[86,17,86,84,1],[86,84,87,13,1],[87,13,87,14,0],[87,14,87,16,1],[84,13,87,16,1],[88,13,89,13,1],[89,13,89,14,1],[89,14,90,17,1],[90,17,90,85,1],[90,85,91,13,1],[91,13,91,14,0],[91,14,91,16,1],[88,13,91,16,1],[92,9,92,10,1],[96,9,96,10,1],[97,13,97,29,1],[100,13,100,56,1],[101,13,101,32,1],[102,9,102,10,1],[105,9,105,10,1],[106,13,106,55,1],[107,13,107,20,1],[107,22,107,30,1],[107,31,107,33,1],[107,34,107,39,1],[108,13,108,14,1],[109,17,109,37,1],[110,13,110,14,1],[111,13,111,48,1],[112,13,112,20,1],[112,22,112,29,1],[112,30,112,32,1],[112,33,112,37,1],[113,13,113,14,1],[114,17,114,32,1],[115,17,115,41,1],[116,13,116,14,1],[117,9,117,10,1]]);
    </script>
  </body>
</html>