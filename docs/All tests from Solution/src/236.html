<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Cache\FullDataSetCachePolicyTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Web.Caching;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Cache;
using Umbraco.Core.Collections;
using Umbraco.Core.Models;

namespace Umbraco.Tests.Cache
{
    [TestFixture]
    public class FullDataSetCachePolicyTests
    {
        [Test]
        public void Caches_Single()
        {
            var getAll = new[]
            {
                new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123),
                new AuditItem(2, &quot;blah2&quot;, AuditType.Copy, 123)
            };

            var isCached = false;
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.InsertCacheItem(It.IsAny&lt;string&gt;(), It.IsAny&lt;Func&lt;object&gt;&gt;(), It.IsAny&lt;TimeSpan?&gt;(), It.IsAny&lt;bool&gt;(),
                It.IsAny&lt;CacheItemPriority&gt;(), It.IsAny&lt;CacheItemRemovedCallback&gt;(), It.IsAny&lt;string[]&gt;()))
                .Callback(() =&gt;
                {
                    isCached = true;
                });

            var defaultPolicy = new FullDataSetRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, item =&gt; item.Id, () =&gt; getAll, false);
            using (defaultPolicy)
            {
                var found = defaultPolicy.Get(1, o =&gt; new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123));
            }
            Assert.IsTrue(isCached);
        }

        [Test]
        public void Get_Single_From_Cache()
        {
            var getAll = new[]
            {
                new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123),
                new AuditItem(2, &quot;blah2&quot;, AuditType.Copy, 123)
            };

            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.GetCacheItem(It.IsAny&lt;string&gt;())).Returns(new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123));

            var defaultPolicy = new FullDataSetRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, item =&gt; item.Id, () =&gt; getAll, false);
            using (defaultPolicy)
            {
                var found = defaultPolicy.Get(1, o =&gt; (AuditItem)null);
                Assert.IsNotNull(found);
            }
        }

        [Test]
        public void Get_All_Caches_Empty_List()
        {
            var getAll = new AuditItem[] {};

            var cached = new List&lt;string&gt;();
            
            IList list = null;

            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.InsertCacheItem(It.IsAny&lt;string&gt;(), It.IsAny&lt;Func&lt;object&gt;&gt;(), It.IsAny&lt;TimeSpan?&gt;(), It.IsAny&lt;bool&gt;(),
                It.IsAny&lt;CacheItemPriority&gt;(), It.IsAny&lt;CacheItemRemovedCallback&gt;(), It.IsAny&lt;string[]&gt;()))
                .Callback((string cacheKey, Func&lt;object&gt; o, TimeSpan? t, bool b, CacheItemPriority cip, CacheItemRemovedCallback circ, string[] s) =&gt;
                {
                    cached.Add(cacheKey);

                    list = o() as IList;
                });
            cache.Setup(x =&gt; x.GetCacheItem(It.IsAny&lt;string&gt;())).Returns(() =&gt;
            {
                //return null if this is the first pass
                return cached.Any() ? new DeepCloneableList&lt;AuditItem&gt;(ListCloneBehavior.CloneOnce) : null;
            });

            var defaultPolicy = new FullDataSetRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, item =&gt; item.Id, () =&gt; getAll, false);
            using (defaultPolicy)
            {
                var found = defaultPolicy.GetAll(new object[] {}, o =&gt; getAll);
            }

            Assert.AreEqual(1, cached.Count);
            Assert.IsNotNull(list);

            //Do it again, ensure that its coming from the cache!
            defaultPolicy = new FullDataSetRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, item =&gt; item.Id, () =&gt; getAll, false);
            using (defaultPolicy)
            {
                var found = defaultPolicy.GetAll(new object[] { }, o =&gt; getAll);
            }

            Assert.AreEqual(1, cached.Count);
            Assert.IsNotNull(list);
        }

        [Test]
        public void Get_All_Caches_As_Single_List()
        {
            var getAll = new[]
            {
                new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123),
                new AuditItem(2, &quot;blah2&quot;, AuditType.Copy, 123)
            };

            var cached = new List&lt;string&gt;();
            IList list = null;

            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.InsertCacheItem(It.IsAny&lt;string&gt;(), It.IsAny&lt;Func&lt;object&gt;&gt;(), It.IsAny&lt;TimeSpan?&gt;(), It.IsAny&lt;bool&gt;(),
                It.IsAny&lt;CacheItemPriority&gt;(), It.IsAny&lt;CacheItemRemovedCallback&gt;(), It.IsAny&lt;string[]&gt;()))
                .Callback((string cacheKey, Func&lt;object&gt; o, TimeSpan? t, bool b, CacheItemPriority cip, CacheItemRemovedCallback circ, string[] s) =&gt;
                {
                    cached.Add(cacheKey);

                    list = o() as IList;
                });
            cache.Setup(x =&gt; x.GetCacheItem(It.IsAny&lt;string&gt;())).Returns(new AuditItem[] { });

            var defaultPolicy = new FullDataSetRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, item =&gt; item.Id, () =&gt; getAll, false);
            using (defaultPolicy)
            {
                var found = defaultPolicy.GetAll(new object[] { }, o =&gt; getAll);
            }

            Assert.AreEqual(1, cached.Count);
            Assert.IsNotNull(list);
        }

        [Test]
        public void Get_All_Without_Ids_From_Cache()
        {
            var getAll = new[] { (AuditItem)null };

            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();

            cache.Setup(x =&gt; x.GetCacheItem(It.IsAny&lt;string&gt;())).Returns(() =&gt; new DeepCloneableList&lt;AuditItem&gt;(ListCloneBehavior.CloneOnce)
            {
                new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123),
                new AuditItem(2, &quot;blah2&quot;, AuditType.Copy, 123)
            });

            var defaultPolicy = new FullDataSetRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, item =&gt; item.Id, () =&gt; getAll, false);
            using (defaultPolicy)
            {
                var found = defaultPolicy.GetAll(new object[] { }, o =&gt; getAll);
                Assert.AreEqual(2, found.Length);
            }
        }

        [Test]
        public void If_CreateOrUpdate_Throws_Cache_Is_Removed()
        {
            var getAll = new[]
            {
                new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123),
                new AuditItem(2, &quot;blah2&quot;, AuditType.Copy, 123)
            };

            var cacheCleared = false;
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.ClearCacheItem(It.IsAny&lt;string&gt;()))
                .Callback(() =&gt;
                {
                    cacheCleared = true;
                });

            var defaultPolicy = new FullDataSetRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, item =&gt; item.Id, () =&gt; getAll, false);
            try
            {
                using (defaultPolicy)
                {
                    defaultPolicy.CreateOrUpdate(new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123), item =&gt;
                    {
                        throw new Exception(&quot;blah!&quot;);
                    });
                }
            }
            catch
            {
                //we need this catch or nunit throw up
            }
            finally
            {
                Assert.IsTrue(cacheCleared);
            }
        }

        [Test]
        public void If_Removes_Throws_Cache_Is_Removed()
        {
            var getAll = new[]
            {
                new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123),
                new AuditItem(2, &quot;blah2&quot;, AuditType.Copy, 123)
            };

            var cacheCleared = false;
            var cache = new Mock&lt;IRuntimeCacheProvider&gt;();
            cache.Setup(x =&gt; x.ClearCacheItem(It.IsAny&lt;string&gt;()))
                .Callback(() =&gt;
                {
                    cacheCleared = true;
                });

            var defaultPolicy = new FullDataSetRepositoryCachePolicy&lt;AuditItem, object&gt;(cache.Object, item =&gt; item.Id, () =&gt; getAll, false);
            try
            {
                using (defaultPolicy)
                {
                    defaultPolicy.Remove(new AuditItem(1, &quot;blah&quot;, AuditType.Copy, 123), item =&gt;
                    {
                        throw new Exception(&quot;blah!&quot;);
                    });
                }
            }
            catch
            {
                //we need this catch or nunit throw up
            }
            finally
            {
                Assert.IsTrue(cacheCleared);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,10,1],[20,13,24,15,1],[26,13,26,34,1],[27,13,27,59,1],[28,13,31,17,1],[31,17,31,18,1],[31,18,32,21,1],[32,21,32,37,1],[32,37,33,17,1],[33,17,33,18,1],[33,18,33,20,1],[28,13,33,20,1],[35,13,35,111,1],[35,111,35,118,1],[35,118,35,126,1],[35,126,35,132,1],[35,132,35,141,1],[35,13,35,141,1],[36,13,36,34,1],[37,13,37,14,1],[38,17,38,55,1],[38,55,38,100,0],[38,100,38,102,1],[38,17,38,102,1],[39,13,39,14,1],[40,13,40,37,1],[41,9,41,10,1],[45,9,45,10,1],[46,13,50,15,1],[52,13,52,59,1],[53,13,53,121,1],[55,13,55,111,1],[55,111,55,118,1],[55,118,55,126,1],[55,126,55,132,1],[55,132,55,141,1],[55,13,55,141,1],[56,13,56,34,1],[57,13,57,14,1],[58,17,58,55,1],[58,55,58,70,0],[58,70,58,72,1],[58,17,58,72,1],[59,17,59,41,1],[60,13,60,14,1],[61,9,61,10,1],[65,9,65,10,1],[66,13,66,45,1],[68,13,68,45,1],[70,13,70,31,1],[72,13,72,59,1],[73,13,76,17,1],[76,17,76,18,1],[76,18,77,21,1],[77,21,77,42,1],[77,42,79,21,1],[79,21,79,41,1],[79,41,80,17,1],[80,17,80,18,1],[80,18,80,20,1],[73,13,80,20,1],[81,13,82,13,1],[82,13,82,14,1],[82,14,84,17,1],[84,17,84,108,1],[84,108,85,13,1],[85,13,85,14,1],[85,14,85,16,1],[81,13,85,16,1],[87,13,87,111,1],[87,111,87,118,0],[87,118,87,126,1],[87,126,87,132,0],[87,132,87,141,1],[87,13,87,141,1],[88,13,88,34,1],[89,13,89,14,1],[90,17,90,72,1],[90,72,90,78,1],[90,78,90,80,1],[90,17,90,80,1],[91,13,91,14,1],[93,13,93,46,1],[94,13,94,36,1],[97,13,97,107,1],[97,107,97,114,0],[97,114,97,122,1],[97,122,97,128,0],[97,128,97,137,1],[97,13,97,137,1],[98,13,98,34,1],[99,13,99,14,1],[100,17,100,73,1],[100,73,100,79,0],[100,79,100,81,1],[100,17,100,81,1],[101,13,101,14,1],[103,13,103,46,1],[104,13,104,36,1],[105,9,105,10,1],[109,9,109,10,1],[110,13,114,15,1],[116,13,116,45,1],[117,13,117,31,1],[119,13,119,59,1],[120,13,123,17,1],[123,17,123,18,1],[123,18,124,21,1],[124,21,124,42,1],[124,42,126,21,1],[126,21,126,41,1],[126,41,127,17,1],[127,17,127,18,1],[127,18,127,20,1],[120,13,127,20,1],[128,13,128,95,1],[130,13,130,111,1],[130,111,130,118,0],[130,118,130,126,1],[130,126,130,132,0],[130,132,130,141,1],[130,13,130,141,1],[131,13,131,34,1],[132,13,132,14,1],[133,17,133,73,1],[133,73,133,79,1],[133,79,133,81,1],[133,17,133,81,1],[134,13,134,14,1],[136,13,136,46,1],[137,13,137,36,1],[138,9,138,10,1],[142,9,142,10,1],[143,13,143,52,1],[145,13,145,59,1],[147,13,147,80,1],[147,80,151,14,1],[151,14,151,16,1],[147,13,151,16,1],[153,13,153,111,1],[153,111,153,118,0],[153,118,153,126,1],[153,126,153,132,0],[153,132,153,141,1],[153,13,153,141,1],[154,13,154,34,1],[155,13,155,14,1],[156,17,156,73,1],[156,73,156,79,0],[156,79,156,81,1],[156,17,156,81,1],[157,17,157,50,1],[158,13,158,14,1],[159,9,159,10,1],[163,9,163,10,1],[164,13,168,15,1],[170,13,170,38,1],[171,13,171,59,1],[172,13,174,17,1],[174,17,174,18,1],[174,18,175,21,1],[175,21,175,41,1],[175,41,176,17,1],[176,17,176,18,1],[176,18,176,20,1],[172,13,176,20,1],[178,13,178,111,1],[178,111,178,118,0],[178,118,178,126,1],[178,126,178,132,0],[178,132,178,141,1],[178,13,178,141,1],[180,13,180,14,1],[181,17,181,38,1],[182,17,182,18,1],[183,21,184,21,1],[184,21,184,22,1],[184,22,185,25,1],[185,25,185,54,1],[185,54,186,24,1],[183,21,186,24,1],[187,17,187,18,0],[188,13,188,14,0],[189,13,189,18,1],[190,13,190,14,1],[192,13,192,14,1],[194,13,194,14,1],[195,17,195,45,1],[196,13,196,14,1],[197,9,197,10,1],[201,9,201,10,1],[202,13,206,15,1],[208,13,208,38,1],[209,13,209,59,1],[210,13,212,17,1],[212,17,212,18,1],[212,18,213,21,1],[213,21,213,41,1],[213,41,214,17,1],[214,17,214,18,1],[214,18,214,20,1],[210,13,214,20,1],[216,13,216,111,1],[216,111,216,118,0],[216,118,216,126,1],[216,126,216,132,0],[216,132,216,141,1],[216,13,216,141,1],[218,13,218,14,1],[219,17,219,38,1],[220,17,220,18,1],[221,21,222,21,1],[222,21,222,22,1],[222,22,223,25,1],[223,25,223,54,1],[223,54,224,24,1],[221,21,224,24,1],[225,17,225,18,0],[226,13,226,14,0],[227,13,227,18,1],[228,13,228,14,1],[230,13,230,14,1],[232,13,232,14,1],[233,17,233,45,1],[234,13,234,14,1],[235,9,235,10,1]]);
    </script>
  </body>
</html>