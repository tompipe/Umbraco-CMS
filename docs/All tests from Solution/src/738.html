<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebServices\EmbedMediaService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.Script.Serialization;
using System.Xml;
using Umbraco.Core.Configuration;
using Umbraco.Core.Media;
using umbraco.BusinessLogic;
using Umbraco.Web.BaseRest;

namespace Umbraco.Web.WebServices
{
    [RestExtension(&quot;EmbedMediaService&quot;)]
    public class EmbedMediaService
    {
        [RestExtensionMethod(ReturnXml = false)]
        public static string Embed()
        {
            var currentUser = User.GetCurrent();

            if (currentUser == null)
                throw new UnauthorizedAccessException(&quot;You must be logged in to use this service&quot;);
            
            var url = HttpContext.Current.Request.Form[&quot;url&quot;];
            var width = int.Parse(HttpContext.Current.Request.Form[&quot;width&quot;]);
            var height = int.Parse(HttpContext.Current.Request.Form[&quot;height&quot;]);

            var result = new Result();

            //todo cache embed doc
            var xmlConfig = new XmlDocument();
            xmlConfig.Load(GlobalSettings.FullpathToRoot + Path.DirectorySeparatorChar + &quot;config&quot; + Path.DirectorySeparatorChar + &quot;EmbeddedMedia.config&quot;);

            foreach (XmlNode node in xmlConfig.SelectNodes(&quot;//provider&quot;))
            {
                var regexPattern = new Regex(node.SelectSingleNode(&quot;./urlShemeRegex&quot;).InnerText, RegexOptions.IgnoreCase);

                if (regexPattern.IsMatch(url))
                {
                    var prov = (IEmbedProvider)Activator.CreateInstance(Type.GetType(node.Attributes[&quot;type&quot;].Value));

                    if (node.Attributes[&quot;supportsDimensions&quot;] != null)
                        result.SupportsDimensions = node.Attributes[&quot;supportsDimensions&quot;].Value == &quot;True&quot;;
                    else
                        result.SupportsDimensions = prov.SupportsDimensions;

                    var settings = node.ChildNodes.Cast&lt;XmlNode&gt;().ToDictionary(settingNode =&gt; settingNode.Name);

                    foreach (var prop in prov.GetType().GetProperties().Where(prop =&gt; prop.IsDefined(typeof(ProviderSetting), true)))
                    {

                        if (settings.Any(s =&gt; s.Key.ToLower() == prop.Name.ToLower()))
                        {
                            var setting = settings.FirstOrDefault(s =&gt; s.Key.ToLower() == prop.Name.ToLower()).Value;
                            var settingType = typeof(Media.EmbedProviders.Settings.String);

                            if (setting.Attributes[&quot;type&quot;] != null)
                                settingType = Type.GetType(setting.Attributes[&quot;type&quot;].Value);

                            var settingProv = (IEmbedSettingProvider)Activator.CreateInstance(settingType);
                            prop.SetValue(prov, settingProv.GetSetting(settings.FirstOrDefault(s =&gt; s.Key.ToLower() == prop.Name.ToLower()).Value), null);
                        }
                    }
                    try
                    {
                        result.Markup = prov.GetMarkup(url, width, height);
                        result.Status = Status.Success;
                    }
                    catch
                    {
                        result.Status = Status.Error;
                    }

                    return new JavaScriptSerializer().Serialize(result);
                }
            }

            result.Status = Status.NotSupported;
            return new JavaScriptSerializer().Serialize(result);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,0],[21,13,21,49,0],[23,13,23,37,0],[24,17,24,100,0],[26,13,26,63,0],[27,13,27,78,0],[28,13,28,80,0],[30,13,30,39,0],[33,13,33,47,0],[34,13,34,155,0],[36,13,36,20,0],[36,22,36,34,0],[36,35,36,37,0],[36,38,36,73,0],[37,13,37,14,0],[38,17,38,123,0],[40,17,40,47,0],[41,17,41,18,0],[42,21,42,118,0],[44,21,44,71,0],[45,25,45,107,0],[47,25,47,77,0],[49,21,49,96,0],[49,96,49,112,0],[49,112,49,114,0],[49,21,49,114,0],[51,21,51,28,0],[51,30,51,38,0],[51,39,51,41,0],[51,42,51,87,0],[51,87,51,132,0],[51,132,51,133,0],[51,42,51,133,0],[52,21,52,22,0],[54,25,54,47,0],[54,47,54,85,0],[54,85,54,87,0],[54,25,54,87,0],[55,25,55,26,0],[56,29,56,72,0],[56,72,56,110,0],[56,110,56,118,0],[56,29,56,118,0],[57,29,57,92,0],[59,29,59,68,0],[60,33,60,94,0],[62,29,62,108,0],[63,29,63,101,0],[63,101,63,139,0],[63,139,63,155,0],[63,29,63,155,0],[64,25,64,26,0],[65,21,65,22,0],[67,21,67,22,0],[68,25,68,76,0],[69,25,69,56,0],[70,21,70,22,0],[71,21,71,26,0],[72,21,72,22,0],[73,25,73,54,0],[74,21,74,22,0],[76,21,76,73,0],[78,13,78,14,0],[80,13,80,49,0],[81,13,81,65,0],[82,9,82,10,0]]);
    </script>
  </body>
</html>