<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Media\Exif\ExifPropertyFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Text;

namespace Umbraco.Core.Media.Exif
{
    /// &lt;summary&gt;
    /// Creates exif properties from interoperability parameters.
    /// &lt;/summary&gt;
    internal static class ExifPropertyFactory
    {
        #region Static Methods
        /// &lt;summary&gt;
        /// Creates an ExifProperty from the given interoperability parameters.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;tag&quot;&gt;The tag id of the exif property.&lt;/param&gt;
        /// &lt;param name=&quot;type&quot;&gt;The type id of the exif property.&lt;/param&gt;
        /// &lt;param name=&quot;count&quot;&gt;Byte or component count.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;Field data as an array of bytes.&lt;/param&gt;
        /// &lt;param name=&quot;byteOrder&quot;&gt;Byte order of value.&lt;/param&gt;
        /// &lt;param name=&quot;ifd&quot;&gt;IFD section containing this propery.&lt;/param&gt;
        /// &lt;param name=&quot;encoding&quot;&gt;The encoding to be used for text metadata when the source encoding is unknown.&lt;/param&gt;
        /// &lt;returns&gt;an ExifProperty initialized from the interoperability parameters.&lt;/returns&gt;
        public static ExifProperty Get(ushort tag, ushort type, uint count, byte[] value, BitConverterEx.ByteOrder byteOrder, IFD ifd, Encoding encoding)
        {
            BitConverterEx conv = new BitConverterEx(byteOrder, BitConverterEx.SystemByteOrder);
            // Find the exif tag corresponding to given tag id
            ExifTag etag = ExifTagFactory.GetExifTag(ifd, tag);

            if (ifd == IFD.Zeroth)
            {
                if (tag == 0x103) // Compression
                    return new ExifEnumProperty&lt;Compression&gt;(ExifTag.Compression, (Compression)conv.ToUInt16(value, 0));
                else if (tag == 0x106) // PhotometricInterpretation
                    return new ExifEnumProperty&lt;PhotometricInterpretation&gt;(ExifTag.PhotometricInterpretation, (PhotometricInterpretation)conv.ToUInt16(value, 0));
                else if (tag == 0x112) // Orientation
                    return new ExifEnumProperty&lt;Orientation&gt;(ExifTag.Orientation, (Orientation)conv.ToUInt16(value, 0));
                else if (tag == 0x11c) // PlanarConfiguration
                    return new ExifEnumProperty&lt;PlanarConfiguration&gt;(ExifTag.PlanarConfiguration, (PlanarConfiguration)conv.ToUInt16(value, 0));
                else if (tag == 0x213) // YCbCrPositioning
                    return new ExifEnumProperty&lt;YCbCrPositioning&gt;(ExifTag.YCbCrPositioning, (YCbCrPositioning)conv.ToUInt16(value, 0));
                else if (tag == 0x128) // ResolutionUnit
                    return new ExifEnumProperty&lt;ResolutionUnit&gt;(ExifTag.ResolutionUnit, (ResolutionUnit)conv.ToUInt16(value, 0));
                else if (tag == 0x132) // DateTime
                    return new ExifDateTime(ExifTag.DateTime, ExifBitConverter.ToDateTime(value));
                else if (tag == 0x9c9b || tag == 0x9c9c ||  // Windows tags
                    tag == 0x9c9d || tag == 0x9c9e || tag == 0x9c9f)
                    return new WindowsByteString(etag, Encoding.Unicode.GetString(value).TrimEnd(&#39;\0&#39;));
            }
            else if (ifd == IFD.EXIF)
            {
                if (tag == 0x9000) // ExifVersion
                    return new ExifVersion(ExifTag.ExifVersion, ExifBitConverter.ToAscii(value, Encoding.ASCII));
                else if (tag == 0xa000) // FlashpixVersion
                    return new ExifVersion(ExifTag.FlashpixVersion, ExifBitConverter.ToAscii(value, Encoding.ASCII));
                else if (tag == 0xa001) // ColorSpace
                    return new ExifEnumProperty&lt;ColorSpace&gt;(ExifTag.ColorSpace, (ColorSpace)conv.ToUInt16(value, 0));
                else if (tag == 0x9286) // UserComment
                {
                    // Default to ASCII
                    Encoding enc = Encoding.ASCII;
                    bool hasenc;
                    if (value.Length &lt; 8)
                        hasenc = false;
                    else
                    {
                        hasenc = true;
                        string encstr = enc.GetString(value, 0, 8);
                        if (string.Compare(encstr, &quot;ASCII\0\0\0&quot;, StringComparison.OrdinalIgnoreCase) == 0)
                            enc = Encoding.ASCII;
                        else if (string.Compare(encstr, &quot;JIS\0\0\0\0\0&quot;, StringComparison.OrdinalIgnoreCase) == 0)
                            enc = Encoding.GetEncoding(&quot;Japanese (JIS 0208-1990 and 0212-1990)&quot;);
                        else if (string.Compare(encstr, &quot;Unicode\0&quot;, StringComparison.OrdinalIgnoreCase) == 0)
                            enc = Encoding.Unicode;
                        else
                            hasenc = false;
                    }

                    string val = (hasenc ? enc.GetString(value, 8, value.Length - 8) : enc.GetString(value)).Trim(&#39;\0&#39;);

                    return new ExifEncodedString(ExifTag.UserComment, val, enc);
                }
                else if (tag == 0x9003) // DateTimeOriginal
                    return new ExifDateTime(ExifTag.DateTimeOriginal, ExifBitConverter.ToDateTime(value));
                else if (tag == 0x9004) // DateTimeDigitized
                    return new ExifDateTime(ExifTag.DateTimeDigitized, ExifBitConverter.ToDateTime(value));
                else if (tag == 0x8822) // ExposureProgram
                    return new ExifEnumProperty&lt;ExposureProgram&gt;(ExifTag.ExposureProgram, (ExposureProgram)conv.ToUInt16(value, 0));
                else if (tag == 0x9207) // MeteringMode
                    return new ExifEnumProperty&lt;MeteringMode&gt;(ExifTag.MeteringMode, (MeteringMode)conv.ToUInt16(value, 0));
                else if (tag == 0x9208) // LightSource
                    return new ExifEnumProperty&lt;LightSource&gt;(ExifTag.LightSource, (LightSource)conv.ToUInt16(value, 0));
                else if (tag == 0x9209) // Flash
                    return new ExifEnumProperty&lt;Flash&gt;(ExifTag.Flash, (Flash)conv.ToUInt16(value, 0), true);
                else if (tag == 0x9214) // SubjectArea
                {
                    if (count == 3)
                        return new ExifCircularSubjectArea(ExifTag.SubjectArea, ExifBitConverter.ToUShortArray(value, (int)count, byteOrder));
                    else if (count == 4)
                        return new ExifRectangularSubjectArea(ExifTag.SubjectArea, ExifBitConverter.ToUShortArray(value, (int)count, byteOrder));
                    else // count == 2
                        return new ExifPointSubjectArea(ExifTag.SubjectArea, ExifBitConverter.ToUShortArray(value, (int)count, byteOrder));
                }
                else if (tag == 0xa210) // FocalPlaneResolutionUnit
                    return new ExifEnumProperty&lt;ResolutionUnit&gt;(ExifTag.FocalPlaneResolutionUnit, (ResolutionUnit)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa214) // SubjectLocation
                    return new ExifPointSubjectArea(ExifTag.SubjectLocation, ExifBitConverter.ToUShortArray(value, (int)count, byteOrder));
                else if (tag == 0xa217) // SensingMethod
                    return new ExifEnumProperty&lt;SensingMethod&gt;(ExifTag.SensingMethod, (SensingMethod)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa300) // FileSource
                    return new ExifEnumProperty&lt;FileSource&gt;(ExifTag.FileSource, (FileSource)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa301) // SceneType
                    return new ExifEnumProperty&lt;SceneType&gt;(ExifTag.SceneType, (SceneType)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa401) // CustomRendered
                    return new ExifEnumProperty&lt;CustomRendered&gt;(ExifTag.CustomRendered, (CustomRendered)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa402) // ExposureMode
                    return new ExifEnumProperty&lt;ExposureMode&gt;(ExifTag.ExposureMode, (ExposureMode)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa403) // WhiteBalance
                    return new ExifEnumProperty&lt;WhiteBalance&gt;(ExifTag.WhiteBalance, (WhiteBalance)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa406) // SceneCaptureType
                    return new ExifEnumProperty&lt;SceneCaptureType&gt;(ExifTag.SceneCaptureType, (SceneCaptureType)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa407) // GainControl
                    return new ExifEnumProperty&lt;GainControl&gt;(ExifTag.GainControl, (GainControl)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa408) // Contrast
                    return new ExifEnumProperty&lt;Contrast&gt;(ExifTag.Contrast, (Contrast)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa409) // Saturation
                    return new ExifEnumProperty&lt;Saturation&gt;(ExifTag.Saturation, (Saturation)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa40a) // Sharpness
                    return new ExifEnumProperty&lt;Sharpness&gt;(ExifTag.Sharpness, (Sharpness)conv.ToUInt16(value, 0), true);
                else if (tag == 0xa40c) // SubjectDistanceRange
                    return new ExifEnumProperty&lt;SubjectDistanceRange&gt;(ExifTag.SubjectDistanceRange, (SubjectDistanceRange)conv.ToUInt16(value, 0), true);
            }
            else if (ifd == IFD.GPS)
            {
                if (tag == 0) // GPSVersionID
                    return new ExifVersion(ExifTag.GPSVersionID, ExifBitConverter.ToString(value));
                else if (tag == 1) // GPSLatitudeRef
                    return new ExifEnumProperty&lt;GPSLatitudeRef&gt;(ExifTag.GPSLatitudeRef, (GPSLatitudeRef)value[0]);
                else if (tag == 2) // GPSLatitude
                    return new GPSLatitudeLongitude(ExifTag.GPSLatitude, ExifBitConverter.ToURationalArray(value, (int)count, byteOrder));
                else if (tag == 3) // GPSLongitudeRef
                    return new ExifEnumProperty&lt;GPSLongitudeRef&gt;(ExifTag.GPSLongitudeRef, (GPSLongitudeRef)value[0]);
                else if (tag == 4) // GPSLongitude
                    return new GPSLatitudeLongitude(ExifTag.GPSLongitude, ExifBitConverter.ToURationalArray(value, (int)count, byteOrder));
                else if (tag == 5) // GPSAltitudeRef
                    return new ExifEnumProperty&lt;GPSAltitudeRef&gt;(ExifTag.GPSAltitudeRef, (GPSAltitudeRef)value[0]);
                else if (tag == 7) // GPSTimeStamp
                    return new GPSTimeStamp(ExifTag.GPSTimeStamp, ExifBitConverter.ToURationalArray(value, (int)count, byteOrder));
                else if (tag == 9) // GPSStatus
                    return new ExifEnumProperty&lt;GPSStatus&gt;(ExifTag.GPSStatus, (GPSStatus)value[0]);
                else if (tag == 10) // GPSMeasureMode
                    return new ExifEnumProperty&lt;GPSMeasureMode&gt;(ExifTag.GPSMeasureMode, (GPSMeasureMode)value[0]);
                else if (tag == 12) // GPSSpeedRef
                    return new ExifEnumProperty&lt;GPSSpeedRef&gt;(ExifTag.GPSSpeedRef, (GPSSpeedRef)value[0]);
                else if (tag == 14) // GPSTrackRef
                    return new ExifEnumProperty&lt;GPSDirectionRef&gt;(ExifTag.GPSTrackRef, (GPSDirectionRef)value[0]);
                else if (tag == 16) // GPSImgDirectionRef
                    return new ExifEnumProperty&lt;GPSDirectionRef&gt;(ExifTag.GPSImgDirectionRef, (GPSDirectionRef)value[0]);
                else if (tag == 19) // GPSDestLatitudeRef
                    return new ExifEnumProperty&lt;GPSLatitudeRef&gt;(ExifTag.GPSDestLatitudeRef, (GPSLatitudeRef)value[0]);
                else if (tag == 20) // GPSDestLatitude
                    return new GPSLatitudeLongitude(ExifTag.GPSDestLatitude, ExifBitConverter.ToURationalArray(value, (int)count, byteOrder));
                else if (tag == 21) // GPSDestLongitudeRef
                    return new ExifEnumProperty&lt;GPSLongitudeRef&gt;(ExifTag.GPSDestLongitudeRef, (GPSLongitudeRef)value[0]);
                else if (tag == 22) // GPSDestLongitude
                    return new GPSLatitudeLongitude(ExifTag.GPSDestLongitude, ExifBitConverter.ToURationalArray(value, (int)count, byteOrder));
                else if (tag == 23) // GPSDestBearingRef
                    return new ExifEnumProperty&lt;GPSDirectionRef&gt;(ExifTag.GPSDestBearingRef, (GPSDirectionRef)value[0]);
                else if (tag == 25) // GPSDestDistanceRef
                    return new ExifEnumProperty&lt;GPSDistanceRef&gt;(ExifTag.GPSDestDistanceRef, (GPSDistanceRef)value[0]);
                else if (tag == 29) // GPSDate
                    return new ExifDateTime(ExifTag.GPSDateStamp, ExifBitConverter.ToDateTime(value, false));
                else if (tag == 30) // GPSDifferential
                    return new ExifEnumProperty&lt;GPSDifferential&gt;(ExifTag.GPSDifferential, (GPSDifferential)conv.ToUInt16(value, 0));
            }
            else if (ifd == IFD.Interop)
            {
                if (tag == 1) // InteroperabilityIndex
                    return new ExifAscii(ExifTag.InteroperabilityIndex, ExifBitConverter.ToAscii(value, Encoding.ASCII), Encoding.ASCII);
                else if (tag == 2) // InteroperabilityVersion
                    return new ExifVersion(ExifTag.InteroperabilityVersion, ExifBitConverter.ToAscii(value, Encoding.ASCII));
            }
            else if (ifd == IFD.First)
            {
                if (tag == 0x103) // Compression
                    return new ExifEnumProperty&lt;Compression&gt;(ExifTag.ThumbnailCompression, (Compression)conv.ToUInt16(value, 0));
                else if (tag == 0x106) // PhotometricInterpretation
                    return new ExifEnumProperty&lt;PhotometricInterpretation&gt;(ExifTag.ThumbnailPhotometricInterpretation, (PhotometricInterpretation)conv.ToUInt16(value, 0));
                else if (tag == 0x112) // Orientation
                    return new ExifEnumProperty&lt;Orientation&gt;(ExifTag.ThumbnailOrientation, (Orientation)conv.ToUInt16(value, 0));
                else if (tag == 0x11c) // PlanarConfiguration
                    return new ExifEnumProperty&lt;PlanarConfiguration&gt;(ExifTag.ThumbnailPlanarConfiguration, (PlanarConfiguration)conv.ToUInt16(value, 0));
                else if (tag == 0x213) // YCbCrPositioning
                    return new ExifEnumProperty&lt;YCbCrPositioning&gt;(ExifTag.ThumbnailYCbCrPositioning, (YCbCrPositioning)conv.ToUInt16(value, 0));
                else if (tag == 0x128) // ResolutionUnit
                    return new ExifEnumProperty&lt;ResolutionUnit&gt;(ExifTag.ThumbnailResolutionUnit, (ResolutionUnit)conv.ToUInt16(value, 0));
                else if (tag == 0x132) // DateTime
                    return new ExifDateTime(ExifTag.ThumbnailDateTime, ExifBitConverter.ToDateTime(value));
            }

            if (type == 1) // 1 = BYTE An 8-bit unsigned integer.
            {
                if (count == 1)
                    return new ExifByte(etag, value[0]);
                else
                    return new ExifByteArray(etag, value);
            }
            else if (type == 2) // 2 = ASCII An 8-bit byte containing one 7-bit ASCII code. 
            {
                return new ExifAscii(etag, ExifBitConverter.ToAscii(value, encoding), encoding);
            }
            else if (type == 3) // 3 = SHORT A 16-bit (2-byte) unsigned integer.
            {
                if (count == 1)
                    return new ExifUShort(etag, conv.ToUInt16(value, 0));
                else
                    return new ExifUShortArray(etag, ExifBitConverter.ToUShortArray(value, (int)count, byteOrder));
            }
            else if (type == 4) // 4 = LONG A 32-bit (4-byte) unsigned integer.
            {
                if (count == 1)
                    return new ExifUInt(etag, conv.ToUInt32(value, 0));
                else
                    return new ExifUIntArray(etag, ExifBitConverter.ToUIntArray(value, (int)count, byteOrder));
            }
            else if (type == 5) // 5 = RATIONAL Two LONGs. The first LONG is the numerator and the second LONG expresses the denominator.
            {
                if (count == 1)
                    return new ExifURational(etag, ExifBitConverter.ToURational(value, byteOrder));
                else
                    return new ExifURationalArray(etag, ExifBitConverter.ToURationalArray(value, (int)count, byteOrder));
            }
            else if (type == 7) // 7 = UNDEFINED An 8-bit byte that can take any value depending on the field definition.
                return new ExifUndefined(etag, value);
            else if (type == 9) // 9 = SLONG A 32-bit (4-byte) signed integer (2&#39;s complement notation).
            {
                if (count == 1)
                    return new ExifSInt(etag, conv.ToInt32(value, 0));
                else
                    return new ExifSIntArray(etag, ExifBitConverter.ToSIntArray(value, (int)count, byteOrder));
            }
            else if (type == 10) // 10 = SRATIONAL Two SLONGs. The first SLONG is the numerator and the second SLONG is the denominator.
            {
                if (count == 1)
                    return new ExifSRational(etag, ExifBitConverter.ToSRational(value, byteOrder));
                else
                    return new ExifSRationalArray(etag, ExifBitConverter.ToSRationalArray(value, (int)count, byteOrder));
            }
            else
                throw new ArgumentException(&quot;Unknown property type.&quot;);
        }
        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,0],[25,13,25,97,0],[27,13,27,64,0],[29,13,29,35,0],[30,13,30,14,0],[31,17,31,34,0],[32,21,32,121,0],[33,22,33,39,0],[34,21,34,163,0],[35,22,35,39,0],[36,21,36,121,0],[37,22,37,39,0],[38,21,38,145,0],[39,22,39,39,0],[40,21,40,136,0],[41,22,41,39,0],[42,21,42,130,0],[43,22,43,39,0],[44,21,44,99,0],[45,22,46,69,0],[47,21,47,105,0],[48,13,48,14,0],[49,18,49,38,0],[50,13,50,14,0],[51,17,51,35,0],[52,21,52,114,0],[53,22,53,40,0],[54,21,54,118,0],[55,22,55,40,0],[56,21,56,118,0],[57,22,57,40,0],[58,17,58,18,0],[60,21,60,51,0],[62,21,62,42,0],[63,25,63,40,0],[65,21,65,22,0],[66,25,66,39,0],[67,25,67,68,0],[68,25,68,108,0],[69,29,69,50,0],[70,30,70,115,0],[71,29,71,98,0],[72,30,72,111,0],[73,29,73,52,0],[75,29,75,44,0],[76,21,76,22,0],[78,21,78,121,0],[80,21,80,81,0],[82,22,82,40,0],[83,21,83,107,0],[84,22,84,40,0],[85,21,85,108,0],[86,22,86,40,0],[87,21,87,133,0],[88,22,88,40,0],[89,21,89,124,0],[90,22,90,40,0],[91,21,91,121,0],[92,22,92,40,0],[93,21,93,109,0],[94,22,94,40,0],[95,17,95,18,0],[96,21,96,36,0],[97,25,97,143,0],[98,26,98,41,0],[99,25,99,146,0],[101,25,101,140,0],[103,22,103,40,0],[104,21,104,146,0],[105,22,105,40,0],[106,21,106,140,0],[107,22,107,40,0],[108,21,108,133,0],[109,22,109,40,0],[110,21,110,124,0],[111,22,111,40,0],[112,21,112,121,0],[113,22,113,40,0],[114,21,114,136,0],[115,22,115,40,0],[116,21,116,130,0],[117,22,117,40,0],[118,21,118,130,0],[119,22,119,40,0],[120,21,120,142,0],[121,22,121,40,0],[122,21,122,127,0],[123,22,123,40,0],[124,21,124,118,0],[125,22,125,40,0],[126,21,126,124,0],[127,22,127,40,0],[128,21,128,121,0],[129,22,129,40,0],[130,21,130,154,0],[131,13,131,14,0],[132,18,132,37,0],[133,13,133,14,0],[134,17,134,30,0],[135,21,135,100,0],[136,22,136,35,0],[137,21,137,115,0],[138,22,138,35,0],[139,21,139,139,0],[140,22,140,35,0],[141,21,141,118,0],[142,22,142,35,0],[143,21,143,140,0],[144,22,144,35,0],[145,21,145,115,0],[146,22,146,35,0],[147,21,147,132,0],[148,22,148,35,0],[149,21,149,100,0],[150,22,150,36,0],[151,21,151,115,0],[152,22,152,36,0],[153,21,153,106,0],[154,22,154,36,0],[155,21,155,114,0],[156,22,156,36,0],[157,21,157,121,0],[158,22,158,36,0],[159,21,159,119,0],[160,22,160,36,0],[161,21,161,143,0],[162,22,162,36,0],[163,21,163,122,0],[164,22,164,36,0],[165,21,165,144,0],[166,22,166,36,0],[167,21,167,120,0],[168,22,168,36,0],[169,21,169,119,0],[170,22,170,36,0],[171,21,171,110,0],[172,22,172,36,0],[173,21,173,133,0],[174,13,174,14,0],[175,18,175,41,0],[176,13,176,14,0],[177,17,177,30,0],[178,21,178,138,0],[179,22,179,35,0],[180,21,180,126,0],[181,13,181,14,0],[182,18,182,39,0],[183,13,183,14,0],[184,17,184,34,0],[185,21,185,130,0],[186,22,186,39,0],[187,21,187,172,0],[188,22,188,39,0],[189,21,189,130,0],[190,22,190,39,0],[191,21,191,154,0],[192,22,192,39,0],[193,21,193,145,0],[194,22,194,39,0],[195,21,195,139,0],[196,22,196,39,0],[197,21,197,108,0],[198,13,198,14,0],[200,13,200,27,0],[201,13,201,14,0],[202,17,202,32,0],[203,21,203,57,0],[205,21,205,59,0],[207,18,207,32,0],[208,13,208,14,0],[209,17,209,97,0],[211,18,211,32,0],[212,13,212,14,0],[213,17,213,32,0],[214,21,214,74,0],[216,21,216,116,0],[218,18,218,32,0],[219,13,219,14,0],[220,17,220,32,0],[221,21,221,72,0],[223,21,223,112,0],[225,18,225,32,0],[226,13,226,14,0],[227,17,227,32,0],[228,21,228,100,0],[230,21,230,122,0],[232,18,232,32,0],[233,17,233,55,0],[234,18,234,32,0],[235,13,235,14,0],[236,17,236,32,0],[237,21,237,71,0],[239,21,239,112,0],[241,18,241,33,0],[242,13,242,14,0],[243,17,243,32,0],[244,21,244,100,0],[246,21,246,122,0],[249,17,249,71,0],[250,9,250,10,0]]);
    </script>
  </body>
</html>