<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\webservices\UltimatePickerAutoCompleteHandler.ashx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web;
using System.Web.Services;
using Umbraco.Web.WebServices;
using umbraco.BasePages;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.web;
using umbraco.cms.businesslogic;

namespace umbraco.presentation.umbraco.webservices
{
    /// &lt;summary&gt;
    /// Summary description for $codebehindclassname$
    /// &lt;/summary&gt;
    [WebService(Namespace = &quot;http://tempuri.org/&quot;)]
    [WebServiceBinding(ConformsTo = WsiProfiles.BasicProfile1_1)]
    public class UltimatePickerAutoCompleteHandler : UmbracoAuthorizedHttpHandler
    {

        private int _nodeCount;
        private int _counter;
        private string[] _output;
        private string _prefix;

        public override void ProcessRequest(HttpContext context)
        {
            if (BasePage.ValidateUserContextID(BasePage.umbracoUserContextID) == false)
                throw new Exception(&quot;Client authorization failed. User is not logged in&quot;);

            //user must be allowed to see content or media
            if (AuthorizeRequest(DefaultApps.content.ToString()) == false &amp;&amp; AuthorizeRequest(DefaultApps.media.ToString()) == false)
                return;

            context.Response.ContentType = &quot;text/plain&quot;;

            _prefix = context.Request.QueryString[&quot;q&quot;];

            var parentNodeId = Convert.ToInt32(context.Request.QueryString[&quot;id&quot;]);
            var showGrandChildren = Convert.ToBoolean(context.Request.QueryString[&quot;showchildren&quot;]);

            var documentAliasFilter = context.Request.QueryString[&quot;filter&quot;];
            var documentAliasFilters = documentAliasFilter.Split(&quot;,&quot;.ToCharArray());

            var parent = new CMSNode(parentNodeId);

            _nodeCount = 0;

            //store children array here because iterating over an Array property object is very inneficient.
            var children = parent.Children;
            foreach (CMSNode child in children)
            {
                NodeChildrenCount(child, showGrandChildren, documentAliasFilters);
            }

            _output = new string[_nodeCount];
            _counter = 0;
            int level = 1;

            foreach (CMSNode child in children)
            {
                AddNode(child, level, showGrandChildren, documentAliasFilters);
            }

            foreach (var item in _output)
            {
                context.Response.Write(item + Environment.NewLine);
            }
        }

        private bool ValidNode(string nodeText)
        {
            return nodeText.Length &gt;= _prefix.Length &amp;&amp; nodeText.Substring(0, _prefix.Length).ToLower() == _prefix.ToLower();
        }

        private void NodeChildrenCount(CMSNode node, bool countChildren, string[] documentAliasFilters)
        {
            if (documentAliasFilters.Length &gt; 0)
            {
                foreach (var filter in documentAliasFilters)
                {
                    var trimmedFilter = filter.TrimStart(&quot; &quot;.ToCharArray());
                    trimmedFilter = trimmedFilter.TrimEnd(&quot; &quot;.ToCharArray());

                    if ((new Document(node.Id).ContentType.Alias == trimmedFilter || trimmedFilter == string.Empty) &amp;&amp; ValidNode(node.Text))
                    {
                        _nodeCount += 1;
                    }
                }
            }
            else
            {
                if (ValidNode(node.Text))
                {
                    _nodeCount += 1;
                }
            }

            if (countChildren)
            {
                //store children array here because iterating over an Array property object is very inneficient.
                var children = node.Children;
                foreach (CMSNode child in children)
                {
                    NodeChildrenCount(child, countChildren, documentAliasFilters);
                }
            }

        }

        private void AddNode(CMSNode node, int level, bool showGrandChildren, string[] documentAliasFilters)
        {
            var preText = string.Empty;

            for (var i = 1; i &lt; level; i++)
            {
                preText += &quot;- &quot;;
            }

            if (documentAliasFilters.Length &gt; 0)
            {
                foreach (var filter in documentAliasFilters)
                {
                    var trimmedFilter = filter.TrimStart(&quot; &quot;.ToCharArray());
                    trimmedFilter = trimmedFilter.TrimEnd(&quot; &quot;.ToCharArray());

                    if ((new Document(node.Id).ContentType.Alias == trimmedFilter || trimmedFilter == string.Empty) &amp;&amp; ValidNode(node.Text))
                    {
                        _output[_counter] = preText + node.Text + &quot; [&quot; + node.Id + &quot;]&quot;;
                        _counter++;
                    }

                }
            }
            else
            {
                if (ValidNode(node.Text))
                {
                    _output[_counter] = preText + node.Text + &quot; [&quot; + node.Id + &quot;]&quot;;
                    _counter++;
                }
            }

            if (showGrandChildren)
            {
                if (node.HasChildren)
                {
                    //store children array here because iterating over an Array property object is very inneficient.
                    var children = node.Children;
                    foreach (CMSNode child in children)
                    {
                        AddNode(child, level + 1, showGrandChildren, documentAliasFilters);
                    }
                }
            }
        }

        public override bool IsReusable
        {
            get { return false; }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,0],[28,13,28,88,0],[29,17,29,91,0],[32,13,32,134,0],[33,17,33,24,0],[35,13,35,57,0],[37,13,37,56,0],[39,13,39,83,0],[40,13,40,100,0],[42,13,42,77,0],[43,13,43,85,0],[45,13,45,52,0],[47,13,47,28,0],[50,13,50,44,0],[51,13,51,20,0],[51,22,51,35,0],[51,36,51,38,0],[51,39,51,47,0],[52,13,52,14,0],[53,17,53,83,0],[54,13,54,14,0],[56,13,56,46,0],[57,13,57,26,0],[58,13,58,27,0],[60,13,60,20,0],[60,22,60,35,0],[60,36,60,38,0],[60,39,60,47,0],[61,13,61,14,0],[62,17,62,80,0],[63,13,63,14,0],[65,13,65,20,0],[65,22,65,30,0],[65,31,65,33,0],[65,34,65,41,0],[66,13,66,14,0],[67,17,67,68,0],[68,13,68,14,0],[69,9,69,10,0],[72,9,72,10,0],[73,13,73,126,0],[74,9,74,10,0],[77,9,77,10,0],[78,13,78,49,0],[79,13,79,14,0],[80,17,80,24,0],[80,26,80,36,0],[80,37,80,39,0],[80,40,80,60,0],[81,17,81,18,0],[82,21,82,77,0],[83,21,83,78,0],[85,21,85,141,0],[86,21,86,22,0],[87,25,87,41,0],[88,21,88,22,0],[89,17,89,18,0],[90,13,90,14,0],[92,13,92,14,0],[93,17,93,42,0],[94,17,94,18,0],[95,21,95,37,0],[96,17,96,18,0],[97,13,97,14,0],[99,13,99,31,0],[100,13,100,14,0],[102,17,102,46,0],[103,17,103,24,0],[103,26,103,39,0],[103,40,103,42,0],[103,43,103,51,0],[104,17,104,18,0],[105,21,105,83,0],[106,17,106,18,0],[107,13,107,14,0],[109,9,109,10,0],[112,9,112,10,0],[113,13,113,40,0],[115,18,115,27,0],[115,29,115,38,0],[115,40,115,43,0],[116,13,116,14,0],[117,17,117,33,0],[118,13,118,14,0],[120,13,120,49,0],[121,13,121,14,0],[122,17,122,24,0],[122,26,122,36,0],[122,37,122,39,0],[122,40,122,60,0],[123,17,123,18,0],[124,21,124,77,0],[125,21,125,78,0],[127,21,127,141,0],[128,21,128,22,0],[129,25,129,88,0],[130,25,130,36,0],[131,21,131,22,0],[133,17,133,18,0],[134,13,134,14,0],[136,13,136,14,0],[137,17,137,42,0],[138,17,138,18,0],[139,21,139,84,0],[140,21,140,32,0],[141,17,141,18,0],[142,13,142,14,0],[144,13,144,35,0],[145,13,145,14,0],[146,17,146,38,0],[147,17,147,18,0],[149,21,149,50,0],[150,21,150,28,0],[150,30,150,43,0],[150,44,150,46,0],[150,47,150,55,0],[151,21,151,22,0],[152,25,152,92,0],[153,21,153,22,0],[154,17,154,18,0],[155,13,155,14,0],[156,9,156,10,0],[160,17,160,18,0],[160,19,160,32,0],[160,33,160,34,0]]);
    </script>
  </body>
</html>