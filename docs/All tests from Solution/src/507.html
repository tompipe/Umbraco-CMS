<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\controls\Images\UploadMediaImage.ascx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Linq;
using System.Xml;
using umbraco.BasePages;
using umbraco.cms.businesslogic.datatype;
using umbraco.interfaces;
using Media = umbraco.cms.businesslogic.media.Media;
using Umbraco.Core;

namespace umbraco.controls.Images
{

    /// &lt;summary&gt;
    /// A control to render out the controls to upload a new image to media.
    /// Includes ability to select where in the media you would like it to upload and also supports client
    /// callback methods once complete.
    /// &lt;/summary&gt;
    public partial class UploadMediaImage : UserControl
    {

        public UploadMediaImage()
        {
            OnClientUpload = &quot;&quot;;
        }

        /// &lt;summary&gt;
        /// The JavaScript method to be invoked once the image is uploaded, the page is rendered and the document is ready.
        /// The method will receive a JSON object with the following parameters:
        /// - imagePath
        /// - thumbnailPath
        /// - width
        /// - height
        /// - id
        /// &lt;/summary&gt;
        public string OnClientUpload { get; set; }

        protected IDataType UploadField = DataTypeDefinition.GetByDataTypeId(new Guid(Constants.PropertyEditors.UploadField)).DataType;

        protected override void OnInit(EventArgs e)
        {

            base.OnInit(e);
            // Get upload field from datafield factory
            UploadControl.Controls.Add((Control)UploadField.DataEditor);
        }

        protected void Page_Load(object sender, EventArgs e)
        {

            ((HtmlInputFile)UploadField.DataEditor).ID = &quot;uploadFile&quot;;
            if (!IsPostBack)
            {
                DataBind();
            }
            

       }

        protected void SubmitButton_Click(object sender, EventArgs e)
        {
            var media = Media.MakeNew(TextBoxTitle.Text, cms.businesslogic.media.MediaType.GetByAlias(Constants.Conventions.MediaTypes.Image), BasePage.Current.getUser(), int.Parse(MediaPickerControl.Value));

            foreach (var property in media.GenericProperties)
            {
                if (property.PropertyType.DataTypeDefinition.DataType.Id == UploadField.Id)
                {
                    UploadField.DataTypeDefinitionId = property.PropertyType.DataTypeDefinition.Id;
                    UploadField.Data.PropertyId = property.Id;
                }
            }
            UploadField.DataEditor.Save();
            //MCH NOTE: After having refactored the legacy api to use the new api under the hood, it is necessary to set the property value and save the media.
            var prop = media.GenericProperties.FirstOrDefault(x =&gt; x.PropertyType.DataTypeDefinition.DataType.Id == UploadField.Id);
            prop.Value = UploadField.Data.Value;
            media.Save();

            pane_upload.Visible = false;
            
            //this seems real ugly since we apparently already have the properties above (props)... but this data layer is insane and undecipherable:)
            string mainImage = media.getProperty(Constants.Conventions.Media.File).Value.ToString();
            string extension = mainImage.Substring(mainImage.LastIndexOf(&quot;.&quot;) + 1, mainImage.Length - mainImage.LastIndexOf(&quot;.&quot;) - 1);            
            var thumbnail = mainImage.Remove(mainImage.Length - extension.Length - 1, extension.Length + 1) + &quot;_thumb.&quot; + extension;
            string width = media.getProperty(Constants.Conventions.Media.Width).Value.ToString();
            string height = media.getProperty(Constants.Conventions.Media.Height).Value.ToString();
            int id = media.Id;

            feedback.Style.Add(&quot;margin-top&quot;, &quot;8px&quot;);
            feedback.type = uicontrols.Feedback.feedbacktype.success;
            if (mainImage.StartsWith(&quot;~&quot;)) mainImage = mainImage.Substring(1);
            if (thumbnail.StartsWith(&quot;~&quot;)) thumbnail = thumbnail.Substring(1);
            feedback.Text += &quot;&lt;div style=\&quot;text-align: center\&quot;&gt; &lt;a target=\&quot;_blank\&quot; href=&#39;&quot; + mainImage + &quot;&#39;&gt;&lt;img src=&#39;&quot; + thumbnail + &quot;&#39; style=&#39;border: none;&#39;/&gt;&lt;br/&gt;&lt;br/&gt;&quot;;
            feedback.Text += ui.Text(&quot;thumbnailimageclickfororiginal&quot;) + &quot;&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;&lt;/div&gt;&quot;;

            if (!string.IsNullOrEmpty(OnClientUpload))
            {
                feedback.Text += @&quot;
                &lt;script type=&quot;&quot;text/javascript&quot;&quot;&gt;
                jQuery(document).ready(function() { 
                &quot; + OnClientUpload + @&quot;.call(this, {imagePath: &#39;&quot; + mainImage + @&quot;&#39;, thumbnailPath: &#39;&quot; + thumbnail + @&quot;&#39;, width: &quot; + width + @&quot;, height: &quot; + height + @&quot;, id: &quot; + id + @&quot;});  
                });
                &lt;/script&gt;&quot;;
            }
            
        }

        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            ((HtmlInputFile)UploadField.DataEditor).Attributes.Add(&quot;onChange&quot;, &quot;uploader_&quot; + this.ClientID + &quot;.validateImage();&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,34,0],[24,9,24,10,0],[25,13,25,33,0],[26,9,26,10,0],[37,40,37,44,0],[37,45,37,49,0],[39,9,39,136,0],[42,9,42,10,0],[44,13,44,28,0],[46,13,46,73,0],[47,9,47,10,0],[50,9,50,10,0],[52,13,52,71,0],[53,13,53,29,0],[54,13,54,14,0],[55,17,55,28,0],[56,13,56,14,0],[59,8,59,9,0],[62,9,62,10,0],[63,13,63,209,0],[65,13,65,20,0],[65,22,65,34,0],[65,35,65,37,0],[65,38,65,61,0],[66,13,66,14,0],[67,17,67,92,0],[68,17,68,18,0],[69,21,69,100,0],[70,21,70,63,0],[71,17,71,18,0],[72,13,72,14,0],[73,13,73,43,0],[75,13,75,68,0],[75,68,75,131,0],[75,131,75,133,0],[75,13,75,133,0],[76,13,76,49,0],[77,13,77,26,0],[79,13,79,41,0],[82,13,82,101,0],[83,13,83,135,0],[84,13,84,133,0],[85,13,85,98,0],[86,13,86,100,0],[87,13,87,31,0],[89,13,89,53,0],[90,13,90,70,0],[91,13,91,43,0],[91,44,91,79,0],[92,13,92,43,0],[92,44,92,79,0],[93,13,93,176,0],[94,13,94,97,0],[96,13,96,55,0],[97,13,97,14,0],[98,17,103,28,0],[104,13,104,14,0],[106,9,106,10,0],[109,9,109,10,0],[110,13,110,33,0],[112,13,112,131,0],[113,9,113,10,0]]);
    </script>
  </body>
</html>