<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UI\JavaScript\AssetInitialization.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Web;
using ClientDependency.Core;
using ClientDependency.Core.Config;
using Newtonsoft.Json.Linq;
using Umbraco.Core.PropertyEditors;
using Umbraco.Web.PropertyEditors;

namespace Umbraco.Web.UI.JavaScript
{
    internal abstract class AssetInitialization
    {
        /// &lt;summary&gt;
        /// Get all dependencies declared on property editors
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cdfType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;httpContext&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected JArray ScanPropertyEditors(ClientDependencyType cdfType, HttpContextBase httpContext)
        {
            if (httpContext == null) throw new ArgumentNullException(&quot;httpContext&quot;);
            var cdfAttributes =
                PropertyEditorResolver.Current.PropertyEditors
                                      .SelectMany(x =&gt; x.GetType().GetCustomAttributes&lt;PropertyEditorAssetAttribute&gt;(false))
                                      .Where(x =&gt; x.AssetType == cdfType)
                                      .Select(x =&gt; x.DependencyFile)
                                      .ToList();

            string jsOut;
            string cssOut;
            var renderer = ClientDependencySettings.Instance.MvcRendererCollection[&quot;Umbraco.DependencyPathRenderer&quot;];
            renderer.RegisterDependencies(cdfAttributes, new HashSet&lt;IClientDependencyPath&gt;(), out jsOut, out cssOut, httpContext);

            var toParse = cdfType == ClientDependencyType.Javascript ? jsOut : cssOut;

            var result = new JArray();
            //split the result by the delimiter and add to the array
            foreach (var u in toParse.Split(new[] { DependencyPathRenderer.Delimiter }, StringSplitOptions.RemoveEmptyEntries))
            {
                result.Add(u);
            }
            return result;
        }

        /// &lt;summary&gt;
        /// This will use CDF to optimize the asset file collection
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;fileRefs&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;cdfType&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;httpContext&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;
        /// Return the asset URLs that should be loaded, if the application is in debug mode then the URLs returned will be the same as the ones
        /// passed in with the CDF version query strings appended so cache busting works correctly.
        /// &lt;/returns&gt;
        protected JArray OptimizeAssetCollection(JArray fileRefs, ClientDependencyType cdfType, HttpContextBase httpContext)
        {
            if (httpContext == null) throw new ArgumentNullException(&quot;httpContext&quot;);

            var depenencies = fileRefs.Select(x =&gt;
            {
                var asString = x.ToString();
                if (asString.StartsWith(&quot;/&quot;) == false)
                {
                    //most declarations with be made relative to the /umbraco folder, so things like lib/blah/blah.js
                    // so we need to turn them into absolutes here
                    if (Uri.IsWellFormedUriString(asString, UriKind.Relative))
                    {
                        var absolute = new Uri(httpContext.Request.Url, asString);
                        return (IClientDependencyFile)new BasicFile(cdfType) { FilePath = absolute.AbsolutePath };
                    }
                }
                return cdfType == ClientDependencyType.Javascript
                    ? (IClientDependencyFile)new JavascriptFile(asString)
                    : (IClientDependencyFile)new CssFile(asString);
            }).Where(x =&gt; x != null).ToList();

            //Get the output string for these registrations which will be processed by CDF correctly to stagger the output based
            // on internal vs external resources. The output will be delimited based on our custom Umbraco.Web.UI.JavaScript.DependencyPathRenderer
            string jsOut;
            string cssOut;
            var renderer = ClientDependencySettings.Instance.MvcRendererCollection[&quot;Umbraco.DependencyPathRenderer&quot;];
            renderer.RegisterDependencies(depenencies, new HashSet&lt;IClientDependencyPath&gt;(), out jsOut, out cssOut, httpContext);

            var urls = cdfType == ClientDependencyType.Javascript
                ? jsOut.Split(new string[] { DependencyPathRenderer.Delimiter }, StringSplitOptions.RemoveEmptyEntries)
                : cssOut.Split(new string[] { DependencyPathRenderer.Delimiter }, StringSplitOptions.RemoveEmptyEntries);

            var result = new JArray();
            foreach (var u in urls)
            {
                result.Add(u);
            }
            return result;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,0],[25,13,25,37,0],[25,38,25,85,0],[26,13,28,56,0],[28,56,28,124,0],[28,124,29,51,0],[29,51,29,73,0],[29,73,30,52,0],[30,52,30,68,0],[30,68,31,49,0],[26,13,31,49,0],[35,13,35,118,0],[36,13,36,132,0],[38,13,38,87,0],[40,13,40,39,0],[42,13,42,20,0],[42,22,42,27,0],[42,28,42,30,0],[42,31,42,127,0],[43,13,43,14,0],[44,17,44,31,0],[45,13,45,14,0],[46,13,46,27,0],[47,9,47,10,0],[60,9,60,10,0],[61,13,61,37,0],[61,38,61,85,0],[63,13,64,13,0],[64,13,64,14,0],[64,14,65,17,0],[65,17,65,45,0],[65,45,66,17,0],[66,17,66,55,0],[66,55,67,17,0],[67,17,67,18,0],[67,18,70,21,0],[70,21,70,79,0],[70,79,71,21,0],[71,21,71,22,0],[71,22,72,25,0],[72,25,72,83,0],[72,83,73,25,0],[73,25,73,115,0],[73,115,75,17,0],[75,17,75,18,0],[75,18,76,17,0],[76,17,78,68,0],[78,68,79,13,0],[79,13,79,14,0],[79,14,79,27,0],[79,27,79,36,0],[79,36,79,47,0],[63,13,79,47,0],[85,13,85,118,0],[86,13,86,130,0],[88,13,90,122,0],[92,13,92,39,0],[93,13,93,20,0],[93,22,93,27,0],[93,28,93,30,0],[93,31,93,35,0],[94,13,94,14,0],[95,17,95,31,0],[96,13,96,14,0],[97,13,97,27,0],[98,9,98,10,0]]);
    </script>
  </body>
</html>