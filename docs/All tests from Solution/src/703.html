<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\NotificationServiceExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Services;
using umbraco;
using umbraco.BusinessLogic.Actions;
using umbraco.interfaces;
using System.Collections.Generic;

namespace Umbraco.Web
{
    //NOTE: all of these require an UmbracoContext because currently to send the notifications we need an HttpContext, this is based on legacy code
    // for which probably requires updating so that these can be sent outside of the http context.

    internal static class NotificationServiceExtensions
    {
        internal static void SendNotification(this INotificationService service, IUmbracoEntity entity, IAction action, ApplicationContext applicationContext)
        {
            if (UmbracoContext.Current == null)
            {
                LogHelper.Warn(typeof(NotificationServiceExtensions), &quot;Cannot send notifications, there is no current UmbracoContext&quot;);
                return;
            }
            service.SendNotification(entity, action, UmbracoContext.Current);
        }

        internal static void SendNotification(this INotificationService service, IEnumerable&lt;IUmbracoEntity&gt; entities, IAction action, ApplicationContext applicationContext)
        {
            if (UmbracoContext.Current == null)
            {
                LogHelper.Warn(typeof(NotificationServiceExtensions), &quot;Cannot send notifications, there is no current UmbracoContext&quot;);
                return;
            }
            service.SendNotification(entities, action, UmbracoContext.Current);
        }

        internal static void SendNotification(this INotificationService service, IUmbracoEntity entity, IAction action, UmbracoContext umbracoContext)
        {
            if (umbracoContext == null)
            {
                LogHelper.Warn(typeof(NotificationServiceExtensions), &quot;Cannot send notifications, there is no current UmbracoContext&quot;);
                return;
            }
            service.SendNotification(entity, action, umbracoContext, umbracoContext.Application);
        }

        internal static void SendNotification(this INotificationService service, IEnumerable&lt;IUmbracoEntity&gt; entities, IAction action, UmbracoContext umbracoContext)
        {
            if (umbracoContext == null)
            {
                LogHelper.Warn(typeof(NotificationServiceExtensions), &quot;Cannot send notifications, there is no current UmbracoContext&quot;);
                return;
            }
            service.SendNotification(entities, action, umbracoContext, umbracoContext.Application);
        }

        internal static void SendNotification(this INotificationService service, IUmbracoEntity entity, IAction action, UmbracoContext umbracoContext, ApplicationContext applicationContext)
        {
            if (umbracoContext == null)
            {
                LogHelper.Warn(typeof(NotificationServiceExtensions), &quot;Cannot send notifications, there is no current UmbracoContext&quot;);
                return;
            }

            var user = umbracoContext.Security.CurrentUser;

            //if there is no current user, then use the admin 
            if (user == null)
            {
                LogHelper.Debug(typeof(NotificationServiceExtensions), &quot;There is no current Umbraco user logged in, the notifications will be sent from the administrator&quot;);
                user = applicationContext.Services.UserService.GetUserById(0);
                if (user == null)
                {
                    LogHelper.Warn(typeof(NotificationServiceExtensions), &quot;Noticiations can not be sent, no admin user with id 0 could be resolved&quot;);
                    return;
                }
            }
            service.SendNotification(user, entity, action, umbracoContext, applicationContext);
        }

        internal static void SendNotification(this INotificationService service, IEnumerable&lt;IUmbracoEntity&gt; entities, IAction action, UmbracoContext umbracoContext, ApplicationContext applicationContext)
        {
            if (umbracoContext == null)
            {
                LogHelper.Warn(typeof(NotificationServiceExtensions), &quot;Cannot send notifications, there is no current UmbracoContext&quot;);
                return;
            }

            var user = umbracoContext.Security.CurrentUser;

            //if there is no current user, then use the admin 
            if (user == null)
            {
                LogHelper.Debug(typeof(NotificationServiceExtensions), &quot;There is no current Umbraco user logged in, the notifications will be sent from the administrator&quot;);
                user = applicationContext.Services.UserService.GetUserById(0);
                if (user == null)
                {
                    LogHelper.Warn(typeof(NotificationServiceExtensions), &quot;Noticiations can not be sent, no admin user with id 0 could be resolved&quot;);
                    return;
                }
            }
            service.SendNotification(user, entities, action, umbracoContext, applicationContext);
        }

        internal static void SendNotification(this INotificationService service, IUser sender, IUmbracoEntity entity, IAction action, UmbracoContext umbracoContext, ApplicationContext applicationContext)
        {
            if (sender == null) throw new ArgumentNullException(&quot;sender&quot;);
            if (umbracoContext == null) throw new ArgumentNullException(&quot;umbracoContext&quot;);
            if (applicationContext == null) throw new ArgumentNullException(&quot;applicationContext&quot;);

            
            applicationContext.Services.NotificationService.SendNotifications(
                sender,
                entity,
                action.Letter.ToString(CultureInfo.InvariantCulture),
                ui.Text(&quot;actions&quot;, action.Alias),
                umbracoContext.HttpContext,
                (mailingUser, strings) =&gt; ui.Text(&quot;notifications&quot;, &quot;mailSubject&quot;, strings, mailingUser),
                (mailingUser, strings) =&gt; UmbracoConfig.For.UmbracoSettings().Content.DisableHtmlEmail
                                              ? ui.Text(&quot;notifications&quot;, &quot;mailBody&quot;, strings, mailingUser)
                                              : ui.Text(&quot;notifications&quot;, &quot;mailBodyHtml&quot;, strings, mailingUser));
        }

         internal static void SendNotification(this INotificationService service, IUser sender, IEnumerable&lt;IUmbracoEntity&gt; entities, IAction action, UmbracoContext umbracoContext, ApplicationContext applicationContext)
        {
            if (sender == null) throw new ArgumentNullException(&quot;sender&quot;);
            if (umbracoContext == null) throw new ArgumentNullException(&quot;umbracoContext&quot;);
            if (applicationContext == null) throw new ArgumentNullException(&quot;applicationContext&quot;);

            
            applicationContext.Services.NotificationService.SendNotifications(
                sender,
                entities,
                action.Letter.ToString(CultureInfo.InvariantCulture),
                ui.Text(&quot;actions&quot;, action.Alias),
                umbracoContext.HttpContext,
                (mailingUser, strings) =&gt; ui.Text(&quot;notifications&quot;, &quot;mailSubject&quot;, strings, mailingUser),
                (mailingUser, strings) =&gt; UmbracoConfig.For.UmbracoSettings().Content.DisableHtmlEmail
                                              ? ui.Text(&quot;notifications&quot;, &quot;mailBody&quot;, strings, mailingUser)
                                              : ui.Text(&quot;notifications&quot;, &quot;mailBodyHtml&quot;, strings, mailingUser));
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,0],[23,13,23,48,0],[24,13,24,14,0],[25,17,25,136,0],[26,17,26,24,0],[28,13,28,78,0],[29,9,29,10,0],[32,9,32,10,0],[33,13,33,48,0],[34,13,34,14,0],[35,17,35,136,0],[36,17,36,24,0],[38,13,38,80,0],[39,9,39,10,0],[42,9,42,10,0],[43,13,43,40,0],[44,13,44,14,0],[45,17,45,136,0],[46,17,46,24,0],[48,13,48,98,0],[49,9,49,10,0],[52,9,52,10,0],[53,13,53,40,0],[54,13,54,14,0],[55,17,55,136,0],[56,17,56,24,0],[58,13,58,100,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,40,0],[64,13,64,14,0],[65,17,65,136,0],[66,17,66,24,0],[69,13,69,60,0],[72,13,72,30,0],[73,13,73,14,0],[74,17,74,173,0],[75,17,75,79,0],[76,17,76,34,0],[77,17,77,18,0],[78,21,78,150,0],[79,21,79,28,0],[81,13,81,14,0],[82,13,82,96,0],[83,9,83,10,0],[86,9,86,10,0],[87,13,87,40,0],[88,13,88,14,0],[89,17,89,136,0],[90,17,90,24,0],[93,13,93,60,0],[96,13,96,30,0],[97,13,97,14,0],[98,17,98,173,0],[99,17,99,79,0],[100,17,100,34,0],[101,17,101,18,0],[102,21,102,150,0],[103,21,103,28,0],[105,13,105,14,0],[106,13,106,98,0],[107,9,107,10,0],[110,9,110,10,0],[111,13,111,32,0],[111,33,111,75,0],[112,13,112,40,0],[112,41,112,91,0],[113,13,113,44,0],[113,45,113,99,0],[116,13,122,43,0],[122,43,122,104,0],[122,104,123,43,0],[123,43,125,111,0],[125,111,125,113,0],[116,13,125,113,0],[126,9,126,10,0],[129,9,129,10,0],[130,13,130,32,0],[130,33,130,75,0],[131,13,131,40,0],[131,41,131,91,0],[132,13,132,44,0],[132,45,132,99,0],[135,13,141,43,0],[141,43,141,104,0],[141,104,142,43,0],[142,43,144,111,0],[144,111,144,113,0],[135,13,144,113,0],[145,9,145,10,0]]);
    </script>
  </body>
</html>