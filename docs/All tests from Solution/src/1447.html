<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Sync\BatchedWebServiceServerMessenger.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using umbraco.interfaces;

namespace Umbraco.Core.Sync
{
    /// &lt;summary&gt;
    /// An &lt;see cref=&quot;IServerMessenger&quot;/&gt; that works by messaging servers via web services.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// Abstract because it needs to be inherited by a class that will
    /// - implement ProcessBatch()
    /// - trigger FlushBatch() when appropriate
    /// &lt;/remarks&gt;
    internal abstract class BatchedWebServiceServerMessenger : WebServiceServerMessenger
    {
        internal BatchedWebServiceServerMessenger()
        {
        }

        internal BatchedWebServiceServerMessenger(string login, string password)
            : base(login, password)
        {
        }

        internal BatchedWebServiceServerMessenger(string login, string password, bool useDistributedCalls)
            : base(login, password, useDistributedCalls)
        {
        }

        protected BatchedWebServiceServerMessenger(Func&lt;Tuple&lt;string, string&gt;&gt; getLoginAndPassword)
            : base(getLoginAndPassword)
        {
        }

        protected abstract ICollection&lt;RefreshInstructionEnvelope&gt; GetBatch(bool ensureHttpContext);

        protected void FlushBatch()
        {
            var batch = GetBatch(false);
            if (batch == null) return;

            var batcha = batch.ToArray();
            batch.Clear();
            if (batcha.Length == 0) return;

            ProcessBatch(batcha);
        }

        // needs to be overriden to actually do something
        protected abstract void ProcessBatch(RefreshInstructionEnvelope[] batch);

        protected override void DeliverRemote(IEnumerable&lt;IServerAddress&gt; servers, ICacheRefresher refresher, MessageType messageType, IEnumerable&lt;object&gt; ids = null, string json = null)
        {
            var idsA = ids == null ? null : ids.ToArray();

            Type arrayType;
            if (GetArrayType(idsA, out arrayType) == false)
                throw new ArgumentException(&quot;All items must be of the same type, either int or Guid.&quot;, &quot;ids&quot;);

            BatchMessage(servers, refresher, messageType, idsA, arrayType, json);
        }

        protected void BatchMessage(
            IEnumerable&lt;IServerAddress&gt; servers,
            ICacheRefresher refresher,
            MessageType messageType,
            IEnumerable&lt;object&gt; ids = null,
            Type idType = null,
            string json = null)
        {
            var batch = GetBatch(true);
            if (batch == null)
                throw new Exception(&quot;Failed to get a batch.&quot;);

            batch.Add(new RefreshInstructionEnvelope(servers, refresher,
                RefreshInstruction.GetInstructions(refresher, messageType, ids, idType, json)));
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,52,0],[19,9,19,10,0],[20,9,20,10,0],[23,15,23,36,0],[24,9,24,10,0],[25,9,25,10,0],[28,15,28,57,0],[29,9,29,10,0],[30,9,30,10,0],[33,15,33,40,0],[34,9,34,10,0],[35,9,35,10,0],[40,9,40,10,0],[41,13,41,41,0],[42,13,42,31,0],[42,32,42,39,0],[44,13,44,42,0],[45,13,45,27,0],[46,13,46,36,0],[46,37,46,44,0],[48,13,48,34,0],[49,9,49,10,0],[55,9,55,10,0],[56,13,56,59,0],[59,13,59,60,0],[60,17,60,111,0],[62,13,62,82,0],[63,9,63,10,0],[72,9,72,10,0],[73,13,73,40,0],[74,13,74,31,0],[75,17,75,63,0],[77,13,78,97,0],[79,9,79,10,0]]);
    </script>
  </body>
</html>