<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\PublishedContent\LegacyExamineBackedMediaTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Lucene.Net.Analysis.Standard;
using Lucene.Net.Documents;
using Lucene.Net.Index;
using Lucene.Net.Store;
using Moq;
using NUnit.Framework;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.UmbracoExamine;
using umbraco.MacroEngines;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence.Mappers;

namespace Umbraco.Tests.PublishedContent
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    public class LegacyExamineBackedMediaTests : ExamineBaseTest
    {
        public override void Initialize()
        {
            base.Initialize();

            var settings = SettingsForTests.GenerateMockSettings();
            var contentMock = Mock.Get(settings.Content);
            contentMock.Setup(x =&gt; x.ForceSafeAliases).Returns(true);
            contentMock.Setup(x =&gt; x.UmbracoLibraryCacheDuration).Returns(1800);
            SettingsForTests.ConfigureSettings(settings);
        }
        
   
        [Test]
        public void Ensure_Children_Are_Sorted()
        {
            using (var luceneDir = new RandomIdRAMDirectory())
            using (var writer = new IndexWriter(luceneDir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29), IndexWriter.MaxFieldLength.LIMITED))
            using (var indexer = IndexInitializer.GetUmbracoIndexer(writer))
            using (var searcher = IndexInitializer.GetUmbracoSearcher(writer))
            {
                //var indexer = IndexInitializer.GetUmbracoIndexer(luceneDir);
                indexer.RebuildIndex();

                //var searcher = IndexInitializer.GetUmbracoSearcher(luceneDir);
                var result = searcher.Search(searcher.CreateSearchCriteria().Id(1111).Compile());
                Assert.IsNotNull(result);
                Assert.AreEqual(1, result.TotalItemCount);

                var searchItem = result.First();
                var backedMedia = new ExamineBackedMedia(searchItem, indexer, searcher);
                var children = backedMedia.ChildrenAsList.Value;

                var currSort = 0;
                Assert.Greater(children.Count, 0);

                for (var i = 0; i &lt; children.Count; i++)
                {
                    Assert.GreaterOrEqual(children[i].SortOrder, currSort);
                    currSort = children[i].SortOrder;
                }
            }

        }

        [Test]
        public void Ensure_Result_Has_All_Values()
        {
            using (var luceneDir = new RandomIdRAMDirectory())
            using (var writer = new IndexWriter(luceneDir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_29), IndexWriter.MaxFieldLength.LIMITED))
            using (var indexer = IndexInitializer.GetUmbracoIndexer(writer))
            using (var searcher = IndexInitializer.GetUmbracoSearcher(writer))
            {
                //var indexer = IndexInitializer.GetUmbracoIndexer(luceneDir);
                indexer.RebuildIndex();

                //var searcher = IndexInitializer.GetUmbracoSearcher(luceneDir);
                var result = searcher.Search(searcher.CreateSearchCriteria().Id(1111).Compile());
                Assert.IsNotNull(result);
                Assert.AreEqual(1, result.TotalItemCount);

                var searchItem = result.First();
                var backedMedia = new ExamineBackedMedia(searchItem, indexer, searcher);

                Assert.AreEqual(searchItem.Id, backedMedia.Id);
                Assert.AreEqual(searchItem.Fields[&quot;sortOrder&quot;], backedMedia.SortOrder.ToString());
                Assert.AreEqual(searchItem.Fields[&quot;urlName&quot;], backedMedia.UrlName);
                Assert.AreEqual(DateTools.StringToDate(searchItem.Fields[&quot;createDate&quot;]), backedMedia.CreateDate);
                Assert.AreEqual(DateTools.StringToDate(searchItem.Fields[&quot;updateDate&quot;]), backedMedia.UpdateDate);
                Assert.AreEqual(Guid.Parse(searchItem.Fields[&quot;version&quot;]), backedMedia.Version);
                Assert.AreEqual(searchItem.Fields[&quot;level&quot;], backedMedia.Level.ToString());
                Assert.AreEqual(searchItem.Fields[&quot;writerID&quot;], backedMedia.WriterID.ToString());
                Assert.AreEqual(searchItem.Fields[&quot;writerID&quot;], backedMedia.CreatorID.ToString()); //there&#39;s only writerId in the xml
                Assert.AreEqual(searchItem.Fields[&quot;writerName&quot;], backedMedia.CreatorName);
                Assert.AreEqual(searchItem.Fields[&quot;writerName&quot;], backedMedia.WriterName); //tehre&#39;s only writer name in the xml
            }

        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,31,1],[25,13,25,68,1],[26,13,26,58,1],[27,13,27,70,1],[28,13,28,81,1],[29,13,29,58,1],[30,9,30,10,1],[35,9,35,10,1],[36,20,36,62,1],[37,20,37,152,1],[38,20,38,76,1],[39,20,39,78,1],[40,13,40,14,1],[42,17,42,40,1],[45,17,45,98,1],[46,17,46,42,1],[47,17,47,59,1],[49,17,49,49,1],[50,17,50,89,1],[51,17,51,65,1],[53,17,53,34,1],[54,17,54,51,1],[56,22,56,31,1],[56,33,56,51,1],[56,53,56,56,1],[57,17,57,18,1],[58,21,58,76,1],[59,21,59,54,1],[60,17,60,18,1],[61,13,61,14,1],[63,9,63,10,1],[67,9,67,10,1],[68,20,68,62,1],[69,20,69,152,1],[70,20,70,76,1],[71,20,71,78,1],[72,13,72,14,1],[74,17,74,40,1],[77,17,77,98,1],[78,17,78,42,1],[79,17,79,59,1],[81,17,81,49,1],[82,17,82,89,1],[84,17,84,64,1],[85,17,85,99,1],[86,17,86,84,1],[87,17,87,114,1],[88,17,88,114,1],[89,17,89,96,1],[90,17,90,91,1],[91,17,91,97,1],[92,17,92,98,1],[93,17,93,91,1],[94,17,94,90,1],[95,13,95,14,1],[97,9,97,10,1]]);
    </script>
  </body>
</html>