<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSeven\AlterTagsTable.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSeven
{
    [Migration(&quot;7.0.0&quot;, 9, GlobalSettings.UmbracoMigrationName)]
    public class AlterTagsTable : MigrationBase
    {
        public AlterTagsTable(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {
            var dbIndexes = SqlSyntax.GetDefinedIndexes(Context.Database)
                .Select(x =&gt; new DbIndexDefinition()
                {
                    TableName = x.Item1,
                    IndexName = x.Item2,
                    ColumnName = x.Item3,
                    IsUnique = x.Item4
                }).ToArray();
            
            //add a foreign key to the parent id column too!

            //In some cases in very old corrupted db&#39;s this will fail, so it means we need to clean the data first
            //set the parentID to NULL where it doesn&#39;t actually exist in the normal ids
            Execute.Sql(@&quot;UPDATE cmsTags SET parentId = NULL WHERE parentId IS NOT NULL AND parentId NOT IN (SELECT id FROM cmsTags)&quot;);

            Create.ForeignKey(&quot;FK_cmsTags_cmsTags&quot;)
                  .FromTable(&quot;cmsTags&quot;)
                  .ForeignColumn(&quot;ParentId&quot;)
                  .ToTable(&quot;cmsTags&quot;)
                  .PrimaryColumn(&quot;id&quot;)
                  .OnDelete(Rule.None)
                  .OnUpdate(Rule.None); 

            //make sure it doesn&#39;t already exist
            if (dbIndexes.Any(x =&gt; x.IndexName.InvariantEquals(&quot;IX_cmsTags&quot;)) == false)
            {
                //add an index to tag/group since it&#39;s queried often
                Create.Index(&quot;IX_cmsTags&quot;).OnTable(&quot;cmsTags&quot;).OnColumn(&quot;tag&quot;).Ascending().OnColumn(&quot;group&quot;).Ascending().WithOptions().NonClustered();
            }
            
        }

        public override void Down()
        {
            throw new DataLossException(&quot;Cannot downgrade from a version 7 database to a prior version, the database schema has already been modified&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,79,14,102,0],[15,9,15,10,0],[16,9,16,10,0],[19,9,19,10,0],[20,13,21,30,0],[21,30,27,18,0],[27,18,27,30,0],[20,13,27,30,0],[33,13,33,136,0],[35,13,41,40,0],[44,13,44,36,0],[44,36,44,77,0],[44,77,44,88,0],[44,13,44,88,0],[45,13,45,14,0],[47,17,47,150,0],[48,13,48,14,0],[50,9,50,10,0],[53,9,53,10,0],[54,13,54,153,0]]);
    </script>
  </body>
</html>