<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\RenderViewEngine.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Web.Mvc;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Web.Models;

namespace Umbraco.Web.Mvc
{
	/// &lt;summary&gt;
	/// A view engine to look into the template location specified in the config for the front-end/Rendering part of the cms,
	/// this includes paths to render partial macros and media item templates.
	/// &lt;/summary&gt;
    public class RenderViewEngine : ReflectedFixedRazorViewEngine
	{

		private readonly IEnumerable&lt;string&gt; _supplementedViewLocations = new[] { &quot;/{0}.cshtml&quot; };
		//NOTE: we will make the main view location the last to be searched since if it is the first to be searched and there is both a view and a partial
		// view in both locations and the main view is rendering a partial view with the same name, we will get a stack overflow exception. 
		// http://issues.umbraco.org/issue/U4-1287, http://issues.umbraco.org/issue/U4-1215
		private readonly IEnumerable&lt;string&gt; _supplementedPartialViewLocations = new[] { &quot;/Partials/{0}.cshtml&quot;, &quot;/MacroPartials/{0}.cshtml&quot;, &quot;/{0}.cshtml&quot; };

		/// &lt;summary&gt;
		/// Constructor
		/// &lt;/summary&gt;
		public RenderViewEngine()
		{
			const string templateFolder = Constants.ViewLocation;

			var replaceWithUmbracoFolder = _supplementedViewLocations.ForEach(location =&gt; templateFolder + location);
			var replacePartialWithUmbracoFolder = _supplementedPartialViewLocations.ForEach(location =&gt; templateFolder + location);

			//The Render view engine doesn&#39;t support Area&#39;s so make those blank
            ViewLocationFormats = replaceWithUmbracoFolder.ToArray();
			PartialViewLocationFormats = replacePartialWithUmbracoFolder.ToArray();

			AreaPartialViewLocationFormats = new string[] { };
			AreaViewLocationFormats = new string[] { };

			EnsureFoldersAndFiles();
		}

		/// &lt;summary&gt;
		/// Ensures that the correct web.config for razor exists in the /Views folder, the partials folder exist and the ViewStartPage exists.
		/// &lt;/summary&gt;
		private void EnsureFoldersAndFiles()
		{
			var viewFolder = IOHelper.MapPath(Constants.ViewLocation);
			//ensure the web.config file is in the ~/Views folder
			Directory.CreateDirectory(viewFolder);
			if (!File.Exists(Path.Combine(viewFolder, &quot;web.config&quot;)))
			{
				using (var writer = File.CreateText(Path.Combine(viewFolder, &quot;web.config&quot;)))
				{
					writer.Write(Strings.WebConfigTemplate);
				}
			}
			//auto create the partials folder
			var partialsFolder = Path.Combine(viewFolder, &quot;Partials&quot;);
			Directory.CreateDirectory(partialsFolder);			

			//We could create a _ViewStart page if it isn&#39;t there as well, but we may not allow editing of this page in the back office.
		}

		public override ViewEngineResult FindView(ControllerContext controllerContext, string viewName, string masterName, bool useCache)
		{
			if (!ShouldFindView(controllerContext, false))
			{
				return new ViewEngineResult(new string[] { });
			}

			return base.FindView(controllerContext, viewName, masterName, useCache);
		}

		public override ViewEngineResult FindPartialView(ControllerContext controllerContext, string partialViewName, bool useCache)
		{
			if (!ShouldFindView(controllerContext, true))
			{
				return new ViewEngineResult(new string[] { });
			}

			return base.FindPartialView(controllerContext, partialViewName, useCache);
		}

		/// &lt;summary&gt;
		/// Determines if the view should be found, this is used for view lookup performance and also to ensure 
		/// less overlap with other user&#39;s view engines. This will return true if the Umbraco back office is rendering
		/// and its a partial view or if the umbraco front-end is rendering but nothing else.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;controllerContext&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;isPartial&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
        private bool ShouldFindView(ControllerContext controllerContext, bool isPartial)
        {
            var umbracoToken = controllerContext.GetDataTokenInViewContextHierarchy(Core.Constants.Web.UmbracoDataToken);

            //first check if we&#39;re rendering a partial view for the back office, or surface controller, etc...
            //anything that is not IUmbracoRenderModel as this should only pertain to Umbraco views.
            if (isPartial &amp;&amp; ((umbracoToken is RenderModel) == false))
            {
                return true;
            }

            //only find views if we&#39;re rendering the umbraco front end
            if (umbracoToken is RenderModel)
            {
                return true;
            }

            return false;
        }

	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,3,18,93,1],[22,3,22,153,1],[27,3,27,28,1],[28,3,28,4,1],[31,4,31,82,1],[31,82,31,107,1],[31,107,31,109,1],[31,4,31,109,1],[32,4,32,96,1],[32,96,32,121,1],[32,121,32,123,1],[32,4,32,123,1],[35,13,35,70,1],[36,4,36,75,1],[38,4,38,54,1],[39,4,39,47,1],[41,4,41,28,1],[42,3,42,4,1],[48,3,48,4,1],[49,4,49,62,1],[51,4,51,42,1],[52,4,52,61,1],[53,4,53,5,1],[54,12,54,80,1],[55,5,55,6,1],[56,6,56,46,1],[57,5,57,6,1],[58,4,58,5,1],[60,4,60,62,1],[61,4,61,46,1],[64,3,64,4,1],[67,3,67,4,0],[68,4,68,50,0],[69,4,69,5,0],[70,5,70,51,0],[73,4,73,76,0],[74,3,74,4,0],[77,3,77,4,0],[78,4,78,49,0],[79,4,79,5,0],[80,5,80,51,0],[83,4,83,78,0],[84,3,84,4,0],[95,9,95,10,0],[96,13,96,122,0],[100,13,100,71,0],[101,13,101,14,0],[102,17,102,29,0],[106,13,106,45,0],[107,13,107,14,0],[108,17,108,29,0],[111,13,111,26,0],[112,9,112,10,0]]);
    </script>
  </body>
</html>