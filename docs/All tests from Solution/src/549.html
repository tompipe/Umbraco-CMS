<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\translation\xml.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;

using System.Xml;
using System.Xml.Schema;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic.task;
using umbraco.cms.businesslogic.web;
using Umbraco.Core.IO;

namespace umbraco.presentation.translation
{
    public partial class xml : BasePages.UmbracoEnsuredPage
    {
        private readonly XmlDocument _xd = new XmlDocument();

        public xml()
        {
            CurrentApp = DefaultApps.translation.ToString();
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            Response.ContentType = &quot;text/xml&quot;;
            int pageId;

            XmlNode root = _xd.CreateElement(&quot;tasks&quot;);

            if (int.TryParse(Request[&quot;id&quot;], out pageId))
            {
                var t = new Task(pageId);
                if (t.User.Id == base.getUser().Id || t.ParentUser.Id == base.getUser().Id)
                {
                    XmlNode x = CreateTaskNode(t, _xd);
                    root.AppendChild(x);

                    xmlContents.Text = root.OuterXml;

                    Response.AddHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=&quot; + t.Node.Text.Replace(&quot; &quot;, &quot;_&quot;) + &quot;.xml&quot;);
                }
            }
            else
            {
                var nodes = new SortedList();
                int totalWords = 0;

                foreach (Task t in Task.GetTasks(base.getUser(), false))
                {
                    if (!nodes.ContainsKey(t.Node.Path))
                    {
                        var xTask = CreateTaskNode(t, _xd);
                        totalWords += int.Parse(xTask.Attributes.GetNamedItem(&quot;TotalWords&quot;).Value);
                        nodes.Add(t.Node.Path, xTask);
                    }
                }

                // Arrange nodes in tree
                var ide = nodes.GetEnumerator();
                while (ide.MoveNext())
                {
                    var x = (XmlElement)ide.Value;
                    var parentXpath = UmbracoConfig.For.UmbracoSettings().Content.UseLegacyXmlSchema ? &quot;//node [@id = &#39;&quot; + x.SelectSingleNode(&quot;//node&quot;).Attributes.GetNamedItem(&quot;parentID&quot;).Value + &quot;&#39;]&quot; :
                        &quot;//* [@isDoc and @id = &#39;&quot; + x.SelectSingleNode(&quot;//* [@isDoc]&quot;).Attributes.GetNamedItem(&quot;parentID&quot;).Value + &quot;&#39;]&quot;;
                    var parent = _xd.SelectSingleNode(parentXpath);

                    if (parent == null)
                        parent = root;
                    else
                        parent = parent.ParentNode;

                    parent.AppendChild((XmlElement)ide.Value);
                }

                root.Attributes.Append(XmlHelper.AddAttribute(_xd, &quot;TotalWords&quot;, totalWords.ToString()));
                xmlContents.Text = root.OuterXml;
                Response.AddHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=all.xml&quot;);

            }
        }

        private XmlElement CreateTaskNode(Task t, XmlDocument xd)
        {
            var d = new Document(t.Node.Id);
            var x = d.ToPreviewXml(xd);//  xd.CreateNode(XmlNodeType.Element, &quot;node&quot;, &quot;&quot;);

            var xTask = xd.CreateElement(&quot;task&quot;);
            xTask.SetAttributeNode(XmlHelper.AddAttribute(xd, &quot;Id&quot;, t.Id.ToString()));
            xTask.SetAttributeNode(XmlHelper.AddAttribute(xd, &quot;Date&quot;, t.Date.ToString(&quot;s&quot;)));
            xTask.SetAttributeNode(XmlHelper.AddAttribute(xd, &quot;NodeId&quot;, t.Node.Id.ToString()));
            xTask.SetAttributeNode(XmlHelper.AddAttribute(xd, &quot;TotalWords&quot;, cms.businesslogic.translation.Translation.CountWords(d.Id).ToString()));
            xTask.AppendChild(XmlHelper.AddCDataNode(xd, &quot;Comment&quot;, t.Comment));
            string protocol = GlobalSettings.UseSSL ? &quot;https&quot; : &quot;http&quot;;
            xTask.AppendChild(XmlHelper.AddTextNode(xd, &quot;PreviewUrl&quot;, protocol + &quot;://&quot; + Request.ServerVariables[&quot;SERVER_NAME&quot;] + SystemDirectories.Umbraco + &quot;/translation/preview.aspx?id=&quot; + t.Id.ToString()));
            //            d.XmlPopulate(xd, ref x, false);
            xTask.AppendChild(x);

            return xTask;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,62,0],[27,9,27,21,0],[28,9,28,10,0],[29,13,29,61,0],[30,9,30,10,0],[33,9,33,10,0],[34,13,34,47,0],[37,13,37,55,0],[39,13,39,57,0],[40,13,40,14,0],[41,17,41,42,0],[42,17,42,92,0],[43,17,43,18,0],[44,21,44,56,0],[45,21,45,41,0],[47,21,47,54,0],[49,21,49,129,0],[50,17,50,18,0],[51,13,51,14,0],[53,13,53,14,0],[54,17,54,46,0],[55,17,55,36,0],[57,17,57,24,0],[57,26,57,32,0],[57,33,57,35,0],[57,36,57,72,0],[58,17,58,18,0],[59,21,59,57,0],[60,21,60,22,0],[61,25,61,60,0],[62,25,62,100,0],[63,25,63,55,0],[64,21,64,22,0],[65,17,65,18,0],[68,17,68,49,0],[69,17,69,39,0],[70,17,70,18,0],[71,21,71,51,0],[72,21,73,137,0],[74,21,74,68,0],[76,21,76,40,0],[77,25,77,39,0],[79,25,79,52,0],[81,21,81,63,0],[82,17,82,18,0],[84,17,84,106,0],[85,17,85,50,0],[86,17,86,91,0],[88,13,88,14,0],[89,9,89,10,0],[92,9,92,10,0],[93,13,93,45,0],[94,13,94,40,0],[96,13,96,50,0],[97,13,97,87,0],[98,13,98,94,0],[99,13,99,96,0],[100,13,100,149,0],[101,13,101,81,0],[102,13,102,72,0],[103,13,103,211,0],[105,13,105,34,0],[107,13,107,26,0],[108,9,108,10,0]]);
    </script>
  </body>
</html>