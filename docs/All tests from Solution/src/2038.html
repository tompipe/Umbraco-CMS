<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Models\Membership\User.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Collections.Specialized;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization;
using Umbraco.Core.Configuration;
using Umbraco.Core.Models.EntityBase;


namespace Umbraco.Core.Models.Membership
{
    /// &lt;summary&gt;
    /// Represents a backoffice user
    /// &lt;/summary&gt;    
    [Serializable]
    [DataContract(IsReference = true)]
    public class User : Entity, IUser
    {
        public User(IUserType userType)
        {
            if (userType == null) throw new ArgumentNullException(&quot;userType&quot;);

            _userType = userType;
            _defaultPermissions = _userType.Permissions == null ? Enumerable.Empty&lt;string&gt;() : new List&lt;string&gt;(_userType.Permissions);
            //Groups = new List&lt;object&gt; { userType };
            SessionTimeout = 60;
            _sectionCollection = new ObservableCollection&lt;string&gt;();
            _addedSections = new List&lt;string&gt;();
            _removedSections = new List&lt;string&gt;();
            _language = GlobalSettings.DefaultUILanguage;
            _sectionCollection.CollectionChanged += SectionCollectionChanged;
            _isApproved = true;
            _isLockedOut = false;
            _startContentId = -1;
            _startMediaId = -1;
            //cannot be null
            _rawPasswordValue = &quot;&quot;;
        }

        public User(string name, string email, string username, string rawPasswordValue, IUserType userType)
            : this(userType)
        {
            _name = name;
            _email = email;
            _username = username;
            _rawPasswordValue = rawPasswordValue;
            _isApproved = true;
            _isLockedOut = false;
            _startContentId = -1;
            _startMediaId = -1;
        }

        private IUserType _userType;
        private string _name;
        private string _securityStamp;
        private List&lt;string&gt; _addedSections;
        private List&lt;string&gt; _removedSections;
        private ObservableCollection&lt;string&gt; _sectionCollection;
        private int _sessionTimeout;
        private int _startContentId;
        private int _startMediaId;
        private int _failedLoginAttempts;

        private string _username;
        private string _email;
        private string _rawPasswordValue;
        private bool _isApproved;
        private bool _isLockedOut;
        private string _language;
        private DateTime _lastPasswordChangedDate;
        private DateTime _lastLoginDate;
        private DateTime _lastLockoutDate;

        private IEnumerable&lt;string&gt; _defaultPermissions; 
        
        private bool _defaultToLiveEditing;

        private static readonly Lazy&lt;PropertySelectors&gt; Ps = new Lazy&lt;PropertySelectors&gt;();

        private class PropertySelectors
        {
            public readonly PropertyInfo FailedPasswordAttemptsSelector = ExpressionHelper.GetPropertyInfo&lt;User, int&gt;(x =&gt; x.FailedPasswordAttempts);
            public readonly PropertyInfo LastLockoutDateSelector = ExpressionHelper.GetPropertyInfo&lt;User, DateTime&gt;(x =&gt; x.LastLockoutDate);
            public readonly PropertyInfo LastLoginDateSelector = ExpressionHelper.GetPropertyInfo&lt;User, DateTime&gt;(x =&gt; x.LastLoginDate);
            public readonly PropertyInfo LastPasswordChangeDateSelector = ExpressionHelper.GetPropertyInfo&lt;User, DateTime&gt;(x =&gt; x.LastPasswordChangeDate);

            public readonly PropertyInfo SecurityStampSelector = ExpressionHelper.GetPropertyInfo&lt;User, string&gt;(x =&gt; x.SecurityStamp);
            public readonly PropertyInfo SessionTimeoutSelector = ExpressionHelper.GetPropertyInfo&lt;User, int&gt;(x =&gt; x.SessionTimeout);
            public readonly PropertyInfo StartContentIdSelector = ExpressionHelper.GetPropertyInfo&lt;User, int&gt;(x =&gt; x.StartContentId);
            public readonly PropertyInfo StartMediaIdSelector = ExpressionHelper.GetPropertyInfo&lt;User, int&gt;(x =&gt; x.StartMediaId);
            public readonly PropertyInfo AllowedSectionsSelector = ExpressionHelper.GetPropertyInfo&lt;User, IEnumerable&lt;string&gt;&gt;(x =&gt; x.AllowedSections);
            public readonly PropertyInfo NameSelector = ExpressionHelper.GetPropertyInfo&lt;User, string&gt;(x =&gt; x.Name);

            public readonly PropertyInfo UsernameSelector = ExpressionHelper.GetPropertyInfo&lt;User, string&gt;(x =&gt; x.Username);
            public readonly PropertyInfo EmailSelector = ExpressionHelper.GetPropertyInfo&lt;User, string&gt;(x =&gt; x.Email);
            public readonly PropertyInfo PasswordSelector = ExpressionHelper.GetPropertyInfo&lt;User, string&gt;(x =&gt; x.RawPasswordValue);
            public readonly PropertyInfo IsLockedOutSelector = ExpressionHelper.GetPropertyInfo&lt;User, bool&gt;(x =&gt; x.IsLockedOut);
            public readonly PropertyInfo IsApprovedSelector = ExpressionHelper.GetPropertyInfo&lt;User, bool&gt;(x =&gt; x.IsApproved);
            public readonly PropertyInfo LanguageSelector = ExpressionHelper.GetPropertyInfo&lt;User, string&gt;(x =&gt; x.Language);

            public readonly PropertyInfo DefaultToLiveEditingSelector = ExpressionHelper.GetPropertyInfo&lt;User, bool&gt;(x =&gt; x.DefaultToLiveEditing);
            public readonly PropertyInfo UserTypeSelector = ExpressionHelper.GetPropertyInfo&lt;User, IUserType&gt;(x =&gt; x.UserType);
        }
        
        #region Implementation of IMembershipUser

        [IgnoreDataMember]
        public object ProviderUserKey
        {
            get { return Id; }
            set { throw new NotSupportedException(&quot;Cannot set the provider user key for a user&quot;); }
        }


        [DataMember]
        public string Username
        {
            get { return _username; }
            set { SetPropertyValueAndDetectChanges(value, ref _username, Ps.Value.UsernameSelector); }
        }
        [DataMember]
        public string Email
        {
            get { return _email; }
            set { SetPropertyValueAndDetectChanges(value, ref _email, Ps.Value.EmailSelector); }
        }
        [DataMember]
        public string RawPasswordValue
        {
            get { return _rawPasswordValue; }
            set { SetPropertyValueAndDetectChanges(value, ref _rawPasswordValue, Ps.Value.PasswordSelector); }
        }

        [DataMember]
        public bool IsApproved
        {
            get { return _isApproved; }
            set { SetPropertyValueAndDetectChanges(value, ref _isApproved, Ps.Value.IsApprovedSelector); }
        }

        [IgnoreDataMember]
        public bool IsLockedOut
        {
            get { return _isLockedOut; }
            set { SetPropertyValueAndDetectChanges(value, ref _isLockedOut, Ps.Value.IsLockedOutSelector); }
        }

        [IgnoreDataMember]
        public DateTime LastLoginDate
        {
            get { return _lastLoginDate; }
            set { SetPropertyValueAndDetectChanges(value, ref _lastLoginDate, Ps.Value.LastLoginDateSelector); }
        }

        [IgnoreDataMember]
        public DateTime LastPasswordChangeDate
        {
            get { return _lastPasswordChangedDate; }
            set { SetPropertyValueAndDetectChanges(value, ref _lastPasswordChangedDate, Ps.Value.LastPasswordChangeDateSelector); }
        }

        [IgnoreDataMember]
        public DateTime LastLockoutDate
        {
            get { return _lastLockoutDate; }
            set { SetPropertyValueAndDetectChanges(value, ref _lastLockoutDate, Ps.Value.LastLockoutDateSelector); }
        }

        [IgnoreDataMember]
        public int FailedPasswordAttempts
        {
            get { return _failedLoginAttempts; }
            set { SetPropertyValueAndDetectChanges(value, ref _failedLoginAttempts, Ps.Value.FailedPasswordAttemptsSelector); }
        }

        //TODO: Figure out how to support all of this! - we cannot have NotImplementedExceptions because these get used by the IMembershipMemberService&lt;IUser&gt; service so
        // we&#39;ll just have them as generic get/set which don&#39;t interact with the db.

        [IgnoreDataMember]
        public string PasswordQuestion { get; set; }
        [IgnoreDataMember]
        public string RawPasswordAnswerValue { get; set; }
        [IgnoreDataMember]
        public string Comments { get; set; }               
        
        #endregion
        
        #region Implementation of IUser

        [DataMember]
        public string Name
        {
            get { return _name; }
            set { SetPropertyValueAndDetectChanges(value, ref _name, Ps.Value.NameSelector); }
        }

        public IEnumerable&lt;string&gt; AllowedSections
        {
            get { return _sectionCollection; }
        }

        public void RemoveAllowedSection(string sectionAlias)
        {
            if (_sectionCollection.Contains(sectionAlias))
            {
                _sectionCollection.Remove(sectionAlias);
            }
        }

        public void AddAllowedSection(string sectionAlias)
        {
            if (_sectionCollection.Contains(sectionAlias) == false)
            {
                _sectionCollection.Add(sectionAlias);
            }
        }

        public IProfile ProfileData
        {
            get { return new UserProfile(this); }
        }

        /// &lt;summary&gt;
        /// The security stamp used by ASP.Net identity
        /// &lt;/summary&gt;
        [IgnoreDataMember]
        public string SecurityStamp
        {
            get { return _securityStamp; }
            set { SetPropertyValueAndDetectChanges(value, ref _securityStamp, Ps.Value.SecurityStampSelector); }
        }

        /// &lt;summary&gt;
        /// Used internally to check if we need to add a section in the repository to the db
        /// &lt;/summary&gt;
        internal IEnumerable&lt;string&gt; AddedSections
        {
            get { return _addedSections; }
        }

        /// &lt;summary&gt;
        /// Used internally to check if we need to remove  a section in the repository to the db
        /// &lt;/summary&gt;
        internal IEnumerable&lt;string&gt; RemovedSections
        {
            get { return _removedSections; }
        }

        /// &lt;summary&gt;
        /// Gets or sets the session timeout.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// The session timeout.
        /// &lt;/value&gt;
        [DataMember]
        public int SessionTimeout
        {
            get { return _sessionTimeout; }
            set { SetPropertyValueAndDetectChanges(value, ref _sessionTimeout, Ps.Value.SessionTimeoutSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the start content id.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// The start content id.
        /// &lt;/value&gt;
        [DataMember]
        public int StartContentId
        {
            get { return _startContentId; }
            set { SetPropertyValueAndDetectChanges(value, ref _startContentId, Ps.Value.StartContentIdSelector); }
        }

        /// &lt;summary&gt;
        /// Gets or sets the start media id.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// The start media id.
        /// &lt;/value&gt;
        [DataMember]
        public int StartMediaId
        {
            get { return _startMediaId; }
            set { SetPropertyValueAndDetectChanges(value, ref _startMediaId, Ps.Value.StartMediaIdSelector); }
        }

        [DataMember]
        public string Language
        {
            get { return _language; }
            set { SetPropertyValueAndDetectChanges(value, ref _language, Ps.Value.LanguageSelector); }
        }

        //TODO: This should be a private set
        [DataMember]
        public IEnumerable&lt;string&gt; DefaultPermissions
        {
            get {  return _defaultPermissions;}
            set { _defaultPermissions = value; }
        }

        [IgnoreDataMember]
        internal bool DefaultToLiveEditing
        {
            get { return _defaultToLiveEditing; }
            set { SetPropertyValueAndDetectChanges(value, ref _defaultToLiveEditing, Ps.Value.DefaultToLiveEditingSelector); }
        }

        [IgnoreDataMember]
        public IUserType UserType
        {
            get { return _userType; }
            set
            {
                if (value.HasIdentity == false)
                {
                    throw new InvalidOperationException(&quot;Cannot assign a User Type that has not been persisted&quot;);
                }

                SetPropertyValueAndDetectChanges(value, ref _userType, Ps.Value.UserTypeSelector);                
            }
        }

        #endregion

        /// &lt;summary&gt;
        /// Whenever resetting occurs, clear the remembered add/removed collections, even if 
        /// rememberPreviouslyChangedProperties is true, the AllowedSections property will still
        /// be flagged as dirty.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;rememberPreviouslyChangedProperties&quot;&gt;&lt;/param&gt;
        public override void ResetDirtyProperties(bool rememberPreviouslyChangedProperties)
        {
            _addedSections.Clear();
            _removedSections.Clear();
            base.ResetDirtyProperties(rememberPreviouslyChangedProperties);
        }

        /// &lt;summary&gt;
        /// Handles the collection changed event in order for us to flag the AllowedSections property as changed
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        void SectionCollectionChanged(object sender, NotifyCollectionChangedEventArgs e)
        {
            OnPropertyChanged(Ps.Value.AllowedSectionsSelector);

            if (e.Action == NotifyCollectionChangedAction.Add)
            {
                var item = e.NewItems.Cast&lt;string&gt;().First();

                if (_addedSections.Contains(item) == false)
                {
                    _addedSections.Add(item);
                }
            }
            else if (e.Action == NotifyCollectionChangedAction.Remove)
            {
                var item = e.OldItems.Cast&lt;string&gt;().First();

                if (_removedSections.Contains(item) == false)
                {
                    _removedSections.Add(item);    
                }

            }
        }

        public override object DeepClone()
        {
            var clone = (User)base.DeepClone();
            //turn off change tracking
            clone.DisableChangeTracking();
            //need to create new collections otherwise they&#39;ll get copied by ref
            clone._addedSections = new List&lt;string&gt;();
            clone._removedSections = new List&lt;string&gt;();
            clone._sectionCollection = new ObservableCollection&lt;string&gt;(_sectionCollection.ToList());
            clone._defaultPermissions = new List&lt;string&gt;(_defaultPermissions.ToList());
            //re-create the event handler
            clone._sectionCollection.CollectionChanged += clone.SectionCollectionChanged;
            //this shouldn&#39;t really be needed since we&#39;re not tracking
            clone.ResetDirtyProperties(false);
            //re-enable tracking
            clone.EnableChangeTracking();

            return clone;
        }

        /// &lt;summary&gt;
        /// Internal class used to wrap the user in a profile
        /// &lt;/summary&gt;
        private class UserProfile : IProfile
        {
            private readonly IUser _user;

            public UserProfile(IUser user)
            {
                _user = user;
            }

            public object Id
            {
                get { return _user.Id; }
                set { _user.Id = (int)value; }
            }

            public string Name
            {
                get { return _user.Name; }
                set { _user.Name = value; }
            }

            protected bool Equals(UserProfile other)
            {
                return _user.Equals(other._user);
            }

            public override bool Equals(object obj)
            {
                if (ReferenceEquals(null, obj)) return false;
                if (ReferenceEquals(this, obj)) return true;
                if (obj.GetType() != this.GetType()) return false;
                return Equals((UserProfile) obj);
            }

            public override int GetHashCode()
            {
                return _user.GetHashCode();
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,40,1],[22,9,22,10,1],[23,13,23,34,1],[23,35,23,79,0],[25,13,25,34,1],[26,13,26,136,1],[28,13,28,33,1],[29,13,29,69,1],[30,13,30,49,1],[31,13,31,51,1],[32,13,32,58,1],[33,13,33,78,1],[34,13,34,32,1],[35,13,35,34,1],[36,13,36,34,1],[37,13,37,32,1],[39,13,39,36,1],[40,9,40,10,1],[43,15,43,29,1],[44,9,44,10,1],[45,13,45,26,1],[46,13,46,28,1],[47,13,47,34,1],[48,13,48,50,1],[49,13,49,32,1],[50,13,50,34,1],[51,13,51,34,1],[52,13,52,32,1],[53,9,53,10,1],[80,9,80,92,1],[84,13,84,150,1],[85,13,85,141,1],[86,13,86,137,1],[87,13,87,155,1],[89,13,89,135,1],[90,13,90,134,1],[91,13,91,134,1],[92,13,92,130,1],[93,13,93,152,1],[94,13,94,117,1],[96,13,96,125,1],[97,13,97,119,1],[98,13,98,133,1],[99,13,99,129,1],[100,13,100,127,1],[101,13,101,125,1],[103,13,103,147,1],[104,13,104,128,1],[112,17,112,18,1],[112,19,112,29,1],[112,30,112,31,1],[113,17,113,18,0],[113,19,113,98,0],[120,17,120,18,1],[120,19,120,36,1],[120,37,120,38,1],[121,17,121,18,1],[121,19,121,101,1],[121,102,121,103,1],[126,17,126,18,1],[126,19,126,33,1],[126,34,126,35,1],[127,17,127,18,1],[127,19,127,95,1],[127,96,127,97,1],[132,17,132,18,1],[132,19,132,44,1],[132,45,132,46,1],[133,17,133,18,1],[133,19,133,109,1],[133,110,133,111,1],[139,17,139,18,1],[139,19,139,38,1],[139,39,139,40,1],[140,17,140,18,1],[140,19,140,105,1],[140,106,140,107,1],[146,17,146,18,1],[146,19,146,39,1],[146,40,146,41,1],[147,17,147,18,1],[147,19,147,107,1],[147,108,147,109,1],[153,17,153,18,1],[153,19,153,41,1],[153,42,153,43,1],[154,17,154,18,1],[154,19,154,111,1],[154,112,154,113,1],[160,17,160,18,1],[160,19,160,51,1],[160,52,160,53,1],[161,17,161,18,1],[161,19,161,130,1],[161,131,161,132,1],[167,17,167,18,1],[167,19,167,43,1],[167,44,167,45,1],[168,17,168,18,1],[168,19,168,115,1],[168,116,168,117,1],[174,17,174,18,1],[174,19,174,47,1],[174,48,174,49,1],[175,17,175,18,1],[175,19,175,126,1],[175,127,175,128,1],[182,42,182,46,1],[182,47,182,51,1],[184,48,184,52,1],[184,53,184,57,0],[186,34,186,38,1],[186,39,186,43,1],[195,17,195,18,1],[195,19,195,32,1],[195,33,195,34,1],[196,17,196,18,1],[196,19,196,93,1],[196,94,196,95,1],[201,17,201,18,1],[201,19,201,45,1],[201,46,201,47,1],[205,9,205,10,1],[206,13,206,59,1],[207,13,207,14,1],[208,17,208,57,1],[209,13,209,14,1],[210,9,210,10,1],[213,9,213,10,1],[214,13,214,68,1],[215,13,215,14,1],[216,17,216,54,1],[217,13,217,14,1],[218,9,218,10,1],[222,17,222,18,1],[222,19,222,48,1],[222,49,222,50,1],[231,17,231,18,1],[231,19,231,41,1],[231,42,231,43,1],[232,17,232,18,1],[232,19,232,111,1],[232,112,232,113,1],[240,17,240,18,1],[240,19,240,41,1],[240,42,240,43,1],[248,17,248,18,1],[248,19,248,43,1],[248,44,248,45,1],[260,17,260,18,1],[260,19,260,42,1],[260,43,260,44,1],[261,17,261,18,1],[261,19,261,113,1],[261,114,261,115,1],[273,17,273,18,1],[273,19,273,42,1],[273,43,273,44,1],[274,17,274,18,1],[274,19,274,113,1],[274,114,274,115,1],[286,17,286,18,1],[286,19,286,40,1],[286,41,286,42,1],[287,17,287,18,1],[287,19,287,109,1],[287,110,287,111,1],[293,17,293,18,1],[293,19,293,36,1],[293,37,293,38,1],[294,17,294,18,1],[294,19,294,101,1],[294,102,294,103,1],[301,17,301,18,1],[301,20,301,47,1],[301,47,301,48,1],[302,17,302,18,1],[302,19,302,47,1],[302,48,302,49,1],[308,17,308,18,0],[308,19,308,48,0],[308,49,308,50,0],[309,17,309,18,1],[309,19,309,125,1],[309,126,309,127,1],[315,17,315,18,1],[315,19,315,36,1],[315,37,315,38,1],[317,13,317,14,1],[318,17,318,48,1],[319,17,319,18,0],[320,21,320,114,0],[323,17,323,99,1],[324,13,324,14,1],[336,9,336,10,1],[337,13,337,36,1],[338,13,338,38,1],[339,13,339,76,1],[340,9,340,10,1],[348,9,348,10,1],[349,13,349,65,1],[351,13,351,63,1],[352,13,352,14,1],[353,17,353,62,1],[355,17,355,60,1],[356,17,356,18,1],[357,21,357,46,1],[358,17,358,18,1],[359,13,359,14,1],[360,18,360,71,1],[361,13,361,14,1],[362,17,362,62,1],[364,17,364,62,1],[365,17,365,18,1],[366,21,366,48,1],[367,17,367,18,1],[369,13,369,14,1],[370,9,370,10,1],[373,9,373,10,1],[374,13,374,48,1],[376,13,376,43,1],[378,13,378,55,1],[379,13,379,57,1],[380,13,380,102,1],[381,13,381,88,1],[383,13,383,90,1],[385,13,385,47,1],[387,13,387,42,1],[389,13,389,26,1],[390,9,390,10,1],[399,13,399,43,1],[400,13,400,14,1],[401,17,401,30,1],[402,13,402,14,1],[406,21,406,22,1],[406,23,406,39,1],[406,40,406,41,1],[407,21,407,22,0],[407,23,407,45,0],[407,46,407,47,0],[412,21,412,22,1],[412,23,412,41,1],[412,42,412,43,1],[413,21,413,22,0],[413,23,413,42,0],[413,43,413,44,0],[417,13,417,14,1],[418,17,418,50,1],[419,13,419,14,1],[422,13,422,14,1],[423,17,423,48,1],[423,49,423,62,0],[424,17,424,48,1],[424,49,424,61,0],[425,17,425,53,1],[425,54,425,67,0],[426,17,426,50,1],[427,13,427,14,1],[430,13,430,14,1],[431,17,431,44,1],[432,13,432,14,1]]);
    </script>
  </body>
</html>