<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\imagecropper\ImageManipulation.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Drawing.Drawing2D;
using System.Drawing.Imaging;
using System.Drawing;
using Umbraco.Core.IO;
using System.IO;


namespace umbraco.editorControls.imagecropper
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class ImageTransform
    {
        private static readonly MediaFileSystem _fs = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();

        public static void Execute(string sourceFile, string name, int cropX, int cropY, int cropWidth, int cropHeight, int sizeWidth, int sizeHeight, long quality)
        {

            if (!_fs.FileExists(sourceFile)) return;


            string path = string.Empty;

            //http or local filesystem
            if (sourceFile.Contains(&quot;/&quot;))
                path = sourceFile.Substring(0, sourceFile.LastIndexOf(&#39;/&#39;));
            else
                path = sourceFile.Substring(0, sourceFile.LastIndexOf(&#39;\\&#39;));

            // TODO: Make configurable and move to imageInfo
            //if(File.Exists(String.Format(@&quot;{0}\{1}.jpg&quot;, path, name))) return;

            //Do we need this check as we are always working with images that are already in a folder??
            //DirectoryInfo di = new DirectoryInfo(path);
            //if (!di.Exists) di.Create();

            using (var stream = _fs.OpenFile(sourceFile))
            using (var image = Image.FromStream(stream))
            using (var croppedImage = CropImage(image, new Rectangle(cropX, cropY, cropWidth, cropHeight)))
            using (var resizedImage = ResizeImage(croppedImage, new Size(sizeWidth, sizeHeight)))
            using (var b = new Bitmap(resizedImage))
            {
                SaveJpeg(String.Format(&quot;{0}/{1}.jpg&quot;, path, name), b, quality);
            }
           
        }

        private static void SaveJpeg(string path, Bitmap img, long quality)
        {
            // Encoder parameter for image quality
            EncoderParameter qualityParam = new EncoderParameter(Encoder.Quality, quality);

            // Jpeg image codec
            ImageCodecInfo jpegCodec = GetEncoderInfo(&quot;image/jpeg&quot;);

            if (jpegCodec == null)
                return;

            EncoderParameters encoderParams = new EncoderParameters(1);
            encoderParams.Param[0] = qualityParam;

            using (var fileStream = new MemoryStream())
            {
                img.Save(fileStream, jpegCodec, encoderParams);
                fileStream.Position = 0;
                _fs.AddFile(path, fileStream, true);    
            }

        }

        private static ImageCodecInfo GetEncoderInfo(string mimeType)
        {
            // Get image codecs for all image formats
            ImageCodecInfo[] codecs = ImageCodecInfo.GetImageEncoders();

            // Find the correct image codec
            for (int i = 0; i &lt; codecs.Length; i++)
                if (codecs[i].MimeType == mimeType)
                    return codecs[i];
            return null;
        }

        private static Image CropImage(Image img, Rectangle cropArea)
        {
            if (cropArea.Right &gt; img.Width)
                cropArea.Width -= (cropArea.Right - img.Width);

            if (cropArea.Bottom &gt; img.Height)
                cropArea.Height -= (cropArea.Bottom - img.Height);

            var bmpCrop = new Bitmap(cropArea.Width, cropArea.Height);

            using (var graphics = Graphics.FromImage(bmpCrop))
            {
                graphics.DrawImage(img, new Rectangle(0, 0, bmpCrop.Width, bmpCrop.Height), cropArea, GraphicsUnit.Pixel);
            }

            return bmpCrop;
        }

        private static Image ResizeImage(Image imgToResize, Size size)
        {
            int destWidth = size.Width;
            int destHeight = size.Height;

            Bitmap b = new Bitmap(destWidth, destHeight);

            using (var ia = new ImageAttributes())
            {
                ia.SetWrapMode(WrapMode.TileFlipXY);

                using (Graphics g = Graphics.FromImage(b))
                {
                    g.PixelOffsetMode = PixelOffsetMode.HighQuality;
                    g.Clear(Color.White);
                    g.InterpolationMode = InterpolationMode.HighQualityBicubic;
                    g.CompositingQuality = CompositingQuality.HighQuality;
                    g.SmoothingMode = SmoothingMode.HighQuality;
                    g.DrawImage(imgToResize, new Rectangle(0, 0, destWidth, destHeight), 0, 0, imgToResize.Width,
                                imgToResize.Height, GraphicsUnit.Pixel, ia);

                    ia.Dispose();
                }
            }
            

            return b;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,9,14,130,0],[17,9,17,10,0],[19,13,19,45,0],[19,46,19,53,0],[22,13,22,40,0],[25,13,25,42,0],[26,17,26,77,0],[28,17,28,78,0],[37,20,37,57,0],[38,20,38,56,0],[39,20,39,107,0],[40,20,40,97,0],[41,20,41,52,0],[42,13,42,14,0],[43,17,43,80,0],[44,13,44,14,0],[46,9,46,10,0],[49,9,49,10,0],[51,13,51,92,0],[54,13,54,69,0],[56,13,56,35,0],[57,17,57,24,0],[59,13,59,72,0],[60,13,60,51,0],[62,20,62,55,0],[63,13,63,14,0],[64,17,64,64,0],[65,17,65,41,0],[66,17,66,53,0],[67,13,67,14,0],[69,9,69,10,0],[72,9,72,10,0],[74,13,74,73,0],[77,18,77,27,0],[77,29,77,46,0],[77,48,77,51,0],[78,17,78,52,0],[79,21,79,38,0],[80,13,80,25,0],[81,9,81,10,0],[84,9,84,10,0],[85,13,85,44,0],[86,17,86,64,0],[88,13,88,46,0],[89,17,89,67,0],[91,13,91,71,0],[93,20,93,62,0],[94,13,94,14,0],[95,17,95,123,0],[96,13,96,14,0],[98,13,98,28,0],[99,9,99,10,0],[102,9,102,10,0],[103,13,103,40,0],[104,13,104,42,0],[106,13,106,58,0],[108,20,108,50,0],[109,13,109,14,0],[110,17,110,53,0],[112,24,112,58,0],[113,17,113,18,0],[114,21,114,69,0],[115,21,115,42,0],[116,21,116,80,0],[117,21,117,75,0],[118,21,118,65,0],[119,21,120,77,0],[122,21,122,34,0],[123,17,123,18,0],[124,13,124,14,0],[127,13,127,22,0],[128,9,128,10,0]]);
    </script>
  </body>
</html>