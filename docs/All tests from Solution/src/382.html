<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Migrations\MigrationIssuesTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.Linq;
using Moq;
using NUnit.Framework;
using Semver;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSeven;
using Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSevenFiveZero;
using Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSix;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers;
using GlobalSettings = Umbraco.Core.Configuration.GlobalSettings;

namespace Umbraco.Tests.Migrations
{
    [TestFixture]
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    public class MigrationIssuesTests : BaseDatabaseFactoryTest
    {
        [Test]
        public void Issue8370Test()
        {
            // fixme maybe we need to create some content?
            // yes otherwise cannot get it to fail!

            var n = new NodeDto
            {
                Text = &quot;text&quot;,
                CreateDate = DateTime.Now,
                Path = &quot;-1&quot;,
                ParentId = -1,
                UniqueId = Guid.NewGuid()
            };
            DatabaseContext.Database.Insert(n);
            var ct = new ContentTypeDto
            {
                Alias = &quot;alias&quot;,
                NodeId = n.NodeId,
                Thumbnail = &quot;thumb&quot;
            };
            DatabaseContext.Database.Insert(ct);
            n = new NodeDto
            {
                Text = &quot;text&quot;,
                CreateDate = DateTime.Now,
                Path = &quot;-1&quot;,
                ParentId = -1,
                UniqueId = Guid.NewGuid()
            };
            DatabaseContext.Database.Insert(n);
            var dt = new DataTypeDto
            {
                PropertyEditorAlias = Constants.PropertyEditors.RelatedLinksAlias,
                DbType = &quot;x&quot;,
                DataTypeId = n.NodeId
            };
            DatabaseContext.Database.Insert(dt);
            var pt = new PropertyTypeDto
            {
                Alias = &quot;alias&quot;,
                ContentTypeId = ct.NodeId,
                DataTypeId = dt.DataTypeId
            };
            DatabaseContext.Database.Insert(pt);
            n = new NodeDto
            {
                Text = &quot;text&quot;,
                CreateDate = DateTime.Now,
                Path = &quot;-1&quot;,
                ParentId = -1,
                UniqueId = Guid.NewGuid()
            };
            DatabaseContext.Database.Insert(n);
            var data = new PropertyDataDto
            {
                NodeId = n.NodeId,
                PropertyTypeId = pt.Id,
                Text = &quot;text&quot;,
                VersionId = Guid.NewGuid()
            };
            DatabaseContext.Database.Insert(data);
            data = new PropertyDataDto
            {
                NodeId = n.NodeId,
                PropertyTypeId = pt.Id,
                Text = &quot;&lt;root&gt;&lt;node title=\&quot;\&quot; type=\&quot;\&quot; newwindow=\&quot;\&quot; link=\&quot;\&quot; /&gt;&lt;/root&gt;&quot;,
                VersionId = Guid.NewGuid()
            };
            DatabaseContext.Database.Insert(data);

            var migration = new UpdateRelatedLinksData(SqlSyntax, Logger);
            migration.UpdateRelatedLinksDataDo(DatabaseContext.Database);

            data = DatabaseContext.Database.Fetch&lt;PropertyDataDto&gt;(&quot;SELECT * FROM cmsPropertyData WHERE id=&quot; + data.Id).FirstOrDefault();
            Assert.IsNotNull(data);
            Debug.Print(data.Text);
            Assert.AreEqual(&quot;[{\&quot;title\&quot;:\&quot;\&quot;,\&quot;caption\&quot;:\&quot;\&quot;,\&quot;link\&quot;:\&quot;\&quot;,\&quot;newWindow\&quot;:false,\&quot;type\&quot;:\&quot;external\&quot;,\&quot;internal\&quot;:null,\&quot;edit\&quot;:false,\&quot;isInternal\&quot;:false}]&quot;,
                data.Text);
        }

        [Test]
        public void Issue8361Test()
        {
            var logger = new DebugDiagnosticsLogger();

            //Setup the MigrationRunner
            var migrationRunner = new MigrationRunner(
                Mock.Of&lt;IMigrationEntryService&gt;(),
                logger,
                new SemVersion(7, 4, 0),
                new SemVersion(7, 5, 0),
                GlobalSettings.UmbracoMigrationName,

                //pass in explicit migrations
                new DeleteRedirectUrlTable(SqlSyntax, logger),
                new AddRedirectUrlTable(SqlSyntax, logger)
            );

            var db = new UmbracoDatabase(&quot;Datasource=|DataDirectory|UmbracoPetaPocoTests.sdf;Flush Interval=1;&quot;, Constants.DatabaseProviders.SqlCe, Logger);

            var upgraded = migrationRunner.Execute(db, DatabaseProviders.SqlServerCE, true);
            Assert.IsTrue(upgraded);
        }

        [Migration(&quot;7.5.0&quot;, 99, GlobalSettings.UmbracoMigrationName)]
        public class DeleteRedirectUrlTable : MigrationBase
        {
            public DeleteRedirectUrlTable(ISqlSyntaxProvider sqlSyntax, ILogger logger)
                : base(sqlSyntax, logger)
            { }

            public override void Up()
            {
                Delete.Table(&quot;umbracoRedirectUrl&quot;);
            }

            public override void Down()
            { }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,1],[32,13,39,15,1],[40,13,40,48,1],[41,13,46,15,1],[47,13,47,49,1],[48,13,55,15,1],[56,13,56,48,1],[57,13,62,15,1],[63,13,63,49,1],[64,13,69,15,1],[70,13,70,49,1],[71,13,78,15,1],[79,13,79,48,1],[80,13,86,15,1],[87,13,87,51,1],[88,13,94,15,1],[95,13,95,51,1],[97,13,97,75,1],[98,13,98,74,1],[100,13,100,138,1],[101,13,101,36,1],[102,13,102,36,1],[103,13,104,28,1],[105,9,105,10,1],[109,9,109,10,1],[110,13,110,55,1],[113,13,123,15,1],[125,13,125,157,1],[127,13,127,93,1],[128,13,128,37,1],[129,9,129,10,1],[135,19,135,42,1],[136,13,136,14,1],[136,15,136,16,1],[139,13,139,14,1],[140,17,140,52,1],[141,13,141,14,1],[144,13,144,14,0],[144,15,144,16,0]]);
    </script>
  </body>
</html>