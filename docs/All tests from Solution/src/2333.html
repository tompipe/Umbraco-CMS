<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.MacroEngines\RazorDynamicNode\DynamicNodeListOrdering.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Linq.Expressions;

namespace umbraco.MacroEngines
{
    public static class DynamicNodeListOrdering
    {

        private static TOut Reduce&lt;TOut&gt;(Func&lt;DynamicNode, TOut&gt; func, DynamicNode node)
        {
            var value = func(node);
            while (value is Func&lt;DynamicNode, TOut&gt;)
            {
                value = (value as Func&lt;DynamicNode, TOut&gt;)(node);
            }
            //when you&#39;re sorting a list of properties
            //and one of those properties doesn&#39;t exist, it will come back as DynamicNull
            //when that gets handled by the expression tree parser, it&#39;s converted to be false
            //which lets .Where work properly with e.g. umbracoNaviHide which may not be defined
            //on all properties
            //this checks to see if the type of value is bool, and if it is, and it&#39;s false
            //then return false
            //in a case where Reduce&lt;bool&gt; is being called, this will return false, which is the 
            //same as the actual real value
            //but when Reduce&lt;object&gt; [a dynamicnode dynamic property call] is called
            //it will result in null, (because default(object) is null) 
            //which will cause the item with the missing property to sort up to the top of the list
            if (value.GetType() == typeof(bool) &amp;&amp; !((value as bool?) ?? false))
            {
                return default(TOut);
            }
            if (value.GetType() == typeof(string) &amp;&amp; string.IsNullOrEmpty((value as string)))
            {
                return default(TOut);
            }
            return (TOut)value;
        }
        public static IOrderedQueryable&lt;DynamicNode&gt; OrderBy(object source, object key)
        {
            IEnumerable&lt;DynamicNode&gt; typedSource = source as IEnumerable&lt;DynamicNode&gt;;
            LambdaExpression lambda = key as LambdaExpression;
            //if the lambda we have returns an actual property, not a dynamic one,
            //then the TOut of the func will be the actual type, not object
            //Func&lt;DynamicNode, object&gt; func = (Func&lt;DynamicNode, object&gt;)lambda.Compile();
            var func = lambda.Compile();
            var TOut = func.GetType().GetGenericArguments()[1];
            IOrderedQueryable&lt;DynamicNode&gt; result = null;
            if (TOut == typeof(Func&lt;DynamicNode, object&gt;))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderBy(x =&gt; Reduce&lt;object&gt;(func as Func&lt;DynamicNode, object&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(object))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderBy(x =&gt; Reduce&lt;object&gt;(func as Func&lt;DynamicNode, object&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(bool))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderBy(x =&gt; Reduce&lt;bool&gt;(func as Func&lt;DynamicNode, bool&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(decimal))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderBy(x =&gt; Reduce&lt;decimal&gt;(func as Func&lt;DynamicNode, decimal&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(int))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderBy(x =&gt; Reduce&lt;int&gt;(func as Func&lt;DynamicNode, int&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(string))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderBy(x =&gt; Reduce&lt;string&gt;(func as Func&lt;DynamicNode, string&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(DateTime))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderBy(x =&gt; Reduce&lt;DateTime&gt;(func as Func&lt;DynamicNode, DateTime&gt;, x))
                    .AsQueryable();
            }
            return result;
        }
        public static IOrderedQueryable&lt;DynamicNode&gt; ThenBy(object source, object key)
        {
            IOrderedQueryable&lt;DynamicNode&gt; typedSource = source as IOrderedQueryable&lt;DynamicNode&gt;;
            LambdaExpression lambda = key as LambdaExpression;
            var func = lambda.Compile();
            var TOut = func.GetType().GetGenericArguments()[1];
            IOrderedQueryable&lt;DynamicNode&gt; result = null;
            if (TOut == typeof(Func&lt;DynamicNode, object&gt;))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenBy(x =&gt; Reduce&lt;object&gt;(func as Func&lt;DynamicNode, object&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(object))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenBy(x =&gt; Reduce&lt;object&gt;(func as Func&lt;DynamicNode, object&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(bool))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenBy(x =&gt; Reduce&lt;bool&gt;(func as Func&lt;DynamicNode, bool&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(decimal))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenBy(x =&gt; Reduce&lt;decimal&gt;(func as Func&lt;DynamicNode, decimal&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(int))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenBy(x =&gt; Reduce&lt;int&gt;(func as Func&lt;DynamicNode, int&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(string))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenBy(x =&gt; Reduce&lt;string&gt;(func as Func&lt;DynamicNode, string&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(DateTime))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenBy(x =&gt; Reduce&lt;DateTime&gt;(func as Func&lt;DynamicNode, DateTime&gt;, x))
                    .AsQueryable();
            }
            return result;
        }
        public static IOrderedQueryable&lt;DynamicNode&gt; OrderByDescending(object source, object key)
        {
            IEnumerable&lt;DynamicNode&gt; typedSource = source as IEnumerable&lt;DynamicNode&gt;;
            LambdaExpression lambda = key as LambdaExpression;
            var func = lambda.Compile();
            var TOut = func.GetType().GetGenericArguments()[1];
            IOrderedQueryable&lt;DynamicNode&gt; result = null;
            if (TOut == typeof(Func&lt;DynamicNode, object&gt;))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderByDescending(x =&gt; Reduce&lt;object&gt;(func as Func&lt;DynamicNode, object&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(object))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderByDescending(x =&gt; Reduce&lt;object&gt;(func as Func&lt;DynamicNode, object&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(bool))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderByDescending(x =&gt; Reduce&lt;bool&gt;(func as Func&lt;DynamicNode, bool&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(decimal))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderByDescending(x =&gt; Reduce&lt;decimal&gt;(func as Func&lt;DynamicNode, decimal&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(int))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderByDescending(x =&gt; Reduce&lt;int&gt;(func as Func&lt;DynamicNode, int&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(string))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderByDescending(x =&gt; Reduce&lt;string&gt;(func as Func&lt;DynamicNode, string&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(DateTime))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .OrderByDescending(x =&gt; Reduce&lt;DateTime&gt;(func as Func&lt;DynamicNode, DateTime&gt;, x))
                    .AsQueryable();
            }
            return result;
        }
        public static IOrderedQueryable&lt;DynamicNode&gt; ThenByDescending(object source, object key)
        {
            IOrderedQueryable&lt;DynamicNode&gt; typedSource = source as IOrderedQueryable&lt;DynamicNode&gt;;
            LambdaExpression lambda = key as LambdaExpression;
            var func = lambda.Compile();
            var TOut = func.GetType().GetGenericArguments()[1];
            IOrderedQueryable&lt;DynamicNode&gt; result = null;
            if (TOut == typeof(Func&lt;DynamicNode, object&gt;))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenByDescending(x =&gt; Reduce&lt;object&gt;(func as Func&lt;DynamicNode, object&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(object))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenByDescending(x =&gt; Reduce&lt;object&gt;(func as Func&lt;DynamicNode, object&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(bool))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenByDescending(x =&gt; Reduce&lt;bool&gt;(func as Func&lt;DynamicNode, bool&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(decimal))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenByDescending(x =&gt; Reduce&lt;decimal&gt;(func as Func&lt;DynamicNode, decimal&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(int))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenByDescending(x =&gt; Reduce&lt;int&gt;(func as Func&lt;DynamicNode, int&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(string))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenByDescending(x =&gt; Reduce&lt;string&gt;(func as Func&lt;DynamicNode, string&gt;, x))
                    .AsQueryable();
            }
            if (TOut == typeof(DateTime))
            {
                result = (IOrderedQueryable&lt;DynamicNode&gt;)typedSource
                    .ThenByDescending(x =&gt; Reduce&lt;DateTime&gt;(func as Func&lt;DynamicNode, DateTime&gt;, x))
                    .AsQueryable();
            }
            return result;
        }

    }
}


    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,10,0],[14,13,14,36,0],[15,13,15,53,0],[16,13,16,14,0],[17,17,17,66,0],[18,13,18,14,0],[31,13,31,81,0],[32,13,32,14,0],[33,17,33,38,0],[35,13,35,94,0],[36,13,36,14,0],[37,17,37,38,0],[39,13,39,32,0],[40,9,40,10,0],[42,9,42,10,0],[43,13,43,87,0],[44,13,44,63,0],[48,13,48,41,0],[49,13,49,64,0],[50,13,50,58,0],[51,13,51,59,0],[52,13,52,14,0],[53,17,54,35,0],[54,35,54,87,0],[54,87,55,36,0],[53,17,55,36,0],[56,13,56,14,0],[57,13,57,40,0],[58,13,58,14,0],[59,17,60,35,0],[60,35,60,87,0],[60,87,61,36,0],[59,17,61,36,0],[62,13,62,14,0],[63,13,63,38,0],[64,13,64,14,0],[65,17,66,35,0],[66,35,66,83,0],[66,83,67,36,0],[65,17,67,36,0],[68,13,68,14,0],[69,13,69,41,0],[70,13,70,14,0],[71,17,72,35,0],[72,35,72,89,0],[72,89,73,36,0],[71,17,73,36,0],[74,13,74,14,0],[75,13,75,37,0],[76,13,76,14,0],[77,17,78,35,0],[78,35,78,81,0],[78,81,79,36,0],[77,17,79,36,0],[80,13,80,14,0],[81,13,81,40,0],[82,13,82,14,0],[83,17,84,35,0],[84,35,84,87,0],[84,87,85,36,0],[83,17,85,36,0],[86,13,86,14,0],[87,13,87,42,0],[88,13,88,14,0],[89,17,90,35,0],[90,35,90,91,0],[90,91,91,36,0],[89,17,91,36,0],[92,13,92,14,0],[93,13,93,27,0],[94,9,94,10,0],[96,9,96,10,0],[97,13,97,99,0],[98,13,98,63,0],[99,13,99,41,0],[100,13,100,64,0],[101,13,101,58,0],[102,13,102,59,0],[103,13,103,14,0],[104,17,106,36,0],[107,13,107,14,0],[108,13,108,40,0],[109,13,109,14,0],[110,17,112,36,0],[113,13,113,14,0],[114,13,114,38,0],[115,13,115,14,0],[116,17,118,36,0],[119,13,119,14,0],[120,13,120,41,0],[121,13,121,14,0],[122,17,124,36,0],[125,13,125,14,0],[126,13,126,37,0],[127,13,127,14,0],[128,17,130,36,0],[131,13,131,14,0],[132,13,132,40,0],[133,13,133,14,0],[134,17,136,36,0],[137,13,137,14,0],[138,13,138,42,0],[139,13,139,14,0],[140,17,142,36,0],[143,13,143,14,0],[144,13,144,27,0],[145,9,145,10,0],[147,9,147,10,0],[148,13,148,87,0],[149,13,149,63,0],[150,13,150,41,0],[151,13,151,64,0],[152,13,152,58,0],[153,13,153,59,0],[154,13,154,14,0],[155,17,156,45,0],[156,45,156,97,0],[156,97,157,36,0],[155,17,157,36,0],[158,13,158,14,0],[159,13,159,40,0],[160,13,160,14,0],[161,17,162,45,0],[162,45,162,97,0],[162,97,163,36,0],[161,17,163,36,0],[164,13,164,14,0],[165,13,165,38,0],[166,13,166,14,0],[167,17,168,45,0],[168,45,168,93,0],[168,93,169,36,0],[167,17,169,36,0],[170,13,170,14,0],[171,13,171,41,0],[172,13,172,14,0],[173,17,174,45,0],[174,45,174,99,0],[174,99,175,36,0],[173,17,175,36,0],[176,13,176,14,0],[177,13,177,37,0],[178,13,178,14,0],[179,17,180,45,0],[180,45,180,91,0],[180,91,181,36,0],[179,17,181,36,0],[182,13,182,14,0],[183,13,183,40,0],[184,13,184,14,0],[185,17,186,45,0],[186,45,186,97,0],[186,97,187,36,0],[185,17,187,36,0],[188,13,188,14,0],[189,13,189,42,0],[190,13,190,14,0],[191,17,192,45,0],[192,45,192,101,0],[192,101,193,36,0],[191,17,193,36,0],[194,13,194,14,0],[195,13,195,27,0],[196,9,196,10,0],[198,9,198,10,0],[199,13,199,99,0],[200,13,200,63,0],[201,13,201,41,0],[202,13,202,64,0],[203,13,203,58,0],[204,13,204,59,0],[205,13,205,14,0],[206,17,208,36,0],[209,13,209,14,0],[210,13,210,40,0],[211,13,211,14,0],[212,17,214,36,0],[215,13,215,14,0],[216,13,216,38,0],[217,13,217,14,0],[218,17,220,36,0],[221,13,221,14,0],[222,13,222,41,0],[223,13,223,14,0],[224,17,226,36,0],[227,13,227,14,0],[228,13,228,37,0],[229,13,229,14,0],[230,17,232,36,0],[233,13,233,14,0],[234,13,234,40,0],[235,13,235,14,0],[236,17,238,36,0],[239,13,239,14,0],[240,13,240,42,0],[241,13,241,14,0],[242,17,244,36,0],[245,13,245,14,0],[246,13,246,27,0],[247,9,247,10,0]]);
    </script>
  </body>
</html>