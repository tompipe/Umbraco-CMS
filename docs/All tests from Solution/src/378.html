<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\RelationTypeRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;

using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class RelationTypeRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();

            CreateTestData();
        }

        private RelationTypeRepository CreateRepository(IDatabaseUnitOfWork unitOfWork)
        {
            return new RelationTypeRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax);
        }


        [Test]
        public void Can_Perform_Add_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var relateMemberToContent = new RelationType(new Guid(Constants.ObjectTypes.Member),
                                                             new Guid(Constants.ObjectTypes.Document),
                                                             &quot;relateMemberToContent&quot;) { IsBidirectional = true, Name = &quot;Relate Member to Content&quot; };

                repository.AddOrUpdate(relateMemberToContent);
                unitOfWork.Commit();

                // Assert
                Assert.That(relateMemberToContent.HasIdentity, Is.True);
                Assert.That(repository.Exists(relateMemberToContent.Id), Is.True);
            }
        }

        [Test]
        public void Can_Perform_Update_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var relationType = repository.Get(3);
                relationType.Alias = relationType.Alias + &quot;Updated&quot;;
                relationType.Name = relationType.Name + &quot; Updated&quot;;
                repository.AddOrUpdate(relationType);
                unitOfWork.Commit();

                var relationTypeUpdated = repository.Get(3);

                // Assert
                Assert.That(relationTypeUpdated, Is.Not.Null);
                Assert.That(relationTypeUpdated.HasIdentity, Is.True);
                Assert.That(relationTypeUpdated.Alias, Is.EqualTo(relationType.Alias));
                Assert.That(relationTypeUpdated.Name, Is.EqualTo(relationType.Name));
            }
        }

        [Test]
        public void Can_Perform_Delete_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var relationType = repository.Get(3);
                repository.Delete(relationType);
                unitOfWork.Commit();

                var exists = repository.Exists(3);

                // Assert
                Assert.That(exists, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Get_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var relationType = repository.Get(RelationTypeDto.NodeIdSeed);

                // Assert
                Assert.That(relationType, Is.Not.Null);
                Assert.That(relationType.HasIdentity, Is.True);
                Assert.That(relationType.Alias, Is.EqualTo(&quot;relateContentOnCopy&quot;));
                Assert.That(relationType.Name, Is.EqualTo(&quot;Relate Content on Copy&quot;));
            }
        }

        [Test]
        public void Can_Perform_GetAll_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var relationTypes = repository.GetAll();

                // Assert
                Assert.That(relationTypes, Is.Not.Null);
                Assert.That(relationTypes.Any(), Is.True);
                Assert.That(relationTypes.Any(x =&gt; x == null), Is.False);
                Assert.That(relationTypes.Count(), Is.EqualTo(4));
            }
        }

        [Test]
        public void Can_Perform_GetAll_With_Params_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var relationTypes = repository.GetAll(2, 3);

                // Assert
                Assert.That(relationTypes, Is.Not.Null);
                Assert.That(relationTypes.Any(), Is.True);
                Assert.That(relationTypes.Any(x =&gt; x == null), Is.False);
                Assert.That(relationTypes.Count(), Is.EqualTo(2));
            }
        }

        [Test]
        public void Can_Perform_Exists_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var exists = repository.Exists(3);
                var doesntExist = repository.Exists(5);

                // Assert
                Assert.That(exists, Is.True);
                Assert.That(doesntExist, Is.False);
            }
        }

        [Test]
        public void Can_Perform_Count_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var query = Query&lt;IRelationType&gt;.Builder.Where(x =&gt; x.Alias.StartsWith(&quot;relate&quot;));
                int count = repository.Count(query);

                // Assert
                Assert.That(count, Is.EqualTo(4));
            }
        }

        [Test]
        public void Can_Perform_GetByQuery_On_RelationTypeRepository()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            using (var repository = CreateRepository(unitOfWork))
            {

                // Act
                var childObjType = new Guid(Constants.ObjectTypes.DocumentType);
                var query = Query&lt;IRelationType&gt;.Builder.Where(x =&gt; x.ChildObjectType == childObjType);
                var result = repository.GetByQuery(query);

                // Assert
                Assert.That(result, Is.Not.Null);
                Assert.That(result.Any(), Is.True);
                Assert.That(result.Any(x =&gt; x == null), Is.False);
                Assert.That(result.Count(), Is.EqualTo(1));
            }
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        public void CreateTestData()
        {
            var relateContent = new RelationType(new Guid(Constants.ObjectTypes.Document), new Guid(&quot;C66BA18E-EAF3-4CFF-8A22-41B16D66A972&quot;), &quot;relateContentOnCopy&quot;) { IsBidirectional = true, Name = &quot;Relate Content on Copy&quot; };
            var relateContentType = new RelationType(new Guid(Constants.ObjectTypes.DocumentType), new Guid(&quot;A2CB7800-F571-4787-9638-BC48539A0EFB&quot;), &quot;relateContentTypeOnCopy&quot;) { IsBidirectional = true, Name = &quot;Relate ContentType on Copy&quot; };

            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            var repository = new RelationTypeRepository(unitOfWork, CacheHelper.CreateDisabledCacheHelper(), Mock.Of&lt;ILogger&gt;(), SqlSyntax);

            repository.AddOrUpdate(relateContent);//Id 2
            repository.AddOrUpdate(relateContentType);//Id 3
            unitOfWork.Commit();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,1],[25,13,25,31,1],[27,13,27,30,1],[28,9,28,10,1],[31,9,31,10,1],[32,13,32,131,1],[33,9,33,10,1],[38,9,38,10,1],[40,13,40,67,1],[41,13,41,55,1],[42,20,42,65,1],[43,13,43,14,1],[46,17,48,149,1],[50,17,50,63,1],[51,17,51,37,1],[54,17,54,73,1],[55,17,55,83,1],[56,13,56,14,1],[57,9,57,10,1],[61,9,61,10,1],[63,13,63,67,1],[64,13,64,55,1],[65,20,65,65,1],[66,13,66,14,1],[69,17,69,54,1],[70,17,70,69,1],[71,17,71,68,1],[72,17,72,54,1],[73,17,73,37,1],[75,17,75,61,1],[78,17,78,63,1],[79,17,79,71,1],[80,17,80,88,1],[81,17,81,86,1],[82,13,82,14,1],[83,9,83,10,1],[87,9,87,10,1],[89,13,89,67,1],[90,13,90,55,1],[91,20,91,65,1],[92,13,92,14,1],[95,17,95,54,1],[96,17,96,49,1],[97,17,97,37,1],[99,17,99,51,1],[102,17,102,47,1],[103,13,103,14,1],[104,9,104,10,1],[108,9,108,10,1],[110,13,110,67,1],[111,13,111,55,1],[112,20,112,65,1],[113,13,113,14,1],[116,17,116,79,1],[119,17,119,56,1],[120,17,120,64,1],[121,17,121,84,1],[122,17,122,86,1],[123,13,123,14,1],[124,9,124,10,1],[128,9,128,10,1],[130,13,130,67,1],[131,13,131,55,1],[132,20,132,65,1],[133,13,133,14,1],[136,17,136,57,1],[139,17,139,57,1],[140,17,140,59,1],[141,17,141,52,1],[141,52,141,61,1],[141,61,141,74,1],[141,17,141,74,1],[142,17,142,67,1],[143,13,143,14,1],[144,9,144,10,1],[148,9,148,10,1],[150,13,150,67,1],[151,13,151,55,1],[152,20,152,65,1],[153,13,153,14,1],[156,17,156,61,1],[159,17,159,57,1],[160,17,160,59,1],[161,17,161,52,1],[161,52,161,61,1],[161,61,161,74,1],[161,17,161,74,1],[162,17,162,67,1],[163,13,163,14,1],[164,9,164,10,1],[168,9,168,10,1],[170,13,170,67,1],[171,13,171,55,1],[172,20,172,65,1],[173,13,173,14,1],[176,17,176,51,1],[177,17,177,56,1],[180,17,180,46,1],[181,17,181,52,1],[182,13,182,14,1],[183,9,183,10,1],[187,9,187,10,1],[189,13,189,67,1],[190,13,190,55,1],[191,20,191,65,1],[192,13,192,14,1],[195,17,195,99,1],[196,17,196,53,1],[199,17,199,51,1],[200,13,200,14,1],[201,9,201,10,1],[205,9,205,10,1],[207,13,207,67,1],[208,13,208,55,1],[209,20,209,65,1],[210,13,210,14,1],[213,17,213,81,1],[214,17,214,104,1],[215,17,215,59,1],[218,17,218,50,1],[219,17,219,52,1],[220,17,220,45,1],[220,45,220,54,1],[220,54,220,67,1],[220,17,220,67,1],[221,17,221,60,1],[222,13,222,14,1],[223,9,223,10,1],[227,9,227,10,1],[228,13,228,29,1],[229,9,229,10,1],[232,9,232,10,1],[233,13,233,225,1],[234,13,234,241,1],[236,13,236,67,1],[237,13,237,55,1],[238,13,238,141,1],[240,13,240,51,1],[241,13,241,55,1],[242,13,242,33,1],[243,9,243,10,1]]);
    </script>
  </body>
</html>