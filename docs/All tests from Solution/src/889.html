<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\LegacyTreeController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Linq;
using System.Net.Http.Formatting;
using System.Web.Http.Routing;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Web.Models.Trees;
using Umbraco.Web.Mvc;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebApi.Filters;
using umbraco.cms.presentation.Trees;

namespace Umbraco.Web.Trees
{

    /// &lt;summary&gt;
    /// This is used to output JSON from legacy trees
    /// &lt;/summary&gt;
    [PluginController(&quot;UmbracoTrees&quot;)]
    [LegacyTreeAuthorizeAttribute]
    public class LegacyTreeController : TreeControllerBase
    {
        private readonly XmlTreeNode _xmlTreeNode;
        private readonly string _treeAlias;
        private readonly string _currentSection;
        private readonly string _rootDisplay;

        public LegacyTreeController()
        {
            
        }

        public LegacyTreeController(XmlTreeNode xmlTreeNode, string treeAlias, string currentSection, UrlHelper urlHelper)
        {
            _xmlTreeNode = xmlTreeNode;
            _treeAlias = treeAlias;
            _currentSection = currentSection;
            _rootDisplay = xmlTreeNode.Text;
            Url = urlHelper;
        }

        protected override TreeNode CreateRootNode(FormDataCollection queryStrings)
        {
            return LegacyTreeDataConverter.ConvertFromLegacy(
                _xmlTreeNode.NodeID,
                _xmlTreeNode,
                Url,
                _currentSection, 
                queryStrings, 
                isRoot: true);
        }

        protected override TreeNodeCollection GetTreeNodes(string id, FormDataCollection queryStrings)
        {
            var tree = GetTree(queryStrings);
            var attempt = tree.TryLoadFromLegacyTree(id, queryStrings, Url, tree.ApplicationAlias);
            if (attempt.Success == false)
            {
                var msg = &quot;Could not render tree &quot; + queryStrings.GetRequiredString(&quot;treeType&quot;) + &quot; for node id &quot; + id;
                LogHelper.Error&lt;LegacyTreeController&gt;(msg, attempt.Exception);
                throw new ApplicationException(msg);
            }

            return attempt.Result;
        }

        protected override MenuItemCollection GetMenuForNode(string id, FormDataCollection queryStrings)
        {
            //get the parent id from the query strings
            var parentId = queryStrings.GetRequiredString(&quot;parentId&quot;);
            var tree = GetTree(queryStrings);

            var rootIds = new[]
            {
                Core.Constants.System.Root.ToString(CultureInfo.InvariantCulture),
                Core.Constants.System.RecycleBinContent.ToString(CultureInfo.InvariantCulture),
                Core.Constants.System.RecycleBinMedia.ToString(CultureInfo.InvariantCulture)
            };

            //if the id and the parentId are both -1 then we need to get the menu for the root node
            if (rootIds.Contains(id) &amp;&amp; parentId == &quot;-1&quot;)
            {
                var attempt = tree.TryGetMenuFromLegacyTreeRootNode(queryStrings, Url);
                if (attempt.Success == false)
                {
                    var msg = &quot;Could not render menu for root node for treeType &quot; + queryStrings.GetRequiredString(&quot;treeType&quot;);
                    LogHelper.Error&lt;LegacyTreeController&gt;(msg, attempt.Exception);
                    throw new ApplicationException(msg);
                }

                foreach (var menuItem in attempt.Result.Items)
                {
                    menuItem.Name = global::umbraco.ui.Text(&quot;actions&quot;, menuItem.Alias);
                }
                return attempt.Result;
            }
            else
            {
                var attempt = tree.TryGetMenuFromLegacyTreeNode(parentId, id, queryStrings, Url);
                if (attempt.Success == false)
                {
                    var msg = &quot;Could not render menu for treeType &quot; + queryStrings.GetRequiredString(&quot;treeType&quot;) + &quot; for node id &quot; + parentId;
                    LogHelper.Error&lt;LegacyTreeController&gt;(msg, attempt.Exception);
                    throw new ApplicationException(msg);
                }
                foreach (var menuItem in attempt.Result.Items)
                {
                    menuItem.Name = global::umbraco.ui.Text(&quot;actions&quot;, menuItem.Alias);
                }
                return attempt.Result;
            }                       
        }

        public override string RootNodeDisplayName
        {
            get { return _rootDisplay; }
        }

        public override string TreeAlias
        {
            get { return _treeAlias; }
        }

        private ApplicationTree GetTree(FormDataCollection queryStrings)
        {
            //need to ensure we have a tree type
            var treeType = queryStrings.GetRequiredString(&quot;treeType&quot;);
            //now we&#39;ll look up that tree
            var tree = Services.ApplicationTreeService.GetByAlias(treeType);
            if (tree == null)
                throw new InvalidOperationException(&quot;No tree found with alias &quot; + treeType);
            return tree;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,38,0],[31,9,31,10,0],[33,9,33,10,0],[35,9,35,123,0],[36,9,36,10,0],[37,13,37,40,0],[38,13,38,36,0],[39,13,39,46,0],[40,13,40,45,0],[41,13,41,29,0],[42,9,42,10,0],[45,9,45,10,0],[46,13,52,31,0],[53,9,53,10,0],[56,9,56,10,0],[57,13,57,46,0],[58,13,58,100,0],[59,13,59,42,0],[60,13,60,14,0],[61,17,61,120,0],[62,17,62,79,0],[63,17,63,53,0],[66,13,66,35,0],[67,9,67,10,0],[70,9,70,10,0],[72,13,72,71,0],[73,13,73,46,0],[75,13,80,15,0],[83,13,83,58,0],[84,13,84,14,0],[85,17,85,88,0],[86,17,86,46,0],[87,17,87,18,0],[88,21,88,128,0],[89,21,89,83,0],[90,21,90,57,0],[93,17,93,24,0],[93,26,93,38,0],[93,39,93,41,0],[93,42,93,62,0],[94,17,94,18,0],[95,21,95,88,0],[96,17,96,18,0],[97,17,97,39,0],[100,13,100,14,0],[101,17,101,98,0],[102,17,102,46,0],[103,17,103,18,0],[104,21,104,143,0],[105,21,105,83,0],[106,21,106,57,0],[108,17,108,24,0],[108,26,108,38,0],[108,39,108,41,0],[108,42,108,62,0],[109,17,109,18,0],[110,21,110,88,0],[111,17,111,18,0],[112,17,112,39,0],[114,9,114,10,0],[118,17,118,18,0],[118,19,118,39,0],[118,40,118,41,0],[123,17,123,18,0],[123,19,123,37,0],[123,38,123,39,0],[127,9,127,10,0],[129,13,129,71,0],[131,13,131,77,0],[132,13,132,30,0],[133,17,133,93,0],[134,13,134,25,0],[135,9,135,10,0]]);
    </script>
  </body>
</html>