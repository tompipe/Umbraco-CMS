<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\UnitOfWork\FileUnitOfWork.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Transactions;
using Umbraco.Core.Models.EntityBase;

namespace Umbraco.Core.Persistence.UnitOfWork
{
    /// &lt;summary&gt;
    /// Represents the Unit of Work implementation for working with files
    /// &lt;/summary&gt;
    internal class FileUnitOfWork : IUnitOfWork
    {
        private Guid _key;
        private readonly Queue&lt;Operation&gt; _operations = new Queue&lt;Operation&gt;();

        public FileUnitOfWork()
        {
            _key = Guid.NewGuid();
        }

        #region Implementation of IUnitOfWork

        /// &lt;summary&gt;
        /// Registers an &lt;see cref=&quot;IEntity&quot; /&gt; instance to be added through this &lt;see cref=&quot;UnitOfWork&quot; /&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;entity&quot;&gt;The &lt;see cref=&quot;IEntity&quot; /&gt;&lt;/param&gt;
        /// &lt;param name=&quot;repository&quot;&gt;The &lt;see cref=&quot;IUnitOfWorkRepository&quot; /&gt; participating in the transaction&lt;/param&gt;
        public void RegisterAdded(IEntity entity, IUnitOfWorkRepository repository)
        {
            _operations.Enqueue(
                new Operation
                {
                    Entity = entity,
                    Repository = repository,
                    Type = TransactionType.Insert
                });
        }

        /// &lt;summary&gt;
        /// Registers an &lt;see cref=&quot;IEntity&quot; /&gt; instance to be changed through this &lt;see cref=&quot;UnitOfWork&quot; /&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;entity&quot;&gt;The &lt;see cref=&quot;IEntity&quot; /&gt;&lt;/param&gt;
        /// &lt;param name=&quot;repository&quot;&gt;The &lt;see cref=&quot;IUnitOfWorkRepository&quot; /&gt; participating in the transaction&lt;/param&gt;
        public void RegisterChanged(IEntity entity, IUnitOfWorkRepository repository)
        {
            _operations.Enqueue(
                new Operation
                {
                    Entity = entity,
                    Repository = repository,
                    Type = TransactionType.Update
                });
        }

        /// &lt;summary&gt;
        /// Registers an &lt;see cref=&quot;IEntity&quot; /&gt; instance to be removed through this &lt;see cref=&quot;UnitOfWork&quot; /&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;entity&quot;&gt;The &lt;see cref=&quot;IEntity&quot; /&gt;&lt;/param&gt;
        /// &lt;param name=&quot;repository&quot;&gt;The &lt;see cref=&quot;IUnitOfWorkRepository&quot; /&gt; participating in the transaction&lt;/param&gt;
        public void RegisterRemoved(IEntity entity, IUnitOfWorkRepository repository)
        {
            _operations.Enqueue(
                new Operation
                {
                    Entity = entity,
                    Repository = repository,
                    Type = TransactionType.Delete
                });
        }

        public void Commit()
        {
            //NOTE: I&#39;m leaving this in here for reference, but this is useless, transaction scope + Files doesn&#39;t do anything,
            // the closest you can get is transactional NTFS, but that requires distributed transaction coordinator and some other libs/wrappers,
            // plus MS has not deprecated it anyways. To do transactional IO we&#39;d have to write this ourselves using temporary files and then 
            // on committing move them to their correct place.
            //using(var scope = new TransactionScope())
            //{
            //    // Commit the transaction
            //    scope.Complete();
            //}

            while (_operations.Count &gt; 0)
            {
                var operation = _operations.Dequeue();
                switch (operation.Type)
                {
                    case TransactionType.Insert:
                        operation.Repository.PersistNewItem(operation.Entity);
                        break;
                    case TransactionType.Delete:
                        operation.Repository.PersistDeletedItem(operation.Entity);
                        break;
                    case TransactionType.Update:
                        operation.Repository.PersistUpdatedItem(operation.Entity);
                        break;
                }
            }

            // Clear everything
            _operations.Clear();
            _key = Guid.NewGuid();
        }

        public object Key
        {
            get { return _key; }
        }

        #endregion

        #region Operation

        /// &lt;summary&gt;
        /// Provides a snapshot of an entity and the repository reference it belongs to.
        /// &lt;/summary&gt;
        private sealed class Operation
        {
            /// &lt;summary&gt;
            /// Gets or sets the entity.
            /// &lt;/summary&gt;
            /// &lt;value&gt;The entity.&lt;/value&gt;
            public IEntity Entity { get; set; }

            /// &lt;summary&gt;
            /// Gets or sets the repository.
            /// &lt;/summary&gt;
            /// &lt;value&gt;The repository.&lt;/value&gt;
            public IUnitOfWorkRepository Repository { get; set; }

            /// &lt;summary&gt;
            /// Gets or sets the type of operation.
            /// &lt;/summary&gt;
            /// &lt;value&gt;The type of operation.&lt;/value&gt;
            public TransactionType Type { get; set; }
        }

        #endregion

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,9,15,80,1],[17,9,17,32,1],[18,9,18,10,1],[19,13,19,35,1],[20,9,20,10,1],[30,9,30,10,1],[31,13,37,20,1],[38,9,38,10,1],[46,9,46,10,1],[47,13,53,20,1],[54,9,54,10,1],[62,9,62,10,1],[63,13,69,20,1],[70,9,70,10,1],[73,9,73,10,1],[84,13,84,42,1],[85,13,85,14,1],[86,17,86,55,1],[87,17,87,40,1],[90,25,90,79,1],[91,25,91,31,1],[93,25,93,83,1],[94,25,94,31,1],[96,25,96,83,1],[97,25,97,31,1],[99,13,99,14,1],[102,13,102,33,1],[103,13,103,35,1],[104,9,104,10,1],[108,17,108,18,0],[108,19,108,31,0],[108,32,108,33,0],[124,37,124,41,1],[124,42,124,46,1],[130,55,130,59,1],[130,60,130,64,1],[136,43,136,47,1],[136,48,136,52,1]]);
    </script>
  </body>
</html>