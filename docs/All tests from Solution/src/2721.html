<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\macrocontainer\MacroEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web.UI.WebControls;
using System.Web.UI;
using Umbraco.Core;
using Umbraco.Core.Macros;
using Umbraco.Core.ObjectResolution;
using umbraco.cms.businesslogic.macro;
using System.Collections;
using umbraco.presentation;
using System.Web;

namespace umbraco.editorControls.macrocontainer
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class MacroEditor : System.Web.UI.Control
    {
        private List&lt;string&gt; _allowedMacros;
        private DropDownList _macroSelectDropdown;
        private LinkButton _delete;
        private Table _formTable;
        private Hashtable _dataValues;
        private string _data;
        private LiteralControl propertiesHeader = new LiteralControl(&quot;&lt;h4&gt;&quot; + ui.Text(&quot;macroContainerSettings&quot;) + &quot; &lt;span class=\&quot;settingsToggle\&quot;&gt;&lt;a href=\&quot;#\&quot; onClick=\&quot;jQuery(this).closest(&#39;.macroeditor&#39;).find(&#39;.macroSettings&#39;).toggle()\&quot;&gt;Show/Hide&lt;/a&gt;&lt;/span&gt; &lt;/h4&gt; &quot;);

        public MacroEditor(string Data, List&lt;string&gt; allowedMacros)
        {
            _data = Data;
            _allowedMacros = allowedMacros;
        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            _macroSelectDropdown = new DropDownList();
            _macroSelectDropdown.ID = ID + &quot;_ddselectmacro&quot;;
            _macroSelectDropdown.SelectedIndexChanged += new EventHandler(_macroSelectDropdown_SelectedIndexChanged);
            _macroSelectDropdown.Items.Add(new ListItem(umbraco.ui.Text(&quot;choose&quot;), &quot;&quot;));
            foreach (string item in _allowedMacros)
            {
                _macroSelectDropdown.Items.Add(new ListItem(GetMacroNameFromAlias(item), item));
            }
            _macroSelectDropdown.AutoPostBack = true;

            _delete = new LinkButton();
            _delete.CssClass = &quot;macroDelete&quot;;
            _delete.ID = ID + &quot;_btndelete&quot;;
            _delete.Text = ui.Text(&quot;removeMacro&quot;);
            _delete.Attributes.Add(&quot;style&quot;, &quot;color:red;&quot;);
            _delete.Click += new EventHandler(_delete_Click);
            _formTable = new Table();
            _formTable.ID = ID + &quot;_tblform&quot;;
            _formTable.CssClass = &quot;macroSettings&quot;;

            propertiesHeader.Visible = false;
            this.Controls.Add(_delete);
            this.Controls.Add(_macroSelectDropdown);
            this.Controls.Add(propertiesHeader);
            this.Controls.Add(_formTable);
        }

        //using this to solve to eager loading,
        // replaces _macroSelectDropdown.Items.Add(new ListItem(Macro.GetByAlias(item).Name, item));
        // with  _macroSelectDropdown.Items.Add(new ListItem(GetMacroNameFromAlias(item), item));
        private string GetMacroNameFromAlias(string alias)
        {
            var macro = umbraco.macro.GetMacro(alias);

            return macro == null ? string.Empty : macro.Name;
        }
        
        void _delete_Click(object sender, EventArgs e)
        {
            _macroSelectDropdown.SelectedIndex = 0;
            InitializeForm(&quot;&quot;);
            this.Visible = false;
            MacroContainerEvent.Delete();
        }



        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            if (!Page.IsPostBack)
            {

                //Handle Initial Request
                if (DataValues[&quot;macroalias&quot;] != null)
                {
                    //Data is available from the database, initialize the form with the data
                    string alias = DataValues[&quot;macroalias&quot;].ToString();

                    //Set Pulldown selected value based on the macro alias
                    _macroSelectDropdown.SelectedValue = alias;

                    //Create from with values based on the alias
                    InitializeForm(alias);
                }
                else
                {
                    this.Visible = false;
                }

            }
            else
            {
                //Render form if properties are in the viewstate
                if (SelectedProperties.Count &gt; 0)
                {
                    RendeFormControls();
                }
            }

            //Make sure child controls get rendered
            EnsureChildControls();

        }

        protected override void Render(HtmlTextWriter writer)
        {            
            writer.Write(&quot;&lt;div id=\&quot;container&quot; + ID + &quot;\&quot; class=\&quot;macroeditor\&quot;&gt;&quot;);
            _delete.RenderControl(writer);
            writer.Write(&quot;&lt;h4&gt;Macro:&lt;/h4&gt;&quot;);
            _macroSelectDropdown.RenderControl(writer);
            writer.Write(&quot; &quot;);//&lt;a style=\&quot;color: red;\&quot; href=\&quot;javascript:deletemacro(&#39;&quot; + _macroSelectDropdown.ClientID + &quot;&#39;,&#39;&quot;+ID+&quot;container&#39; )\&quot;&gt;Delete&lt;/a&gt;&quot;);
            propertiesHeader.RenderControl(writer);
            _formTable.RenderControl(writer);
            writer.Write(&quot;&lt;/div&gt;&quot;);
        }

        private void _macroSelectDropdown_SelectedIndexChanged(object sender, EventArgs e)
        {
            InitializeForm(_macroSelectDropdown.SelectedValue);

        }

        private void InitializeForm(string macroAlias)
        {

            //Hold selected Alias in Viewstate
            SelectedMacroAlias = macroAlias;

            //Create new property collection
            List&lt;PersistableMacroProperty&gt; props = new List&lt;PersistableMacroProperty&gt;();

            //Clear Old Control Collection
            _formTable.Controls.Clear();

            //Is a Macro selected
            if (!string.IsNullOrEmpty(macroAlias))
            {
                Macro formMacro = Macro.GetByAlias(macroAlias);

                ///Only render form when macro is found
                if (formMacro != null)
                {
                    if (formMacro.Properties.Length &gt; 0)
                    {
                        propertiesHeader.Visible = true;
                    }
                    foreach (MacroProperty macroProperty in formMacro.Properties)
                    {
                        var prop = new PersistableMacroProperty();
                        prop.Alias = macroProperty.Alias;
                        prop.Name = macroProperty.Name;
                        prop.AssemblyName = macroProperty.Type.Assembly;
                        prop.TypeName = macroProperty.Type.Type;

                        //Assign value if specified
                        if (DataValues[macroProperty.Alias.ToLower()] != null)
                        {
                            prop.Value = DataValues[macroProperty.Alias.ToLower()].ToString();
                        }

                        props.Add(prop);
                    }
                }
            }
            //Hold selected properties in ViewState
            SelectedProperties = props;

            //Render the form
            RendeFormControls();
        }

        /// &lt;summary&gt;
        /// Renders a from based on the properties of the macro
        /// &lt;/summary&gt;
        private void RendeFormControls()
        {
            foreach (PersistableMacroProperty prop in SelectedProperties)
            {
                //Create Literal
                Literal caption = new Literal();
                caption.ID = ID + &quot;_&quot; + string.Format(&quot;{0}Label&quot;, prop.Alias);
                caption.Text = prop.Name;

                //Get the MacroControl 
				Control macroControl = MacroFieldEditorsResolver.Current.GetMacroRenderControlByType(prop, ID + &quot;_&quot; + prop.Alias);

                AddFormRow(caption, macroControl);

            }
        }

        /// &lt;summary&gt;
        /// Add a new TableRow to the table. with two cells that holds the Caption and the  form element
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;formElement&quot;&gt;&lt;/param&gt;
        private void AddFormRow(Control name, Control formElement)
        {
            string aliasPrefix = formElement.ID;

            TableRow tr = new TableRow();
            tr.ID = ID + &quot;_&quot; + string.Format(&quot;{0}tr&quot;, aliasPrefix);

            TableCell tcLeft = new TableCell();
            tcLeft.ID = ID + &quot;_&quot; + string.Format(&quot;{0}tcleft&quot;, aliasPrefix);
            tcLeft.Width = 120;

            TableCell tcRight = new TableCell();
            tcRight.ID = ID + &quot;_&quot; + string.Format(&quot;{0}tcright&quot;, aliasPrefix);
            tcRight.Width = 300;

            tcLeft.Controls.Add(name);
            tcRight.Controls.Add(formElement);

            tr.Controls.Add(tcLeft);
            tr.Controls.Add(tcRight);

            _formTable.Controls.Add(tr);

        }

        /// &lt;summary&gt;
        /// Builds an Umbraco Macro tag if a user selected a macro
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private string CreateUmbracoMacroTag()
        {
            string result = string.Empty;

            if (!string.IsNullOrEmpty(SelectedMacroAlias))
            {
                //Only create Macro Tag if we have something to store.
                StringBuilder sb = new StringBuilder();
                //Start
                sb.Append(&quot;&lt;?UMBRACO_MACRO &quot;);

                //Alias Attribute
                sb.AppendFormat(&quot; macroalias=\&quot;{0}\&quot; &quot;, SelectedMacroAlias);

                foreach (PersistableMacroProperty prop in SelectedProperties)
                {
                    //Make sure we find the correct Unique ID
                    string ControlIdToFind = ID + &quot;_&quot; + prop.Alias;
					string value = MacroFieldEditorsResolver.Current.GetValueFromMacroControl(_formTable.FindControl(ControlIdToFind));
                    sb.AppendFormat(&quot; {0}=\&quot;{1}\&quot; &quot;, prop.Alias, value);
                }
                sb.Append(&quot; /&gt;&quot;);
                result = sb.ToString();
            }
            return result;
        }

        private string SelectedMacroAlias
        {

            get { return string.Format(&quot;{0}&quot;, ViewState[ID + &quot;SelectedMacroAlias&quot;]); }
            set { ViewState[ID + &quot;SelectedMacroAlias&quot;] = value; }
        }

        private List&lt;PersistableMacroProperty&gt; SelectedProperties
        {
            get
            {
                if (ViewState[ID + &quot;controls&quot;] == null)
                {
                    return new List&lt;PersistableMacroProperty&gt;();
                }
                else
                {
                    return (List&lt;PersistableMacroProperty&gt;)ViewState[ID + &quot;controls&quot;];
                }
            }
            set
            {
                ViewState[ID + &quot;controls&quot;] = value;
            }
        }

        public Hashtable DataValues
        {
            get
            {
                if (_dataValues == null)
                {
                    _dataValues = umbraco.helper.ReturnAttributes(_data);
                }
                return _dataValues;
            }
        }


        public string MacroTag
        {
            get
            {
                return CreateUmbracoMacroTag();
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,273,0],[28,9,28,68,0],[29,9,29,10,0],[30,13,30,26,0],[31,13,31,44,0],[32,9,32,10,0],[35,9,35,10,0],[36,13,36,28,0],[38,13,38,55,0],[39,13,39,61,0],[40,13,40,118,0],[41,13,41,89,0],[42,13,42,20,0],[42,22,42,33,0],[42,34,42,36,0],[42,37,42,51,0],[43,13,43,14,0],[44,17,44,97,0],[45,13,45,14,0],[46,13,46,54,0],[48,13,48,40,0],[49,13,49,46,0],[50,13,50,44,0],[51,13,51,51,0],[52,13,52,59,0],[53,13,53,62,0],[54,13,54,38,0],[55,13,55,45,0],[56,13,56,51,0],[58,13,58,46,0],[59,13,59,40,0],[60,13,60,53,0],[61,13,61,49,0],[62,13,62,43,0],[63,9,63,10,0],[69,9,69,10,0],[70,13,70,55,0],[72,13,72,62,0],[73,9,73,10,0],[76,9,76,10,0],[77,13,77,52,0],[78,13,78,32,0],[79,13,79,34,0],[80,13,80,42,0],[81,9,81,10,0],[86,9,86,10,0],[87,13,87,28,0],[89,13,89,34,0],[90,13,90,14,0],[93,17,93,54,0],[94,17,94,18,0],[96,21,96,72,0],[99,21,99,64,0],[102,21,102,43,0],[103,17,103,18,0],[105,17,105,18,0],[106,21,106,42,0],[107,17,107,18,0],[109,13,109,14,0],[111,13,111,14,0],[113,17,113,50,0],[114,17,114,18,0],[115,21,115,41,0],[116,17,116,18,0],[117,13,117,14,0],[120,13,120,35,0],[122,9,122,10,0],[125,9,125,10,0],[126,13,126,84,0],[127,13,127,43,0],[128,13,128,45,0],[129,13,129,56,0],[130,13,130,31,0],[131,13,131,52,0],[132,13,132,46,0],[133,13,133,36,0],[134,9,134,10,0],[137,9,137,10,0],[138,13,138,64,0],[140,9,140,10,0],[143,9,143,10,0],[146,13,146,45,0],[149,13,149,89,0],[152,13,152,41,0],[155,13,155,51,0],[156,13,156,14,0],[157,17,157,64,0],[160,17,160,39,0],[161,17,161,18,0],[162,21,162,57,0],[163,21,163,22,0],[164,25,164,57,0],[165,21,165,22,0],[166,21,166,28,0],[166,30,166,57,0],[166,58,166,60,0],[166,61,166,81,0],[167,21,167,22,0],[168,25,168,67,0],[169,25,169,58,0],[170,25,170,56,0],[171,25,171,73,0],[172,25,172,65,0],[175,25,175,79,0],[176,25,176,26,0],[177,29,177,95,0],[178,25,178,26,0],[180,25,180,41,0],[181,21,181,22,0],[182,17,182,18,0],[183,13,183,14,0],[185,13,185,40,0],[188,13,188,33,0],[189,9,189,10,0],[195,9,195,10,0],[196,13,196,20,0],[196,22,196,51,0],[196,52,196,54,0],[196,55,196,73,0],[197,13,197,14,0],[199,17,199,49,0],[200,17,200,79,0],[201,17,201,42,0],[204,5,204,119,0],[206,17,206,51,0],[208,13,208,14,0],[209,9,209,10,0],[217,9,217,10,0],[218,13,218,49,0],[220,13,220,42,0],[221,13,221,68,0],[223,13,223,48,0],[224,13,224,76,0],[225,13,225,32,0],[227,13,227,49,0],[228,13,228,78,0],[229,13,229,33,0],[231,13,231,39,0],[232,13,232,47,0],[234,13,234,37,0],[235,13,235,38,0],[237,13,237,41,0],[239,9,239,10,0],[246,9,246,10,0],[247,13,247,42,0],[249,13,249,59,0],[250,13,250,14,0],[252,17,252,56,0],[254,17,254,47,0],[257,17,257,77,0],[259,17,259,24,0],[259,26,259,55,0],[259,56,259,58,0],[259,59,259,77,0],[260,17,260,18,0],[262,21,262,68,0],[263,6,263,121,0],[264,21,264,73,0],[265,17,265,18,0],[266,17,266,34,0],[267,17,267,40,0],[268,13,268,14,0],[269,13,269,27,0],[270,9,270,10,0],[275,17,275,18,0],[275,19,275,85,0],[275,86,275,87,0],[276,17,276,18,0],[276,19,276,64,0],[276,65,276,66,0],[282,13,282,14,0],[283,17,283,56,0],[284,17,284,18,0],[285,21,285,65,0],[288,17,288,18,0],[289,21,289,87,0],[291,13,291,14,0],[293,13,293,14,0],[294,17,294,52,0],[295,13,295,14,0],[301,13,301,14,0],[302,17,302,41,0],[303,17,303,18,0],[304,21,304,74,0],[305,17,305,18,0],[306,17,306,36,0],[307,13,307,14,0],[314,13,314,14,0],[315,17,315,48,0],[316,13,316,14,0]]);
    </script>
  </body>
</html>