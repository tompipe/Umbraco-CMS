<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Routing\DomainsAndCulturesTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Moq;
using NUnit.Framework;
using Umbraco.Core.Models;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;
using Umbraco.Web.Routing;
using umbraco.cms.businesslogic.web;
using System.Configuration;

namespace Umbraco.Tests.Routing
{
    [TestFixture]
    internal class DomainsAndCulturesTests : UrlRoutingTestBase
    {
        protected override void FreezeResolution()
        {
            SiteDomainHelperResolver.Current = new SiteDomainHelperResolver(new SiteDomainHelper());
            base.FreezeResolution();
        }

        private void SetDomains1()
        {
            SetupDomainServiceMock(new[]
            {
                new UmbracoDomain(&quot;domain1.com/&quot;)
                {
                    Id = 1,
                    LanguageId = LangDeId,
                    RootContentId = 1001,
                    LanguageIsoCode = &quot;de-DE&quot;
                },
                new UmbracoDomain(&quot;domain1.com/en&quot;)
                {
                    Id = 1,
                    LanguageId = LangEngId,
                    RootContentId = 10011,
                    LanguageIsoCode = &quot;en-US&quot;
                },
                new UmbracoDomain(&quot;domain1.com/fr&quot;)
                {
                    Id = 1,
                    LanguageId = LangFrId,
                    RootContentId = 10012,
                    LanguageIsoCode = &quot;fr-FR&quot;
                }
            });
        }

        private void SetDomains2()
        {
            SetupDomainServiceMock(new[]
            {
                new UmbracoDomain(&quot;domain1.com/&quot;)
                {
                    Id = 1,
                    LanguageId = LangDeId,
                    RootContentId = 1001,
                    LanguageIsoCode = &quot;de-DE&quot;
                },
                new UmbracoDomain(&quot;domain1.com/en&quot;)
                {
                    Id = 1,
                    LanguageId = LangEngId,
                    RootContentId = 10011,
                    LanguageIsoCode = &quot;en-US&quot;
                },
                new UmbracoDomain(&quot;domain1.com/fr&quot;)
                {
                    Id = 1,
                    LanguageId = LangFrId,
                    RootContentId = 10012,
                    LanguageIsoCode = &quot;fr-FR&quot;
                },
                new UmbracoDomain(&quot;*1001&quot;)
                {
                    Id = 1,
                    LanguageId = LangDeId,
                    RootContentId = 1001,
                    LanguageIsoCode = &quot;de-DE&quot;
                },
                new UmbracoDomain(&quot;*10011&quot;)
                {
                    Id = 1,
                    LanguageId = LangCzId,
                    RootContentId = 10011,
                    LanguageIsoCode = &quot;cs-CZ&quot;
                },
                new UmbracoDomain(&quot;*100112&quot;)
                {
                    Id = 1,
                    LanguageId = LangNlId,
                    RootContentId = 100112,
                    LanguageIsoCode = &quot;nl-NL&quot;
                },
                new UmbracoDomain(&quot;*1001122&quot;)
                {
                    Id = 1,
                    LanguageId = LangDkId,
                    RootContentId = 1001122,
                    LanguageIsoCode = &quot;da-DK&quot;
                },
                new UmbracoDomain(&quot;*10012&quot;)
                {
                    Id = 1,
                    LanguageId = LangNlId,
                    RootContentId = 10012,
                    LanguageIsoCode = &quot;nl-NL&quot;
                },
                new UmbracoDomain(&quot;*10031&quot;)
                {
                    Id = 1,
                    LanguageId = LangNlId,
                    RootContentId =10031,
                    LanguageIsoCode = &quot;nl-NL&quot;
                }
            });
        }

        protected override string GetXmlContent(int templateId)
        {
            return @&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;
&lt;!DOCTYPE root[ 
&lt;!ELEMENT Doc ANY&gt;
&lt;!ATTLIST Doc id ID #REQUIRED&gt;
]&gt;
&lt;root id=&quot;&quot;-1&quot;&quot;&gt;
	&lt;Doc id=&quot;&quot;1001&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; nodeName=&quot;&quot;Home&quot;&quot; urlName=&quot;&quot;1001&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
		&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
        &lt;umbracoUrlAlias&gt;&lt;![CDATA[this/is/my/alias, anotheralias]]&gt;&lt;/umbracoUrlAlias&gt;
		&lt;Doc id=&quot;&quot;10011&quot;&quot; parentID=&quot;&quot;1001&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; nodeName=&quot;&quot;Sub1&quot;&quot; urlName=&quot;&quot;1001-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10011&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;content&gt;&lt;![CDATA[&lt;div&gt;This is some content&lt;/div&gt;]]&gt;&lt;/content&gt;
            &lt;umbracoUrlAlias&gt;&lt;![CDATA[page2/alias, 2ndpagealias, en/flux, endanger]]&gt;&lt;/umbracoUrlAlias&gt;
			&lt;Doc id=&quot;&quot;100111&quot;&quot; parentID=&quot;&quot;10011&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-07-20T18:07:54&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:27&quot;&quot; nodeName=&quot;&quot;Sub2&quot;&quot; urlName=&quot;&quot;1001-1-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10011,100111&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
                &lt;umbracoUrlAlias&gt;&lt;![CDATA[only/one/alias, entropy, bar/foo, en/bar/nil]]&gt;&lt;/umbracoUrlAlias&gt;
			&lt;/Doc&gt;
			&lt;Doc id=&quot;&quot;100112&quot;&quot; parentID=&quot;&quot;10011&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1001-1-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10011,100112&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;Doc id=&quot;&quot;1001121&quot;&quot; parentID=&quot;&quot;100112&quot;&quot; level=&quot;&quot;4&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1001-1-2-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10011,100112,1001121&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
					&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;/Doc&gt;
				&lt;Doc id=&quot;&quot;1001122&quot;&quot; parentID=&quot;&quot;100112&quot;&quot; level=&quot;&quot;4&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1001-1-2-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10011,100112,1001122&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
					&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;/Doc&gt;
			&lt;/Doc&gt;
		&lt;/Doc&gt;
		&lt;Doc id=&quot;&quot;10012&quot;&quot; parentID=&quot;&quot;1001&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub 2&quot;&quot; urlName=&quot;&quot;1001-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10012&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;content&gt;&lt;![CDATA[&lt;div&gt;This is some content&lt;/div&gt;]]&gt;&lt;/content&gt;
            &lt;umbracoUrlAlias&gt;&lt;![CDATA[alias42]]&gt;&lt;/umbracoUrlAlias&gt;
			&lt;Doc id=&quot;&quot;100121&quot;&quot; parentID=&quot;&quot;10012&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-07-20T18:07:54&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:27&quot;&quot; nodeName=&quot;&quot;Sub2&quot;&quot; urlName=&quot;&quot;1001-2-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10012,100121&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
                &lt;umbracoUrlAlias&gt;&lt;![CDATA[alias43]]&gt;&lt;/umbracoUrlAlias&gt;
			&lt;/Doc&gt;
			&lt;Doc id=&quot;&quot;100122&quot;&quot; parentID=&quot;&quot;10012&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1001-2-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10012,100122&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;Doc id=&quot;&quot;1001221&quot;&quot; parentID=&quot;&quot;100122&quot;&quot; level=&quot;&quot;4&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1001-2-2-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10012,100122,1001221&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
					&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;/Doc&gt;
				&lt;Doc id=&quot;&quot;1001222&quot;&quot; parentID=&quot;&quot;100122&quot;&quot; level=&quot;&quot;4&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1001-2-2-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10012,100122,1001222&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
					&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;/Doc&gt;
			&lt;/Doc&gt;
		&lt;/Doc&gt;
		&lt;Doc id=&quot;&quot;10013&quot;&quot; parentID=&quot;&quot;1001&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub 2&quot;&quot; urlName=&quot;&quot;1001-3&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1001,10013&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
            &lt;umbracoUrlAlias&gt;&lt;![CDATA[alias42]]&gt;&lt;/umbracoUrlAlias&gt;
		&lt;/Doc&gt;
	&lt;/Doc&gt;
	&lt;Doc id=&quot;&quot;1002&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1234&quot;&quot; template=&quot;&quot;&quot; + templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;Test&quot;&quot; urlName=&quot;&quot;1002&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1002&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
	&lt;/Doc&gt;
	&lt;Doc id=&quot;&quot;1003&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; + templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; nodeName=&quot;&quot;Home&quot;&quot; urlName=&quot;&quot;1003&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
		&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;Doc id=&quot;&quot;10031&quot;&quot; parentID=&quot;&quot;1003&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; nodeName=&quot;&quot;Sub1&quot;&quot; urlName=&quot;&quot;1003-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10031&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;content&gt;&lt;![CDATA[&lt;div&gt;This is some content&lt;/div&gt;]]&gt;&lt;/content&gt;
			&lt;Doc id=&quot;&quot;100311&quot;&quot; parentID=&quot;&quot;10031&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-07-20T18:07:54&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:27&quot;&quot; nodeName=&quot;&quot;Sub2&quot;&quot; urlName=&quot;&quot;1003-1-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10031,100311&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
			&lt;/Doc&gt;
			&lt;Doc id=&quot;&quot;100312&quot;&quot; parentID=&quot;&quot;10031&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1003-1-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10031,100312&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;Doc id=&quot;&quot;1003121&quot;&quot; parentID=&quot;&quot;100312&quot;&quot; level=&quot;&quot;4&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1003-1-2-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10031,100312,1003121&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
					&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;/Doc&gt;
				&lt;Doc id=&quot;&quot;1003122&quot;&quot; parentID=&quot;&quot;100312&quot;&quot; level=&quot;&quot;4&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1003-1-2-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10031,100312,1003122&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
					&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;/Doc&gt;
			&lt;/Doc&gt;
		&lt;/Doc&gt;
		&lt;Doc id=&quot;&quot;10032&quot;&quot; parentID=&quot;&quot;1003&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub 2&quot;&quot; urlName=&quot;&quot;1003-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10032&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
			&lt;content&gt;&lt;![CDATA[&lt;div&gt;This is some content&lt;/div&gt;]]&gt;&lt;/content&gt;
			&lt;Doc id=&quot;&quot;100321&quot;&quot; parentID=&quot;&quot;10032&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-07-20T18:07:54&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:27&quot;&quot; nodeName=&quot;&quot;Sub2&quot;&quot; urlName=&quot;&quot;1003-2-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10032,100321&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
			&lt;/Doc&gt;
			&lt;Doc id=&quot;&quot;100322&quot;&quot; parentID=&quot;&quot;10032&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1003-2-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10032,100322&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
				&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;Doc id=&quot;&quot;1003221&quot;&quot; parentID=&quot;&quot;100322&quot;&quot; level=&quot;&quot;4&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;0&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1003-2-2-1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10032,100322,1003221&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
					&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;/Doc&gt;
				&lt;Doc id=&quot;&quot;1003222&quot;&quot; parentID=&quot;&quot;100322&quot;&quot; level=&quot;&quot;4&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;1003-2-2-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10032,100322,1003222&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
					&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
				&lt;/Doc&gt;
			&lt;/Doc&gt;
		&lt;/Doc&gt;
		&lt;Doc id=&quot;&quot;10033&quot;&quot; parentID=&quot;&quot;1003&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;&quot; +
                   templateId +
                   @&quot;&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub 2&quot;&quot; urlName=&quot;&quot;1003-3&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1003,10033&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;
		&lt;/Doc&gt;
	&lt;/Doc&gt;
&lt;/root&gt;&quot;;
        }

        #region Cases
        [TestCase(&quot;http://domain1.com/&quot;, &quot;de-DE&quot;, 1001)]
        [TestCase(&quot;http://domain1.com/1001-1&quot;, &quot;de-DE&quot;, 10011)]
        [TestCase(&quot;http://domain1.com/1001-1/1001-1-1&quot;, &quot;de-DE&quot;, 100111)]
        [TestCase(&quot;http://domain1.com/en&quot;, &quot;en-US&quot;, 10011)]
        [TestCase(&quot;http://domain1.com/en/1001-1-1&quot;, &quot;en-US&quot;, 100111)]
        [TestCase(&quot;http://domain1.com/fr&quot;, &quot;fr-FR&quot;, 10012)]
        [TestCase(&quot;http://domain1.com/fr/1001-2-1&quot;, &quot;fr-FR&quot;, 100121)]
        #endregion
        public void DomainAndCulture(string inputUrl, string expectedCulture, int expectedNode)
        {
            SetDomains1();

            var routingContext = GetRoutingContext(inputUrl);
            var url = routingContext.UmbracoContext.CleanedUmbracoUrl;
            //very important to use the cleaned up umbraco url
            var pcr = new PublishedContentRequest(url, routingContext);

            // lookup domain
            pcr.Engine.FindDomain();

            Assert.AreEqual(expectedCulture, pcr.Culture.Name);

            SettingsForTests.HideTopLevelNodeFromPath = false;
            var finder = new ContentFinderByNiceUrl();
            var result = finder.TryFindContent(pcr);

            Assert.IsTrue(result);
            Assert.AreEqual(pcr.PublishedContent.Id, expectedNode);
        }

        #region Cases
        [TestCase(&quot;http://domain1.com/&quot;, &quot;de-DE&quot;, 1001)] // domain takes over local wildcard at 1001
        [TestCase(&quot;http://domain1.com/1001-1&quot;, &quot;cs-CZ&quot;, 10011)] // wildcard on 10011 applies
        [TestCase(&quot;http://domain1.com/1001-1/1001-1-1&quot;, &quot;cs-CZ&quot;, 100111)] // wildcard on 10011 applies
        [TestCase(&quot;http://domain1.com/1001-1/1001-1-2&quot;, &quot;nl-NL&quot;, 100112)] // wildcard on 100112 applies
        [TestCase(&quot;http://domain1.com/1001-1/1001-1-2/1001-1-2-1&quot;, &quot;nl-NL&quot;, 1001121)] // wildcard on 100112 applies
        [TestCase(&quot;http://domain1.com/1001-1/1001-1-2/1001-1-2-2&quot;, &quot;da-DK&quot;, 1001122)] // wildcard on 1001122 applies

        [TestCase(&quot;http://domain1.com/1001-2&quot;, &quot;nl-NL&quot;, 10012)] // wildcard on 10012 applies
        [TestCase(&quot;http://domain1.com/1001-2/1001-2-1&quot;, &quot;nl-NL&quot;, 100121)] // wildcard on 10012 applies
        [TestCase(&quot;http://domain1.com/en&quot;, &quot;en-US&quot;, 10011)] // domain takes over local wildcard at 10011
        [TestCase(&quot;http://domain1.com/en/1001-1-1&quot;, &quot;en-US&quot;, 100111)] // domain takes over local wildcard at 10011
        [TestCase(&quot;http://domain1.com/en/1001-1-2&quot;, &quot;nl-NL&quot;, 100112)] // wildcard on 100112 applies
        [TestCase(&quot;http://domain1.com/en/1001-1-2/1001-1-2-1&quot;, &quot;nl-NL&quot;, 1001121)] // wildcard on 100112 applies
        [TestCase(&quot;http://domain1.com/en/1001-1-2/1001-1-2-2&quot;, &quot;da-DK&quot;, 1001122)] // wildcard on 1001122 applies

        [TestCase(&quot;http://domain1.com/fr&quot;, &quot;fr-FR&quot;, 10012)] // domain takes over local wildcard at 10012
        [TestCase(&quot;http://domain1.com/fr/1001-2-1&quot;, &quot;fr-FR&quot;, 100121)] // domain takes over local wildcard at 10012

        [TestCase(&quot;/1003&quot;, null, 1003)] // default culture (no domain)
        [TestCase(&quot;/1003/1003-1&quot;, &quot;nl-NL&quot;, 10031)] // wildcard on 10031 applies
        [TestCase(&quot;/1003/1003-1/1003-1-1&quot;, &quot;nl-NL&quot;, 100311)] // wildcard on 10031 applies
        #endregion
        public void DomainAndCultureWithWildcards(string inputUrl, string expectedCulture, int expectedNode)
        {
            SetDomains2();

            // defaults depend on test environment
            expectedCulture = expectedCulture ?? System.Threading.Thread.CurrentThread.CurrentUICulture.Name;

            var routingContext = GetRoutingContext(inputUrl);
            var url = routingContext.UmbracoContext.CleanedUmbracoUrl;
            //very important to use the cleaned up umbraco url
            var pcr = new PublishedContentRequest(url, routingContext);

            // lookup domain
            pcr.Engine.FindDomain();

            // find document
            SettingsForTests.HideTopLevelNodeFromPath = false;
            var finder = new ContentFinderByNiceUrl();
            var result = finder.TryFindContent(pcr);

            // apply wildcard domain
            pcr.Engine.HandleWildcardDomains();

            Assert.IsTrue(result);
            Assert.AreEqual(expectedCulture, pcr.Culture.Name);
            Assert.AreEqual(pcr.PublishedContent.Id, expectedNode);
        }



        #region Cases
        [TestCase(10011, &quot;http://domain1.com/&quot;, &quot;en-US&quot;)]
        [TestCase(100111, &quot;http://domain1.com/&quot;, &quot;en-US&quot;)]
        [TestCase(10011, &quot;http://domain1.fr/&quot;, &quot;fr-FR&quot;)]
        [TestCase(100111, &quot;http://domain1.fr/&quot;, &quot;fr-FR&quot;)]
        [TestCase(1001121, &quot;http://domain1.fr/&quot;, &quot;de-DE&quot;)]
        #endregion
        public void GetCulture(int nodeId, string currentUrl, string expectedCulture)
        {
            var domainService = SetupDomainServiceMock(new[]
            {
                new UmbracoDomain(&quot;domain1.com/&quot;)
                {
                    Id = 1,
                    LanguageId = LangEngId,
                    RootContentId = 1001,
                    LanguageIsoCode = &quot;en-US&quot;
                },
                new UmbracoDomain(&quot;domain1.fr/&quot;)
                {
                    Id = 1,
                    LanguageId = LangFrId,
                    RootContentId = 1001,
                    LanguageIsoCode = &quot;fr-FR&quot;
                },
                new UmbracoDomain(&quot;*100112&quot;)
                {
                    Id = 1,
                    LanguageId = LangDeId,
                    RootContentId = 100112,
                    LanguageIsoCode = &quot;de-DE&quot;
                }
            });

            var routingContext = GetRoutingContext(&quot;http://anything/&quot;);
            var umbracoContext = routingContext.UmbracoContext;

            var content = umbracoContext.ContentCache.GetById(nodeId);
            Assert.IsNotNull(content);

            var culture = global::Umbraco.Web.Models.ContentExtensions.GetCulture(umbracoContext, domainService, ServiceContext.LocalizationService, null, content.Id, content.Path, new Uri(currentUrl));
            Assert.AreEqual(expectedCulture, culture.Name);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,1],[21,13,21,101,1],[22,13,22,37,1],[23,9,23,10,1],[26,9,26,10,1],[27,13,50,16,1],[51,9,51,10,1],[54,9,54,10,1],[55,13,120,16,1],[121,9,121,10,1],[124,9,124,10,1],[125,13,252,10,1],[257,9,257,10,1],[269,9,269,10,1],[270,13,270,27,1],[272,13,272,62,1],[273,13,273,71,1],[275,13,275,72,1],[278,13,278,37,1],[280,13,280,64,1],[282,13,282,63,1],[283,13,283,55,1],[284,13,284,53,1],[286,13,286,35,1],[287,13,287,68,1],[288,9,288,10,1],[314,9,314,10,1],[315,13,315,27,1],[318,13,318,110,1],[320,13,320,62,1],[321,13,321,71,1],[323,13,323,72,1],[326,13,326,37,1],[329,13,329,63,1],[330,13,330,55,1],[331,13,331,53,1],[334,13,334,48,1],[336,13,336,35,1],[337,13,337,64,1],[338,13,338,68,1],[339,9,339,10,1],[351,9,351,10,1],[352,13,375,16,1],[377,13,377,72,1],[378,13,378,64,1],[380,13,380,71,1],[381,13,381,39,1],[383,13,383,203,1],[384,13,384,60,1],[385,9,385,10,1]]);
    </script>
  </body>
</html>