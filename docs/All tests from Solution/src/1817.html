<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSixZeroOne\UpdatePropertyTypesAndGroups.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSixZeroOne
{
    [Migration(&quot;6.0.2&quot;, 0, GlobalSettings.UmbracoMigrationName)]
    public class UpdatePropertyTypesAndGroups : MigrationBase
    {
        public UpdatePropertyTypesAndGroups(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {
            Execute.Code(UpdatePropertyTypesAndGroupsDo);
        }

        public override void Down()
        {
            
        }

        public static string UpdatePropertyTypesAndGroupsDo(Database database)
        {
            if (database != null)
            {
                //Fetch all PropertyTypes that belongs to a PropertyTypeGroup                
                //NOTE: We are writing the full query because we&#39;ve added a column to the PropertyTypeDto in later versions so one of the columns
                // won&#39;t exist yet
                var propertyTypes = database.Fetch&lt;dynamic&gt;(&quot;SELECT * FROM cmsPropertyType WHERE propertyTypeGroupId &gt; 0&quot;);

                // need to use dynamic, as PropertyTypeGroupDto has new properties
                var propertyGroups = database.Fetch&lt;dynamic&gt;(&quot;SELECT * FROM cmsPropertyTypeGroup WHERE id &gt; 0&quot;);

                foreach (var propertyType in propertyTypes)
                {
                    // get the PropertyTypeGroup of the current PropertyType, skip if not found
                    var propertyTypeGroup = propertyGroups.FirstOrDefault(x =&gt; x.id == propertyType.propertyTypeGroupId);
                    if (propertyTypeGroup == null) continue;

                    // if the PropretyTypeGroup belongs to the same content type as the PropertyType, then fine
                    if (propertyTypeGroup.contenttypeNodeId == propertyType.contentTypeId) continue;

                    // else we want to assign the PropertyType to a proper PropertyTypeGroup
                    // ie one that does belong to the same content - look for it
                    var okPropertyTypeGroup = propertyGroups.FirstOrDefault(x =&gt;
                        x.text == propertyTypeGroup.text &amp;&amp; // same name
                        x.contenttypeNodeId == propertyType.contentTypeId); // but for proper content type

                    if (okPropertyTypeGroup == null)
                    {
                        // does not exist, create a new PropertyTypeGroup
                        // cannot use a PropertyTypeGroupDto because of the new (not-yet-existing) uniqueID property
                        // cannot use a dynamic because database.Insert fails to set the value of property
                        var propertyGroup = new PropertyTypeGroupDtoTemp
                        {
                            id = 0,
                            contenttypeNodeId = propertyType.contentTypeId,
                            text = propertyTypeGroup.text,
                            sortorder = propertyTypeGroup.sortorder
                        };

                        // save + add to list of groups
                        int id = Convert.ToInt16(database.Insert(&quot;cmsPropertyTypeGroup&quot;, &quot;id&quot;, propertyGroup));
                        propertyGroup.id = id;
                        propertyGroups.Add(propertyGroup);

                        // update the PropertyType to use the new PropertyTypeGroup
                        propertyType.propertyTypeGroupId = id;
                    }
                    else
                    {
                        // exists, update PropertyType to use the PropertyTypeGroup
                        propertyType.propertyTypeGroupId = okPropertyTypeGroup.id;
                    }
                    database.Update(&quot;cmsPropertyType&quot;, &quot;id&quot;, propertyType);
                }
            }

            return string.Empty;
        }

        private class PropertyTypeGroupDtoTemp
        {
            public int id { get; set; }
            public int contenttypeNodeId { get; set; }
            public string text { get; set; }
            public int sortorder { get; set; }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,93,13,116,0],[14,9,14,10,0],[15,9,15,10,0],[18,9,18,10,0],[19,13,19,58,0],[20,9,20,10,0],[23,9,23,10,0],[25,9,25,10,0],[28,9,28,10,0],[29,13,29,34,0],[30,13,30,14,0],[34,17,34,124,0],[37,17,37,113,0],[39,17,39,24,0],[39,26,39,42,0],[39,43,39,45,0],[39,46,39,59,0],[40,17,40,18,0],[42,21,42,80,0],[42,80,42,120,0],[42,120,42,122,0],[42,21,42,122,0],[43,21,43,51,0],[43,52,43,61,0],[46,21,46,91,0],[46,92,46,101,0],[50,21,51,25,0],[51,25,52,74,0],[52,74,52,76,0],[50,21,52,76,0],[54,21,54,53,0],[55,21,55,22,0],[59,25,65,27,0],[68,25,68,112,0],[69,25,69,47,0],[70,25,70,59,0],[73,25,73,63,0],[74,21,74,22,0],[76,21,76,22,0],[78,25,78,83,0],[79,21,79,22,0],[80,21,80,76,0],[81,17,81,18,0],[82,13,82,14,0],[84,13,84,33,0],[85,9,85,10,0],[89,29,89,33,0],[89,34,89,38,0],[90,44,90,48,0],[90,49,90,53,0],[91,34,91,38,0],[91,39,91,43,0],[92,36,92,40,0],[92,41,92,45,0]]);
    </script>
  </body>
</html>