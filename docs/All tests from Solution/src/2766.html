<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\tom pipe\documents\hexadigital\code\umbraco\umbraco-cms\src\umbraco.web.ui\umbraco\settings\views\editview.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Web.Trees;
using Umbraco.Web.UI.Controls;
using umbraco;
using umbraco.BasePages;
using umbraco.cms.businesslogic.template;
using umbraco.cms.helpers;
using umbraco.cms.presentation.Trees;
using Umbraco.Core;
using umbraco.uicontrols;

namespace Umbraco.Web.UI.Umbraco.Settings.Views
{
	public partial class EditView : global::umbraco.BasePages.UmbracoEnsuredPage
	{
		private Template _template;
		public MenuButton SaveButton;

		public EditView()
		{
			CurrentApp = global::umbraco.BusinessLogic.DefaultApps.settings.ToString();
		}

		/// &lt;summary&gt;
		/// The type of MVC/Umbraco view the editor is editing
		/// &lt;/summary&gt;
		public enum ViewEditorType
		{
			Template,
			PartialView,
            PartialViewMacro
		}

		/// &lt;summary&gt;
		/// Returns the type of view being edited
		/// &lt;/summary&gt;
		protected ViewEditorType EditorType
		{
		    get
		    {
		        if (_template != null) return ViewEditorType.Template;
                if (Request.QueryString[&quot;treeType&quot;].IsNullOrWhiteSpace() == false &amp;&amp; Request.QueryString[&quot;treeType&quot;].InvariantEquals(&quot;partialViewMacros&quot;)) return ViewEditorType.PartialViewMacro;
		        return ViewEditorType.PartialView;
		    }
		}

        protected string TemplateTreeSyncPath { get; private set; }
	    
        /// &lt;summary&gt;
        /// This view is shared between different trees so we&#39;ll look for the query string
        /// &lt;/summary&gt;
        protected string CurrentTreeType
	    {
	        get
	        {
	            if (Request.QueryString[&quot;treeType&quot;].IsNullOrWhiteSpace())
	            {
	                return TreeDefinitionCollection.Instance.FindTree&lt;PartialViewsTree&gt;().Tree.Alias;
	            }
	            return Request.CleanForXss(&quot;treeType&quot;);
	        }
	    }

		/// &lt;summary&gt;
		/// Returns the original file name that the editor was loaded with
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;
		/// this is used for editing a partial view
		/// &lt;/remarks&gt;
		protected string OriginalFileName { get; private set; }

		protected override void OnLoad(EventArgs e)
		{
			base.OnLoad(e);

			if (!IsPostBack)
			{

				//configure screen for editing a template
				if (_template != null)
				{
					MasterTemplate.Items.Add(new ListItem(ui.Text(&quot;none&quot;), &quot;0&quot;));
					var selectedTemplate = string.Empty;

					foreach (var t in Template.GetAllAsList())
					{
						if (t.Id == _template.Id) continue;

						var li = new ListItem(t.Text, t.Id.ToString(CultureInfo.InvariantCulture));
						li.Attributes.Add(&quot;id&quot;, t.Alias.Replace(&quot; &quot;, &quot;&quot;) + &quot;.cshtml&quot;);
						MasterTemplate.Items.Add(li);
					}

					try
					{
						if (_template.MasterTemplate &gt; 0)
							MasterTemplate.SelectedValue = _template.MasterTemplate.ToString(CultureInfo.InvariantCulture);
					}
					catch (Exception ex)
					{
                        LogHelper.Error&lt;EditView&gt;(&quot;An error occurred setting a master template id&quot;, ex);
					}

					MasterTemplate.SelectedValue = selectedTemplate;
					NameTxt.Text = _template.GetRawText();
					AliasTxt.Text = _template.Alias;
					editorSource.Text = _template.Design;
				    PathPrefix.Visible = false;
				}
				else
				{
					//configure editor for editing a file....

					NameTxt.Text = OriginalFileName;
				    var svce = ApplicationContext.Current.Services.FileService;
                    var file = EditorType == ViewEditorType.PartialView
				        ? svce.GetPartialView(OriginalFileName)
                        : svce.GetPartialViewMacro(OriginalFileName);
				    editorSource.Text = file.Content;

                    const string prefixFormat = &quot;&lt;span style=\&quot;display: inline-block; height: 20px; line-height: 20px; margin-bottom: 0px; padding: 4px 6px;\&quot;&gt;{0}&lt;/span&gt;&quot;;
                    PathPrefix.Text = string.Format(prefixFormat, EditorType == ViewEditorType.PartialView
				        ? &quot;Partials/&quot;
				        : &quot;MacroPartials/&quot;);
				}							
			}
            
            ClientTools
                .SetActiveTreeType(CurrentTreeType)
                .SyncTree(TemplateTreeSyncPath, false);
		}


		protected override void OnInit(EventArgs e)
		{
			base.OnInit(e);

			//check if a templateId is assigned, meaning we are editing a template
			if (!Request.QueryString[&quot;templateID&quot;].IsNullOrWhiteSpace())
			{
				_template = new Template(int.Parse(Request.QueryString[&quot;templateID&quot;]));
                TemplateTreeSyncPath = &quot;-1,init,&quot; + _template.Path.Replace(&quot;-1,&quot;, &quot;&quot;);
			}
			else if (!Request.QueryString[&quot;file&quot;].IsNullOrWhiteSpace())
			{
				//we are editing a view (i.e. partial view)
				OriginalFileName = HttpUtility.UrlDecode(Request.QueryString[&quot;file&quot;]);

                //TemplateTreeSyncPath = &quot;-1,init,&quot; + Path.GetFileName(OriginalFileName);

                TemplateTreeSyncPath = DeepLink.GetTreePathFromFilePath(OriginalFileName.TrimStart(&quot;MacroPartials/&quot;).TrimStart(&quot;Partials/&quot;));
			}
			else
			{
				throw new InvalidOperationException(&quot;Cannot render the editor without a supplied templateId or a file&quot;);
			}
			
			Panel1.hasMenu = true;
            var editor = Panel1.NewTabPage(ui.Text(&quot;template&quot;));
            editor.Controls.Add(Pane8);

            var props = Panel1.NewTabPage(ui.Text(&quot;properties&quot;));
            props.Controls.Add(Pane7);


            SaveButton = Panel1.Menu.NewButton();
            SaveButton.Text = ui.Text(&quot;save&quot;);
            SaveButton.ButtonType = MenuButtonType.Primary;
            SaveButton.ID = &quot;save&quot;;
            SaveButton.CssClass = &quot;client-side&quot;;

			Panel1.Text = ui.Text(&quot;edittemplate&quot;);
			pp_name.Text = ui.Text(&quot;name&quot;, base.getUser());
			pp_alias.Text = ui.Text(&quot;alias&quot;, base.getUser());
			pp_masterTemplate.Text = ui.Text(&quot;mastertemplate&quot;, base.getUser());

			// Editing buttons
            MenuIconI umbField = editorSource.Menu.NewIcon();
			umbField.ImageURL = UmbracoPath + &quot;/images/editor/insField.gif&quot;;
			umbField.OnClickCommand =
				ClientTools.Scripts.OpenModalWindow(
					IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/umbracoField.aspx?objectId=&quot; +
					editorSource.ClientID + &quot;&amp;tagName=UMBRACOGETDATA&amp;mvcView=true&quot;, ui.Text(&quot;template&quot;, &quot;insertPageField&quot;), 640, 550);
			umbField.AltText = ui.Text(&quot;template&quot;, &quot;insertPageField&quot;);


			// TODO: Update icon
            MenuIconI umbDictionary = editorSource.Menu.NewIcon();
			umbDictionary.ImageURL = GlobalSettings.Path + &quot;/images/editor/dictionaryItem.gif&quot;;
			umbDictionary.OnClickCommand =
				ClientTools.Scripts.OpenModalWindow(
					IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/dialogs/umbracoField.aspx?objectId=&quot; +
                    editorSource.ClientID + &quot;&amp;tagName=UMBRACOGETDICTIONARY&amp;mvcView=true&quot;, ui.Text(&quot;template&quot;, &quot;insertDictionaryItem&quot;),
					640, 550);
			umbDictionary.AltText = &quot;Insert umbraco dictionary item&quot;;

			var macroSplitButton = new InsertMacroSplitButton
				{
					ClientCallbackInsertMacroMarkup = &quot;function(alias) {editViewEditor.insertMacroMarkup(alias);}&quot;,
					ClientCallbackOpenMacroModel = &quot;function(alias) {editViewEditor.openMacroModal(alias);}&quot;
				};
            editorSource.Menu.InsertNewControl(macroSplitButton, 40);

            MenuIconI umbTemplateQueryBuilder = editorSource.Menu.NewIcon();
            umbTemplateQueryBuilder.ImageURL = UmbracoPath + &quot;/images/editor/inshtml.gif&quot;;
            umbTemplateQueryBuilder.OnClickCommand = &quot;editViewEditor.openQueryModal()&quot;;
            umbTemplateQueryBuilder.AltText = &quot;Open query builder&quot;;

			if (_template == null)
			{
				InitializeEditorForPartialView();
			}
			else
			{
				InitializeEditorForTemplate();	
			}
			
		}

		protected override void OnPreRender(EventArgs e)
		{
			base.OnPreRender(e);
			ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/codeEditorSave.asmx&quot;));
			ScriptManager.GetCurrent(Page).Services.Add(new ServiceReference(&quot;../webservices/legacyAjaxCalls.asmx&quot;));
		}
		
		/// &lt;summary&gt;
		/// Configure the editor for partial view editing
		/// &lt;/summary&gt;
		private void InitializeEditorForPartialView()
		{
			pp_masterTemplate.Visible = false;
			pp_alias.Visible = false;
			pp_name.Text = &quot;Filename&quot;;
		}

		/// &lt;summary&gt;
		/// Configure the editor for editing a template
		/// &lt;/summary&gt;
		private void InitializeEditorForTemplate()
		{

            //TODO: implement content placeholders, etc... just like we had in v5

            editorSource.Menu.InsertSplitter();

            MenuIconI umbRenderBody = editorSource.Menu.NewIcon();
            umbRenderBody.ImageURL = UmbracoPath + &quot;/images/editor/renderbody.gif&quot;;
            //umbContainer.AltText = ui.Text(&quot;template&quot;, &quot;insertContentAreaPlaceHolder&quot;);
            umbRenderBody.AltText = &quot;Insert @RenderBody()&quot;;

            umbRenderBody.OnClickCommand = &quot;editViewEditor.insertRenderBody()&quot;;

            MenuIconI umbSection = editorSource.Menu.NewIcon();
            umbSection.ImageURL = UmbracoPath + &quot;/images/editor/masterpagePlaceHolder.gif&quot;;
            //umbContainer.AltText = ui.Text(&quot;template&quot;, &quot;insertContentAreaPlaceHolder&quot;);
            umbSection.AltText = &quot;Insert Section&quot;;

            umbSection.OnClickCommand = &quot;editViewEditor.openSnippetModal(&#39;section&#39;)&quot;;

            MenuIconI umbRenderSection = editorSource.Menu.NewIcon();
            umbRenderSection.ImageURL = UmbracoPath + &quot;/images/editor/masterpageContent.gif&quot;;
            //umbContainer.AltText = ui.Text(&quot;template&quot;, &quot;insertContentAreaPlaceHolder&quot;);
            umbRenderSection.AltText = &quot;Insert @RenderSection&quot;;

            umbRenderSection.OnClickCommand = &quot;editViewEditor.openSnippetModal(&#39;rendersection&#39;)&quot;;

        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,3,28,20,0],[29,3,29,4,0],[30,4,30,79,0],[31,3,31,4,0],[49,7,49,8,0],[50,11,50,33,0],[50,34,50,65,0],[51,17,51,155,0],[51,156,51,195,0],[52,11,52,45,0],[53,7,53,8,0],[56,49,56,53,0],[56,54,56,66,0],[64,10,64,11,0],[65,14,65,71,0],[66,14,66,15,0],[67,18,67,99,0],[69,14,69,53,0],[70,10,70,11,0],[79,39,79,43,0],[79,44,79,56,0],[82,3,82,4,0],[83,4,83,19,0],[85,4,85,20,0],[86,4,86,5,0],[89,5,89,27,0],[90,5,90,6,0],[91,6,91,67,0],[92,6,92,42,0],[94,6,94,13,0],[94,15,94,20,0],[94,21,94,23,0],[94,24,94,47,0],[95,6,95,7,0],[96,7,96,32,0],[96,33,96,42,0],[98,7,98,82,0],[99,7,99,69,0],[100,7,100,36,0],[101,6,101,7,0],[104,6,104,7,0],[105,7,105,40,0],[106,8,106,103,0],[107,6,107,7,0],[108,6,108,26,0],[109,6,109,7,0],[110,25,110,105,0],[111,6,111,7,0],[113,6,113,54,0],[114,6,114,44,0],[115,6,115,38,0],[116,6,116,43,0],[117,9,117,36,0],[118,5,118,6,0],[120,5,120,6,0],[123,6,123,38,0],[124,9,124,68,0],[125,21,127,70,0],[128,9,128,42,0],[131,21,133,33,0],[134,5,134,6,0],[135,4,135,5,0],[137,13,139,56,0],[140,3,140,4,0],[144,3,144,4,0],[145,4,145,19,0],[148,4,148,64,0],[149,4,149,5,0],[150,5,150,76,0],[151,17,151,87,0],[152,4,152,5,0],[153,9,153,63,0],[154,4,154,5,0],[156,5,156,75,0],[160,17,160,142,0],[161,4,161,5,0],[163,4,163,5,0],[164,5,164,109,0],[167,4,167,26,0],[168,13,168,65,0],[169,13,169,40,0],[171,13,171,66,0],[172,13,172,39,0],[175,13,175,50,0],[176,13,176,47,0],[177,13,177,60,0],[178,13,178,36,0],[179,13,179,49,0],[181,4,181,42,0],[182,4,182,51,0],[183,4,183,53,0],[184,4,184,71,0],[187,13,187,62,0],[188,4,188,68,0],[189,4,192,120,0],[193,4,193,62,0],[197,13,197,67,0],[198,4,198,87,0],[199,4,203,16,0],[204,4,204,61,0],[206,4,210,7,0],[211,13,211,70,0],[213,13,213,77,0],[214,13,214,91,0],[215,13,215,88,0],[216,13,216,68,0],[218,4,218,26,0],[219,4,219,5,0],[220,5,220,38,0],[221,4,221,5,0],[223,4,223,5,0],[224,5,224,35,0],[225,4,225,5,0],[227,3,227,4,0],[230,3,230,4,0],[231,4,231,24,0],[232,4,232,108,0],[233,4,233,109,0],[234,3,234,4,0],[240,3,240,4,0],[241,4,241,38,0],[242,4,242,29,0],[243,4,243,30,0],[244,3,244,4,0],[250,3,250,4,0],[254,13,254,48,0],[256,13,256,67,0],[257,13,257,84,0],[259,13,259,60,0],[261,13,261,80,0],[263,13,263,64,0],[264,13,264,92,0],[266,13,266,51,0],[268,13,268,86,0],[270,13,270,70,0],[271,13,271,94,0],[273,13,273,64,0],[275,13,275,98,0],[277,9,277,10,0]]);
    </script>
  </body>
</html>