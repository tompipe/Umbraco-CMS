<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.datalayer\SqlHelpers\SqlServer\SqlServerTableUtility.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text;
using umbraco.DataLayer.Utility.Table;

namespace umbraco.DataLayer.SqlHelpers.SqlServer
{
    /// &lt;summary&gt;
    /// SQL Server implementation of &lt;see cref=&quot;DefaultTableUtility&amp;lt;S&amp;gt;&quot;/&gt;.
    /// &lt;/summary&gt;
    [Obsolete(&quot;The legacy installers are no longer used and will be removed from the codebase in the future&quot;)]
    public class SqlServerTableUtility : DefaultTableUtility&lt;SqlServerHelper&gt;
    {
        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;SqlServerTableUtility&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sqlHelper&quot;&gt;The SQL helper.&lt;/param&gt;
        public SqlServerTableUtility(SqlServerHelper sqlHelper)
            : base(sqlHelper)
        { }

        #region DefaultTableUtility&lt;SqlServerHelper&gt; members

        /// &lt;summary&gt;
        /// Gets the table with the specified name.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;name&quot;&gt;The name.&lt;/param&gt;
        /// &lt;returns&gt;The table, or &lt;c&gt;null&lt;/c&gt; if no table with that name exists.&lt;/returns&gt;
        public override ITable GetTable(string name)
        {
            if (name == null)
                throw new ArgumentNullException(&quot;name&quot;);

            ITable table = null;

            // get name in correct casing
            using (var sqlHelper = SqlHelper)
                name = sqlHelper.ExecuteScalar&lt;string&gt;(&quot;SELECT name FROM sys.tables WHERE name=@name&quot;,
                                                          sqlHelper.CreateParameter(&quot;name&quot;, name));
            if (name != null)
            {
                table = new DefaultTable(name);

                using (var sqlHelper = SqlHelper)
                using (IRecordsReader reader = sqlHelper.ExecuteReader(
                        @&quot;SELECT c.name AS Name, st.name AS DataType, c.max_length, c.is_nullable, c.is_identity
                          FROM sys.tables AS t
                            JOIN sys.columns AS c ON t.object_id = c.object_id
                            JOIN sys.schemas AS s ON s.schema_id = t.schema_id
                            JOIN sys.types AS ty ON ty.user_type_id = c.user_type_id
                            JOIN sys.types st ON ty.system_type_id = st.user_type_id
                          WHERE t.name = @name
                          ORDER BY c.column_id&quot;, sqlHelper.CreateParameter(&quot;name&quot;, name)))
                {
                    while (reader.Read())
                    {
                        table.AddField(table.CreateField(reader.GetString(&quot;Name&quot;), GetType(reader)));
                    }
                }
            }

            return table;
        }

        /// &lt;summary&gt;
        /// Saves or updates the table.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;table&quot;&gt;The table to be saved.&lt;/param&gt;
        public override void SaveTable(ITable table)
        {
            if (table == null)
                throw new ArgumentNullException(&quot;table&quot;);

            ITable oldTable = GetTable(table.Name);

            // create the table if it didn&#39;t exist, update fields otherwise
            if (oldTable == null)
            {
                CreateTable(table);
            }
            else
            {
                foreach (IField field in table)
                {
                    // create the field if it did&#39;t exist in the old table
                    if (oldTable.FindField(field.Name)==null)
                    {
                        CreateColumn(table, field);
                    }
                }
            }
        }

        #endregion

        #region Protected Helper Methods

        /// &lt;summary&gt;
        /// Creates the table in the data source.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;table&quot;&gt;The table.&lt;/param&gt;
        protected virtual void CreateTable(ITable table)
        {
            Debug.Assert(table != null);

            // create enumerator and check for first field
            IEnumerator&lt;IField&gt; fieldEnumerator = table.GetEnumerator();
            bool hasNext = fieldEnumerator.MoveNext();
            if(!hasNext)
                throw new ArgumentException(&quot;The table must contain at least one field.&quot;);

            // create query
            StringBuilder createTableQuery = new StringBuilder();
            using (var sqlHelper = SqlHelper)
                createTableQuery.AppendFormat(&quot;CREATE TABLE [{0}] (&quot;, sqlHelper.EscapeString(table.Name));

            // add fields
            while (hasNext)
            {
                // add field name and type
                IField field = fieldEnumerator.Current;
                createTableQuery.Append(&#39;[&#39;).Append(field.Name).Append(&#39;]&#39;);
                createTableQuery.Append(&#39; &#39;).Append(GetDatabaseType(field));

                // append comma if a following field exists
                hasNext = fieldEnumerator.MoveNext();
                if (hasNext)
                {
                    createTableQuery.Append(&#39;,&#39;);
                }
            }

            // close CREATE TABLE x (...) bracket
            createTableQuery.Append(&#39;)&#39;);

            // execute query
            try
            {
                using (var sqlHelper = SqlHelper)
                    sqlHelper.ExecuteNonQuery(createTableQuery.ToString());
            }
            catch (Exception executeException)
            {
                throw new UmbracoException(String.Format(&quot;Could not create table &#39;{0}&#39;.&quot;, table), executeException);
            }
        }

        /// &lt;summary&gt;
        /// Creates a new column in the table.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;table&quot;&gt;The table.&lt;/param&gt;
        /// &lt;param name=&quot;field&quot;&gt;The field used to create the column.&lt;/param&gt;
        protected virtual void CreateColumn(ITable table, IField field)
        {
            Debug.Assert(table != null &amp;&amp; field != null);

            StringBuilder addColumnQuery = new StringBuilder();
            using (var sqlHelper = SqlHelper)
                addColumnQuery.AppendFormat(&quot;ALTER TABLE [{0}] ADD [{1}] {2}&quot;,
                                        sqlHelper.EscapeString(table.Name),
                                        sqlHelper.EscapeString(field.Name),
                                        sqlHelper.EscapeString(GetDatabaseType(field)));
            try
            {
                using (var sqlHelper = SqlHelper)
                    sqlHelper.ExecuteNonQuery(addColumnQuery.ToString());
            }
            catch (Exception executeException)
            {
                throw new UmbracoException(String.Format(&quot;Could not create column &#39;{0}&#39; in table &#39;{1}&#39;.&quot;,
                                                         field, table.Name), executeException);
            }
        }

        /// &lt;summary&gt;
        /// Gets the .Net type corresponding to the specified database data type.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataTypeReader&quot;&gt;The data type reader.&lt;/param&gt;
        /// &lt;returns&gt;The .Net type&lt;/returns&gt;
        protected virtual Type GetType(IRecordsReader dataTypeReader)
        {
            string typeName = dataTypeReader.GetString(&quot;DataType&quot;);

            switch (typeName)
            {
                case &quot;bit&quot;:                 return typeof(bool);
                case &quot;tinyint&quot;:             return typeof(byte);
                case &quot;datetime&quot;:            return typeof(DateTime);
                // TODO: return different decimal type according to field precision
                case &quot;decimal&quot;:             return typeof(decimal);
                case &quot;uniqueidentifier&quot;:    return typeof(Guid);
                case &quot;smallint&quot;:            return typeof(Int16);
                case &quot;int&quot;:                 return typeof(Int32);
                case &quot;bigint&quot;:              return typeof(Int64);
                case &quot;nvarchar&quot;:            return typeof(string);
                default:
                    throw new ArgumentException(String.Format(&quot;Cannot convert database type &#39;{0}&#39; to a .Net type.&quot;,
                                                              typeName));
            }
        }

        /// &lt;summary&gt;
        /// Gets the database type corresponding to the field, complete with field properties.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;field&quot;&gt;The field.&lt;/param&gt;
        /// &lt;returns&gt;The database type.&lt;/returns&gt;
        protected virtual string GetDatabaseType(IField field)
        {
            StringBuilder fieldBuilder = new StringBuilder();

            fieldBuilder.Append(GetDatabaseTypeName(field));
            fieldBuilder.Append(field.HasProperty(FieldProperties.Identity) ? &quot; IDENTITY(1,1)&quot; : String.Empty);
            fieldBuilder.Append(field.HasProperty(FieldProperties.NotNull) ? &quot; NOT NULL&quot; : &quot; NULL&quot;);

            return fieldBuilder.ToString();
        }

        /// &lt;summary&gt;
        /// Gets the name of the database type, without field properties.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;field&quot;&gt;The field.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected virtual string GetDatabaseTypeName(IField field)
        {
            switch (field.DataType.FullName)
            {
                case &quot;System.Boolean&quot;:  return &quot;bit&quot;;
                case &quot;System.Byte&quot;:     return &quot;tinyint&quot;;
                case &quot;System.DateTime&quot;: return &quot;datetime&quot;;
                case &quot;System.Decimal&quot;:  return &quot;decimal(28)&quot;;
                case &quot;System.Double&quot;:   return &quot;decimal(15)&quot;;
                case &quot;System.Single&quot;:   return &quot;decimal(7)&quot;;
                case &quot;System.Guid&quot;:     return &quot;uniqueidentifier&quot;;
                case &quot;System.Int16&quot;:    return &quot;smallint&quot;;
                case &quot;System.Int32&quot;:    return &quot;int&quot;;
                case &quot;System.Int64&quot;:    return &quot;bigint&quot;;;
                case &quot;System.String&quot;:
                    string type = &quot;nvarchar&quot;;
                    return field.Size == 0 ? type : String.Format(&quot;{0}({1})&quot;, type, field.Size);
                default:
                    throw new ArgumentException(String.Format(&quot;Cannot convert &#39;{0}&#39; to a database type.&quot;, field));
            }
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,15,20,30,0],[21,9,21,10,0],[21,11,21,12,0],[31,9,31,10,0],[32,13,32,30,0],[33,17,33,57,0],[35,13,35,33,0],[38,20,38,45,0],[39,17,40,100,0],[41,13,41,30,0],[42,13,42,14,0],[43,17,43,48,0],[45,24,45,49,0],[46,24,54,90,0],[55,17,55,18,0],[56,21,56,42,0],[57,21,57,22,0],[58,25,58,102,0],[59,21,59,22,0],[60,17,60,18,0],[61,13,61,14,0],[63,13,63,26,0],[64,9,64,10,0],[71,9,71,10,0],[72,13,72,31,0],[73,17,73,58,0],[75,13,75,52,0],[78,13,78,34,0],[79,13,79,14,0],[80,17,80,36,0],[81,13,81,14,0],[83,13,83,14,0],[84,17,84,24,0],[84,26,84,38,0],[84,39,84,41,0],[84,42,84,47,0],[85,17,85,18,0],[87,21,87,62,0],[88,21,88,22,0],[89,25,89,52,0],[90,21,90,22,0],[91,17,91,18,0],[92,13,92,14,0],[93,9,93,10,0],[104,9,104,10,0],[105,13,105,41,0],[108,13,108,73,0],[109,13,109,55,0],[110,13,110,25,0],[111,17,111,91,0],[114,13,114,66,0],[115,20,115,45,0],[116,17,116,107,0],[119,13,119,28,0],[120,13,120,14,0],[122,17,122,56,0],[123,17,123,77,0],[124,17,124,77,0],[127,17,127,54,0],[128,17,128,29,0],[129,17,129,18,0],[130,21,130,50,0],[131,17,131,18,0],[132,13,132,14,0],[135,13,135,42,0],[139,13,139,14,0],[140,24,140,49,0],[141,21,141,76,0],[142,13,142,14,0],[143,13,143,47,0],[144,13,144,14,0],[145,17,145,117,0],[147,9,147,10,0],[155,9,155,10,0],[156,13,156,58,0],[158,13,158,64,0],[159,20,159,45,0],[160,17,163,89,0],[165,13,165,14,0],[166,24,166,49,0],[167,21,167,74,0],[168,13,168,14,0],[169,13,169,47,0],[170,13,170,14,0],[171,17,172,96,0],[174,9,174,10,0],[182,9,182,10,0],[183,13,183,68,0],[185,13,185,30,0],[187,45,187,65,0],[188,45,188,65,0],[189,45,189,69,0],[191,45,191,68,0],[192,45,192,65,0],[193,45,193,66,0],[194,45,194,66,0],[195,45,195,66,0],[196,45,196,67,0],[198,21,199,74,0],[201,9,201,10,0],[209,9,209,10,0],[210,13,210,62,0],[212,13,212,61,0],[213,13,213,112,0],[214,13,214,101,0],[216,13,216,44,0],[217,9,217,10,0],[225,9,225,10,0],[226,13,226,45,0],[228,41,228,54,0],[229,41,229,58,0],[230,41,230,59,0],[231,41,231,62,0],[232,41,232,62,0],[233,41,233,61,0],[234,41,234,67,0],[235,41,235,59,0],[236,41,236,54,0],[237,41,237,57,0],[239,21,239,46,0],[240,21,240,97,0],[242,21,242,115,0],[244,9,244,10,0]]);
    </script>
  </body>
</html>