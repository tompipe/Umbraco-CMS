<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\macrocontainer\Editor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core.IO;
using umbraco.interfaces;
using umbraco.cms.businesslogic.macro;
using umbraco.presentation.webservices;
using System.Text.RegularExpressions;
using ClientDependency.Core;
using System.Web;
using ClientDependency.Core.Controls;
using umbraco.presentation;

namespace umbraco.editorControls.macrocontainer
{

    [ClientDependency(ClientDependencyType.Javascript, &quot;ui/jqueryui.js&quot;, &quot;UmbracoClient&quot;)]
    [ClientDependency(ClientDependencyType.Css, &quot;macroContainer/macroContainer.css&quot;, &quot;UmbracoClient&quot;)]
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class Editor : UpdatePanel, IDataEditor
    {
        private IData _data;
        private List&lt;string&gt; _allowedMacros;
        private int _maxNumber, _preferedHeight, _preferedWidth;

        private LinkButton _addMacro;
        private Literal _limit;



        public Editor(IData data, List&lt;string&gt; allowedMacros, int maxNumber, int preferedHeight, int preferedWidth)
        {
            _data = data;
            _allowedMacros = allowedMacros;
            _maxNumber = maxNumber;
            _preferedHeight = preferedHeight;
            _preferedWidth = preferedWidth;

        }

        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);

            ajaxHelpers.EnsureLegacyCalls(base.Page);
            var sm = ScriptManager.GetCurrent(base.Page);
            var webservicePath = new ServiceReference(IOHelper.ResolveUrl(SystemDirectories.Umbraco) + &quot;/webservices/MacroContainerService.asmx&quot;);

            if (!sm.Services.Contains(webservicePath))
                sm.Services.Add(webservicePath);

            _addMacro = new LinkButton();
            _addMacro.ID = ID + &quot;_btnaddmacro&quot;;


            _addMacro.Click += _addMacro_Click;
            _addMacro.Text = ui.Text(&quot;insertMacro&quot;);
            _addMacro.CssClass = &quot;macroContainerAdd&quot;;

            this.ContentTemplateContainer.Controls.Add(_addMacro);


            _limit = new Literal();
            _limit.Text = string.Format(&quot; Only {0} macros are allowed&quot;, _maxNumber);
            _limit.ID = ID + &quot;_litlimit&quot;;
            _limit.Visible = false;

            this.ContentTemplateContainer.Controls.Add(_limit);

            string widthHeight = &quot;&quot;;
            if (_preferedHeight &gt; 0 &amp;&amp; _preferedWidth &gt; 0)
            {
                widthHeight = String.Format(&quot; style=\&quot;min-width: {0}px; min-height: {1}px;\&quot;&quot;, _preferedWidth, _preferedHeight);
            }

            this.ContentTemplateContainer.Controls.Add(new LiteralControl(String.Format(&quot;&lt;div id=\&quot;&quot; + ID + &quot;container\&quot; class=\&quot;macrocontainer\&quot;{0}&gt;&quot;, widthHeight)));

            Regex tagregex = new Regex(&quot;&lt;[^&gt;]*(&gt;|$)&quot;, RegexOptions.Singleline | RegexOptions.ExplicitCapture | RegexOptions.Compiled);
            MatchCollection tags = tagregex.Matches(_data.Value.ToString());

            List&lt;int&gt; editornumbers = new List&lt;int&gt;();
            string sortorder = string.Empty;


            for (int i = 0; i &lt; _maxNumber; i++)
            {
                if (!editornumbers.Contains(i))
                {
                    string data = string.Empty;

                    if (tags.Count &gt; i)
                        data = tags[i].Value;

                    MacroEditor macroEditor = new MacroEditor(data, _allowedMacros);
                    macroEditor.ID = ID + &quot;macroeditor_&quot; + i;

                    this.ContentTemplateContainer.Controls.Add(macroEditor);
                }


            }

            this.ContentTemplateContainer.Controls.Add(new LiteralControl(&quot;&lt;/div&gt;&quot;));

            if (tags.Count == _maxNumber)
            {
                _addMacro.Enabled = false;
                _limit.Visible = true;
            }



            MacroContainerEvent.Execute += new MacroContainerEvent.ExecuteHandler(MacroContainerEvent_Execute);

        }
        private void CheckLimit()
        {
            bool allowadd = false;
            for (int i = 0; i &lt; _maxNumber; i++)
            {
                MacroEditor current = ((MacroEditor)this.ContentTemplateContainer.FindControl(ID + &quot;macroeditor_&quot; + i.ToString()));

                if (!current.Visible)
                {
                    allowadd = true;
                    break;
                };
            }

            if (!allowadd)
            {
                _addMacro.Enabled = false;
                _limit.Visible = true;
            }
            else
            {
                _addMacro.Enabled = true;
                _limit.Visible = false;
            }
        }

        private void MacroContainerEvent_Execute()
        {
            CheckLimit();

        }

        private void _addMacro_Click(object sender, EventArgs e)
        {

            for (int i = 0; i &lt; _maxNumber; i++)
            {
                MacroEditor current = ((MacroEditor)this.ContentTemplateContainer.FindControl(ID + &quot;macroeditor_&quot; + i.ToString()));

                if (!current.Visible)
                {
                    current.Visible = true;
                    MacroContainerEvent.Add();
                    break;
                };
            }
        }



        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            // And a reference to the macro container calls 
            //ClientDependencyLoader.Instance.RegisterDependency(&quot;webservices/MacroContainerService.asmx/js&quot;, &quot;UmbracoRoot&quot;, ClientDependencyType.Javascript);


            string script = &quot;function &quot; + ID + &quot;makesortable(){   &quot;;
            script += &quot; jQuery(&#39;#&quot; + ID + &quot;container&#39;).sortable({ update : function () { &quot;;
            script += &quot; umbraco.presentation.webservices.MacroContainerService.SetSortOrder(&#39;&quot; + ID + &quot;&#39;, jQuery(&#39;#&quot; + ID + &quot;container&#39;).sortable(&#39;serialize&#39;));&quot;;
            script += &quot; }}); &quot;;
            script += &quot;  &quot;;
            script += &quot;}&quot;;

            ScriptManager.RegisterClientScriptBlock(this, this.GetType(), ID + &quot;macrocontainersortable&quot;,
                script, true);

            if (!Page.IsPostBack)
                HttpContext.Current.Session[ID + &quot;sortorder&quot;] = null;

            ScriptManager.RegisterStartupScript(this, this.GetType(), ID + &quot;initsort&quot;, ID + &quot;makesortable();&quot;, true);

            string sortscript = string.Empty;

            string sortorder = string.Empty;
            if (HttpContext.Current.Session[ID + &quot;sortorder&quot;] != null)
            {
                sortorder = HttpContext.Current.Session[ID + &quot;sortorder&quot;].ToString();
            }
            if (sortorder != string.Empty)
            {

                foreach (string temp in sortorder.Split(&#39;&amp;&#39;))
                {
                    string number = temp.Substring(temp.LastIndexOf(&#39;=&#39;) + 1);


                    sortscript += &quot;jQuery(&#39;#container&quot; + ID + &quot;macroeditor_&quot; + number + &quot;&#39;).appendTo(&#39;#&quot; + ID + &quot;container&#39;);&quot;;
                }
            }
            if (sortscript != string.Empty)
                ScriptManager.RegisterStartupScript(this, this.GetType(), ID + &quot;resort&quot;, sortscript, true);

            EnsureChildControls();

        }





        #region IDataEditor Members

        public void Save()
        {



            string value = string.Empty;

            if (HttpContext.Current.Session[ID + &quot;sortorder&quot;] != null)
            {
                string sortorder = HttpContext.Current.Session[ID + &quot;sortorder&quot;].ToString();

                foreach (string temp in sortorder.Split(&#39;&amp;&#39;))
                {
                    string number = temp.Substring(temp.LastIndexOf(&#39;=&#39;) + 1);

                    if (this.ContentTemplateContainer.FindControl(ID + &quot;macroeditor_&quot; + number) != null)
                    {
                        MacroEditor current = ((MacroEditor)this.ContentTemplateContainer.FindControl(ID + &quot;macroeditor_&quot; + number));
                        if (current.Visible)
                            value += current.MacroTag;
                    }
                }
            }
            else
            {
                for (int i = 0; i &lt; _maxNumber; i++)
                {
                    if (this.ContentTemplateContainer.FindControl(ID + &quot;macroeditor_&quot; + i.ToString()) != null)
                    {
                        MacroEditor current = ((MacroEditor)this.ContentTemplateContainer.FindControl(ID + &quot;macroeditor_&quot; + i.ToString()));
                        if (current.Visible)
                            value += current.MacroTag;
                    }
                }
            }
            _data.Value = value;

        }

        public bool ShowLabel
        {
            get { return true; }
        }

        public bool TreatAsRichTextEditor
        {
            get { return false; }
        }

        Control IDataEditor.Editor
        {
            get { return this; }
        }

        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[34,9,34,116,0],[35,9,35,10,0],[36,13,36,26,0],[37,13,37,44,0],[38,13,38,36,0],[39,13,39,46,0],[40,13,40,44,0],[42,9,42,10,0],[45,9,45,10,0],[46,13,46,28,0],[48,13,48,54,0],[49,13,49,58,0],[50,13,50,147,0],[52,13,52,55,0],[53,17,53,49,0],[55,13,55,42,0],[56,13,56,48,0],[59,13,59,48,0],[60,13,60,53,0],[61,13,61,54,0],[63,13,63,67,0],[66,13,66,36,0],[67,13,67,85,0],[68,13,68,42,0],[69,13,69,36,0],[71,13,71,64,0],[73,13,73,37,0],[74,13,74,59,0],[75,13,75,14,0],[76,17,76,129,0],[77,13,77,14,0],[79,13,79,168,0],[81,13,81,135,0],[82,13,82,77,0],[84,13,84,55,0],[85,13,85,45,0],[88,18,88,27,0],[88,29,88,43,0],[88,45,88,48,0],[89,13,89,14,0],[90,17,90,48,0],[91,17,91,18,0],[92,21,92,48,0],[94,21,94,40,0],[95,25,95,46,0],[97,21,97,85,0],[98,21,98,62,0],[100,21,100,77,0],[101,17,101,18,0],[104,13,104,14,0],[106,13,106,86,0],[108,13,108,42,0],[109,13,109,14,0],[110,17,110,43,0],[111,17,111,39,0],[112,13,112,14,0],[116,13,116,112,0],[118,9,118,10,0],[120,9,120,10,0],[121,13,121,35,0],[122,18,122,27,0],[122,29,122,43,0],[122,45,122,48,0],[123,13,123,14,0],[124,17,124,132,0],[126,17,126,38,0],[127,17,127,18,0],[128,21,128,37,0],[129,21,129,27,0],[130,18,130,19,0],[131,13,131,14,0],[133,13,133,27,0],[134,13,134,14,0],[135,17,135,43,0],[136,17,136,39,0],[137,13,137,14,0],[139,13,139,14,0],[140,17,140,42,0],[141,17,141,40,0],[142,13,142,14,0],[143,9,143,10,0],[146,9,146,10,0],[147,13,147,26,0],[149,9,149,10,0],[152,9,152,10,0],[154,18,154,27,0],[154,29,154,43,0],[154,45,154,48,0],[155,13,155,14,0],[156,17,156,132,0],[158,17,158,38,0],[159,17,159,18,0],[160,21,160,44,0],[161,21,161,47,0],[162,21,162,27,0],[163,18,163,19,0],[164,13,164,14,0],[165,9,165,10,0],[170,9,170,10,0],[171,13,171,28,0],[177,13,177,69,0],[178,13,178,92,0],[179,13,179,163,0],[180,13,180,32,0],[181,13,181,28,0],[182,13,182,27,0],[184,13,185,31,0],[187,13,187,34,0],[188,17,188,70,0],[190,13,190,118,0],[192,13,192,46,0],[194,13,194,45,0],[195,13,195,71,0],[196,13,196,14,0],[197,17,197,86,0],[198,13,198,14,0],[199,13,199,43,0],[200,13,200,14,0],[202,17,202,24,0],[202,26,202,37,0],[202,38,202,40,0],[202,41,202,61,0],[203,17,203,18,0],[204,21,204,79,0],[207,21,207,128,0],[208,17,208,18,0],[209,13,209,14,0],[210,13,210,44,0],[211,17,211,108,0],[213,13,213,35,0],[215,9,215,10,0],[224,9,224,10,0],[228,13,228,41,0],[230,13,230,71,0],[231,13,231,14,0],[232,17,232,93,0],[234,17,234,24,0],[234,26,234,37,0],[234,38,234,40,0],[234,41,234,61,0],[235,17,235,18,0],[236,21,236,79,0],[238,21,238,105,0],[239,21,239,22,0],[240,25,240,134,0],[241,25,241,45,0],[242,29,242,55,0],[243,21,243,22,0],[244,17,244,18,0],[245,13,245,14,0],[247,13,247,14,0],[248,22,248,31,0],[248,33,248,47,0],[248,49,248,52,0],[249,17,249,18,0],[250,21,250,111,0],[251,21,251,22,0],[252,25,252,140,0],[253,25,253,45,0],[254,29,254,55,0],[255,21,255,22,0],[256,17,256,18,0],[257,13,257,14,0],[258,13,258,33,0],[260,9,260,10,0],[264,17,264,18,0],[264,19,264,31,0],[264,32,264,33,0],[269,17,269,18,0],[269,19,269,32,0],[269,33,269,34,0],[274,17,274,18,0],[274,19,274,31,0],[274,32,274,33,0]]);
    </script>
  </body>
</html>