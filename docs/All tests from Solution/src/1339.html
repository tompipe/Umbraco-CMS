<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Editors\MediaPostValidateAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Net;
using System.Net.Http;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.Filters;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Web.Models.ContentEditing;
using Umbraco.Web.Security;
using Umbraco.Web.WebApi;

namespace Umbraco.Web.Editors
{
    /// &lt;summary&gt;
    /// Checks if the user has access to post a content item based on whether it&#39;s being created or saved.
    /// &lt;/summary&gt;
    internal sealed class MediaPostValidateAttribute : ActionFilterAttribute
    {
        private readonly IMediaService _mediaService;
        private readonly WebSecurity _security;

        public MediaPostValidateAttribute()
        {
        }

        public MediaPostValidateAttribute(IMediaService mediaService, WebSecurity security)
        {
            if (mediaService == null) throw new ArgumentNullException(&quot;mediaService&quot;);
            if (security == null) throw new ArgumentNullException(&quot;security&quot;);
            _mediaService = mediaService;
            _security = security;
        }

        private IMediaService MediaService
        {
            get { return _mediaService ?? ApplicationContext.Current.Services.MediaService; }
        }

        private WebSecurity Security
        {
            get { return _security ?? UmbracoContext.Current.Security; }
        }
        
        public override void OnActionExecuting(HttpActionContext actionContext)
        {
            var mediaItem = (MediaItemSave)actionContext.ActionArguments[&quot;contentItem&quot;];

            //We now need to validate that the user is allowed to be doing what they are doing.
            //Then if it is new, we need to lookup those permissions on the parent.
            IMedia contentToCheck = null;
            int contentIdToCheck;
            switch (mediaItem.Action)
            {
                case ContentSaveAction.Save:
                    contentToCheck = mediaItem.PersistedContent;
                    contentIdToCheck = contentToCheck.Id;
                    break;                
                case ContentSaveAction.SaveNew:
                    contentToCheck = MediaService.GetById(mediaItem.ParentId);

                    if (mediaItem.ParentId != Constants.System.Root)
                    {
                        contentToCheck = MediaService.GetById(mediaItem.ParentId);
                        contentIdToCheck = contentToCheck.Id;
                    }
                    else
                    {
                        contentIdToCheck = mediaItem.ParentId;
                    }

                    break;
                default:
                    //we don&#39;t support this for media
                    actionContext.Response = actionContext.Request.CreateResponse(HttpStatusCode.NotFound);
                    return;
            }

            if (MediaController.CheckPermissions(
                actionContext.Request.Properties,
                Security.CurrentUser,
                MediaService,
                contentIdToCheck,
                contentToCheck) == false)
            {
                throw new HttpResponseException(actionContext.Request.CreateUserNoAccessResponse());
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,44,0],[25,9,25,10,0],[26,9,26,10,0],[28,9,28,92,0],[29,9,29,10,0],[30,13,30,38,0],[30,39,30,87,0],[31,13,31,34,0],[31,35,31,79,0],[32,13,32,42,0],[33,13,33,34,0],[34,9,34,10,0],[38,17,38,18,0],[38,19,38,92,0],[38,93,38,94,0],[43,17,43,18,0],[43,19,43,71,0],[43,72,43,73,0],[47,9,47,10,0],[48,13,48,89,0],[52,13,52,42,0],[54,13,54,38,0],[57,21,57,65,0],[58,21,58,58,0],[59,21,59,27,0],[61,21,61,79,0],[63,21,63,69,0],[64,21,64,22,0],[65,25,65,83,0],[66,25,66,62,0],[67,21,67,22,0],[69,21,69,22,0],[70,25,70,63,0],[71,21,71,22,0],[73,21,73,27,0],[76,21,76,108,0],[77,21,77,28,0],[80,13,85,42,0],[86,13,86,14,0],[87,17,87,101,0],[89,9,89,10,0]]);
    </script>
  </body>
</html>