<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Routing\UmbracoModuleTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Configuration;
using System.IO;
using System.Threading;
using System.Xml;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;
using Umbraco.Web.Routing;
using umbraco.BusinessLogic;
using Umbraco.Core.IO;
using umbraco.cms.businesslogic.cache;
using umbraco.cms.businesslogic.template;

namespace Umbraco.Tests.Routing
{
	[TestFixture, RequiresSTA]
	public class UmbracoModuleTests : BaseRoutingTest
	{
		private UmbracoModule _module;

		public override void Initialize()
		{
			base.Initialize();
			
			//create the module
			_module = new UmbracoModule();

		    SettingsForTests.ConfigurationStatus = UmbracoVersion.GetSemanticVersion().ToSemanticString();
            //SettingsForTests.ReservedPaths = &quot;~/umbraco,~/install/&quot;;
            //SettingsForTests.ReservedUrls = &quot;~/config/splashes/booting.aspx,~/install/default.aspx,~/config/splashes/noNodes.aspx,~/VSEnterpriseHelper.axd&quot;;

		    Directory.CreateDirectory(Path.GetDirectoryName(IOHelper.MapPath(SystemFiles.NotFoundhandlersConfig, false)));

			//create the not found handlers config
			using (var sw = File.CreateText(IOHelper.MapPath(SystemFiles.NotFoundhandlersConfig, false)))
			{
				sw.Write(@&quot;&lt;NotFoundHandlers&gt;
	&lt;notFound assembly=&#39;umbraco&#39; type=&#39;SearchForAlias&#39; /&gt;
	&lt;notFound assembly=&#39;umbraco&#39; type=&#39;SearchForTemplate&#39;/&gt;
	&lt;notFound assembly=&#39;umbraco&#39; type=&#39;SearchForProfile&#39;/&gt;
	&lt;notFound assembly=&#39;umbraco&#39; type=&#39;handle404&#39;/&gt;
&lt;/NotFoundHandlers&gt;&quot;);
			}
		}

		public override void TearDown()
		{
			base.TearDown();

			_module.DisposeIfDisposable();
		}

		// do not test for /base here as it&#39;s handled before EnsureUmbracoRoutablePage is called
		[TestCase(&quot;/umbraco_client/Tree/treeIcons.css&quot;, false)]
		[TestCase(&quot;/umbraco_client/Tree/Themes/umbraco/style.css?cdv=37&quot;, false)]
		[TestCase(&quot;/umbraco_client/scrollingmenu/style.css?cdv=37&quot;, false)]
		[TestCase(&quot;/umbraco/umbraco.aspx&quot;, false)]
		[TestCase(&quot;/umbraco/editContent.aspx&quot;, false)]
		[TestCase(&quot;/install/default.aspx&quot;, false)]
		[TestCase(&quot;/install/?installStep=license&quot;, false)]
		[TestCase(&quot;/install?installStep=license&quot;, false)]
		[TestCase(&quot;/install/test.aspx&quot;, false)]
		[TestCase(&quot;/config/splashes/noNodes.aspx&quot;, false)]
		[TestCase(&quot;/&quot;, true)]
		[TestCase(&quot;/home.aspx&quot;, true)]
		[TestCase(&quot;/umbraco-test&quot;, true)]
		[TestCase(&quot;/install-test&quot;, true)]
		public void Ensure_Request_Routable(string url, bool assert)
		{
			var httpContextFactory = new FakeHttpContextFactory(url);
			var httpContext = httpContextFactory.HttpContext;
			var routingContext = GetRoutingContext(url);
			var umbracoContext = routingContext.UmbracoContext;
			
			var result = _module.EnsureUmbracoRoutablePage(umbracoContext, httpContext);

			Assert.AreEqual(assert, result.Success);
		}

		[TestCase(&quot;/favicon.ico&quot;, true)]
		[TestCase(&quot;/umbraco_client/Tree/treeIcons.css&quot;, true)]
		[TestCase(&quot;/umbraco_client/Tree/Themes/umbraco/style.css?cdv=37&quot;, true)]
		[TestCase(&quot;/umbraco_client/scrollingmenu/style.css?cdv=37&quot;, true)]
		[TestCase(&quot;/base/somebasehandler&quot;, false)]
		[TestCase(&quot;/&quot;, false)]
		[TestCase(&quot;/home.aspx&quot;, false)]
		public void Is_Client_Side_Request(string url, bool assert)
		{
			var uri = new Uri(&quot;http://test.com&quot; + url);			
			var result = uri.IsClientSideRequest();
			Assert.AreEqual(assert, result);
		}




		//NOTE: This test shows how we can test most of the HttpModule, it however is testing a method that no longer exists and is testing too much, 
		// we need to write unit tests for each of the components: NiceUrlProvider, all of the Lookup classes, etc...
		// to ensure that each one is individually tested. 

		//[TestCase(&quot;/&quot;, 1046)]
		//[TestCase(&quot;/home.aspx&quot;, 1046)]
		//[TestCase(&quot;/home/sub1.aspx&quot;, 1173)]
		//[TestCase(&quot;/home.aspx?altTemplate=blah&quot;, 1046)]
		//public void Process_Front_End_Document_Request_Match_Node(string url, int nodeId)
		//{
		//    var httpContextFactory = new FakeHttpContextFactory(url);
		//    var httpContext = httpContextFactory.HttpContext;
		//    var umbracoContext = new UmbracoContext(httpContext, ApplicationContext.Current, new NullRoutesCache());
		//    var contentStore = new ContentStore(umbracoContext);
		//    var niceUrls = new NiceUrlProvider(contentStore, umbracoContext);
		//    umbracoContext.RoutingContext = new RoutingContext(
		//        new IPublishedContentLookup[] {new LookupByNiceUrl()},
		//        new DefaultLastChanceLookup(),
		//        contentStore,
		//        niceUrls); 

		//    StateHelper.HttpContext = httpContext;

		//    //because of so much dependency on the db, we need to create som stuff here, i originally abstracted out stuff but 
		//    //was turning out to be quite a deep hole because ultimately we&#39;d have to abstract the old &#39;Domain&#39; and &#39;Language&#39; classes
		//    Domain.MakeNew(&quot;Test.com&quot;, 1000, Language.GetByCultureCode(&quot;en-US&quot;).id);

		//    //need to create a template with id 1045
		//    var template = Template.MakeNew(&quot;test&quot;, new User(0));

		//    SetupUmbracoContextForTest(umbracoContext, template);

		//    _module.AssignDocumentRequest(httpContext, umbracoContext, httpContext.Request.Url);

		//    Assert.IsNotNull(umbracoContext.PublishedContentRequest);
		//    Assert.IsNotNull(umbracoContext.PublishedContentRequest.XmlNode);	
		//    Assert.IsFalse(umbracoContext.PublishedContentRequest.IsRedirect);
		//    Assert.IsFalse(umbracoContext.PublishedContentRequest.Is404);
		//    Assert.AreEqual(umbracoContext.PublishedContentRequest.Culture, Thread.CurrentThread.CurrentCulture);
		//    Assert.AreEqual(umbracoContext.PublishedContentRequest.Culture, Thread.CurrentThread.CurrentUICulture);
		//    Assert.AreEqual(nodeId, umbracoContext.PublishedContentRequest.NodeId);
			
		//}

	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,3,25,4,1],[26,4,26,22,1],[29,4,29,34,1],[31,7,31,101,1],[35,7,35,117,1],[38,11,38,96,1],[39,4,39,5,1],[40,5,45,23,1],[46,4,46,5,1],[47,3,47,4,1],[50,3,50,4,1],[51,4,51,20,1],[53,4,53,34,1],[54,3,54,4,1],[72,3,72,4,1],[73,4,73,61,1],[74,4,74,53,1],[75,4,75,48,1],[76,4,76,55,1],[78,4,78,80,1],[80,4,80,44,1],[81,3,81,4,1],[91,3,91,4,1],[92,4,92,47,1],[93,4,93,43,1],[94,4,94,36,1],[95,3,95,4,1]]);
    </script>
  </body>
</html>