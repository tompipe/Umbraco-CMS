<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\Trees\loadPackages.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Web;
using System.Xml;
using umbraco.businesslogic;
using umbraco.cms.businesslogic.packager;
using umbraco.cms.presentation.Trees;
using Umbraco.Core;
using umbraco.interfaces;

namespace umbraco
{
    //[Tree(Constants.Applications.Developer, &quot;packagerPackages&quot;, &quot;Packager Packages&quot;, initialize: false, sortOrder: 1)]
    [Obsolete(&quot;This is no longer used and will be removed from the codebase in the future&quot;)]
    public class loadPackages : BaseTree
    {

        public const string PACKAGE_TREE_PREFIX = &quot;package_&quot;;

        public loadPackages(string application) : base(application) { }
        
        protected override void CreateRootNode(ref XmlTreeNode rootNode)
        {
            
        }
        
        private int _id;
        private string _app;
        private string _packageType = &quot;&quot;;
        private string _repoGuid = &quot;&quot;;

        public override void RenderJS(ref StringBuilder Javascript)
        {
            Javascript.Append(@&quot;
            function openCreatedPackage(id) {
	            UmbClientMgr.contentFrame(&#39;developer/packages/editPackage.aspx?id=&#39; + id);
            }
            function openInstalledPackage(id) {
	            UmbClientMgr.contentFrame(&#39;developer/packages/installedPackage.aspx?id=&#39; + id);
            }
            &quot;);
        }

        protected override void CreateAllowedActions(ref List&lt;IAction&gt; actions)
        {
            actions.Clear();
        }

        public override void Render(ref XmlTree tree)
        {

            _packageType = HttpContext.Current.Request.QueryString[&quot;packageType&quot;];
           
            switch (_packageType)
            {
                case &quot;installed&quot;:
                    Version v;
                    // Display the unique packages, ordered by the latest version number. [LK 2013-06-10]
                    var uniquePackages = InstalledPackage.GetAllInstalledPackages()
                        .OrderByDescending(x =&gt; Version.TryParse(x.Data.Version, out v) ? v : new Version())
                        .GroupBy(x =&gt; x.Data.Name)
                        .Select(x =&gt; x.First())
                        .OrderBy(x =&gt; x.Data.Name);
                    foreach (var p in uniquePackages)
                    {
                        var xNode = XmlTreeNode.Create(this);
                        xNode.NodeID = string.Concat(PACKAGE_TREE_PREFIX, p.Data.Id);
                        xNode.Text = p.Data.Name;
                        xNode.Action = string.Format(&quot;javascript:openInstalledPackage(&#39;{0}&#39;);&quot;, p.Data.Id);
                        xNode.Icon = &quot;icon-box&quot;;
                        xNode.OpenIcon = &quot;icon-box&quot;;
                        xNode.NodeType = &quot;createdPackageInstance&quot;;
                        tree.Add(xNode);
                    }
                    break;

                case &quot;created&quot;:
                    foreach (CreatedPackage p in CreatedPackage.GetAllCreatedPackages())
                    {

                        XmlTreeNode xNode = XmlTreeNode.Create(this);
                        xNode.NodeID = PACKAGE_TREE_PREFIX + p.Data.Id.ToString();
                        xNode.Text = p.Data.Name;
                        xNode.Action = &quot;javascript:openCreatedPackage(&#39;&quot; + p.Data.Id.ToString() + &quot;&#39;);&quot;;
                        xNode.Icon = &quot;icon-box&quot;;
                        xNode.OpenIcon = &quot;icon-box&quot;;
                        xNode.NodeType = &quot;createdPackageInstance&quot;;
                        xNode.Menu.Add(umbraco.BusinessLogic.Actions.ActionDelete.Instance);
                        tree.Add(xNode);
                    }
                    break;

                case &quot;repositories&quot;:
                    List&lt;cms.businesslogic.packager.repositories.Repository&gt; repos = cms.businesslogic.packager.repositories.Repository.getAll();

                    foreach (cms.businesslogic.packager.repositories.Repository repo in repos)
                    {
                        XmlTreeNode xNode = XmlTreeNode.Create(this);
                        xNode.Text = repo.Name;
                        xNode.Action = &quot;javascript:openPackageCategory(&#39;BrowseRepository.aspx?repoGuid=&quot; + repo.Guid + &quot;&#39;);&quot;;
                        xNode.Icon = &quot;icon-server-alt&quot;;
                        xNode.OpenIcon = &quot;icon-server-alt&quot;;
                        xNode.NodeType = &quot;packagesRepo&quot; + repo.Guid;
                        xNode.Menu.Add( umbraco.BusinessLogic.Actions.ActionRefresh.Instance );
                        xNode.Source = &quot;tree.aspx?app=&quot; + this._app + &quot;&amp;id=&quot; + this._id + &quot;&amp;treeType=packagerPackages&amp;packageType=repository&amp;repoGuid=&quot; + repo.Guid + &quot;&amp;rnd=&quot; + Guid.NewGuid();
                        tree.Add(xNode);
                        
                    }

                    break;
                case &quot;repository&quot;:

                    _repoGuid = HttpContext.Current.Request.QueryString[&quot;repoGuid&quot;];
                    Umbraco.Web.org.umbraco.our.Repository r = new Umbraco.Web.org.umbraco.our.Repository();
                    
                    foreach (var cat in r.Categories(_repoGuid))
                    {
                        XmlTreeNode xNode = XmlTreeNode.Create(this);
                        xNode.NodeID = cat.Id.ToInvariantString();
                        xNode.Text = cat.Text;
                        xNode.Action = &quot;javascript:openPackageCategory(&#39;BrowseRepository.aspx?category=&quot; + cat.Id + &quot;&amp;repoGuid=&quot; + _repoGuid + &quot;&#39;);&quot;;
                        xNode.Icon = &quot;icon-folder&quot;;
                        xNode.OpenIcon = &quot;icon-folder&quot;;
                        xNode.NodeType = &quot;packagesCategory&quot; + cat.Id;                        
                        tree.Add(xNode);
                    
                    }
                    
                    break;
            }

        }

        
    }

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,51,22,68,0],[22,69,22,70,0],[22,71,22,72,0],[25,9,25,10,0],[27,9,27,10,0],[31,9,31,42,0],[32,9,32,39,0],[35,9,35,10,0],[36,13,43,16,0],[44,9,44,10,0],[47,9,47,10,0],[48,13,48,29,0],[49,9,49,10,0],[52,9,52,10,0],[54,13,54,83,0],[56,13,56,34,0],[61,21,62,49,0],[62,49,62,108,0],[62,108,63,39,0],[63,39,63,50,0],[63,50,64,38,0],[64,38,64,47,0],[64,47,65,39,0],[65,39,65,50,0],[65,50,65,52,0],[61,21,65,52,0],[66,21,66,28,0],[66,30,66,35,0],[66,36,66,38,0],[66,39,66,53,0],[67,21,67,22,0],[68,25,68,62,0],[69,25,69,86,0],[70,25,70,50,0],[71,25,71,108,0],[72,25,72,49,0],[73,25,73,53,0],[74,25,74,67,0],[75,25,75,41,0],[76,21,76,22,0],[77,21,77,27,0],[80,21,80,28,0],[80,30,80,46,0],[80,47,80,49,0],[80,50,80,88,0],[81,21,81,22,0],[83,25,83,70,0],[84,25,84,83,0],[85,25,85,50,0],[86,25,86,105,0],[87,25,87,49,0],[88,25,88,53,0],[89,25,89,67,0],[90,25,90,93,0],[91,25,91,41,0],[92,21,92,22,0],[93,21,93,27,0],[96,21,96,146,0],[98,21,98,28,0],[98,30,98,85,0],[98,86,98,88,0],[98,89,98,94,0],[99,21,99,22,0],[100,25,100,70,0],[101,25,101,48,0],[102,25,102,126,0],[103,25,103,56,0],[104,25,104,60,0],[105,25,105,69,0],[106,25,106,96,0],[107,25,107,192,0],[108,25,108,41,0],[110,21,110,22,0],[112,21,112,27,0],[115,21,115,85,0],[116,21,116,109,0],[118,21,118,28,0],[118,30,118,37,0],[118,38,118,40,0],[118,41,118,64,0],[119,21,119,22,0],[120,25,120,70,0],[121,25,121,67,0],[122,25,122,47,0],[123,25,123,150,0],[124,25,124,52,0],[125,25,125,56,0],[126,25,126,70,0],[127,25,127,41,0],[129,21,129,22,0],[131,21,131,27,0],[134,9,134,10,0]]);
    </script>
  </body>
</html>