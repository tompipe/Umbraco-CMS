<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSix\DeleteAppTables.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence.SqlSyntax;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSix
{
    
    [Migration(&quot;6.0.0&quot;, 10, GlobalSettings.UmbracoMigrationName)]
    public class DeleteAppTables : MigrationBase
    {
        public DeleteAppTables(ISqlSyntaxProvider sqlSyntax, ILogger logger) : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {
            Delete.Table(&quot;umbracoAppTree&quot;);

            //NOTE: this is a hack since old umbraco versions might not have had their db&#39;s upgraded correctly so they are all quite inconsistent.
            // This is actually done in migration: RemoveUmbracoAppConstraints to target 4.9.0 but we&#39;ve found with some db&#39;s that are currently at 4.9.1, 
            // these upgrades did not run. So, now we not only have to check if these constraints exist, but we also have to check if the RemoveUmbracoAppConstraints
            // has executed since we cannot drop the same foreign key twice or we&#39;ll get errors.

            //Here we&#39;ll do a dirty check to see if RemoveUmbracoAppConstraints has executed
            if (Context.Expressions.Any(x =&gt;
            {
                var b = x as MigrationExpressionBase;
                if (b == null) return false;
                return b.Name == &quot;FK_umbracoUser2app_umbracoApp&quot;;
            }) == false)
            {
                //These are the old aliases, before removing them, check they exist
                var constraints = SqlSyntax.GetConstraintsPerColumn(Context.Database).Distinct().ToArray();
                if (constraints.Any(x =&gt; x.Item1.InvariantEquals(&quot;umbracoUser2app&quot;) &amp;&amp; x.Item3.InvariantEquals(&quot;FK_umbracoUser2app_umbracoApp&quot;)))
                {
                    Delete.ForeignKey(&quot;FK_umbracoUser2app_umbracoApp&quot;).OnTable(&quot;umbracoUser2app&quot;);
                }
                if (constraints.Any(x =&gt; x.Item1.InvariantEquals(&quot;umbracoUser2app&quot;) &amp;&amp; x.Item3.InvariantEquals(&quot;FK_umbracoUser2app_umbracoUser&quot;)))
                {
                    Delete.ForeignKey(&quot;FK_umbracoUser2app_umbracoUser&quot;).OnTable(&quot;umbracoUser2app&quot;);
                }    
            }

            Delete.Table(&quot;umbracoApp&quot;);
        }

        public override void Down()
        {
            //This cannot be rolled back!!
            throw new DataLossException(&quot;Cannot rollback migration &quot; + typeof(DeleteAppTables) + &quot; the db tables umbracoAppTree and umbracoApp have been droppped&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,80,12,103,1],[13,9,13,10,1],[14,9,14,10,1],[17,9,17,10,1],[18,13,18,44,1],[26,13,27,13,1],[27,13,27,14,1],[27,14,28,17,1],[28,17,28,54,1],[28,54,29,17,1],[29,17,29,31,1],[29,31,29,32,1],[29,32,29,45,0],[29,45,30,17,1],[30,17,30,66,1],[30,66,31,13,1],[31,13,31,14,1],[31,14,31,25,1],[26,13,31,25,1],[32,13,32,14,0],[34,17,34,108,0],[35,17,35,42,0],[35,42,35,144,0],[35,144,35,146,0],[35,17,35,146,0],[36,17,36,18,0],[37,21,37,99,0],[38,17,38,18,0],[39,17,39,42,0],[39,42,39,145,0],[39,145,39,147,0],[39,17,39,147,0],[40,17,40,18,0],[41,21,41,100,0],[42,17,42,18,0],[43,13,43,14,0],[45,13,45,40,1],[46,9,46,10,1],[49,9,49,10,0],[51,13,51,165,0]]);
    </script>
  </body>
</html>