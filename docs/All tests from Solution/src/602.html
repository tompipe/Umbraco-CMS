<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\dialogs\search.aspx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Umbraco.Core;
using UmbracoExamine;
using System.Xml;
using Examine;
using Examine.LuceneEngine.SearchCriteria;
using System.Linq;
using Umbraco.Core;


namespace umbraco.presentation.dialogs
{
    public partial class search : BasePages.UmbracoEnsuredPage
    {

        protected override void OnInit(EventArgs e)
        {
            CurrentApp = IndexTypes.Content;
            if (!string.IsNullOrEmpty(Request[&quot;app&quot;]))
            {
                CurrentApp = Request[&quot;app&quot;].ToLower();
            }

            base.OnInit(e);
        }

        protected void Page_Load(object sender, EventArgs e)
        {
            Page.Form.DefaultButton = searchButton.UniqueID;

            if (!IsPostBack &amp;&amp; Request[&quot;search&quot;] != &quot;&quot;)
            {
                keyword.Text = Request[&quot;search&quot;];
                DoSearch();

            }
        }

        protected void search_Click(object sender, EventArgs e)
        {
            DoSearch();            
        }

        private void DoSearch()
        {
            var txt = keyword.Text.ToLower();

            int limit;
            if (!int.TryParse(Request[&quot;limit&quot;], out limit))
            {
                limit = 100;
            }

            //if it doesn&#39;t start with &quot;*&quot;, then search only nodeName and nodeId
            var internalSearcher = (CurrentApp == Constants.Applications.Members)
                ? UmbracoContext.Current.InternalMemberSearchProvider
                : UmbracoContext.Current.InternalSearchProvider;

            //create some search criteria, make everything combined to be &#39;And&#39; and only search the current app
            var criteria = internalSearcher.CreateSearchCriteria(CurrentApp, Examine.SearchCriteria.BooleanOperation.And);

            IEnumerable&lt;SearchResult&gt; results;
            if (txt.StartsWith(&quot;*&quot;))
            {
                //if it starts with * then search all fields
                results = internalSearcher.Search(txt.Substring(1), true);
            }
            else
            {
                var words = txt.Split(new[] { &#39; &#39; }, StringSplitOptions.RemoveEmptyEntries).Select(w =&gt; w.ToLower().MultipleCharacterWildcard()).ToList();
                var operation = criteria.GroupedOr(new[] { &quot;__nodeName&quot;, &quot;__NodeId&quot;, &quot;id&quot; }, new[] { words[0] });
                words.RemoveAt(0);
                foreach (var word in words)
                    operation = operation.And().GroupedOr(new[] { &quot;__nodeName&quot; }, new[] { word });

                // ensure the user can only find nodes they are allowed to see
                if (UmbracoContext.Current.UmbracoUser.StartNodeId &gt; 0)
                {
                    //TODO: This is not correct! This will not filter out seearches &#39;from&#39; this node, this
                    // query is meant to search &#39;for&#39; a specific node.
                    operation = operation.And().Id(UmbracoContext.Current.UmbracoUser.StartNodeId);
                }

                results = internalSearcher.Search(operation.Compile());
            }

            nothingFound.Visible = !results.Any();

            searchResult.XPathNavigator = ResultsAsXml(results).CreateNavigator();
        }

        private XmlDocument ResultsAsXml(IEnumerable&lt;SearchResult&gt; results)
        {
            var result = new XmlDocument();
            result.LoadXml(&quot;&lt;results/&gt;&quot;);
            
            foreach (var r in results)
            {
                var x = XmlHelper.AddTextNode(result, &quot;result&quot;, &quot;&quot;);
                x.Attributes.Append(XmlHelper.AddAttribute(result, &quot;id&quot;, r.Id.ToString(CultureInfo.InvariantCulture)));
                x.Attributes.Append(XmlHelper.AddAttribute(result, &quot;title&quot;, r.Fields[&quot;nodeName&quot;]));
                x.Attributes.Append(XmlHelper.AddAttribute(result, &quot;author&quot;, r.Fields[&quot;writerName&quot;]));
                x.Attributes.Append(XmlHelper.AddAttribute(result, &quot;changeDate&quot;, r.Fields[&quot;updateDate&quot;]));
                x.Attributes.Append(xmlHelper.addAttribute(result, &quot;type&quot;, r.Fields[&quot;nodeTypeAlias&quot;]));
                result.DocumentElement.AppendChild(x);
            }

            return result;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,0],[23,13,23,45,0],[24,13,24,55,0],[25,13,25,14,0],[26,17,26,55,0],[27,13,27,14,0],[29,13,29,28,0],[30,9,30,10,0],[33,9,33,10,0],[34,13,34,61,0],[36,13,36,56,0],[37,13,37,14,0],[38,17,38,50,0],[39,17,39,28,0],[41,13,41,14,0],[42,9,42,10,0],[45,9,45,10,0],[46,13,46,24,0],[47,9,47,10,0],[50,9,50,10,0],[51,13,51,46,0],[54,13,54,60,0],[55,13,55,14,0],[56,17,56,29,0],[57,13,57,14,0],[60,13,62,65,0],[65,13,65,123,0],[68,13,68,37,0],[69,13,69,14,0],[71,17,71,75,0],[72,13,72,14,0],[74,13,74,14,0],[75,17,75,105,0],[75,105,75,144,0],[75,144,75,155,0],[75,17,75,155,0],[76,17,76,114,0],[77,17,77,35,0],[78,17,78,24,0],[78,26,78,34,0],[78,35,78,37,0],[78,38,78,43,0],[79,21,79,99,0],[82,17,82,72,0],[83,17,83,18,0],[86,21,86,100,0],[87,17,87,18,0],[89,17,89,72,0],[90,13,90,14,0],[92,13,92,51,0],[94,13,94,83,0],[95,9,95,10,0],[98,9,98,10,0],[99,13,99,44,0],[100,13,100,42,0],[102,13,102,20,0],[102,22,102,27,0],[102,28,102,30,0],[102,31,102,38,0],[103,13,103,14,0],[104,17,104,69,0],[105,17,105,120,0],[106,17,106,100,0],[107,17,107,103,0],[108,17,108,107,0],[109,17,109,104,0],[110,17,110,55,0],[111,13,111,14,0],[113,13,113,27,0],[114,9,114,10,0]]);
    </script>
  </body>
</html>