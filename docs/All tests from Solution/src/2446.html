<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.cms\businesslogic\macro\MacroProperty.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Xml;
using System.Runtime.CompilerServices;
using Umbraco.Core;
using Umbraco.Core.PropertyEditors;
using umbraco.DataLayer;
using umbraco.BusinessLogic;
using System.Collections.Generic;


namespace umbraco.cms.businesslogic.macro
{
    /// &lt;summary&gt;
    /// The macro property is used by macroes to communicate/transfer userinput to an instance of a macro.
    /// 
    /// It contains information on which type of data is inputted aswell as the userinterface used to input data
    /// 
    /// A MacroProperty uses it&#39;s MacroPropertyType to define which underlaying component should be used when
    /// rendering the MacroProperty editor aswell as which datatype its containing.
    /// &lt;/summary&gt;
    [Obsolete(&quot;This is no longer used, use the IMacroService and related models instead&quot;)]
    public class MacroProperty
    {
        /// &lt;summary&gt;
        /// Unused, please do not use
        /// &lt;/summary&gt;
        [Obsolete(&quot;Obsolete, For querying the database use the new UmbracoDatabase object ApplicationContext.Current.DatabaseContext.Database&quot;, false)]
        protected static ISqlHelper SqlHelper
        {
            get { return Application.SqlHelper; }
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;MacroProperty&quot;/&gt; class.
        /// &lt;/summary&gt;
        public MacroProperty()
        {
        }

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Id&quot;&gt;Id&lt;/param&gt;
        public MacroProperty(int Id)
        {
            this.Id = Id;
            Setup();
        }

        /// &lt;summary&gt;
        /// The sortorder
        /// &lt;/summary&gt;
        public int SortOrder { get; set; }

        /// &lt;summary&gt;
        /// This is not used for anything
        /// &lt;/summary&gt;
        [Obsolete(&quot;This is not used for anything and will be removed in future versions&quot;)]
        public bool Public { get; set; }

        /// &lt;summary&gt;
        /// The macro property alias
        /// &lt;/summary&gt;
        public string Alias { get; set; }

        /// &lt;summary&gt;
        /// The userfriendly name
        /// &lt;/summary&gt;
        public string Name { get; set; }

        /// &lt;summary&gt;
        /// Gets the id.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The id.&lt;/value&gt;
        public int Id { get; private set; }

        /// &lt;summary&gt;
        /// Gets or sets the macro.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The macro.&lt;/value&gt;
        public Macro Macro { get; set; }

        private MacroPropertyType _type;
        private string _parameterEditorAlias;

        /// &lt;summary&gt;
        /// The basetype which defines which component is used in the UI for editing content
        /// &lt;/summary&gt;
        [Obsolete(&quot;This is no longer used and will be removed in future versions&quot;)]
        public MacroPropertyType Type
        {
            get
            {
                if (_type == null)
                {
                    //we&#39;ll try to create one based on the resolved new parameter editors
                    var found = ParameterEditorResolver.Current.GetByAlias(ParameterEditorAlias);
                    if (found == null)
                    {
                        return null;
                    }
                    var type = new MacroPropertyType
                        {
                            Alias = ParameterEditorAlias,
                            Id = 0,
                            Assembly = found.GetType().Namespace,
                            //NOTE: In v6 macro parameter&#39;s stored in the database used to 
                            // expose a CLR type but we no longer support that, instead we&#39;ll just attempt
                            // to convert the value to the CLR type - It&#39;s also important to note that the
                            // ONLY place this BaseType is ever used is to assign to the umbraco.cms.businesslogic.macro.MacroPropertyModel.CLRType
                            // property, which is then used when attempting to render a UserControl macro. So basically
                            // it is completely pointless since we already know the CLR property type of the UserControl
                            // property and we&#39;re just going to do the conversion anyways since it is always essentially a string.
                            BaseType = &quot;String&quot;,
                            Type = found.GetType().Name
                        };
                    _type = type;
                }
                return _type;
            }
            set { _type = Type; }
        }

        /// &lt;summary&gt;
        /// The macro parameter editor alias used to render the editor
        /// &lt;/summary&gt;
        public string ParameterEditorAlias
        {
            get { return _parameterEditorAlias; }
            set
            {
                //try to get the new mapped parameter editor
                var mapped = LegacyParameterEditorAliasConverter.GetNewAliasFromLegacyAlias(value, false);
                if (mapped.IsNullOrWhiteSpace() == false)
                {
                    _parameterEditorAlias = mapped;
                }
                else
                {
                    _parameterEditorAlias = value;    
                }
                
            }
        }

        private void Setup()
        {
            using (var sqlHelper = Application.SqlHelper)
            using (var dr = sqlHelper.ExecuteReader(&quot;select macro, editorAlias, macroPropertySortOrder, macroPropertyAlias, macroPropertyName from cmsMacroProperty where id = @id&quot;, sqlHelper.CreateParameter(&quot;@id&quot;, Id)))
            {
                if (dr.Read())
                {
                    Macro = new Macro(dr.GetInt(&quot;macro&quot;));
                    SortOrder = (int)dr.GetByte(&quot;macroPropertySortOrder&quot;);
                    Alias = dr.GetString(&quot;macroPropertyAlias&quot;);
                    Name = dr.GetString(&quot;macroPropertyName&quot;);
                    Type = null;
                    ParameterEditorAlias = dr.GetString(&quot;editorAlias&quot;);
                }
                else
                {
                    throw new ArgumentException(&quot;No macro property found for the id specified&quot;);
                }
            }
        }

        /// &lt;summary&gt;
        /// Deletes the current macroproperty
        /// &lt;/summary&gt;
        public void Delete()
        {
            using (var sqlHelper = Application.SqlHelper)
                sqlHelper.ExecuteNonQuery(&quot;delete from cmsMacroProperty where id = @id&quot;, sqlHelper.CreateParameter(&quot;@id&quot;, this.Id));
        }

        public void Save()
        {
            if (Id == 0)
            {
                MacroProperty mp = MakeNew(Macro, Alias, Name, ParameterEditorAlias);
                Id = mp.Id;
            }
            else
            {
                using (var sqlHelper = Application.SqlHelper)
                    sqlHelper.ExecuteNonQuery(&quot;UPDATE cmsMacroProperty set macro = @macro, &quot; +
                                          &quot;macropropertyAlias = @alias, macroPropertyName = @name, &quot; +
                                          &quot;editorAlias = @editorAlias, macroPropertySortOrder = @so WHERE id = @id&quot;,
                                          sqlHelper.CreateParameter(&quot;@id&quot;, Id),
                                          sqlHelper.CreateParameter(&quot;@macro&quot;, Macro.Id),
                                          sqlHelper.CreateParameter(&quot;@alias&quot;, Alias),
                                          sqlHelper.CreateParameter(&quot;@name&quot;, Name),
                                          sqlHelper.CreateParameter(&quot;@editorAlias&quot;, ParameterEditorAlias),
                                          sqlHelper.CreateParameter(&quot;@so&quot;, SortOrder));
            }
        }

        /// &lt;summary&gt;
        /// Retrieve a Xmlrepresentation of the MacroProperty used for exporting the Macro to the package
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xd&quot;&gt;XmlDocument context&lt;/param&gt;
        /// &lt;returns&gt;A xmlrepresentation of the object&lt;/returns&gt;
        public XmlElement ToXml(XmlDocument xd)
        {
            XmlElement doc = xd.CreateElement(&quot;property&quot;);

            doc.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;name&quot;, this.Name));
            doc.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;alias&quot;, this.Alias));
            doc.Attributes.Append(XmlHelper.AddAttribute(xd, &quot;propertyType&quot;, this.ParameterEditorAlias));

            return doc;
        }

        #region STATICS

        /// &lt;summary&gt;
        /// Retieve all MacroProperties of a macro
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;macroId&quot;&gt;Macro identifier&lt;/param&gt;
        /// &lt;returns&gt;All MacroProperties of a macro&lt;/returns&gt;
        public static MacroProperty[] GetProperties(int macroId)
        {
            var props = new List&lt;MacroProperty&gt;();
            using (var sqlHelper = Application.SqlHelper)
            using (IRecordsReader dr = sqlHelper.ExecuteReader(&quot;select id from cmsMacroProperty where macro = @macroId order by macroPropertySortOrder, id ASC&quot;, sqlHelper.CreateParameter(&quot;@macroId&quot;, macroId)))
            {                
                while (dr.Read())
                {
                    props.Add(new MacroProperty(dr.GetInt(&quot;id&quot;)));
                }
                return props.ToArray();
            }
        }

        
        [MethodImpl(MethodImplOptions.Synchronized)]
        [Obsolete(&quot;This method is no longer supported because MacroPropertyType no longer has a function&quot;)]
        public static MacroProperty MakeNew(Macro macro, bool show, string alias, string name, MacroPropertyType propertyType)
        {
            return MakeNew(macro, alias, name, propertyType.Alias);
        }

        /// &lt;summary&gt;
        /// Creates a new MacroProperty on a macro
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;macro&quot;&gt;The macro&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;The alias of the property&lt;/param&gt;
        /// &lt;param name=&quot;name&quot;&gt;Userfriendly MacroProperty name&lt;/param&gt;
        /// &lt;param name=&quot;editorAlias&quot;&gt;The Alias of the parameter editor&lt;/param&gt;
        [MethodImpl(MethodImplOptions.Synchronized)]
        public static MacroProperty MakeNew(Macro macro, string alias, string name, string editorAlias)
        {
            //try to get the new mapped parameter editor
            var mapped = LegacyParameterEditorAliasConverter.GetNewAliasFromLegacyAlias(editorAlias, false);
            if (mapped.IsNullOrWhiteSpace() == false)
            {
                editorAlias = mapped;
            }

            int macroPropertyId = 0;
            // The method is synchronized
            using (var sqlHelper = Application.SqlHelper)
            {
                sqlHelper.ExecuteNonQuery(
                    &quot;INSERT INTO cmsMacroProperty (macro, macropropertyAlias, macroPropertyName, editorAlias) VALUES (@macro, @alias, @name, @editorAlias)&quot;,
                    sqlHelper.CreateParameter(&quot;@macro&quot;, macro.Id),
                    sqlHelper.CreateParameter(&quot;@alias&quot;, alias),
                    sqlHelper.CreateParameter(&quot;@name&quot;, name),
                    sqlHelper.CreateParameter(&quot;@editorAlias&quot;, editorAlias));
                macroPropertyId = sqlHelper.ExecuteScalar&lt;int&gt;(&quot;SELECT MAX(id) FROM cmsMacroProperty&quot;);
                return new MacroProperty(macroPropertyId);
            }
        }

        #endregion

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,17,31,18,0],[31,19,31,48,0],[31,49,31,50,0],[37,9,37,31,0],[38,9,38,10,0],[39,9,39,10,0],[45,9,45,37,0],[46,9,46,10,0],[47,13,47,26,0],[48,13,48,21,0],[49,9,49,10,0],[54,32,54,36,0],[54,37,54,41,0],[60,30,60,34,0],[60,35,60,39,0],[65,31,65,35,0],[65,36,65,40,0],[70,30,70,34,0],[70,35,70,39,0],[76,25,76,29,0],[76,30,76,42,0],[82,30,82,34,0],[82,35,82,39,0],[94,13,94,14,0],[95,17,95,35,0],[96,17,96,18,0],[98,21,98,98,0],[99,21,99,39,0],[100,21,100,22,0],[101,25,101,37,0],[103,21,117,27,0],[118,21,118,34,0],[119,17,119,18,0],[120,17,120,30,0],[121,13,121,14,0],[122,17,122,18,0],[122,19,122,32,0],[122,33,122,34,0],[130,17,130,18,0],[130,19,130,48,0],[130,49,130,50,0],[132,13,132,14,0],[134,17,134,107,0],[135,17,135,58,0],[136,17,136,18,0],[137,21,137,52,0],[138,17,138,18,0],[140,17,140,18,0],[141,21,141,51,0],[142,17,142,18,0],[144,13,144,14,0],[148,9,148,10,0],[149,20,149,57,0],[150,20,150,219,0],[151,13,151,14,0],[152,17,152,31,0],[153,17,153,18,0],[154,21,154,59,0],[155,21,155,75,0],[156,21,156,64,0],[157,21,157,62,0],[158,21,158,33,0],[159,21,159,72,0],[160,17,160,18,0],[162,17,162,18,0],[163,21,163,97,0],[165,13,165,14,0],[166,9,166,10,0],[172,9,172,10,0],[173,20,173,57,0],[174,17,174,133,0],[175,9,175,10,0],[178,9,178,10,0],[179,13,179,25,0],[180,13,180,14,0],[181,17,181,86,0],[182,17,182,28,0],[183,13,183,14,0],[185,13,185,14,0],[186,24,186,61,0],[187,21,195,88,0],[196,13,196,14,0],[197,9,197,10,0],[205,9,205,10,0],[206,13,206,59,0],[208,13,208,82,0],[209,13,209,84,0],[210,13,210,106,0],[212,13,212,24,0],[213,9,213,10,0],[223,9,223,10,0],[224,13,224,51,0],[225,20,225,57,0],[226,20,226,209,0],[227,13,227,14,0],[228,17,228,34,0],[229,17,229,18,0],[230,21,230,67,0],[231,17,231,18,0],[232,17,232,40,0],[234,9,234,10,0],[240,9,240,10,0],[241,13,241,68,0],[242,9,242,10,0],[253,9,253,10,0],[255,13,255,109,0],[256,13,256,54,0],[257,13,257,14,0],[258,17,258,38,0],[259,13,259,14,0],[261,13,261,37,0],[263,20,263,57,0],[264,13,264,14,0],[265,17,270,77,0],[271,17,271,104,0],[272,17,272,59,0],[274,9,274,10,0]]);
    </script>
  </body>
</html>