<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\UmbracoExamine\IndexInitializer.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Xml.Linq;
using Examine;
using Examine.LuceneEngine.Config;
using Examine.LuceneEngine.Providers;
using Lucene.Net.Analysis;
using Lucene.Net.Analysis.Standard;
using Lucene.Net.Index;
using Lucene.Net.Store;
using Moq;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Services;
using UmbracoExamine;
using UmbracoExamine.Config;
using UmbracoExamine.DataServices;
using IContentService = Umbraco.Core.Services.IContentService;
using IMediaService = Umbraco.Core.Services.IMediaService;
using Version = Lucene.Net.Util.Version;

namespace Umbraco.Tests.UmbracoExamine
{
    /// &lt;summary&gt;
    /// Used internally by test classes to initialize a new index from the template
    /// &lt;/summary&gt;
    internal static class IndexInitializer
    {
        public static UmbracoContentIndexer GetUmbracoIndexer(
                IndexWriter writer,
                Analyzer analyzer = null,
                IDataService dataService = null,
                IContentService contentService = null,
                IMediaService mediaService = null,
                IDataTypeService dataTypeService = null,
                IMemberService memberService = null,
                IUserService userService = null,
                IContentTypeService contentTypeService = null, 
                bool supportUnpublishedContent = false)
        {
            if (dataService == null)
            {
                dataService = new TestDataService();
            }
            if (contentService == null)
            {
                long longTotalRecs;
                int intTotalRecs;

                var allRecs = dataService.ContentService.GetLatestContentByXPath(&quot;//*[@isDoc]&quot;)
                    .Root
                    .Elements()
                    .Select(x =&gt; Mock.Of&lt;IContent&gt;(
                        m =&gt;
                            m.Id == (int)x.Attribute(&quot;id&quot;) &amp;&amp;
                            m.ParentId == (int)x.Attribute(&quot;parentID&quot;) &amp;&amp;
                            m.Level == (int)x.Attribute(&quot;level&quot;) &amp;&amp;
                            m.CreatorId == 0 &amp;&amp;
                            m.SortOrder == (int)x.Attribute(&quot;sortOrder&quot;) &amp;&amp;
                            m.CreateDate == (DateTime)x.Attribute(&quot;createDate&quot;) &amp;&amp;
                            m.UpdateDate == (DateTime)x.Attribute(&quot;updateDate&quot;) &amp;&amp;
                            m.Name == (string)x.Attribute(&quot;nodeName&quot;) &amp;&amp;
                            m.Path == (string)x.Attribute(&quot;path&quot;) &amp;&amp;
                            m.Properties == new PropertyCollection() &amp;&amp;
                            m.ContentType == Mock.Of&lt;IContentType&gt;(mt =&gt;
                                mt.Alias == x.Name.LocalName &amp;&amp;
                                mt.Id == (int)x.Attribute(&quot;nodeType&quot;) &amp;&amp;
                                mt.Icon == &quot;test&quot;)))
                    .ToArray();


                contentService = Mock.Of&lt;IContentService&gt;(
                    x =&gt; x.GetPagedDescendants(
                        It.IsAny&lt;int&gt;(), It.IsAny&lt;long&gt;(), It.IsAny&lt;int&gt;(), out longTotalRecs, It.IsAny&lt;string&gt;(), It.IsAny&lt;Direction&gt;(), It.IsAny&lt;bool&gt;(), It.IsAny&lt;string&gt;())
                        ==
                        allRecs
                        &amp;&amp; x.GetPagedDescendants(
                        It.IsAny&lt;int&gt;(), It.IsAny&lt;long&gt;(), It.IsAny&lt;int&gt;(), out longTotalRecs, It.IsAny&lt;string&gt;(), It.IsAny&lt;Direction&gt;(), It.IsAny&lt;string&gt;())
                        ==
                        allRecs
                        &amp;&amp; x.GetPagedDescendants(
                        It.IsAny&lt;int&gt;(), It.IsAny&lt;int&gt;(), It.IsAny&lt;int&gt;(), out intTotalRecs, It.IsAny&lt;string&gt;(), It.IsAny&lt;Direction&gt;(), It.IsAny&lt;string&gt;())
                        ==
                        allRecs
                        &amp;&amp; x.GetPagedDescendants(
                        It.IsAny&lt;int&gt;(), It.IsAny&lt;long&gt;(), It.IsAny&lt;int&gt;(), out longTotalRecs, It.IsAny&lt;string&gt;(), It.IsAny&lt;Direction&gt;(), It.IsAny&lt;bool&gt;(), It.IsAny&lt;IQuery&lt;IContent&gt;&gt;())
                        ==
                        allRecs);
            }
            if (userService == null)
            {
                userService = Mock.Of&lt;IUserService&gt;(x =&gt; x.GetProfileById(It.IsAny&lt;int&gt;()) == Mock.Of&lt;IProfile&gt;(p =&gt; p.Id == (object)0 &amp;&amp; p.Name == &quot;admin&quot;));
            }
            if (mediaService == null)
            {
                long longTotalRecs;
                int intTotalRecs;

                var mediaXml = dataService.MediaService.GetLatestMediaByXpath(&quot;//node&quot;);
                var allRecs = mediaXml
                    .Root
                    .Elements()
                    .Select(x =&gt; Mock.Of&lt;IMedia&gt;(
                        m =&gt;
                            m.Id == (int)x.Attribute(&quot;id&quot;) &amp;&amp;
                            m.ParentId == (int)x.Attribute(&quot;parentID&quot;) &amp;&amp;
                            m.Level == (int)x.Attribute(&quot;level&quot;) &amp;&amp;
                            m.CreatorId == 0 &amp;&amp;
                            m.SortOrder == (int)x.Attribute(&quot;sortOrder&quot;) &amp;&amp;
                            m.CreateDate == (DateTime)x.Attribute(&quot;createDate&quot;) &amp;&amp;
                            m.UpdateDate == (DateTime)x.Attribute(&quot;updateDate&quot;) &amp;&amp;
                            m.Name == (string)x.Attribute(&quot;nodeName&quot;) &amp;&amp;
                            m.Path == (string)x.Attribute(&quot;path&quot;) &amp;&amp;
                            m.Properties == new PropertyCollection() &amp;&amp;
                            m.ContentType == Mock.Of&lt;IMediaType&gt;(mt =&gt;
                                mt.Alias == (string)x.Attribute(&quot;nodeTypeAlias&quot;) &amp;&amp;
                                mt.Id == (int)x.Attribute(&quot;nodeType&quot;))))
                    .ToArray();

                // MOCK!
                var mediaServiceMock = new Mock&lt;IMediaService&gt;();

                mediaServiceMock
                    .Setup(x =&gt; x.GetPagedDescendants(
                            It.IsAny&lt;int&gt;(), It.IsAny&lt;long&gt;(), It.IsAny&lt;int&gt;(), out longTotalRecs, It.IsAny&lt;string&gt;(), It.IsAny&lt;Direction&gt;(), It.IsAny&lt;bool&gt;(), It.IsAny&lt;string&gt;())
                    ).Returns(() =&gt; allRecs);

                mediaServiceMock
                    .Setup(x =&gt; x.GetPagedDescendants(
                            It.IsAny&lt;int&gt;(), It.IsAny&lt;long&gt;(), It.IsAny&lt;int&gt;(), out longTotalRecs, It.IsAny&lt;string&gt;(), It.IsAny&lt;Direction&gt;(), It.IsAny&lt;string&gt;())
                    ).Returns(() =&gt; allRecs);

                mediaServiceMock
                   .Setup(x =&gt; x.GetPagedDescendants(
                           It.IsAny&lt;int&gt;(), It.IsAny&lt;int&gt;(), It.IsAny&lt;int&gt;(), out intTotalRecs, It.IsAny&lt;string&gt;(), It.IsAny&lt;Direction&gt;(), It.IsAny&lt;string&gt;())
                   ).Returns(() =&gt; allRecs);

                mediaServiceMock.Setup(service =&gt; service.GetPagedXmlEntries(It.IsAny&lt;string&gt;(), It.IsAny&lt;long&gt;(), It.IsAny&lt;int&gt;(), out longTotalRecs))
                    .Returns(() =&gt; allRecs.Select(x =&gt; x.ToXml()));

                mediaService = mediaServiceMock.Object;

            }
            if (dataTypeService == null)
            {
                dataTypeService = Mock.Of&lt;IDataTypeService&gt;();
            }

            if (memberService == null)
            {
                memberService = Mock.Of&lt;IMemberService&gt;();
            }

            if (contentTypeService == null)
            {
                var contentTypeServiceMock = new Mock&lt;IContentTypeService&gt;();
                contentTypeServiceMock.Setup(x =&gt; x.GetAllMediaTypes())
                    .Returns(new List&lt;IMediaType&gt;()
                    {
                        new MediaType(-1) {Alias = &quot;Folder&quot;, Name = &quot;Folder&quot;, Id = 1031, Icon = &quot;icon-folder&quot;},
                        new MediaType(-1) {Alias = &quot;Image&quot;, Name = &quot;Image&quot;, Id = 1032, Icon = &quot;icon-picture&quot;}
                    });
                contentTypeService = contentTypeServiceMock.Object;
            }

            if (analyzer == null)
            {
                analyzer = new StandardAnalyzer(Version.LUCENE_29);
            }

            var indexSet = new IndexSet();
            var indexCriteria = indexSet.ToIndexCriteria(dataService, UmbracoContentIndexer.IndexFieldPolicies);

            var i = new UmbracoContentIndexer(indexCriteria,
                writer, 
                dataService,
                contentService,
                mediaService,
                dataTypeService,
                userService,
                contentTypeService,
                false)
            {
                SupportUnpublishedContent = supportUnpublishedContent
            };

            //i.IndexSecondsInterval = 1;

            i.IndexingError += IndexingError;

            return i;
        }

        public static UmbracoExamineSearcher GetUmbracoSearcher(IndexWriter writer, Analyzer analyzer = null)
        {
            if (analyzer == null)
            {
                analyzer = new StandardAnalyzer(Version.LUCENE_29);
            }
            return new UmbracoExamineSearcher(writer, analyzer);
        }

        public static LuceneSearcher GetLuceneSearcher(Directory luceneDir)
        {
            return new LuceneSearcher(luceneDir, new StandardAnalyzer(Version.LUCENE_29));
        }

        public static MultiIndexSearcher GetMultiSearcher(Directory pdfDir, Directory simpleDir, Directory conventionDir, Directory cwsDir)
        {
            var i = new MultiIndexSearcher(new[] { pdfDir, simpleDir, conventionDir, cwsDir }, new StandardAnalyzer(Version.LUCENE_29));
            return i;
        }


        internal static void IndexingError(object sender, IndexingErrorEventArgs e)
        {
            throw new ApplicationException(e.Message, e.InnerException);
        }


    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[47,9,47,10,1],[48,13,48,37,1],[49,13,49,14,1],[50,17,50,53,1],[51,13,51,14,1],[52,13,52,40,1],[53,13,53,14,1],[57,17,60,34,1],[60,34,75,52,1],[75,52,76,32,1],[57,17,76,32,1],[79,17,95,34,1],[96,13,96,14,1],[97,13,97,37,1],[98,13,98,14,1],[99,17,99,159,1],[100,13,100,14,1],[101,13,101,38,1],[102,13,102,14,1],[106,17,106,89,1],[107,17,110,34,1],[110,34,124,72,1],[124,72,125,32,1],[107,17,125,32,1],[128,17,128,66,1],[130,17,133,37,1],[133,37,133,44,0],[133,44,133,46,1],[130,17,133,46,1],[135,17,138,37,1],[138,37,138,44,0],[138,44,138,46,1],[135,17,138,46,1],[140,17,143,36,1],[143,36,143,43,0],[143,43,143,45,1],[140,17,143,45,1],[145,17,146,36,1],[146,36,146,56,1],[146,56,146,65,1],[146,65,146,66,1],[146,36,146,66,1],[146,66,146,68,1],[145,17,146,68,1],[148,17,148,56,1],[150,13,150,14,1],[151,13,151,41,1],[152,13,152,14,1],[153,17,153,63,1],[154,13,154,14,1],[156,13,156,39,1],[157,13,157,14,1],[158,17,158,59,1],[159,13,159,14,1],[161,13,161,44,1],[162,13,162,14,1],[163,17,163,78,1],[164,17,169,24,1],[170,17,170,68,1],[171,13,171,14,1],[173,13,173,34,1],[174,13,174,14,1],[175,17,175,68,1],[176,13,176,14,1],[178,13,178,43,1],[179,13,179,113,1],[181,13,192,15,1],[196,13,196,46,1],[198,13,198,22,1],[199,9,199,10,1],[202,9,202,10,1],[203,13,203,34,1],[204,13,204,14,1],[205,17,205,68,1],[206,13,206,14,1],[207,13,207,65,1],[208,9,208,10,1],[211,9,211,10,0],[212,13,212,91,0],[213,9,213,10,0],[216,9,216,10,0],[217,13,217,137,0],[218,13,218,22,0],[219,9,219,10,0],[223,9,223,10,0],[224,13,224,73,0]]);
    </script>
  </body>
</html>