<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebApi\Filters\ValidateAngularAntiForgeryTokenAttribute.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Net;
using System.Net.Http;
using System.Security.Claims;
using System.Web.Http;
using System.Web.Http.Filters;

namespace Umbraco.Web.WebApi.Filters
{
    /// &lt;summary&gt;
    /// A filter to check for the csrf token based on Angular&#39;s standard approach
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// Code derived from http://ericpanorel.net/2013/07/28/spa-authentication-and-csrf-mvc4-antiforgery-implementation/
    /// 
    /// If the authentication type is cookie based, then this filter will execute, otherwise it will be disabled
    /// &lt;/remarks&gt;
    public sealed class ValidateAngularAntiForgeryTokenAttribute : ActionFilterAttribute
    {
        public override void OnActionExecuting(System.Web.Http.Controllers.HttpActionContext actionContext)
        {
            var userIdentity = ((ApiController) actionContext.ControllerContext.Controller).User.Identity as ClaimsIdentity;
            if (userIdentity != null)
            {
                //if there is not CookiePath claim, then exist
                if (userIdentity.HasClaim(x =&gt; x.Type == ClaimTypes.CookiePath) == false)
                {
                    base.OnActionExecuting(actionContext);
                    return;
                }
            }

            string failedReason;
            if (AngularAntiForgeryHelper.ValidateHeaders(actionContext.Request.Headers, out failedReason) == false)
            {
                actionContext.Response = actionContext.Request.CreateResponse(HttpStatusCode.ExpectationFailed);
                actionContext.Response.ReasonPhrase = failedReason;
                return;
            }

            base.OnActionExecuting(actionContext);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,9,20,10,0],[21,13,21,125,0],[22,13,22,38,0],[23,13,23,14,0],[25,17,25,48,0],[25,48,25,79,0],[25,79,25,90,0],[25,17,25,90,0],[26,17,26,18,0],[27,21,27,59,0],[28,21,28,28,0],[30,13,30,14,0],[33,13,33,116,0],[34,13,34,14,0],[35,17,35,113,0],[36,17,36,68,0],[37,17,37,24,0],[40,13,40,51,0],[41,9,41,10,0]]);
    </script>
  </body>
</html>