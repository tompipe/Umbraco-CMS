<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Querying\ContentRepositorySqlClausesTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Querying
{
    [TestFixture]
    public class ContentRepositorySqlClausesTest : BaseUsingSqlCeSyntax
    {
        [Test]
        public void Can_Verify_Base_Clause()
        {
            var NodeObjectType = new Guid(Constants.ObjectTypes.Document);

            var expected = new Sql();
            expected.Select(&quot;*&quot;)
                .From(&quot;[cmsDocument]&quot;)
                .InnerJoin(&quot;[cmsContentVersion]&quot;).On(&quot;[cmsDocument].[versionId] = [cmsContentVersion].[VersionId]&quot;)
                .InnerJoin(&quot;[cmsContent]&quot;).On(&quot;[cmsContentVersion].[ContentId] = [cmsContent].[nodeId]&quot;)
                .InnerJoin(&quot;[umbracoNode]&quot;).On(&quot;[cmsContent].[nodeId] = [umbracoNode].[id]&quot;)
                .Where(&quot;([umbracoNode].[nodeObjectType] = @0)&quot;, new Guid(&quot;c66ba18e-eaf3-4cff-8a22-41b16d66a972&quot;));

            var sql = new Sql();
            sql.Select(&quot;*&quot;)
                .From&lt;DocumentDto&gt;()
                .InnerJoin&lt;ContentVersionDto&gt;()
                .On&lt;DocumentDto, ContentVersionDto&gt;(left =&gt; left.VersionId, right =&gt; right.VersionId)
                .InnerJoin&lt;ContentDto&gt;()
                .On&lt;ContentVersionDto, ContentDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .InnerJoin&lt;NodeDto&gt;()
                .On&lt;ContentDto, NodeDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == NodeObjectType);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));

            Assert.AreEqual(expected.Arguments.Length, sql.Arguments.Length);
            for (int i = 0; i &lt; expected.Arguments.Length; i++)
            {
                Assert.AreEqual(expected.Arguments[i], sql.Arguments[i]);
            }

            Debug.Print(sql.SQL);
        }

        [Test]
        public void Can_Verify_Base_Where_Clause()
        {
            var NodeObjectType = new Guid(Constants.ObjectTypes.Document);

            var expected = new Sql();
            expected.Select(&quot;*&quot;)
                .From(&quot;[cmsDocument]&quot;)
                .InnerJoin(&quot;[cmsContentVersion]&quot;).On(&quot;[cmsDocument].[versionId] = [cmsContentVersion].[VersionId]&quot;)
                .InnerJoin(&quot;[cmsContent]&quot;).On(&quot;[cmsContentVersion].[ContentId] = [cmsContent].[nodeId]&quot;)
                .InnerJoin(&quot;[umbracoNode]&quot;).On(&quot;[cmsContent].[nodeId] = [umbracoNode].[id]&quot;)
                .Where(&quot;([umbracoNode].[nodeObjectType] = @0)&quot;, new Guid(&quot;c66ba18e-eaf3-4cff-8a22-41b16d66a972&quot;))
                .Where(&quot;([umbracoNode].[id] = @0)&quot;, 1050);

            var sql = new Sql();
            sql.Select(&quot;*&quot;)
                .From&lt;DocumentDto&gt;()
                .InnerJoin&lt;ContentVersionDto&gt;()
                .On&lt;DocumentDto, ContentVersionDto&gt;(left =&gt; left.VersionId, right =&gt; right.VersionId)
                .InnerJoin&lt;ContentDto&gt;()
                .On&lt;ContentVersionDto, ContentDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .InnerJoin&lt;NodeDto&gt;()
                .On&lt;ContentDto, NodeDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == NodeObjectType)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeId == 1050);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));

            Assert.AreEqual(expected.Arguments.Length, sql.Arguments.Length);
            for (int i = 0; i &lt; expected.Arguments.Length; i++)
            {
                Assert.AreEqual(expected.Arguments[i], sql.Arguments[i]);
            }

            Debug.Print(sql.SQL);
        }

        [Test]
        public void Can_Verify_Base_Where_With_Version_Clause()
        {
            var NodeObjectType = new Guid(Constants.ObjectTypes.Document);
            var versionId = new Guid(&quot;2b543516-a944-4ee6-88c6-8813da7aaa07&quot;);

            var expected = new Sql();
            expected.Select(&quot;*&quot;)
                .From(&quot;[cmsDocument]&quot;)
                .InnerJoin(&quot;[cmsContentVersion]&quot;).On(&quot;[cmsDocument].[versionId] = [cmsContentVersion].[VersionId]&quot;)
                .InnerJoin(&quot;[cmsContent]&quot;).On(&quot;[cmsContentVersion].[ContentId] = [cmsContent].[nodeId]&quot;)
                .InnerJoin(&quot;[umbracoNode]&quot;).On(&quot;[cmsContent].[nodeId] = [umbracoNode].[id]&quot;)
                .Where(&quot;([umbracoNode].[nodeObjectType] = @0)&quot;, new Guid(&quot;c66ba18e-eaf3-4cff-8a22-41b16d66a972&quot;))
                .Where(&quot;([umbracoNode].[id] = @0)&quot;, 1050)
                .Where(&quot;([cmsContentVersion].[VersionId] = @0)&quot;, new Guid(&quot;2b543516-a944-4ee6-88c6-8813da7aaa07&quot;))
                .OrderBy(&quot;([cmsContentVersion].[VersionDate]) DESC&quot;);

            var sql = new Sql();
            sql.Select(&quot;*&quot;)
                .From&lt;DocumentDto&gt;()
                .InnerJoin&lt;ContentVersionDto&gt;()
                .On&lt;DocumentDto, ContentVersionDto&gt;(left =&gt; left.VersionId, right =&gt; right.VersionId)
                .InnerJoin&lt;ContentDto&gt;()
                .On&lt;ContentVersionDto, ContentDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .InnerJoin&lt;NodeDto&gt;()
                .On&lt;ContentDto, NodeDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeObjectType == NodeObjectType)
                .Where&lt;NodeDto&gt;(x =&gt; x.NodeId == 1050)
                .Where&lt;ContentVersionDto&gt;(x =&gt; x.VersionId == versionId)
                .OrderByDescending&lt;ContentVersionDto&gt;(x =&gt; x.VersionDate);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));
            Assert.AreEqual(expected.Arguments.Length, sql.Arguments.Length);
            for (int i = 0; i &lt; expected.Arguments.Length; i++)
            {
                Assert.AreEqual(expected.Arguments[i], sql.Arguments[i]);
            }

            Debug.Print(sql.SQL);
        }

        [Test]
        public void Can_Verify_Property_Collection_Query()
        {
            var versionId = new Guid(&quot;2b543516-a944-4ee6-88c6-8813da7aaa07&quot;);
            var id = 1050;

            var expected = new Sql();
            expected.Select(&quot;*&quot;);
            expected.From(&quot;[cmsPropertyData]&quot;);
            expected.InnerJoin(&quot;[cmsPropertyType]&quot;).On(&quot;[cmsPropertyData].[propertytypeid] = [cmsPropertyType].[id]&quot;);
            expected.Where(&quot;([cmsPropertyData].[contentNodeId] = @0)&quot;, 1050);
            expected.Where(&quot;([cmsPropertyData].[versionId] = @0)&quot;, new Guid(&quot;2b543516-a944-4ee6-88c6-8813da7aaa07&quot;));

            var sql = new Sql();
            sql.Select(&quot;*&quot;)
                .From&lt;PropertyDataDto&gt;()
                .InnerJoin&lt;PropertyTypeDto&gt;()
                .On&lt;PropertyDataDto, PropertyTypeDto&gt;(left =&gt; left.PropertyTypeId, right =&gt; right.Id)
                .Where&lt;PropertyDataDto&gt;(x =&gt; x.NodeId == id)
                .Where&lt;PropertyDataDto&gt;(x =&gt; x.VersionId == versionId);

            Assert.That(sql.SQL, Is.EqualTo(expected.SQL));
            Assert.AreEqual(expected.Arguments.Length, sql.Arguments.Length);
            for (int i = 0; i &lt; expected.Arguments.Length; i++)
            {
                Assert.AreEqual(expected.Arguments[i], sql.Arguments[i]);
            }

            Debug.Print(sql.SQL);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,1],[17,13,17,75,1],[19,13,19,38,1],[20,13,25,115,1],[27,13,27,33,1],[28,13,36,74,1],[38,13,38,60,1],[40,13,40,78,1],[41,18,41,27,1],[41,29,41,58,1],[41,60,41,63,1],[42,13,42,14,1],[43,17,43,74,1],[44,13,44,14,1],[46,13,46,34,1],[47,9,47,10,1],[51,9,51,10,1],[52,13,52,75,1],[54,13,54,38,1],[55,13,61,59,1],[63,13,63,33,1],[64,13,73,56,1],[75,13,75,60,1],[77,13,77,78,1],[78,18,78,27,1],[78,29,78,58,1],[78,60,78,63,1],[79,13,79,14,1],[80,17,80,74,1],[81,13,81,14,1],[83,13,83,34,1],[84,9,84,10,1],[88,9,88,10,1],[89,13,89,75,1],[90,13,90,78,1],[92,13,92,38,1],[93,13,101,70,1],[103,13,103,33,1],[104,13,115,75,1],[117,13,117,60,1],[118,13,118,78,1],[119,18,119,27,1],[119,29,119,58,1],[119,60,119,63,1],[120,13,120,14,1],[121,17,121,74,1],[122,13,122,14,1],[124,13,124,34,1],[125,9,125,10,1],[129,9,129,10,1],[130,13,130,78,1],[131,13,131,27,1],[133,13,133,38,1],[134,13,134,34,1],[135,13,135,48,1],[136,13,136,119,1],[137,13,137,78,1],[138,13,138,118,1],[140,13,140,33,1],[141,13,146,72,1],[148,13,148,60,1],[149,13,149,78,1],[150,18,150,27,1],[150,29,150,58,1],[150,60,150,63,1],[151,13,151,14,1],[152,17,152,74,1],[153,13,153,14,1],[155,13,155,34,1],[156,9,156,10,1]]);
    </script>
  </body>
</html>