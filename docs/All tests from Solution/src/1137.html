<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Install\InstallSteps\Version73FileCleanup.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading;
using System.Web;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Web.Install.Models;

namespace Umbraco.Web.Install.InstallSteps
{
    [InstallSetupStep(InstallationType.Upgrade,
        &quot;Version73FileCleanup&quot;, 2, 
        &quot;Performing some housecleaning...&quot;, 
        PerformsAppRestart = true)]
    internal class Version73FileCleanup : InstallSetupStep&lt;object&gt;
    {
        private readonly HttpContextBase _httpContext;
        private readonly ILogger _logger;

        public Version73FileCleanup(HttpContextBase httpContext, ILogger logger)
        {
            _httpContext = httpContext;
            _logger = logger;
        }

        /// &lt;summary&gt;
        /// The step execution method
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;model&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override InstallSetupResult Execute(object model)
        {
            //first cleanup all web.configs

            var root = new DirectoryInfo(_httpContext.Server.MapPath(&quot;~/&quot;));
            ProcessWebConfigs(root);
            
            //now remove the dll 

            var bin = root.GetDirectories(&quot;bin&quot;, SearchOption.TopDirectoryOnly);
            if (bin.Length == 1)
            {
                var dll = bin[0].GetFiles(&quot;Microsoft.Web.Mvc.FixedDisplayModes.dll&quot;, SearchOption.TopDirectoryOnly);
                if (dll.Length == 1)
                {
                    _logger.Info&lt;Version73FileCleanup&gt;(&quot;Deleting non-compatible and no longer used DLL: {0}&quot;, () =&gt; dll[0].FullName);
                    File.Delete(dll[0].FullName);
                }
            }

            return null;
        }

        /// &lt;summary&gt;
        /// Determines if this step needs to execute based on the current state of the application and/or install process
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override bool RequiresExecution(object model)
        {
            return UmbracoVersion.Current == Version.Parse(&quot;7.3.0&quot;);
        }

        private void ProcessWebConfigs(DirectoryInfo dir)
        {
            //Do the processing of files
            var found = dir.GetFiles(&quot;web.config&quot;, SearchOption.AllDirectories);

            foreach (var configFile in found)
            {
                var fileName = configFile.FullName;
                _logger.Info&lt;Version73FileCleanup&gt;(&quot;Cleaning up web.config file: {0}&quot;, () =&gt; fileName);

                var contents = File.ReadAllText(fileName);
                contents = _microsoftWebHelpers.Replace(contents, string.Empty);
                contents = _webPagesRazorVersion.Replace(contents, &quot;$1=3.0.0.0&quot;);
                contents = _mvcVersion.Replace(contents, &quot;$1=5.2.3.0&quot;);
                using (var writer = new StreamWriter(configFile.FullName, false))
                {
                    writer.Write(contents);
                }
            }
        }

        private readonly Regex _microsoftWebHelpers = new Regex(@&quot;&lt;add\s*?namespace=&quot;&quot;Microsoft\.Web\.Helpers&quot;&quot;\s*?/&gt;&quot;, RegexOptions.Compiled);
        private readonly Regex _webPagesRazorVersion = new Regex(@&quot;(System\.Web\.WebPages\.Razor,\s*?Version)(=2\.0\.0\.0)&quot;, RegexOptions.Compiled);
        private readonly Regex _mvcVersion = new Regex(@&quot;(System\.Web\.Mvc,\s*?Version)(=4\.0\.0\.0)&quot;, RegexOptions.Compiled);
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,81,0],[23,9,23,10,0],[24,13,24,40,0],[25,13,25,30,0],[26,9,26,10,0],[34,9,34,10,0],[37,13,37,77,0],[38,13,38,37,0],[42,13,42,81,0],[43,13,43,33,0],[44,13,44,14,0],[45,17,45,117,0],[46,17,46,37,0],[47,17,47,18,0],[48,21,48,117,0],[48,117,48,132,0],[48,132,48,134,0],[48,21,48,134,0],[49,21,49,50,0],[50,17,50,18,0],[51,13,51,14,0],[53,13,53,25,0],[54,9,54,10,0],[61,9,61,10,0],[62,13,62,69,0],[63,9,63,10,0],[66,9,66,10,0],[68,13,68,81,0],[70,13,70,20,0],[70,22,70,36,0],[70,37,70,39,0],[70,40,70,45,0],[71,13,71,14,0],[72,17,72,52,0],[73,17,73,94,0],[73,94,73,102,0],[73,102,73,104,0],[73,17,73,104,0],[75,17,75,59,0],[76,17,76,81,0],[77,17,77,82,0],[78,17,78,72,0],[79,24,79,81,0],[80,17,80,18,0],[81,21,81,44,0],[82,17,82,18,0],[83,13,83,14,0],[84,9,84,10,0],[86,9,86,144,0],[87,9,87,149,0],[88,9,88,127,0]]);
    </script>
  </body>
</html>