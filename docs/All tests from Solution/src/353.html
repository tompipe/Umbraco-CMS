<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\EntityRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Configuration.UmbracoSettings;
using Umbraco.Core.IO;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class EntityRepositoryTest : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();            
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }
        
        private ContentRepository CreateContentRepository(IDatabaseUnitOfWork unitOfWork, out ContentTypeRepository contentTypeRepository)
        {
            TemplateRepository tr;
            return CreateContentRepository(unitOfWork, out contentTypeRepository, out tr);
        }

        private ContentRepository CreateContentRepository(IDatabaseUnitOfWork unitOfWork, out ContentTypeRepository contentTypeRepository, out TemplateRepository templateRepository)
        {
            templateRepository = new TemplateRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, Mock.Of&lt;IFileSystem&gt;(), Mock.Of&lt;IFileSystem&gt;(), Mock.Of&lt;ITemplatesSection&gt;());
            var tagRepository = new TagRepository(unitOfWork, CacheHelper, Logger, SqlSyntax);
            contentTypeRepository = new ContentTypeRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, templateRepository);
            var repository = new ContentRepository(unitOfWork, CacheHelper, Logger, SqlSyntax, contentTypeRepository, templateRepository, tagRepository, Mock.Of&lt;IContentSection&gt;());
            return repository;
        }

        [Test]
        public void Deal_With_Corrupt_Duplicate_Newest_Published_Flags_Full_Model()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            IContent content1;            

            using (var repository = CreateContentRepository(unitOfWork, out contentTypeRepository))
            {
                var hasPropertiesContentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;);
                content1 = MockedContent.CreateSimpleContent(hasPropertiesContentType);

                contentTypeRepository.AddOrUpdate(hasPropertiesContentType);
                repository.AddOrUpdate(content1);
                unitOfWork.Commit();
            }

            var versionDtos = new List&lt;ContentVersionDto&gt;();

            //Now manually corrupt the data
            var versions = new[] {Guid.NewGuid(), Guid.NewGuid()};
            for (var index = 0; index &lt; versions.Length; index++)
            {
                var version = versions[index];
                var versionDate = DateTime.Now.AddMinutes(index);
                var versionDto = new ContentVersionDto
                {
                    NodeId = content1.Id,
                    VersionDate = versionDate,
                    VersionId = version
                };
                this.DatabaseContext.Database.Insert(versionDto);
                versionDtos.Add(versionDto);
                this.DatabaseContext.Database.Insert(new DocumentDto
                {
                    Newest = true,
                    NodeId = content1.Id,
                    Published = true,
                    Text = content1.Name,
                    VersionId = version,
                    WriterUserId = 0,
                    UpdateDate = versionDate,
                    TemplateId = content1.Template == null || content1.Template.Id &lt;= 0 ? null : (int?)content1.Template.Id
                });
            }

            // Assert
            using (var repository = new EntityRepository(unitOfWork))
            {
                var content = repository.GetByQuery(new Query&lt;IUmbracoEntity&gt;().Where(c =&gt; c.Id == content1.Id), Constants.ObjectTypes.DocumentGuid).ToArray();
                Assert.AreEqual(1, content.Length);
                Assert.AreEqual(versionDtos.Max(x =&gt; x.Id), content[0].AdditionalData[&quot;VersionId&quot;]);

                content = repository.GetAll(Constants.ObjectTypes.DocumentGuid, content[0].Key).ToArray();
                Assert.AreEqual(1, content.Length);
                Assert.AreEqual(versionDtos.Max(x =&gt; x.Id), content[0].AdditionalData[&quot;VersionId&quot;]);

                content = repository.GetAll(Constants.ObjectTypes.DocumentGuid, content[0].Id).ToArray();
                Assert.AreEqual(1, content.Length);
                Assert.AreEqual(versionDtos.Max(x =&gt; x.Id), content[0].AdditionalData[&quot;VersionId&quot;]);

                var contentItem = repository.Get(content[0].Id, Constants.ObjectTypes.DocumentGuid);
                Assert.AreEqual(versionDtos.Max(x =&gt; x.Id), contentItem.AdditionalData[&quot;VersionId&quot;]);

                contentItem = repository.GetByKey(content[0].Key, Constants.ObjectTypes.DocumentGuid);
                Assert.AreEqual(versionDtos.Max(x =&gt; x.Id), contentItem.AdditionalData[&quot;VersionId&quot;]);
            }
        }

        /// &lt;summary&gt;
        /// The Slim model will test the EntityRepository when it doesn&#39;t know the object type so it will 
        /// make the simplest (slim) query
        /// &lt;/summary&gt;
        [Test]
        public void Deal_With_Corrupt_Duplicate_Newest_Published_Flags_Slim_Model()
        {
            // Arrange
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            ContentTypeRepository contentTypeRepository;
            IContent content1;

            using (var repository = CreateContentRepository(unitOfWork, out contentTypeRepository))
            {
                var hasPropertiesContentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage1&quot;, &quot;Textpage&quot;);
                content1 = MockedContent.CreateSimpleContent(hasPropertiesContentType);

                contentTypeRepository.AddOrUpdate(hasPropertiesContentType);
                repository.AddOrUpdate(content1);
                unitOfWork.Commit();
            }

            //Now manually corrupt the data
            var versions = new[] { Guid.NewGuid(), Guid.NewGuid() };
            for (var index = 0; index &lt; versions.Length; index++)
            {
                var version = versions[index];
                var versionDate = DateTime.Now.AddMinutes(index);
                var versionDto = new ContentVersionDto
                {
                    NodeId = content1.Id,
                    VersionDate = versionDate,
                    VersionId = version
                };
                this.DatabaseContext.Database.Insert(versionDto);
                this.DatabaseContext.Database.Insert(new DocumentDto
                {
                    Newest = true,
                    NodeId = content1.Id,
                    Published = true,
                    Text = content1.Name,
                    VersionId = version,
                    WriterUserId = 0,
                    UpdateDate = versionDate,
                    TemplateId = content1.Template == null || content1.Template.Id &lt;= 0 ? null : (int?)content1.Template.Id
                });
            }

            // Assert
            using (var repository = new EntityRepository(unitOfWork))
            {
                var content = repository.GetByQuery(new Query&lt;IUmbracoEntity&gt;().Where(c =&gt; c.Id == content1.Id)).ToArray();
                Assert.AreEqual(1, content.Length);
                var contentItem = repository.Get(content[0].Id);
                Assert.IsNotNull(contentItem);
                contentItem = repository.GetByKey(content[0].Key);
                Assert.IsNotNull(contentItem);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,1],[27,13,27,31,1],[28,9,28,10,1],[32,9,32,10,1],[33,13,33,29,1],[34,9,34,10,1],[37,9,37,10,1],[39,13,39,91,1],[40,9,40,10,1],[43,9,43,10,1],[44,13,44,179,1],[45,13,45,95,1],[46,13,46,127,1],[47,13,47,182,1],[48,13,48,31,1],[49,9,49,10,1],[53,9,53,10,1],[55,13,55,67,1],[56,13,56,55,1],[60,20,60,99,1],[61,13,61,14,1],[62,17,62,119,1],[63,17,63,88,1],[65,17,65,77,1],[66,17,66,50,1],[67,17,67,37,1],[68,13,68,14,1],[70,13,70,61,1],[73,13,73,67,1],[74,18,74,31,1],[74,33,74,56,1],[74,58,74,65,1],[75,13,75,14,1],[76,17,76,47,1],[77,17,77,66,1],[78,17,83,19,1],[84,17,84,66,1],[85,17,85,45,1],[86,17,96,20,1],[97,13,97,14,1],[100,20,100,69,1],[101,13,101,14,1],[102,17,102,160,1],[103,17,103,52,1],[104,17,104,54,1],[104,54,104,58,1],[104,58,104,101,1],[104,17,104,101,1],[106,17,106,107,1],[107,17,107,52,1],[108,17,108,54,1],[108,54,108,58,1],[108,58,108,101,1],[108,17,108,101,1],[110,17,110,106,1],[111,17,111,52,1],[112,17,112,54,1],[112,54,112,58,1],[112,58,112,101,1],[112,17,112,101,1],[114,17,114,101,1],[115,17,115,54,1],[115,54,115,58,1],[115,58,115,102,1],[115,17,115,102,1],[117,17,117,103,1],[118,17,118,54,1],[118,54,118,58,1],[118,58,118,102,1],[118,17,118,102,1],[119,13,119,14,1],[120,9,120,10,1],[128,9,128,10,1],[130,13,130,67,1],[131,13,131,55,1],[135,20,135,99,1],[136,13,136,14,1],[137,17,137,119,1],[138,17,138,88,1],[140,17,140,77,1],[141,17,141,50,1],[142,17,142,37,1],[143,13,143,14,1],[146,13,146,69,1],[147,18,147,31,1],[147,33,147,56,1],[147,58,147,65,1],[148,13,148,14,1],[149,17,149,47,1],[150,17,150,66,1],[151,17,156,19,1],[157,17,157,66,1],[158,17,168,20,1],[169,13,169,14,1],[172,20,172,69,1],[173,13,173,14,1],[174,17,174,124,1],[175,17,175,52,1],[176,17,176,65,1],[177,17,177,47,1],[178,17,178,67,1],[179,17,179,47,1],[180,13,180,14,1],[181,9,181,10,1]]);
    </script>
  </body>
</html>