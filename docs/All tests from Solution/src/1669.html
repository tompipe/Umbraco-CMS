<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\FaultHandling\Strategies\SqlAzureTransientErrorDetectionStrategy.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Data;
using System.Data.SqlClient;

namespace Umbraco.Core.Persistence.FaultHandling.Strategies
{
    /// &lt;summary&gt;
    /// Provides the transient error detection logic for transient faults that are specific to SQL Azure.
    /// &lt;/summary&gt;
    public class SqlAzureTransientErrorDetectionStrategy : ITransientErrorDetectionStrategy
    {
        #region ProcessNetLibErrorCode enumeration

        /// &lt;summary&gt;
        /// Error codes reported by the DBNETLIB module.
        /// &lt;/summary&gt;
        private enum ProcessNetLibErrorCode
        {
            ZeroBytes = -3,

            Timeout = -2, /* Timeout expired. The timeout period elapsed prior to completion of the operation or the server is not responding. */

            Unknown = -1,

            InsufficientMemory = 1,

            AccessDenied = 2,

            ConnectionBusy = 3,

            ConnectionBroken = 4,

            ConnectionLimit = 5,

            ServerNotFound = 6,

            NetworkNotFound = 7,

            InsufficientResources = 8,

            NetworkBusy = 9,

            NetworkAccessDenied = 10,

            GeneralError = 11,

            IncorrectMode = 12,

            NameNotFound = 13,

            InvalidConnection = 14,

            ReadWriteError = 15,

            TooManyHandles = 16,

            ServerError = 17,

            SSLError = 18,

            EncryptionError = 19,

            EncryptionNotSupported = 20
        }

        #endregion

        #region ITransientErrorDetectionStrategy implementation

        /// &lt;summary&gt;
        /// Determines whether the specified exception represents a transient failure that can be compensated by a retry.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ex&quot;&gt;The exception object to be verified.&lt;/param&gt;
        /// &lt;returns&gt;True if the specified exception is considered as transient, otherwise false.&lt;/returns&gt;
        public bool IsTransient(Exception ex)
        {
            if (ex != null)
            {
                SqlException sqlException;
                if ((sqlException = ex as SqlException) != null)
                {
                    // Enumerate through all errors found in the exception.
                    foreach (SqlError err in sqlException.Errors)
                    {
                        switch (err.Number)
                        {
                            // SQL Error Code: 40501
                            // The service is currently busy. Retry the request after 10 seconds. Code: (reason code to be decoded).
                            case ThrottlingCondition.ThrottlingErrorNumber:
                                // Decode the reason code from the error message to determine the grounds for throttling.
                                var condition = ThrottlingCondition.FromError(err);

                                // Attach the decoded values as additional attributes to the original SQL exception.
                                sqlException.Data[condition.ThrottlingMode.GetType().Name] =
                                    condition.ThrottlingMode.ToString();
                                sqlException.Data[condition.GetType().Name] = condition;

                                return true;

                            // SQL Error Code: 40197
                            // The service has encountered an error processing your request. Please try again.
                            case 40197:
                            // SQL Error Code: 10053
                            // A transport-level error has occurred when receiving results from the server.
                            // An established connection was aborted by the software in your host machine.
                            case 10053:
                            // SQL Error Code: 10054
                            // A transport-level error has occurred when sending the request to the server. 
                            // (provider: TCP Provider, error: 0 - An existing connection was forcibly closed by the remote host.)
                            case 10054:
                            // SQL Error Code: 10060
                            // A network-related or instance-specific error occurred while establishing a connection to SQL Server. 
                            // The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server 
                            // is configured to allow remote connections. (provider: TCP Provider, error: 0 - A connection attempt failed 
                            // because the connected party did not properly respond after a period of time, or established connection failed 
                            // because connected host has failed to respond.)&quot;}
                            case 10060:
                            // SQL Error Code: 40613
                            // Database XXXX on server YYYY is not currently available. Please retry the connection later. If the problem persists, contact customer 
                            // support, and provide them the session tracing ID of ZZZZZ.
                            case 40613:
                            // SQL Error Code: 40143
                            // The service has encountered an error processing your request. Please try again.
                            case 40143:
                            // SQL Error Code: 233
                            // The client was unable to establish a connection because of an error during connection initialization process before login. 
                            // Possible causes include the following: the client tried to connect to an unsupported version of SQL Server; the server was too busy 
                            // to accept new connections; or there was a resource limitation (insufficient memory or maximum allowed connections) on the server. 
                            // (provider: TCP Provider, error: 0 - An existing connection was forcibly closed by the remote host.)
                            case 233:
                            // SQL Error Code: 64
                            // A connection was successfully established with the server, but then an error occurred during the login process. 
                            // (provider: TCP Provider, error: 0 - The specified network name is no longer available.) 
                            case 64:
                            // DBNETLIB Error Code: 20
                            // The instance of SQL Server you attempted to connect to does not support encryption.
                            case (int)ProcessNetLibErrorCode.EncryptionNotSupported:
                                return true;
                        }
                    }
                }
                else if (ex is TimeoutException)
                {
                    return true;
                }
                else
                {
                    EntityException entityException;
                    if ((entityException = ex as EntityException) != null)
                    {
                        return this.IsTransient(entityException.InnerException);
                    }
                }
            }

            return false;
        }

        #endregion
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[76,9,76,10,0],[77,13,77,28,0],[78,13,78,14,0],[80,17,80,65,0],[81,17,81,18,0],[83,21,83,28,0],[83,30,83,42,0],[83,43,83,45,0],[83,46,83,65,0],[84,21,84,22,0],[85,25,85,44,0],[91,33,91,84,0],[94,33,95,73,0],[96,33,96,89,0],[98,33,98,45,0],[138,33,138,45,0],[140,21,140,22,0],[141,17,141,18,0],[142,22,142,49,0],[143,17,143,18,0],[144,21,144,33,0],[147,17,147,18,0],[149,21,149,75,0],[150,21,150,22,0],[151,25,151,81,0],[153,17,153,18,0],[154,13,154,14,0],[156,13,156,26,0],[157,9,157,10,0]]);
    </script>
  </body>
</html>