<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Services\MemberTypeService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using Umbraco.Core.Events;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Services
{
    public class MemberTypeService : ContentTypeServiceBase, IMemberTypeService
    {
        private readonly IMemberService _memberService;

        private static readonly ReaderWriterLockSlim Locker = new ReaderWriterLockSlim();
        

        public MemberTypeService(IDatabaseUnitOfWorkProvider provider, RepositoryFactory repositoryFactory, ILogger logger, IEventMessagesFactory eventMessagesFactory, IMemberService memberService)
            : base(provider, repositoryFactory, logger, eventMessagesFactory)
        {
            if (memberService == null) throw new ArgumentNullException(&quot;memberService&quot;);
            _memberService = memberService;
        }

        public IEnumerable&lt;IMemberType&gt; GetAll(params int[] ids)
        {
            using (var repository = RepositoryFactory.CreateMemberTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.GetAll(ids);
            }
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IMemberType&quot;/&gt; object by its Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;Id of the &lt;see cref=&quot;IMemberType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IMemberType&quot;/&gt;&lt;/returns&gt;
        public IMemberType Get(int id)
        {
            using (var repository = RepositoryFactory.CreateMemberTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(id);
            }
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IMemberType&quot;/&gt; object by its Key
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Key of the &lt;see cref=&quot;IMemberType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IMemberType&quot;/&gt;&lt;/returns&gt;
        public IMemberType Get(Guid key)
        {
            using (var repository = RepositoryFactory.CreateMemberTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(key);
            }
        }

        /// &lt;summary&gt;
        /// Gets an &lt;see cref=&quot;IMemberType&quot;/&gt; object by its Alias
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;alias&quot;&gt;Alias of the &lt;see cref=&quot;IMemberType&quot;/&gt; to retrieve&lt;/param&gt;
        /// &lt;returns&gt;&lt;see cref=&quot;IMemberType&quot;/&gt;&lt;/returns&gt;
        public IMemberType Get(string alias)
        {
            using (var repository = RepositoryFactory.CreateMemberTypeRepository(UowProvider.GetUnitOfWork()))
            {
                return repository.Get(alias);
            }
        }

        public void Save(IMemberType memberType, int userId = 0)
        {
            if (Saving.IsRaisedEventCancelled(new SaveEventArgs&lt;IMemberType&gt;(memberType), this))
                return;

            if (string.IsNullOrWhiteSpace(memberType.Name))
            {
                throw new ArgumentException(&quot;Cannot save MemberType with empty name.&quot;);
            }

            using (new WriteLock(Locker))
            {
                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateMemberTypeRepository(uow))
                {
                    memberType.CreatorId = userId;
                    if (memberType.Description == string.Empty)
                        memberType.Description = null;
                    repository.AddOrUpdate(memberType);

                    uow.Commit();
                }

                UpdateContentXmlStructure(memberType);
            }
            Saved.RaiseEvent(new SaveEventArgs&lt;IMemberType&gt;(memberType, false), this);
        }

        public void Save(IEnumerable&lt;IMemberType&gt; memberTypes, int userId = 0)
        {
            var asArray = memberTypes.ToArray();

            if (Saving.IsRaisedEventCancelled(new SaveEventArgs&lt;IMemberType&gt;(asArray), this))
                return;

            using (new WriteLock(Locker))
            {
                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateMemberTypeRepository(uow))
                {
                    foreach (var memberType in asArray)
                    {
                        memberType.CreatorId = userId;
                        if (memberType.Description == string.Empty)
                            memberType.Description = null;
                        repository.AddOrUpdate(memberType);
                    }

                    //save it all in one go
                    uow.Commit();
                }

                UpdateContentXmlStructure(asArray.Cast&lt;IContentTypeBase&gt;().ToArray());
            }
            Saved.RaiseEvent(new SaveEventArgs&lt;IMemberType&gt;(asArray, false), this);
        }

        public void Delete(IMemberType memberType, int userId = 0)
        {
            if (Deleting.IsRaisedEventCancelled(new DeleteEventArgs&lt;IMemberType&gt;(memberType), this))
                return;

            using (new WriteLock(Locker))
            {
                _memberService.DeleteMembersOfType(memberType.Id);

                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateMemberTypeRepository(uow))
                {
                    repository.Delete(memberType);
                    uow.Commit();

                    Deleted.RaiseEvent(new DeleteEventArgs&lt;IMemberType&gt;(memberType, false), this);
                }
            }
        }

        public void Delete(IEnumerable&lt;IMemberType&gt; memberTypes, int userId = 0)
        {
            var asArray = memberTypes.ToArray();

            if (Deleting.IsRaisedEventCancelled(new DeleteEventArgs&lt;IMemberType&gt;(asArray), this))
                return;

            using (new WriteLock(Locker))
            {
                foreach (var contentType in asArray)
                {
                    _memberService.DeleteMembersOfType(contentType.Id);
                }

                var uow = UowProvider.GetUnitOfWork();
                using (var repository = RepositoryFactory.CreateMemberTypeRepository(uow))
                {
                    foreach (var memberType in asArray)
                    {
                        repository.Delete(memberType);
                    }

                    uow.Commit();

                    Deleted.RaiseEvent(new DeleteEventArgs&lt;IMemberType&gt;(asArray, false), this);
                }                
            }
        }

        /// &lt;summary&gt;
        /// This is called after an IContentType is saved and is used to update the content xml structures in the database
        /// if they are required to be updated.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;contentTypes&quot;&gt;A tuple of a content type and a boolean indicating if it is new (HasIdentity was false before committing)&lt;/param&gt;
        private void UpdateContentXmlStructure(params IContentTypeBase[] contentTypes)
        {

            var toUpdate = GetContentTypesForXmlUpdates(contentTypes).ToArray();

            if (toUpdate.Any())
            {
                //if it is a media type then call the rebuilding methods for media
                var typedMemberService = _memberService as MemberService;
                if (typedMemberService != null)
                {
                    typedMemberService.RebuildXmlStructures(toUpdate.Select(x =&gt; x.Id).ToArray());
                }
            }

        }

        /// &lt;summary&gt;
        /// Occurs before Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IMemberTypeService, SaveEventArgs&lt;IMemberType&gt;&gt; Saving;

        /// &lt;summary&gt;
        /// Occurs after Save
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IMemberTypeService, SaveEventArgs&lt;IMemberType&gt;&gt; Saved;

        /// &lt;summary&gt;
        /// Occurs before Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IMemberTypeService, DeleteEventArgs&lt;IMemberType&gt;&gt; Deleting;

        /// &lt;summary&gt;
        /// Occurs after Delete
        /// &lt;/summary&gt;
        public static event TypedEventHandler&lt;IMemberTypeService, DeleteEventArgs&lt;IMemberType&gt;&gt; Deleted;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,90,1],[21,15,21,78,1],[22,9,22,10,1],[23,13,23,39,1],[23,40,23,89,0],[24,13,24,44,1],[25,9,25,10,1],[28,9,28,10,0],[29,20,29,110,0],[30,13,30,14,0],[31,17,31,47,0],[33,9,33,10,0],[41,9,41,10,1],[42,20,42,110,1],[43,13,43,14,1],[44,17,44,43,1],[46,9,46,10,1],[54,9,54,10,0],[55,20,55,110,0],[56,13,56,14,0],[57,17,57,44,0],[59,9,59,10,0],[67,9,67,10,0],[68,20,68,110,0],[69,13,69,14,0],[70,17,70,46,0],[72,9,72,10,0],[75,9,75,10,1],[76,13,76,97,1],[77,17,77,24,0],[79,13,79,60,1],[80,13,80,14,1],[81,17,81,88,1],[84,13,84,42,1],[85,13,85,14,1],[86,17,86,55,1],[87,24,87,90,1],[88,17,88,18,1],[89,21,89,51,1],[90,21,90,64,1],[91,25,91,55,1],[92,21,92,56,1],[94,21,94,34,1],[95,17,95,18,1],[97,17,97,55,1],[98,13,98,14,1],[99,13,99,87,1],[100,9,100,10,1],[103,9,103,10,0],[104,13,104,49,0],[106,13,106,94,0],[107,17,107,24,0],[109,13,109,42,0],[110,13,110,14,0],[111,17,111,55,0],[112,24,112,90,0],[113,17,113,18,0],[114,21,114,28,0],[114,30,114,44,0],[114,45,114,47,0],[114,48,114,55,0],[115,21,115,22,0],[116,25,116,55,0],[117,25,117,68,0],[118,29,118,59,0],[119,25,119,60,0],[120,21,120,22,0],[123,21,123,34,0],[124,17,124,18,0],[126,17,126,87,0],[127,13,127,14,0],[128,13,128,84,0],[129,9,129,10,0],[132,9,132,10,0],[133,13,133,101,0],[134,17,134,24,0],[136,13,136,42,0],[137,13,137,14,0],[138,17,138,67,0],[140,17,140,55,0],[141,24,141,90,0],[142,17,142,18,0],[143,21,143,51,0],[144,21,144,34,0],[146,21,146,99,0],[147,17,147,18,0],[148,13,148,14,0],[149,9,149,10,0],[152,9,152,10,0],[153,13,153,49,0],[155,13,155,98,0],[156,17,156,24,0],[158,13,158,42,0],[159,13,159,14,0],[160,17,160,24,0],[160,26,160,41,0],[160,42,160,44,0],[160,45,160,52,0],[161,17,161,18,0],[162,21,162,72,0],[163,17,163,18,0],[165,17,165,55,0],[166,24,166,90,0],[167,17,167,18,0],[168,21,168,28,0],[168,30,168,44,0],[168,45,168,47,0],[168,48,168,55,0],[169,21,169,22,0],[170,25,170,55,0],[171,21,171,22,0],[173,21,173,34,0],[175,21,175,96,0],[176,17,176,18,0],[177,13,177,14,0],[178,9,178,10,0],[186,9,186,10,1],[188,13,188,81,1],[190,13,190,32,1],[191,13,191,14,1],[193,17,193,74,1],[194,17,194,48,1],[195,17,195,18,1],[196,21,196,82,1],[196,82,196,86,1],[196,86,196,99,1],[196,21,196,99,1],[197,17,197,18,1],[198,13,198,14,1],[200,9,200,10,1]]);
    </script>
  </body>
</html>