<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\SQLCE4Umbraco\SqlCeContextGuardian.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Data.SqlServerCe;
using System.Linq;
using System.Text;

namespace SQLCE4Umbraco
{
    public static class SqlCeContextGuardian
    {
        private static SqlCeConnection _constantOpenConnection;
        private static readonly object Lock = new object();

        // Awesome SQL CE 4 speed improvement by Erik Ejskov Jensen - SQL CE 4 MVP
        // It&#39;s not an issue with SQL CE 4 that we never close the connection
        public static SqlCeConnection Open(string connectionString)
        {
            var connectionStringBuilder = new DbConnectionStringBuilder();
            try
            {
                connectionStringBuilder.ConnectionString = connectionString;
            }
            catch (Exception ex)
            {
                throw new ArgumentException(&quot;Bad connection string.&quot;, &quot;connectionString&quot;, ex);
            }
            connectionStringBuilder.Remove(&quot;datalayer&quot;);

            // SQL CE 4 performs better when there&#39;s always a connection open in the background
            EnsureOpenBackgroundConnection(connectionStringBuilder.ConnectionString);

            SqlCeConnection conn = new SqlCeConnection(connectionStringBuilder.ConnectionString);
            conn.Open();

            return conn;

        }

		/// &lt;summary&gt;
		/// Sometimes we need to ensure this is closed especially in unit tests
		/// &lt;/summary&gt;
		internal static void CloseBackgroundConnection()
		{
			if (_constantOpenConnection != null)
				_constantOpenConnection.Close();
		}

        private static void EnsureOpenBackgroundConnection(string connectionString)
        {
            lock (Lock)
            {
                if (_constantOpenConnection == null)
                {
                    _constantOpenConnection = new SqlCeConnection(connectionString);
                    _constantOpenConnection.Open();
                }
                else if (_constantOpenConnection.State != ConnectionState.Open)
                    _constantOpenConnection.Open();
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[14,9,14,60,1],[19,9,19,10,1],[20,13,20,75,1],[22,13,22,14,1],[23,17,23,77,1],[24,13,24,14,1],[25,13,25,33,0],[26,13,26,14,0],[27,17,27,95,0],[29,13,29,57,1],[32,13,32,86,1],[34,13,34,98,1],[35,13,35,25,1],[37,13,37,25,1],[39,9,39,10,1],[45,3,45,4,1],[46,4,46,40,1],[47,5,47,37,1],[48,3,48,4,1],[51,9,51,10,1],[52,13,52,24,1],[53,13,53,14,1],[54,17,54,53,1],[55,17,55,18,1],[56,21,56,85,1],[57,21,57,52,1],[58,17,58,18,1],[59,22,59,80,1],[60,21,60,52,1],[61,13,61,14,1],[62,9,62,10,1]]);
    </script>
  </body>
</html>