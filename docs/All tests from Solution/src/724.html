<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\ModelStateExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Web.Mvc;

namespace Umbraco.Web
{
	internal static class ModelStateExtensions
	{

		/// &lt;summary&gt;
		/// Merges ModelState that has names matching the prefix
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;state&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;dictionary&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;prefix&quot;&gt;&lt;/param&gt;
		public static void Merge(this ModelStateDictionary state, ModelStateDictionary dictionary, string prefix)
		{
			if (dictionary == null)
				return;
			foreach (var keyValuePair in dictionary
                //It can either equal the prefix exactly (model level errors) or start with the prefix. (property level errors)
                .Where(keyValuePair =&gt; keyValuePair.Key == prefix || keyValuePair.Key.StartsWith(prefix + &quot;.&quot;)))
			{
				state[keyValuePair.Key] = keyValuePair.Value;
			}
		}

		/// &lt;summary&gt;
		/// Checks if there are any model errors on any fields containing the prefix
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;state&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;prefix&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static bool IsValid(this ModelStateDictionary state, string prefix)
		{
			return state.Where(v =&gt; v.Key.StartsWith(prefix + &quot;.&quot;)).All(v =&gt; !v.Value.Errors.Any());
		}


		//NOTE: we used this alot in v5 when we had editors in MVC, this was really handy for knockout editors using JS

		///// &lt;summary&gt;
		///// Adds an error to the model state that has to do with data validation, this is generally used for JSON responses
		///// &lt;/summary&gt;
		///// &lt;param name=&quot;state&quot;&gt;&lt;/param&gt;
		///// &lt;param name=&quot;errorMessage&quot;&gt;&lt;/param&gt;
		//public static void AddDataValidationError(this ModelStateDictionary state, string errorMessage)
		//{
		//    state.AddModelError(&quot;DataValidation&quot;, errorMessage);
		//}

        /// &lt;summary&gt;
        /// Adds the error to model state correctly for a property so we can use it on the client side.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;modelState&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;result&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;propertyAlias&quot;&gt;&lt;/param&gt;
        internal static void AddPropertyError(this System.Web.Http.ModelBinding.ModelStateDictionary modelState, ValidationResult result, string propertyAlias)
        {
            //if there are no member names supplied then we assume that the validation message is for the overall property
            // not a sub field on the property editor
            if (!result.MemberNames.Any())
            {
                //add a model state error for the entire property
                modelState.AddModelError(string.Format(&quot;{0}.{1}&quot;, &quot;_Properties&quot;, propertyAlias), result.ErrorMessage);
            }
            else
            {
                //there&#39;s assigned field names so we&#39;ll combine the field name with the property name
                // so that we can try to match it up to a real sub field of this editor
                foreach (var field in result.MemberNames)
                {
                    modelState.AddModelError(string.Format(&quot;{0}.{1}.{2}&quot;, &quot;_Properties&quot;, propertyAlias, field), result.ErrorMessage);
                }
            }
        }

        public static IDictionary&lt;string, object&gt; ToErrorDictionary(this System.Web.Http.ModelBinding.ModelStateDictionary modelState)
        {
            var modelStateError = new Dictionary&lt;string, object&gt;();
            foreach (var keyModelStatePair in modelState)
            {
                var key = keyModelStatePair.Key;
                var errors = keyModelStatePair.Value.Errors;
                if (errors != null &amp;&amp; errors.Count &gt; 0)
                {
                    modelStateError.Add(key, errors.Select(error =&gt; error.ErrorMessage));
                }
            }
            return modelStateError;
        }

		/// &lt;summary&gt;
		/// Serializes the ModelState to JSON for JavaScript to interrogate the errors
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;state&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public static JsonResult ToJsonErrors(this ModelStateDictionary state)
		{
			return new JsonResult
				{
					Data = new
						{
							success = state.IsValid.ToString().ToLower(),
							failureType = &quot;ValidationError&quot;,
							validationErrors = from e in state
							                   where e.Value.Errors.Count &gt; 0
							                   select new
							                   	{
							                   		name = e.Key,
							                   		errors = e.Value.Errors.Select(x =&gt; x.ErrorMessage)
							                   	.Concat(
							                   		e.Value.Errors.Where(x =&gt; x.Exception != null).Select(x =&gt; x.Exception.Message))
							                   	}
						}
				};
		}

	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,3,19,4,0],[20,4,20,27,0],[21,5,21,12,0],[22,4,22,11,0],[22,13,22,29,0],[22,30,22,32,0],[22,33,24,40,0],[24,40,24,111,0],[24,111,24,112,0],[22,33,24,112,0],[25,4,25,5,0],[26,5,26,50,0],[27,4,27,5,0],[28,3,28,4,0],[37,3,37,4,0],[38,4,38,28,0],[38,28,38,58,0],[38,58,38,69,0],[38,69,38,90,0],[38,90,38,92,0],[38,4,38,92,0],[39,3,39,4,0],[61,9,61,10,0],[64,13,64,43,0],[65,13,65,14,0],[67,17,67,119,0],[68,13,68,14,0],[70,13,70,14,0],[73,17,73,24,0],[73,26,73,35,0],[73,36,73,38,0],[73,39,73,57,0],[74,17,74,18,0],[75,21,75,134,0],[76,17,76,18,0],[77,13,77,14,0],[78,9,78,10,0],[81,9,81,10,0],[82,13,82,68,0],[83,13,83,20,0],[83,22,83,43,0],[83,44,83,46,0],[83,47,83,57,0],[84,13,84,14,0],[85,17,85,49,0],[86,17,86,61,0],[87,17,87,56,0],[88,17,88,18,0],[89,21,89,69,0],[89,69,89,87,0],[89,87,89,90,0],[89,21,89,90,0],[90,17,90,18,0],[91,13,91,14,0],[92,13,92,36,0],[93,9,93,10,0],[101,3,101,4,0],[102,4,109,33,0],[109,33,109,57,0],[109,57,110,34,0],[110,34,113,65,0],[113,65,113,79,0],[113,79,115,55,0],[115,55,115,74,0],[115,74,115,88,0],[115,88,115,107,0],[115,107,116,29,0],[110,34,116,29,0],[116,29,118,7,0],[102,4,118,7,0],[119,3,119,4,0]]);
    </script>
  </body>
</html>