<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.MacroEngines\RazorDynamicNode\RazorLibraryCore.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using System.Web.Mvc;
using Umbraco.Web;
using umbraco.interfaces;
using System.Xml.Linq;
using System.Xml.XPath;
using System.Web;

namespace umbraco.MacroEngines.Library
{
	public class RazorLibraryCore
    {
        private readonly INode _node;
    	private readonly UmbracoHelper _umbracoHelper;
        private readonly HtmlStringUtilities _stringUtilities = new HtmlStringUtilities();
		
		/// &lt;summary&gt;
		/// An empty HtmlHelper with a blank ViewContext, used only to access some htmlHelper extension methods
		/// &lt;/summary&gt;
		private readonly HtmlHelper _htmlHelper;

        public INode Node
        {
            get { return _node; }
        }
        public RazorLibraryCore(INode node)
        {
            this._node = node;
			_umbracoHelper = new UmbracoHelper(UmbracoContext.Current);
			_htmlHelper = new HtmlHelper(new ViewContext(), new ViewPage());
        }

        public dynamic NodeById(int Id)
        {
            var node = new DynamicNode(Id);
            if (node.Id == 0) return new DynamicNull();
            return node;
        }
        public dynamic NodeById(string Id)
        {
            var node = new DynamicNode(Id);
            if (node.Id == 0) return new DynamicNull();
            return node;
        }
        public dynamic NodeById(DynamicNull Id)
        {
            return new DynamicNull();
        }
        public dynamic NodeById(object Id)
        {
            if (Id.GetType() == typeof(DynamicNull))
            {
                return new DynamicNull();
            }
            var node = new DynamicNode(Id);
            if (node.Id == 0) return new DynamicNull();
            return node;
        }
        public dynamic NodesById(List&lt;object&gt; Ids)
        {
            List&lt;DynamicNode&gt; nodes = new List&lt;DynamicNode&gt;();
            foreach (object eachId in Ids)
                nodes.Add(new DynamicNode(eachId));
            return new DynamicNodeList(nodes);
        }
        public dynamic NodesById(List&lt;int&gt; Ids)
        {
            List&lt;DynamicNode&gt; nodes = new List&lt;DynamicNode&gt;();
            foreach (int eachId in Ids)
                nodes.Add(new DynamicNode(eachId));
            return new DynamicNodeList(nodes);
        }
        public dynamic NodesById(List&lt;int&gt; Ids, DynamicBackingItemType ItemType)
        {
            List&lt;DynamicNode&gt; nodes = new List&lt;DynamicNode&gt;();
            foreach (int eachId in Ids)
                nodes.Add(new DynamicNode(eachId, ItemType));
            return new DynamicNodeList(nodes);
        }
        public dynamic NodesById(params object[] Ids)
        {
            return NodesById(Ids.ToList());
        }
        public dynamic MediaById(DynamicNull Id)
        {
            return new DynamicNull();
        }
        public dynamic MediaById(int Id)
        {
            var ebm = ExamineBackedMedia.GetUmbracoMedia(Id);
            if (ebm != null &amp;&amp; ebm.Id == 0)
            {
                return new DynamicNull();
            }
            return new DynamicMedia(new DynamicBackingItem(ebm));
        }
        public dynamic MediaById(string Id)
        {
            int mediaId = 0;
            if (int.TryParse(Id, out mediaId))
            {
                return MediaById(mediaId);
            }
            return new DynamicNull();
        }
        public dynamic MediaById(object Id)
        {
            if (Id.GetType() == typeof(DynamicNull))
            {
                return new DynamicNull();
            }
            int mediaId = 0;
            if (int.TryParse(string.Format(&quot;{0}&quot;, Id), out mediaId))
            {
                return MediaById(mediaId);
            }
            return null;
        }
        public dynamic MediaById(List&lt;object&gt; Ids)
        {
            List&lt;DynamicNode&gt; nodes = new List&lt;DynamicNode&gt;();
            foreach (object eachId in Ids)
                nodes.Add(MediaById(eachId));
            return new DynamicNodeList(nodes);
        }
        public dynamic MediaById(List&lt;int&gt; Ids)
        {
            List&lt;DynamicNode&gt; nodes = new List&lt;DynamicNode&gt;();
            foreach (int eachId in Ids)
                nodes.Add(MediaById(eachId));
            return new DynamicNodeList(nodes);
        }
        public dynamic MediaById(params object[] Ids)
        {
            return MediaById(Ids.ToList());
        }


        public dynamic Search(string term, bool useWildCards = true, string searchProvider = null)
        {
            var searcher = Examine.ExamineManager.Instance.DefaultSearchProvider;
            if (!string.IsNullOrEmpty(searchProvider))
                searcher = Examine.ExamineManager.Instance.SearchProviderCollection[searchProvider];

            var results = searcher.Search(term, useWildCards);
            return ExamineSearchUtill.ConvertSearchResultToDynamicNode(results);

            //TODO: Does NOT return legacy DynamicNodeList, old code is back in place

            ////wraps the functionality in UmbracoHelper but still returns the legacy DynamicNodeList
            //var nodes = ((DynamicPublishedContentList)_umbracoHelper.Search(term, useWildCards, searchProvider))
            //    .Select(x =&gt; x.ConvertToNode());
            //return new DynamicNodeList(nodes);
        }

        public dynamic Search(Examine.SearchCriteria.ISearchCriteria criteria, Examine.Providers.BaseSearchProvider searchProvider = null)
        {
            var s = Examine.ExamineManager.Instance.DefaultSearchProvider;
            if (searchProvider != null)
                s = searchProvider;

            var results = s.Search(criteria);
            return ExamineSearchUtill.ConvertSearchResultToDynamicNode(results);

            //TODO: Does NOT return legacy DynamicNodeList, old code is back in place

            ////wraps the functionality in UmbracoHelper but still returns the legacy DynamicNodeList
            //var nodes = ((DynamicPublishedContentList) _umbracoHelper.Search(criteria, searchProvider))
            //    .Select(x =&gt; x.ConvertToNode());
            //return new DynamicNodeList(nodes);
        }


        public T As&lt;T&gt;() where T : class
        {
            return (this as T);
        }

        public dynamic ToDynamicXml(string xml)
        {
        	return _umbracoHelper.ToDynamicXml(xml);
        }

        public dynamic ToDynamicXml(XElement xElement)
		{
			return _umbracoHelper.ToDynamicXml(xElement);
		}

        public dynamic ToDynamicXml(XPathNodeIterator xpni)
		{
			return _umbracoHelper.ToDynamicXml(xpni);
		}

        public string Coalesce(params object[] args)
        {
            return _stringUtilities.Coalesce&lt;DynamicNull&gt;(args);
        }

        public string Concatenate(params object[] args)
        {
            return _stringUtilities.Concatenate&lt;DynamicNull&gt;(args);
        }
        public string Join(string seperator, params object[] args)
        {
            return _stringUtilities.Join&lt;DynamicNull&gt;(seperator, args);
        }

        public HtmlString If(bool test, string valueIfTrue, string valueIfFalse)
        {
        	return _umbracoHelper.If(test, valueIfTrue, valueIfFalse);
        }
        public HtmlString If(bool test, string valueIfTrue)
        {
        	return _umbracoHelper.If(test, valueIfTrue);
        }

		public Umbraco.Web.Mvc.HtmlTagWrapper Wrap(string tag, string innerText, params Umbraco.Web.Mvc.IHtmlTagWrapper[] children)
		{
			return _htmlHelper.Wrap(tag, innerText, children);
        }
		public Umbraco.Web.Mvc.HtmlTagWrapper Wrap(string tag, object inner, object anonymousAttributes, params Umbraco.Web.Mvc.IHtmlTagWrapper[] children)
		{
			return _htmlHelper.Wrap(tag, inner, anonymousAttributes, children);
		}
		public Umbraco.Web.Mvc.HtmlTagWrapper Wrap(string tag, object inner)
		{
			return _htmlHelper.Wrap(tag, inner);
		}
		public Umbraco.Web.Mvc.HtmlTagWrapper Wrap(string tag, string innerText, object anonymousAttributes, params Umbraco.Web.Mvc.IHtmlTagWrapper[] children)
		{
			return _htmlHelper.Wrap(tag, innerText, anonymousAttributes, children);
		}
		public Umbraco.Web.Mvc.HtmlTagWrapper Wrap(bool visible, string tag, string innerText, object anonymousAttributes, params Umbraco.Web.Mvc.IHtmlTagWrapper[] children)
		{
			return _htmlHelper.Wrap(visible, tag, innerText, anonymousAttributes, children);
		}

        public IHtmlString Truncate(IHtmlString html, int length)
        {
            return Truncate(html.ToHtmlString(), length, true, false);
        }
        public IHtmlString Truncate(IHtmlString html, int length, bool addElipsis)
        {
            return Truncate(html.ToHtmlString(), length, addElipsis, false);
        }
        public IHtmlString Truncate(IHtmlString html, int length, bool addElipsis, bool treatTagsAsContent)
        {
            return Truncate(html.ToHtmlString(), length, addElipsis, treatTagsAsContent);
        }
        public IHtmlString Truncate(DynamicNull html, int length)
        {
            return new HtmlString(string.Empty);
        }
        public IHtmlString Truncate(DynamicNull html, int length, bool addElipsis)
        {
            return new HtmlString(string.Empty);
        }
        public IHtmlString Truncate(DynamicNull html, int length, bool addElipsis, bool treatTagsAsContent)
        {
            return new HtmlString(string.Empty);
        }
        public IHtmlString Truncate(string html, int length)
        {
            return Truncate(html, length, true, false);
        }
        public IHtmlString Truncate(string html, int length, bool addElipsis)
        {
            return Truncate(html, length, addElipsis, false);
        }
        public IHtmlString Truncate(string html, int length, bool addElipsis, bool treatTagsAsContent)
        {
        	return _umbracoHelper.Truncate(html, length, addElipsis, treatTagsAsContent);
        }


        public HtmlString StripHtml(IHtmlString html)
        {
			return _umbracoHelper.StripHtml(html);
        }
        public HtmlString StripHtml(DynamicNull html)
        {
            return new HtmlString(string.Empty);
        }
        public HtmlString StripHtml(string html)
        {
        	return _umbracoHelper.StripHtml(html);
        }

        public HtmlString StripHtml(IHtmlString html, List&lt;string&gt; tags)
        {
        	return _umbracoHelper.StripHtml(html, tags.ToArray());
        }
        public HtmlString StripHtml(DynamicNull html, List&lt;string&gt; tags)
        {
            return new HtmlString(string.Empty);
        }
        public HtmlString StripHtml(string html, List&lt;string&gt; tags)
        {
        	return _umbracoHelper.StripHtml(html, tags.ToArray());
        }

        public HtmlString StripHtml(IHtmlString html, params string[] tags)
        {
        	return _umbracoHelper.StripHtml(html, tags);
        }
        public HtmlString StripHtml(DynamicNull html, params string[] tags)
        {
            return new HtmlString(string.Empty);
        }
        public HtmlString StripHtml(string html, params string[] tags)
        {
        	return _umbracoHelper.StripHtml(html, tags);
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,91,0],[25,17,25,18,0],[25,19,25,32,0],[25,33,25,34,0],[27,9,27,44,0],[28,9,28,10,0],[29,13,29,31,0],[30,4,30,63,0],[31,4,31,68,0],[32,9,32,10,0],[35,9,35,10,0],[36,13,36,44,0],[37,13,37,30,0],[37,31,37,56,0],[38,13,38,25,0],[39,9,39,10,0],[41,9,41,10,0],[42,13,42,44,0],[43,13,43,30,0],[43,31,43,56,0],[44,13,44,25,0],[45,9,45,10,0],[47,9,47,10,0],[48,13,48,38,0],[49,9,49,10,0],[51,9,51,10,0],[52,13,52,53,0],[53,13,53,14,0],[54,17,54,42,0],[56,13,56,44,0],[57,13,57,30,0],[57,31,57,56,0],[58,13,58,25,0],[59,9,59,10,0],[61,9,61,10,0],[62,13,62,63,0],[63,13,63,20,0],[63,22,63,35,0],[63,36,63,38,0],[63,39,63,42,0],[64,17,64,52,0],[65,13,65,47,0],[66,9,66,10,0],[68,9,68,10,0],[69,13,69,63,0],[70,13,70,20,0],[70,22,70,32,0],[70,33,70,35,0],[70,36,70,39,0],[71,17,71,52,0],[72,13,72,47,0],[73,9,73,10,0],[75,9,75,10,0],[76,13,76,63,0],[77,13,77,20,0],[77,22,77,32,0],[77,33,77,35,0],[77,36,77,39,0],[78,17,78,62,0],[79,13,79,47,0],[80,9,80,10,0],[82,9,82,10,0],[83,13,83,44,0],[84,9,84,10,0],[86,9,86,10,0],[87,13,87,38,0],[88,9,88,10,0],[90,9,90,10,0],[91,13,91,62,0],[92,13,92,44,0],[93,13,93,14,0],[94,17,94,42,0],[96,13,96,66,0],[97,9,97,10,0],[99,9,99,10,0],[100,13,100,29,0],[101,13,101,47,0],[102,13,102,14,0],[103,17,103,43,0],[105,13,105,38,0],[106,9,106,10,0],[108,9,108,10,0],[109,13,109,53,0],[110,13,110,14,0],[111,17,111,42,0],[113,13,113,29,0],[114,13,114,69,0],[115,13,115,14,0],[116,17,116,43,0],[118,13,118,25,0],[119,9,119,10,0],[121,9,121,10,0],[122,13,122,63,0],[123,13,123,20,0],[123,22,123,35,0],[123,36,123,38,0],[123,39,123,42,0],[124,17,124,46,0],[125,13,125,47,0],[126,9,126,10,0],[128,9,128,10,0],[129,13,129,63,0],[130,13,130,20,0],[130,22,130,32,0],[130,33,130,35,0],[130,36,130,39,0],[131,17,131,46,0],[132,13,132,47,0],[133,9,133,10,0],[135,9,135,10,0],[136,13,136,44,0],[137,9,137,10,0],[141,9,141,10,0],[142,13,142,82,0],[143,13,143,55,0],[144,17,144,101,0],[146,13,146,63,0],[147,13,147,81,0],[155,9,155,10,0],[158,9,158,10,0],[159,13,159,75,0],[160,13,160,40,0],[161,17,161,36,0],[163,13,163,46,0],[164,13,164,81,0],[172,9,172,10,0],[176,9,176,10,0],[177,13,177,32,0],[178,9,178,10,0],[181,9,181,10,0],[182,10,182,50,0],[183,9,183,10,0],[186,3,186,4,0],[187,4,187,49,0],[188,3,188,4,0],[191,3,191,4,0],[192,4,192,45,0],[193,3,193,4,0],[196,9,196,10,0],[197,13,197,65,0],[198,9,198,10,0],[201,9,201,10,0],[202,13,202,68,0],[203,9,203,10,0],[205,9,205,10,0],[206,13,206,72,0],[207,9,207,10,0],[210,9,210,10,0],[211,10,211,68,0],[212,9,212,10,0],[214,9,214,10,0],[215,10,215,54,0],[216,9,216,10,0],[219,3,219,4,0],[220,4,220,54,0],[221,9,221,10,0],[223,3,223,4,0],[224,4,224,71,0],[225,3,225,4,0],[227,3,227,4,0],[228,4,228,40,0],[229,3,229,4,0],[231,3,231,4,0],[232,4,232,75,0],[233,3,233,4,0],[235,3,235,4,0],[236,4,236,84,0],[237,3,237,4,0],[240,9,240,10,0],[241,13,241,71,0],[242,9,242,10,0],[244,9,244,10,0],[245,13,245,77,0],[246,9,246,10,0],[248,9,248,10,0],[249,13,249,90,0],[250,9,250,10,0],[252,9,252,10,0],[253,13,253,49,0],[254,9,254,10,0],[256,9,256,10,0],[257,13,257,49,0],[258,9,258,10,0],[260,9,260,10,0],[261,13,261,49,0],[262,9,262,10,0],[264,9,264,10,0],[265,13,265,56,0],[266,9,266,10,0],[268,9,268,10,0],[269,13,269,62,0],[270,9,270,10,0],[272,9,272,10,0],[273,10,273,87,0],[274,9,274,10,0],[278,9,278,10,0],[279,4,279,42,0],[280,9,280,10,0],[282,9,282,10,0],[283,13,283,49,0],[284,9,284,10,0],[286,9,286,10,0],[287,10,287,48,0],[288,9,288,10,0],[291,9,291,10,0],[292,10,292,64,0],[293,9,293,10,0],[295,9,295,10,0],[296,13,296,49,0],[297,9,297,10,0],[299,9,299,10,0],[300,10,300,64,0],[301,9,301,10,0],[304,9,304,10,0],[305,10,305,54,0],[306,9,306,10,0],[308,9,308,10,0],[309,13,309,49,0],[310,9,310,10,0],[312,9,312,10,0],[313,10,313,54,0],[314,9,314,10,0]]);
    </script>
  </body>
</html>