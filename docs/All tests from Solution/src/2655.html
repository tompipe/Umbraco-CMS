<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\tinymce\tinyMCEImageHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Linq;
using System.Text.RegularExpressions;
using System.Web;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using umbraco.cms.businesslogic.Files;

namespace umbraco.editorControls.tinymce
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    internal class tinyMCEImageHelper
    {
        public static string cleanImages(string html)
        {
            var allowedAttributes = UmbracoConfig.For.UmbracoSettings().Content.ImageTagAllowedAttributes.Select(x =&gt; x.ToLower()).ToList();
            
            //Always add src as it&#39;s essential to output any image at all
            if (allowedAttributes.Contains(&quot;src&quot;) == false)
                allowedAttributes.Add(&quot;src&quot;);
            
            const string pattern = @&quot;&lt;img [^&gt;]*&gt;&quot;;
            var tags = Regex.Matches(html + &quot; &quot;, pattern, RegexOptions.IgnoreCase | RegexOptions.IgnorePatternWhitespace);
            foreach (Match tag in tags)
            {
                if (tag.Value.ToLower().IndexOf(&quot;umbraco_macro&quot;, StringComparison.Ordinal) == -1)
                {
                    var cleanTag = &quot;&lt;img&quot;;
                    // gather all attributes
                    // TODO: This should be replaced with a general helper method - but for now we&#39;ll wanna leave umbraco.dll alone for this patch
                    var ht = new Hashtable();
                    var matches = Regex.Matches(tag.Value.Replace(&quot;&gt;&quot;, &quot; &gt;&quot;), &quot;(?&lt;attributeName&gt;\\S*?)=\&quot;(?&lt;attributeValue&gt;[^\&quot;]*)\&quot;|(?&lt;attributeName&gt;\\S*?)=(?&lt;attributeValue&gt;[^\&quot;|\\s]*)\\s&quot;, RegexOptions.IgnoreCase | RegexOptions.IgnorePatternWhitespace);
                    foreach (Match attributeSet in matches)
                    {
                        ht.Add(attributeSet.Groups[&quot;attributeName&quot;].Value.ToLower(),
                               attributeSet.Groups[&quot;attributeValue&quot;].Value);
                    }

                    // If rel attribute exists and if it&#39;s different from current sizing we should resize the image!
                    if (helper.FindAttribute(ht, &quot;rel&quot;) != &quot;&quot;)
                    {
                        // if size has changed resize image serverside
                        var newDims = helper.FindAttribute(ht, &quot;rel&quot;).Split(&quot;,&quot;.ToCharArray());
                        if (newDims.Length &gt; 0 &amp;&amp; (newDims[0] != helper.FindAttribute(ht, &quot;width&quot;) || newDims[1] != helper.FindAttribute(ht, &quot;height&quot;)))
                        {
                            try
                            {
                                int newWidth;
                                int newHeight;
                                string newSrc;

                                cleanTag += DoResize(ht, out newWidth, out newHeight, out newSrc);

                                ht[&quot;src&quot;] = newSrc;
                            }
                            catch (Exception err)
                            {
                                cleanTag += &quot; src=\&quot;&quot; + helper.FindAttribute(ht, &quot;src&quot;) + &quot;\&quot;&quot;;
                                if (helper.FindAttribute(ht, &quot;width&quot;) != &quot;&quot;)
                                {
                                    cleanTag += &quot; width=\&quot;&quot; + helper.FindAttribute(ht, &quot;width&quot;) + &quot;\&quot;&quot;;
                                    cleanTag += &quot; height=\&quot;&quot; + helper.FindAttribute(ht, &quot;height&quot;) + &quot;\&quot;&quot;;
                                }
								LogHelper.Error&lt;tinyMCEImageHelper&gt;(&quot;Error resizing image in editor&quot;, err);
                            }
                        }
                        else
                        {
                            if (helper.FindAttribute(ht, &quot;width&quot;) != &quot;&quot;)
                            {
                                cleanTag += &quot; width=\&quot;&quot; + helper.FindAttribute(ht, &quot;width&quot;) + &quot;\&quot;&quot;;
                                cleanTag += &quot; height=\&quot;&quot; + helper.FindAttribute(ht, &quot;height&quot;) + &quot;\&quot;&quot;;
                            }

                        }
                    }
                    else
                    {
                        if (helper.FindAttribute(ht, &quot;width&quot;) != &quot;&quot;)
                        {
                            cleanTag += &quot; width=\&quot;&quot; + helper.FindAttribute(ht, &quot;width&quot;) + &quot;\&quot;&quot;;
                            cleanTag += &quot; height=\&quot;&quot; + helper.FindAttribute(ht, &quot;height&quot;) + &quot;\&quot;&quot;;
                        }
                    }

                    // Build image tag
                    foreach (var attr in allowedAttributes)
                    {
                        if (helper.FindAttribute(ht, attr) != &quot;&quot;)
                        {
                            var attrValue = helper.FindAttribute(ht, attr);
                            cleanTag += &quot; &quot; + attr + &quot;=\&quot;&quot; + attrValue + &quot;\&quot;&quot;;
                        }
                    }

                    if (bool.Parse(GlobalSettings.EditXhtmlMode))
                        cleanTag += &quot;/&quot;;

                    cleanTag += &quot;&gt;&quot;;
                    html = html.Replace(tag.Value, cleanTag);
                }
            }

            return html;
        }

        private static string DoResize(IDictionary attributes, out int finalWidth, out int finalHeight, out string newSrc)
        {
            var fs = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();
            var orgSrc = HttpContext.Current.Server.HtmlDecode(helper.FindAttribute(attributes, &quot;src&quot;).Replace(&quot;%20&quot;, &quot; &quot;));
            var orgDim = helper.FindAttribute(attributes, &quot;rel&quot;).Split(&quot;,&quot;.ToCharArray());
            var orgWidth = float.Parse(orgDim[0]);
            var orgHeight = float.Parse(orgDim[1]);
            var newWidth = int.Parse(helper.FindAttribute(attributes, &quot;width&quot;));
            var newHeight = int.Parse(helper.FindAttribute(attributes, &quot;height&quot;));

            newSrc = &quot;&quot;;

            if (orgHeight &gt; 0 &amp;&amp; orgWidth &gt; 0 &amp;&amp; orgSrc != &quot;&quot;)
            {
                // Check dimensions
                if (Math.Abs(orgWidth / newWidth) &gt; Math.Abs(orgHeight / newHeight))
                {
                    newHeight = (int)Math.Round(newWidth * (orgHeight / orgWidth));
                }
                else
                {
                    newWidth = (int)Math.Round(newHeight * (orgWidth / orgHeight));
                }

                var orgPath = fs.GetRelativePath(orgSrc);
                if (fs.FileExists(orgPath))
                {
                    var uf = new UmbracoFile(orgPath);

                    try
                    {
                        newSrc = uf.Resize(newWidth, newHeight);
                    }
                    catch (Exception ex)
                    {
                        LogHelper.Error&lt;tinyMCEImageHelper&gt;(string.Format(&quot;The file {0} could not be resized, reverting the image src attribute to the original source: {1}&quot;, orgPath, orgSrc), ex);
                        newSrc = orgSrc;
                    }
                }
                else
                {
                    LogHelper.Warn&lt;tinyMCEImageHelper&gt;(string.Format(&quot;The file {0} does not exist, reverting the image src attribute to the original source: {1}&quot;, orgPath, orgSrc));
                    newSrc = orgSrc;
                }
            }

            finalWidth = newWidth;
            finalHeight = newHeight;

            return &quot; width=\&quot;&quot; + newWidth + &quot;\&quot;  height=\&quot;&quot; + newHeight + &quot;\&quot;&quot;;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,10,0],[18,13,18,119,0],[18,119,18,130,0],[18,130,18,141,0],[18,13,18,141,0],[21,13,21,60,0],[22,17,22,46,0],[25,13,25,123,0],[26,13,26,20,0],[26,22,26,31,0],[26,32,26,34,0],[26,35,26,39,0],[27,13,27,14,0],[28,17,28,98,0],[29,17,29,18,0],[30,21,30,43,0],[33,21,33,46,0],[34,21,34,257,0],[35,21,35,28,0],[35,30,35,48,0],[35,49,35,51,0],[35,52,35,59,0],[36,21,36,22,0],[37,25,38,77,0],[39,21,39,22,0],[42,21,42,63,0],[43,21,43,22,0],[45,25,45,96,0],[46,25,46,153,0],[47,25,47,26,0],[49,29,49,30,0],[54,33,54,99,0],[56,33,56,52,0],[57,29,57,30,0],[58,29,58,50,0],[59,29,59,30,0],[60,33,60,96,0],[61,33,61,77,0],[62,33,62,34,0],[63,37,63,104,0],[64,37,64,106,0],[65,33,65,34,0],[66,9,66,84,0],[67,29,67,30,0],[68,25,68,26,0],[70,25,70,26,0],[71,29,71,73,0],[72,29,72,30,0],[73,33,73,100,0],[74,33,74,102,0],[75,29,75,30,0],[77,25,77,26,0],[78,21,78,22,0],[80,21,80,22,0],[81,25,81,69,0],[82,25,82,26,0],[83,29,83,96,0],[84,29,84,98,0],[85,25,85,26,0],[86,21,86,22,0],[89,21,89,28,0],[89,30,89,38,0],[89,39,89,41,0],[89,42,89,59,0],[90,21,90,22,0],[91,25,91,66,0],[92,25,92,26,0],[93,29,93,76,0],[94,29,94,79,0],[95,25,95,26,0],[96,21,96,22,0],[98,21,98,66,0],[99,25,99,41,0],[101,21,101,37,0],[102,21,102,62,0],[103,17,103,18,0],[104,13,104,14,0],[106,13,106,25,0],[107,9,107,10,0],[110,9,110,10,0],[111,13,111,97,0],[112,13,112,125,0],[113,13,113,91,0],[114,13,114,51,0],[115,13,115,52,0],[116,13,116,81,0],[117,13,117,83,0],[119,13,119,25,0],[121,13,121,63,0],[122,13,122,14,0],[124,17,124,85,0],[125,17,125,18,0],[126,21,126,84,0],[127,17,127,18,0],[129,17,129,18,0],[130,21,130,84,0],[131,17,131,18,0],[133,17,133,58,0],[134,17,134,44,0],[135,17,135,18,0],[136,21,136,55,0],[139,21,139,22,0],[140,25,140,65,0],[141,21,141,22,0],[142,21,142,41,0],[143,21,143,22,0],[144,25,144,197,0],[145,25,145,41,0],[146,21,146,22,0],[147,17,147,18,0],[149,17,149,18,0],[150,21,150,182,0],[151,21,151,37,0],[152,17,152,18,0],[153,13,153,14,0],[155,13,155,35,0],[156,13,156,37,0],[158,13,158,80,0],[159,9,159,10,0]]);
    </script>
  </body>
</html>