<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.businesslogic\ApplicationRegistrar.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Linq;
using System.Xml.Linq;
using AutoMapper;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Mapping;
using Umbraco.Core.Persistence;
using Umbraco.Core.Services;
using umbraco.BusinessLogic.Utils;
using umbraco.DataLayer;
using umbraco.businesslogic;
using umbraco.interfaces;

namespace umbraco.BusinessLogic
{
    /// &lt;summary&gt;
    /// A startup handler for putting the app config in the config file based on attributes found
    /// &lt;/summary&gt;
    /// /// &lt;remarks&gt;
    /// TODO: This is really not a very ideal process but the code is found here because tree plugins are in the Web project or the legacy business logic project.
    /// Moving forward we can put the base tree plugin classes in the core and then this can all just be taken care of normally within the service.
    /// &lt;/remarks&gt;
    public class ApplicationRegistrar : ApplicationEventHandler, IMapperConfiguration
    {
        protected override void ApplicationStarted(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            //initialize the section service with a lazy collection of found app plugins
            applicationContext.Services.SectionService.Initialize(new LazyEnumerableSections());                
        }

        /// &lt;summary&gt;
        /// Configure a few auto-mappings
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;config&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;applicationContext&quot;&gt;&lt;/param&gt;
        public void ConfigureMappings(IConfiguration config, ApplicationContext applicationContext)
        {
            config.CreateMap&lt;Section, Application&gt;()
                  .ForMember(x =&gt; x.alias, expression =&gt; expression.MapFrom(x =&gt; x.Alias))
                  .ForMember(x =&gt; x.icon, expression =&gt; expression.MapFrom(x =&gt; x.Icon))
                  .ForMember(x =&gt; x.name, expression =&gt; expression.MapFrom(x =&gt; x.Name))
                  .ForMember(x =&gt; x.sortOrder, expression =&gt; expression.MapFrom(x =&gt; x.SortOrder)).ReverseMap();
            config.CreateMap&lt;Application, Section&gt;()
                  .ForMember(x =&gt; x.Alias, expression =&gt; expression.MapFrom(x =&gt; x.alias))
                  .ForMember(x =&gt; x.Icon, expression =&gt; expression.MapFrom(x =&gt; x.icon))
                  .ForMember(x =&gt; x.Name, expression =&gt; expression.MapFrom(x =&gt; x.name))
                  .ForMember(x =&gt; x.SortOrder, expression =&gt; expression.MapFrom(x =&gt; x.sortOrder));
        }

        /// &lt;summary&gt;
        /// This class is here so that we can provide lazy access to tree scanning for when it is needed
        /// &lt;/summary&gt;
        private class LazyEnumerableSections : IEnumerable&lt;Section&gt;
        {
            public LazyEnumerableSections()
            {
                _lazySections = new Lazy&lt;IEnumerable&lt;Section&gt;&gt;(() =&gt;
                {
                    // Load all Applications by attribute and add them to the XML config
                    var types = PluginManager.Current.ResolveApplications();

                    //since applications don&#39;t populate their metadata from the attribute and because it is an interface, 
                    //we need to interrogate the attributes for the data. Would be better to have a base class that contains 
                    //metadata populated by the attribute. Oh well i guess.
                    var attrs = types.Select(x =&gt; x.GetCustomAttributes&lt;ApplicationAttribute&gt;(false).Single());                                   
                    return attrs.Select(x =&gt; new Section(x.Name, x.Alias, x.Icon, x.SortOrder)).ToArray();
                });
            }

            private readonly Lazy&lt;IEnumerable&lt;Section&gt;&gt; _lazySections;

            /// &lt;summary&gt;
            /// Returns an enumerator that iterates through the collection.
            /// &lt;/summary&gt;
            /// &lt;returns&gt;
            /// A &lt;see cref=&quot;T:System.Collections.Generic.IEnumerator`1&quot;/&gt; that can be used to iterate through the collection.
            /// &lt;/returns&gt;
            public IEnumerator&lt;Section&gt; GetEnumerator()
            {
                return _lazySections.Value.GetEnumerator();
            }

            /// &lt;summary&gt;
            /// Returns an enumerator that iterates through a collection.
            /// &lt;/summary&gt;
            /// &lt;returns&gt;
            /// An &lt;see cref=&quot;T:System.Collections.IEnumerator&quot;/&gt; object that can be used to iterate through the collection.
            /// &lt;/returns&gt;
            IEnumerator IEnumerable.GetEnumerator()
            {
                return GetEnumerator();
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,10,0],[33,13,33,97,0],[34,9,34,10,0],[42,9,42,10,1],[43,13,44,58,1],[44,58,44,90,1],[44,90,45,57,1],[45,57,45,88,1],[45,88,46,57,1],[46,57,46,88,1],[46,88,47,62,1],[47,62,47,98,1],[47,98,47,113,1],[43,13,47,113,1],[48,13,49,58,1],[49,58,49,90,1],[49,90,50,57,1],[50,57,50,88,1],[50,88,51,57,1],[51,57,51,88,1],[51,88,52,62,1],[52,62,52,98,1],[52,98,52,100,1],[48,13,52,100,1],[53,9,53,10,1],[60,13,60,44,0],[61,13,61,14,0],[62,17,63,17,0],[63,17,63,18,0],[63,18,65,21,0],[65,21,65,77,0],[65,77,70,21,0],[70,21,70,51,0],[70,51,70,110,0],[70,110,70,112,0],[70,21,70,112,0],[70,112,71,21,0],[71,21,71,46,0],[71,46,71,95,0],[71,95,71,107,0],[71,21,71,107,0],[71,107,72,17,0],[72,17,72,18,0],[72,18,72,20,0],[62,17,72,20,0],[73,13,73,14,0],[84,13,84,14,0],[85,17,85,60,0],[86,13,86,14,0],[95,13,95,14,0],[96,17,96,40,0],[97,13,97,14,0]]);
    </script>
  </body>
</html>