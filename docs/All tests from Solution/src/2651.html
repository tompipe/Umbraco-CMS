<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\userControlWrapper\usercontrolDataEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.UI;
using Umbraco.Core.IO;
using umbraco.cms.businesslogic.property;
using umbraco.cms.businesslogic.datatype;
using System.Collections.Generic;

namespace umbraco.editorControls.userControlGrapper
{
    [ValidationProperty(&quot;Value&quot;)]
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class usercontrolDataEditor : System.Web.UI.WebControls.PlaceHolder, umbraco.interfaces.IDataEditor
	{
		private umbraco.interfaces.IData _data;
        private string _usercontrolPath;

        public object Value
        {
            get
            {
                return ((IUsercontrolDataEditor)Controls[0]).value;
            }
        }

        public usercontrolDataEditor(umbraco.interfaces.IData Data, string UsercontrolPath)
        {
			_data = Data;
            _usercontrolPath = IOHelper.FindFile(UsercontrolPath);
		}

		public virtual bool TreatAsRichTextEditor 
		{
			get {return false;}
		}

		public bool ShowLabel 
		{
			get {return true;}
		}

		public Control Editor {get{return this;}}

		public void Save() 
		{
            IUsercontrolDataEditor uc =
                (IUsercontrolDataEditor)Controls[0] as IUsercontrolDataEditor;

			_data.Value = uc.value;
		}

		protected override void OnInit(EventArgs e)
		{
			base.OnInit (e);

            Control oControl = new System.Web.UI.UserControl().LoadControl(_usercontrolPath);

            if (HasSettings(oControl.GetType()))
            {
                DataEditorSettingsStorage ss = new DataEditorSettingsStorage();
                List&lt;Setting&lt;string, string&gt;&gt; s = ss.GetSettings(((umbraco.cms.businesslogic.datatype.DefaultData)_data).DataTypeDefinitionId);
                ss.Dispose();

                foreach (Setting&lt;string, string&gt; setting in s)
                {
                    try
                    {
                        if(!string.IsNullOrEmpty(setting.Key))
                        {
                            oControl.GetType().InvokeMember(setting.Key, System.Reflection.BindingFlags.SetProperty, null, oControl, new object[] { setting.Value });
                        }

                    }
                    catch (MissingMethodException) { }
                }
                
            }

            // Add property data to the usercontrol if it supports it
            // TODO: Find the best way to test for an interface!
		    IUsercontrolPropertyData propertyData = oControl as IUsercontrolPropertyData;
            if (propertyData != null)
            {
                propertyData.PropertyObject = new Property(((usercontrolData)_data).PropertyId);
            }

            this.Controls.Add(oControl);

            if (!Page.IsPostBack)
                ((IUsercontrolDataEditor)Controls[0] as IUsercontrolDataEditor).value = _data.Value;
              
		}

        private bool HasSettings(Type t)
        {
            bool hasSettings = false;
            foreach (System.Reflection.PropertyInfo p in t.GetProperties())
            {
                object[] o = p.GetCustomAttributes(typeof(DataEditorSetting), true);

                if (o.Length &gt; 0)
                {
                    hasSettings = true;
                    break;
                }
            }

            return hasSettings;
        }

	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,13,20,14,0],[21,17,21,68,0],[22,13,22,14,0],[25,9,25,92,0],[26,9,26,10,0],[27,4,27,17,0],[28,13,28,67,0],[29,3,29,4,0],[33,8,33,9,0],[33,9,33,22,0],[33,22,33,23,0],[38,8,38,9,0],[38,9,38,21,0],[38,21,38,22,0],[41,29,41,30,0],[41,30,41,42,0],[41,42,41,43,0],[44,3,44,4,0],[45,13,46,79,0],[48,4,48,27,0],[49,3,49,4,0],[52,3,52,4,0],[53,4,53,20,0],[55,13,55,94,0],[57,13,57,49,0],[58,13,58,14,0],[59,17,59,80,0],[60,17,60,144,0],[61,17,61,30,0],[63,17,63,24,0],[63,26,63,57,0],[63,58,63,60,0],[63,61,63,62,0],[64,17,64,18,0],[66,21,66,22,0],[67,25,67,63,0],[68,25,68,26,0],[69,29,69,166,0],[70,25,70,26,0],[72,21,72,22,0],[73,21,73,51,0],[73,52,73,53,0],[73,54,73,55,0],[74,17,74,18,0],[76,13,76,14,0],[80,7,80,84,0],[81,13,81,38,0],[82,13,82,14,0],[83,17,83,97,0],[84,13,84,14,0],[86,13,86,41,0],[88,13,88,34,0],[89,17,89,101,0],[91,3,91,4,0],[94,9,94,10,0],[95,13,95,38,0],[96,13,96,20,0],[96,22,96,54,0],[96,55,96,57,0],[96,58,96,75,0],[97,13,97,14,0],[98,17,98,85,0],[100,17,100,34,0],[101,17,101,18,0],[102,21,102,40,0],[103,21,103,27,0],[105,13,105,14,0],[107,13,107,32,0],[108,9,108,10,0]]);
    </script>
  </body>
</html>