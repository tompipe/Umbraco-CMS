<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\LegacyTreeJavascript.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Umbraco.Core;
using Umbraco.Core.Logging;
using umbraco.cms.presentation.Trees;

namespace Umbraco.Web.Trees
{
    /// &lt;summary&gt;
    /// A class used to render the legacy JS requirements for trees and IActions.
    /// &lt;/summary&gt;
    internal static class LegacyTreeJavascript
    {
        /// &lt;summary&gt;
        /// If any legacy tree requires any JS rendering then we will compile a JS output of the combination.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetLegacyTreeJavascript()
        {
            //find all tree defs that exists for the current application regardless of if they are active
            List&lt;TreeDefinition&gt; appTreeDefs = TreeDefinitionCollection.Instance;
            //Create the BaseTree&#39;s based on the tree definitions found
            var legacyTrees = appTreeDefs.Select(treeDef =&gt; treeDef.CreateInstance()).ToList();
            var javascript = new StringBuilder();
            foreach (var bTree in legacyTrees)
            {
                try
                {
                    bTree.RenderJS(ref javascript);
                }
                catch (Exception ex)
                {
                    LogHelper.Error(typeof(LegacyTreeJavascript), &quot;Could not load the JS from the legacy tree &quot; + bTree.TreeAlias, ex);
                }
            }

            return ReplaceLegacyJs(javascript.ToString());
        }

        /// &lt;summary&gt;
        /// Returns a string with javascript proxy methods for IActions that are using old javascript
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetLegacyIActionJavascript()
        {
            var js = new StringBuilder();
            foreach (var a in ActionsResolver.Current.Actions.ToList())
            {
                // NH: Added a try/catch block to this as an error in a 3rd party action can crash the whole menu initialization
                try
                {
                    if (string.IsNullOrEmpty(a.Alias) == false &amp;&amp; (string.IsNullOrEmpty(a.JsFunctionName) == false || string.IsNullOrEmpty(a.JsSource) == false))
                    {
                        // if the action is using invalid javascript we need to do something about this
                        if (global::umbraco.BusinessLogic.Actions.Action.ValidateActionJs(a) == false)
                        {
                            js.AppendLine(&quot;function IActionProxy_&quot; + a.Alias.ToSafeAlias() + &quot;() {&quot;);
                            js.AppendLine(global::umbraco.BusinessLogic.Actions.Action.ConvertLegacyJs(a.JsFunctionName));
                            js.AppendLine(&quot;}&quot;);
                        }
                    }
                }
                catch (Exception ee)
                {
                    LogHelper.Error(typeof(LegacyTreeJavascript), &quot;Error initializing tree action&quot;, ee);
                }
            }

            if (js.Length != 0)
            {
                js.Insert(0, &quot;// This javascript is autogenerated by Umbraco to ensure legacy compatiblity with old context menu items\n\n&quot;);
            }

            return ReplaceLegacyJs(js.ToString());
        }

        private static string ReplaceLegacyJs(string js){
            js = js.Replace(&quot;parent.right.document.location&quot;, &quot;UmbClientMgr.getFakeFrame()&quot;);
            js = js.Replace(&quot;right.document.location&quot;, &quot;UmbClientMgr.getFakeFrame()&quot;);

            return js;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,0],[23,13,23,82,0],[25,13,25,61,0],[25,61,25,85,0],[25,85,25,96,0],[25,13,25,96,0],[26,13,26,50,0],[27,13,27,20,0],[27,22,27,31,0],[27,32,27,34,0],[27,35,27,46,0],[28,13,28,14,0],[30,17,30,18,0],[31,21,31,52,0],[32,17,32,18,0],[33,17,33,37,0],[34,17,34,18,0],[35,21,35,136,0],[36,17,36,18,0],[37,13,37,14,0],[39,13,39,59,0],[40,9,40,10,0],[47,9,47,10,0],[48,13,48,42,0],[49,13,49,20,0],[49,22,49,27,0],[49,28,49,30,0],[49,31,49,71,0],[50,13,50,14,0],[53,17,53,18,0],[54,21,54,162,0],[55,21,55,22,0],[57,25,57,103,0],[58,25,58,26,0],[59,29,59,102,0],[60,29,60,123,0],[61,29,61,48,0],[62,25,62,26,0],[63,21,63,22,0],[64,17,64,18,0],[65,17,65,37,0],[66,17,66,18,0],[67,21,67,105,0],[68,17,68,18,0],[69,13,69,14,0],[71,13,71,32,0],[72,13,72,14,0],[73,17,73,142,0],[74,13,74,14,0],[76,13,76,51,0],[77,9,77,10,0],[79,57,79,58,0],[80,13,80,94,0],[81,13,81,87,0],[83,13,83,23,0],[84,9,84,10,0]]);
    </script>
  </body>
</html>