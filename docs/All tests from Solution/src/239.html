<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Cache\CacheProviderTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web.UI;
using NUnit.Framework;
using Umbraco.Core.Cache;
using umbraco;

namespace Umbraco.Tests.Cache
{
    public abstract class CacheProviderTests
    {
        internal abstract ICacheProvider Provider { get; }
        protected abstract int GetTotalItemCount { get; }

        [SetUp]
        public virtual void Setup()
        {

        }

        [TearDown]
        public virtual void TearDown()
        {
            Provider.ClearAllCache();
        } 

        [Test]
        public void Throws_On_Reentry()
        {
            // don&#39;t run for StaticCacheProvider - not making sense
            if (GetType() == typeof (StaticCacheProviderTests))
                Assert.Ignore(&quot;Do not run for StaticCacheProvider.&quot;);

            Exception exception = null;
            var result = Provider.GetCacheItem(&quot;blah&quot;, () =&gt;
            {
                try
                {
                    var result2 = Provider.GetCacheItem(&quot;blah&quot;);
                }
                catch (Exception e)
                {
                    exception = e;
                }
                return &quot;value&quot;;
            });
            Assert.IsNotNull(exception);
            Assert.IsAssignableFrom&lt;InvalidOperationException&gt;(exception);
        }

        [Test]
        public void Does_Not_Cache_Exceptions()
        {
            var counter = 0;

            object result;
            try
            {
                result = Provider.GetCacheItem(&quot;Blah&quot;, () =&gt;
                    {
                        counter++;
                        throw new Exception(&quot;Do not cache this&quot;);
                    });
            }
            catch (Exception){}

            try
            {
                result = Provider.GetCacheItem(&quot;Blah&quot;, () =&gt;
                {
                    counter++;
                    throw new Exception(&quot;Do not cache this&quot;);
                });
            }
            catch (Exception){}

            Assert.Greater(counter, 1);

        }

        [Test]
        public void Ensures_Delegate_Result_Is_Cached_Once()
        {
            var counter = 0;

            object result;
            
            result = Provider.GetCacheItem(&quot;Blah&quot;, () =&gt;
            {
                counter++;
                return &quot;&quot;;
            });

            result = Provider.GetCacheItem(&quot;Blah&quot;, () =&gt;
            {
                counter++;
                return &quot;&quot;;
            });

            Assert.AreEqual(counter, 1);

        }

        [Test]
        public void Can_Get_By_Search()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            var cacheContent2 = new MacroCacheContent(new LiteralControl(), &quot;Test2&quot;);
            var cacheContent3 = new MacroCacheContent(new LiteralControl(), &quot;Test3&quot;);
            var cacheContent4 = new LiteralControl();
            Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            Provider.GetCacheItem(&quot;Tester2&quot;, () =&gt; cacheContent2);
            Provider.GetCacheItem(&quot;Tes3&quot;, () =&gt; cacheContent3);
            Provider.GetCacheItem(&quot;different4&quot;, () =&gt; cacheContent4);

            Assert.AreEqual(4, GetTotalItemCount);

            var result = Provider.GetCacheItemsByKeySearch(&quot;Tes&quot;);

            Assert.AreEqual(3, result.Count());
        }

        [Test]
        public void Can_Clear_By_Expression()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            var cacheContent2 = new MacroCacheContent(new LiteralControl(), &quot;Test2&quot;);
            var cacheContent3 = new MacroCacheContent(new LiteralControl(), &quot;Test3&quot;);
            var cacheContent4 = new LiteralControl();
            Provider.GetCacheItem(&quot;TTes1t&quot;, () =&gt; cacheContent1);
            Provider.GetCacheItem(&quot;Tester2&quot;, () =&gt; cacheContent2);
            Provider.GetCacheItem(&quot;Tes3&quot;, () =&gt; cacheContent3);
            Provider.GetCacheItem(&quot;different4&quot;, () =&gt; cacheContent4);

            Assert.AreEqual(4, GetTotalItemCount);

            Provider.ClearCacheByKeyExpression(&quot;^\\w+es\\d.*&quot;);

            Assert.AreEqual(2, GetTotalItemCount);
        }

        [Test]
        public void Can_Clear_By_Search()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            var cacheContent2 = new MacroCacheContent(new LiteralControl(), &quot;Test2&quot;);
            var cacheContent3 = new MacroCacheContent(new LiteralControl(), &quot;Test3&quot;);
            var cacheContent4 = new LiteralControl();
            Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            Provider.GetCacheItem(&quot;Tester2&quot;, () =&gt; cacheContent2);
            Provider.GetCacheItem(&quot;Tes3&quot;, () =&gt; cacheContent3);
            Provider.GetCacheItem(&quot;different4&quot;, () =&gt; cacheContent4);

            Assert.AreEqual(4, GetTotalItemCount);

            Provider.ClearCacheByKeySearch(&quot;Test&quot;);

            Assert.AreEqual(2, GetTotalItemCount);
        }

        [Test]
        public void Can_Clear_By_Key()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            var cacheContent2 = new MacroCacheContent(new LiteralControl(), &quot;Test2&quot;);
            var cacheContent3 = new MacroCacheContent(new LiteralControl(), &quot;Test3&quot;);
            var cacheContent4 = new LiteralControl();
            Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            Provider.GetCacheItem(&quot;Test2&quot;, () =&gt; cacheContent2);
            Provider.GetCacheItem(&quot;Test3&quot;, () =&gt; cacheContent3);
            Provider.GetCacheItem(&quot;Test4&quot;, () =&gt; cacheContent4);

            Assert.AreEqual(4, GetTotalItemCount);

            Provider.ClearCacheItem(&quot;Test1&quot;);
            Provider.ClearCacheItem(&quot;Test2&quot;);

            Assert.AreEqual(2, GetTotalItemCount);
        }

        [Test] 
        public void Can_Clear_All_Items()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            var cacheContent2 = new MacroCacheContent(new LiteralControl(), &quot;Test2&quot;);
            var cacheContent3 = new MacroCacheContent(new LiteralControl(), &quot;Test3&quot;);
            var cacheContent4 = new LiteralControl();
            Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            Provider.GetCacheItem(&quot;Test2&quot;, () =&gt; cacheContent2);
            Provider.GetCacheItem(&quot;Test3&quot;, () =&gt; cacheContent3);
            Provider.GetCacheItem(&quot;Test4&quot;, () =&gt; cacheContent4);

            Assert.AreEqual(4, GetTotalItemCount);

            Provider.ClearAllCache();

            Assert.AreEqual(0, GetTotalItemCount);
        }

        [Test]
        public void Can_Add_When_Not_Available()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            Assert.AreEqual(1, GetTotalItemCount);
        }

        [Test]
        public void Can_Get_When_Available()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            var result = Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            var result2 = Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            Assert.AreEqual(1, GetTotalItemCount);
            Assert.AreEqual(result, result2);
        }

        [Test]
        public void Can_Remove_By_Type_Name()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            var cacheContent2 = new MacroCacheContent(new LiteralControl(), &quot;Test2&quot;);
            var cacheContent3 = new MacroCacheContent(new LiteralControl(), &quot;Test3&quot;);
            var cacheContent4 = new LiteralControl();
            Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            Provider.GetCacheItem(&quot;Test2&quot;, () =&gt; cacheContent2);
            Provider.GetCacheItem(&quot;Test3&quot;, () =&gt; cacheContent3);
            Provider.GetCacheItem(&quot;Test4&quot;, () =&gt; cacheContent4);

            Assert.AreEqual(4, GetTotalItemCount);

            //Provider.ClearCacheObjectTypes(&quot;umbraco.MacroCacheContent&quot;);
            Provider.ClearCacheObjectTypes(typeof(MacroCacheContent).ToString());

            Assert.AreEqual(1, GetTotalItemCount);
        }

        [Test]
        public void Can_Remove_By_Strong_Type()
        {
            var cacheContent1 = new MacroCacheContent(new LiteralControl(), &quot;Test1&quot;);
            var cacheContent2 = new MacroCacheContent(new LiteralControl(), &quot;Test2&quot;);
            var cacheContent3 = new MacroCacheContent(new LiteralControl(), &quot;Test3&quot;);
            var cacheContent4 = new LiteralControl();
            Provider.GetCacheItem(&quot;Test1&quot;, () =&gt; cacheContent1);
            Provider.GetCacheItem(&quot;Test2&quot;, () =&gt; cacheContent2);
            Provider.GetCacheItem(&quot;Test3&quot;, () =&gt; cacheContent3);
            Provider.GetCacheItem(&quot;Test4&quot;, () =&gt; cacheContent4);

            Assert.AreEqual(4, GetTotalItemCount);

            Provider.ClearCacheObjectTypes&lt;MacroCacheContent&gt;();

            Assert.AreEqual(1, GetTotalItemCount);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,10,1],[19,9,19,10,1],[23,9,23,10,1],[24,13,24,38,1],[25,9,25,10,1],[29,9,29,10,1],[31,13,31,64,1],[32,17,32,70,1],[34,13,34,40,1],[35,13,36,13,1],[36,13,36,14,1],[36,14,38,17,1],[38,17,38,18,1],[38,18,39,21,1],[39,21,39,65,1],[39,65,40,17,1],[40,17,40,18,0],[40,18,41,17,1],[41,17,41,36,1],[41,36,42,17,1],[42,17,42,18,1],[42,18,43,21,1],[43,21,43,35,1],[43,35,44,17,1],[44,17,44,18,1],[44,18,45,17,1],[45,17,45,32,1],[45,32,46,13,1],[46,13,46,14,1],[46,14,46,16,1],[35,13,46,16,1],[47,13,47,41,1],[48,13,48,75,1],[49,9,49,10,1],[53,9,53,10,1],[54,13,54,29,1],[58,13,58,14,1],[59,17,60,21,1],[60,21,60,22,1],[60,22,61,25,1],[61,25,61,35,1],[61,35,62,25,1],[62,25,62,66,1],[62,66,63,24,1],[59,17,63,24,1],[64,13,64,14,0],[65,13,65,30,1],[65,30,65,31,1],[65,31,65,32,1],[68,13,68,14,1],[69,17,70,17,1],[70,17,70,18,1],[70,18,71,21,1],[71,21,71,31,1],[71,31,72,21,1],[72,21,72,62,1],[72,62,73,20,1],[69,17,73,20,1],[74,13,74,14,0],[75,13,75,30,1],[75,30,75,31,1],[75,31,75,32,1],[77,13,77,40,1],[79,9,79,10,1],[83,9,83,10,1],[84,13,84,29,1],[88,13,89,13,1],[89,13,89,14,1],[89,14,90,17,1],[90,17,90,27,1],[90,27,91,17,1],[91,17,91,27,1],[91,27,92,13,1],[92,13,92,14,1],[92,14,92,16,1],[88,13,92,16,1],[94,13,95,13,1],[95,13,95,14,0],[95,14,96,17,1],[96,17,96,27,0],[96,27,97,17,1],[97,17,97,27,0],[97,27,98,13,1],[98,13,98,14,0],[98,14,98,16,1],[94,13,98,16,1],[100,13,100,41,1],[102,9,102,10,1],[106,9,106,10,1],[107,13,107,86,1],[108,13,108,86,1],[109,13,109,86,1],[110,13,110,54,1],[111,13,111,50,1],[111,50,111,63,1],[111,63,111,65,1],[111,13,111,65,1],[112,13,112,52,1],[112,52,112,65,1],[112,65,112,67,1],[112,13,112,67,1],[113,13,113,49,1],[113,49,113,62,1],[113,62,113,64,1],[113,13,113,64,1],[114,13,114,55,1],[114,55,114,68,1],[114,68,114,70,1],[114,13,114,70,1],[116,13,116,51,1],[118,13,118,67,1],[120,13,120,48,1],[121,9,121,10,1],[125,9,125,10,1],[126,13,126,86,1],[127,13,127,86,1],[128,13,128,86,1],[129,13,129,54,1],[130,13,130,51,1],[130,51,130,64,1],[130,64,130,66,1],[130,13,130,66,1],[131,13,131,52,1],[131,52,131,65,1],[131,65,131,67,1],[131,13,131,67,1],[132,13,132,49,1],[132,49,132,62,1],[132,62,132,64,1],[132,13,132,64,1],[133,13,133,55,1],[133,55,133,68,1],[133,68,133,70,1],[133,13,133,70,1],[135,13,135,51,1],[137,13,137,64,1],[139,13,139,51,1],[140,9,140,10,1],[144,9,144,10,1],[145,13,145,86,1],[146,13,146,86,1],[147,13,147,86,1],[148,13,148,54,1],[149,13,149,50,1],[149,50,149,63,1],[149,63,149,65,1],[149,13,149,65,1],[150,13,150,52,1],[150,52,150,65,1],[150,65,150,67,1],[150,13,150,67,1],[151,13,151,49,1],[151,49,151,62,1],[151,62,151,64,1],[151,13,151,64,1],[152,13,152,55,1],[152,55,152,68,1],[152,68,152,70,1],[152,13,152,70,1],[154,13,154,51,1],[156,13,156,52,1],[158,13,158,51,1],[159,9,159,10,1],[163,9,163,10,1],[164,13,164,86,1],[165,13,165,86,1],[166,13,166,86,1],[167,13,167,54,1],[168,13,168,50,1],[168,50,168,63,1],[168,63,168,65,1],[168,13,168,65,1],[169,13,169,50,1],[169,50,169,63,1],[169,63,169,65,1],[169,13,169,65,1],[170,13,170,50,1],[170,50,170,63,1],[170,63,170,65,1],[170,13,170,65,1],[171,13,171,50,1],[171,50,171,63,1],[171,63,171,65,1],[171,13,171,65,1],[173,13,173,51,1],[175,13,175,46,1],[176,13,176,46,1],[178,13,178,51,1],[179,9,179,10,1],[183,9,183,10,1],[184,13,184,86,1],[185,13,185,86,1],[186,13,186,86,1],[187,13,187,54,1],[188,13,188,50,1],[188,50,188,63,1],[188,63,188,65,1],[188,13,188,65,1],[189,13,189,50,1],[189,50,189,63,1],[189,63,189,65,1],[189,13,189,65,1],[190,13,190,50,1],[190,50,190,63,1],[190,63,190,65,1],[190,13,190,65,1],[191,13,191,50,1],[191,50,191,63,1],[191,63,191,65,1],[191,13,191,65,1],[193,13,193,51,1],[195,13,195,38,1],[197,13,197,51,1],[198,9,198,10,1],[202,9,202,10,1],[203,13,203,86,1],[204,13,204,50,1],[204,50,204,63,1],[204,63,204,65,1],[204,13,204,65,1],[205,13,205,51,1],[206,9,206,10,1],[210,9,210,10,1],[211,13,211,86,1],[212,13,212,63,1],[212,63,212,76,1],[212,76,212,78,1],[212,13,212,78,1],[213,13,213,64,1],[213,64,213,77,0],[213,77,213,79,1],[213,13,213,79,1],[214,13,214,51,1],[215,13,215,46,1],[216,9,216,10,1],[220,9,220,10,1],[221,13,221,86,1],[222,13,222,86,1],[223,13,223,86,1],[224,13,224,54,1],[225,13,225,50,1],[225,50,225,63,1],[225,63,225,65,1],[225,13,225,65,1],[226,13,226,50,1],[226,50,226,63,1],[226,63,226,65,1],[226,13,226,65,1],[227,13,227,50,1],[227,50,227,63,1],[227,63,227,65,1],[227,13,227,65,1],[228,13,228,50,1],[228,50,228,63,1],[228,63,228,65,1],[228,13,228,65,1],[230,13,230,51,1],[233,13,233,82,1],[235,13,235,51,1],[236,9,236,10,1],[240,9,240,10,1],[241,13,241,86,1],[242,13,242,86,1],[243,13,243,86,1],[244,13,244,54,1],[245,13,245,50,1],[245,50,245,63,1],[245,63,245,65,1],[245,13,245,65,1],[246,13,246,50,1],[246,50,246,63,1],[246,63,246,65,1],[246,13,246,65,1],[247,13,247,50,1],[247,50,247,63,1],[247,63,247,65,1],[247,13,247,65,1],[248,13,248,50,1],[248,50,248,63,1],[248,63,248,65,1],[248,13,248,65,1],[250,13,250,51,1],[252,13,252,65,1],[254,13,254,51,1],[255,9,255,10,1]]);
    </script>
  </body>
</html>