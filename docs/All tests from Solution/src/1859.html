<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Migrations\Upgrades\TargetVersionSevenThreeZero\MigrateStylesheetDataToFile.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Linq;
using System.Text;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.SqlSyntax;
using File = System.IO.File;

namespace Umbraco.Core.Persistence.Migrations.Upgrades.TargetVersionSevenThreeZero
{
    /// &lt;summary&gt;
    /// Ensures that any stylesheets that have properties defined at the db level have the correct new syntax 
    /// in their files before we remove the stylesheet db tables
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// Instead of modifying the files directly (since we cannot roll them back) we will create temporary migrated files. 
    /// These files will then be copied over once the entire migration is complete so that if any migration fails and the db changes are
    /// rolled back, the original files won&#39;t be affected.
    /// &lt;/remarks&gt;
    [Migration(&quot;7.3.0&quot;, 2, GlobalSettings.UmbracoMigrationName)]
    public class MigrateStylesheetDataToFile : MigrationBase
    {
        public MigrateStylesheetDataToFile(ISqlSyntaxProvider sqlSyntax, ILogger logger)
            : base(sqlSyntax, logger)
        {
        }

        public override void Up()
        {
            //Don&#39;t exeucte if the stylesheet table is not there
            var tables = SqlSyntax.GetTablesInSchema(Context.Database).ToArray();
            if (tables.InvariantContains(&quot;cmsStylesheet&quot;) == false) return;

            //This is all rather nasty but it&#39;s how stylesheets used to work in the 2 various ugly ways so we just have to 
            // deal with that to get this migration done


            var tempFolder = IOHelper.MapPath(&quot;~/App_Data/TEMP/CssMigration/&quot;);
            if (Directory.Exists(tempFolder))
            {
                //clear any existing css files (we back the real ones up so if this migration is run again for whatever reason anything that 
                // was previously backed up is still there, backup happens in a post migration: OverwriteStylesheetFilesFromTempFiles class)
                var files = Directory.GetFiles(tempFolder, &quot;*.css&quot;, SearchOption.AllDirectories);
                foreach (var file in files)
                {
                    File.Delete(file);
                }
            }
            //create the temp folder
            var tempDir = Directory.CreateDirectory(IOHelper.MapPath(&quot;~/App_Data/TEMP/CssMigration/&quot;));


            var sheets = Context.Database.Fetch&lt;dynamic&gt;(&quot;SELECT * FROM cmsStylesheet INNER JOIN umbracoNode on cmsStylesheet.nodeId = umbracoNode.id&quot;);
            foreach (var sheet in sheets)
            {
                var fileName = sheet.text;

                string dbContent;
                //we will always use the file content over the db content if there is any
                using (var memStream = new MemoryStream(Encoding.UTF8.GetBytes(sheet.content)))
                {
                    dbContent = GetContentAboveUmbracoProps(memStream);
                }

                var fileContent = string.Empty;

                //check for file and read in it&#39;s data - umbraco properties will only be kept that are in the db, 
                // anything below the infamous: /* EDITOR PROPERTIES - PLEASE DON&#39;T DELETE THIS LINE TO AVOID DUPLICATE PROPERTIES */
                // line is an Umbraco property and therefore anything that is there that is not in the db will be cleared.

                var filePath = IOHelper.MapPath(string.Format(&quot;{0}/{1}.css&quot;, SystemDirectories.Css, fileName));
                if (File.Exists(filePath))
                {
                    using (var stream = File.OpenRead(filePath))
                    {
                        fileContent = GetContentAboveUmbracoProps(stream);
                    }
                }

                var props = Context.Database.Fetch&lt;dynamic&gt;(&quot;SELECT * FROM cmsStylesheetProperty INNER JOIN umbracoNode ON cmsStylesheetProperty.nodeId = umbracoNode.id WHere umbracoNode.parentID = @id&quot;, new { id = sheet.nodeId });

                var cssFolderPath = IOHelper.MapPath(SystemDirectories.Css);
                var relativeFsPath = StringExtensions.TrimStart(StringExtensions.TrimStart(filePath, cssFolderPath), &quot;\\&quot;);
                var stylesheetInstance = new Stylesheet(relativeFsPath)
                {
                    Content = fileContent.IsNullOrWhiteSpace() ? dbContent : fileContent
                };

                foreach (var prop in props)
                {
                    if (stylesheetInstance.Properties.Any(x =&gt; x.Name == prop.text) == false)
                    {
                        stylesheetInstance.AddProperty(new StylesheetProperty(prop.text, prop.stylesheetPropertyAlias, prop.stylesheetPropertyValue));
                    }
                }

                //Save to temp folder

                //ensure the folder for the file exists since it could be in a sub folder
                var tempFilePath = Path.Combine(tempDir.FullName, relativeFsPath);
                Directory.CreateDirectory(Path.GetDirectoryName(tempFilePath));

                File.WriteAllText(tempFilePath, stylesheetInstance.Content, Encoding.UTF8);

            }
        }

        public override void Down()
        {
            throw new NotSupportedException(&quot;Cannot downgrade from 7.3 as there are database table deletions&quot;);
        }

        private string GetContentAboveUmbracoProps(Stream stream)
        {
            var content = string.Empty;
            using (var re = new StreamReader(stream))
            {
                string input;
                var readingProperties = false;

                while ((input = re.ReadLine()) != null)
                {
                    //This is that line that was in there before that was delimiting umb props from normal css:
                    // /* EDITOR PROPERTIES - PLEASE DON&#39;T DELETE THIS LINE TO AVOID DUPLICATE PROPERTIES */
                    if (input.Contains(&quot;EDITOR PROPERTIES&quot;))
                    {
                        readingProperties = true;
                        continue;
                    }

                    if (readingProperties == false)
                    {
                        content += input;
                    }
                }
            }
            return content;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,15,27,38,0],[28,9,28,10,0],[29,9,29,10,0],[32,9,32,10,0],[34,13,34,82,0],[35,13,35,68,0],[35,69,35,76,0],[41,13,41,80,0],[42,13,42,46,0],[43,13,43,14,0],[46,17,46,98,0],[47,17,47,24,0],[47,26,47,34,0],[47,35,47,37,0],[47,38,47,43,0],[48,17,48,18,0],[49,21,49,39,0],[50,17,50,18,0],[51,13,51,14,0],[53,13,53,104,0],[56,13,56,153,0],[57,13,57,20,0],[57,22,57,31,0],[57,32,57,34,0],[57,35,57,41,0],[58,13,58,14,0],[59,17,59,43,0],[63,24,63,95,0],[64,17,64,18,0],[65,21,65,72,0],[66,17,66,18,0],[68,17,68,48,0],[74,17,74,112,0],[75,17,75,43,0],[76,17,76,18,0],[77,28,77,64,0],[78,21,78,22,0],[79,25,79,75,0],[80,21,80,22,0],[81,17,81,18,0],[83,17,83,232,0],[85,17,85,77,0],[86,17,86,124,0],[87,17,90,19,0],[92,17,92,24,0],[92,26,92,34,0],[92,35,92,37,0],[92,38,92,43,0],[93,17,93,18,0],[94,21,94,64,0],[94,64,94,83,0],[94,83,94,94,0],[94,21,94,94,0],[95,21,95,22,0],[96,25,96,151,0],[97,21,97,22,0],[98,17,98,18,0],[103,17,103,83,0],[104,17,104,80,0],[106,17,106,92,0],[108,13,108,14,0],[109,9,109,10,0],[112,9,112,10,0],[113,13,113,112,0],[117,9,117,10,0],[118,13,118,40,0],[119,20,119,53,0],[120,13,120,14,0],[122,17,122,47,0],[124,17,124,56,0],[125,17,125,18,0],[128,21,128,61,0],[129,21,129,22,0],[130,25,130,50,0],[131,25,131,34,0],[134,21,134,52,0],[135,21,135,22,0],[136,25,136,42,0],[137,21,137,22,0],[138,17,138,18,0],[139,13,139,14,0],[140,13,140,28,0],[141,9,141,10,0]]);
    </script>
  </body>
</html>