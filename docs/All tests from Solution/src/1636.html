<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\DatabaseSchemaHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.DatabaseModelDefinitions;
using Umbraco.Core.Persistence.Migrations.Initial;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Services;

namespace Umbraco.Core.Persistence
{

    public class DatabaseSchemaHelper
    {
        private readonly Database _db;
        private readonly ILogger _logger;
        private readonly ISqlSyntaxProvider _syntaxProvider;
        private readonly BaseDataCreation _baseDataCreation;

        public DatabaseSchemaHelper(Database db, ILogger logger, ISqlSyntaxProvider syntaxProvider)
        {
            _db = db;
            _logger = logger;
            _syntaxProvider = syntaxProvider;
            _baseDataCreation = new BaseDataCreation(db, logger);
        }

        public bool TableExist(string tableName)
        {
            return _syntaxProvider.DoesTableExist(_db, tableName);
        }

        internal void UninstallDatabaseSchema()
        {
            var creation = new DatabaseSchemaCreation(_db, _logger, _syntaxProvider);
            creation.UninstallDatabaseSchema();
        }

        /// &lt;summary&gt;
        /// Creates the Umbraco db schema in the Database of the current Database.
        /// Safe method that is only able to create the schema in non-configured
        /// umbraco instances.
        /// &lt;/summary&gt;
        public void CreateDatabaseSchema(ApplicationContext applicationContext)
        {
            if (applicationContext == null) throw new ArgumentNullException(&quot;applicationContext&quot;);
            CreateDatabaseSchema(true, applicationContext);
        }

        /// &lt;summary&gt;
        /// Creates the Umbraco db schema in the Database of the current Database
        /// with the option to guard the db from having the schema created
        /// multiple times.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;guardConfiguration&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;applicationContext&quot;&gt;&lt;/param&gt;
        public void CreateDatabaseSchema(bool guardConfiguration, ApplicationContext applicationContext)
        {
            if (applicationContext == null) throw new ArgumentNullException(&quot;applicationContext&quot;);

            if (guardConfiguration &amp;&amp; applicationContext.IsConfigured)
                throw new Exception(&quot;Umbraco is already configured!&quot;);

            CreateDatabaseSchemaDo(applicationContext.Services.MigrationEntryService);
        }

        internal void CreateDatabaseSchemaDo(bool guardConfiguration, ApplicationContext applicationContext)
        {
            if (guardConfiguration &amp;&amp; applicationContext.IsConfigured)
                throw new Exception(&quot;Umbraco is already configured!&quot;);

            CreateDatabaseSchemaDo(applicationContext.Services.MigrationEntryService);
        }

        internal void CreateDatabaseSchemaDo(IMigrationEntryService migrationEntryService)
        {
            _logger.Info&lt;Database&gt;(&quot;Initializing database schema creation&quot;);

            var creation = new DatabaseSchemaCreation(_db, _logger, _syntaxProvider);
            creation.InitializeDatabaseSchema();

            _logger.Info&lt;Database&gt;(&quot;Finalized database schema creation&quot;);
        }

        public void CreateTable&lt;T&gt;(bool overwrite)
           where T : new()
        {
            var tableType = typeof(T);
            CreateTable(overwrite, tableType);
        }

        public void CreateTable&lt;T&gt;()
          where T : new()
        {
            var tableType = typeof(T);           
            CreateTable(false, tableType);
        }

        public void CreateTable(bool overwrite, Type modelType)
        {
            var tableDefinition = DefinitionFactory.GetTableDefinition(_syntaxProvider, modelType);
            var tableName = tableDefinition.Name;

            string createSql = _syntaxProvider.Format(tableDefinition);
            string createPrimaryKeySql = _syntaxProvider.FormatPrimaryKey(tableDefinition);
            var foreignSql = _syntaxProvider.Format(tableDefinition.ForeignKeys);
            var indexSql = _syntaxProvider.Format(tableDefinition.Indexes);

            var tableExist = TableExist(tableName);
            if (overwrite &amp;&amp; tableExist)
            {
                DropTable(tableName);
                tableExist = false;
            }

            if (tableExist == false)
            {
                using (var transaction = _db.GetTransaction())
                {
                    //Execute the Create Table sql
                    int created = _db.Execute(new Sql(createSql));
                    _logger.Info&lt;Database&gt;(string.Format(&quot;Create Table sql {0}:\n {1}&quot;, created, createSql));

                    //If any statements exists for the primary key execute them here
                    if (!string.IsNullOrEmpty(createPrimaryKeySql))
                    {
                        int createdPk = _db.Execute(new Sql(createPrimaryKeySql));
                        _logger.Info&lt;Database&gt;(string.Format(&quot;Primary Key sql {0}:\n {1}&quot;, createdPk, createPrimaryKeySql));
                    }

                    //Turn on identity insert if db provider is not mysql
                    if (_syntaxProvider.SupportsIdentityInsert() &amp;&amp; tableDefinition.Columns.Any(x =&gt; x.IsIdentity))
                        _db.Execute(new Sql(string.Format(&quot;SET IDENTITY_INSERT {0} ON &quot;, _syntaxProvider.GetQuotedTableName(tableName))));

                    //Call the NewTable-event to trigger the insert of base/default data
                    //OnNewTable(tableName, _db, e, _logger);

                    _baseDataCreation.InitializeBaseData(tableName);

                    //Turn off identity insert if db provider is not mysql
                    if (_syntaxProvider.SupportsIdentityInsert() &amp;&amp; tableDefinition.Columns.Any(x =&gt; x.IsIdentity))
                        _db.Execute(new Sql(string.Format(&quot;SET IDENTITY_INSERT {0} OFF;&quot;, _syntaxProvider.GetQuotedTableName(tableName))));

                    //Special case for MySql
                    if (_syntaxProvider is MySqlSyntaxProvider &amp;&amp; tableName.Equals(&quot;umbracoUser&quot;))
                    {
                        _db.Update&lt;UserDto&gt;(&quot;SET id = @IdAfter WHERE id = @IdBefore AND userLogin = @Login&quot;, new { IdAfter = 0, IdBefore = 1, Login = &quot;admin&quot; });
                    }

                    //Loop through index statements and execute sql
                    foreach (var sql in indexSql)
                    {
                        int createdIndex = _db.Execute(new Sql(sql));
                        _logger.Info&lt;Database&gt;(string.Format(&quot;Create Index sql {0}:\n {1}&quot;, createdIndex, sql));
                    }

                    //Loop through foreignkey statements and execute sql
                    foreach (var sql in foreignSql)
                    {
                        int createdFk = _db.Execute(new Sql(sql));
                        _logger.Info&lt;Database&gt;(string.Format(&quot;Create Foreign Key sql {0}:\n {1}&quot;, createdFk, sql));
                    }

                    

                    transaction.Complete();
                }
            }

            _logger.Info&lt;Database&gt;(string.Format(&quot;New table &#39;{0}&#39; was created&quot;, tableName));
        }

        public void DropTable&lt;T&gt;()
            where T : new()
        {
            Type type = typeof(T);
            var tableNameAttribute = type.FirstAttribute&lt;TableNameAttribute&gt;();
            if (tableNameAttribute == null)
                throw new Exception(
                    string.Format(
                        &quot;The Type &#39;{0}&#39; does not contain a TableNameAttribute, which is used to find the name of the table to drop. The operation could not be completed.&quot;,
                        type.Name));

            string tableName = tableNameAttribute.Value;
            DropTable(tableName);
        }

        public void DropTable(string tableName)
        {
            var sql = new Sql(string.Format(
                _syntaxProvider.DropTable,
                _syntaxProvider.GetQuotedTableName(tableName)));
            _db.Execute(sql);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,100,1],[22,9,22,10,1],[23,13,23,22,1],[24,13,24,30,1],[25,13,25,46,1],[26,13,26,66,1],[27,9,27,10,1],[30,9,30,10,1],[31,13,31,67,1],[32,9,32,10,1],[35,9,35,10,0],[36,13,36,86,0],[37,13,37,48,0],[38,9,38,10,0],[46,9,46,10,0],[47,13,47,44,0],[47,45,47,99,0],[48,13,48,60,0],[49,9,49,10,0],[59,9,59,10,1],[60,13,60,44,1],[60,45,60,99,0],[62,13,62,71,1],[63,17,63,71,0],[65,13,65,87,1],[66,9,66,10,1],[69,9,69,10,0],[70,13,70,71,0],[71,17,71,71,0],[73,13,73,87,0],[74,9,74,10,0],[77,9,77,10,1],[78,13,78,77,1],[80,13,80,86,1],[81,13,81,49,1],[83,13,83,74,1],[84,9,84,10,1],[88,9,88,10,0],[89,13,89,39,0],[90,13,90,47,0],[91,9,91,10,0],[95,9,95,10,1],[96,13,96,39,1],[97,13,97,43,1],[98,9,98,10,1],[101,9,101,10,1],[102,13,102,100,1],[103,13,103,50,1],[105,13,105,72,1],[106,13,106,92,1],[107,13,107,82,1],[108,13,108,76,1],[110,13,110,52,1],[111,13,111,41,1],[112,13,112,14,0],[113,17,113,38,0],[114,17,114,36,0],[115,13,115,14,0],[117,13,117,37,1],[118,13,118,14,1],[119,24,119,62,1],[120,17,120,18,1],[122,21,122,67,1],[123,21,123,110,1],[126,21,126,68,1],[127,21,127,22,1],[128,25,128,83,1],[129,25,129,125,1],[130,21,130,22,1],[133,21,133,102,1],[133,102,133,114,1],[133,114,133,116,1],[133,21,133,116,1],[134,25,134,139,1],[139,21,139,69,1],[142,21,142,102,1],[142,102,142,114,1],[142,114,142,116,1],[142,21,142,116,1],[143,25,143,140,1],[146,21,146,99,1],[147,21,147,22,0],[148,25,148,162,0],[149,21,149,22,0],[152,21,152,28,1],[152,30,152,37,1],[152,38,152,40,1],[152,41,152,49,1],[153,21,153,22,1],[154,25,154,70,1],[155,25,155,113,1],[156,21,156,22,1],[159,21,159,28,1],[159,30,159,37,1],[159,38,159,40,1],[159,41,159,51,1],[160,21,160,22,1],[161,25,161,67,1],[162,25,162,116,1],[163,21,163,22,1],[167,21,167,44,1],[168,17,168,18,1],[169,13,169,14,1],[171,13,171,93,1],[172,9,172,10,1],[176,9,176,10,0],[177,13,177,35,0],[178,13,178,80,0],[179,13,179,44,0],[180,17,183,37,0],[185,13,185,57,0],[186,13,186,34,0],[187,9,187,10,0],[190,9,190,10,0],[191,13,193,65,0],[194,13,194,30,0],[195,9,195,10,0]]);
    </script>
  </body>
</html>