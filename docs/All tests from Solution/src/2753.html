<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\PickerRelations\PickerRelationsPreValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web.UI;
using System.Web.UI.WebControls;
using umbraco.cms.businesslogic.datatype;
using umbraco.cms.businesslogic.relation;


namespace umbraco.editorControls.PickerRelations
{
    /// &lt;summary&gt;
    /// This PreValueEditor will require an XPath expression to define the nodes to pick as CheckBox options,
	/// TODO: [HR] min / max selections ?
    /// Uses the shared JsonPreValueEditor as nice way of lightweight serializing a config data class object into a single DB field
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class PickerRelationsPreValueEditor : AbstractJsonPrevalueEditor
    {
        /// &lt;summary&gt;
        /// Prepopulated Umbraco Propery Picker, lists all aliases (could refine this by asking for the context in which this relation wire-up will
        /// be used, and then only listing the aliases for that context)
        /// &lt;/summary&gt;
        private PropertyTypePicker pickerPropertyAliasPicker = new PropertyTypePicker();

        /// &lt;summary&gt;
        /// RequiredFieldValidator for the ProperyAliasPicker
        /// &lt;/summary&gt;
        private RequiredFieldValidator pickerPropertyAliasRequiredFieldValidator = new RequiredFieldValidator();

        /// &lt;summary&gt;
        /// drop down list of all relation types
        /// &lt;/summary&gt;
        private DropDownList relationTypeDropDownList = new DropDownList();

        /// &lt;summary&gt;
        /// RequiredFieldValidator for the RelationType DropDownList
        /// &lt;/summary&gt;
        private RequiredFieldValidator relationTypeRequiredFieldValidator = new RequiredFieldValidator();

        /// &lt;summary&gt;
        /// If a parent to child relation type is selected, then this checkbox will indicate the direction to use,
        /// with reverse indexing the parents are the nodes selected via the picker, and the nodeID on which the
        /// this datatype is used, become the child nodes
        /// &lt;/summary&gt;
        private CheckBox reverseIndexingCheckBox = new CheckBox();

		/// &lt;summary&gt;
		/// if selected, then the property on the data editor is hidden (it&#39;s only used as a label)
		/// &lt;/summary&gt;
		private CheckBox hideDataEditorCheckBox = new CheckBox();

        /// &lt;summary&gt;
        /// Data object used to define the configuration status of this PreValueEditor
        /// &lt;/summary&gt;
        private PickerRelationsOptions options = null;

        /// &lt;summary&gt;
        /// Currently selected RelationType
        /// &lt;/summary&gt;
        private RelationType relationType = null;

        /// &lt;summary&gt;
        /// Lazy load the options data object that represents the current state of this datatypes configuration
        /// &lt;/summary&gt;
        internal PickerRelationsOptions Options
        {
            get
            {
                if (this.options == null)
                {
                    // Deserialize any stored settings for this PreValueEditor instance
                    this.options = this.GetPreValueOptions&lt;PickerRelationsOptions&gt;();

                    // If still null, ie, object couldn&#39;t be de-serialized from PreValue[0] string value
                    if (this.options == null)
                    {
                        // Create a new Options data object with the default values
                        this.options = new PickerRelationsOptions();
                    }
                }
                return this.options;
            }
        }

        /// &lt;summary&gt;
        /// Lazy load currently selected RelationType
        /// &lt;/summary&gt;
        private RelationType RelationType
        {
            get
            {
                if (this.relationType == null)
                {
                    // Attempt to get RelationType from the selected DropDownList item
                    int relationTypeId;
                    if(int.TryParse(this.relationTypeDropDownList.SelectedValue, out relationTypeId))
                    {
                        if (relationTypeId != -1)
                        {
                            this.relationType = new RelationType(relationTypeId);
                        }
                    }
                }

                return this.relationType;
            }
        }

        /// &lt;summary&gt;
        /// Initialize a new instance of PickerRelationsPreValueEditor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataType&quot;&gt;PickerRelationsDataType&lt;/param&gt;
        public PickerRelationsPreValueEditor(umbraco.cms.businesslogic.datatype.BaseDataType dataType)
            : base(dataType, umbraco.cms.businesslogic.datatype.DBTypes.Nvarchar)
        {
        }

        /// &lt;summary&gt;
        /// Creates all of the controls and assigns all of their properties
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            this.pickerPropertyAliasPicker.ID = &quot;pickerPropertyAliasPicker&quot;;
			
            this.pickerPropertyAliasRequiredFieldValidator.Text = &quot; Required&quot;;
            this.pickerPropertyAliasRequiredFieldValidator.InitialValue = string.Empty;
            this.pickerPropertyAliasRequiredFieldValidator.ControlToValidate = this.pickerPropertyAliasPicker.ID;

            this.relationTypeDropDownList.ID = &quot;relationTypeDropDownList&quot;;
            this.relationTypeDropDownList.AutoPostBack = true;
			this.relationTypeDropDownList.DataSource = RelationType.GetAll().OrderBy(x =&gt; x.Name);
            this.relationTypeDropDownList.DataTextField = &quot;Name&quot;;
            this.relationTypeDropDownList.DataValueField = &quot;Id&quot;;
            this.relationTypeDropDownList.DataBind();
            this.relationTypeDropDownList.Items.Insert(0, new ListItem(string.Empty, &quot;-1&quot;));

            this.relationTypeRequiredFieldValidator.Text = &quot; Required&quot;;
            this.relationTypeRequiredFieldValidator.InitialValue = &quot;-1&quot;;
            this.relationTypeRequiredFieldValidator.ControlToValidate = this.relationTypeDropDownList.ID;

            this.Controls.Add(this.pickerPropertyAliasPicker);
            this.Controls.Add(this.pickerPropertyAliasRequiredFieldValidator);
            this.Controls.Add(this.relationTypeDropDownList);
            this.Controls.Add(this.relationTypeRequiredFieldValidator);
            this.Controls.Add(this.reverseIndexingCheckBox);
			this.Controls.Add(this.hideDataEditorCheckBox);
        }

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            if (!this.Page.IsPostBack)
            {
                // Read in stored configuration values
                if (this.pickerPropertyAliasPicker.Items.Contains(new ListItem(this.Options.PropertyAlias)))
                {
                    this.pickerPropertyAliasPicker.SelectedValue = this.Options.PropertyAlias;
                }

                if (this.relationTypeDropDownList.Items.FindByValue(this.Options.RelationTypeId.ToString()) != null)
                {
                    this.relationTypeDropDownList.SelectedValue = this.Options.RelationTypeId.ToString();
                }

                this.reverseIndexingCheckBox.Checked = this.Options.ReverseIndexing;
				
				this.hideDataEditorCheckBox.Checked = this.Options.HideDataEditor;
            }
        }

        /// &lt;summary&gt;
        /// Saves the pre value data to Umbraco
        /// &lt;/summary&gt;
        public override void Save()
        {
            if (this.Page.IsValid)
            {
                this.Options.PropertyAlias = this.pickerPropertyAliasPicker.SelectedValue;
                if (this.RelationType != null)
                {
                    this.Options.RelationTypeId = this.RelationType.Id;
                }

                this.Options.ReverseIndexing = this.reverseIndexingCheckBox.Checked;

				this.Options.HideDataEditor = this.hideDataEditorCheckBox.Checked;

                // Serialize to Umbraco database field
                this.SaveAsJson(this.Options);
            }
        }

        /// &lt;summary&gt;
        /// Used to remove styling from the built in pickerProperty alias picker DropDownList 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnPreRender(EventArgs e)
        {
            base.OnPreRender(e);

            this.pickerPropertyAliasPicker.CssClass = string.Empty; // Remove guiInputTextStandard 

			// Sort properties in the built in property picker control
			ListItem[] propertyAliasListItems = this.pickerPropertyAliasPicker.Items.Cast&lt;ListItem&gt;().OrderBy(x =&gt; x.Text).ToArray();

			this.pickerPropertyAliasPicker.Items.Clear();
			this.pickerPropertyAliasPicker.Items.AddRange(propertyAliasListItems);
        }

        /// &lt;summary&gt;
        /// Replaces the base class writer and instead uses the shared uComponents extension method, to inject consistant markup
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;writer&quot;&gt;&lt;/param&gt;
        protected override void RenderContents(HtmlTextWriter writer)
        {
            writer.AddPrevalueRow(&quot;Picker Alias&quot;, this.pickerPropertyAliasPicker, this.pickerPropertyAliasRequiredFieldValidator);
            writer.AddPrevalueRow(&quot;Relation Type&quot;, this.relationTypeDropDownList, this.relationTypeRequiredFieldValidator);

            // Only show this field if selected RelationType is of Parent to Child
            if (this.RelationType != null)
            {
                if (!this.RelationType.Dual)
                {
                    writer.AddPrevalueRow(&quot;Reverse Indexing&quot;, this.reverseIndexingCheckBox);
                }
            }

			writer.AddPrevalueRow(&quot;Hide Data Editor&quot;, this.hideDataEditorCheckBox);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,89,0],[28,9,28,113,0],[33,9,33,76,0],[38,9,38,106,0],[45,9,45,67,0],[50,3,50,60,0],[55,9,55,55,0],[60,9,60,50,0],[68,13,68,14,0],[69,17,69,42,0],[70,17,70,18,0],[72,21,72,86,0],[75,21,75,46,0],[76,21,76,22,0],[78,25,78,69,0],[79,21,79,22,0],[80,17,80,18,0],[81,17,81,37,0],[82,13,82,14,0],[91,13,91,14,0],[92,17,92,47,0],[93,17,93,18,0],[96,21,96,102,0],[97,21,97,22,0],[98,25,98,50,0],[99,25,99,26,0],[100,29,100,82,0],[101,25,101,26,0],[102,21,102,22,0],[103,17,103,18,0],[105,17,105,42,0],[106,13,106,14,0],[114,15,114,82,0],[115,9,115,10,0],[116,9,116,10,0],[122,9,122,10,0],[123,13,123,77,0],[125,13,125,79,0],[126,13,126,88,0],[127,13,127,114,0],[129,13,129,75,0],[130,13,130,63,0],[131,4,131,82,0],[131,82,131,88,0],[131,88,131,90,0],[131,4,131,90,0],[132,13,132,66,0],[133,13,133,65,0],[134,13,134,54,0],[135,13,135,93,0],[137,13,137,72,0],[138,13,138,73,0],[139,13,139,106,0],[141,13,141,63,0],[142,13,142,79,0],[143,13,143,62,0],[144,13,144,72,0],[145,13,145,61,0],[146,4,146,51,0],[147,9,147,10,0],[154,9,154,10,0],[155,13,155,28,0],[157,13,157,39,0],[158,13,158,14,0],[160,17,160,109,0],[161,17,161,18,0],[162,21,162,95,0],[163,17,163,18,0],[165,17,165,117,0],[166,17,166,18,0],[167,21,167,106,0],[168,17,168,18,0],[170,17,170,85,0],[172,5,172,71,0],[173,13,173,14,0],[174,9,174,10,0],[180,9,180,10,0],[181,13,181,35,0],[182,13,182,14,0],[183,17,183,91,0],[184,17,184,47,0],[185,17,185,18,0],[186,21,186,72,0],[187,17,187,18,0],[189,17,189,85,0],[191,5,191,71,0],[194,17,194,47,0],[195,13,195,14,0],[196,9,196,10,0],[203,9,203,10,0],[204,13,204,33,0],[206,13,206,68,0],[209,4,209,107,0],[209,107,209,113,0],[209,113,209,125,0],[209,4,209,125,0],[211,4,211,49,0],[212,4,212,74,0],[213,9,213,10,0],[220,9,220,10,0],[221,13,221,131,0],[222,13,222,124,0],[225,13,225,43,0],[226,13,226,14,0],[227,17,227,45,0],[228,17,228,18,0],[229,21,229,93,0],[230,17,230,18,0],[231,13,231,14,0],[233,4,233,75,0],[234,9,234,10,0]]);
    </script>
  </body>
</html>