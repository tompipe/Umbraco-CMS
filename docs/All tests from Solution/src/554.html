<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\webservices\CacheRefresher.asmx.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web;
using System.Web.Services;
using System.Xml;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.Owin;
using Newtonsoft.Json;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Logging;
using Umbraco.Core.Sync;
using umbraco.interfaces;
using Umbraco.Core.Models.Identity;
using Umbraco.Core.Security;
using Umbraco.Web.Security;

namespace umbraco.presentation.webservices
{
	/// &lt;summary&gt;
	/// CacheRefresher web service.
	/// &lt;/summary&gt;
	[WebService(Namespace=&quot;http://umbraco.org/webservices/&quot;)]
	public class CacheRefresher : WebService
    {
        #region Helpers

        // is the server originating from this server - ie are we self-messaging?
        // in which case we should ignore the message because it&#39;s been processed locally already
        internal static bool SelfMessage(string hash)
        {
            if (string.IsNullOrEmpty(hash)) return false; // no hash = don&#39;t know = not self
            if (hash != WebServiceServerMessenger.GetCurrentServerHash()) return false;

            LogHelper.Debug&lt;CacheRefresher&gt;(
                &quot;Ignoring self-message. (server: {0}, appId: {1}, hash: {2})&quot;,
                () =&gt; NetworkHelper.MachineName,
                () =&gt; HttpRuntime.AppDomainAppId,
                () =&gt; hash);

            return true;
        }

        private static ICacheRefresher GetRefresher(Guid id)
        {
            var refresher = CacheRefreshersResolver.Current.GetById(id);
            if (refresher == null)
                throw new InvalidOperationException(&quot;Cache refresher with ID \&quot;&quot; + id + &quot;\&quot; does not exist.&quot;);
            return refresher;
        }

        private static IJsonCacheRefresher GetJsonRefresher(Guid id)
        {
            return GetJsonRefresher(GetRefresher(id));
        }

        private static IJsonCacheRefresher GetJsonRefresher(ICacheRefresher refresher)
        {
            var jsonRefresher = refresher as IJsonCacheRefresher;
            if (jsonRefresher == null)
                throw new InvalidOperationException(&quot;Cache refresher with ID \&quot;&quot; + refresher.UniqueIdentifier + &quot;\&quot; does not implement &quot; + typeof(IJsonCacheRefresher) + &quot;.&quot;);
            return jsonRefresher;
        }

        private bool Authorized(string login, string rawPassword)
        {
            //TODO: This technique of passing the raw password in is a legacy idea and isn&#39;t really 
            // a very happy way to secure this webservice. To prevent brute force attacks, we need 
            // to ensure that the lockout policies are applied, though because we are not authenticating
            // the user with their real password, we need to do this a bit manually.

            var userMgr = Context.GetOwinContext().GetBackOfficeUserManager();
            
            var user = ApplicationContext.Current.Services.UserService.GetByUsername(login);
            if (user == null) return false;

            var u = userMgr.FindById(user.Id);
            if (u == null) return false;

            if (u.IsLockedOut) return false;

            if (user.RawPasswordValue != rawPassword)
            {
                //this performs the lockout and/or increments the access failed count
                userMgr.AccessFailed(u.Id);
                return false;
            }

            return true;
        }

        #endregion

        [WebMethod]
        public void BulkRefresh(RefreshInstruction[] instructions, string appId, string login, string password)
        {
            if (Authorized(login, password) == false) return;
            if (SelfMessage(appId)) return; // do not process self-messages

            // only execute distinct instructions - no sense in running the same one more than once
            foreach (var instruction in instructions.Distinct())
            {
                var refresher = GetRefresher(instruction.RefresherId);
                switch (instruction.RefreshType)
                {
                    case RefreshMethodType.RefreshAll:
                        refresher.RefreshAll();
                        break;
                    case RefreshMethodType.RefreshByGuid:
                        refresher.Refresh(instruction.GuidId);
                        break;
                    case RefreshMethodType.RefreshById:
                        refresher.Refresh(instruction.IntId);
                        break;
                    case RefreshMethodType.RefreshByIds: // not directly supported by ICacheRefresher
                        foreach (var id in JsonConvert.DeserializeObject&lt;int[]&gt;(instruction.JsonIds))
	                        refresher.Refresh(id);
                        break;
                    case RefreshMethodType.RefreshByJson:
                        GetJsonRefresher(refresher).Refresh(instruction.JsonPayload);
                        break;
                    case RefreshMethodType.RemoveById:
                        refresher.Remove(instruction.IntId);
                        break;
                    //case RefreshMethodType.RemoveByIds: // not directly supported by ICacheRefresher
                    //    foreach (var id in JsonConvert.DeserializeObject&lt;int[]&gt;(instruction.JsonIds))
                    //        refresher.Remove(id);
                    //    break;
                }
            }
        }

		[WebMethod]
		public void RefreshAll(Guid uniqueIdentifier, string Login, string Password)
		{
		    if (Authorized(Login, Password) == false) return;
			GetRefresher(uniqueIdentifier).RefreshAll();
		}

	    [WebMethod]
		public void RefreshByGuid(Guid uniqueIdentifier, Guid Id, string Login, string Password)
		{
            if (Authorized(Login, Password) == false) return;
            GetRefresher(uniqueIdentifier).Refresh(Id);
		}

		[WebMethod]
		public void RefreshById(Guid uniqueIdentifier, int Id, string Login, string Password)
		{
		    if (Authorized(Login, Password) == false) return;
			GetRefresher(uniqueIdentifier).Refresh(Id);
		}

        [WebMethod]
        public void RefreshByIds(Guid uniqueIdentifier, string jsonIds, string Login, string Password)
        {
            if (Authorized(Login, Password) == false) return;
            var refresher = GetRefresher(uniqueIdentifier);
	        foreach (var id in JsonConvert.DeserializeObject&lt;int[]&gt;(jsonIds))
	            refresher.Refresh(id);
        }

        [WebMethod]
        public void RefreshByJson(Guid uniqueIdentifier, string jsonPayload, string Login, string Password)
        {
            if (Authorized(Login, Password) == false) return;
            GetJsonRefresher(uniqueIdentifier).Refresh(jsonPayload);
        }

	    [WebMethod]
        public void RemoveById(Guid uniqueIdentifier, int Id, string Login, string Password) 
        {
            if (Authorized(Login, Password) == false) return;
            GetRefresher(uniqueIdentifier).Remove(Id);
        }

	    [WebMethod]
		public XmlDocument GetRefreshers(string Login, string Password)
	    {
	        if (Authorized(Login, Password) == false) return null;

			var xd = new XmlDocument();
			xd.LoadXml(&quot;&lt;cacheRefreshers/&gt;&quot;);
			foreach (var cr in CacheRefreshersResolver.Current.CacheRefreshers) 
			{
				var n = xmlHelper.addTextNode(xd, &quot;cacheRefresher&quot;, cr.Name);
				n.Attributes.Append(xmlHelper.addAttribute(xd, &quot;uniqueIdentifier&quot;, cr.UniqueIdentifier.ToString()));
				xd.DocumentElement.AppendChild(n);
			}
			return xd;
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,10,0],[32,13,32,44,0],[32,45,32,58,0],[33,13,33,74,0],[33,75,33,88,0],[35,13,37,23,0],[37,23,37,48,0],[37,48,38,23,0],[38,23,38,49,0],[38,49,39,23,0],[39,23,39,27,0],[39,27,39,29,0],[35,13,39,29,0],[41,13,41,25,0],[42,9,42,10,0],[45,9,45,10,0],[46,13,46,73,0],[47,13,47,35,0],[48,17,48,111,0],[49,13,49,30,0],[50,9,50,10,0],[53,9,53,10,0],[54,13,54,55,0],[55,9,55,10,0],[58,9,58,10,0],[59,13,59,66,0],[60,13,60,39,0],[61,17,61,175,0],[62,13,62,34,0],[63,9,63,10,0],[66,9,66,10,0],[72,13,72,79,0],[74,13,74,93,0],[75,13,75,30,0],[75,31,75,44,0],[77,13,77,47,0],[78,13,78,27,0],[78,28,78,41,0],[80,13,80,31,0],[80,32,80,45,0],[82,13,82,54,0],[83,13,83,14,0],[85,17,85,44,0],[86,17,86,30,0],[89,13,89,25,0],[90,9,90,10,0],[96,9,96,10,0],[97,13,97,54,0],[97,55,97,62,0],[98,13,98,36,0],[98,37,98,44,0],[101,13,101,20,0],[101,22,101,37,0],[101,38,101,40,0],[101,41,101,64,0],[102,13,102,14,0],[103,17,103,71,0],[104,17,104,49,0],[107,25,107,48,0],[108,25,108,31,0],[110,25,110,63,0],[111,25,111,31,0],[113,25,113,62,0],[114,25,114,31,0],[116,25,116,32,0],[116,34,116,40,0],[116,41,116,43,0],[116,44,116,101,0],[117,26,117,48,0],[118,25,118,31,0],[120,25,120,86,0],[121,25,121,31,0],[123,25,123,61,0],[124,25,124,31,0],[130,13,130,14,0],[131,9,131,10,0],[135,3,135,4,0],[136,7,136,48,0],[136,49,136,56,0],[137,4,137,48,0],[138,3,138,4,0],[142,3,142,4,0],[143,13,143,54,0],[143,55,143,62,0],[144,13,144,56,0],[145,3,145,4,0],[149,3,149,4,0],[150,7,150,48,0],[150,49,150,56,0],[151,4,151,47,0],[152,3,152,4,0],[156,9,156,10,0],[157,13,157,54,0],[157,55,157,62,0],[158,13,158,60,0],[159,10,159,17,0],[159,19,159,25,0],[159,26,159,28,0],[159,29,159,74,0],[160,14,160,36,0],[161,9,161,10,0],[165,9,165,10,0],[166,13,166,54,0],[166,55,166,62,0],[167,13,167,69,0],[168,9,168,10,0],[172,9,172,10,0],[173,13,173,54,0],[173,55,173,62,0],[174,13,174,55,0],[175,9,175,10,0],[179,6,179,7,0],[180,10,180,51,0],[180,52,180,64,0],[182,4,182,31,0],[183,4,183,37,0],[184,4,184,11,0],[184,13,184,19,0],[184,20,184,22,0],[184,23,184,70,0],[185,4,185,5,0],[186,5,186,66,0],[187,5,187,105,0],[188,5,188,39,0],[189,4,189,5,0],[190,4,190,14,0],[191,3,191,4,0]]);
    </script>
  </body>
</html>