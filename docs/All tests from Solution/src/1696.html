<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\TaskRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using AutoMapper;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Factories;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence.Repositories
{
    internal class TaskRepository : PetaPocoRepositoryBase&lt;int, Task&gt;, ITaskRepository
    {
        public TaskRepository(IDatabaseUnitOfWork work, CacheHelper cache, ILogger logger, ISqlSyntaxProvider sqlSyntax)
            : base(work, cache, logger, sqlSyntax)
        {
        }

        protected override Task PerformGet(int id)
        {
            var sql = GetBaseQuery(false);
            sql.Where(GetBaseWhereClause(), new { Id = id });

            var taskDto = Database.Fetch&lt;TaskDto, TaskTypeDto&gt;(SqlSyntax.SelectTop(sql, 1)).FirstOrDefault();
            if (taskDto == null)
                return null;

            var factory = new TaskFactory();
            var entity = factory.BuildEntity(taskDto);
            return entity;
        }

        protected override IEnumerable&lt;Task&gt; PerformGetAll(params int[] ids)
        {
            var sql = GetBaseQuery(false);

            if (ids.Any())
            {
                sql.Where(&quot;cmsTask.id IN (@ids)&quot;, new { ids = ids });
            }

            var factory = new TaskFactory();
            var dtos = Database.Fetch&lt;TaskDto, TaskTypeDto&gt;(sql);
            return dtos.Select(factory.BuildEntity);
        }

        protected override IEnumerable&lt;Task&gt; PerformGetByQuery(IQuery&lt;Task&gt; query)
        {
            var sqlClause = GetBaseQuery(false);
            var translator = new SqlTranslator&lt;Task&gt;(sqlClause, query);
            var sql = translator.Translate();

            var factory = new TaskFactory();
            var dtos = Database.Fetch&lt;TaskDto, TaskTypeDto&gt;(sql);
            return dtos.Select(factory.BuildEntity);
        }

        protected override Sql GetBaseQuery(bool isCount)
        {
            var sql = new Sql();
            if (isCount)
            {
                sql.Select(&quot;COUNT(*)&quot;).From&lt;TaskDto&gt;(SqlSyntax);
            }
            else
            {
                return GetBaseQuery();
            }
            return sql;
        }

        private Sql GetBaseQuery()
        {
            var sql = new Sql();
            sql.Select(&quot;cmsTask.closed,cmsTask.id,cmsTask.taskTypeId,cmsTask.nodeId,cmsTask.parentUserId,cmsTask.userId,cmsTask.&quot; + SqlSyntax.GetQuotedColumnName(&quot;DateTime&quot;) + &quot;,cmsTask.Comment,cmsTaskType.id, cmsTaskType.alias&quot;)
                .From&lt;TaskDto&gt;(SqlSyntax)
                .InnerJoin&lt;TaskTypeDto&gt;(SqlSyntax)
                .On&lt;TaskDto, TaskTypeDto&gt;(SqlSyntax, left =&gt; left.TaskTypeId, right =&gt; right.Id)
                .InnerJoin&lt;NodeDto&gt;(SqlSyntax)
                .On&lt;TaskDto, NodeDto&gt;(SqlSyntax, left =&gt; left.NodeId, right =&gt; right.NodeId);
            return sql;
        }

        protected override string GetBaseWhereClause()
        {
            return &quot;cmsTask.id = @Id&quot;;
        }

        protected override IEnumerable&lt;string&gt; GetDeleteClauses()
        {
            var list = new List&lt;string&gt;
                {
                    &quot;DELETE FROM cmsTask WHERE id = @Id&quot;                           
                };
            return list;
        }

        protected override Guid NodeObjectTypeId
        {
            get { throw new NotImplementedException(); }
        }

        protected override void PersistNewItem(Task entity)
        {
            entity.AddingEntity();

            //ensure the task type exists
            var taskType = Database.SingleOrDefault&lt;TaskTypeDto&gt;(&quot;Where alias = @alias&quot;, new { alias = entity.TaskType.Alias });
            if (taskType == null)
            {
                var taskTypeId = Convert.ToInt32(Database.Insert(new TaskTypeDto { Alias = entity.TaskType.Alias }));
                entity.TaskType.Id = taskTypeId;
            }
            else
            {
                entity.TaskType.Id = taskType.Id;
            }

            var factory = new TaskFactory();
            var dto = factory.BuildDto(entity);

            var id = Convert.ToInt32(Database.Insert(dto));
            entity.Id = id;

            entity.ResetDirtyProperties();
        }

        protected override void PersistUpdatedItem(Task entity)
        {
            entity.UpdatingEntity();

            var factory = new TaskFactory();
            var dto = factory.BuildDto(entity);

            Database.Update(dto);

            entity.ResetDirtyProperties();
        }

        public IEnumerable&lt;Task&gt; GetTasks(int? itemId = null, int? assignedUser = null, int? ownerUser = null, string taskTypeAlias = null, bool includeClosed = false)
        {
            var sql = GetGetTasksQuery(assignedUser, ownerUser, taskTypeAlias, includeClosed);
            if (itemId.HasValue)
            {
                sql.Where&lt;NodeDto&gt;(dto =&gt; dto.NodeId == itemId.Value);
            }

            var dtos = Database.Fetch&lt;TaskDto, TaskTypeDto&gt;(sql);
            var factory = new TaskFactory();
            return dtos.Select(factory.BuildEntity);
        }

        private Sql GetGetTasksQuery(int? assignedUser = null, int? ownerUser = null, string taskTypeAlias = null, bool includeClosed = false)
        {
            var sql = GetBaseQuery(false);

            if (includeClosed == false)
            {
                sql.Where&lt;TaskDto&gt;(dto =&gt; dto.Closed == false);
            }
            if (taskTypeAlias.IsNullOrWhiteSpace() == false)
            {
                sql.Where(&quot;cmsTaskType.alias = @alias&quot;, new { alias = taskTypeAlias });
            }
            if (ownerUser.HasValue)
            {
                sql.Where&lt;TaskDto&gt;(dto =&gt; dto.ParentUserId == ownerUser.Value);
            }
            if (assignedUser.HasValue)
            {
                sql.Where&lt;TaskDto&gt;(dto =&gt; dto.UserId == assignedUser.Value);
            }
            return sql;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,15,19,51,1],[20,9,20,10,1],[21,9,21,10,1],[24,9,24,10,1],[25,13,25,43,1],[26,13,26,62,1],[28,13,28,110,1],[29,13,29,33,1],[30,17,30,29,1],[32,13,32,45,1],[33,13,33,55,1],[34,13,34,27,1],[35,9,35,10,1],[38,9,38,10,1],[39,13,39,43,1],[41,13,41,27,1],[42,13,42,14,0],[43,17,43,70,0],[44,13,44,14,0],[46,13,46,45,1],[47,13,47,66,1],[48,13,48,53,1],[49,9,49,10,1],[52,9,52,10,0],[53,13,53,49,0],[54,13,54,72,0],[55,13,55,46,0],[57,13,57,45,0],[58,13,58,66,0],[59,13,59,53,0],[60,9,60,10,0],[63,9,63,10,1],[64,13,64,33,1],[65,13,65,25,1],[66,13,66,14,0],[67,17,67,65,0],[68,13,68,14,0],[70,13,70,14,1],[71,17,71,39,1],[73,13,73,24,0],[74,9,74,10,1],[77,9,77,10,1],[78,13,78,33,1],[79,13,84,94,1],[85,13,85,24,1],[86,9,86,10,1],[89,9,89,10,1],[90,13,90,39,1],[91,9,91,10,1],[94,9,94,10,1],[95,13,98,19,1],[99,13,99,25,1],[100,9,100,10,1],[104,17,104,18,0],[104,19,104,55,0],[108,9,108,10,1],[109,13,109,35,1],[112,13,112,129,1],[113,13,113,34,1],[114,13,114,14,1],[115,17,115,118,1],[116,17,116,49,1],[117,13,117,14,1],[119,13,119,14,1],[120,17,120,50,1],[121,13,121,14,1],[123,13,123,45,1],[124,13,124,48,1],[126,13,126,60,1],[127,13,127,28,1],[129,13,129,43,1],[130,9,130,10,1],[133,9,133,10,1],[134,13,134,37,1],[136,13,136,45,1],[137,13,137,48,1],[139,13,139,34,1],[141,13,141,43,1],[142,9,142,10,1],[145,9,145,10,1],[146,13,146,95,1],[147,13,147,33,1],[148,13,148,14,1],[149,17,149,71,1],[150,13,150,14,1],[152,13,152,66,1],[153,13,153,45,1],[154,13,154,53,1],[155,9,155,10,1],[158,9,158,10,1],[159,13,159,43,1],[161,13,161,40,1],[162,13,162,14,1],[163,17,163,64,1],[164,13,164,14,1],[165,13,165,61,1],[166,13,166,14,0],[167,17,167,88,0],[168,13,168,14,0],[169,13,169,36,1],[170,13,170,14,0],[171,17,171,80,0],[172,13,172,14,0],[173,13,173,39,1],[174,13,174,14,0],[175,17,175,77,0],[176,13,176,14,0],[177,13,177,24,1],[178,9,178,10,1]]);
    </script>
  </body>
</html>