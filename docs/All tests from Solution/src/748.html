<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebServices\XmlDataIntegrityController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Web.Http;
using Umbraco.Core;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Web.WebApi;
using Umbraco.Web.WebApi.Filters;

namespace Umbraco.Web.WebServices
{
    [ValidateAngularAntiForgeryToken]
    public class XmlDataIntegrityController : UmbracoAuthorizedApiController
    {
        [HttpPost]
        public bool FixContentXmlTable()
        {
            Services.ContentService.RebuildXmlStructures();
            return CheckContentXmlTable();
        }

        [HttpPost]
        public bool FixMediaXmlTable()
        {
            Services.MediaService.RebuildXmlStructures();
            return CheckMediaXmlTable();
        }

        [HttpPost]
        public bool FixMembersXmlTable()
        {
            Services.MemberService.RebuildXmlStructures();
            return CheckMembersXmlTable();
        }

        [HttpGet]
        public bool CheckContentXmlTable()
        {
            var totalPublished = Services.ContentService.CountPublished();
            
            var subQuery = new Sql()
                .Select(&quot;DISTINCT cmsContentXml.nodeId&quot;)
                .From&lt;ContentXmlDto&gt;()
                .InnerJoin&lt;DocumentDto&gt;()
                .On&lt;DocumentDto, ContentXmlDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId);

            var totalXml = ApplicationContext.DatabaseContext.Database.ExecuteScalar&lt;int&gt;(&quot;SELECT COUNT(*) FROM (&quot; + subQuery.SQL + &quot;) as tmp&quot;);

            return totalXml == totalPublished;
        }
        
        [HttpGet]
        public bool CheckMediaXmlTable()
        {
            var total = Services.MediaService.CountNotTrashed();
            var mediaObjectType = Guid.Parse(Constants.ObjectTypes.Media);
            var subQuery = new Sql()
                .Select(&quot;Count(*)&quot;)
                .From&lt;ContentXmlDto&gt;()
                .InnerJoin&lt;NodeDto&gt;()
                .On&lt;ContentXmlDto, NodeDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeObjectType == mediaObjectType);
            var totalXml = ApplicationContext.DatabaseContext.Database.ExecuteScalar&lt;int&gt;(subQuery);

            return totalXml == total;
        }

        [HttpGet]
        public bool CheckMembersXmlTable()
        {
            var total = Services.MemberService.Count();
            var memberObjectType = Guid.Parse(Constants.ObjectTypes.Member);
            var subQuery = new Sql()
                .Select(&quot;Count(*)&quot;)
                .From&lt;ContentXmlDto&gt;()
                .InnerJoin&lt;NodeDto&gt;()
                .On&lt;ContentXmlDto, NodeDto&gt;(left =&gt; left.NodeId, right =&gt; right.NodeId)
                .Where&lt;NodeDto&gt;(dto =&gt; dto.NodeObjectType == memberObjectType);
            var totalXml = ApplicationContext.DatabaseContext.Database.ExecuteScalar&lt;int&gt;(subQuery);

            return totalXml == total;
        }

        
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,0],[17,13,17,60,0],[18,13,18,43,0],[19,9,19,10,0],[23,9,23,10,0],[24,13,24,58,0],[25,13,25,41,0],[26,9,26,10,0],[30,9,30,10,0],[31,13,31,59,0],[32,13,32,43,0],[33,9,33,10,0],[37,9,37,10,0],[38,13,38,75,0],[40,13,44,93,0],[46,13,46,145,0],[48,13,48,47,0],[49,9,49,10,0],[53,9,53,10,0],[54,13,54,65,0],[55,13,55,75,0],[56,13,61,79,0],[62,13,62,101,0],[64,13,64,38,0],[65,9,65,10,0],[69,9,69,10,0],[70,13,70,56,0],[71,13,71,77,0],[72,13,77,80,0],[78,13,78,101,0],[80,13,80,38,0],[81,9,81,10,0]]);
    </script>
  </body>
</html>