<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\PublishedContent\PublishedContentDataTableTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Dynamics;
using Umbraco.Core.Models;
using Umbraco.Core.Models.PublishedContent;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;

namespace Umbraco.Tests.PublishedContent
{
	/// &lt;summary&gt;
	/// Unit tests for IPublishedContent and extensions
	/// &lt;/summary&gt;
	[TestFixture]
	public class PublishedContentDataTableTests : BaseRoutingTest
	{
		public override void Initialize()
		{
			base.Initialize();

            // need to specify a custom callback for unit tests
            // AutoPublishedContentTypes generates properties automatically
            var type = new AutoPublishedContentType(0, &quot;anything&quot;, new PublishedPropertyType[] {});
            PublishedContentType.GetPublishedContentTypeCallback = (alias) =&gt; type;

            // need to specify a different callback for testing
			PublishedContentExtensions.GetPropertyAliasesAndNames = s =&gt;
				{
					var userFields = new Dictionary&lt;string, string&gt;()
						{
							{&quot;property1&quot;, &quot;Property 1&quot;},
							{&quot;property2&quot;, &quot;Property 2&quot;}					
						};
					if (s == &quot;Child&quot;)
					{
						userFields.Add(&quot;property4&quot;, &quot;Property 4&quot;);
					}
					else
					{
						userFields.Add(&quot;property3&quot;, &quot;Property 3&quot;);
					}

					//ensure the standard fields are there
					var allFields = new Dictionary&lt;string, string&gt;()
						{
							{&quot;Id&quot;, &quot;Id&quot;},
							{&quot;NodeName&quot;, &quot;NodeName&quot;},
							{&quot;NodeTypeAlias&quot;, &quot;NodeTypeAlias&quot;},
							{&quot;CreateDate&quot;, &quot;CreateDate&quot;},
							{&quot;UpdateDate&quot;, &quot;UpdateDate&quot;},
							{&quot;CreatorName&quot;, &quot;CreatorName&quot;},
							{&quot;WriterName&quot;, &quot;WriterName&quot;},
							{&quot;Url&quot;, &quot;Url&quot;}
						};
					foreach (var f in userFields.Where(f =&gt; !allFields.ContainsKey(f.Key)))
					{
						allFields.Add(f.Key, f.Value);
					}
					return allFields;
				};
			var routingContext = GetRoutingContext(&quot;/test&quot;);

			//set the UmbracoContext.Current since the extension methods rely on it
			UmbracoContext.Current = routingContext.UmbracoContext;
		}

		public override void TearDown()
		{
			base.TearDown();
			Umbraco.Web.PublishedContentExtensions.GetPropertyAliasesAndNames = null;
			UmbracoContext.Current = null;
		}		

		[Test]
		public void To_DataTable()
		{	
			var doc = GetContent(true, 1);
			var dt = doc.ChildrenAsTable();

			Assert.AreEqual(11, dt.Columns.Count);
			Assert.AreEqual(3, dt.Rows.Count);
			Assert.AreEqual(&quot;value4&quot;, dt.Rows[0][&quot;Property 1&quot;]);
			Assert.AreEqual(&quot;value5&quot;, dt.Rows[0][&quot;Property 2&quot;]);
			Assert.AreEqual(&quot;value6&quot;, dt.Rows[0][&quot;Property 4&quot;]);
			Assert.AreEqual(&quot;value7&quot;, dt.Rows[1][&quot;Property 1&quot;]);
			Assert.AreEqual(&quot;value8&quot;, dt.Rows[1][&quot;Property 2&quot;]);
			Assert.AreEqual(&quot;value9&quot;, dt.Rows[1][&quot;Property 4&quot;]);
			Assert.AreEqual(&quot;value10&quot;, dt.Rows[2][&quot;Property 1&quot;]);
			Assert.AreEqual(&quot;value11&quot;, dt.Rows[2][&quot;Property 2&quot;]);
			Assert.AreEqual(&quot;value12&quot;, dt.Rows[2][&quot;Property 4&quot;]);
		}

		[Test]
		public void To_DataTable_With_Filter()
		{
			var doc = GetContent(true, 1);
			//change a doc type alias
			((TestPublishedContent) doc.Children.ElementAt(0)).DocumentTypeAlias = &quot;DontMatch&quot;;

			var dt = doc.ChildrenAsTable(&quot;Child&quot;);

			Assert.AreEqual(11, dt.Columns.Count);
			Assert.AreEqual(2, dt.Rows.Count);
			Assert.AreEqual(&quot;value7&quot;, dt.Rows[0][&quot;Property 1&quot;]);
			Assert.AreEqual(&quot;value8&quot;, dt.Rows[0][&quot;Property 2&quot;]);
			Assert.AreEqual(&quot;value9&quot;, dt.Rows[0][&quot;Property 4&quot;]);
			Assert.AreEqual(&quot;value10&quot;, dt.Rows[1][&quot;Property 1&quot;]);
			Assert.AreEqual(&quot;value11&quot;, dt.Rows[1][&quot;Property 2&quot;]);
			Assert.AreEqual(&quot;value12&quot;, dt.Rows[1][&quot;Property 4&quot;]);
		}

		[Test]
		public void To_DataTable_No_Rows()
		{
			var doc = GetContent(false, 1);			
			var dt = doc.ChildrenAsTable();
			//will return an empty data table
			Assert.AreEqual(0, dt.Columns.Count);
			Assert.AreEqual(0, dt.Rows.Count);			
		}

		private IPublishedContent GetContent(bool createChildren, int indexVals)
		{
		    var contentTypeAlias = createChildren ? &quot;Parent&quot; : &quot;Child&quot;;
			var d = new TestPublishedContent
				{
					CreateDate = DateTime.Now,
					CreatorId = 1,
					CreatorName = &quot;Shannon&quot;,
                    DocumentTypeAlias = contentTypeAlias,
					DocumentTypeId = 2,
					Id = 3,
					SortOrder = 4,
					TemplateId = 5,
					UpdateDate = DateTime.Now,
					Path = &quot;-1,3&quot;,
					UrlName = &quot;home-page&quot;,
					Name = &quot;Page&quot; + Guid.NewGuid().ToString(),
					Version = Guid.NewGuid(),
					WriterId = 1,
					WriterName = &quot;Shannon&quot;,
					Parent = null,
					Level = 1,
					Properties = new Collection&lt;IPublishedProperty&gt;(
						new List&lt;IPublishedProperty&gt;()
							{
								new PropertyResult(&quot;property1&quot;, &quot;value&quot; + indexVals, PropertyResultType.UserProperty),
								new PropertyResult(&quot;property2&quot;, &quot;value&quot; + (indexVals + 1), PropertyResultType.UserProperty)
							}),
					Children = new List&lt;IPublishedContent&gt;()
				};
			if (createChildren)
			{
				d.Children = new List&lt;IPublishedContent&gt;()
					{
						GetContent(false, indexVals + 3),
						GetContent(false, indexVals + 6),
						GetContent(false, indexVals + 9)
					};
			}
			if (!createChildren)
			{
				//create additional columns, used to test the different columns for child nodes
				d.Properties.Add(new PropertyResult(&quot;property4&quot;, &quot;value&quot; + (indexVals + 2), PropertyResultType.UserProperty));
			}
			else
			{
				d.Properties.Add(new PropertyResult(&quot;property3&quot;, &quot;value&quot; + (indexVals + 2), PropertyResultType.UserProperty));
			}
			return d;
		}

        // note - could probably rewrite those tests using SolidPublishedContentCache
        // l8tr...
	    private class TestPublishedContent : IPublishedContent
	    {
	        public string Url { get; set; }
	        public PublishedItemType ItemType { get; set; }

	        IPublishedContent IPublishedContent.Parent
	        {
	            get { return Parent; }
	        }

	        IEnumerable&lt;IPublishedContent&gt; IPublishedContent.Children
	        {
	            get { return Children; }
	        }

	        public IPublishedContent Parent { get; set; }
	        public int Id { get; set; }
	        public int TemplateId { get; set; }
	        public int SortOrder { get; set; }
	        public string Name { get; set; }
	        public string UrlName { get; set; }
	        public string DocumentTypeAlias { get; set; }
	        public int DocumentTypeId { get; set; }
	        public string WriterName { get; set; }
	        public string CreatorName { get; set; }
	        public int WriterId { get; set; }
	        public int CreatorId { get; set; }
	        public string Path { get; set; }
	        public DateTime CreateDate { get; set; }
	        public DateTime UpdateDate { get; set; }
	        public Guid Version { get; set; }
	        public int Level { get; set; }
            public bool IsDraft { get; set; }
            public int GetIndex() { throw new NotImplementedException();}
            
            public ICollection&lt;IPublishedProperty&gt; Properties { get; set; }

	        public object this[string propertyAlias]
	        {
                get { return GetProperty(propertyAlias).Value; }
	        }

	        public IEnumerable&lt;IPublishedContent&gt; Children { get; set; }

	        public IPublishedProperty GetProperty(string alias)
	        {
	            return Properties.FirstOrDefault(x =&gt; x.PropertyTypeAlias.InvariantEquals(alias));
	        }

	        public IPublishedProperty GetProperty(string alias, bool recurse)
	        {
	            var property = GetProperty(alias);
	            if (recurse == false) return property;

	            IPublishedContent content = this;
	            while (content != null &amp;&amp; (property == null || property.HasValue == false))
	            {
	                content = content.Parent;
	                property = content == null ? null : content.GetProperty(alias);
	            }

	            return property;
	        }

	        public IEnumerable&lt;IPublishedContent&gt; ContentSet
	        {
	            get { throw new NotImplementedException(); }
	        }

            public PublishedContentType ContentType 
            {
                get { throw new NotImplementedException(); }
            }
	    }
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,3,22,4,1],[23,4,23,22,1],[27,13,27,100,1],[28,13,28,79,1],[28,79,28,83,0],[28,83,28,84,1],[28,13,28,84,1],[31,4,32,5,1],[32,5,32,6,1],[32,6,33,6,1],[33,6,37,9,1],[37,9,38,6,1],[38,6,38,23,1],[38,23,39,6,1],[39,6,39,7,1],[39,7,40,7,1],[40,7,40,49,1],[40,49,41,6,1],[41,6,41,7,1],[41,7,43,6,1],[43,6,43,7,0],[43,7,44,7,1],[44,7,44,49,0],[44,49,45,6,1],[45,6,45,7,0],[45,7,48,6,1],[48,6,58,9,1],[58,9,59,6,1],[59,6,59,13,1],[59,13,59,15,1],[59,15,59,20,1],[59,20,59,21,1],[59,21,59,23,1],[59,23,59,24,1],[59,24,59,46,1],[59,46,59,75,1],[59,75,59,76,1],[59,24,59,76,1],[59,76,60,6,1],[60,6,60,7,1],[60,7,61,7,1],[61,7,61,37,1],[61,37,62,6,1],[62,6,62,7,1],[62,7,63,6,1],[63,6,63,23,1],[63,23,64,5,1],[64,5,64,6,1],[64,6,64,7,1],[31,4,64,7,1],[65,4,65,52,1],[68,4,68,59,1],[69,3,69,4,1],[72,3,72,4,1],[73,4,73,20,1],[74,4,74,77,1],[75,4,75,34,1],[76,3,76,4,1],[80,3,80,4,1],[81,4,81,34,1],[82,4,82,35,1],[84,4,84,42,1],[85,4,85,38,1],[86,4,86,56,1],[87,4,87,56,1],[88,4,88,56,1],[89,4,89,56,1],[90,4,90,56,1],[91,4,91,56,1],[92,4,92,57,1],[93,4,93,57,1],[94,4,94,57,1],[95,3,95,4,1],[99,3,99,4,1],[100,4,100,34,1],[102,4,102,87,1],[104,4,104,42,1],[106,4,106,42,1],[107,4,107,38,1],[108,4,108,56,1],[109,4,109,56,1],[110,4,110,56,1],[111,4,111,57,1],[112,4,112,57,1],[113,4,113,57,1],[114,3,114,4,1],[118,3,118,4,1],[119,4,119,35,1],[120,4,120,35,1],[122,4,122,41,1],[123,4,123,38,1],[124,3,124,4,1],[127,3,127,4,1],[128,7,128,66,1],[129,4,155,7,1],[156,4,156,23,1],[157,4,157,5,1],[158,5,163,8,1],[164,4,164,5,1],[165,4,165,24,1],[166,4,166,5,1],[168,5,168,115,1],[169,4,169,5,1],[171,4,171,5,1],[172,5,172,115,1],[173,4,173,5,1],[174,4,174,13,1],[175,3,175,4,1],[181,30,181,34,1],[181,35,181,39,0],[182,46,182,50,0],[182,51,182,55,0],[186,18,186,19,0],[186,20,186,34,0],[186,35,186,36,0],[191,18,191,19,1],[191,20,191,36,1],[191,37,191,38,1],[194,44,194,48,0],[194,49,194,53,1],[195,26,195,30,1],[195,31,195,35,1],[196,34,196,38,0],[196,39,196,43,1],[197,33,197,37,1],[197,38,197,42,1],[198,31,198,35,1],[198,36,198,40,1],[199,34,199,38,0],[199,39,199,43,1],[200,44,200,48,1],[200,49,200,53,1],[201,38,201,42,0],[201,43,201,47,1],[202,37,202,41,1],[202,42,202,46,1],[203,38,203,42,1],[203,43,203,47,1],[204,32,204,36,0],[204,37,204,41,1],[205,33,205,37,0],[205,38,205,42,1],[206,31,206,35,0],[206,36,206,40,1],[207,39,207,43,1],[207,44,207,48,1],[208,39,208,43,1],[208,44,208,48,1],[209,32,209,36,0],[209,37,209,41,1],[210,29,210,33,0],[210,34,210,38,1],[211,35,211,39,0],[211,40,211,44,0],[212,35,212,36,0],[212,37,212,73,0],[214,65,214,69,1],[214,70,214,74,1],[218,21,218,22,0],[218,23,218,63,0],[218,64,218,65,0],[221,59,221,63,1],[221,64,221,68,1],[224,10,224,11,0],[225,14,225,52,0],[225,52,225,94,0],[225,94,225,96,0],[225,14,225,96,0],[226,10,226,11,0],[229,10,229,11,0],[230,14,230,48,0],[231,14,231,35,0],[231,36,231,52,0],[233,14,233,47,0],[234,14,234,89,0],[235,14,235,15,0],[236,18,236,43,0],[237,18,237,81,0],[238,14,238,15,0],[240,14,240,30,0],[241,10,241,11,0],[245,18,245,19,0],[245,20,245,56,0],[250,21,250,22,0],[250,23,250,59,0]]);
    </script>
  </body>
</html>