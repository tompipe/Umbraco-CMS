<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Routing\ContentFinderByLegacy404.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Globalization;
using System.Linq;
using System.Web;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;

namespace Umbraco.Web.Routing
{
	/// &lt;summary&gt;
	/// Provides an implementation of &lt;see cref=&quot;IContentFinder&quot;/&gt; that runs the legacy 404 logic.
	/// &lt;/summary&gt;
	public class ContentFinderByLegacy404 : IContentFinder
	{
		/// &lt;summary&gt;
		/// Tries to find and assign an Umbraco document to a &lt;c&gt;PublishedContentRequest&lt;/c&gt;.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;pcr&quot;&gt;The &lt;c&gt;PublishedContentRequest&lt;/c&gt;.&lt;/param&gt;		
		/// &lt;returns&gt;A value indicating whether an Umbraco document was found and assigned.&lt;/returns&gt;
		public bool TryFindContent(PublishedContentRequest pcr)
		{
			LogHelper.Debug&lt;ContentFinderByLegacy404&gt;(&quot;Looking for a page to handle 404.&quot;);

            // try to find a culture as best as we can
		    var errorCulture = CultureInfo.CurrentUICulture;
		    if (pcr.HasDomain)
		    {
		        errorCulture = CultureInfo.GetCultureInfo(pcr.UmbracoDomain.LanguageIsoCode);
		    }
		    else
		    {
		        var route = pcr.Uri.GetAbsolutePathDecoded();
		        var pos = route.LastIndexOf(&#39;/&#39;);
		        IPublishedContent node = null;
		        while (pos &gt; 1)
		        {
		            route = route.Substring(0, pos);
                    node = pcr.RoutingContext.UmbracoContext.ContentCache.GetByRoute(route);
		            if (node != null) break;
                    pos = route.LastIndexOf(&#39;/&#39;);
                }
		        if (node != null)
		        {
		            var d = DomainHelper.FindWildcardDomainInPath(pcr.RoutingContext.UmbracoContext.Application.Services.DomainService.GetAll(true), node.Path, null);
		            if (d != null &amp;&amp; string.IsNullOrWhiteSpace(d.LanguageIsoCode) == false)
		                errorCulture = CultureInfo.GetCultureInfo(d.LanguageIsoCode);
		        }
            }

            // TODO - replace the whole logic
		    var error404 = NotFoundHandlerHelper.GetCurrentNotFoundPageId(
                //TODO: The IContentSection should be ctor injected into this class in v8!
		        UmbracoConfig.For.UmbracoSettings().Content.Error404Collection.ToArray(),
                pcr.RoutingContext.UmbracoContext.Application.Services.EntityService,
                new PublishedContentQuery(pcr.RoutingContext.UmbracoContext.ContentCache, pcr.RoutingContext.UmbracoContext.MediaCache),
                errorCulture);

			IPublishedContent content = null;

            if (error404.HasValue)
			{
                LogHelper.Debug&lt;ContentFinderByLegacy404&gt;(&quot;Got id={0}.&quot;, () =&gt; error404.Value);

                content = pcr.RoutingContext.UmbracoContext.ContentCache.GetById(error404.Value);

			    LogHelper.Debug&lt;ContentFinderByLegacy404&gt;(content == null
			        ? &quot;Could not find content with that id.&quot;
			        : &quot;Found corresponding content.&quot;);
			}
			else
			{
				LogHelper.Debug&lt;ContentFinderByLegacy404&gt;(&quot;Got nothing.&quot;);
			}

			pcr.PublishedContent = content;
            pcr.SetIs404();
			return content != null;
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,3,22,4,0],[23,4,23,83,0],[26,7,26,55,0],[27,7,27,25,0],[28,7,28,8,0],[29,11,29,88,0],[30,7,30,8,0],[32,7,32,8,0],[33,11,33,56,0],[34,11,34,44,0],[35,11,35,41,0],[36,11,36,26,0],[37,11,37,12,0],[38,15,38,47,0],[39,21,39,93,0],[40,15,40,32,0],[40,33,40,39,0],[41,21,41,50,0],[42,17,42,18,0],[43,11,43,28,0],[44,11,44,12,0],[45,15,45,161,0],[46,15,46,86,0],[47,19,47,80,0],[48,11,48,12,0],[49,13,49,14,0],[52,7,57,31,0],[59,4,59,37,0],[61,13,61,35,0],[62,4,62,5,0],[63,17,63,80,0],[63,80,63,94,0],[63,94,63,96,0],[63,17,63,96,0],[65,17,65,98,0],[67,8,69,46,0],[70,4,70,5,0],[72,4,72,5,0],[73,5,73,63,0],[74,4,74,5,0],[76,4,76,35,0],[77,13,77,28,0],[78,4,78,27,0],[79,3,79,4,0]]);
    </script>
  </body>
</html>