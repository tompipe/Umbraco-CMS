<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\ContentTypeServiceExtensionsTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Services
{
    [TestFixture]
    public class ContentTypeServiceExtensionsTests : BaseUmbracoApplicationTest
    {
        [Test]
        public void GetAvailableCompositeContentTypes_No_Overlap_By_Content_Type_And_Property_Type_Alias()
        {
            Action&lt;string, IContentType&gt; addPropType = (alias, ct) =&gt;
            {
                var contentCollection = new PropertyTypeCollection
                {
                    new PropertyType(Constants.PropertyEditors.TextboxAlias, DataTypeDatabaseType.Ntext) {Alias = alias, Name = &quot;Title&quot;, Description = &quot;&quot;, Mandatory = false, SortOrder = 1, DataTypeDefinitionId = -88}
                };
                var pg = new PropertyGroup(contentCollection) { Name = &quot;test&quot;, SortOrder = 1 };
                ct.PropertyGroups.Add(pg);
            };

            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;, null);
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;, null);
            addPropType(&quot;title&quot;, ct2);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;, null);
            addPropType(&quot;title&quot;, ct3);
            var ct4 = MockedContentTypes.CreateBasicContentType(&quot;ct4&quot;, &quot;CT4&quot;, null);
            var ct5 = MockedContentTypes.CreateBasicContentType(&quot;ct5&quot;, &quot;CT5&quot;, null);
            addPropType(&quot;blah&quot;, ct5);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;
            ct4.Id = 4;
            ct5.Id = 4;

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] { ct1, ct2, ct3, ct4, ct5 },
                new[] { ct2.Alias },
                new[] { &quot;blah&quot; })
                .Results.Where(x =&gt; x.Allowed).Select(x =&gt; x.Composition).ToArray();

            Assert.AreEqual(1, availableTypes.Count());
            Assert.AreEqual(ct4.Id, availableTypes.ElementAt(0).Id);
        }

        [Test]
        public void GetAvailableCompositeContentTypes_No_Overlap_By_Property_Type_Alias()
        {
            Action&lt;IContentType&gt; addPropType = ct =&gt;
            {
                var contentCollection = new PropertyTypeCollection
                {
                    new PropertyType(Constants.PropertyEditors.TextboxAlias, DataTypeDatabaseType.Ntext) {Alias = &quot;title&quot;, Name = &quot;Title&quot;, Description = &quot;&quot;, Mandatory = false, SortOrder = 1, DataTypeDefinitionId = -88}
                };
                var pg = new PropertyGroup(contentCollection) { Name = &quot;test&quot;, SortOrder = 1 };
                ct.PropertyGroups.Add(pg);
            };

            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;, null);
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;, null);
            addPropType(ct2);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;, null);
            addPropType(ct3);
            var ct4 = MockedContentTypes.CreateBasicContentType(&quot;ct4&quot;, &quot;CT4&quot;, null);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;
            ct4.Id = 4;

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] { ct1, ct2, ct3, ct4 },
                new string[] { },
                new[] { &quot;title&quot; })
                .Results.Where(x =&gt; x.Allowed).Select(x =&gt; x.Composition).ToArray();

            Assert.AreEqual(1, availableTypes.Count());
            Assert.AreEqual(ct4.Id, availableTypes.ElementAt(0).Id);
        }

        [Test]
        public void GetAvailableCompositeContentTypes_No_Overlap_By_Content_Type()
        {
            Action&lt;IContentType&gt; addPropType = ct =&gt;
            {
                var contentCollection = new PropertyTypeCollection
                {
                    new PropertyType(Constants.PropertyEditors.TextboxAlias, DataTypeDatabaseType.Ntext) {Alias = &quot;title&quot;, Name = &quot;Title&quot;, Description = &quot;&quot;, Mandatory = false, SortOrder = 1, DataTypeDefinitionId = -88}
                };
                var pg = new PropertyGroup(contentCollection) { Name = &quot;test&quot;, SortOrder = 1 };
                ct.PropertyGroups.Add(pg);
            };

            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;, null);            
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;, null);
            addPropType(ct2);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;, null);
            addPropType(ct3);
            var ct4 = MockedContentTypes.CreateBasicContentType(&quot;ct4&quot;, &quot;CT4&quot;, null);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;
            ct4.Id = 4;

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] { ct1, ct2, ct3, ct4 },
                new [] {ct2.Alias})
                .Results.Where(x =&gt; x.Allowed).Select(x =&gt; x.Composition).ToArray();

            Assert.AreEqual(1, availableTypes.Count());
            Assert.AreEqual(ct4.Id, availableTypes.ElementAt(0).Id);
        }

        [Test]
        public void GetAvailableCompositeContentTypes_Not_Itself()
        {
            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;, null);            
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;, null);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;, null);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] {ct1, ct2, ct3})
                .Results.Where(x =&gt; x.Allowed).Select(x =&gt; x.Composition).ToArray();

            Assert.AreEqual(2, availableTypes.Count());
            Assert.AreEqual(ct2.Id, availableTypes.ElementAt(0).Id);
            Assert.AreEqual(ct3.Id, availableTypes.ElementAt(1).Id);
        }

        //This shows that a nested comp is not allowed
        [Test]
        public void GetAvailableCompositeContentTypes_No_Results_If_Already_A_Composition_By_Parent()
        {
            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;);
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;, ct1);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] { ct1, ct2, ct3 }).Results;

            Assert.AreEqual(0, availableTypes.Count());
        }

        //This shows that a nested comp is not allowed
        [Test]
        public void GetAvailableCompositeContentTypes_No_Results_If_Already_A_Composition()
        {
            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;);
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;

            ct2.AddContentType(ct1);

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] { ct1, ct2, ct3 }).Results;

            Assert.AreEqual(0, availableTypes.Count());
        }

        [Test]
        public void GetAvailableCompositeContentTypes_Do_Not_Include_Other_Composed_Types()
        {
            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;);
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;

            ct2.AddContentType(ct3);

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] { ct1, ct2, ct3 })
                .Results.Where(x =&gt; x.Allowed).Select(x =&gt; x.Composition).ToArray();

            Assert.AreEqual(1, availableTypes.Count());
            Assert.AreEqual(ct3.Id, availableTypes.Single().Id);
        }

        [Test]
        public void GetAvailableCompositeContentTypes_Include_Direct_Composed_Types()
        {
            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;);
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;

            ct1.AddContentType(ct3);

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] { ct1, ct2, ct3 })
                .Results.Where(x =&gt; x.Allowed).Select(x =&gt; x.Composition).ToArray();

            Assert.AreEqual(2, availableTypes.Count());
            Assert.AreEqual(ct2.Id, availableTypes.ElementAt(0).Id);
            Assert.AreEqual(ct3.Id, availableTypes.ElementAt(1).Id);
        }

        [Test]
        public void GetAvailableCompositeContentTypes_Include_Indirect_Composed_Types()
        {
            var ct1 = MockedContentTypes.CreateBasicContentType(&quot;ct1&quot;, &quot;CT1&quot;);
            var ct2 = MockedContentTypes.CreateBasicContentType(&quot;ct2&quot;, &quot;CT2&quot;);
            var ct3 = MockedContentTypes.CreateBasicContentType(&quot;ct3&quot;, &quot;CT3&quot;);
            var ct4 = MockedContentTypes.CreateBasicContentType(&quot;ct4&quot;, &quot;CT4&quot;);
            ct1.Id = 1;
            ct2.Id = 2;
            ct3.Id = 3;
            ct4.Id = 4;

            ct1.AddContentType(ct3);    //ct3 is direct to ct1
            ct3.AddContentType(ct4);    //ct4 is indirect to ct1

            var service = new Mock&lt;IContentTypeService&gt;();

            var availableTypes = service.Object.GetAvailableCompositeContentTypes(
                ct1,
                new[] { ct1, ct2, ct3 })
                .Results.Where(x =&gt; x.Allowed).Select(x =&gt; x.Composition).ToArray();

            Assert.AreEqual(3, availableTypes.Count());
            Assert.AreEqual(ct2.Id, availableTypes.ElementAt(0).Id);
            Assert.AreEqual(ct3.Id, availableTypes.ElementAt(1).Id);
            Assert.AreEqual(ct4.Id, availableTypes.ElementAt(2).Id);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,10,1],[19,13,20,13,1],[20,13,20,14,1],[20,14,21,17,1],[21,17,24,19,1],[24,19,25,17,1],[25,17,25,96,1],[25,96,26,17,1],[26,17,26,43,1],[26,43,27,13,1],[27,13,27,14,1],[27,14,27,15,1],[19,13,27,15,1],[29,13,29,85,1],[30,13,30,85,1],[31,13,31,39,1],[32,13,32,85,1],[33,13,33,39,1],[34,13,34,85,1],[35,13,35,85,1],[36,13,36,38,1],[37,13,37,24,1],[38,13,38,24,1],[39,13,39,24,1],[40,13,40,24,1],[41,13,41,24,1],[43,13,43,59,1],[45,13,50,37,1],[50,37,50,46,1],[50,46,50,60,1],[50,60,50,73,1],[50,73,50,85,1],[45,13,50,85,1],[52,13,52,56,1],[53,13,53,69,1],[54,9,54,10,1],[58,9,58,10,1],[59,13,60,13,1],[60,13,60,14,1],[60,14,61,17,1],[61,17,64,19,1],[64,19,65,17,1],[65,17,65,96,1],[65,96,66,17,1],[66,17,66,43,1],[66,43,67,13,1],[67,13,67,14,1],[67,14,67,15,1],[59,13,67,15,1],[69,13,69,85,1],[70,13,70,85,1],[71,13,71,30,1],[72,13,72,85,1],[73,13,73,30,1],[74,13,74,85,1],[75,13,75,24,1],[76,13,76,24,1],[77,13,77,24,1],[78,13,78,24,1],[80,13,80,59,1],[82,13,87,37,1],[87,37,87,46,1],[87,46,87,60,1],[87,60,87,73,1],[87,73,87,85,1],[82,13,87,85,1],[89,13,89,56,1],[90,13,90,69,1],[91,9,91,10,1],[95,9,95,10,1],[96,13,97,13,1],[97,13,97,14,1],[97,14,98,17,1],[98,17,101,19,1],[101,19,102,17,1],[102,17,102,96,1],[102,96,103,17,1],[103,17,103,43,1],[103,43,104,13,1],[104,13,104,14,1],[104,14,104,15,1],[96,13,104,15,1],[106,13,106,85,1],[107,13,107,85,1],[108,13,108,30,1],[109,13,109,85,1],[110,13,110,30,1],[111,13,111,85,1],[112,13,112,24,1],[113,13,113,24,1],[114,13,114,24,1],[115,13,115,24,1],[117,13,117,59,1],[119,13,123,37,1],[123,37,123,46,1],[123,46,123,60,1],[123,60,123,73,1],[123,73,123,85,1],[119,13,123,85,1],[125,13,125,56,1],[126,13,126,69,1],[127,9,127,10,1],[131,9,131,10,1],[132,13,132,85,1],[133,13,133,85,1],[134,13,134,85,1],[135,13,135,24,1],[136,13,136,24,1],[137,13,137,24,1],[139,13,139,59,1],[141,13,144,37,1],[144,37,144,46,1],[144,46,144,60,1],[144,60,144,73,1],[144,73,144,85,1],[141,13,144,85,1],[146,13,146,56,1],[147,13,147,69,1],[148,13,148,69,1],[149,9,149,10,1],[154,9,154,10,1],[155,13,155,79,1],[156,13,156,84,1],[157,13,157,79,1],[158,13,158,24,1],[159,13,159,24,1],[160,13,160,24,1],[162,13,162,59,1],[164,13,166,50,1],[168,13,168,56,1],[169,9,169,10,1],[174,9,174,10,1],[175,13,175,79,1],[176,13,176,79,1],[177,13,177,79,1],[178,13,178,24,1],[179,13,179,24,1],[180,13,180,24,1],[182,13,182,37,1],[184,13,184,59,1],[186,13,188,50,1],[190,13,190,56,1],[191,9,191,10,1],[195,9,195,10,1],[196,13,196,79,1],[197,13,197,79,1],[198,13,198,79,1],[199,13,199,24,1],[200,13,200,24,1],[201,13,201,24,1],[203,13,203,37,1],[205,13,205,59,1],[207,13,210,37,1],[210,37,210,46,1],[210,46,210,60,1],[210,60,210,73,1],[210,73,210,85,1],[207,13,210,85,1],[212,13,212,56,1],[213,13,213,65,1],[214,9,214,10,1],[218,9,218,10,1],[219,13,219,79,1],[220,13,220,79,1],[221,13,221,79,1],[222,13,222,24,1],[223,13,223,24,1],[224,13,224,24,1],[226,13,226,37,1],[228,13,228,59,1],[230,13,233,37,1],[233,37,233,46,1],[233,46,233,60,1],[233,60,233,73,1],[233,73,233,85,1],[230,13,233,85,1],[235,13,235,56,1],[236,13,236,69,1],[237,13,237,69,1],[238,9,238,10,1],[242,9,242,10,1],[243,13,243,79,1],[244,13,244,79,1],[245,13,245,79,1],[246,13,246,79,1],[247,13,247,24,1],[248,13,248,24,1],[249,13,249,24,1],[250,13,250,24,1],[252,13,252,37,1],[253,13,253,37,1],[255,13,255,59,1],[257,13,260,37,1],[260,37,260,46,1],[260,46,260,60,1],[260,60,260,73,1],[260,73,260,85,1],[257,13,260,85,1],[262,13,262,56,1],[263,13,263,69,1],[264,13,264,69,1],[265,13,265,69,1],[266,9,266,10,1]]);
    </script>
  </body>
</html>