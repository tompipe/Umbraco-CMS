<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\imagecropper\DataEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Text;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Xml;
using umbraco.cms.businesslogic;
using umbraco.cms.businesslogic.media;
using umbraco.cms.businesslogic.member;
using umbraco.cms.businesslogic.property;
using umbraco.cms.businesslogic.web;

namespace umbraco.editorControls.imagecropper
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class DataEditor : PlaceHolder, umbraco.interfaces.IDataEditor
    {
        private umbraco.interfaces.IData data;
        private Config config;
        private XmlDocument _xml;

        public Image imgImage = new Image();
        public HiddenField hdnJson = new HiddenField();
        public HiddenField hdnRaw = new HiddenField();
        public HiddenField hdnSer = new HiddenField();

        public DataEditor(umbraco.interfaces.IData Data, string Configuration)
        {
            data = Data;
            config = new Config(Configuration);
        }

        public virtual bool TreatAsRichTextEditor { get { return false; } }

        public bool ShowLabel { get { return config.ShowLabel; } }

        public Control Editor { get { return this; } }

        protected override void OnInit(EventArgs e)
        {
            this.ID = &quot;ImageCropper&quot;;
            //base.OnInit(e);

            int propertyId = ((umbraco.cms.businesslogic.datatype.DefaultData)data).PropertyId;

            int currentDocumentId = ((umbraco.cms.businesslogic.datatype.DefaultData)data).NodeId;
            Property uploadProperty;

            // we need this ugly code because there&#39;s no way to use a base class
            CMSNode node = new CMSNode(currentDocumentId);
            if (node.nodeObjectType == Document._objectType)
            {
                uploadProperty = new Document(currentDocumentId).getProperty(config.UploadPropertyAlias);
            }
            else if (node.nodeObjectType == umbraco.cms.businesslogic.media.Media._objectType)
            {
                uploadProperty = new Media(currentDocumentId).getProperty(config.UploadPropertyAlias);
            }
            else if (node.nodeObjectType == Member._objectType)
            {
                uploadProperty = new Member(currentDocumentId).getProperty(config.UploadPropertyAlias);
            }
            else
            {
                throw new Exception(&quot;Unsupported Umbraco Node type for Image Cropper (only Document, Media and Members are supported.&quot;);
            }

            // upload property could be null here if the property wasn&#39;t found
            if (uploadProperty != null)
            {
                string relativeImagePath = uploadProperty.Value.ToString();

                ImageInfo imageInfo = new ImageInfo(relativeImagePath);

                imgImage.ImageUrl = relativeImagePath;
                imgImage.ID = String.Format(&quot;cropBox_{0}&quot;, propertyId);

                StringBuilder sbJson = new StringBuilder();
                StringBuilder sbRaw = new StringBuilder();

                try
                {
                    _xml = new XmlDocument();
                    _xml.LoadXml(data.Value.ToString());
                }
                catch
                {
                    _xml = createBaseXmlDocument();
                }

                sbJson.Append(&quot;{ \&quot;current\&quot;: 0, \&quot;crops\&quot;: [&quot;);

                for (int i = 0; i &lt; config.presets.Count; i++)
                {
                    Preset preset = (Preset)config.presets[i];
                    Crop crop;

                    sbJson.Append(&quot;{\&quot;name\&quot;:&#39;&quot; + preset.Name + &quot;&#39;&quot;);

                    sbJson.Append(&quot;,\&quot;config\&quot;:{&quot; +
                                  String.Format(&quot;\&quot;targetWidth\&quot;:{0},\&quot;targetHeight\&quot;:{1},\&quot;keepAspect\&quot;:{2}&quot;,
                                                preset.TargetWidth, preset.TargetHeight,
                                                (preset.KeepAspect ? &quot;true&quot; : &quot;false&quot;) + &quot;}&quot;));

                    if (imageInfo.Exists)
                    {
                        crop = preset.Fit(imageInfo);
                    }
                    else
                    {
                        crop.X = 0;
                        crop.Y = 0;
                        crop.X2 = preset.TargetWidth;
                        crop.Y2 = preset.TargetHeight;
                    }

                    // stored
                    if (_xml.DocumentElement != null &amp;&amp; _xml.DocumentElement.ChildNodes.Count == config.presets.Count)
                    {
                        XmlNode xmlNode = _xml.DocumentElement.ChildNodes[i];

                        int xml_x = Convert.ToInt32(xmlNode.Attributes[&quot;x&quot;].Value);
                        int xml_y = Convert.ToInt32(xmlNode.Attributes[&quot;y&quot;].Value);
                        int xml_x2 = Convert.ToInt32(xmlNode.Attributes[&quot;x2&quot;].Value);
                        int xml_y2 = Convert.ToInt32(xmlNode.Attributes[&quot;y2&quot;].Value);

                        // only use xml values if image is the same and different from defaults (document is stored inbetween image upload and cropping)
                        //if (xml_x2 - xml_x != preset.TargetWidth || xml_y2 - xml_y != preset.TargetHeight)
                        //fileDate == imageInfo.DateStamp &amp;&amp; (

                        if (crop.X != xml_x || crop.X2 != xml_x2 || crop.Y != xml_y || crop.Y2 != xml_y2)
                        {
                            crop.X = xml_x;
                            crop.Y = xml_y;
                            crop.X2 = xml_x2;
                            crop.Y2 = xml_y2;
                        }
                    }

                    sbJson.Append(&quot;,\&quot;value\&quot;:{&quot; + String.Format(&quot;\&quot;x\&quot;:{0},\&quot;y\&quot;:{1},\&quot;x2\&quot;:{2},\&quot;y2\&quot;:{3}&quot;, crop.X, crop.Y, crop.X2, crop.Y2) + &quot;}}&quot;);
                    sbRaw.Append(String.Format(&quot;{0},{1},{2},{3}&quot;, crop.X, crop.Y, crop.X2, crop.Y2));

                    if (i &lt; config.presets.Count - 1)
                    {
                        sbJson.Append(&quot;,&quot;);
                        sbRaw.Append(&quot;;&quot;);
                    }
                }

                sbJson.Append(&quot;]}&quot;);

                hdnJson.Value = sbJson.ToString();
                //hdnJson.ID = String.Format(&quot;json_{0}&quot;, propertyId);
                hdnRaw.Value = sbRaw.ToString();
                //hdnRaw.ID = String.Format(&quot;raw_{0}&quot;, propertyId);

                Controls.Add(imgImage);

                Controls.Add(hdnJson);
                Controls.Add(hdnRaw);

                string imageCropperInitScript =
                    &quot;initImageCropper(&#39;&quot; +
                    imgImage.ClientID + &quot;&#39;, &#39;&quot; +
                    hdnJson.ClientID + &quot;&#39;, &#39;&quot; +
                    hdnRaw.ClientID +
                    &quot;&#39;);&quot;;

                Page.ClientScript.RegisterStartupScript(GetType(), ClientID + &quot;_imageCropper&quot;, imageCropperInitScript, true);
                Page.ClientScript.RegisterClientScriptBlock(Resources.json2Script.GetType(), &quot;json2Script&quot;, Resources.json2Script, true);
                Page.ClientScript.RegisterClientScriptBlock(Resources.jCropCSS.GetType(), &quot;jCropCSS&quot;, Resources.jCropCSS);
                Page.ClientScript.RegisterClientScriptBlock(Resources.jCropScript.GetType(), &quot;jCropScript&quot;, Resources.jCropScript, true);
                Page.ClientScript.RegisterClientScriptBlock(Resources.imageCropperScript.GetType(), &quot;imageCropperScript&quot;, Resources.imageCropperScript, true);

            }

            base.OnInit(e);
        }

        /// &lt;summary&gt;
        /// Store data as string XML (overridden by ToXMl to store &quot;real&quot; XML
        /// XML format:
        /// &lt;crops dateStamp=&quot;&quot;&gt;
        ///     &lt;crop name=&quot;&quot; x=&quot;&quot; y=&quot;&quot; x2=&quot;&quot; y2=&quot;&quot; url=&quot;&quot; /&gt;
        /// &lt;/crops&gt;
        /// &lt;/summary&gt;
        public void Save()
        {
            ImageInfo imageInfo = new ImageInfo(imgImage.ImageUrl);
            if (!imageInfo.Exists)
            {
                data.Value = &quot;&quot;;
            }
            else
            {
                SaveData saveData = new SaveData(hdnRaw.Value);
                data.Value = saveData.Xml(config, imageInfo);
                imageInfo.GenerateThumbnails(saveData, config);
            }
        }

        private static XmlDocument createBaseXmlDocument()
        {
            XmlDocument doc = new XmlDocument();
            XmlNode root = doc.CreateElement(&quot;crops&quot;);
            doc.AppendChild(root);
            return doc;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,45,0],[22,9,22,56,0],[23,9,23,55,0],[24,9,24,55,0],[26,9,26,79,0],[27,9,27,10,0],[28,13,28,25,0],[29,13,29,48,0],[30,9,30,10,0],[32,57,32,58,0],[32,59,32,72,0],[32,73,32,74,0],[34,37,34,38,0],[34,39,34,63,0],[34,64,34,65,0],[36,37,36,38,0],[36,39,36,51,0],[36,52,36,53,0],[39,9,39,10,0],[40,13,40,38,0],[43,13,43,96,0],[45,13,45,99,0],[49,13,49,59,0],[50,13,50,61,0],[51,13,51,14,0],[52,17,52,106,0],[53,13,53,14,0],[54,18,54,95,0],[55,13,55,14,0],[56,17,56,103,0],[57,13,57,14,0],[58,18,58,64,0],[59,13,59,14,0],[60,17,60,104,0],[61,13,61,14,0],[63,13,63,14,0],[64,17,64,137,0],[68,13,68,40,0],[69,13,69,14,0],[70,17,70,76,0],[72,17,72,72,0],[74,17,74,55,0],[75,17,75,72,0],[77,17,77,60,0],[78,17,78,59,0],[81,17,81,18,0],[82,21,82,46,0],[83,21,83,57,0],[84,17,84,18,0],[85,17,85,22,0],[86,17,86,18,0],[87,21,87,52,0],[88,17,88,18,0],[90,17,90,65,0],[92,22,92,31,0],[92,33,92,57,0],[92,59,92,62,0],[93,17,93,18,0],[94,21,94,63,0],[97,21,97,70,0],[99,21,102,96,0],[104,21,104,42,0],[105,21,105,22,0],[106,25,106,54,0],[107,21,107,22,0],[109,21,109,22,0],[110,25,110,36,0],[111,25,111,36,0],[112,25,112,54,0],[113,25,113,55,0],[114,21,114,22,0],[117,21,117,119,0],[118,21,118,22,0],[119,25,119,78,0],[121,25,121,84,0],[122,25,122,84,0],[123,25,123,86,0],[124,25,124,86,0],[130,25,130,106,0],[131,25,131,26,0],[132,29,132,44,0],[133,29,133,44,0],[134,29,134,46,0],[135,29,135,46,0],[136,25,136,26,0],[137,21,137,22,0],[139,21,139,153,0],[140,21,140,102,0],[142,21,142,54,0],[143,21,143,22,0],[144,25,144,44,0],[145,25,145,43,0],[146,21,146,22,0],[147,17,147,18,0],[149,17,149,37,0],[151,17,151,51,0],[153,17,153,49,0],[156,17,156,40,0],[158,17,158,39,0],[159,17,159,38,0],[161,17,166,27,0],[168,17,168,126,0],[169,17,169,138,0],[170,17,170,123,0],[171,17,171,138,0],[172,17,172,159,0],[174,13,174,14,0],[176,13,176,28,0],[177,9,177,10,0],[187,9,187,10,0],[188,13,188,68,0],[189,13,189,35,0],[190,13,190,14,0],[191,17,191,33,0],[192,13,192,14,0],[194,13,194,14,0],[195,17,195,64,0],[196,17,196,62,0],[197,17,197,64,0],[198,13,198,14,0],[199,9,199,10,0],[202,9,202,10,0],[203,13,203,49,0],[204,13,204,55,0],[205,13,205,35,0],[206,13,206,24,0],[207,9,207,10,0]]);
    </script>
  </body>
</html>