<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Core\Persistence\Repositories\RedirectUrlRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Persistence.UnitOfWork;

namespace Umbraco.Core.Persistence.Repositories
{
    internal class RedirectUrlRepository : PetaPocoRepositoryBase&lt;Guid, IRedirectUrl&gt;, IRedirectUrlRepository
    {
        public RedirectUrlRepository(IDatabaseUnitOfWork work, CacheHelper cache, ILogger logger, ISqlSyntaxProvider sqlSyntax)
            : base(work, cache, logger, sqlSyntax)
        { }

        protected override int PerformCount(IQuery&lt;IRedirectUrl&gt; query)
        {
            throw new NotSupportedException(&quot;This repository does not support this method.&quot;);
        }

        protected override bool PerformExists(Guid id)
        {
            return PerformGet(id) != null;
        }

        protected override IRedirectUrl PerformGet(Guid id)
        {
            var sql = GetBaseQuery(false).Where&lt;RedirectUrlDto&gt;(x =&gt; x.Id == id);
            var dto = Database.Fetch&lt;RedirectUrlDto&gt;(SqlSyntax.SelectTop(sql, 1)).FirstOrDefault();
            return dto == null ? null : Map(dto);
        }

        protected override IEnumerable&lt;IRedirectUrl&gt; PerformGetAll(params Guid[] ids)
        {
            if (ids.Length &gt; 2000)
                throw new NotSupportedException(&quot;This repository does not support more than 2000 ids.&quot;);
            var sql = GetBaseQuery(false).WhereIn&lt;RedirectUrlDto&gt;(x =&gt; x.Id, ids);
            var dtos = Database.Fetch&lt;RedirectUrlDto&gt;(sql);
            return dtos.WhereNotNull().Select(Map);
        }

        protected override IEnumerable&lt;IRedirectUrl&gt; PerformGetByQuery(IQuery&lt;IRedirectUrl&gt; query)
        {
            throw new NotSupportedException(&quot;This repository does not support this method.&quot;);
        }

        protected override Sql GetBaseQuery(bool isCount)
        {
            var sql = new Sql();
            if (isCount)
                sql.Select(@&quot;COUNT(*)
FROM umbracoRedirectUrl
JOIN umbracoNode ON umbracoRedirectUrl.contentKey=umbracoNode.uniqueID&quot;);
            else
                sql.Select(@&quot;umbracoRedirectUrl.*, umbracoNode.id AS contentId
FROM umbracoRedirectUrl
JOIN umbracoNode ON umbracoRedirectUrl.contentKey=umbracoNode.uniqueID&quot;);
            return sql;
        }

        protected override string GetBaseWhereClause()
        {
            return &quot;id = @Id&quot;;
        }

        protected override IEnumerable&lt;string&gt; GetDeleteClauses()
        {
            var list = new List&lt;string&gt;
                {
                    &quot;DELETE FROM umbracoRedirectUrl WHERE id = @Id&quot;
                };
            return list;
        }

        protected override Guid NodeObjectTypeId
        {
            get { throw new NotImplementedException(); }
        }

        protected override void PersistNewItem(IRedirectUrl entity)
        {
            var dto = Map(entity);
            Database.Insert(dto);
            entity.Id = entity.Key.GetHashCode();
        }

        protected override void PersistUpdatedItem(IRedirectUrl entity)
        {
            var dto = Map(entity);
            Database.Update(dto);
        }

        private static RedirectUrlDto Map(IRedirectUrl redirectUrl)
        {
            if (redirectUrl == null) return null;

            return new RedirectUrlDto
            {
                Id = redirectUrl.Key,
                ContentKey = redirectUrl.ContentKey,
                CreateDateUtc = redirectUrl.CreateDateUtc,
                Url = redirectUrl.Url,
                UrlHash = redirectUrl.Url.ToSHA1()
            };
        }

        private static IRedirectUrl Map(RedirectUrlDto dto)
        {
            if (dto == null) return null;

            var url = new RedirectUrl();
            try
            {
                url.DisableChangeTracking();
                url.Key = dto.Id;
                url.Id = dto.Id.GetHashCode();
                url.ContentId = dto.ContentId;
                url.ContentKey = dto.ContentKey;
                url.CreateDateUtc = dto.CreateDateUtc;
                url.Url = dto.Url;
                return url;
            }
            finally
            {
                url.EnableChangeTracking();
            }
        }

        public IRedirectUrl Get(string url, Guid contentKey)
        {
            var urlHash = url.ToSHA1();
            var sql = GetBaseQuery(false).Where&lt;RedirectUrlDto&gt;(x =&gt; x.Url == url &amp;&amp; x.UrlHash == urlHash &amp;&amp; x.ContentKey == contentKey);
            var dto = Database.Fetch&lt;RedirectUrlDto&gt;(sql).FirstOrDefault();
            return dto == null ? null : Map(dto);
        }

        public void DeleteAll()
        {
            Database.Execute(&quot;DELETE FROM umbracoRedirectUrl&quot;);
        }

        public void DeleteContentUrls(Guid contentKey)
        {
            Database.Execute(&quot;DELETE FROM umbracoRedirectUrl WHERE contentKey=@contentKey&quot;, new { contentKey });
        }

        public void Delete(Guid id)
        {
            Database.Delete&lt;RedirectUrlDto&gt;(id);
        }

        public IRedirectUrl GetMostRecentUrl(string url)
        {
            var urlHash = url.ToSHA1();
            var sql = GetBaseQuery(false)
                .Where&lt;RedirectUrlDto&gt;(x =&gt; x.Url == url &amp;&amp; x.UrlHash == urlHash)
                .OrderByDescending&lt;RedirectUrlDto&gt;(x =&gt; x.CreateDateUtc, SqlSyntax);
            var dtos = Database.Fetch&lt;RedirectUrlDto&gt;(sql);
            var dto = dtos.FirstOrDefault();
            return dto == null ? null : Map(dto);
        }

        public IEnumerable&lt;IRedirectUrl&gt; GetContentUrls(Guid contentKey)
        {
            var sql = GetBaseQuery(false)
                .Where&lt;RedirectUrlDto&gt;(x =&gt; x.ContentKey == contentKey)
                .OrderByDescending&lt;RedirectUrlDto&gt;(x =&gt; x.CreateDateUtc, SqlSyntax);
            var dtos = Database.Fetch&lt;RedirectUrlDto&gt;(sql);
            return dtos.Select(Map);
        }

        public IEnumerable&lt;IRedirectUrl&gt; GetAllUrls(long pageIndex, int pageSize, out long total)
        {
            var sql = GetBaseQuery(false)
                .OrderByDescending&lt;RedirectUrlDto&gt;(x =&gt; x.CreateDateUtc, SqlSyntax);
            var result = Database.Page&lt;RedirectUrlDto&gt;(pageIndex + 1, pageSize, sql);
            total = Convert.ToInt32(result.TotalItems);
            return result.Items.Select(Map);
        }

        public IEnumerable&lt;IRedirectUrl&gt; GetAllUrls(int rootContentId, long pageIndex, int pageSize, out long total)
        {
            var sql = GetBaseQuery(false)
                .Where(string.Format(&quot;{0}.{1} LIKE @path&quot;, SqlSyntax.GetQuotedTableName(&quot;umbracoNode&quot;), SqlSyntax.GetQuotedColumnName(&quot;path&quot;)), new { path = &quot;%,&quot; + rootContentId + &quot;,%&quot; })
                .OrderByDescending&lt;RedirectUrlDto&gt;(x =&gt; x.CreateDateUtc, SqlSyntax);
            var result = Database.Page&lt;RedirectUrlDto&gt;(pageIndex + 1, pageSize, sql);
            total = Convert.ToInt32(result.TotalItems);

            var rules = result.Items.Select(Map);
            return rules;
        }

        public IEnumerable&lt;IRedirectUrl&gt; SearchUrls(string searchTerm, long pageIndex, int pageSize, out long total)
        {
            var sql = GetBaseQuery(false)
                .Where(string.Format(&quot;{0}.{1} LIKE @url&quot;, SqlSyntax.GetQuotedTableName(&quot;umbracoRedirectUrl&quot;), SqlSyntax.GetQuotedColumnName(&quot;Url&quot;)), new { url = &quot;%&quot; + searchTerm.Trim().ToLowerInvariant() + &quot;%&quot; })
                .OrderByDescending&lt;RedirectUrlDto&gt;(x =&gt; x.CreateDateUtc, SqlSyntax);
            var result = Database.Page&lt;RedirectUrlDto&gt;(pageIndex + 1, pageSize, sql);
            total = Convert.ToInt32(result.TotalItems);

            var rules = result.Items.Select(Map);
            return rules;
        }     
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,15,18,51,1],[19,9,19,10,1],[19,11,19,12,1],[22,9,22,10,0],[23,13,23,94,0],[27,9,27,10,0],[28,13,28,43,0],[29,9,29,10,0],[32,9,32,10,0],[33,13,33,82,0],[34,13,34,100,0],[35,13,35,50,0],[36,9,36,10,0],[39,9,39,10,0],[40,13,40,35,0],[41,17,41,105,0],[42,13,42,83,0],[43,13,43,60,0],[44,13,44,52,0],[45,9,45,10,0],[48,9,48,10,0],[49,13,49,94,0],[53,9,53,10,1],[54,13,54,33,1],[55,13,55,25,1],[56,17,58,74,0],[60,17,62,74,1],[63,13,63,24,1],[64,9,64,10,1],[67,9,67,10,0],[68,13,68,31,0],[69,9,69,10,0],[72,9,72,10,0],[73,13,76,19,0],[77,13,77,25,0],[78,9,78,10,0],[82,17,82,18,0],[82,19,82,55,0],[86,9,86,10,1],[87,13,87,35,1],[88,13,88,34,1],[89,13,89,50,1],[90,9,90,10,1],[93,9,93,10,0],[94,13,94,35,0],[95,13,95,34,0],[96,9,96,10,0],[99,9,99,10,1],[100,13,100,37,1],[100,38,100,50,0],[102,13,109,15,1],[110,9,110,10,1],[113,9,113,10,1],[114,13,114,29,1],[114,30,114,42,0],[116,13,116,41,1],[118,13,118,14,1],[119,17,119,45,1],[120,17,120,34,1],[121,17,121,47,1],[122,17,122,47,1],[123,17,123,49,1],[124,17,124,55,1],[125,17,125,35,1],[126,17,126,28,1],[129,13,129,14,1],[130,17,130,44,1],[131,13,131,14,1],[132,9,132,10,1],[135,9,135,10,0],[136,13,136,40,0],[137,13,137,138,0],[138,13,138,76,0],[139,13,139,50,0],[140,9,140,10,0],[143,9,143,10,0],[144,13,144,64,0],[145,9,145,10,0],[148,9,148,10,1],[149,13,149,113,1],[150,9,150,10,1],[153,9,153,10,0],[154,13,154,49,0],[155,9,155,10,0],[158,9,158,10,1],[159,13,159,40,1],[160,13,162,85,1],[163,13,163,60,1],[164,13,164,45,1],[165,13,165,50,1],[166,9,166,10,1],[169,9,169,10,1],[170,13,172,85,1],[173,13,173,60,1],[174,13,174,37,1],[175,9,175,10,1],[178,9,178,10,0],[179,13,180,85,0],[181,13,181,86,0],[182,13,182,56,0],[183,13,183,45,0],[184,9,184,10,0],[187,9,187,10,0],[188,13,190,85,0],[191,13,191,86,0],[192,13,192,56,0],[194,13,194,50,0],[195,13,195,26,0],[196,9,196,10,0],[199,9,199,10,0],[200,13,202,85,0],[203,13,203,86,0],[204,13,204,56,0],[206,13,206,50,0],[207,13,207,26,0],[208,9,208,10,0]]);
    </script>
  </body>
</html>