<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Cache\MemberGroupCacheRefresher.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web.Script.Serialization;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Models;

using Umbraco.Core.Persistence.Repositories;

namespace Umbraco.Web.Cache
{
    public sealed class MemberGroupCacheRefresher : JsonCacheRefresherBase&lt;MemberGroupCacheRefresher&gt;
    {
        #region Static helpers

        /// &lt;summary&gt;
        /// Converts the json to a JsonPayload object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;json&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static JsonPayload[] DeserializeFromJsonPayload(string json)
        {
            var serializer = new JavaScriptSerializer();
            var jsonObject = serializer.Deserialize&lt;JsonPayload[]&gt;(json);
            return jsonObject;
        }

        /// &lt;summary&gt;
        /// Creates the custom Json payload used to refresh cache amongst the servers
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;groups&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        internal static string SerializeToJsonPayload(params IMemberGroup[] groups)
        {
            var serializer = new JavaScriptSerializer();
            var items = groups.Select(FromMemberGroup).ToArray();
            var json = serializer.Serialize(items);
            return json;
        }

        /// &lt;summary&gt;
        /// Converts a macro to a jsonPayload object
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;group&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static JsonPayload FromMemberGroup(IMemberGroup group)
        {
            if (group == null) return null;

            var payload = new JsonPayload
            {
                Id = group.Id,
                Name = group.Name
            };
            return payload;
        }

        #endregion

        #region Sub classes

        private class JsonPayload
        {
            public string Name { get; set; }
            public int Id { get; set; }
        }

        #endregion

        protected override MemberGroupCacheRefresher Instance
        {
            get { return this; }
        }

        public override Guid UniqueIdentifier
        {
            get { return new Guid(DistributedCache.MemberGroupCacheRefresherId); }
        }

        public override string Name
        {
            get { return &quot;Clears Member Group Cache&quot;; }
        }

        public override void Refresh(string jsonPayload)
        {
            ClearCache(DeserializeFromJsonPayload(jsonPayload));
            base.Refresh(jsonPayload);
        }

        public override void Refresh(int id)
        {
            ClearCache(FromMemberGroup(ApplicationContext.Current.Services.MemberGroupService.GetById(id)));
            base.Refresh(id);
        }

        public override void Remove(int id)
        {
            ClearCache(FromMemberGroup(ApplicationContext.Current.Services.MemberGroupService.GetById(id)));
            base.Remove(id);
        }

        private void ClearCache(params JsonPayload[] payloads)
        {
            if (payloads == null) return;

            var memberGroupCache = ApplicationContext.Current.ApplicationCache.IsolatedRuntimeCache.GetCache&lt;IMemberGroup&gt;();
            payloads.ForEach(payload =&gt;
            {
                if (payload != null &amp;&amp; memberGroupCache)
                {
                    memberGroupCache.Result.ClearCacheByKeySearch(string.Format(&quot;{0}.{1}&quot;, typeof(IMemberGroup).FullName, payload.Name));
                    memberGroupCache.Result.ClearCacheItem(RepositoryBase.GetCacheIdKey&lt;IMemberGroup&gt;(payload.Id));
                }                
            });
            
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,0],[23,13,23,57,0],[24,13,24,74,0],[25,13,25,31,0],[26,9,26,10,0],[34,9,34,10,0],[35,13,35,57,0],[36,13,36,66,0],[37,13,37,52,0],[38,13,38,25,0],[39,9,39,10,0],[47,9,47,10,0],[48,13,48,31,0],[48,32,48,44,0],[50,13,54,15,0],[55,13,55,28,0],[56,9,56,10,0],[64,34,64,38,0],[64,39,64,43,0],[65,29,65,33,0],[65,34,65,38,0],[72,17,72,18,0],[72,19,72,31,0],[72,32,72,33,0],[77,17,77,18,0],[77,19,77,81,0],[77,82,77,83,0],[82,17,82,18,0],[82,19,82,54,0],[82,55,82,56,0],[86,9,86,10,0],[87,13,87,65,0],[88,13,88,39,0],[89,9,89,10,0],[92,9,92,10,0],[93,13,93,109,0],[94,13,94,30,0],[95,9,95,10,0],[98,9,98,10,0],[99,13,99,109,0],[100,13,100,29,0],[101,9,101,10,0],[104,9,104,10,0],[105,13,105,34,0],[105,35,105,42,0],[107,13,107,126,0],[108,13,109,13,0],[109,13,109,14,0],[109,14,110,17,0],[110,17,110,57,0],[110,57,111,17,0],[111,17,111,18,0],[111,18,112,21,0],[112,21,112,138,0],[112,138,113,21,0],[113,21,113,116,0],[113,116,114,17,0],[114,17,114,18,0],[114,18,115,13,0],[115,13,115,14,0],[115,14,115,16,0],[108,13,115,16,0],[117,9,117,10,0]]);
    </script>
  </body>
</html>