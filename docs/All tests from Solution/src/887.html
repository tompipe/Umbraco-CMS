<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Trees\ApplicationTreeRegistrar.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Xml.Linq;
using Umbraco.Core;
using Umbraco.Core.Models;
using umbraco.businesslogic;
using Umbraco.Core.Services;

namespace Umbraco.Web.Trees
{
    /// &lt;summary&gt;
    /// A startup handler for putting the tree config in the config file based on attributes found
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    /// TODO: This is really not a very ideal process but the code is found here because tree plugins are in the Web project or the legacy business logic project.
    /// Moving forward we can put the base tree plugin classes in the core and then this can all just be taken care of normally within the service.
    /// &lt;/remarks&gt;
    public sealed class ApplicationTreeRegistrar : ApplicationEventHandler
    {
        protected override void ApplicationStarted(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            //Call initialize on the tree service with the lazy enumerable class below, when the tree service needs to resolve,
            // it will lazily do the scanning and comparing so it&#39;s not actually done on app start.
            applicationContext.Services.ApplicationTreeService.Intitialize(new LazyEnumerableTrees());
        }

        /// &lt;summary&gt;
        /// This class is here so that we can provide lazy access to tree scanning for when it is needed
        /// &lt;/summary&gt;
        private class LazyEnumerableTrees : IEnumerable&lt;ApplicationTree&gt;
        {
            public LazyEnumerableTrees()
            {
                _lazyTrees = new Lazy&lt;IEnumerable&lt;ApplicationTree&gt;&gt;(() =&gt;
                {
                    var added = new List&lt;string&gt;();

                    // Load all Controller Trees by attribute
                    var types = PluginManager.Current.ResolveAttributedTreeControllers();
                    //convert them to ApplicationTree instances
                    var items = types
                        .Select(x =&gt;
                                new Tuple&lt;Type, TreeAttribute&gt;(x, x.GetCustomAttributes&lt;TreeAttribute&gt;(false).Single()))
                        .Select(x =&gt; new ApplicationTree(x.Item2.Initialize, x.Item2.SortOrder, x.Item2.ApplicationAlias, x.Item2.Alias, x.Item2.Title, x.Item2.IconClosed, x.Item2.IconOpen, x.Item1.GetFullNameWithAssembly()))
                        .ToArray();

                    added.AddRange(items.Select(x =&gt; x.Alias));

                    //find the legacy trees
                    var legacyTreeTypes = PluginManager.Current.ResolveAttributedTrees();
                    //convert them to ApplicationTree instances
                    var legacyItems = legacyTreeTypes
                        .Select(x =&gt;
                            new Tuple&lt;Type, global::umbraco.businesslogic.TreeAttribute, ObsoleteAttribute&gt;(
                                x,
                                x.GetCustomAttributes&lt;global::umbraco.businesslogic.TreeAttribute&gt;(false).SingleOrDefault(),
                                x.GetCustomAttributes&lt;ObsoleteAttribute&gt;(false).SingleOrDefault()))
                        //ensure that the legacy tree attribute exists
                        .Where(x =&gt; x.Item2 != null)
                        //ensure that it&#39;s not obsoleted, any obsoleted tree will not be auto added to the config
                        .Where(x =&gt; x.Item3 == null)
                        //make sure the legacy tree isn&#39;t added on top of the controller tree!        
                        .Where(x =&gt; added.InvariantContains(x.Item2.Alias) == false)
                        .Select(x =&gt; new ApplicationTree(x.Item2.Initialize, x.Item2.SortOrder, x.Item2.ApplicationAlias, x.Item2.Alias, x.Item2.Title, x.Item2.IconClosed, x.Item2.IconOpen, x.Item1.GetFullNameWithAssembly()));

                    return items.Concat(legacyItems).ToArray();
                });
            }

            private readonly Lazy&lt;IEnumerable&lt;ApplicationTree&gt;&gt; _lazyTrees;

            /// &lt;summary&gt;
            /// Returns an enumerator that iterates through the collection.
            /// &lt;/summary&gt;
            /// &lt;returns&gt;
            /// A &lt;see cref=&quot;T:System.Collections.Generic.IEnumerator`1&quot;/&gt; that can be used to iterate through the collection.
            /// &lt;/returns&gt;
            public IEnumerator&lt;ApplicationTree&gt; GetEnumerator()
            {
                return _lazyTrees.Value.GetEnumerator();
            }

            /// &lt;summary&gt;
            /// Returns an enumerator that iterates through a collection.
            /// &lt;/summary&gt;
            /// &lt;returns&gt;
            /// An &lt;see cref=&quot;T:System.Collections.IEnumerator&quot;/&gt; object that can be used to iterate through the collection.
            /// &lt;/returns&gt;
            IEnumerator IEnumerable.GetEnumerator()
            {
                return GetEnumerator();
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,0],[26,13,26,103,0],[27,9,27,10,0],[34,13,34,41,0],[35,13,35,14,0],[36,17,37,17,0],[37,17,37,18,0],[37,18,38,21,0],[38,21,38,52,0],[38,52,41,21,0],[41,21,41,90,0],[41,90,43,21,0],[43,21,45,33,0],[45,33,45,120,0],[45,120,46,38,0],[46,38,46,225,0],[46,225,47,36,0],[43,21,47,36,0],[47,36,49,21,0],[49,21,49,54,0],[49,54,49,61,0],[49,61,49,64,0],[49,21,49,64,0],[49,64,52,21,0],[52,21,52,90,0],[52,90,54,21,0],[54,21,56,29,0],[56,29,59,99,0],[59,99,61,37,0],[61,37,61,52,0],[61,52,63,37,0],[63,37,63,52,0],[63,52,65,37,0],[65,37,65,84,0],[65,84,66,38,0],[66,38,66,225,0],[66,225,66,227,0],[54,21,66,227,0],[66,227,68,21,0],[68,21,68,64,0],[68,64,69,17,0],[69,17,69,18,0],[69,18,69,20,0],[36,17,69,20,0],[70,13,70,14,0],[81,13,81,14,0],[82,17,82,57,0],[83,13,83,14,0],[92,13,92,14,0],[93,17,93,40,0],[94,13,94,14,0]]);
    </script>
  </body>
</html>