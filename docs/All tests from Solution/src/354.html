<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\RedirectUrlRepositoryTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class RedirectUrlRepositoryTests : BaseDatabaseFactoryTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
            CreateTestData();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        [Test]
        public void CanSaveAndGet()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);

            using (var uow = provider.GetUnitOfWork())
            using (var repo = CreateRepository(uow))
            {
                var rurl = new RedirectUrl
                {
                    ContentKey = _textpage.Key,
                    Url = &quot;blah&quot;
                };
                repo.AddOrUpdate(rurl);
                uow.Commit();

                Assert.AreNotEqual(0, rurl.Id);
            }

            using (var uow = provider.GetUnitOfWork())
            using (var repo = CreateRepository(uow))
            {
                var rurl = repo.GetMostRecentUrl(&quot;blah&quot;);
                uow.Commit();

                Assert.IsNotNull(rurl);
                Assert.AreEqual(_textpage.Id, rurl.ContentId);
            }
        }

        [Test]
        public void CanSaveAndGetMostRecent()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);

            Assert.AreNotEqual(_textpage.Id, _otherpage.Id);

            using (var uow = provider.GetUnitOfWork())
            using (var repo = CreateRepository(uow))
            {
                var rurl = new RedirectUrl
                {
                    ContentKey = _textpage.Key,
                    Url = &quot;blah&quot;
                };
                repo.AddOrUpdate(rurl);
                uow.Commit();

                Assert.AreNotEqual(0, rurl.Id);

                // fixme - too fast = same date = key violation?
                // and... can that happen in real life?
                // we don&#39;t really *care* about the IX, only supposed to make things faster...
                // BUT in realife we AddOrUpdate in a trx so it should be safe, always

                rurl = new RedirectUrl
                {
                    ContentKey = _otherpage.Key,
                    Url = &quot;blah&quot;,
                    CreateDateUtc = rurl.CreateDateUtc.AddSeconds(1) // ensure time difference
                };
                repo.AddOrUpdate(rurl);
                uow.Commit();

                Assert.AreNotEqual(0, rurl.Id);
            }

            using (var uow = provider.GetUnitOfWork())
            using (var repo = CreateRepository(uow))
            {
                var rurl = repo.GetMostRecentUrl(&quot;blah&quot;);
                uow.Commit();

                Assert.IsNotNull(rurl);
                Assert.AreEqual(_otherpage.Id, rurl.ContentId);
            }
        }

        [Test]
        public void CanSaveAndGetByContent()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);

            using (var uow = provider.GetUnitOfWork())
            using (var repo = CreateRepository(uow))
            {
                var rurl = new RedirectUrl
                {
                    ContentKey = _textpage.Key,
                    Url = &quot;blah&quot;
                };
                repo.AddOrUpdate(rurl);
                uow.Commit();

                Assert.AreNotEqual(0, rurl.Id);

                // fixme - goes too fast and bam, errors, first is blah

                rurl = new RedirectUrl
                {
                    ContentKey = _textpage.Key,
                    Url = &quot;durg&quot;,
                    CreateDateUtc = rurl.CreateDateUtc.AddSeconds(1) // ensure time difference
                };
                repo.AddOrUpdate(rurl);
                uow.Commit();

                Assert.AreNotEqual(0, rurl.Id);
            }

            using (var uow = provider.GetUnitOfWork())
            using (var repo = CreateRepository(uow))
            {
                var rurls = repo.GetContentUrls(_textpage.Key).ToArray();
                uow.Commit();

                Assert.AreEqual(2, rurls.Length);
                Assert.AreEqual(&quot;durg&quot;, rurls[0].Url);
                Assert.AreEqual(&quot;blah&quot;, rurls[1].Url);
            }
        }

        [Test]
        public void CanSaveAndDelete()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);

            using (var uow = provider.GetUnitOfWork())
            using (var repo = CreateRepository(uow))
            {
                var rurl = new RedirectUrl
                {
                    ContentKey = _textpage.Key,
                    Url = &quot;blah&quot;
                };
                repo.AddOrUpdate(rurl);
                uow.Commit();

                Assert.AreNotEqual(0, rurl.Id);

                rurl = new RedirectUrl
                {
                    ContentKey = _otherpage.Key,
                    Url = &quot;durg&quot;
                };
                repo.AddOrUpdate(rurl);
                uow.Commit();

                Assert.AreNotEqual(0, rurl.Id);
            }

            using (var uow = provider.GetUnitOfWork())
            using (var repo = CreateRepository(uow))
            {
                repo.DeleteContentUrls(_textpage.Key);
                uow.Commit();

                var rurls = repo.GetContentUrls(_textpage.Key);

                Assert.AreEqual(0, rurls.Count());
            }
        }

        private IRedirectUrlRepository CreateRepository(IDatabaseUnitOfWork uow)
        {
            return new RedirectUrlRepository(uow, CacheHelper.CreateDisabledCacheHelper(), Logger, SqlSyntax);
        }

        private IContent _textpage, _subpage, _otherpage, _trashed;

        public void CreateTestData()
        {
            //Create and Save ContentType &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed)
            var contentType = MockedContentTypes.CreateSimpleContentType(&quot;umbTextpage&quot;, &quot;Textpage&quot;);
            contentType.Key = Guid.NewGuid();
            ServiceContext.ContentTypeService.Save(contentType);

            //Create and Save Content &quot;Homepage&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 1)
            _textpage = MockedContent.CreateSimpleContent(contentType);
            _textpage.Key = Guid.NewGuid();
            ServiceContext.ContentService.Save(_textpage);

            //Create and Save Content &quot;Text Page 1&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 2)
            _subpage = MockedContent.CreateSimpleContent(contentType, &quot;Text Page 1&quot;, _textpage.Id);
            _subpage.Key = Guid.NewGuid();
            ServiceContext.ContentService.Save(_subpage);

            //Create and Save Content &quot;Text Page 1&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 3)
            _otherpage = MockedContent.CreateSimpleContent(contentType, &quot;Text Page 2&quot;, _textpage.Id);
            _otherpage.Key = Guid.NewGuid();
            ServiceContext.ContentService.Save(_otherpage);

            //Create and Save Content &quot;Text Page Deleted&quot; based on &quot;umbTextpage&quot; -&gt; (NodeDto.NodeIdSeed + 4)
            _trashed = MockedContent.CreateSimpleContent(contentType, &quot;Text Page Deleted&quot;, -20);
            _trashed.Key = Guid.NewGuid();
            ((Content) _trashed).Trashed = true;
            ServiceContext.ContentService.Save(_trashed);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[19,9,19,10,1],[20,13,20,31,1],[21,13,21,30,1],[22,9,22,10,1],[26,9,26,10,1],[27,13,27,29,1],[28,9,28,10,1],[32,9,32,10,1],[33,13,33,67,1],[35,20,35,54,1],[36,20,36,52,1],[37,13,37,14,1],[38,17,42,19,1],[43,17,43,40,1],[44,17,44,30,1],[46,17,46,48,1],[47,13,47,14,1],[49,20,49,54,1],[50,20,50,52,1],[51,13,51,14,1],[52,17,52,58,1],[53,17,53,30,1],[55,17,55,40,1],[56,17,56,63,1],[57,13,57,14,1],[58,9,58,10,1],[62,9,62,10,1],[63,13,63,67,1],[65,13,65,61,1],[67,20,67,54,1],[68,20,68,52,1],[69,13,69,14,1],[70,17,74,19,1],[75,17,75,40,1],[76,17,76,30,1],[78,17,78,48,1],[85,17,90,19,1],[91,17,91,40,1],[92,17,92,30,1],[94,17,94,48,1],[95,13,95,14,1],[97,20,97,54,1],[98,20,98,52,1],[99,13,99,14,1],[100,17,100,58,1],[101,17,101,30,1],[103,17,103,40,1],[104,17,104,64,1],[105,13,105,14,1],[106,9,106,10,1],[110,9,110,10,1],[111,13,111,67,1],[113,20,113,54,1],[114,20,114,52,1],[115,13,115,14,1],[116,17,120,19,1],[121,17,121,40,1],[122,17,122,30,1],[124,17,124,48,1],[128,17,133,19,1],[134,17,134,40,1],[135,17,135,30,1],[137,17,137,48,1],[138,13,138,14,1],[140,20,140,54,1],[141,20,141,52,1],[142,13,142,14,1],[143,17,143,74,1],[144,17,144,30,1],[146,17,146,50,1],[147,17,147,55,1],[148,17,148,55,1],[149,13,149,14,1],[150,9,150,10,1],[154,9,154,10,1],[155,13,155,67,1],[157,20,157,54,1],[158,20,158,52,1],[159,13,159,14,1],[160,17,164,19,1],[165,17,165,40,1],[166,17,166,30,1],[168,17,168,48,1],[170,17,174,19,1],[175,17,175,40,1],[176,17,176,30,1],[178,17,178,48,1],[179,13,179,14,1],[181,20,181,54,1],[182,20,182,52,1],[183,13,183,14,1],[184,17,184,55,1],[185,17,185,30,1],[187,17,187,64,1],[189,17,189,51,1],[190,13,190,14,1],[191,9,191,10,1],[194,9,194,10,1],[195,13,195,111,1],[196,9,196,10,1],[201,9,201,10,1],[203,13,203,101,1],[204,13,204,46,1],[205,13,205,65,1],[208,13,208,72,1],[209,13,209,44,1],[210,13,210,59,1],[213,13,213,100,1],[214,13,214,43,1],[215,13,215,58,1],[218,13,218,102,1],[219,13,219,45,1],[220,13,220,60,1],[223,13,223,97,1],[224,13,224,43,1],[225,13,225,49,1],[226,13,226,58,1],[227,9,227,10,1]]);
    </script>
  </body>
</html>