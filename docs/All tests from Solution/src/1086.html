<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Mvc\MasterControllerFactory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Web.Mvc;
using System.Web.Routing;
using Umbraco.Core;

namespace Umbraco.Web.Mvc
{
    /// &lt;summary&gt;
	/// A controller factory which uses an internal list of &lt;see cref=&quot;IFilteredControllerFactory&quot;/&gt; in order to invoke 
	/// different controller factories dependent upon their implementation of &lt;see cref=&quot;IFilteredControllerFactory.CanHandle&quot;/&gt; for the current
	/// request. Allows circumvention of MVC3&#39;s singly registered IControllerFactory.
	/// &lt;/summary&gt;
	/// &lt;remarks&gt;&lt;/remarks&gt;
	internal class MasterControllerFactory : DefaultControllerFactory
	{
		private readonly FilteredControllerFactoriesResolver _slaveFactories;

		public MasterControllerFactory(FilteredControllerFactoriesResolver factoryResolver)
		{
			_slaveFactories = factoryResolver;
		}

		/// &lt;summary&gt;
		/// Creates the specified controller by using the specified request context.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;requestContext&quot;&gt;The context of the HTTP request, which includes the HTTP context and route data.&lt;/param&gt;
		/// &lt;param name=&quot;controllerName&quot;&gt;The name of the controller.&lt;/param&gt;
		/// &lt;returns&gt;The controller.&lt;/returns&gt;
		/// &lt;exception cref=&quot;T:System.ArgumentNullException&quot;&gt;The &lt;paramref name=&quot;requestContext&quot;/&gt; parameter is null.&lt;/exception&gt;
		///   
		/// &lt;exception cref=&quot;T:System.ArgumentException&quot;&gt;The &lt;paramref name=&quot;controllerName&quot;/&gt; parameter is null or empty.&lt;/exception&gt;
		/// &lt;remarks&gt;&lt;/remarks&gt;
		public override IController CreateController(RequestContext requestContext, string controllerName)
		{
			var factory = _slaveFactories.Factories.FirstOrDefault(x =&gt; x.CanHandle(requestContext));
			return factory != null
			       	? factory.CreateController(requestContext, controllerName)
			       	: base.CreateController(requestContext, controllerName);
		}

        /// &lt;summary&gt;
        /// Retrieves the controller type for the specified name and request context.
        /// &lt;/summary&gt;
        /// 
        /// &lt;returns&gt;
        /// The controller type.
        /// &lt;/returns&gt;
        /// &lt;param name=&quot;requestContext&quot;&gt;The context of the HTTP request, which includes the HTTP context and route data.&lt;/param&gt;
        /// &lt;param name=&quot;controllerName&quot;&gt;The name of the controller.&lt;/param&gt;
        internal Type GetControllerTypeInternal(RequestContext requestContext, string controllerName)
        {
            var factory = _slaveFactories.Factories.FirstOrDefault(x =&gt; x.CanHandle(requestContext));
            if (factory != null)
            {
                //check to see if the factory is of type UmbracoControllerFactory which exposes the GetControllerType method so we don&#39;t have to create
                // an instance of the controller to figure out what it is. This is a work around for not having a breaking change for:
                // http://issues.umbraco.org/issue/U4-1726

                var umbFactory = factory as UmbracoControllerFactory;
                if (umbFactory != null)
                {
                    return umbFactory.GetControllerType(requestContext, controllerName);
                }
                //we have no choice but to instantiate the controller
                var instance = factory.CreateController(requestContext, controllerName);
                if (instance != null)
                {
                    return instance.GetType();    
                }
                return null;
            }

            return base.GetControllerType(requestContext, controllerName);
        }

		/// &lt;summary&gt;
		/// Releases the specified controller.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;controller&quot;&gt;The controller to release.&lt;/param&gt;
		/// &lt;remarks&gt;&lt;/remarks&gt;
		public override void ReleaseController(IController controller)
		{
			bool released = false;
				if (controller is Controller)
				{
					var requestContext = ((Controller)controller).ControllerContext.RequestContext;
					var factory = _slaveFactories.Factories.FirstOrDefault(x =&gt; x.CanHandle(requestContext));
					if (factory != null)
					{
						factory.ReleaseController(controller);
						released = true;
					}
				}
				if (!released) base.ReleaseController(controller);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,3,22,86,0],[23,3,23,4,0],[24,4,24,38,0],[25,3,25,4,0],[38,3,38,4,0],[39,4,39,64,0],[39,64,39,91,0],[39,91,39,93,0],[39,4,39,93,0],[40,4,42,68,0],[43,3,43,4,0],[55,9,55,10,0],[56,13,56,73,0],[56,73,56,100,0],[56,100,56,102,0],[56,13,56,102,0],[57,13,57,33,0],[58,13,58,14,0],[63,17,63,70,0],[64,17,64,40,0],[65,17,65,18,0],[66,21,66,89,0],[69,17,69,89,0],[70,17,70,38,0],[71,17,71,18,0],[72,21,72,47,0],[74,17,74,29,0],[77,13,77,75,0],[78,9,78,10,0],[86,3,86,4,0],[87,4,87,26,0],[88,5,88,34,0],[89,5,89,6,0],[90,6,90,85,0],[91,6,91,66,0],[91,66,91,93,0],[91,93,91,95,0],[91,6,91,95,0],[92,6,92,26,0],[93,6,93,7,0],[94,7,94,45,0],[95,7,95,23,0],[96,6,96,7,0],[97,5,97,6,0],[98,5,98,19,0],[98,20,98,55,0],[99,3,99,4,0]]);
    </script>
  </body>
</html>