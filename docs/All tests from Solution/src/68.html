<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Macros\MacroTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Web.Caching;
using System.Web.UI;
using System.Web.UI.WebControls;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Cache;
using Umbraco.Core.Logging;
using Umbraco.Core.Profiling;
using umbraco;
using umbraco.cms.businesslogic.macro;
using Umbraco.Core.Configuration;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Macros
{
    [TestFixture]
    public class MacroTests
    {

        [SetUp]
        public void Setup()
        {
            //we DO want cache enabled for these tests
            var cacheHelper = new CacheHelper(
                new ObjectCacheRuntimeCacheProvider(),
                new StaticCacheProvider(),
                new NullCacheProvider(),
                new IsolatedRuntimeCache(type =&gt; new ObjectCacheRuntimeCacheProvider()));
            ApplicationContext.Current = new ApplicationContext(cacheHelper, new ProfilingLogger(Mock.Of&lt;ILogger&gt;(), Mock.Of&lt;IProfiler&gt;()));

            UmbracoConfig.For.SetUmbracoSettings(SettingsForTests.GetDefault());
        }

        [TearDown]
        public void TearDown()
        {
            ApplicationContext.Current.ApplicationCache.RuntimeCache.ClearAllCache();
            ApplicationContext.Current.DisposeIfDisposable();
            ApplicationContext.Current = null;
        }

        [TestCase(&quot;123&quot;, &quot;IntProp&quot;, typeof(int))]
        [TestCase(&quot;Hello&quot;, &quot;StringProp&quot;, typeof(string))]
        [TestCase(&quot;123456789.01&quot;, &quot;DoubleProp&quot;, typeof(double))]
        [TestCase(&quot;1234567&quot;, &quot;FloatProp&quot;, typeof(float))]
        [TestCase(&quot;1&quot;, &quot;BoolProp&quot;, typeof(bool))]
        [TestCase(&quot;true&quot;, &quot;BoolProp&quot;, typeof(bool))]
        [TestCase(&quot;0&quot;, &quot;BoolProp&quot;, typeof(bool))]
        [TestCase(&quot;false&quot;, &quot;BoolProp&quot;, typeof(bool))]
        [TestCase(&quot;2001-05-10&quot;, &quot;DateProp&quot;, typeof(DateTime))]
        [TestCase(&quot;123px&quot;, &quot;UnitProp&quot;, typeof(Unit))]
        [TestCase(&quot;456pt&quot;, &quot;UnitProp&quot;, typeof(Unit))]
        [TestCase(&quot;CEC063D3-D73E-4B7D-93ED-7F69CA9BF2D0&quot;, &quot;GuidProp&quot;, typeof(Guid))]
        [TestCase(&quot;CEC063D3D73E4B7D93ED7F69CA9BF2D0&quot;, &quot;GuidProp&quot;, typeof(Guid))]
        [TestCase(&quot;&quot;, &quot;NullDateProp&quot;, typeof(DateTime?))]
        [TestCase(&quot;2001-05-10&quot;, &quot;NullDateProp&quot;, typeof(DateTime?))]
        [TestCase(&quot;&quot;, &quot;NullUnitProp&quot;, typeof(Unit?))]
        [TestCase(&quot;456pt&quot;, &quot;NullUnitProp&quot;, typeof(Unit?))]
        public void SetUserControlProperty(string val, string macroPropName, Type convertTo)
        {
            var ctrl = new UserControlTest();
            var macroModel = new MacroModel(&quot;test&quot;, &quot;test&quot;, &quot;&quot;, &quot;~/usercontrols/menu.ascx&quot;, &quot;&quot;, &quot;&quot;, 0, false, false);
            macroModel.Properties.Add(new MacroPropertyModel(macroPropName, val));

            macro.UpdateControlProperties(ctrl, macroModel);

            var ctrlType = ctrl.GetType();
            var prop = ctrlType.GetProperty(macroPropName);
            var converted = val.TryConvertTo(convertTo);

            Assert.IsTrue(converted.Success);
            Assert.NotNull(prop);
            Assert.AreEqual(converted.Result, prop.GetValue(ctrl));
        }

        [TestCase(&quot;text.xslt&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;XSLT&quot;)]
        [TestCase(&quot;&quot;, &quot;razor-script.cshtml&quot;, &quot;&quot;, &quot;&quot;, &quot;Script&quot;)]
        [TestCase(&quot;&quot;, &quot;~/Views/MacroPartials/test.cshtml&quot;, &quot;&quot;, &quot;&quot;, &quot;PartialView&quot;)]
        [TestCase(&quot;&quot;, &quot;~/App_Plugins/MyPackage/Views/MacroPartials/test.cshtml&quot;, &quot;&quot;, &quot;&quot;, &quot;PartialView&quot;)]
        [TestCase(&quot;&quot;, &quot;&quot;, &quot;~/usercontrols/menu.ascx&quot;, &quot;&quot;, &quot;UserControl&quot;)]
        [TestCase(&quot;&quot;, &quot;&quot;, &quot;~/usercontrols/Header.ASCX&quot;, &quot;&quot;, &quot;UserControl&quot;)]
        [TestCase(&quot;&quot;, &quot;&quot;, &quot;MyNamespace.MyCustomControl&quot;, &quot;MyAssembly&quot;, &quot;CustomControl&quot;)]
        [TestCase(&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;Unknown&quot;)]
        public void Determine_Macro_Type(string xslt, string scriptFile, string scriptType, string scriptAssembly, string expectedType)
        {
            var expected = Enum&lt;MacroTypes&gt;.Parse(expectedType);
            Assert.AreEqual(expected, Macro.FindMacroType(xslt, scriptFile, scriptType, scriptAssembly));
        }

        [TestCase(&quot;text.xslt&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;~/xslt/text.xslt&quot;)]
        [TestCase(&quot;&quot;, &quot;razor-script.cshtml&quot;, &quot;&quot;, &quot;&quot;, &quot;~/macroScripts/razor-script.cshtml&quot;)]
        [TestCase(&quot;&quot;, &quot;~/Views/MacroPartials/test.cshtml&quot;, &quot;&quot;, &quot;&quot;, &quot;~/Views/MacroPartials/test.cshtml&quot;)]
        [TestCase(&quot;&quot;, &quot;~/App_Plugins/MyPackage/Views/MacroPartials/test.cshtml&quot;, &quot;&quot;, &quot;&quot;, &quot;~/App_Plugins/MyPackage/Views/MacroPartials/test.cshtml&quot;)]
        [TestCase(&quot;&quot;, &quot;&quot;, &quot;~/usercontrols/menu.ascx&quot;, &quot;&quot;, &quot;~/usercontrols/menu.ascx&quot;)]
        public void Get_Macro_File(string xslt, string scriptFile, string scriptType, string scriptAssembly, string expectedResult)
        {
            var model = new MacroModel(&quot;Test&quot;, &quot;test&quot;, scriptAssembly, scriptType, xslt, scriptFile, 0, false, false);
            var file = macro.GetMacroFile(model);
            Assert.AreEqual(expectedResult, file);
        }

        [TestCase(&quot;XSLT&quot;, true)]
        [TestCase(&quot;Script&quot;, true)]
        [TestCase(&quot;PartialView&quot;, true)]
        [TestCase(&quot;UserControl&quot;, true)]
        [TestCase(&quot;CustomControl&quot;, false)]
        [TestCase(&quot;Python&quot;, true)]
        [TestCase(&quot;Unknown&quot;, false)]
        public void Macro_Is_File_Based(string macroType, bool expectedResult)
        {
            var mType = Enum&lt;MacroTypes&gt;.Parse(macroType);
            var model = new MacroModel(&quot;Test&quot;, &quot;test&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, 0, false, false);
            model.MacroType = mType; //force the type
            Assert.AreEqual(expectedResult, macro.MacroIsFileBased(model));
        }

        [TestCase(&quot;XSLT&quot;, true)]
        [TestCase(&quot;Script&quot;, true)]
        [TestCase(&quot;PartialView&quot;, true)]
        [TestCase(&quot;UserControl&quot;, false)]
        [TestCase(&quot;CustomControl&quot;, false)]
        [TestCase(&quot;Python&quot;, true)]
        [TestCase(&quot;Unknown&quot;, false)]
        public void Can_Cache_As_String(string macroType, bool expectedResult)
        {
            var mType = Enum&lt;MacroTypes&gt;.Parse(macroType);
            var model = new MacroModel(&quot;Test&quot;, &quot;test&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, 0, false, false);
            model.MacroType = mType; //force the type
            Assert.AreEqual(expectedResult, macro.CacheMacroAsString(model));
        }

        [TestCase(-5, true)] //the cache DateTime will be older than the file date
        [TestCase(5, false)] //the cache DateTime will be newer than the file date
        public void Macro_Needs_Removing_Based_On_Macro_File(int minutesToNow, bool expectedResult)
        {
            var now = DateTime.Now;
            ApplicationContext.Current.ApplicationCache.RuntimeCache.InsertCacheItem(
                &quot;TestDate&quot;,
                priority:       CacheItemPriority.NotRemovable,
                timeout:        new TimeSpan(0, 0, 60),
                getCacheItem:   () =&gt; now.AddMinutes(minutesToNow)); //add a datetime value of &#39;now&#39; with the minutes offset

            //now we need to update a file&#39;s date to &#39;now&#39; to compare
            var path = Path.Combine(TestHelpers.TestHelper.CurrentAssemblyDirectory, &quot;temp.txt&quot;);
            File.CreateText(path).Close();

            //needs to be file based (i.e. xslt)
            var model = new MacroModel(&quot;Test&quot;, &quot;test&quot;, &quot;&quot;, &quot;&quot;, &quot;test.xslt&quot;, &quot;&quot;, 0, false, false);

            Assert.AreEqual(expectedResult, macro.MacroNeedsToBeClearedFromCache(model, &quot;TestDate&quot;, new FileInfo(path)));
        }

        public void Get_Macro_Cache_Identifier()
        {
            //var asdf  = macro.GetCacheIdentifier()
        }

        private class UserControlTest : UserControl
        {
            public int IntProp { get; set; }
            public string StringProp { get; set; }
            public double DoubleProp { get; set; }
            public float FloatProp { get; set; }
            public bool BoolProp { get; set; }
            public DateTime DateProp { get; set; }
            public Unit UnitProp { get; set; }
            public Guid GuidProp { get; set; }
            public DateTime? NullDateProp { get; set; }
            public Unit? NullUnitProp { get; set; }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[25,9,25,10,1],[27,13,31,50,1],[31,50,31,87,0],[31,87,31,90,1],[27,13,31,90,1],[32,13,32,141,1],[34,13,34,81,1],[35,9,35,10,1],[39,9,39,10,1],[40,13,40,86,1],[41,13,41,62,1],[42,13,42,47,1],[43,9,43,10,1],[63,9,63,10,1],[64,13,64,46,1],[65,13,65,118,1],[66,13,66,83,1],[68,13,68,61,1],[70,13,70,43,1],[71,13,71,60,1],[72,13,72,57,1],[74,13,74,46,1],[75,13,75,34,1],[76,13,76,68,1],[77,9,77,10,1],[88,9,88,10,1],[89,13,89,65,1],[90,13,90,106,1],[91,9,91,10,1],[99,9,99,10,1],[100,13,100,119,1],[101,13,101,50,1],[102,13,102,51,1],[103,9,103,10,1],[113,9,113,10,1],[114,13,114,59,1],[115,13,115,89,1],[116,13,116,37,1],[117,13,117,76,1],[118,9,118,10,1],[128,9,128,10,1],[129,13,129,59,1],[130,13,130,89,1],[131,13,131,37,1],[132,13,132,78,1],[133,9,133,10,1],[138,9,138,10,1],[139,13,139,36,1],[140,13,144,39,1],[144,39,144,67,1],[144,67,144,69,1],[140,13,144,69,1],[147,13,147,98,1],[148,13,148,43,1],[151,13,151,98,1],[153,13,153,122,1],[154,9,154,10,1],[157,9,157,10,0],[159,9,159,10,0],[163,34,163,38,1],[163,39,163,43,1],[164,40,164,44,1],[164,45,164,49,1],[165,40,165,44,1],[165,45,165,49,1],[166,38,166,42,1],[166,43,166,47,1],[167,36,167,40,1],[167,41,167,45,1],[168,40,168,44,1],[168,45,168,49,1],[169,36,169,40,1],[169,41,169,45,1],[170,36,170,40,1],[170,41,170,45,1],[171,45,171,49,1],[171,50,171,54,1],[172,41,172,45,1],[172,46,172,50,1]]);
    </script>
  </body>
</html>