<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Cache\PublishedCache\PublishedContentCacheTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq;
using System.Xml;
using Moq;
using NUnit.Framework;
using umbraco.BusinessLogic;
using Umbraco.Core.Models.PublishedContent;
using Umbraco.Tests.TestHelpers;
using Umbraco.Web;
using Umbraco.Web.PublishedCache;
using Umbraco.Web.PublishedCache.XmlPublishedCache;
using Umbraco.Web.Security;

namespace Umbraco.Tests.Cache.PublishedCache
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerFixture)]
	[TestFixture]
	public class PublishContentCacheTests : BaseWebTest
	{
		private FakeHttpContextFactory _httpContextFactory;
		private UmbracoContext _umbracoContext;
		private ContextualPublishedContentCache _cache;
	    private XmlDocument _xml;

		private string GetLegacyXml()
		{
			return @&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;&lt;!DOCTYPE root[ 
&lt;!ELEMENT node ANY&gt; &lt;!ATTLIST node id ID #REQUIRED&gt;  &lt;!ELEMENT data ANY&gt;

]&gt;
&lt;root id=&quot;&quot;-1&quot;&quot;&gt;
	&lt;node id=&quot;&quot;1046&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; nodeName=&quot;&quot;Home&quot;&quot; urlName=&quot;&quot;home&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046&quot;&quot; nodeTypeAlias=&quot;&quot;Home&quot;&quot;  &gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;node id=&quot;&quot;1173&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; nodeName=&quot;&quot;Sub1&quot;&quot; urlName=&quot;&quot;sub1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173&quot;&quot; nodeTypeAlias=&quot;&quot;Home&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
			&lt;node id=&quot;&quot;1174&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:07:54&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:27&quot;&quot; nodeName=&quot;&quot;Sub2&quot;&quot; urlName=&quot;&quot;sub2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1174&quot;&quot; nodeTypeAlias=&quot;&quot;Home&quot;&quot; &gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
			&lt;/node&gt;
			&lt;node id=&quot;&quot;1176&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;sub-3&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1176&quot;&quot; nodeTypeAlias=&quot;&quot;Home&quot;&quot; &gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
			&lt;/node&gt;
		&lt;/node&gt;
		&lt;node id=&quot;&quot;1175&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub 2&quot;&quot; urlName=&quot;&quot;sub-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1175&quot;&quot; nodeTypeAlias=&quot;&quot;Home&quot;&quot; &gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;/node&gt;
	&lt;/node&gt;
	&lt;node id=&quot;&quot;1172&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;3&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;Test&quot;&quot; urlName=&quot;&quot;test&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1172&quot;&quot; nodeTypeAlias=&quot;&quot;Home&quot;&quot; /&gt;
&lt;/root&gt;&quot;;
		}

		private string GetXml()
		{
			return @&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;&lt;!DOCTYPE root[ 
&lt;!ELEMENT Home ANY&gt;
&lt;!ATTLIST Home id ID #REQUIRED&gt;

]&gt;
&lt;root id=&quot;&quot;-1&quot;&quot;&gt;
	&lt;Home id=&quot;&quot;1046&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-06-12T14:13:17&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:50:43&quot;&quot; nodeName=&quot;&quot;Home&quot;&quot; urlName=&quot;&quot;home&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;Home id=&quot;&quot;1173&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:06:45&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:07:31&quot;&quot; nodeName=&quot;&quot;Sub1&quot;&quot; urlName=&quot;&quot;sub1&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
			&lt;Home id=&quot;&quot;1174&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;1&quot;&quot; createDate=&quot;&quot;2012-07-20T18:07:54&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:27&quot;&quot; nodeName=&quot;&quot;Sub2&quot;&quot; urlName=&quot;&quot;sub2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1174&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
			&lt;/Home&gt;
			&lt;Home id=&quot;&quot;1176&quot;&quot; parentID=&quot;&quot;1173&quot;&quot; level=&quot;&quot;3&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:08&quot;&quot; updateDate=&quot;&quot;2012-07-20T19:10:52&quot;&quot; nodeName=&quot;&quot;Sub 3&quot;&quot; urlName=&quot;&quot;sub-3&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1173,1176&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
			&lt;/Home&gt;
		&lt;/Home&gt;
		&lt;Home id=&quot;&quot;1175&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub 2&quot;&quot; urlName=&quot;&quot;sub-2&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1175&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;/Home&gt;
		&lt;Home id=&quot;&quot;1177&quot;&quot; parentID=&quot;&quot;1046&quot;&quot; level=&quot;&quot;2&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;2&quot;&quot; createDate=&quot;&quot;2012-07-20T18:08:01&quot;&quot; updateDate=&quot;&quot;2012-07-20T18:49:32&quot;&quot; nodeName=&quot;&quot;Sub&#39;Apostrophe&quot;&quot; urlName=&quot;&quot;sub&#39;apostrophe&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1046,1177&quot;&quot; isDoc=&quot;&quot;&quot;&quot;&gt;&lt;content&gt;&lt;![CDATA[]]&gt;&lt;/content&gt;
		&lt;/Home&gt;
	&lt;/Home&gt;
	&lt;Home id=&quot;&quot;1172&quot;&quot; parentID=&quot;&quot;-1&quot;&quot; level=&quot;&quot;1&quot;&quot; writerID=&quot;&quot;0&quot;&quot; creatorID=&quot;&quot;0&quot;&quot; nodeType=&quot;&quot;1044&quot;&quot; template=&quot;&quot;1045&quot;&quot; sortOrder=&quot;&quot;3&quot;&quot; createDate=&quot;&quot;2012-07-16T15:26:59&quot;&quot; updateDate=&quot;&quot;2012-07-18T14:23:35&quot;&quot; nodeName=&quot;&quot;Test&quot;&quot; urlName=&quot;&quot;test&quot;&quot; writerName=&quot;&quot;admin&quot;&quot; creatorName=&quot;&quot;admin&quot;&quot; path=&quot;&quot;-1,1172&quot;&quot; isDoc=&quot;&quot;&quot;&quot; /&gt;
&lt;/root&gt;&quot;;
		}

		[SetUp]
        public override void Initialize()
        {
            base.Initialize();

            _httpContextFactory = new FakeHttpContextFactory(&quot;~/Home&quot;);
            //ensure the StateHelper is using our custom context
            StateHelper.HttpContext = _httpContextFactory.HttpContext;

		    var settings = SettingsForTests.GenerateMockSettings();
		    var contentMock = Mock.Get(settings.Content);
            contentMock.Setup(x =&gt; x.UseLegacyXmlSchema).Returns(false);
		    SettingsForTests.ConfigureSettings(settings);
            _xml = new XmlDocument();
            _xml.LoadXml(GetXml());
            var cache = new PublishedContentCache
                {
                    GetXmlDelegate = (context, preview) =&gt; _xml
                };

		    _umbracoContext = new UmbracoContext(
                _httpContextFactory.HttpContext,
                ApplicationContext,
                new PublishedCaches(cache, new PublishedMediaCache(ApplicationContext)),
                new WebSecurity(_httpContextFactory.HttpContext, ApplicationContext));

		    _cache = _umbracoContext.ContentCache;
        }

	    private void SetupForLegacy()
		{
            var settings = SettingsForTests.GenerateMockSettings();
		    var contentMock = Mock.Get(settings.Content);
            contentMock.Setup(x =&gt; x.UseLegacyXmlSchema).Returns(true);
            SettingsForTests.ConfigureSettings(settings);
            _xml = new XmlDocument();
            _xml.LoadXml(GetLegacyXml());
		}

	    protected override void FreezeResolution()
	    {
            PublishedContentModelFactoryResolver.Current = new PublishedContentModelFactoryResolver();
	        base.FreezeResolution();
	    }
		
	    [Test]
		public void Has_Content_LegacySchema()
		{
			SetupForLegacy();
			Has_Content();
		}

		[Test]
		public void Has_Content()
		{
			Assert.IsTrue(_cache.HasContent());
		}

		[Test]
		public void Get_Root_Docs_LegacySchema()
		{
			SetupForLegacy();
			Get_Root_Docs();
		}

		[Test]
		public void Get_Root_Docs()
		{
			var result = _cache.GetAtRoot();
			Assert.AreEqual(2, result.Count());
			Assert.AreEqual(1046, result.ElementAt(0).Id);
			Assert.AreEqual(1172, result.ElementAt(1).Id);
		}

		[TestCase(&quot;/&quot;, 1046)]
		[TestCase(&quot;/home&quot;, 1046)]
		[TestCase(&quot;/Home&quot;, 1046)] //test different cases
		[TestCase(&quot;/home/sub1&quot;, 1173)]
		[TestCase(&quot;/Home/sub1&quot;, 1173)]
		[TestCase(&quot;/home/Sub1&quot;, 1173)] //test different cases
		public void Get_Node_By_Route_LegacySchema(string route, int nodeId)
		{
			SetupForLegacy();
			Get_Node_By_Route(route, nodeId);
		}

		[TestCase(&quot;/&quot;, 1046)]
		[TestCase(&quot;/home&quot;, 1046)]
		[TestCase(&quot;/Home&quot;, 1046)] //test different cases
		[TestCase(&quot;/home/sub1&quot;, 1173)]
		[TestCase(&quot;/Home/sub1&quot;, 1173)]
		[TestCase(&quot;/home/Sub1&quot;, 1173)] //test different cases
		[TestCase(&quot;/home/Sub&#39;Apostrophe&quot;, 1177)]
		public void Get_Node_By_Route(string route, int nodeId)
		{
			var result = _cache.GetByRoute(route, false);
			Assert.IsNotNull(result);
			Assert.AreEqual(nodeId, result.Id);
		}

		[TestCase(&quot;/&quot;, 1046)]
		[TestCase(&quot;/sub1&quot;, 1173)]
		[TestCase(&quot;/Sub1&quot;, 1173)]
		public void Get_Node_By_Route_Hiding_Top_Level_Nodes_LegacySchema(string route, int nodeId)
		{
			SetupForLegacy();
			Get_Node_By_Route_Hiding_Top_Level_Nodes(route, nodeId);
		}

		[TestCase(&quot;/&quot;, 1046)]		
		[TestCase(&quot;/sub1&quot;, 1173)]
		[TestCase(&quot;/Sub1&quot;, 1173)]
		public void Get_Node_By_Route_Hiding_Top_Level_Nodes(string route, int nodeId)
		{
			var result = _cache.GetByRoute(route, true);
			Assert.IsNotNull(result);
			Assert.AreEqual(nodeId, result.Id);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[25,3,25,4,1],[26,4,42,10,1],[43,3,43,4,1],[46,3,46,4,1],[47,4,66,10,1],[67,3,67,4,1],[71,9,71,10,1],[72,13,72,31,1],[74,13,74,72,1],[76,13,76,71,1],[78,7,78,62,1],[79,7,79,52,1],[80,13,80,73,1],[81,7,81,52,1],[82,13,82,38,1],[83,13,83,36,1],[84,13,86,60,1],[86,60,86,64,1],[86,64,87,19,1],[84,13,87,19,1],[89,7,93,87,1],[95,7,95,45,1],[96,9,96,10,1],[99,3,99,4,1],[100,13,100,68,1],[101,7,101,52,1],[102,13,102,72,1],[103,13,103,58,1],[104,13,104,38,1],[105,13,105,42,1],[106,3,106,4,1],[109,6,109,7,1],[110,13,110,103,1],[111,10,111,34,1],[112,6,112,7,1],[116,3,116,4,1],[117,4,117,21,1],[118,4,118,18,1],[119,3,119,4,1],[123,3,123,4,1],[124,4,124,39,1],[125,3,125,4,1],[129,3,129,4,1],[130,4,130,21,1],[131,4,131,20,1],[132,3,132,4,1],[136,3,136,4,1],[137,4,137,36,1],[138,4,138,39,1],[139,4,139,50,1],[140,4,140,50,1],[141,3,141,4,1],[150,3,150,4,1],[151,4,151,21,1],[152,4,152,37,1],[153,3,153,4,1],[163,3,163,4,1],[164,4,164,49,1],[165,4,165,29,1],[166,4,166,39,1],[167,3,167,4,1],[173,3,173,4,1],[174,4,174,21,1],[175,4,175,60,1],[176,3,176,4,1],[182,3,182,4,1],[183,4,183,48,1],[184,4,184,29,1],[185,4,185,39,1],[186,3,186,4,1]]);
    </script>
  </body>
</html>