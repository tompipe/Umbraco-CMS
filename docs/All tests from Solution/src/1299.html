<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\HealthCheck\Checks\Services\SmtpCheck.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Net.Configuration;
using System.Net.Sockets;
using System.Web.Configuration;
using Umbraco.Core.Services;

namespace Umbraco.Web.HealthCheck.Checks.Services
{
    [HealthCheck(
        &quot;1B5D221B-CE99-4193-97CB-5F3261EC73DF&quot;,
        &quot;SMTP Settings&quot;,
        Description = &quot;Checks that valid settings for sending emails are in place.&quot;,
        Group = &quot;Services&quot;)]
    public class SmtpCheck : HealthCheck
    {
        private readonly ILocalizedTextService _textService;

        public SmtpCheck(HealthCheckContext healthCheckContext) : base(healthCheckContext)
        {
            _textService = healthCheckContext.ApplicationContext.Services.TextService;
        }

        /// &lt;summary&gt;
        /// Get the status for this health check
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override IEnumerable&lt;HealthCheckStatus&gt; GetStatus()
        {
            //return the statuses
            return new[] { CheckSmtpSettings() };
        }

        /// &lt;summary&gt;
        /// Executes the action and returns it&#39;s status
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public override HealthCheckStatus ExecuteAction(HealthCheckAction action)
        {
            throw new InvalidOperationException(&quot;SmtpCheck has no executable actions&quot;);
        }

        private HealthCheckStatus CheckSmtpSettings()
        {
            const int DefaultSmtpPort = 25;
            var message = string.Empty;
            var success = false;

            var config = WebConfigurationManager.OpenWebConfiguration(HealthCheckContext.HttpContext.Request.ApplicationPath);
            var settings = (MailSettingsSectionGroup)config.GetSectionGroup(&quot;system.net/mailSettings&quot;);
            if (settings == null)
            {
                message = _textService.Localize(&quot;healthcheck/smtpMailSettingsNotFound&quot;);
            }
            else
            {
                var host = settings.Smtp.Network.Host;
                var port = settings.Smtp.Network.Port == 0 ? DefaultSmtpPort : settings.Smtp.Network.Port;
                if (string.IsNullOrEmpty(host))
                {
                    message = _textService.Localize(&quot;healthcheck/smtpMailSettingsHostNotConfigured&quot;);
                }
                else
                {
                    success = CanMakeSmtpConnection(host, port);
                    message = success
                        ? _textService.Localize(&quot;healthcheck/smtpMailSettingsConnectionSuccess&quot;)
                        : _textService.Localize(&quot;healthcheck/smtpMailSettingsConnectionFail&quot;, new [] { host, port.ToString() });
                }
            }

            var actions = new List&lt;HealthCheckAction&gt;();
            return
                new HealthCheckStatus(message)
                {
                    ResultType = success ? StatusResultType.Success : StatusResultType.Error,
                    Actions = actions
                };
        }

        private bool CanMakeSmtpConnection(string host, int port)
        {
            try
            {
                using (var client = new TcpClient())
                {
                    client.Connect(host, port);
                    using (var stream = client.GetStream())
                    {
                        using (var writer = new StreamWriter(stream))
                        using (var reader = new StreamReader(stream))
                        {
                            writer.WriteLine(&quot;EHLO &quot; + host);
                            writer.Flush();
                            reader.ReadLine();
                            return true;
                        }
                    }
                }
            }
            catch
            {
                return false;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,67,20,91,0],[21,9,21,10,0],[22,13,22,87,0],[23,9,23,10,0],[30,9,30,10,0],[32,13,32,50,0],[33,9,33,10,0],[41,9,41,10,0],[42,13,42,88,0],[46,9,46,10,0],[48,13,48,40,0],[49,13,49,33,0],[51,13,51,127,0],[52,13,52,104,0],[53,13,53,34,0],[54,13,54,14,0],[55,17,55,89,0],[56,13,56,14,0],[58,13,58,14,0],[59,17,59,55,0],[60,17,60,107,0],[61,17,61,48,0],[62,17,62,18,0],[63,21,63,102,0],[64,17,64,18,0],[66,17,66,18,0],[67,21,67,65,0],[68,21,70,129,0],[71,17,71,18,0],[72,13,72,14,0],[74,13,74,57,0],[75,13,80,19,0],[81,9,81,10,0],[84,9,84,10,0],[86,13,86,14,0],[87,24,87,52,0],[88,17,88,18,0],[89,21,89,48,0],[90,28,90,59,0],[91,21,91,22,0],[92,32,92,69,0],[93,32,93,69,0],[94,25,94,26,0],[95,29,95,62,0],[96,29,96,44,0],[97,29,97,47,0],[98,29,98,41,0],[103,13,103,18,0],[104,13,104,14,0],[105,17,105,30,0],[107,9,107,10,0]]);
    </script>
  </body>
</html>