<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebApi\HttpControllerContextExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Runtime.Remoting.Contexts;
using System.Threading;
using System.Threading.Tasks;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.Filters;
using Umbraco.Web.WebApi.Filters;

namespace Umbraco.Web.WebApi
{
    internal static class HttpControllerContextExtensions
    {
        /// &lt;summary&gt;
        /// This method will go an execute the authorization filters for the controller action, if any fail
        /// it will return their response, otherwise we&#39;ll return null.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;controllerContext&quot;&gt;&lt;/param&gt;
        internal static async Task&lt;HttpResponseMessage&gt; InvokeAuthorizationFiltersForRequest(this HttpControllerContext controllerContext)
        {
            var controllerDescriptor = controllerContext.ControllerDescriptor;
            var controllerServices = controllerDescriptor.Configuration.Services;
            var actionDescriptor = controllerServices.GetActionSelector().SelectAction(controllerContext);
            var actionContext = new HttpActionContext(controllerContext, actionDescriptor);
            var filters = actionDescriptor.GetFilterPipeline();
            var filterGrouping = new FilterGrouping(filters);
            var actionFilters = filterGrouping.ActionFilters;
            // Because the continuation gets built from the inside out we need to reverse the filter list
            // so that least specific filters (Global) get run first and the most specific filters (Action) get run last.
            var authorizationFilters = filterGrouping.AuthorizationFilters.Reverse().ToArray();

            if (authorizationFilters.Any())
            {
                var cancelToken = new CancellationToken();           
                var filterResult = await FilterContinuation(actionContext, cancelToken, authorizationFilters, 0);
                if (filterResult != null)
                {
                    //this means that the authorization filter has returned a result - unauthorized so we cannot continue
                    return filterResult;
                }                    
            }
            return null;
        }

        /// &lt;summary&gt;
        /// This method is how you execute a chain of filters, it needs to recursively call in to itself as the continuation for the next filter in the chain
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;actionContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;token&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;filters&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;index&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private static async Task&lt;HttpResponseMessage&gt; FilterContinuation(HttpActionContext actionContext, CancellationToken token, IList&lt;IAuthorizationFilter&gt; filters, int index)
        {
            return await filters[index].ExecuteAuthorizationFilterAsync(actionContext, token,
                () =&gt; (index + 1) == filters.Count
                    ? Task.FromResult&lt;HttpResponseMessage&gt;(null)
                    : FilterContinuation(actionContext, token, filters, ++index));
        }
  

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,0],[24,13,24,79,0],[25,13,25,82,0],[26,13,26,107,0],[27,13,27,92,0],[28,13,28,64,0],[29,13,29,62,0],[30,13,30,62,0],[33,13,33,96,0],[35,13,35,44,0],[36,13,36,14,0],[37,17,37,59,0],[38,17,38,114,0],[39,17,39,42,0],[40,17,40,18,0],[42,21,42,41,0],[44,13,44,14,0],[45,13,45,25,0],[46,9,46,10,0],[57,9,57,10,0],[58,13,59,23,0],[59,23,61,81,0],[61,81,61,83,0],[58,13,61,83,0],[62,9,62,10,0]]);
    </script>
  </body>
</html>