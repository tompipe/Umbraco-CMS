<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\UriUtility.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Text;
using System.Web;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using GlobalSettings = umbraco.GlobalSettings;

namespace Umbraco.Web
{
    public static class UriUtility
    {
        static string _appPath;
        static string _appPathPrefix;

        static UriUtility()
        {
			SetAppDomainAppVirtualPath(HttpRuntime.AppDomainAppVirtualPath);
        }

		// internal for unit testing only
		internal static void SetAppDomainAppVirtualPath(string appPath)
		{
			_appPath = appPath ?? &quot;/&quot;;
			_appPathPrefix = _appPath;
			if (_appPathPrefix == &quot;/&quot;)
				_appPathPrefix = String.Empty;
		}

		// will be &quot;/&quot; or &quot;/foo&quot;
        public static string AppPath
        {
            get { return _appPath; }
        }

		// will be &quot;&quot; or &quot;/foo&quot;
        public static string AppPathPrefix
        {
            get { return _appPathPrefix; }
        }

		// adds the virtual directory if any
		// see also VirtualPathUtility.ToAbsolute
		public static string ToAbsolute(string url)
        {
			//return ResolveUrl(url);
			url = url.TrimStart(&#39;~&#39;);
			return _appPathPrefix + url;
        }

		// strips the virtual directory if any
		// see also VirtualPathUtility.ToAppRelative
        public static string ToAppRelative(string virtualPath)
        {
            if (virtualPath.InvariantStartsWith(_appPathPrefix)
                    &amp;&amp; (virtualPath.Length == _appPathPrefix.Length || virtualPath[_appPathPrefix.Length] == &#39;/&#39;))
                virtualPath = virtualPath.Substring(_appPathPrefix.Length);
			if (virtualPath.Length == 0)
				virtualPath = &quot;/&quot;;
            return virtualPath;
        }

		// maps an internal umbraco uri to a public uri
		// ie with virtual directory, .aspx if required...
    	public static Uri UriFromUmbraco(Uri uri)
    	{
    		var path = uri.GetSafeAbsolutePath();

			if (path != &quot;/&quot;)
			{
				if (!GlobalSettings.UseDirectoryUrls)
					path += &quot;.aspx&quot;;
                else if (UmbracoConfig.For.UmbracoSettings().RequestHandler.AddTrailingSlash)
					path += &quot;/&quot;;
			}

			path = ToAbsolute(path);

    		return uri.Rewrite(path);
    	}

		// maps a public uri to an internal umbraco uri
		// ie no virtual directory, no .aspx, lowercase...
		public static Uri UriToUmbraco(Uri uri)
    	{
			// note: no need to decode uri here because we&#39;re returning a uri
			// so it will be re-encoded anyway
    		var path = uri.GetSafeAbsolutePath();

    		path = path.ToLower();
			path = ToAppRelative(path); // strip vdir if any

			//we need to check if the path is /default.aspx because this will occur when using a 
			//web server pre IIS 7 when requesting the root document
			//if this is the case we need to change it to &#39;/&#39;
			if (path.StartsWith(&quot;/default.aspx&quot;, StringComparison.InvariantCultureIgnoreCase))
			{
				string rempath = path.Substring(&quot;/default.aspx&quot;.Length, path.Length - &quot;/default.aspx&quot;.Length);
				path = rempath.StartsWith(&quot;/&quot;) ? rempath : &quot;/&quot; + rempath;
			}
			if (path != &quot;/&quot;)
			{
				path = path.TrimEnd(&#39;/&#39;);
			}

			//if any part of the path contains .aspx, replace it with nothing.
			//sometimes .aspx is not at the end since we might have /home/sub1.aspx/customtemplate
			path = path.Replace(&quot;.aspx&quot;, &quot;&quot;);

    		return uri.Rewrite(path);
    	}

    	#region ResolveUrl

        // http://www.codeproject.com/Articles/53460/ResolveUrl-in-ASP-NET-The-Perfect-Solution
        // note
        // if browsing http://example.com/sub/page1.aspx then 
        // ResolveUrl(&quot;page2.aspx&quot;) returns &quot;/page2.aspx&quot;
        // Page.ResolveUrl(&quot;page2.aspx&quot;) returns &quot;/sub/page2.aspx&quot; (relative...)
        //
        public static string ResolveUrl(string relativeUrl)
        {
            if (relativeUrl == null) throw new ArgumentNullException(&quot;relativeUrl&quot;);

            if (relativeUrl.Length == 0 || relativeUrl[0] == &#39;/&#39; || relativeUrl[0] == &#39;\\&#39;)
                return relativeUrl;

            int idxOfScheme = relativeUrl.IndexOf(@&quot;://&quot;, StringComparison.Ordinal);
            if (idxOfScheme != -1)
            {
                int idxOfQM = relativeUrl.IndexOf(&#39;?&#39;);
                if (idxOfQM == -1 || idxOfQM &gt; idxOfScheme) return relativeUrl;
            }

            StringBuilder sbUrl = new StringBuilder();
            sbUrl.Append(_appPathPrefix);
            if (sbUrl.Length == 0 || sbUrl[sbUrl.Length - 1] != &#39;/&#39;) sbUrl.Append(&#39;/&#39;);

            // found question mark already? query string, do not touch!
            bool foundQM = false;
            bool foundSlash; // the latest char was a slash?
            if (relativeUrl.Length &gt; 1
                &amp;&amp; relativeUrl[0] == &#39;~&#39;
                &amp;&amp; (relativeUrl[1] == &#39;/&#39; || relativeUrl[1] == &#39;\\&#39;))
            {
                relativeUrl = relativeUrl.Substring(2);
                foundSlash = true;
            }
            else foundSlash = false;
            foreach (char c in relativeUrl)
            {
                if (!foundQM)
                {
                    if (c == &#39;?&#39;) foundQM = true;
                    else
                    {
                        if (c == &#39;/&#39; || c == &#39;\\&#39;)
                        {
                            if (foundSlash) continue;
                            else
                            {
                                sbUrl.Append(&#39;/&#39;);
                                foundSlash = true;
                                continue;
                            }
                        }
                        else if (foundSlash) foundSlash = false;
                    }
                }
                sbUrl.Append(c);
            }

            return sbUrl.ToString();
        }

        #endregion

		#region Uri string utilities

		public static bool HasScheme(string uri)
		{
			return uri.IndexOf(&quot;://&quot;) &gt; 0;
		}

		public static string StartWithScheme(string uri)
		{
			return StartWithScheme(uri, null);
		}

		public static string StartWithScheme(string uri, string scheme)
		{
			return HasScheme(uri) ? uri : String.Format(&quot;{0}://{1}&quot;, scheme ?? Uri.UriSchemeHttp, uri);
		}

		public static string EndPathWithSlash(string uri)
		{
			var pos1 = Math.Max(0, uri.IndexOf(&#39;?&#39;));
			var pos2 = Math.Max(0, uri.IndexOf(&#39;#&#39;));
			var pos = Math.Min(pos1, pos2);

			var path = pos &gt; 0 ? uri.Substring(0, pos) : uri;
			path = path.EnsureEndsWith(&#39;/&#39;);

			if (pos &gt; 0)
				path += uri.Substring(pos);

			return path;
		}

		public static string TrimPathEndSlash(string uri)
		{
			var pos1 = Math.Max(0, uri.IndexOf(&#39;?&#39;));
			var pos2 = Math.Max(0, uri.IndexOf(&#39;#&#39;));
			var pos = Math.Min(pos1, pos2);

			var path = pos &gt; 0 ? uri.Substring(0, pos) : uri;
			path = path.TrimEnd(&#39;/&#39;);

			if (pos &gt; 0)
				path += uri.Substring(pos);

			return path;
		}

		#endregion

    	/// &lt;summary&gt;
    	/// Returns an faull url with the host, port, etc...
    	/// &lt;/summary&gt;
    	/// &lt;param name=&quot;absolutePath&quot;&gt;An absolute path (i.e. starts with a &#39;/&#39; )&lt;/param&gt;
    	/// &lt;param name=&quot;httpContext&quot;&gt; &lt;/param&gt;
    	/// &lt;returns&gt;&lt;/returns&gt;
    	/// &lt;remarks&gt;
    	/// Based on http://stackoverflow.com/questions/3681052/get-absolute-url-from-relative-path-refactored-method
    	/// &lt;/remarks&gt;
    	internal static Uri ToFullUrl(string absolutePath, HttpContextBase httpContext)
		{
    		if (httpContext == null) throw new ArgumentNullException(&quot;httpContext&quot;);
    		if (String.IsNullOrEmpty(absolutePath))
				throw new ArgumentNullException(&quot;absolutePath&quot;);
			
			if (!absolutePath.StartsWith(&quot;/&quot;))
				throw new FormatException(&quot;The absolutePath specified does not start with a &#39;/&#39;&quot;);

			return new Uri(absolutePath, UriKind.Relative).MakeAbsolute(httpContext.Request.Url);
		}
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,1],[17,4,17,68,1],[18,9,18,10,1],[22,3,22,4,1],[23,4,23,30,1],[24,4,24,30,1],[25,4,25,30,1],[26,5,26,35,1],[27,3,27,4,1],[32,17,32,18,0],[32,19,32,35,0],[32,36,32,37,0],[38,17,38,18,0],[38,19,38,41,0],[38,42,38,43,0],[44,9,44,10,1],[46,4,46,29,1],[47,4,47,32,1],[48,9,48,10,1],[53,9,53,10,1],[54,13,55,115,1],[56,17,56,76,1],[57,4,57,32,1],[58,5,58,23,1],[59,13,59,32,1],[60,9,60,10,1],[65,6,65,7,1],[66,7,66,44,1],[68,4,68,20,1],[69,4,69,5,1],[70,5,70,42,1],[71,6,71,22,1],[72,22,72,94,1],[73,6,73,18,1],[74,4,74,5,1],[76,4,76,28,1],[78,7,78,32,1],[79,6,79,7,1],[84,6,84,7,1],[87,7,87,44,1],[89,7,89,29,1],[90,4,90,31,1],[95,4,95,86,1],[96,4,96,5,1],[97,5,97,99,1],[98,5,98,62,1],[99,4,99,5,1],[100,4,100,20,1],[101,4,101,5,1],[102,5,102,30,1],[103,4,103,5,1],[107,4,107,37,1],[109,7,109,32,1],[110,6,110,7,1],[121,9,121,10,0],[122,13,122,37,0],[122,38,122,85,0],[124,13,124,92,0],[125,17,125,36,0],[127,13,127,85,0],[128,13,128,35,0],[129,13,129,14,0],[130,17,130,56,0],[131,17,131,60,0],[131,61,131,80,0],[132,13,132,14,0],[134,13,134,55,0],[135,13,135,42,0],[136,13,136,69,0],[136,70,136,88,0],[139,13,139,34,0],[141,13,143,70,0],[144,13,144,14,0],[145,17,145,56,0],[146,17,146,35,0],[147,13,147,14,0],[148,18,148,37,0],[149,13,149,20,0],[149,22,149,28,0],[149,29,149,31,0],[149,32,149,43,0],[150,13,150,14,0],[151,17,151,30,0],[152,17,152,18,0],[153,21,153,34,0],[153,35,153,50,0],[155,21,155,22,0],[156,25,156,51,0],[157,25,157,26,0],[158,29,158,44,0],[158,45,158,54,0],[160,29,160,30,0],[161,33,161,51,0],[162,33,162,51,0],[163,33,163,42,0],[166,30,166,45,0],[166,46,166,65,0],[167,21,167,22,0],[168,17,168,18,0],[169,17,169,33,0],[170,13,170,14,0],[172,13,172,37,0],[173,9,173,10,0],[180,3,180,4,1],[181,4,181,34,1],[182,3,182,4,1],[185,3,185,4,0],[186,4,186,38,0],[187,3,187,4,0],[190,3,190,4,1],[191,4,191,95,1],[192,3,192,4,1],[195,3,195,4,0],[196,4,196,45,0],[197,4,197,45,0],[198,4,198,35,0],[200,4,200,53,0],[201,4,201,36,0],[203,4,203,16,0],[204,5,204,32,0],[206,4,206,16,0],[207,3,207,4,0],[210,3,210,4,1],[211,4,211,45,1],[212,4,212,45,1],[213,4,213,35,1],[215,4,215,53,1],[216,4,216,29,1],[218,4,218,16,1],[219,5,219,32,0],[221,4,221,16,1],[222,3,222,4,1],[236,3,236,4,0],[237,7,237,31,0],[237,32,237,79,0],[238,7,238,46,0],[239,5,239,53,0],[241,4,241,38,0],[242,5,242,87,0],[244,4,244,89,0],[245,3,245,4,0]]);
    </script>
  </body>
</html>