<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.businesslogic\BasePages\UmbracoEnsuredPage.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using Umbraco.Core.Logging;
using System.Linq;
using System.Web;
using Umbraco.Core;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using umbraco.BusinessLogic;
using umbraco.businesslogic.Exceptions;
using Umbraco.Core.Security;

namespace umbraco.BasePages
{
    /// &lt;summary&gt;
    /// UmbracoEnsuredPage is the standard protected page in the umbraco backend, and forces authentication.
    /// &lt;/summary&gt;
    [Obsolete(&quot;This class has been superceded by Umbraco.Web.UI.Pages.UmbracoEnsuredPage&quot;)]
    public class UmbracoEnsuredPage : BasePage
    {
        /// &lt;summary&gt;
        /// Checks if the page exists outside of the /umbraco route, in which case the request will not have been authenticated for the back office 
        /// so we&#39;ll force authentication.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnPreInit(EventArgs e)
        {
            base.OnPreInit(e);

            //If this is not a back office request, then the module won&#39;t have authenticated it, in this case we
            // need to do the auth manually and since this is an UmbracoEnsuredPage, this is the anticipated behavior
            // TODO: When we implement Identity, this process might not work anymore, will be an interesting challenge
            if (Context.Request.Url.IsBackOfficeRequest(HttpRuntime.AppDomainAppVirtualPath) == false)
            {
                var http = new HttpContextWrapper(Context);
                var ticket = http.GetUmbracoAuthTicket();
                http.AuthenticateCurrentRequest(ticket, true);
            }
        }

        /// &lt;summary&gt;
        /// Gets/sets the app for which this page belongs to so that we can validate the current user&#39;s security against it
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// If no app is specified then all logged in users will have access to the page
        /// &lt;/remarks&gt;
        public string CurrentApp { get; set; }

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;UmbracoEnsuredPage&quot;/&gt; class.
        /// &lt;/summary&gt;
        public UmbracoEnsuredPage()
        {
            //Assign security automatically if the attribute is found
            var treeAuth = this.GetType().GetCustomAttribute&lt;WebformsPageTreeAuthorizeAttribute&gt;(true);
            if (treeAuth != null)
            {
                var treeByAlias = ApplicationContext.Current.Services.ApplicationTreeService
                    .GetByAlias(treeAuth.TreeAlias);
                if (treeByAlias != null)
                {
                    CurrentApp = treeByAlias.ApplicationAlias;    
                }
            }
        }

        [Obsolete(&quot;This constructor is not used and will be removed from the codebase in the future&quot;)]
        public UmbracoEnsuredPage(string hest) : this()
        {
            
        }

        /// &lt;summary&gt;
        /// If true then umbraco will force any window/frame to reload umbraco in the main window
        /// &lt;/summary&gt;
        public bool RedirectToUmbraco { get; set; }

        /// &lt;summary&gt;
        /// Validates the user for access to a certain application
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;app&quot;&gt;The application alias.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool ValidateUserApp(string app)
        {
            return getUser().Applications.Any(uApp =&gt; uApp.alias.InvariantEquals(app));
        }

        /// &lt;summary&gt;
        /// Validates the user node tree permissions.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Path&quot;&gt;The path.&lt;/param&gt;
        /// &lt;param name=&quot;Action&quot;&gt;The action.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool ValidateUserNodeTreePermissions(string Path, string Action)
        {
            string permissions = getUser().GetPermissions(Path);
            if (permissions.IndexOf(Action) &gt; -1 &amp;&amp; (Path.Contains(&quot;-20&quot;) || (&quot;,&quot; + Path + &quot;,&quot;).Contains(&quot;,&quot; + getUser().StartNodeId.ToString() + &quot;,&quot;)))
                return true;

	        var user = getUser();
	        LogHelper.Info&lt;UmbracoEnsuredPage&gt;(&quot;User {0} has insufficient permissions in UmbracoEnsuredPage: &#39;{1}&#39;, &#39;{2}&#39;, &#39;{3}&#39;&quot;, () =&gt; user.Name, () =&gt; Path, () =&gt; permissions, () =&gt; Action);
            return false;
        }

        /// &lt;summary&gt;
        /// Gets the current user.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The current user.&lt;/value&gt;
        public static User CurrentUser
        {
            get
            {
                return BusinessLogic.User.GetCurrent();
            }
        }

        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;E:System.Web.UI.Control.Init&quot;&gt;&lt;/see&gt; event to initialize the page.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;An &lt;see cref=&quot;T:System.EventArgs&quot;&gt;&lt;/see&gt; that contains the event data.&lt;/param&gt;
        protected override void OnInit(EventArgs e)
        {
            base.OnInit(e);
            try
            {
                ensureContext();

                if (!string.IsNullOrEmpty(CurrentApp))
                {
                    if (!ValidateUserApp(CurrentApp))
                        throw new UserAuthorizationException(String.Format(&quot;The current user doesn&#39;t have access to the section/app &#39;{0}&#39;&quot;, CurrentApp));
                }
            }
            catch (UserAuthorizationException ex)
            {
                LogHelper.Warn&lt;UmbracoEnsuredPage&gt;(string.Format(&quot;{0} tried to access &#39;{1}&#39;&quot;, CurrentUser.Id, CurrentApp));
                throw;
            }
            catch
            {
                // Clear content as .NET transfers rendered content.
                Response.Clear();

                // Some umbraco pages should not be loaded on timeout, but instead reload the main application in the top window. Like the treeview for instance
                if (RedirectToUmbraco)
                    Response.Redirect(SystemDirectories.Umbraco + &quot;/logout.aspx?t=&quot; + umbracoUserContextID, true);
                else
                    Response.Redirect(SystemDirectories.Umbraco + &quot;/logout.aspx?redir=&quot; + Server.UrlEncode(Request.RawUrl) + &quot;&amp;t=&quot; + umbracoUserContextID, true);
            }
        }

        /// &lt;summary&gt;
        /// Used to assign a webforms page&#39;s security to a specific tree which will in turn check to see
        /// if the current user has access to the specified tree&#39;s registered section
        /// &lt;/summary&gt;
        [AttributeUsage(AttributeTargets.Class)]
        public sealed class WebformsPageTreeAuthorizeAttribute : Attribute
        {
            public string TreeAlias { get; private set; }

            public WebformsPageTreeAuthorizeAttribute(string treeAlias)
            {
                TreeAlias = treeAlias;
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,0],[27,13,27,31,0],[32,13,32,103,0],[33,13,33,14,0],[34,17,34,60,0],[35,17,35,58,0],[36,17,36,63,0],[37,13,37,14,0],[38,9,38,10,0],[46,36,46,40,0],[46,41,46,45,0],[51,9,51,36,0],[52,9,52,10,0],[54,13,54,104,0],[55,13,55,34,0],[56,13,56,14,0],[57,17,58,53,0],[59,17,59,41,0],[60,17,60,18,0],[61,21,61,63,0],[62,17,62,18,0],[63,13,63,14,0],[64,9,64,10,0],[67,50,67,56,0],[68,9,68,10,0],[70,9,70,10,0],[75,41,75,45,0],[75,46,75,50,0],[83,9,83,10,0],[84,13,84,55,0],[84,55,84,86,0],[84,86,84,88,0],[84,13,84,88,0],[85,9,85,10,0],[94,9,94,10,0],[95,13,95,65,0],[96,13,96,153,0],[97,17,97,29,0],[99,10,99,31,0],[100,10,100,135,0],[100,135,100,144,0],[100,144,100,152,0],[100,152,100,156,0],[100,156,100,164,0],[100,164,100,175,0],[100,175,100,183,0],[100,183,100,189,0],[100,189,100,191,0],[100,10,100,191,0],[101,13,101,26,0],[102,9,102,10,0],[111,13,111,14,1],[112,17,112,56,1],[113,13,113,14,1],[121,9,121,10,0],[122,13,122,28,0],[124,13,124,14,0],[125,17,125,33,0],[127,17,127,55,0],[128,17,128,18,0],[129,21,129,54,0],[130,25,130,154,0],[131,17,131,18,0],[132,13,132,14,0],[133,13,133,50,0],[134,13,134,14,0],[135,17,135,124,0],[136,17,136,23,0],[138,13,138,18,0],[139,13,139,14,0],[141,17,141,34,0],[144,17,144,39,0],[145,21,145,115,0],[147,21,147,162,0],[148,13,148,14,0],[149,9,149,10,0],[158,39,158,43,0],[158,44,158,56,0],[160,13,160,72,0],[161,13,161,14,0],[162,17,162,39,0],[163,13,163,14,0]]);
    </script>
  </body>
</html>