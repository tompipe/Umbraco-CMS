<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\WebApi\NamespaceHttpControllerSelector.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.Dispatcher;

namespace Umbraco.Web.WebApi
{
    public class NamespaceHttpControllerSelector : DefaultHttpControllerSelector
    {
        private const string ControllerKey = &quot;controller&quot;;
        private readonly HttpConfiguration _configuration;
        private readonly Lazy&lt;ConcurrentDictionary&lt;string, HttpControllerDescriptor&gt;&gt; _duplicateControllerTypes;

        public NamespaceHttpControllerSelector(HttpConfiguration configuration) : base(configuration)
        {
            _configuration = configuration;
            _duplicateControllerTypes = new Lazy&lt;ConcurrentDictionary&lt;string, HttpControllerDescriptor&gt;&gt;(GetDuplicateControllerTypes);
        }

        public override HttpControllerDescriptor SelectController(HttpRequestMessage request)
        {
            var routeData = request.GetRouteData();
            if (routeData == null 
                || routeData.Route == null
                || routeData.Route.DataTokens == null
                || routeData.Route.DataTokens.ContainsKey(&quot;Namespaces&quot;) == false
                || routeData.Route.DataTokens[&quot;Namespaces&quot;] == null)
                return base.SelectController(request);
            
            // Look up controller in route data
            object controllerName;
            routeData.Values.TryGetValue(ControllerKey, out controllerName);
            var controllerNameAsString = controllerName as string;
            if (controllerNameAsString == null) 
                return base.SelectController(request);
            
            //get the currently cached default controllers - this will not contain duplicate controllers found so if
            // this controller is found in the underlying cache we don&#39;t need to do anything
            var map = base.GetControllerMapping();
            if (map.ContainsKey(controllerNameAsString)) 
                return base.SelectController(request);
            
            //the cache does not contain this controller because it&#39;s most likely a duplicate, 
            // so we need to sort this out ourselves and we can only do that if the namespace token
            // is formatted correctly.
            var namespaces = routeData.Route.DataTokens[&quot;Namespaces&quot;] as IEnumerable&lt;string&gt;;
            if (namespaces == null)
                return base.SelectController(request);

            //see if this is in our cache
            foreach (var ns in namespaces)
            {
                HttpControllerDescriptor descriptor;
                if (_duplicateControllerTypes.Value.TryGetValue(string.Format(&quot;{0}-{1}&quot;, controllerNameAsString, ns), out descriptor))
                {
                    return descriptor;
                }
            }

            return base.SelectController(request);
        }

        private ConcurrentDictionary&lt;string, HttpControllerDescriptor&gt; GetDuplicateControllerTypes()
        {
            var assembliesResolver = _configuration.Services.GetAssembliesResolver();
            var controllersResolver = _configuration.Services.GetHttpControllerTypeResolver();
            var controllerTypes = controllersResolver.GetControllerTypes(assembliesResolver);

            var groupedByName = controllerTypes.GroupBy(
                t =&gt; t.Name.Substring(0, t.Name.Length - ControllerSuffix.Length),
                StringComparer.OrdinalIgnoreCase).Where(x =&gt; x.Count() &gt; 1);

            var duplicateControllers = groupedByName.ToDictionary(
                g =&gt; g.Key,
                g =&gt; g.ToLookup(t =&gt; t.Namespace ?? String.Empty, StringComparer.OrdinalIgnoreCase),
                StringComparer.OrdinalIgnoreCase);

            var result = new ConcurrentDictionary&lt;string, HttpControllerDescriptor&gt;();

            foreach (var controllerTypeGroup in duplicateControllers)
            {
                foreach (var controllerType in controllerTypeGroup.Value.SelectMany(controllerTypesGrouping =&gt; controllerTypesGrouping))
                {
                    result.TryAdd(string.Format(&quot;{0}-{1}&quot;, controllerTypeGroup.Key, controllerType.Namespace),
                        new HttpControllerDescriptor(_configuration, controllerTypeGroup.Key, controllerType));
                }
            }

            return result;
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,83,19,102,0],[20,9,20,10,0],[21,13,21,44,0],[22,13,22,135,0],[23,9,23,10,0],[26,9,26,10,0],[27,13,27,52,0],[28,13,32,69,0],[33,17,33,55,0],[37,13,37,77,0],[38,13,38,67,0],[39,13,39,48,0],[40,17,40,55,0],[44,13,44,51,0],[45,13,45,57,0],[46,17,46,55,0],[51,13,51,94,0],[52,13,52,36,0],[53,17,53,55,0],[56,13,56,20,0],[56,22,56,28,0],[56,29,56,31,0],[56,32,56,42,0],[57,13,57,14,0],[59,17,59,135,0],[60,17,60,18,0],[61,21,61,39,0],[63,13,63,14,0],[65,13,65,51,0],[66,9,66,10,0],[69,9,69,10,0],[70,13,70,86,0],[71,13,71,95,0],[72,13,72,94,0],[74,13,75,22,0],[75,22,75,82,0],[75,82,76,62,0],[76,62,76,75,0],[76,75,76,77,0],[74,13,76,77,0],[78,13,79,22,0],[79,22,79,27,0],[79,27,80,22,0],[80,22,80,38,0],[80,38,80,65,0],[80,65,80,100,0],[80,22,80,100,0],[80,100,81,51,0],[78,13,81,51,0],[83,13,83,87,0],[85,13,85,20,0],[85,22,85,45,0],[85,46,85,48,0],[85,49,85,69,0],[86,13,86,14,0],[87,17,87,24,0],[87,26,87,44,0],[87,45,87,47,0],[87,48,87,112,0],[87,112,87,135,0],[87,135,87,136,0],[87,48,87,136,0],[88,17,88,18,0],[89,21,90,112,0],[91,17,91,18,0],[92,13,92,14,0],[94,13,94,27,0],[95,9,95,10,0]]);
    </script>
  </body>
</html>