<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\XPathDropDownList\XPathDropDownListDataEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web.UI;
using System.Web.UI.WebControls;
using umbraco;
using umbraco.BusinessLogic;
using umbraco.cms.businesslogic;
using umbraco.cms.businesslogic.datatype;
using umbraco.cms.businesslogic.property;
using umbraco.cms.businesslogic.web;
using umbraco.interfaces;

namespace umbraco.editorControls.XPathDropDownList
{
    /// &lt;summary&gt;
    /// XPath configurabale DropDownList Data Type
    /// &lt;/summary&gt;
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    public class XPathDropDownListDataEditor : CompositeControl, IDataEditor
    {
        /// &lt;summary&gt;
        /// Field for the data.
        /// &lt;/summary&gt;
        private IData data;

        /// &lt;summary&gt;
        /// Field for the options.
        /// &lt;/summary&gt;
        private XPathDropDownListOptions options;

        /// &lt;summary&gt;
        /// Field for the CustomValidator.
        /// &lt;/summary&gt;
        private CustomValidator customValidator = new CustomValidator();

        /// &lt;summary&gt;
        /// Field for the DropDownList.
        /// &lt;/summary&gt;
        private DropDownList dropDownList = new DropDownList();

        /// &lt;summary&gt;
        /// Gets a value indicating whether [treat as rich text editor].
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// 	&lt;c&gt;true&lt;/c&gt; if [treat as rich text editor]; otherwise, &lt;c&gt;false&lt;/c&gt;.
        /// &lt;/value&gt;
        public virtual bool TreatAsRichTextEditor
        {
            get
            {
                return false;
            }
        }

        /// &lt;summary&gt;
        /// Gets a value indicating whether [show label].
        /// &lt;/summary&gt;
        /// &lt;value&gt;&lt;c&gt;true&lt;/c&gt; if [show label]; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/value&gt;
        public virtual bool ShowLabel
        {
            get
            {
                return true;
            }
        }

        /// &lt;summary&gt;
        /// Gets the editor.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The editor.&lt;/value&gt;
        public Control Editor
        {
            get
            {
                return this;
            }
        }

        /// &lt;summary&gt;
        /// Initializes a new instance of XPathCheckBoxListDataEditor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;data&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;options&quot;&gt;&lt;/param&gt;
        internal XPathDropDownListDataEditor(IData data, XPathDropDownListOptions options)
        {
            this.data = data;
            this.options = options;
        }

        /// &lt;summary&gt;
        /// Called by the ASP.NET page framework to notify server controls that use composition-based implementation to create any child controls they contain in preparation for posting back or rendering.
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            switch (this.options.UmbracoObjectType)
            {
                case uQuery.UmbracoObjectType.Unknown:
                case uQuery.UmbracoObjectType.Document:

                    this.dropDownList.DataSource = uQuery.GetNodesByXPath(this.options.XPath).Where(x =&gt; x.Id != -1).ToNameIds();
                    break;

                case uQuery.UmbracoObjectType.Media:

                    this.dropDownList.DataSource = uQuery.GetMediaByXPath(this.options.XPath).Where(x =&gt; x.Id != -1).ToNameIds();
                    break;

                case uQuery.UmbracoObjectType.Member:

                    this.dropDownList.DataSource = uQuery.GetMembersByXPath(this.options.XPath).ToNameIds();
                    break;
            }
            
            this.dropDownList.DataTextField = &quot;Value&quot;;
            this.dropDownList.DataValueField = this.options.UseId ? &quot;Key&quot; : &quot;Value&quot;;
            this.dropDownList.DataBind();

            // Add a default please select value
            this.dropDownList.Items.Insert(0, new ListItem(string.Concat(ui.Text(&quot;choose&quot;), &quot;...&quot;), &quot;-1&quot;));

            this.Controls.Add(this.customValidator);
            this.Controls.Add(this.dropDownList);
        }

        /// &lt;summary&gt;
        /// Raises the &lt;see cref=&quot;E:System.Web.UI.Control.Load&quot;/&gt; event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;The &lt;see cref=&quot;T:System.EventArgs&quot;/&gt; object that contains the event data.&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);
            this.EnsureChildControls();

            if (!this.Page.IsPostBack &amp;&amp; this.data.Value != null)
            {
                // Get selected items from Node Name or Node Id
                var dropDownListItem = this.dropDownList.Items.FindByValue(this.data.Value.ToString());
                if (dropDownListItem != null)
                {
                    dropDownListItem.Selected = true;
                }
            }
        }

        /// &lt;summary&gt;
        /// Called by Umbraco when saving the node
        /// &lt;/summary&gt;
        public void Save()
        {
            Property property = new Property(((umbraco.cms.businesslogic.datatype.DefaultData)this.data).PropertyId);
            if (property.PropertyType.Mandatory &amp;&amp; this.dropDownList.SelectedValue == &quot;-1&quot;)
            {
                // Property is mandatory, but no value selected in the DropDownList
                this.customValidator.IsValid = false;

                DocumentType documentType = new DocumentType(property.PropertyType.ContentTypeId);
                ContentType.TabI tab = documentType.getVirtualTabs.Where(x =&gt; x.Id == property.PropertyType.TabId).FirstOrDefault();

                if (tab != null)
                {
                    this.customValidator.ErrorMessage = ui.Text(&quot;errorHandling&quot;, &quot;errorMandatory&quot;, new string[] { property.PropertyType.Alias, tab.Caption }, User.GetCurrent());
                }
            }

            this.data.Value = this.dropDownList.SelectedValue;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[34,9,34,73,0],[39,9,39,64,0],[50,13,50,14,0],[51,17,51,30,0],[52,13,52,14,0],[62,13,62,14,0],[63,17,63,29,0],[64,13,64,14,0],[74,13,74,14,0],[75,17,75,29,0],[76,13,76,14,0],[84,9,84,91,0],[85,9,85,10,0],[86,13,86,30,0],[87,13,87,36,0],[88,9,88,10,0],[94,9,94,10,0],[95,13,95,52,0],[100,21,100,106,0],[100,106,100,116,0],[100,116,100,130,0],[100,21,100,130,0],[101,21,101,27,0],[105,21,105,106,0],[105,106,105,116,0],[105,116,105,130,0],[105,21,105,130,0],[106,21,106,27,0],[110,21,110,109,0],[111,21,111,27,0],[114,13,114,55,0],[115,13,115,85,0],[116,13,116,42,0],[119,13,119,108,0],[121,13,121,53,0],[122,13,122,50,0],[123,9,123,10,0],[130,9,130,10,0],[131,13,131,28,0],[132,13,132,40,0],[134,13,134,66,0],[135,13,135,14,0],[137,17,137,104,0],[138,17,138,46,0],[139,17,139,18,0],[140,21,140,54,0],[141,17,141,18,0],[142,13,142,14,0],[143,9,143,10,0],[149,9,149,10,0],[150,13,150,118,0],[151,13,151,92,0],[152,13,152,14,0],[154,17,154,54,0],[156,17,156,99,0],[157,17,157,79,0],[157,79,157,114,0],[157,114,157,133,0],[157,17,157,133,0],[159,17,159,33,0],[160,17,160,18,0],[161,21,161,178,0],[162,17,162,18,0],[163,13,163,14,0],[165,13,165,63,0],[166,9,166,10,0]]);
    </script>
  </body>
</html>