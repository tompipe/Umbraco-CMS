<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\Macros\PartialViewMacroEngine.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using System.Web.WebPages;
using Umbraco.Core.IO;
using umbraco.cms.businesslogic.macro;
using Umbraco.Core.Models;
using umbraco.interfaces;
using Umbraco.Web.Models;
using Umbraco.Web.Mvc;
using Umbraco.Core;
using System.Web.Mvc.Html;

namespace Umbraco.Web.Macros
{
    /// &lt;summary&gt;
    /// A macro engine using MVC Partial Views to execute
    /// &lt;/summary&gt;
    public class PartialViewMacroEngine : IMacroEngine
    {
        private readonly Func&lt;HttpContextBase&gt; _getHttpContext;
        private readonly Func&lt;UmbracoContext&gt; _getUmbracoContext;

        public const string EngineName = &quot;Partial View Macro Engine&quot;;

        public PartialViewMacroEngine()
        {
            _getHttpContext = () =&gt;
            {
                if (HttpContext.Current == null)
                    throw new InvalidOperationException(&quot;The &quot; + this.GetType() + &quot; cannot execute with a null HttpContext.Current reference&quot;);
                return new HttpContextWrapper(HttpContext.Current);
            };

            _getUmbracoContext = () =&gt;
            {
                if (UmbracoContext.Current == null)
                    throw new InvalidOperationException(&quot;The &quot; + this.GetType() + &quot; cannot execute with a null UmbracoContext.Current reference&quot;);
                return UmbracoContext.Current;
            };
        }

        /// &lt;summary&gt;
        /// Constructor generally used for unit testing
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;httpContext&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;umbracoContext&quot;&gt; &lt;/param&gt;
        internal PartialViewMacroEngine(HttpContextBase httpContext, UmbracoContext umbracoContext)
        {
            _getHttpContext = () =&gt; httpContext;
            _getUmbracoContext = () =&gt; umbracoContext;
        }

        public string Name
        {
            get { return EngineName; }
        }

		//NOTE: We do not return any supported extensions because we don&#39;t want the MacroEngineFactory to return this
		// macro engine when searching for engines via extension. Those types of engines are reserved for files that are
		// stored in the ~/macroScripts folder and each engine must support unique extensions. This is a total Hack until 
		// we rewrite how macro engines work.
		public IEnumerable&lt;string&gt; SupportedExtensions
		{
			get { return Enumerable.Empty&lt;string&gt;(); }		
		}

		//NOTE: We do not return any supported extensions because we don&#39;t want the MacroEngineFactory to return this
		// macro engine when searching for engines via extension. Those types of engines are reserved for files that are
		// stored in the ~/macroScripts folder and each engine must support unique extensions. This is a total Hack until 
		// we rewrite how macro engines work.
		public IEnumerable&lt;string&gt; SupportedUIExtensions
		{
			get { return Enumerable.Empty&lt;string&gt;(); }
		}
        public Dictionary&lt;string, IMacroGuiRendering&gt; SupportedProperties
        {
            get { throw new NotSupportedException(); }
        }

        public bool Validate(string code, string tempFileName, INode currentPage, out string errorMessage)
        {
            var temp = GetVirtualPathFromPhysicalPath(tempFileName);
            try
            {
                CompileAndInstantiate(temp);
            }
            catch (Exception exception)
            {
                errorMessage = exception.Message;
                return false;
            }
            errorMessage = string.Empty;
            return true;
        }

        public string Execute(MacroModel macro, INode node)
        {
            if (node == null) return string.Empty;

            var umbCtx = _getUmbracoContext();
            //NOTE: This is a bit of a nasty hack to check if the INode is actually already based on an IPublishedContent 
            // (will be the case when using LegacyConvertedNode )
            return Execute(macro,
                (node is IPublishedContent)
                    ? (IPublishedContent)node
                    : umbCtx.ContentCache.GetById(node.Id));
        }

        public string Execute(MacroModel macro, IPublishedContent content)
        {
            if (macro == null) throw new ArgumentNullException(&quot;macro&quot;);
            if (content == null) throw new ArgumentNullException(&quot;content&quot;);
			if (macro.ScriptName.IsNullOrWhiteSpace()) throw new ArgumentException(&quot;The ScriptName property of the macro object cannot be null or empty&quot;);
		
            var http = _getHttpContext();
            var umbCtx = _getUmbracoContext();
            var routeVals = new RouteData();
            routeVals.Values.Add(&quot;controller&quot;, &quot;PartialViewMacro&quot;);
            routeVals.Values.Add(&quot;action&quot;, &quot;Index&quot;);
            routeVals.DataTokens.Add(Umbraco.Core.Constants.Web.UmbracoContextDataToken, umbCtx); //required for UmbracoViewPage

			//lets render this controller as a child action
			var viewContext = new ViewContext {ViewData = new ViewDataDictionary()};;
            //try and extract the current view context from the route values, this would be set in the UmbracoViewPage or in 
            // the UmbracoPageResult if POSTing to an MVC controller but rendering in Webforms
            if (http.Request.RequestContext.RouteData.DataTokens.ContainsKey(Mvc.Constants.DataTokenCurrentViewContext))
            {
                viewContext = (ViewContext)http.Request.RequestContext.RouteData.DataTokens[Mvc.Constants.DataTokenCurrentViewContext];
            }
            routeVals.DataTokens.Add(&quot;ParentActionViewContext&quot;, viewContext);

            var request = new RequestContext(http, routeVals);
            string output;
            using (var controller = new PartialViewMacroController(macro, content))
            {
                controller.ViewData = viewContext.ViewData;
                
				controller.ControllerContext = new ControllerContext(request, controller);

                //call the action to render
                var result = controller.Index();
				output = controller.RenderViewResultAsString(result);
            }

            return output;
        }

        private string GetVirtualPathFromPhysicalPath(string physicalPath)
        {
            string rootpath = _getHttpContext().Server.MapPath(&quot;~/&quot;);
            physicalPath = physicalPath.Replace(rootpath, &quot;&quot;);
            physicalPath = physicalPath.Replace(&quot;\\&quot;, &quot;/&quot;);
            return &quot;~/&quot; + physicalPath;
        }

        private static PartialViewMacroPage CompileAndInstantiate(string virtualPath)
        {
            //Compile Razor - We Will Leave This To ASP.NET Compilation Engine &amp; ASP.NET WebPages
            //Security in medium trust is strict around here, so we can only pass a virtual file path
            //ASP.NET Compilation Engine caches returned types
            //Changed From BuildManager As Other Properties Are Attached Like Context Path/
            var webPageBase = WebPageBase.CreateInstanceFromVirtualPath(virtualPath);
            var webPage = webPageBase as PartialViewMacroPage;
            if (webPage == null)
                throw new InvalidCastException(&quot;All Partial View Macro views must inherit from &quot; + typeof(PartialViewMacroPage).FullName);
            return webPage;
        }

    }

}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,9,32,40,0],[33,9,33,10,0],[34,13,35,13,0],[35,13,35,14,0],[35,14,36,17,0],[36,17,36,49,0],[36,49,37,21,0],[37,21,37,144,0],[37,144,38,17,0],[38,17,38,68,0],[38,68,39,13,0],[39,13,39,14,0],[39,14,39,15,0],[34,13,39,15,0],[41,13,42,13,0],[42,13,42,14,0],[42,14,43,17,0],[43,17,43,52,0],[43,52,44,21,0],[44,21,44,147,0],[44,147,45,17,0],[45,17,45,47,0],[45,47,46,13,0],[46,13,46,14,0],[46,14,46,15,0],[41,13,46,15,0],[47,9,47,10,0],[54,9,54,100,0],[55,9,55,10,0],[56,13,56,37,0],[56,37,56,48,0],[56,48,56,49,0],[56,13,56,49,0],[57,13,57,40,0],[57,40,57,54,0],[57,54,57,55,0],[57,13,57,55,0],[58,9,58,10,0],[62,17,62,18,0],[62,19,62,37,0],[62,38,62,39,0],[71,8,71,9,0],[71,10,71,44,0],[71,45,71,46,0],[80,8,80,9,0],[80,10,80,44,0],[80,45,80,46,0],[84,17,84,18,0],[84,19,84,53,0],[88,9,88,10,0],[89,13,89,69,0],[91,13,91,14,0],[92,17,92,45,0],[93,13,93,14,0],[94,13,94,40,0],[95,13,95,14,0],[96,17,96,50,0],[97,17,97,30,0],[99,13,99,41,0],[100,13,100,25,0],[101,9,101,10,0],[104,9,104,10,0],[105,13,105,30,0],[105,31,105,51,0],[107,13,107,47,0],[110,13,113,61,0],[114,9,114,10,0],[117,9,117,10,0],[118,13,118,31,0],[118,32,118,73,0],[119,13,119,33,0],[119,34,119,77,0],[120,4,120,46,0],[120,47,120,146,0],[122,13,122,42,0],[123,13,123,47,0],[124,13,124,45,0],[125,13,125,68,0],[126,13,126,53,0],[127,13,127,98,0],[130,4,130,76,0],[130,76,130,77,0],[133,13,133,121,0],[134,13,134,14,0],[135,17,135,136,0],[136,13,136,14,0],[137,13,137,78,0],[139,13,139,63,0],[141,20,141,83,0],[142,13,142,14,0],[143,17,143,60,0],[145,5,145,79,0],[148,17,148,49,0],[149,5,149,58,0],[150,13,150,14,0],[152,13,152,27,0],[153,9,153,10,0],[156,9,156,10,0],[157,13,157,70,0],[158,13,158,63,0],[159,13,159,60,0],[160,13,160,40,0],[161,9,161,10,0],[164,9,164,10,0],[169,13,169,86,0],[170,13,170,63,0],[171,13,171,33,0],[172,17,172,139,0],[173,13,173,28,0],[174,9,174,10,0]]);
    </script>
  </body>
</html>