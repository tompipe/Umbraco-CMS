<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\umbraco\controls\Tree\CustomTreeService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web.Script.Services;
using System.Web.Services;
using umbraco;
using umbraco.cms.businesslogic;
using umbraco.cms.presentation.Trees;
using umbraco.controls.Tree;

namespace umbraco.controls.Tree
{
    /// &lt;summary&gt;
    /// Client side ajax utlities for the tree
    /// &lt;/summary&gt;
    [ScriptService]
    [WebService]
    public class CustomTreeService : WebService
    {
        /// &lt;summary&gt;
        /// Returns some info about the node such as path and id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [WebMethod]
        [ScriptMethod(ResponseFormat = ResponseFormat.Json)]
        public NodeInfo GetNodeInfo(int id)
        {
            Authorize();

            var node = new CMSNode(id);
            return new NodeInfo()
            {
                Id = node.Id,
                Path = node.Path,
                PathAsNames = string.Join(&quot;-&gt;&quot;,
                   GetPathNames(node.Path.Split(&#39;,&#39;)
                                       .Select(x =&gt; int.Parse(x))
                                       .ToArray()))
            };
        }

        /// &lt;summary&gt;
        /// returns the node names for each id passed in
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ids&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        private string[] GetPathNames(int[] ids)
        {
            return ids
                .Where(x =&gt; x != -1)
                .Select(x =&gt; new CMSNode(x).Text).ToArray();
        }

        /// &lt;summary&gt;
        /// Returns a key/value object with: json, app, js as the keys
        /// &lt;/summary&gt;	
        /// &lt;returns&gt;&lt;/returns&gt;
        [WebMethod]
        [ScriptMethod(ResponseFormat = ResponseFormat.Json)]
        public Dictionary&lt;string, string&gt; GetInitAppTreeData(string app, string treeType, bool showContextMenu, bool isDialog, TreeDialogModes dialogMode, string functionToCall, string nodeKey)
        {
            Authorize();

            var treeCtl = new TreeControl()
            {
                ShowContextMenu = showContextMenu,
                IsDialog = isDialog,
                DialogMode = dialogMode,
                App = app,
                TreeType = string.IsNullOrEmpty(treeType) ? &quot;&quot; : treeType, //don&#39;t set the tree type unless explicitly set
                NodeKey = string.IsNullOrEmpty(nodeKey) ? &quot;&quot; : nodeKey,
                //StartNodeID = -1, //TODO: set this based on parameters!
                FunctionToCall = string.IsNullOrEmpty(functionToCall) ? &quot;&quot; : functionToCall
            };

            var returnVal = new Dictionary&lt;string, string&gt;();

            if (string.IsNullOrEmpty(treeType))
            {
                //if there&#39;s not tree type specified, then render out the tree as per normal with the normal 
                //way of doing things
                returnVal.Add(&quot;json&quot;, treeCtl.GetJSONInitNode());
            }
            else
            {
                //since 4.5.1 has a bug in it, it ignores if the treeType is specified and will always only render
                //the whole APP not just a specific tree. 
                //this is a work around for this bug until it is fixed (which should be fixed in 4.5.2

                //get the tree that we need to render
                var tree = TreeDefinitionCollection.Instance.FindTree(treeType).CreateInstance();
                tree.ShowContextMenu = showContextMenu;
                tree.IsDialog = isDialog;
                tree.DialogMode = dialogMode;
                tree.NodeKey = string.IsNullOrEmpty(nodeKey) ? &quot;&quot; : nodeKey;
                tree.FunctionToCall = string.IsNullOrEmpty(functionToCall) ? &quot;&quot; : functionToCall;

                //now render it&#39;s start node
                var xTree = new XmlTree();

                //we&#39;re going to hijack the node name here to make it say content/media
                var node = tree.RootNode;
                if (node.Text.Equals(&quot;[FilteredContentTree]&quot;)) node.Text = ui.GetText(&quot;content&quot;);
                else if (node.Text.Equals(&quot;[FilteredMediaTree]&quot;)) node.Text = ui.GetText(&quot;media&quot;);
                xTree.Add(node);

                returnVal.Add(&quot;json&quot;, xTree.ToString());
            }

            returnVal.Add(&quot;app&quot;, app);
            returnVal.Add(&quot;js&quot;, treeCtl.JSCurrApp);

            return returnVal;
        }

        internal static void Authorize()
        {
            if (!umbraco.BasePages.BasePage.ValidateUserContextID(umbraco.BasePages.BasePage.umbracoUserContextID))
                throw new Exception(&quot;Client authorization failed. User is not logged in&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[29,13,29,25,0],[31,13,31,40,0],[32,13,38,53,0],[38,53,38,65,0],[38,65,40,15,0],[32,13,40,15,0],[41,9,41,10,0],[49,9,49,10,0],[50,13,51,29,0],[51,29,51,36,0],[51,36,52,30,0],[52,30,52,49,0],[52,49,52,61,0],[50,13,52,61,0],[53,9,53,10,0],[62,9,62,10,0],[63,13,63,25,0],[65,13,75,15,0],[77,13,77,62,0],[79,13,79,48,0],[80,13,80,14,0],[83,17,83,66,0],[84,13,84,14,0],[86,13,86,14,0],[92,17,92,98,0],[93,17,93,56,0],[94,17,94,42,0],[95,17,95,46,0],[96,17,96,77,0],[97,17,97,98,0],[100,17,100,43,0],[103,17,103,42,0],[104,17,104,63,0],[104,64,104,98,0],[105,22,105,66,0],[105,67,105,99,0],[106,17,106,33,0],[108,17,108,57,0],[109,13,109,14,0],[111,13,111,39,0],[112,13,112,52,0],[114,13,114,30,0],[115,9,115,10,0],[118,9,118,10,0],[119,13,119,116,0],[120,17,120,91,0],[121,9,121,10,0]]);
    </script>
  </body>
</html>