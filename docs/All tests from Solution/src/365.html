<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Persistence\Repositories\NotificationsRepositoryTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Globalization;
using System.Linq;
using Moq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models.EntityBase;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence.Repositories;
using Umbraco.Core.Persistence.UnitOfWork;
using Umbraco.Tests.TestHelpers;

namespace Umbraco.Tests.Persistence.Repositories
{
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture]
    public class NotificationsRepositoryTest : BaseDatabaseFactoryTest
    {
        [Test]
        public void CreateNotification()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            var repo = new NotificationsRepository(unitOfWork);

            var node = new NodeDto {CreateDate = DateTime.Now, Level = 1, NodeObjectType = Guid.Parse(Constants.ObjectTypes.ContentItem), ParentId = -1, Path = &quot;-1,123&quot;, SortOrder = 1, Text = &quot;hello&quot;, Trashed = false, UniqueId = Guid.NewGuid(), UserId = 0};
            var result = unitOfWork.Database.Insert(node);
            var entity = Mock.Of&lt;IEntity&gt;(e =&gt; e.Id == node.NodeId);
            var user = Mock.Of&lt;IUser&gt;(e =&gt; e.Id == node.UserId);

            var notification = repo.CreateNotification(user, entity, &quot;A&quot;);

            Assert.AreEqual(&quot;A&quot;, notification.Action);
            Assert.AreEqual(node.NodeId, notification.EntityId);
            Assert.AreEqual(node.NodeObjectType, notification.EntityType);
            Assert.AreEqual(node.UserId, notification.UserId);
        }

        [Test]
        public void GetUserNotifications()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            var repo = new NotificationsRepository(unitOfWork);

            var userDto = new UserDto { ContentStartId = -1, Email = &quot;test&quot; , Login = &quot;test&quot; , MediaStartId = -1, Password = &quot;test&quot; , Type = 1, UserName = &quot;test&quot; , UserLanguage = &quot;en&quot; };
            unitOfWork.Database.Insert(userDto);

            var userNew = Mock.Of&lt;IUser&gt;(e =&gt; e.Id == userDto.Id);
            var userAdmin = Mock.Of&lt;IUser&gt;(e =&gt; e.Id == 0);

            for (var i = 0; i &lt; 10; i++)
            {
                var node = new NodeDto { CreateDate = DateTime.Now, Level = 1, NodeObjectType = Guid.Parse(Constants.ObjectTypes.ContentItem), ParentId = -1, Path = &quot;-1,&quot; + i, SortOrder = 1, Text = &quot;hello&quot; + i, Trashed = false, UniqueId = Guid.NewGuid(), UserId = 0 };
                var result = unitOfWork.Database.Insert(node);
                var entity = Mock.Of&lt;IEntity&gt;(e =&gt; e.Id == node.NodeId);
                var notification = repo.CreateNotification((i % 2 == 0) ? userAdmin : userNew, entity, i.ToString(CultureInfo.InvariantCulture));    
            }

            var notifications = repo.GetUserNotifications(userAdmin);

            Assert.AreEqual(5, notifications.Count());            
        }

        [Test]
        public void GetEntityNotifications()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            var repo = new NotificationsRepository(unitOfWork);
            
            var node1 = new NodeDto { CreateDate = DateTime.Now, Level = 1, NodeObjectType = Guid.Parse(Constants.ObjectTypes.ContentItem), ParentId = -1, Path = &quot;-1,1&quot;, SortOrder = 1, Text = &quot;hello1&quot;, Trashed = false, UniqueId = Guid.NewGuid(), UserId = 0 };
            unitOfWork.Database.Insert(node1);
            var entity1 = Mock.Of&lt;IEntity&gt;(e =&gt; e.Id == node1.NodeId);
            var node2 = new NodeDto { CreateDate = DateTime.Now, Level = 1, NodeObjectType = Guid.Parse(Constants.ObjectTypes.ContentItem), ParentId = -1, Path = &quot;-1,2&quot;, SortOrder = 1, Text = &quot;hello2&quot;, Trashed = false, UniqueId = Guid.NewGuid(), UserId = 0 };
            unitOfWork.Database.Insert(node2);
            var entity2 = Mock.Of&lt;IEntity&gt;(e =&gt; e.Id == node2.NodeId);

            for (var i = 0; i &lt; 10; i++)
            {
                var userDto = new UserDto { ContentStartId = -1, Email = &quot;test&quot; + i, Login = &quot;test&quot; + i, MediaStartId = -1, Password = &quot;test&quot;, Type = 1, UserName = &quot;test&quot; + i, UserLanguage = &quot;en&quot; };
                unitOfWork.Database.Insert(userDto);
                var userNew = Mock.Of&lt;IUser&gt;(e =&gt; e.Id == userDto.Id);
                var notification = repo.CreateNotification(userNew, (i % 2 == 0) ? entity1 : entity2, i.ToString(CultureInfo.InvariantCulture));
            }

            var notifications = repo.GetEntityNotifications(entity1);

            Assert.AreEqual(5, notifications.Count());
        }

        [Test]
        public void Delete_By_Entity()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            var repo = new NotificationsRepository(unitOfWork);

            var node1 = new NodeDto { CreateDate = DateTime.Now, Level = 1, NodeObjectType = Guid.Parse(Constants.ObjectTypes.ContentItem), ParentId = -1, Path = &quot;-1,1&quot;, SortOrder = 1, Text = &quot;hello1&quot;, Trashed = false, UniqueId = Guid.NewGuid(), UserId = 0 };
            unitOfWork.Database.Insert(node1);
            var entity1 = Mock.Of&lt;IEntity&gt;(e =&gt; e.Id == node1.NodeId);
            var node2 = new NodeDto { CreateDate = DateTime.Now, Level = 1, NodeObjectType = Guid.Parse(Constants.ObjectTypes.ContentItem), ParentId = -1, Path = &quot;-1,2&quot;, SortOrder = 1, Text = &quot;hello2&quot;, Trashed = false, UniqueId = Guid.NewGuid(), UserId = 0 };
            unitOfWork.Database.Insert(node2);
            var entity2 = Mock.Of&lt;IEntity&gt;(e =&gt; e.Id == node2.NodeId);

            for (var i = 0; i &lt; 10; i++)
            {
                var userDto = new UserDto { ContentStartId = -1, Email = &quot;test&quot; + i, Login = &quot;test&quot; + i, MediaStartId = -1, Password = &quot;test&quot;, Type = 1, UserName = &quot;test&quot; + i, UserLanguage = &quot;en&quot; };
                unitOfWork.Database.Insert(userDto);
                var userNew = Mock.Of&lt;IUser&gt;(e =&gt; e.Id == userDto.Id);
                var notification = repo.CreateNotification(userNew, (i % 2 == 0) ? entity1 : entity2, i.ToString(CultureInfo.InvariantCulture));
            }

            var delCount = repo.DeleteNotifications(entity1);

            Assert.AreEqual(5, delCount);
        }

        [Test]
        public void Delete_By_User()
        {
            var provider = new PetaPocoUnitOfWorkProvider(Logger);
            var unitOfWork = provider.GetUnitOfWork();
            var repo = new NotificationsRepository(unitOfWork);

            var userDto = new UserDto { ContentStartId = -1, Email = &quot;test&quot;, Login = &quot;test&quot;, MediaStartId = -1, Password = &quot;test&quot;, Type = 1, UserName = &quot;test&quot;, UserLanguage = &quot;en&quot; };
            unitOfWork.Database.Insert(userDto);

            var userNew = Mock.Of&lt;IUser&gt;(e =&gt; e.Id == userDto.Id);
            var userAdmin = Mock.Of&lt;IUser&gt;(e =&gt; e.Id == 0);

            for (var i = 0; i &lt; 10; i++)
            {
                var node = new NodeDto { CreateDate = DateTime.Now, Level = 1, NodeObjectType = Guid.Parse(Constants.ObjectTypes.ContentItem), ParentId = -1, Path = &quot;-1,&quot; + i, SortOrder = 1, Text = &quot;hello&quot; + i, Trashed = false, UniqueId = Guid.NewGuid(), UserId = 0 };
                var result = unitOfWork.Database.Insert(node);
                var entity = Mock.Of&lt;IEntity&gt;(e =&gt; e.Id == node.NodeId);
                var notification = repo.CreateNotification((i % 2 == 0) ? userAdmin : userNew, entity, i.ToString(CultureInfo.InvariantCulture));
            }

            var delCount = repo.DeleteNotifications(userAdmin);

            Assert.AreEqual(5, delCount);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,67,1],[24,13,24,55,1],[25,13,25,64,1],[27,13,27,258,1],[28,13,28,59,1],[29,13,29,69,1],[30,13,30,65,1],[32,13,32,75,1],[34,13,34,55,1],[35,13,35,65,1],[36,13,36,75,1],[37,13,37,63,1],[38,9,38,10,1],[42,9,42,10,1],[43,13,43,67,1],[44,13,44,55,1],[45,13,45,64,1],[47,13,47,187,1],[48,13,48,49,1],[50,13,50,67,1],[51,13,51,60,1],[53,18,53,27,1],[53,29,53,35,1],[53,37,53,40,1],[54,13,54,14,1],[55,17,55,269,1],[56,17,56,63,1],[57,17,57,73,1],[58,17,58,146,1],[59,13,59,14,1],[61,13,61,70,1],[63,13,63,55,1],[64,9,64,10,1],[68,9,68,10,1],[69,13,69,67,1],[70,13,70,55,1],[71,13,71,64,1],[73,13,73,260,1],[74,13,74,47,1],[75,13,75,71,1],[76,13,76,260,1],[77,13,77,47,1],[78,13,78,71,1],[80,18,80,27,1],[80,29,80,35,1],[80,37,80,40,1],[81,13,81,14,1],[82,17,82,199,1],[83,17,83,53,1],[84,17,84,71,1],[85,17,85,145,1],[86,13,86,14,1],[88,13,88,70,1],[90,13,90,55,1],[91,9,91,10,1],[95,9,95,10,1],[96,13,96,67,1],[97,13,97,55,1],[98,13,98,64,1],[100,13,100,260,1],[101,13,101,47,1],[102,13,102,71,1],[103,13,103,260,1],[104,13,104,47,1],[105,13,105,71,1],[107,18,107,27,1],[107,29,107,35,1],[107,37,107,40,1],[108,13,108,14,1],[109,17,109,199,1],[110,17,110,53,1],[111,17,111,71,1],[112,17,112,145,1],[113,13,113,14,1],[115,13,115,62,1],[117,13,117,42,1],[118,9,118,10,1],[122,9,122,10,1],[123,13,123,67,1],[124,13,124,55,1],[125,13,125,64,1],[127,13,127,183,1],[128,13,128,49,1],[130,13,130,67,1],[131,13,131,60,1],[133,18,133,27,1],[133,29,133,35,1],[133,37,133,40,1],[134,13,134,14,1],[135,17,135,269,1],[136,17,136,63,1],[137,17,137,73,1],[138,17,138,146,1],[139,13,139,14,1],[141,13,141,64,1],[143,13,143,42,1],[144,9,144,10,1]]);
    </script>
  </body>
</html>