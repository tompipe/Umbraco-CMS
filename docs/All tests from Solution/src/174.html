<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Services\UserServiceTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using NUnit.Framework;
using Umbraco.Core.Models.Membership;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers.Entities;
using umbraco.BusinessLogic.Actions;
using Umbraco.Core.Persistence.Querying;
using Umbraco.Core.Services;
using Umbraco.Tests.TestHelpers;
using Umbraco.Tests.TestHelpers.Entities;
using umbraco.BusinessLogic.Actions;

namespace Umbraco.Tests.Services
{
    /// &lt;summary&gt;
    /// Tests covering the UserService
    /// &lt;/summary&gt;
    [DatabaseTestBehavior(DatabaseBehavior.NewDbFileAndSchemaPerTest)]
    [TestFixture, RequiresSTA]
    public class UserServiceTests : BaseServiceTest
    {
        [SetUp]
        public override void Initialize()
        {
            base.Initialize();
        }

        [TearDown]
        public override void TearDown()
        {
            base.TearDown();
        }

        [Test]
        public void UserService_Get_User_Permissions_For_Unassigned_Permission_Nodes()
        {
            // Arrange
            var userService = ServiceContext.UserService;
            var userType = userService.GetUserTypeByAlias(&quot;admin&quot;);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;test1&quot;, &quot;test1@test.com&quot;, userType);
            var contentType = MockedContentTypes.CreateSimpleContentType();
            ServiceContext.ContentTypeService.Save(contentType);
            var content = new[]
                {
                    MockedContent.CreateSimpleContent(contentType),
                    MockedContent.CreateSimpleContent(contentType),
                    MockedContent.CreateSimpleContent(contentType)
                };
            ServiceContext.ContentService.Save(content);

            // Act
            var permissions = userService.GetPermissions(user, content.ElementAt(0).Id, content.ElementAt(1).Id, content.ElementAt(2).Id);

            //assert
            Assert.AreEqual(3, permissions.Count());
            Assert.AreEqual(17, permissions.ElementAt(0).AssignedPermissions.Count());
            Assert.AreEqual(17, permissions.ElementAt(1).AssignedPermissions.Count());
            Assert.AreEqual(17, permissions.ElementAt(2).AssignedPermissions.Count());
        }

        [Test]
        public void UserService_Get_User_Permissions_For_Assigned_Permission_Nodes()
        {
            // Arrange
            var userService = ServiceContext.UserService;
            var userType = userService.GetUserTypeByAlias(&quot;admin&quot;);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;test1&quot;, &quot;test1@test.com&quot;, userType);
            var contentType = MockedContentTypes.CreateSimpleContentType();
            ServiceContext.ContentTypeService.Save(contentType);
            var content = new[]
                {
                    MockedContent.CreateSimpleContent(contentType),
                    MockedContent.CreateSimpleContent(contentType),
                    MockedContent.CreateSimpleContent(contentType)
                };
            ServiceContext.ContentService.Save(content);
            ServiceContext.ContentService.AssignContentPermission(content.ElementAt(0), ActionBrowse.Instance.Letter, new int[] { user.Id });
            ServiceContext.ContentService.AssignContentPermission(content.ElementAt(0), ActionDelete.Instance.Letter, new int[] { user.Id });
            ServiceContext.ContentService.AssignContentPermission(content.ElementAt(0), ActionMove.Instance.Letter, new int[] { user.Id });

            ServiceContext.ContentService.AssignContentPermission(content.ElementAt(1), ActionBrowse.Instance.Letter, new int[] { user.Id });
            ServiceContext.ContentService.AssignContentPermission(content.ElementAt(1), ActionDelete.Instance.Letter, new int[] { user.Id });

            ServiceContext.ContentService.AssignContentPermission(content.ElementAt(2), ActionBrowse.Instance.Letter, new int[] { user.Id });

            // Act
            var permissions = userService.GetPermissions(user, content.ElementAt(0).Id, content.ElementAt(1).Id, content.ElementAt(2).Id);

            //assert
            Assert.AreEqual(3, permissions.Count());
            Assert.AreEqual(3, permissions.ElementAt(0).AssignedPermissions.Count());
            Assert.AreEqual(2, permissions.ElementAt(1).AssignedPermissions.Count());
            Assert.AreEqual(1, permissions.ElementAt(2).AssignedPermissions.Count());
        }
        
        [Test]
        public void Can_Delete_User()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;JohnDoe&quot;, &quot;john@umbraco.io&quot;, userType);
            
            ServiceContext.UserService.Delete(user, true);
            var deleted = ServiceContext.UserService.GetUserById(user.Id);

            // Assert
            Assert.That(deleted, Is.Null);
        }

        [Test]
        public void Disables_User_Instead_Of_Deleting_If_Flag_Not_Set()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;JohnDoe&quot;, &quot;john@umbraco.io&quot;, userType);

            ServiceContext.UserService.Delete(user);
            var deleted = ServiceContext.UserService.GetUserById(user.Id);

            // Assert
            Assert.That(deleted, Is.Not.Null);
        }

        [Test]
        public void Exists_By_Username()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;JohnDoe&quot;, &quot;john@umbraco.io&quot;, userType);
            var user2 = ServiceContext.UserService.CreateUserWithIdentity(&quot;john2@umbraco.io&quot;, &quot;john2@umbraco.io&quot;, userType);
            Assert.IsTrue(ServiceContext.UserService.Exists(&quot;JohnDoe&quot;));
            Assert.IsFalse(ServiceContext.UserService.Exists(&quot;notFound&quot;));
            Assert.IsTrue(ServiceContext.UserService.Exists(&quot;john2@umbraco.io&quot;));
        }

        [Test]
        public void Get_By_Email()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;JohnDoe&quot;, &quot;john@umbraco.io&quot;, userType);

            Assert.IsNotNull(ServiceContext.UserService.GetByEmail(user.Email));
            Assert.IsNull(ServiceContext.UserService.GetByEmail(&quot;do@not.find&quot;));
        }

        [Test]
        public void Get_By_Username()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;JohnDoe&quot;, &quot;john@umbraco.io&quot;, userType);

            Assert.IsNotNull(ServiceContext.UserService.GetByUsername(user.Username));
            Assert.IsNull(ServiceContext.UserService.GetByUsername(&quot;notFound&quot;));
        }

        [Test]
        public void Get_By_Username_With_Backslash()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;mydomain\\JohnDoe&quot;, &quot;john@umbraco.io&quot;, userType);

            Assert.IsNotNull(ServiceContext.UserService.GetByUsername(user.Username));
            Assert.IsNull(ServiceContext.UserService.GetByUsername(&quot;notFound&quot;));
        }

        [Test]
        public void Get_By_Object_Id()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;JohnDoe&quot;, &quot;john@umbraco.io&quot;, userType);

            Assert.IsNotNull(ServiceContext.UserService.GetUserById(user.Id));
            Assert.IsNull(ServiceContext.UserService.GetUserById(9876));
        }

        [Test]
        public void Find_By_Email_Starts_With()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10);
            ServiceContext.UserService.Save(users);
            //don&#39;t find this
            var customUser = MockedUser.CreateUser(userType);
            customUser.Email = &quot;hello@hello.com&quot;;
            ServiceContext.UserService.Save(customUser);

            int totalRecs;
            var found = ServiceContext.UserService.FindByEmail(&quot;tes&quot;, 0, 100, out totalRecs, StringPropertyMatchType.StartsWith);

            Assert.AreEqual(10, found.Count());
        }

        [Test]
        public void Find_By_Email_Ends_With()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10);
            ServiceContext.UserService.Save(users);
            //include this
            var customUser = MockedUser.CreateUser(userType);
            customUser.Email = &quot;hello@test.com&quot;;
            ServiceContext.UserService.Save(customUser);

            int totalRecs;
            var found = ServiceContext.UserService.FindByEmail(&quot;test.com&quot;, 0, 100, out totalRecs, StringPropertyMatchType.EndsWith);

            Assert.AreEqual(11, found.Count());
        }

        [Test]
        public void Find_By_Email_Contains()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10);
            ServiceContext.UserService.Save(users);
            //include this
            var customUser = MockedUser.CreateUser(userType);
            customUser.Email = &quot;hello@test.com&quot;;
            ServiceContext.UserService.Save(customUser);

            int totalRecs;
            var found = ServiceContext.UserService.FindByEmail(&quot;test&quot;, 0, 100, out totalRecs, StringPropertyMatchType.Contains);

            Assert.AreEqual(11, found.Count());
        }

        [Test]
        public void Find_By_Email_Exact()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10);
            ServiceContext.UserService.Save(users);
            //include this
            var customUser = MockedUser.CreateUser(userType);
            customUser.Email = &quot;hello@test.com&quot;;
            ServiceContext.UserService.Save(customUser);

            int totalRecs;
            var found = ServiceContext.UserService.FindByEmail(&quot;hello@test.com&quot;, 0, 100, out totalRecs, StringPropertyMatchType.Exact);

            Assert.AreEqual(1, found.Count());
        }

        [Test]
        public void Get_All_Paged_Users()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10);
            ServiceContext.UserService.Save(users);

            int totalRecs;
            var found = ServiceContext.UserService.GetAll(0, 2, out totalRecs);

            Assert.AreEqual(2, found.Count());
            // + 1 because of the built in admin user
            Assert.AreEqual(11, totalRecs);
            Assert.AreEqual(&quot;admin&quot;, found.First().Username);
            Assert.AreEqual(&quot;test0&quot;, found.Last().Username);
        }

        [Test]
        public void Count_All_Users()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10);
            ServiceContext.UserService.Save(users);
            var customUser = MockedUser.CreateUser(userType);
            ServiceContext.UserService.Save(customUser);

            var found = ServiceContext.UserService.GetCount(MemberCountType.All);

            // + 1 because of the built in admin user
            Assert.AreEqual(12, found);
        }

        [Ignore]
        [Test]
        public void Count_All_Online_Users()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10, (i, member) =&gt; member.LastLoginDate = DateTime.Now.AddMinutes(i * -2));
            ServiceContext.UserService.Save(users);

            var customUser = MockedUser.CreateUser(userType);
            throw new NotImplementedException();
        }

        [Test]
        public void Count_All_Locked_Users()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10, (i, member) =&gt; member.IsLockedOut = i % 2 == 0);
            ServiceContext.UserService.Save(users);

            var customUser = MockedUser.CreateUser(userType);
            customUser.IsLockedOut = true;
            ServiceContext.UserService.Save(customUser);

            var found = ServiceContext.UserService.GetCount(MemberCountType.LockedOut);

            Assert.AreEqual(6, found);
        }

        [Test]
        public void Count_All_Approved_Users()
        {
            var userType = MockedUserType.CreateUserType();
            ServiceContext.UserService.SaveUserType(userType);
            var users = MockedUser.CreateUser(userType, 10, (i, member) =&gt; member.IsApproved = i % 2 == 0);
            ServiceContext.UserService.Save(users);

            var customUser = MockedUser.CreateUser(userType);
            customUser.IsApproved = false;
            ServiceContext.UserService.Save(customUser);

            var found = ServiceContext.UserService.GetCount(MemberCountType.Approved);

            // + 1 because of the built in admin user
            Assert.AreEqual(6, found);
        }

        [Test]
        public void Can_Persist_New_User_Type()
        {
            // Arrange
            var userService = ServiceContext.UserService;
            var userType = MockedUserType.CreateUserType();

            // Act
            userService.SaveUserType(userType);

            // Assert
            Assert.That(userType.HasIdentity, Is.True);
        }

        [Test]
        public void Can_Persist_New_User()
        {
            // Arrange
            var userService = ServiceContext.UserService;
            var userType = userService.GetUserTypeByAlias(&quot;admin&quot;);

            // Act
            var membershipUser = userService.CreateUserWithIdentity(&quot;JohnDoe&quot;, &quot;john@umbraco.io&quot;, userType);

            // Assert
            Assert.That(membershipUser.HasIdentity, Is.True);
            Assert.That(membershipUser.Id, Is.GreaterThan(0));
            IUser user = membershipUser as User;
            Assert.That(user, Is.Not.Null);
            Assert.That(user.DefaultPermissions, Is.EqualTo(userType.Permissions));
        }

        [Test]
        public void Can_Persist_New_User_With_Hashed_Password()
        {
            // Arrange
            var userService = ServiceContext.UserService;
            var userType = userService.GetUserTypeByAlias(&quot;admin&quot;);

            // Act
            // NOTE: Normally the hash&#39;ing would be handled in the membership provider, so the service just saves the password
            var password = &quot;123456&quot;;
            var hash = new HMACSHA1();
            hash.Key = Encoding.Unicode.GetBytes(password);
            var encodedPassword = Convert.ToBase64String(hash.ComputeHash(Encoding.Unicode.GetBytes(password)));
            var membershipUser = new User(&quot;JohnDoe&quot;, &quot;john@umbraco.io&quot;, encodedPassword, encodedPassword, userType);
            userService.Save(membershipUser);

            // Assert
            Assert.That(membershipUser.HasIdentity, Is.True);
            Assert.That(membershipUser.RawPasswordValue, Is.Not.EqualTo(password));
            Assert.That(membershipUser.RawPasswordValue, Is.EqualTo(encodedPassword));
            IUser user = membershipUser as User;
            Assert.That(user, Is.Not.Null);
            Assert.That(user.DefaultPermissions, Is.EqualTo(userType.Permissions));
        }

        [Test]
        public void Can_Add_And_Remove_Sections_From_User()
        {
            var userType = ServiceContext.UserService.GetUserTypeByAlias(&quot;admin&quot;);

            var user1 = ServiceContext.UserService.CreateUserWithIdentity(&quot;test1&quot;, &quot;test1@test.com&quot;, userType);

            var result1 = ServiceContext.UserService.GetUserById((int)user1.Id);
            //expect 2 sections by default
            Assert.AreEqual(2, result1.AllowedSections.Count());

            //adds some allowed sections
            user1.AddAllowedSection(&quot;test1&quot;);
            user1.AddAllowedSection(&quot;test2&quot;);
            user1.AddAllowedSection(&quot;test3&quot;);
            user1.AddAllowedSection(&quot;test4&quot;);
            ServiceContext.UserService.Save(user1);

            result1 = ServiceContext.UserService.GetUserById((int)user1.Id);
            //expect 6 sections including the two default sections
            Assert.AreEqual(6, result1.AllowedSections.Count());

            //simulate clearing the sections
            foreach (var s in user1.AllowedSections)
            {
                result1.RemoveAllowedSection(s);
            }
            //now just re-add a couple
            result1.AddAllowedSection(&quot;test3&quot;);
            result1.AddAllowedSection(&quot;test4&quot;);
            ServiceContext.UserService.Save(result1);

            //assert
            //re-get
            result1 = ServiceContext.UserService.GetUserById((int)user1.Id);
            Assert.AreEqual(2, result1.AllowedSections.Count());
        }

        [Test]
        public void Can_Remove_Section_From_All_Assigned_Users()
        {            
            var userType = ServiceContext.UserService.GetUserTypeByAlias(&quot;admin&quot;);

            var user1 = ServiceContext.UserService.CreateUserWithIdentity(&quot;test1&quot;, &quot;test1@test.com&quot;, userType);
            var user2 = ServiceContext.UserService.CreateUserWithIdentity(&quot;test2&quot;, &quot;test2@test.com&quot;, userType);
            
            //adds some allowed sections
            user1.AddAllowedSection(&quot;test&quot;);
            user2.AddAllowedSection(&quot;test&quot;);
            ServiceContext.UserService.Save(user1);
            ServiceContext.UserService.Save(user2);

            //now clear the section from all users
            ServiceContext.UserService.DeleteSectionFromAllUsers(&quot;test&quot;);

            //assert
            var result1 = ServiceContext.UserService.GetUserById((int)user1.Id);
            var result2 = ServiceContext.UserService.GetUserById((int)user2.Id);
            Assert.IsFalse(result1.AllowedSections.Contains(&quot;test&quot;));
            Assert.IsFalse(result2.AllowedSections.Contains(&quot;test&quot;));
        }

        [Test]
        public void Can_Add_Section_To_All_Users()
        {
            var userType = ServiceContext.UserService.GetUserTypeByAlias(&quot;admin&quot;);

            var user1 = ServiceContext.UserService.CreateUserWithIdentity(&quot;test1&quot;, &quot;test1@test.com&quot;, userType);
            var user2 = ServiceContext.UserService.CreateUserWithIdentity(&quot;test2&quot;, &quot;test2@test.com&quot;, userType);
            var user3 = ServiceContext.UserService.CreateUserWithIdentity(&quot;test3&quot;, &quot;test3@test.com&quot;, userType);
            var user4 = ServiceContext.UserService.CreateUserWithIdentity(&quot;test4&quot;, &quot;test4@test.com&quot;, userType);

            //now add the section to specific users
            ServiceContext.UserService.AddSectionToAllUsers(&quot;test&quot;, (int)user1.Id, (int)user2.Id);

            //assert
            var result1 = ServiceContext.UserService.GetUserById((int)user1.Id);
            var result2 = ServiceContext.UserService.GetUserById((int)user2.Id);
            var result3 = ServiceContext.UserService.GetUserById((int)user3.Id);
            var result4 = ServiceContext.UserService.GetUserById((int)user4.Id);
            Assert.IsTrue(result1.AllowedSections.Contains(&quot;test&quot;));
            Assert.IsTrue(result2.AllowedSections.Contains(&quot;test&quot;));
            Assert.IsFalse(result3.AllowedSections.Contains(&quot;test&quot;));
            Assert.IsFalse(result4.AllowedSections.Contains(&quot;test&quot;));

            //now add the section to all users
            ServiceContext.UserService.AddSectionToAllUsers(&quot;test&quot;);

            //assert
            result1 = ServiceContext.UserService.GetUserById((int)user1.Id);
            result2 = ServiceContext.UserService.GetUserById((int)user2.Id);
            result3 = ServiceContext.UserService.GetUserById((int)user3.Id);
            result4 = ServiceContext.UserService.GetUserById((int)user4.Id);
            Assert.IsTrue(result1.AllowedSections.Contains(&quot;test&quot;));
            Assert.IsTrue(result2.AllowedSections.Contains(&quot;test&quot;));
            Assert.IsTrue(result3.AllowedSections.Contains(&quot;test&quot;));
            Assert.IsTrue(result4.AllowedSections.Contains(&quot;test&quot;));
        }

        [Test]
        public void Cannot_Create_User_With_Empty_Username()
        {
            // Arrange
            var userService = ServiceContext.UserService;
            var userType = userService.GetUserTypeByAlias(&quot;admin&quot;);

            // Act &amp; Assert
            Assert.Throws&lt;ArgumentException&gt;(() =&gt; userService.CreateUserWithIdentity(string.Empty, &quot;john@umbraco.io&quot;, userType));
        }

        [Test]
        public void Cannot_Save_User_With_Empty_Username()
        {
            // Arrange
            var userService = ServiceContext.UserService;
            var userType = userService.GetUserTypeByAlias(&quot;admin&quot;);
            var user = userService.CreateUserWithIdentity(&quot;John Doe&quot;, &quot;john@umbraco.io&quot;, userType);
            user.Username = string.Empty;

            // Act &amp; Assert
            Assert.Throws&lt;ArgumentException&gt;(() =&gt; userService.Save(user));
        }

        [Test]
        public void Cannot_Save_User_With_Empty_Name()
        {
            // Arrange
            var userService = ServiceContext.UserService;
            var userType = userService.GetUserTypeByAlias(&quot;admin&quot;);
            var user = userService.CreateUserWithIdentity(&quot;John Doe&quot;, &quot;john@umbraco.io&quot;, userType);
            user.Name = string.Empty;

            // Act &amp; Assert
            Assert.Throws&lt;ArgumentException&gt;(() =&gt; userService.Save(user));
        }

        [Test]
        public void Get_By_Profile_Username()
        {
            // Arrange
            var userType = ServiceContext.UserService.GetUserTypeByAlias(&quot;admin&quot;);
            var user = ServiceContext.UserService.CreateUserWithIdentity(&quot;test1&quot;, &quot;test1@test.com&quot;, userType);

            // Act

            var profile = ServiceContext.UserService.GetProfileByUserName(user.Username);

            // Assert
            Assert.IsNotNull(profile);
            Assert.AreEqual(user.Username, profile.Name);
            Assert.AreEqual(user.Id, profile.Id);
        }

        [Test]
        public void Get_By_Profile_Id()
        {
            // Arrange
            var userType = ServiceContext.UserService.GetUserTypeByAlias(&quot;admin&quot;);
            var user = (IUser)ServiceContext.UserService.CreateUserWithIdentity(&quot;test1&quot;, &quot;test1@test.com&quot;, userType);

            // Act

            var profile = ServiceContext.UserService.GetProfileById((int)user.Id);

            // Assert
            Assert.IsNotNull(profile);
            Assert.AreEqual(user.Username, profile.Name);
            Assert.AreEqual(user.Id, profile.Id);
        }

        [Test]
        public void Get_User_By_Username()
        {
            // Arrange
            var userType = ServiceContext.UserService.GetUserTypeByAlias(&quot;admin&quot;);
            var originalUser = (User)ServiceContext.UserService.CreateUserWithIdentity(&quot;test1&quot;, &quot;test1@test.com&quot;, userType);

            // Act

            var updatedItem = (User)ServiceContext.UserService.GetByUsername(originalUser.Username);

            // Assert
            Assert.IsNotNull(updatedItem);
            Assert.That(updatedItem.Id, Is.EqualTo(originalUser.Id));
            Assert.That(updatedItem.Name, Is.EqualTo(originalUser.Name));
            Assert.That(updatedItem.DefaultPermissions, Is.EqualTo(originalUser.DefaultPermissions));
            Assert.That(updatedItem.Language, Is.EqualTo(originalUser.Language));
            Assert.That(updatedItem.IsApproved, Is.EqualTo(originalUser.IsApproved));
            Assert.That(updatedItem.RawPasswordValue, Is.EqualTo(originalUser.RawPasswordValue));
            Assert.That(updatedItem.IsLockedOut, Is.EqualTo(originalUser.IsLockedOut));
            Assert.That(updatedItem.StartContentId, Is.EqualTo(originalUser.StartContentId));
            Assert.That(updatedItem.StartMediaId, Is.EqualTo(originalUser.StartMediaId));
            Assert.That(updatedItem.Email, Is.EqualTo(originalUser.Email));
            Assert.That(updatedItem.Username, Is.EqualTo(originalUser.Username));
            Assert.That(updatedItem.AllowedSections.Count(), Is.EqualTo(2));
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[27,9,27,10,1],[28,13,28,31,1],[29,9,29,10,1],[33,9,33,10,1],[34,13,34,29,1],[35,9,35,10,1],[39,9,39,10,1],[41,13,41,58,1],[42,13,42,68,1],[43,13,43,111,1],[44,13,44,76,1],[45,13,45,65,1],[46,13,51,19,1],[52,13,52,57,1],[55,13,55,139,1],[58,13,58,53,1],[59,13,59,87,1],[60,13,60,87,1],[61,13,61,87,1],[62,9,62,10,1],[66,9,66,10,1],[68,13,68,58,1],[69,13,69,68,1],[70,13,70,111,1],[71,13,71,76,1],[72,13,72,65,1],[73,13,78,19,1],[79,13,79,57,1],[80,13,80,142,1],[81,13,81,142,1],[82,13,82,140,1],[84,13,84,142,1],[85,13,85,142,1],[87,13,87,142,1],[90,13,90,139,1],[93,13,93,53,1],[94,13,94,86,1],[95,13,95,86,1],[96,13,96,86,1],[97,9,97,10,1],[101,9,101,10,1],[102,13,102,60,1],[103,13,103,63,1],[104,13,104,114,1],[106,13,106,59,1],[107,13,107,75,1],[110,13,110,43,1],[111,9,111,10,1],[115,9,115,10,1],[116,13,116,60,1],[117,13,117,63,1],[118,13,118,114,1],[120,13,120,53,1],[121,13,121,75,1],[124,13,124,47,1],[125,9,125,10,1],[129,9,129,10,1],[130,13,130,60,1],[131,13,131,63,1],[132,13,132,114,1],[133,13,133,125,1],[134,13,134,73,1],[135,13,135,75,1],[136,13,136,82,1],[137,9,137,10,1],[141,9,141,10,1],[142,13,142,60,1],[143,13,143,63,1],[144,13,144,114,1],[146,13,146,81,1],[147,13,147,81,1],[148,9,148,10,1],[152,9,152,10,1],[153,13,153,60,1],[154,13,154,63,1],[155,13,155,114,1],[157,13,157,87,1],[158,13,158,81,1],[159,9,159,10,1],[163,9,163,10,1],[164,13,164,60,1],[165,13,165,63,1],[166,13,166,124,1],[168,13,168,87,1],[169,13,169,81,1],[170,9,170,10,1],[174,9,174,10,1],[175,13,175,60,1],[176,13,176,63,1],[177,13,177,114,1],[179,13,179,79,1],[180,13,180,73,1],[181,9,181,10,1],[185,9,185,10,1],[186,13,186,60,1],[187,13,187,63,1],[188,13,188,61,1],[189,13,189,52,1],[191,13,191,62,1],[192,13,192,50,1],[193,13,193,57,1],[196,13,196,130,1],[198,13,198,48,1],[199,9,199,10,1],[203,9,203,10,1],[204,13,204,60,1],[205,13,205,63,1],[206,13,206,61,1],[207,13,207,52,1],[209,13,209,62,1],[210,13,210,49,1],[211,13,211,57,1],[214,13,214,133,1],[216,13,216,48,1],[217,9,217,10,1],[221,9,221,10,1],[222,13,222,60,1],[223,13,223,63,1],[224,13,224,61,1],[225,13,225,52,1],[227,13,227,62,1],[228,13,228,49,1],[229,13,229,57,1],[232,13,232,129,1],[234,13,234,48,1],[235,9,235,10,1],[239,9,239,10,1],[240,13,240,60,1],[241,13,241,63,1],[242,13,242,61,1],[243,13,243,52,1],[245,13,245,62,1],[246,13,246,49,1],[247,13,247,57,1],[250,13,250,136,1],[252,13,252,47,1],[253,9,253,10,1],[257,9,257,10,1],[258,13,258,60,1],[259,13,259,63,1],[260,13,260,61,1],[261,13,261,52,1],[264,13,264,80,1],[266,13,266,47,1],[268,13,268,44,1],[269,13,269,62,1],[270,13,270,61,1],[271,9,271,10,1],[275,9,275,10,1],[276,13,276,60,1],[277,13,277,63,1],[278,13,278,61,1],[279,13,279,52,1],[280,13,280,62,1],[281,13,281,57,1],[283,13,283,82,1],[286,13,286,40,1],[287,9,287,10,1],[292,9,292,10,0],[293,13,293,60,0],[294,13,294,63,0],[295,13,295,76,0],[295,76,295,130,0],[295,130,295,132,0],[295,13,295,132,0],[296,13,296,52,0],[298,13,298,62,0],[299,13,299,49,0],[304,9,304,10,1],[305,13,305,60,1],[306,13,306,63,1],[307,13,307,76,1],[307,76,307,107,1],[307,107,307,109,1],[307,13,307,109,1],[308,13,308,52,1],[310,13,310,62,1],[311,13,311,43,1],[312,13,312,57,1],[314,13,314,88,1],[316,13,316,39,1],[317,9,317,10,1],[321,9,321,10,1],[322,13,322,60,1],[323,13,323,63,1],[324,13,324,76,1],[324,76,324,106,1],[324,106,324,108,1],[324,13,324,108,1],[325,13,325,52,1],[327,13,327,62,1],[328,13,328,43,1],[329,13,329,57,1],[331,13,331,87,1],[334,13,334,39,1],[335,9,335,10,1],[339,9,339,10,1],[341,13,341,58,1],[342,13,342,60,1],[345,13,345,48,1],[348,13,348,56,1],[349,9,349,10,1],[353,9,353,10,1],[355,13,355,58,1],[356,13,356,68,1],[359,13,359,109,1],[362,13,362,62,1],[363,13,363,63,1],[364,13,364,49,1],[365,13,365,44,1],[366,13,366,84,1],[367,9,367,10,1],[371,9,371,10,1],[373,13,373,58,1],[374,13,374,68,1],[378,13,378,37,1],[379,13,379,39,1],[380,13,380,60,1],[381,13,381,113,1],[382,13,382,117,1],[383,13,383,46,1],[386,13,386,62,1],[387,13,387,84,1],[388,13,388,87,1],[389,13,389,49,1],[390,13,390,44,1],[391,13,391,84,1],[392,9,392,10,1],[396,9,396,10,1],[397,13,397,83,1],[399,13,399,112,1],[401,13,401,81,1],[403,13,403,65,1],[406,13,406,46,1],[407,13,407,46,1],[408,13,408,46,1],[409,13,409,46,1],[410,13,410,52,1],[412,13,412,77,1],[414,13,414,65,1],[417,13,417,20,1],[417,22,417,27,1],[417,28,417,30,1],[417,31,417,52,1],[418,13,418,14,1],[419,17,419,49,1],[420,13,420,14,1],[422,13,422,48,1],[423,13,423,48,1],[424,13,424,54,1],[428,13,428,77,1],[429,13,429,65,1],[430,9,430,10,1],[434,9,434,10,1],[435,13,435,83,1],[437,13,437,112,1],[438,13,438,112,1],[441,13,441,45,1],[442,13,442,45,1],[443,13,443,52,1],[444,13,444,52,1],[447,13,447,74,1],[450,13,450,81,1],[451,13,451,81,1],[452,13,452,70,1],[453,13,453,70,1],[454,9,454,10,1],[458,9,458,10,1],[459,13,459,83,1],[461,13,461,112,1],[462,13,462,112,1],[463,13,463,112,1],[464,13,464,112,1],[467,13,467,99,1],[470,13,470,81,1],[471,13,471,81,1],[472,13,472,81,1],[473,13,473,81,1],[474,13,474,69,1],[475,13,475,69,1],[476,13,476,70,1],[477,13,477,70,1],[480,13,480,69,1],[483,13,483,77,1],[484,13,484,77,1],[485,13,485,77,1],[486,13,486,77,1],[487,13,487,69,1],[488,13,488,69,1],[489,13,489,69,1],[490,13,490,69,1],[491,9,491,10,1],[495,9,495,10,1],[497,13,497,58,1],[498,13,498,68,1],[501,13,501,52,1],[501,52,501,129,1],[501,129,501,131,1],[501,13,501,131,1],[502,9,502,10,1],[506,9,506,10,1],[508,13,508,58,1],[509,13,509,68,1],[510,13,510,100,1],[511,13,511,42,1],[514,13,514,52,1],[514,52,514,74,1],[514,74,514,76,1],[514,13,514,76,1],[515,9,515,10,1],[519,9,519,10,1],[521,13,521,58,1],[522,13,522,68,1],[523,13,523,100,1],[524,13,524,38,1],[527,13,527,52,1],[527,52,527,74,1],[527,74,527,76,1],[527,13,527,76,1],[528,9,528,10,1],[532,9,532,10,1],[534,13,534,83,1],[535,13,535,111,1],[539,13,539,90,1],[542,13,542,39,1],[543,13,543,58,1],[544,13,544,50,1],[545,9,545,10,1],[549,9,549,10,1],[551,13,551,83,1],[552,13,552,118,1],[556,13,556,83,1],[559,13,559,39,1],[560,13,560,58,1],[561,13,561,50,1],[562,9,562,10,1],[566,9,566,10,1],[568,13,568,83,1],[569,13,569,125,1],[573,13,573,101,1],[576,13,576,43,1],[577,13,577,70,1],[578,13,578,74,1],[579,13,579,102,1],[580,13,580,82,1],[581,13,581,86,1],[582,13,582,98,1],[583,13,583,88,1],[584,13,584,94,1],[585,13,585,90,1],[586,13,586,76,1],[587,13,587,82,1],[588,13,588,77,1],[589,9,589,10,1]]);
    </script>
  </body>
</html>