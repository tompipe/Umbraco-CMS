<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\PropertyEditors\ImageCropperPropertyEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Umbraco.Core;
using Umbraco.Core.Configuration;
using Umbraco.Core.IO;
using Umbraco.Core.Logging;
using Umbraco.Core.Models;
using Umbraco.Core.PropertyEditors;
using Umbraco.Core.Services;

namespace Umbraco.Web.PropertyEditors
{
    [PropertyEditor(Constants.PropertyEditors.ImageCropperAlias, &quot;Image Cropper&quot;, &quot;imagecropper&quot;, ValueType = PropertyEditorValueTypes.Json, HideLabel = false, Group=&quot;media&quot;, Icon=&quot;icon-crop&quot;)]
    public class ImageCropperPropertyEditor : PropertyEditor, IApplicationEventHandler
    {
        /// &lt;summary&gt;
        /// Creates our custom value editor
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected override PropertyValueEditor CreateValueEditor()
        {
            var baseEditor = base.CreateValueEditor();
            return new ImageCropperPropertyValueEditor(baseEditor);
        }

        protected override PreValueEditor CreatePreValueEditor()
        {
            return new ImageCropperPreValueEditor();
        }


        public ImageCropperPropertyEditor()
        {
            _internalPreValues = new Dictionary&lt;string, object&gt;
                {
                    {&quot;focalPoint&quot;, &quot;{left: 0.5, top: 0.5}&quot;},
                    {&quot;src&quot;, &quot;&quot;}
                };
        }

        /// &lt;summary&gt;
        /// Ensures any files associated are removed
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;allPropertyData&quot;&gt;&lt;/param&gt;
        static IEnumerable&lt;string&gt; ServiceEmptiedRecycleBin(Dictionary&lt;int, IEnumerable&lt;Property&gt;&gt; allPropertyData)
        {
            var list = new List&lt;string&gt;();
            //Get all values for any image croppers found
            foreach (var cropperVal in allPropertyData
                .SelectMany(x =&gt; x.Value)
                .Where(x =&gt; x.PropertyType.PropertyEditorAlias == Constants.PropertyEditors.ImageCropperAlias)  
                .Select(x =&gt; x.Value)
                .WhereNotNull())
            {
                JObject json;
                try
                {
                    json = JsonConvert.DeserializeObject&lt;JObject&gt;(cropperVal.ToString());
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;ImageCropperPropertyEditor&gt;(&quot;An error occurred parsing the value stored in the image cropper value: &quot; + cropperVal, ex);
                    continue;
                }

                if (json[&quot;src&quot;] != null &amp;&amp; json[&quot;src&quot;].ToString().IsNullOrWhiteSpace() == false)
                {
                    list.Add(json[&quot;src&quot;].ToString());
                }
            }
            return list;
        }

        /// &lt;summary&gt;
        /// Ensures any files associated are removed
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;deletedEntities&quot;&gt;&lt;/param&gt;
        static IEnumerable&lt;string&gt; ServiceDeleted(IEnumerable&lt;ContentBase&gt; deletedEntities)
        {
            var list = new List&lt;string&gt;();
            foreach (var property in deletedEntities.SelectMany(deletedEntity =&gt; deletedEntity
                .Properties
                .Where(x =&gt; x.PropertyType.PropertyEditorAlias == Constants.PropertyEditors.ImageCropperAlias
                            &amp;&amp; x.Value != null
                            &amp;&amp; string.IsNullOrEmpty(x.Value.ToString()) == false)))
            {
                JObject json;
                try
                {
                    json = JsonConvert.DeserializeObject&lt;JObject&gt;(property.Value.ToString());
                }
                catch (Exception ex)
                {
                    LogHelper.Error&lt;ImageCropperPropertyEditor&gt;(&quot;An error occurred parsing the value stored in the image cropper value: &quot; + property.Value, ex);
                    continue;
                }

                if (json[&quot;src&quot;] != null &amp;&amp; json[&quot;src&quot;].ToString().IsNullOrWhiteSpace() == false)
                {
                    list.Add(json[&quot;src&quot;].ToString());
                }
            }
            return list;
        }

        /// &lt;summary&gt;
        /// After the content is copied we need to check if there are files that also need to be copied
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        static void ContentServiceCopied(IContentService sender, Core.Events.CopyEventArgs&lt;IContent&gt; e)
        {
            if (e.Original.Properties.Any(x =&gt; x.PropertyType.PropertyEditorAlias == Constants.PropertyEditors.ImageCropperAlias))
            {
                bool isUpdated = false;
                var fs = FileSystemProviderManager.Current.GetFileSystemProvider&lt;MediaFileSystem&gt;();

                //Loop through properties to check if the content contains media that should be deleted
                foreach (var property in e.Original.Properties.Where(x =&gt; x.PropertyType.PropertyEditorAlias == Constants.PropertyEditors.ImageCropperAlias
                    &amp;&amp; x.Value != null                                                   
                    &amp;&amp; string.IsNullOrEmpty(x.Value.ToString()) == false))
                {
                    JObject json;
                    try
                    {
                        json = JsonConvert.DeserializeObject&lt;JObject&gt;(property.Value.ToString());
                    }
                    catch (Exception ex)
                    {
                        LogHelper.Error&lt;ImageCropperPropertyEditor&gt;(&quot;An error occurred parsing the value stored in the image cropper value: &quot; + property.Value.ToString(), ex);
                        continue;
                    }

                    if (json[&quot;src&quot;] != null &amp;&amp; json[&quot;src&quot;].ToString().IsNullOrWhiteSpace() == false)
                    {
                        if (fs.FileExists(fs.GetRelativePath(json[&quot;src&quot;].ToString())))
                        {
                            var currentPath = fs.GetRelativePath(json[&quot;src&quot;].ToString());
                            var propertyId = e.Copy.Properties.First(x =&gt; x.Alias == property.Alias).Id;
                            var newPath = fs.GetRelativePath(propertyId, System.IO.Path.GetFileName(currentPath));

                            fs.CopyFile(currentPath, newPath);
                            json[&quot;src&quot;] = fs.GetUrl(newPath);
                            e.Copy.SetValue(property.Alias, json.ToString());

                            //Copy thumbnails
                            foreach (var thumbPath in fs.GetThumbnails(currentPath))
                            {
                                var newThumbPath = fs.GetRelativePath(propertyId, System.IO.Path.GetFileName(thumbPath));
                                fs.CopyFile(thumbPath, newThumbPath);
                            }
                            isUpdated = true;
                        }
                    }

                    
                }

                if (isUpdated)
                {
                    //need to re-save the copy with the updated path value
                    sender.Save(e.Copy);
                }
            }
        }

        static void MediaServiceCreated(IMediaService sender, Core.Events.NewEventArgs&lt;IMedia&gt; e)
        {
            AutoFillProperties(e.Entity);
        }

        static void MediaServiceSaving(IMediaService sender, Core.Events.SaveEventArgs&lt;IMedia&gt; e)
        {
            foreach (var m in e.SavedEntities)
            {
                AutoFillProperties(m);
            }
        }

        static void AutoFillProperties(IContentBase model)
        {
            foreach (var p in model.Properties.Where(x =&gt; x.PropertyType.PropertyEditorAlias == Constants.PropertyEditors.ImageCropperAlias))
            {
                var uploadFieldConfigNode =
                    UmbracoConfig.For.UmbracoSettings().Content.ImageAutoFillProperties
                                        .FirstOrDefault(x =&gt; x.Alias == p.Alias);

                if (uploadFieldConfigNode != null)
                {
                    if (p.Value != null)
                    {                        
                        JObject json = null;
                        try
                        {
                            json = JObject.Parse((string)p.Value);
                        }
                        catch (JsonException)
                        {
                            //note: we are swallowing this exception because in some cases a normal string/non json value will be passed in which will just be the 
                            // file path like /media/23454/hello.jpg
                            // This will happen everytime an image is uploaded via the folder browser and we don&#39;t really want to pollute the log since it&#39;s not actually
                            // a problem and we take care of this below.
                            // see: http://issues.umbraco.org/issue/U4-4756
                        }
                        if (json != null &amp;&amp; json[&quot;src&quot;] != null)
                        {
                            model.PopulateFileMetaDataProperties(uploadFieldConfigNode, json[&quot;src&quot;].Value&lt;string&gt;());
                        }
                        else if (p.Value is string)
                        {
                            var src = p.Value == null ? string.Empty : p.Value.ToString();
                            var config = ApplicationContext.Current.Services.DataTypeService.GetPreValuesByDataTypeId(p.PropertyType.DataTypeDefinitionId).FirstOrDefault();
                            var crops = string.IsNullOrEmpty(config) == false ? config : &quot;[]&quot;;
                            p.Value = &quot;{src: &#39;&quot; + p.Value + &quot;&#39;, crops: &quot; + crops + &quot;}&quot;;
                            //Only provide the source path, not the whole JSON value
                            model.PopulateFileMetaDataProperties(uploadFieldConfigNode, src);
                        }
                    }
                    else
                        model.ResetFileMetaDataProperties(uploadFieldConfigNode);
                }
            }
        }

        private IDictionary&lt;string, object&gt; _internalPreValues;
        public override IDictionary&lt;string, object&gt; DefaultPreValues
        {
            get { return _internalPreValues; }
            set { _internalPreValues = value; }
        }

        internal class ImageCropperPreValueEditor : PreValueEditor
        {
            [PreValueField(&quot;crops&quot;, &quot;Crop sizes&quot;, &quot;views/propertyeditors/imagecropper/imagecropper.prevalues.html&quot;)]
            public string Crops { get; set; }
        }

        #region Application event handler, used to bind to events on startup

        private readonly FileUploadPropertyEditorApplicationStartup _applicationStartup = new FileUploadPropertyEditorApplicationStartup();

        /// &lt;summary&gt;
        /// we&#39;re using a sub -class because this has the logic to prevent it from executing if the application is not configured
        /// &lt;/summary&gt;
        private class FileUploadPropertyEditorApplicationStartup : ApplicationEventHandler
        {
            /// &lt;summary&gt;
            /// We&#39;re going to bind to the MediaService Saving event so that we can populate the umbracoFile size, type, etc... label fields
            /// if we find any attached to the current media item.
            /// &lt;/summary&gt;
            protected override void ApplicationStarted(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
            {
                MediaService.Saving += MediaServiceSaving;
                MediaService.Created += MediaServiceCreated;
                ContentService.Copied += ContentServiceCopied;

                MediaService.Deleted += (sender, args) =&gt;
                    args.MediaFilesToDelete.AddRange(ServiceDeleted(args.DeletedEntities.Cast&lt;ContentBase&gt;()));
                MediaService.EmptiedRecycleBin += (sender, args) =&gt;
                    args.Files.AddRange(ServiceEmptiedRecycleBin(args.AllPropertyData));
                ContentService.Deleted += (sender, args) =&gt;
                    args.MediaFilesToDelete.AddRange(ServiceDeleted(args.DeletedEntities.Cast&lt;ContentBase&gt;()));
                ContentService.EmptiedRecycleBin += (sender, args) =&gt;
                    args.Files.AddRange(ServiceEmptiedRecycleBin(args.AllPropertyData));
                MemberService.Deleted += (sender, args) =&gt;
                    args.MediaFilesToDelete.AddRange(ServiceDeleted(args.DeletedEntities.Cast&lt;ContentBase&gt;()));
            }
        }

        public void OnApplicationInitialized(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            //wrap
            _applicationStartup.OnApplicationInitialized(umbracoApplication, applicationContext);
        }
        public void OnApplicationStarting(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            //wrap
            _applicationStartup.OnApplicationStarting(umbracoApplication, applicationContext);
        }
        public void OnApplicationStarted(UmbracoApplicationBase umbracoApplication, ApplicationContext applicationContext)
        {
            //wrap
            _applicationStartup.OnApplicationStarted(umbracoApplication, applicationContext);
        }
        #endregion
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,1],[27,13,27,55,1],[28,13,28,68,1],[29,9,29,10,1],[32,9,32,10,0],[33,13,33,53,0],[34,9,34,10,0],[37,9,37,44,1],[38,9,38,10,1],[39,13,43,19,1],[44,9,44,10,1],[51,9,51,10,0],[52,13,52,43,0],[54,13,54,20,0],[54,22,54,36,0],[54,37,54,39,0],[54,40,55,34,0],[55,34,55,41,0],[55,41,56,29,0],[56,29,56,110,0],[56,110,57,30,0],[57,30,57,37,0],[57,37,58,32,0],[54,40,58,32,0],[59,13,59,14,0],[62,17,62,18,0],[63,21,63,90,0],[64,17,64,18,0],[65,17,65,37,0],[66,17,66,18,0],[67,21,67,157,0],[68,21,68,30,0],[71,17,71,97,0],[72,17,72,18,0],[73,21,73,54,0],[74,17,74,18,0],[75,13,75,14,0],[76,13,76,25,0],[77,9,77,10,0],[84,9,84,10,0],[85,13,85,43,0],[86,13,86,20,0],[86,22,86,34,0],[86,35,86,37,0],[86,38,86,82,0],[86,82,88,29,0],[88,29,90,81,0],[90,81,90,82,0],[86,82,90,82,0],[90,82,90,83,0],[86,38,90,83,0],[91,13,91,14,0],[94,17,94,18,0],[95,21,95,94,0],[96,17,96,18,0],[97,17,97,37,0],[98,17,98,18,0],[99,21,99,161,0],[100,21,100,30,0],[103,17,103,97,0],[104,17,104,18,0],[105,21,105,54,0],[106,17,106,18,0],[107,13,107,14,0],[108,13,108,25,0],[109,9,109,10,0],[117,9,117,10,0],[118,13,118,48,0],[118,48,118,129,0],[118,129,118,131,0],[118,13,118,131,0],[119,13,119,14,0],[120,17,120,40,0],[121,17,121,101,0],[124,17,124,24,0],[124,26,124,38,0],[124,39,124,41,0],[124,42,124,75,0],[124,75,126,73,0],[126,73,126,74,0],[124,42,126,74,0],[127,17,127,18,0],[130,21,130,22,0],[131,25,131,98,0],[132,21,132,22,0],[133,21,133,41,0],[134,21,134,22,0],[135,25,135,176,0],[136,25,136,34,0],[139,21,139,101,0],[140,21,140,22,0],[141,25,141,87,0],[142,25,142,26,0],[143,29,143,90,0],[144,29,144,75,0],[144,75,144,100,0],[144,100,144,105,0],[144,29,144,105,0],[145,29,145,115,0],[147,29,147,63,0],[148,29,148,62,0],[149,29,149,78,0],[152,29,152,36,0],[152,38,152,51,0],[152,52,152,54,0],[152,55,152,84,0],[153,29,153,30,0],[154,33,154,122,0],[155,33,155,70,0],[156,29,156,30,0],[157,29,157,46,0],[158,25,158,26,0],[159,21,159,22,0],[162,17,162,18,0],[164,17,164,31,0],[165,17,165,18,0],[167,21,167,41,0],[168,17,168,18,0],[169,13,169,14,0],[170,9,170,10,0],[173,9,173,10,0],[174,13,174,42,0],[175,9,175,10,0],[178,9,178,10,0],[179,13,179,20,0],[179,22,179,27,0],[179,28,179,30,0],[179,31,179,46,0],[180,13,180,14,0],[181,17,181,39,0],[182,13,182,14,0],[183,9,183,10,0],[186,9,186,10,0],[187,13,187,20,0],[187,22,187,27,0],[187,28,187,30,0],[187,31,187,59,0],[187,59,187,140,0],[187,140,187,141,0],[187,31,187,141,0],[188,13,188,14,0],[189,17,191,62,0],[191,62,191,80,0],[191,80,191,82,0],[189,17,191,82,0],[193,17,193,51,0],[194,17,194,18,0],[195,21,195,41,0],[196,21,196,22,0],[197,25,197,45,0],[199,25,199,26,0],[200,29,200,67,0],[201,25,201,26,0],[202,25,202,46,0],[203,25,203,26,0],[209,25,209,26,0],[210,25,210,65,0],[211,25,211,26,0],[212,29,212,118,0],[213,25,213,26,0],[214,30,214,52,0],[215,25,215,26,0],[216,29,216,91,0],[217,29,217,173,0],[218,29,218,95,0],[219,29,219,88,0],[221,29,221,94,0],[222,25,222,26,0],[223,21,223,22,0],[225,25,225,82,0],[226,17,226,18,0],[227,13,227,14,0],[228,9,228,10,0],[233,17,233,18,0],[233,19,233,45,0],[233,46,233,47,0],[234,17,234,18,0],[234,19,234,46,0],[234,47,234,48,0],[240,35,240,39,0],[240,40,240,44,0],[245,9,245,140,1],[257,13,257,14,0],[258,17,258,59,0],[259,17,259,61,0],[260,17,260,63,0],[262,17,263,21,0],[263,21,263,111,0],[263,111,263,112,0],[262,17,263,112,0],[264,17,265,21,0],[265,21,265,88,0],[265,88,265,89,0],[264,17,265,89,0],[266,17,267,21,0],[267,21,267,111,0],[267,111,267,112,0],[266,17,267,112,0],[268,17,269,21,0],[269,21,269,88,0],[269,88,269,89,0],[268,17,269,89,0],[270,17,271,21,0],[271,21,271,111,0],[271,111,271,112,0],[270,17,271,112,0],[272,13,272,14,0],[276,9,276,10,0],[278,13,278,98,0],[279,9,279,10,0],[281,9,281,10,0],[283,13,283,95,0],[284,9,284,10,0],[286,9,286,10,0],[288,13,288,94,0],[289,9,289,10,0]]);
    </script>
  </body>
</html>