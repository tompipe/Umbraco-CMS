<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\PublishedContent\DynamicPublishedContentTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Linq;
using NUnit.Framework;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Web;
using Umbraco.Web.Models;
using Umbraco.Web.PublishedCache;
using Umbraco.Web.PublishedCache.XmlPublishedCache;
using File = Umbraco.Core.Models.File;

namespace Umbraco.Tests.PublishedContent
{
    [TestFixture]
	public class DynamicPublishedContentTests : DynamicDocumentTestsBase&lt;DynamicPublishedContent, DynamicPublishedContentList&gt;
	{
		internal DynamicPublishedContent GetNode(int id)
		{
			//var template = Template.MakeNew(&quot;test&quot;, new User(0));
			//var ctx = GetUmbracoContext(&quot;/test&quot;, template.Id);
			var ctx = GetUmbracoContext(&quot;/test&quot;, 1234);
			var doc = ctx.ContentCache.GetById(id);
			Assert.IsNotNull(doc);
			var dynamicNode = new DynamicPublishedContent(doc);
			Assert.IsNotNull(dynamicNode);
			return dynamicNode;
		}

		protected override dynamic GetDynamicNode(int id)
		{
			return GetNode(id).AsDynamic();
		}

        [Test]
        public void FirstChild()
        {
            var content = GetDynamicNode(1173);

            var x = content.FirstChild();
            Assert.IsNotNull(x);
            Assert.IsInstanceOf&lt;DynamicPublishedContent&gt;(x);
            Assert.AreEqual(1174, x.Id);

            x = content.FirstChild(&quot;CustomDocument&quot;);
            Assert.IsNotNull(x);
            Assert.IsInstanceOf&lt;DynamicPublishedContent&gt;(x);
            Assert.AreEqual(1177, x.Id);
        }

        [Test]
        public void Children()
        {
            var content = GetDynamicNode(1173);

            var l = content.Children;
            Assert.AreEqual(4, l.Count());

            // works - but not by calling the extension method
            // because the binder will in fact re-route to the property first
            l = content.Children();
            Assert.AreEqual(4, l.Count());
        }

        [Test]
        public void ChildrenOfType()
        {
            var content = GetDynamicNode(1173);

            var l = content.Children;
            Assert.AreEqual(4, l.Count());

            // fails - because it fails to find extension methods?
            l = content.Children(&quot;CustomDocument&quot;);
            Assert.AreEqual(2, l.Count());
        }

        [Test]
		public void Custom_Extension_Methods()
		{
			var asDynamic = GetDynamicNode(1173);

			Assert.AreEqual(&quot;Hello world&quot;, asDynamic.DynamicDocumentNoParameters());
			Assert.AreEqual(&quot;Hello world!&quot;, asDynamic.DynamicDocumentCustomString(&quot;Hello world!&quot;));
			Assert.AreEqual(&quot;Hello world!&quot; + 123 + false, asDynamic.DynamicDocumentMultiParam(&quot;Hello world!&quot;, 123, false));
			Assert.AreEqual(&quot;Hello world!&quot; + 123 + false, asDynamic.Children.DynamicDocumentListMultiParam(&quot;Hello world!&quot;, 123, false));
			Assert.AreEqual(&quot;Hello world!&quot; + 123 + false, asDynamic.Children.DynamicDocumentEnumerableMultiParam(&quot;Hello world!&quot;, 123, false));
			
		}

		[Test]
		public void Returns_IDocument_Object()
		{
			var helper = new TestHelper(GetNode(1173));
			var doc = helper.GetDoc();
			//HasProperty is only a prop on DynamicPublishedContent, NOT IPublishedContent
			Assert.IsFalse(doc.GetType().GetProperties().Any(x =&gt; x.Name == &quot;HasProperty&quot;));
		}

		[Test]
		public void Returns_DynamicDocument_Object()
		{
			var helper = new TestHelper(GetNode(1173));
			var doc = helper.GetDocAsDynamic();
			//HasProperty is only a prop on DynamicPublishedContent, NOT IPublishedContent
			Assert.IsTrue(doc.HasProperty(Constants.Conventions.Content.UrlAlias));
		}

		[Test]
		public void Returns_DynamicDocument_Object_After_Casting()
		{
			var helper = new TestHelper(GetNode(1173));
			var doc = helper.GetDoc();
			var ddoc = (dynamic) doc;
			//HasProperty is only a prop on DynamicPublishedContent, NOT IPublishedContent
			Assert.IsTrue(ddoc.HasProperty(Constants.Conventions.Content.UrlAlias));
		}

        [Test]
        public void U4_4559()
        {
            var doc = GetDynamicNode(1174);
            var result = doc.AncestorOrSelf(1);
            Assert.IsNotNull(result);
            Assert.AreEqual(1046, result.Id);
        }
        
        /// &lt;summary&gt;
		/// Test class to mimic UmbracoHelper when returning docs
		/// &lt;/summary&gt;
		public class TestHelper
		{
			private readonly DynamicPublishedContent _doc;

			public TestHelper(DynamicPublishedContent doc)
			{
				_doc = doc;
			}

			public IPublishedContent GetDoc()
			{
				return _doc;
			}

			public dynamic GetDocAsDynamic()
			{
				return _doc.AsDynamic();
			}
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[19,3,19,4,1],[22,4,22,47,1],[23,4,23,43,1],[24,4,24,26,1],[25,4,25,55,1],[26,4,26,34,1],[27,4,27,23,1],[28,3,28,4,1],[31,3,31,4,1],[32,4,32,35,1],[33,3,33,4,1],[37,9,37,10,1],[38,13,38,48,1],[40,13,40,42,1],[41,13,41,33,1],[42,13,42,61,1],[43,13,43,41,1],[45,13,45,54,1],[46,13,46,33,1],[47,13,47,61,1],[48,13,48,41,1],[49,9,49,10,1],[53,9,53,10,1],[54,13,54,48,1],[56,13,56,38,1],[57,13,57,43,1],[61,13,61,36,1],[62,13,62,43,1],[63,9,63,10,1],[67,9,67,10,1],[68,13,68,48,1],[70,13,70,38,1],[71,13,71,43,1],[74,13,74,52,1],[75,13,75,43,1],[76,9,76,10,1],[80,3,80,4,1],[81,4,81,41,1],[83,4,83,76,1],[84,4,84,91,1],[85,4,85,115,1],[86,4,86,128,1],[87,4,87,134,1],[89,3,89,4,1],[93,3,93,4,1],[94,4,94,47,1],[95,4,95,30,1],[97,4,97,58,1],[97,58,97,81,1],[97,81,97,84,1],[97,4,97,84,1],[98,3,98,4,1],[102,3,102,4,1],[103,4,103,47,1],[104,4,104,39,1],[106,4,106,75,1],[107,3,107,4,1],[111,3,111,4,1],[112,4,112,47,1],[113,4,113,30,1],[114,4,114,29,1],[116,4,116,76,1],[117,3,117,4,1],[121,9,121,10,1],[122,13,122,44,1],[123,13,123,48,1],[124,13,124,38,1],[125,13,125,46,1],[126,9,126,10,1],[135,4,135,50,1],[136,4,136,5,1],[137,5,137,16,1],[138,4,138,5,1],[141,4,141,5,1],[142,5,142,17,1],[143,4,143,5,1],[146,4,146,5,1],[147,5,147,29,1],[148,4,148,5,1]]);
    </script>
  </body>
</html>