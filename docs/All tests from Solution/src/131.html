<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\CodeFirst\Definitions\Conventions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using Umbraco.Core;
using Umbraco.Core.Models;
using Umbraco.Core.Models.Rdbms;
using Umbraco.Core.Persistence;
using Umbraco.Core.Services;
using Umbraco.Tests.CodeFirst.Attributes;
using umbraco.interfaces;

namespace Umbraco.Tests.CodeFirst.Definitions
{
    public static class Conventions
    {
        /// &lt;summary&gt;
        /// Convention to get a DataTypeDefinition from the PropertyTypeAttribute or the type of the property itself
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IDataTypeDefinition GetDataTypeDefinitionByAttributeOrType(PropertyTypeAttribute attribute, Type type)
        {
            if (attribute != null)
            {
                var instance = Activator.CreateInstance(attribute.Type);
                var dataType = instance as IDataType;
                var definition = GetDataTypeByControlId(dataType.Id);
                //If the DataTypeDefinition doesn&#39;t exist we create a new one
                if (definition == null)
                {
                    definition = new DataTypeDefinition(-1, dataType.Id)
                                     {
                                         DatabaseType = attribute.DatabaseType,
                                         Name = dataType.DataTypeName
                                     };
					ApplicationContext.Current.Services.DataTypeService.Save(definition, 0);
                }
                return definition;
            }

            return GetPredefinedDataTypeDefinitionByType(type);
        }

        /// &lt;summary&gt;
        /// Convention to get predefined DataTypeDefinitions based on the Type of the property
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IDataTypeDefinition GetPredefinedDataTypeDefinitionByType(Type type)
        {
            if (type == typeof(bool))
            {
                return GetDataTypeByControlId(new Guid(Constants.PropertyEditors.TrueFalse));// Yes/No DataType
            }
            if (type == typeof(int))
            {
                return GetDataTypeByControlId(new Guid(Constants.PropertyEditors.Integer));// Number DataType
            }
            if (type == typeof(DateTime))
            {
                return GetDataTypeByControlId(new Guid(Constants.PropertyEditors.Date));// Date Picker DataType
            }

            return GetDataTypeByControlId(new Guid(Constants.PropertyEditors.Textbox));// Standard textfield
        }

        /// &lt;summary&gt;
        /// Gets the &lt;see cref=&quot;IDataTypeDefinition&quot;/&gt; from the DataTypeService by its control Id
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IDataTypeDefinition GetDataTypeByControlId(Guid id)
        {
			var definitions = ApplicationContext.Current.Services.DataTypeService.GetDataTypeDefinitionByControlId(id);
            return definitions.FirstOrDefault();
        }

        /// &lt;summary&gt;
        /// Creates a new DataTypeDefinition based on the Type in the PropertyTypeAttribute
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;dataTypeDefinitionName&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static IDataTypeDefinition CreateDataTypeDefinitionFromAttribute(PropertyTypeAttribute attribute, string dataTypeDefinitionName)
        {
            var instance = Activator.CreateInstance(attribute.Type);
            var dataType = instance as IDataType;

            var definition = new DataTypeDefinition(-1, dataType.Id)
                                 {
                                     DatabaseType = attribute.DatabaseType,
                                     Name = dataTypeDefinitionName
                                 };
			ApplicationContext.Current.Services.DataTypeService.Save(definition, 0);
            return definition;
        }

        /// &lt;summary&gt;
        /// Creates a PreValue for a &lt;see cref=&quot;IDataTypeDefinition&quot;/&gt;
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataTypeDefinitionId&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;sortOrder&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;alias&quot;&gt;&lt;/param&gt;
        public static void CreatePrevalueForDataTypeDefinition(int dataTypeDefinitionId, string value, int sortOrder, string alias)
        {
            var poco = new DataTypePreValueDto
                           {
                               Alias = alias, 
                               DataTypeNodeId = dataTypeDefinitionId, 
                               SortOrder = sortOrder, 
                               Value = value
                           };

            ApplicationContext.Current.DatabaseContext.Database.Insert(poco);
        }

        /// &lt;summary&gt;
        /// Convention to get the Alias of the PropertyType from the AliasAttribute or the property itself
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;propertyName&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetPropertyTypeAlias(AliasAttribute attribute, string propertyName)
        {
            return attribute == null ? propertyName.ToUmbracoAlias() : attribute.Alias;
        }

        /// &lt;summary&gt;
        /// Convention to get the Name of the PropertyType from the AliasAttribute or the property itself
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;propertyName&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static string GetPropertyTypeName(AliasAttribute attribute, string propertyName)
        {
            if (attribute == null)
                return propertyName.SplitPascalCasing();

            return string.IsNullOrEmpty(attribute.Name) ? propertyName.SplitPascalCasing() : attribute.Name;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,1],[23,13,23,35,1],[24,13,24,14,1],[25,17,25,73,1],[26,17,26,54,1],[27,17,27,70,1],[29,17,29,40,1],[30,17,30,18,0],[31,21,35,40,0],[36,6,36,78,0],[37,17,37,18,0],[38,17,38,35,1],[41,13,41,64,1],[42,9,42,10,1],[50,9,50,10,1],[51,13,51,38,1],[52,13,52,14,1],[53,17,53,94,1],[55,13,55,37,1],[56,13,56,14,1],[57,17,57,92,1],[59,13,59,42,1],[60,13,60,14,1],[61,17,61,89,1],[64,13,64,88,1],[65,9,65,10,1],[73,9,73,10,1],[74,4,74,111,1],[75,13,75,49,1],[76,9,76,10,1],[85,9,85,10,0],[86,13,86,69,0],[87,13,87,50,0],[89,13,93,36,0],[94,4,94,76,0],[95,13,95,31,0],[96,9,96,10,0],[106,9,106,10,0],[107,13,113,30,0],[115,13,115,78,0],[116,9,116,10,0],[125,9,125,10,1],[126,13,126,88,1],[127,9,127,10,1],[136,9,136,10,1],[137,13,137,35,1],[138,17,138,57,1],[140,13,140,109,1],[141,9,141,10,1]]);
    </script>
  </body>
</html>