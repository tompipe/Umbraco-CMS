<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\umbraco.editorControls\XPathDropDownList\XPathDropDownListPreValueEditor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Xml.XPath;
using umbraco.cms.businesslogic.datatype;

namespace umbraco.editorControls.XPathDropDownList
{
    [Obsolete(&quot;IDataType and all other references to the legacy property editors are no longer used this will be removed from the codebase in future versions&quot;)]
    class XPathDropDownListPreValueEditor : AbstractJsonPrevalueEditor
    {
        /// &lt;summary&gt;
        /// Radio buttons to select type of node to pick from: Content / Media / Members
        /// &lt;/summary&gt;
        private RadioButtonList typeRadioButtonList = new RadioButtonList();

        /// &lt;summary&gt;
        /// TextBox control to get the XPath expression
        /// &lt;/summary&gt;
        private TextBox xPathTextBox = new TextBox();

        /// &lt;summary&gt;
        /// RequiredFieldValidator to ensure an XPath expression has been entered
        /// &lt;/summary&gt;
        private RequiredFieldValidator xPathRequiredFieldValidator = new RequiredFieldValidator();

        /// &lt;summary&gt;
        /// Server side validation of XPath expression
        /// &lt;/summary&gt;
        private CustomValidator xPathCustomValidator = new CustomValidator();

        /// &lt;summary&gt;
        /// Drop Down List to pick either Node Name or Node Id
        /// &lt;/summary&gt;
        private DropDownList valueTypeDropDownList = new DropDownList();

        /// &lt;summary&gt;
        /// Data object used to define the configuration status of this PreValueEditor
        /// &lt;/summary&gt;
        private XPathDropDownListOptions options = null;

        /// &lt;summary&gt;
        /// Gets the options data object that represents the current state of this datatypes configuration
        /// &lt;/summary&gt;
        internal XPathDropDownListOptions Options
        {
            get
            {
                if (this.options == null)
                {
                    // Deserialize any stored settings for this PreValueEditor instance
                    this.options = this.GetPreValueOptions&lt;XPathDropDownListOptions&gt;();

                    // If still null, ie, object couldn&#39;t be de-serialized from PreValue[0] string value
                    if (this.options == null)
                    {
                        // Create a new Options data object with the default values
                        this.options = new XPathDropDownListOptions();
                    }
                }
                return this.options;
            }
        }

        /// &lt;summary&gt;
        /// Initialize a new instance of XPathCheckBoxlistPreValueEditor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dataType&quot;&gt;XPathCheckBoxListDataType&lt;/param&gt;
        public XPathDropDownListPreValueEditor(umbraco.cms.businesslogic.datatype.BaseDataType dataType)
            : base(dataType, umbraco.cms.businesslogic.datatype.DBTypes.Nvarchar)
        {
        }

        /// &lt;summary&gt;
        /// Creates all of the controls and assigns all of their properties
        /// &lt;/summary&gt;
        protected override void CreateChildControls()
        {
            //radio buttons to select type of nodes that can be picked (Document, Media or Member)
            this.typeRadioButtonList.Items.Add(new ListItem(uQuery.UmbracoObjectType.Document.GetFriendlyName(), uQuery.UmbracoObjectType.Document.GetGuid().ToString()));
            this.typeRadioButtonList.Items.Add(new ListItem(uQuery.UmbracoObjectType.Media.GetFriendlyName(), uQuery.UmbracoObjectType.Media.GetGuid().ToString()));
            this.typeRadioButtonList.Items.Add(new ListItem(uQuery.UmbracoObjectType.Member.GetFriendlyName(), uQuery.UmbracoObjectType.Member.GetGuid().ToString()));

            this.xPathTextBox.ID = &quot;xPathTextBox&quot;;
            this.xPathTextBox.CssClass = &quot;umbEditorTextField&quot;;

            this.xPathRequiredFieldValidator.ControlToValidate = this.xPathTextBox.ID;
            this.xPathRequiredFieldValidator.Display = ValidatorDisplay.Dynamic;
            this.xPathRequiredFieldValidator.ErrorMessage = &quot; XPath expression required&quot;;

            this.xPathCustomValidator.ControlToValidate = this.xPathTextBox.ID;
            this.xPathCustomValidator.Display = ValidatorDisplay.Dynamic;
            this.xPathCustomValidator.ServerValidate += new ServerValidateEventHandler(this.XPathCustomValidator_ServerValidate);

            this.valueTypeDropDownList.ID = &quot;valueTypeDropDownList&quot;;
            this.valueTypeDropDownList.Items.Add(new ListItem(&quot;Node Id&quot;, bool.TrueString));
            this.valueTypeDropDownList.Items.Add(new ListItem(&quot;Node Name&quot;, bool.FalseString));

            this.Controls.AddPrevalueControls(
                this.typeRadioButtonList,
                this.xPathTextBox,
                this.xPathRequiredFieldValidator,
                this.xPathCustomValidator,
                this.valueTypeDropDownList);
        }

        /// &lt;summary&gt;
        /// 
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            // Read in stored configuration values
            this.typeRadioButtonList.SelectedValue = this.Options.Type;
            this.xPathTextBox.Text = this.Options.XPath;
            this.valueTypeDropDownList.SelectedValue = this.Options.UseId.ToString();
        }

        /// &lt;summary&gt;
        /// Will run the entered XPath expression to ensure it returns a collection
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;source&quot;&gt;xPathCustomValidator&lt;/param&gt;
        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;
        private void XPathCustomValidator_ServerValidate(object source, ServerValidateEventArgs args)
        {
            string xPath = args.Value;
            bool isValid = false;

            try
            {
                switch (this.options.UmbracoObjectType)
                {
                    case uQuery.UmbracoObjectType.Document:
                        if (uQuery.GetNodesByXPath(xPath).Count() &gt;= 0)
                        {
                            isValid = true;
                        }

                        break;

                    case uQuery.UmbracoObjectType.Media:
                        if (uQuery.GetMediaByXPath(xPath).Count() &gt;= 0)
                        {
                            isValid = true;
                        }

                        break;

                    case uQuery.UmbracoObjectType.Member:
                        if (uQuery.GetMembersByXPath(xPath).Count() &gt;= 0)
                        {
                            isValid = true;
                        }

                        break;
                }                
            }
            catch (XPathException)
            {
                this.xPathCustomValidator.ErrorMessage = &quot; Syntax error in XPath expression&quot;;
            }

            args.IsValid = isValid;
        }

        /// &lt;summary&gt;
        /// Saves the pre value data to Umbraco
        /// &lt;/summary&gt;
        public override void Save()
        {
            if (this.Page.IsValid)
            {
                this.Options.Type = this.typeRadioButtonList.SelectedValue;
                this.Options.XPath = this.xPathTextBox.Text;
                this.Options.UseId = bool.Parse(this.valueTypeDropDownList.SelectedValue);

                this.SaveAsJson(this.Options);  // Serialize to Umbraco database field
            }
        }

        /// &lt;summary&gt;
        /// Replaces the base class writer and instead uses the shared uComponents extension method, to inject consistant markup
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;writer&quot;&gt;&lt;/param&gt;
        protected override void RenderContents(HtmlTextWriter writer)
        {
            writer.AddPrevalueRow(
                        &quot;Type&quot;, 
                        &quot;the xml schema to query&quot;, 
                        this.typeRadioButtonList);

            writer.AddPrevalueRow(
                        &quot;XPath Expression&quot;, 
                        &quot;can use the tokens &lt;strong&gt;$ancestorOrSelf&lt;/strong&gt;, &lt;strong&gt;$parentPage&lt;/strong&gt; and &lt;strong&gt;$currentPage&lt;/strong&gt;&quot;,                                                        
                        this.xPathTextBox, 
                        this.xPathRequiredFieldValidator, 
                        this.xPathCustomValidator);
            
            writer.AddPrevalueRow(
                        &quot;Value&quot;, 
                        &quot;store the node id or the name&quot;,
                        this.valueTypeDropDownList);
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,77,0],[21,9,21,54,0],[26,9,26,99,0],[31,9,31,78,0],[36,9,36,73,0],[41,9,41,57,0],[49,13,49,14,0],[50,17,50,42,0],[51,17,51,18,0],[53,21,53,88,0],[56,21,56,46,0],[57,21,57,22,0],[59,25,59,71,0],[60,21,60,22,0],[61,17,61,18,0],[62,17,62,37,0],[63,13,63,14,0],[71,15,71,82,0],[72,9,72,10,0],[73,9,73,10,0],[79,9,79,10,0],[81,13,81,171,0],[82,13,82,165,0],[83,13,83,167,0],[85,13,85,51,0],[86,13,86,63,0],[88,13,88,87,0],[89,13,89,81,0],[90,13,90,90,0],[92,13,92,80,0],[93,13,93,74,0],[94,13,94,130,0],[96,13,96,69,0],[97,13,97,92,0],[98,13,98,95,0],[100,13,105,45,0],[106,9,106,10,0],[113,9,113,10,0],[114,13,114,28,0],[117,13,117,72,0],[118,13,118,57,0],[119,13,119,86,0],[120,9,120,10,0],[128,9,128,10,0],[129,13,129,39,0],[130,13,130,34,0],[133,13,133,14,0],[134,17,134,56,0],[137,25,137,72,0],[138,25,138,26,0],[139,29,139,44,0],[140,25,140,26,0],[142,25,142,31,0],[145,25,145,72,0],[146,25,146,26,0],[147,29,147,44,0],[148,25,148,26,0],[150,25,150,31,0],[153,25,153,74,0],[154,25,154,26,0],[155,29,155,44,0],[156,25,156,26,0],[158,25,158,31,0],[160,13,160,14,0],[161,13,161,35,0],[162,13,162,14,0],[163,17,163,94,0],[164,13,164,14,0],[166,13,166,36,0],[167,9,167,10,0],[173,9,173,10,0],[174,13,174,35,0],[175,13,175,14,0],[176,17,176,76,0],[177,17,177,61,0],[178,17,178,91,0],[180,17,180,47,0],[181,13,181,14,0],[182,9,182,10,0],[189,9,189,10,0],[190,13,193,51,0],[195,13,200,52,0],[202,13,205,53,0],[206,9,206,10,0]]);
    </script>
  </body>
</html>