<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Tests\Migrations\Upgrades\SqlCeDataUpgradeTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using Moq;
using NUnit.Framework;
using Semver;
using SQLCE4Umbraco;
using Umbraco.Core;
using Umbraco.Core.Logging;
using Umbraco.Core.Persistence;
using Umbraco.Core.Persistence.Migrations;
using Umbraco.Core.Persistence.SqlSyntax;
using Umbraco.Core.Services;
using Umbraco.Web.Strategies.Migrations;
using GlobalSettings = Umbraco.Core.Configuration.GlobalSettings;

namespace Umbraco.Tests.Migrations.Upgrades
{
    [TestFixture, NUnit.Framework.Ignore]
    public class SqlCeDataUpgradeTest : BaseUpgradeTest
    {

        [Test, NUnit.Framework.Ignore]
        public override void Can_Upgrade_From_470_To_600()
        {
            var configuredVersion = new SemVersion(4, 11, 0);
            var targetVersion = new SemVersion(6, 0, 0);
            var provider = GetDatabaseProvider();
            var db = GetConfiguredDatabase();

            var fix = new PublishAfterUpgradeToVersionSixth();

            //Setup the MigrationRunner
            var migrationRunner = new MigrationRunner(
                Mock.Of&lt;IMigrationEntryService&gt;(),
                Mock.Of&lt;ILogger&gt;(), configuredVersion, targetVersion, GlobalSettings.UmbracoMigrationName);

            bool upgraded = migrationRunner.Execute(db, provider, true);

            Assert.That(upgraded, Is.True);

            bool hasTabTable = db.TableExist(&quot;cmsTab&quot;);
            bool hasPropertyTypeGroupTable = db.TableExist(&quot;cmsPropertyTypeGroup&quot;);
            bool hasAppTreeTable = db.TableExist(&quot;umbracoAppTree&quot;);

            fix.Unsubscribe();

            Assert.That(hasTabTable, Is.False);
            Assert.That(hasPropertyTypeGroupTable, Is.True);
            Assert.That(hasAppTreeTable, Is.False);
        }

        public override void DatabaseSpecificSetUp()
        {
        }

        public override void DatabaseSpecificTearDown()
        {
            //legacy API database connection close
            SqlCeContextGuardian.CloseBackgroundConnection();
        }

        public override ISqlSyntaxProvider GetSyntaxProvider()
        {
            return new SqlCeSyntaxProvider();
        }

        public override UmbracoDatabase GetConfiguredDatabase()
        {
            return new UmbracoDatabase(&quot;Datasource=|DataDirectory|UmbracoPetaPocoTests.sdf;Flush Interval=1;&quot;, Constants.DatabaseProviders.SqlCe, Mock.Of&lt;ILogger&gt;());
        }

        public override DatabaseProviders GetDatabaseProvider()
        {
            return DatabaseProviders.SqlServerCE;
        }

        public override string GetDatabaseSpecificSqlScript()
        {
            return SqlScripts.SqlResources.SqlCe_SchemaAndData_4110;
        } 
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,9,23,10,0],[24,13,24,62,0],[25,13,25,57,0],[26,13,26,50,0],[27,13,27,46,0],[29,13,29,63,0],[32,13,34,108,0],[36,13,36,73,0],[38,13,38,44,0],[40,13,40,56,0],[41,13,41,84,0],[42,13,42,68,0],[44,13,44,31,0],[46,13,46,48,0],[47,13,47,61,0],[48,13,48,52,0],[49,9,49,10,0],[52,9,52,10,0],[53,9,53,10,0],[56,9,56,10,0],[58,13,58,62,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,63,46,0],[64,9,64,10,0],[67,9,67,10,0],[68,13,68,167,0],[69,9,69,10,0],[72,9,72,10,0],[73,13,73,50,0],[74,9,74,10,0],[77,9,77,10,0],[78,13,78,69,0],[79,9,79,10,0]]);
    </script>
  </body>
</html>