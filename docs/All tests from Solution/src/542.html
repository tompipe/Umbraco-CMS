<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\Tom Pipe\Documents\Hexadigital\Code\Umbraco\Umbraco-CMS\src\Umbraco.Web\umbraco.presentation\viewstateMoverModule.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
#region Using

using System;
using System.IO;
using System.Web;
using System.Text;
using System.Text.RegularExpressions;
using System.Collections;
using Umbraco.Core.Configuration;

#endregion

namespace umbraco.presentation
{

    /// &lt;summary&gt;
    /// Moved the viewstate
    /// &lt;/summary&gt;
    public class viewstateMoverModule : IHttpModule
    {
        #region IHttpModule Members

        void IHttpModule.Dispose()
        {
            // Nothing to dispose; 
        }

        void IHttpModule.Init(HttpApplication context)
        {
            if (UmbracoConfig.For.UmbracoSettings().ViewStateMoverModule.Enable)
            {
                context.BeginRequest += new EventHandler(context_BeginRequest);
            }
        }

        #endregion

        void context_BeginRequest(object sender, EventArgs e)
        {
            HttpApplication app = sender as HttpApplication;
            if (app.Request.Url.OriginalString.Contains(&quot;.aspx&quot;))
            {
                app.Response.Filter = new ViewstateFilter(app.Response.Filter);
            }
        }

        #region Stream filter

        private class ViewstateFilter : Stream
        {

            public ViewstateFilter(Stream sink)
            {
                _sink = sink;
            }

            private Stream _sink;

            //private Hashtable _html = new Hashtable(); 
            private string html = string.Empty;

            #region Properites

            public override bool CanRead
            {
                get { return true; }
            }

            public override bool CanSeek
            {
                get { return true; }
            }

            public override bool CanWrite
            {
                get { return true; }
            }

            public override void Flush()
            {
                doit();
                _sink.Flush();
            }

            public override long Length
            {
                get { return 0; }
            }

            private long _position;
            public override long Position
            {
                get { return _position; }
                set { _position = value; }
            }

            #endregion

            #region Methods

            public override int Read(byte[] buffer, int offset, int count)
            {
                return _sink.Read(buffer, offset, count);
            }

            public override long Seek(long offset, SeekOrigin origin)
            {
                return _sink.Seek(offset, origin);
            }

            public override void SetLength(long value)
            {
                _sink.SetLength(value);
            }

            public override void Close()
            {
                _sink.Close();
            }

            public override void Write(byte[] buffer, int offset, int count)
            {
                byte[] data = new byte[count];
                Buffer.BlockCopy(buffer, offset, data, 0, count);
                //string html = System.Text.Encoding.Default.GetString(buffer);
                html += System.Text.Encoding.Default.GetString(buffer);
            }
            private void doit()
            {
                int startPoint = html.IndexOf(&quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;__VIEWSTATE\&quot;&quot;);
                if (startPoint &gt;= 0)
                {
                    int endPoint = html.IndexOf(&quot;/&gt;&quot;, startPoint) + 2;
                    string viewstateInput = html.Substring(startPoint, endPoint - startPoint);
                    int formEndStart = html.IndexOf(&quot;&lt;/form&gt;&quot;);
                    if (formEndStart &gt;= 0)
                    {
                        html = html.Remove(startPoint, endPoint - startPoint);
                        html = html.Insert(formEndStart - (endPoint - startPoint), viewstateInput);
                    }
                }

                byte[] outdata = System.Text.Encoding.Default.GetBytes(html);
                _sink.Write(outdata, 0, outdata.GetLength(0));
            }

            #endregion

        }

        #endregion
    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,9,24,10,0],[26,9,26,10,0],[29,9,29,10,0],[30,13,30,81,0],[31,13,31,14,0],[32,17,32,80,0],[33,13,33,14,0],[34,9,34,10,0],[39,9,39,10,0],[40,13,40,61,0],[41,13,41,66,0],[42,13,42,14,0],[43,17,43,80,0],[44,13,44,14,0],[45,9,45,10,0],[52,13,52,48,0],[53,13,53,14,0],[54,17,54,30,0],[55,13,55,14,0],[60,13,60,48,0],[66,21,66,22,0],[66,23,66,35,0],[66,36,66,37,0],[71,21,71,22,0],[71,23,71,35,0],[71,36,71,37,0],[76,21,76,22,0],[76,23,76,35,0],[76,36,76,37,0],[80,13,80,14,0],[81,17,81,24,0],[82,17,82,31,0],[83,13,83,14,0],[87,21,87,22,0],[87,23,87,32,0],[87,33,87,34,0],[93,21,93,22,0],[93,23,93,40,0],[93,41,93,42,0],[94,21,94,22,0],[94,23,94,41,0],[94,42,94,43,0],[102,13,102,14,0],[103,17,103,58,0],[104,13,104,14,0],[107,13,107,14,0],[108,17,108,51,0],[109,13,109,14,0],[112,13,112,14,0],[113,17,113,40,0],[114,13,114,14,0],[117,13,117,14,0],[118,17,118,31,0],[119,13,119,14,0],[122,13,122,14,0],[123,17,123,47,0],[124,17,124,66,0],[126,17,126,72,0],[127,13,127,14,0],[129,13,129,14,0],[130,17,130,94,0],[131,17,131,37,0],[132,17,132,18,0],[133,21,133,71,0],[134,21,134,95,0],[135,21,135,64,0],[136,21,136,43,0],[137,21,137,22,0],[138,25,138,79,0],[139,25,139,100,0],[140,21,140,22,0],[141,17,141,18,0],[143,17,143,78,0],[144,17,144,63,0],[145,13,145,14,0]]);
    </script>
  </body>
</html>